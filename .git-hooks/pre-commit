#!/bin/sh
# Pre-commit hook to prevent fabricated/sample data from being committed
# Install: cp .git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "üîç Running data integrity checks..."

# Check 1: Block forbidden sample data files
FORBIDDEN_FILES="src/data/sampleDocuments.ts src/data/peopleData.ts"
for file in $FORBIDDEN_FILES; do
  if [ -f "$file" ]; then
    echo "‚ùå BLOCKED: Forbidden file exists: $file"
    echo "   These files contained fabricated data and were removed during the security audit."
    echo "   If you need sample data, use the API or create clearly labeled test fixtures."
    exit 1
  fi
done

# Check 2: Scan for fabricated content patterns in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ -n "$STAGED_FILES" ]; then
  # Check for fake email patterns
  if echo "$STAGED_FILES" | xargs grep -l "fabricated\|@clintonfoundation.org\|@epstein.com\|fake.*email" 2>/dev/null; then
    echo "‚ùå BLOCKED: Detected fabricated email content in staged files"
    exit 1
  fi
  
  # Check for hardcoded red flag ratings for real people
  if echo "$STAGED_FILES" | xargs grep -l "red_flag_rating.*:.*[3-5].*Trump\|red_flag_rating.*:.*[3-5].*Clinton\|red_flag_rating.*:.*[3-5].*Prince Andrew" 2>/dev/null; then
    echo "‚ö†Ô∏è  WARNING: Detected hardcoded red flag ratings for named individuals"
    echo "   All ratings should come from data analysis, not hardcoded values."
  fi
  
  # Check for fallback to sample data
  if echo "$STAGED_FILES" | xargs grep -l "generateSampleDocuments\|fallback.*sample" 2>/dev/null; then
    echo "‚ùå BLOCKED: Detected fallback to sample documents"
    echo "   The app should show errors, not fake data."
    exit 1
  fi
fi

# Check 3: Ensure src/data only contains approved files
if [ -d "src/data" ]; then
  UNAPPROVED=$(find src/data -name "*.ts" | grep -v "index.ts" | head -5)
  if [ -n "$UNAPPROVED" ]; then
    echo "‚ö†Ô∏è  WARNING: Unapproved data files in src/data/:"
    echo "$UNAPPROVED"
    echo "   Consider moving static data to the database instead."
  fi
fi

echo "‚úÖ Data integrity checks passed"
exit 0
