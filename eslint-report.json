[{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/About.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/AboutPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/AddToInvestigationButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/AreaTimeline.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ArticleCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ArticleFeed.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchArticles'. Either include it or remove the dependency array.","line":42,"column":6,"nodeType":"ArrayExpression","endLine":42,"endColumn":39,"suggestions":[{"desc":"Update the dependencies array to be: [feedUrl, tagFilter, maxArticles, fetchArticles]","fix":{"range":[1360,1393],"text":"[feedUrl, tagFilter, maxArticles, fetchArticles]"}}],"suppressions":[{"kind":"directive","justification":"fetchArticles depends only on props and internal state"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ArticleViewerModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ArticlesTab.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'filterArticles'. Either include it or remove the dependency array.","line":27,"column":6,"nodeType":"ArrayExpression","endLine":27,"endColumn":49,"suggestions":[{"desc":"Update the dependencies array to be: [searchTerm, selectedPublication, articles, filterArticles]","fix":{"range":[1031,1074],"text":"[searchTerm, selectedPublication, articles, filterArticles]"}}],"suppressions":[{"kind":"directive","justification":"filterArticles already derives from searchTerm/selectedPublication/articles"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/AudioBrowser.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchAudio'. Either include it or remove the dependency array.","line":167,"column":6,"nodeType":"ArrayExpression","endLine":167,"endColumn":39,"suggestions":[{"desc":"Update the dependencies array to be: [fetchAudio, selectedAlbum, transcriptSearch]","fix":{"range":[5581,5614],"text":"[fetchAudio, selectedAlbum, transcriptSearch]"}}],"suppressions":[{"kind":"directive","justification":"fetchAudio already captures latest selectedAlbum/transcriptSearch"}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isItemLoaded' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":354,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":354,"endColumn":21,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/AudioPlayer.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'seek'. Either include it or remove the dependency array.","line":294,"column":5,"nodeType":"ArrayExpression","endLine":294,"endColumn":77,"suggestions":[{"desc":"Update the dependencies array to be: [transcriptMatches, transcript, seek, scrollToSegment, scrollOverlayToSegment]","fix":{"range":[10155,10227],"text":"[transcriptMatches, transcript, seek, scrollToSegment, scrollOverlayToSegment]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/AudioTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/AutoSizer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/BaseCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/BatchToolbar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/BlackBookReview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/BlackBookViewer.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchBlackBookEntries'. Either include it or remove the dependency array.","line":35,"column":6,"nodeType":"ArrayExpression","endLine":35,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchBlackBookEntries]","fix":{"range":[1407,1409],"text":"[fetchBlackBookEntries]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchBlackBookEntries'. Either include it or remove the dependency array.","line":39,"column":6,"nodeType":"ArrayExpression","endLine":39,"endColumn":66,"suggestions":[{"desc":"Update the dependencies array to be: [searchTerm, selectedLetter, hasPhone, hasEmail, hasAddress, fetchBlackBookEntries]","fix":{"range":[1467,1527],"text":"[searchTerm, selectedLetter, hasPhone, hasEmail, hasAddress, fetchBlackBookEntries]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":65,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":65,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":75,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":75,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":81,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":81,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport { Search, Phone, Mail, MapPin, User, Book, Eye, FileText, ExternalLink } from 'lucide-react';\nimport { extractCleanName, formatPhoneNumber } from '../utils/prettifyOCR';\nimport { EvidenceModal } from './EvidenceModal';\nimport { apiClient } from '../services/apiClient';\n\ninterface BlackBookEntry {\n  id: number;\n  person_id: number;\n  entry_text: string;\n  phone_numbers: string[];\n  addresses: string[];\n  email_addresses: string[];\n  notes: string;\n  person_name?: string;\n}\n\nexport const BlackBookViewer: React.FC = () => {\n  const [entries, setEntries] = useState<BlackBookEntry[]>([]);\n  const [filteredEntries, setFilteredEntries] = useState<BlackBookEntry[]>([]);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [loading, setLoading] = useState(true);\n  const [selectedLetter, setSelectedLetter] = useState<string>('ALL');\n  const [hasPhone, setHasPhone] = useState<boolean>(false);\n  const [hasEmail, setHasEmail] = useState<boolean>(false);\n  const [hasAddress, setHasAddress] = useState<boolean>(false);\n  const [showRaw, setShowRaw] = useState<boolean>(false);\n  const [selectedEntity, setSelectedEntity] = useState<any | null>(null);\n  const [loadingEntity, setLoadingEntity] = useState<number | null>(null);\n\n  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');\n\n  useEffect(() => {\n    fetchBlackBookEntries();\n  }, []);\n\n  useEffect(() => {\n    fetchBlackBookEntries();\n  }, [searchTerm, selectedLetter, hasPhone, hasEmail, hasAddress]);\n\n  const fetchBlackBookEntries = async () => {\n    try {\n      setLoading(true);\n      const params = new URLSearchParams();\n      if (searchTerm.trim()) params.set('search', searchTerm.trim());\n      if (selectedLetter) params.set('letter', selectedLetter);\n      if (hasPhone) params.set('hasPhone', 'true');\n      if (hasEmail) params.set('hasEmail', 'true');\n      if (hasAddress) params.set('hasAddress', 'true');\n      params.set('limit', '5000');\n      const response = await fetch(`/api/black-book?${params.toString()}`);\n      const result = await response.json();\n\n      // API now returns {data: [...], total, page, pageSize, totalPages}\n      const data = result.data || [];\n\n      // Parse JSON fields safely\n      const parsedEntries = data.map((entry: any) => {\n        let phone_numbers = [];\n        let addresses = [];\n        let email_addresses = [];\n\n        try {\n          phone_numbers = entry.phone_numbers ? JSON.parse(entry.phone_numbers) : [];\n        } catch (e) {\n          console.warn('Failed to parse phone_numbers for entry', entry.id, entry.phone_numbers);\n          // Fallback: if it looks like a string, wrap it\n          if (typeof entry.phone_numbers === 'string' && !entry.phone_numbers.startsWith('[')) {\n            phone_numbers = [entry.phone_numbers];\n          }\n        }\n\n        try {\n          addresses = entry.addresses ? JSON.parse(entry.addresses) : [];\n        } catch (e) {\n          console.warn('Failed to parse addresses for entry', entry.id);\n        }\n\n        try {\n          email_addresses = entry.email_addresses ? JSON.parse(entry.email_addresses) : [];\n        } catch (e) {\n          console.warn('Failed to parse email_addresses for entry', entry.id);\n        }\n\n        return {\n          ...entry,\n          phone_numbers,\n          addresses,\n          email_addresses,\n        };\n      });\n\n      setEntries(parsedEntries);\n      setFilteredEntries(parsedEntries);\n    } catch (error) {\n      console.error('Error fetching Black Book entries:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Client-side fallback remains if needed\n  useEffect(() => {\n    setFilteredEntries(entries);\n  }, [entries]);\n\n  const extractName = (entryText: string): string => {\n    // Extract name from first line\n    const lines = entryText.split('\\n');\n    return lines[0]?.trim() || 'Unknown';\n  };\n\n  const handleEntityClick = async (personId: number, personName: string) => {\n    if (!personName) return; // Not a known entity\n    try {\n      setLoadingEntity(personId);\n      const entity = await apiClient.getEntity(String(personId));\n      setSelectedEntity(entity);\n    } catch (error) {\n      console.error('Error fetching entity:', error);\n    } finally {\n      setLoadingEntity(null);\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div className=\"flex items-center space-x-3\">\n          <Book className=\"w-8 h-8 text-cyan-400\" />\n          <div>\n            <h2 className=\"text-2xl font-bold text-white\">Jeffrey Epstein's Black Book</h2>\n            <p className=\"text-slate-400 text-sm\">\n              {filteredEntries.length} of {entries.length} contacts\n            </p>\n          </div>\n        </div>\n\n        {/* Pretty/Raw Toggle */}\n        <button\n          onClick={() => setShowRaw(!showRaw)}\n          className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${\n            showRaw\n              ? 'bg-slate-700 text-slate-300 border border-slate-600'\n              : 'bg-cyan-600 text-white border border-cyan-500'\n          }`}\n          title={showRaw ? 'Showing raw OCR text' : 'Showing cleaned text'}\n        >\n          {showRaw ? <FileText className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n          <span className=\"text-sm font-medium\">{showRaw ? 'Raw OCR' : 'Pretty'}</span>\n        </button>\n      </div>\n\n      {/* Search Bar */}\n      <div className=\"relative\">\n        <Search className=\"absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400\" />\n        <input\n          type=\"text\"\n          placeholder=\"Search by name, phone, email, or address...\"\n          value={searchTerm}\n          onChange={(e) => setSearchTerm(e.target.value)}\n          className=\"w-full pl-12 pr-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-500\"\n        />\n      </div>\n\n      {/* Alphabet Filter */}\n      <div className=\"flex flex-wrap gap-2\">\n        <button\n          onClick={() => setSelectedLetter('ALL')}\n          className={`px-3 py-1 rounded-md text-sm font-medium transition-colors ${\n            selectedLetter === 'ALL'\n              ? 'bg-cyan-500 text-white'\n              : 'bg-slate-800/50 text-slate-400 hover:bg-slate-700'\n          }`}\n        >\n          ALL\n        </button>\n        {alphabet.map((letter) => (\n          <button\n            key={letter}\n            onClick={() => setSelectedLetter(letter)}\n            className={`px-3 py-1 rounded-md text-sm font-medium transition-colors ${\n              selectedLetter === letter\n                ? 'bg-cyan-500 text-white'\n                : 'bg-slate-800/50 text-slate-400 hover:bg-slate-700'\n            }`}\n          >\n            {letter}\n          </button>\n        ))}\n      </div>\n\n      {/* Contact Filters */}\n      <div className=\"flex flex-wrap gap-3 items-center\">\n        <label className=\"flex items-center gap-2 text-slate-300\">\n          <input\n            type=\"checkbox\"\n            checked={hasPhone}\n            onChange={(e) => setHasPhone(e.target.checked)}\n          />\n          <span>Has Phone</span>\n          <Phone className=\"w-4 h-4 text-slate-400\" />\n        </label>\n        <label className=\"flex items-center gap-2 text-slate-300\">\n          <input\n            type=\"checkbox\"\n            checked={hasEmail}\n            onChange={(e) => setHasEmail(e.target.checked)}\n          />\n          <span>Has Email</span>\n          <Mail className=\"w-4 h-4 text-slate-400\" />\n        </label>\n        <label className=\"flex items-center gap-2 text-slate-300\">\n          <input\n            type=\"checkbox\"\n            checked={hasAddress}\n            onChange={(e) => setHasAddress(e.target.checked)}\n          />\n          <span>Has Address</span>\n          <MapPin className=\"w-4 h-4 text-slate-400\" />\n        </label>\n      </div>\n\n      {/* Entries Grid */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n        {filteredEntries.map((entry) => {\n          const rawName = entry.person_name || extractName(entry.entry_text);\n          const displayName = showRaw ? rawName : extractCleanName(entry.entry_text) || rawName;\n\n          return (\n            <div\n              key={entry.id}\n              className=\"bg-slate-800/50 border border-slate-700 rounded-lg p-4 hover:border-cyan-500/50 transition-all\"\n            >\n              {/* Name - clickable if known entity */}\n              <div className=\"flex items-center space-x-2 mb-3\">\n                <User className=\"w-5 h-5 text-cyan-400\" />\n                {entry.person_name ? (\n                  <button\n                    onClick={() => handleEntityClick(entry.person_id, entry.person_name!)}\n                    className=\"text-lg font-semibold text-cyan-400 hover:text-cyan-300 hover:underline flex items-center gap-1 transition-colors text-left\"\n                    title=\"Click to view entity profile\"\n                    disabled={loadingEntity === entry.person_id}\n                  >\n                    {loadingEntity === entry.person_id ? (\n                      <span className=\"animate-pulse\">Loading...</span>\n                    ) : (\n                      <>\n                        {displayName}\n                        <ExternalLink className=\"w-3 h-3 opacity-60\" />\n                      </>\n                    )}\n                  </button>\n                ) : (\n                  <h3 className=\"text-lg font-semibold text-white\">{displayName}</h3>\n                )}\n              </div>\n\n              {/* Contact Info */}\n              <div className=\"space-y-2\">\n                {/* Phone Numbers */}\n                {entry.phone_numbers.length > 0 && (\n                  <div className=\"flex items-start space-x-2\">\n                    <Phone className=\"w-4 h-4 text-slate-400 mt-1 flex-shrink-0\" />\n                    <div className=\"flex-1\">\n                      {entry.phone_numbers.map((phone, idx) => (\n                        <div key={idx} className=\"text-sm text-slate-300\">\n                          {showRaw ? phone : formatPhoneNumber(phone)}\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* Emails */}\n                {entry.email_addresses.length > 0 && (\n                  <div className=\"flex items-start space-x-2\">\n                    <Mail className=\"w-4 h-4 text-slate-400 mt-1 flex-shrink-0\" />\n                    <div className=\"flex-1\">\n                      {entry.email_addresses.map((email, idx) => (\n                        <div key={idx} className=\"text-sm text-slate-300 break-all\">\n                          {email}\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* Addresses */}\n                {entry.addresses.length > 0 && (\n                  <div className=\"flex items-start space-x-2\">\n                    <MapPin className=\"w-4 h-4 text-slate-400 mt-1 flex-shrink-0\" />\n                    <div className=\"flex-1\">\n                      {entry.addresses.slice(0, 2).map((address, idx) => (\n                        <div key={idx} className=\"text-sm text-slate-300\">\n                          {address}\n                        </div>\n                      ))}\n                      {entry.addresses.length > 2 && (\n                        <div className=\"text-xs text-slate-500 mt-1\">\n                          +{entry.addresses.length - 2} more\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                )}\n\n                {/* No contact info */}\n                {entry.phone_numbers.length === 0 &&\n                  entry.email_addresses.length === 0 &&\n                  entry.addresses.length === 0 && (\n                    <div className=\"text-sm text-slate-500 italic\">\n                      No contact information available\n                    </div>\n                  )}\n              </div>\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Empty State */}\n      {filteredEntries.length === 0 && (\n        <div className=\"text-center py-12\">\n          <Book className=\"w-16 h-16 text-slate-600 mx-auto mb-4\" />\n          <p className=\"text-slate-400 text-lg\">No contacts found</p>\n          <p className=\"text-slate-500 text-sm mt-2\">Try adjusting your search or filter</p>\n        </div>\n      )}\n\n      {/* Entity Modal */}\n      {selectedEntity && (\n        <EvidenceModal person={selectedEntity} onClose={() => setSelectedEntity(null)} />\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/Breadcrumb.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/Card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ChainOfCustodyModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/CircularProgress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/CommunicationAnalysis.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'investigation' is defined but never used. Allowed unused args must match /^_/u.","line":45,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\nimport { Investigation, EvidenceItem } from '../types/investigation';\nimport { apiClient } from '../services/apiClient';\nimport {\n  Activity,\n  Clock,\n  Users,\n  MessageSquare,\n  TrendingUp,\n  AlertTriangle,\n  Filter,\n  Mail,\n  Phone,\n  X,\n} from 'lucide-react';\n\ninterface CommunicationAnalysisProps {\n  investigation: Investigation;\n  evidence: EvidenceItem[];\n  onCommunicationPatternDetected?: (patterns: CommunicationPattern[]) => void;\n}\n\nexport interface CommunicationPattern {\n  id: string;\n  type: 'frequency' | 'timing' | 'content' | 'network' | 'anomaly';\n  title: string;\n  description: string;\n  confidence: number;\n  severity: 'low' | 'medium' | 'high' | 'critical';\n  participants: string[];\n  evidenceIds: string[];\n  metadata: {\n    frequency?: number;\n    timeRange?: { start: string; end: string };\n    communicationChannels?: string[];\n    messageCount?: number;\n    responseTime?: number;\n    anomalyScore?: number;\n    networkDensity?: number;\n  };\n  recommendations: string[];\n}\n\nexport const CommunicationAnalysis: React.FC<CommunicationAnalysisProps> = ({\n  investigation,\n  evidence,\n  onCommunicationPatternDetected,\n}) => {\n  const [communicationPatterns, setCommunicationPatterns] = useState<CommunicationPattern[]>([]);\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [selectedPattern, setSelectedPattern] = useState<CommunicationPattern | null>(null);\n  const [analysisProgress, setAnalysisProgress] = useState(0);\n  const [filterType, setFilterType] = useState<\n    'all' | 'frequency' | 'timing' | 'content' | 'network' | 'anomaly'\n  >('all');\n\n  const analyzeCommunications = async () => {\n    setIsAnalyzing(true);\n    setAnalysisProgress(5);\n\n    // 1. Collect unique entity IDs from investigation evidence\n    const entityIds = Array.from(\n      new Set(\n        evidence\n          .filter((item) =>\n            ['entity', 'person', 'organization'].includes(\n              (item.type || '').toString().toLowerCase(),\n            ),\n          )\n          .map((item) => String(item.sourceId || item.id))\n          .filter(Boolean),\n      ),\n    );\n\n    if (entityIds.length === 0) {\n      setCommunicationPatterns([]);\n      setAnalysisProgress(100);\n      setIsAnalyzing(false);\n      if (onCommunicationPatternDetected) onCommunicationPatternDetected([]);\n      return;\n    }\n\n    // 2. Fetch communications per entity using the real API\n    const allEvents: Array<{\n      entityId: string;\n      documentId: string;\n      threadId: string;\n      subject: string;\n      date: string | null;\n      from: string;\n      to: string[];\n      cc: string[];\n      topic: string;\n    }> = [];\n\n    for (let i = 0; i < entityIds.length; i++) {\n      const entityId = entityIds[i];\n      try {\n        const res = await apiClient.getEntityCommunications(entityId, {\n          limit: 500,\n        });\n        const events = (res.data || []).map((e: any) => ({\n          entityId,\n          documentId: String(e.documentId || e.document_id || ''),\n          threadId: String(e.threadId || e.thread_id || ''),\n          subject: String(e.subject || ''),\n          date: e.date || null,\n          from: String(e.from || ''),\n          to: Array.isArray(e.to) ? e.to : [],\n          cc: Array.isArray(e.cc) ? e.cc : [],\n          topic: String(e.topic || 'misc'),\n        }));\n        allEvents.push(...events);\n      } catch (err) {\n        // If one entity fails, continue with others\n        // eslint-disable-next-line no-console\n        console.warn('Failed to load communications for entity', entityId, err);\n      }\n      setAnalysisProgress(5 + Math.round(((i + 1) / entityIds.length) * 45));\n    }\n\n    if (allEvents.length === 0) {\n      setCommunicationPatterns([]);\n      setAnalysisProgress(100);\n      setIsAnalyzing(false);\n      if (onCommunicationPatternDetected) onCommunicationPatternDetected([]);\n      return;\n    }\n\n    // 3. Aggregate patterns from real events\n    const byTopic = new Map<string, number>();\n    const byPair = new Map<string, number>();\n    const byHour: number[] = Array.from({ length: 24 }, () => 0);\n\n    for (const ev of allEvents) {\n      const topic = ev.topic || 'misc';\n      byTopic.set(topic, (byTopic.get(topic) || 0) + 1);\n\n      const participants = Array.from(\n        new Set([ev.from, ...ev.to].filter((v) => typeof v === 'string' && v.trim().length > 0)),\n      );\n      if (participants.length >= 2) {\n        const [a, b] = participants.slice(0, 2).sort();\n        const key = `${a} ↔ ${b}`;\n        byPair.set(key, (byPair.get(key) || 0) + 1);\n      }\n\n      if (ev.date) {\n        const d = new Date(ev.date);\n        if (!isNaN(d.getTime())) {\n          const h = d.getHours();\n          if (h >= 0 && h < 24) {\n            byHour[h] += 1;\n          }\n        }\n      }\n    }\n\n    setAnalysisProgress(70);\n\n    const totalMessages = allEvents.length;\n\n    // Top topic frequency pattern\n    const sortedTopics = Array.from(byTopic.entries()).sort((a, b) => b[1] - a[1]);\n    const topTopic = sortedTopics[0];\n\n    // Late-night spike: 0-5h\n    const lateNightCount = byHour.slice(0, 6).reduce((a, b) => a + b, 0);\n\n    // Top communication pair\n    const sortedPairs = Array.from(byPair.entries()).sort((a, b) => b[1] - a[1]);\n    const topPair = sortedPairs[0];\n\n    const patterns: CommunicationPattern[] = [];\n\n    if (topTopic) {\n      patterns.push({\n        id: 'frequency-topic',\n        type: 'frequency',\n        title: `Dominant Topic: ${topTopic[0].replace('_', ' ')}`,\n        description: `Most common email topic in this investigation is “${topTopic[0].replace(\n          '_',\n          ' ',\n        )}” with ${topTopic[1]} messages.`,\n        confidence: Math.min(100, Math.round((topTopic[1] / totalMessages) * 100) || 50),\n        severity:\n          topTopic[1] / totalMessages > 0.4\n            ? 'high'\n            : topTopic[1] / totalMessages > 0.2\n              ? 'medium'\n              : 'low',\n        participants: [],\n        evidenceIds: allEvents\n          .filter((e) => e.topic === topTopic[0])\n          .map((e) => e.documentId)\n          .slice(0, 50),\n        metadata: {\n          frequency: topTopic[1],\n          messageCount: totalMessages,\n          communicationChannels: ['email'],\n        },\n        recommendations: [\n          'Review all high-volume threads for this topic.',\n          'Cross-reference with investigation timeline and key entities.',\n        ],\n      });\n    }\n\n    if (lateNightCount > 0) {\n      patterns.push({\n        id: 'timing-late-night',\n        type: 'timing',\n        title: 'Late-night communication clusters',\n        description: `Detected ${lateNightCount} messages sent between 00:00 and 05:59, which may indicate covert or off-hours coordination.`,\n        confidence: Math.min(100, 60 + lateNightCount),\n        severity: lateNightCount > 50 ? 'high' : lateNightCount > 10 ? 'medium' : 'low',\n        participants: [],\n        evidenceIds: allEvents\n          .filter((e) => {\n            if (!e.date) return false;\n            const d = new Date(e.date);\n            return !isNaN(d.getTime()) && d.getHours() < 6;\n          })\n          .map((e) => e.documentId)\n          .slice(0, 50),\n        metadata: {\n          timeRange: {\n            start: '',\n            end: '',\n          },\n          communicationChannels: ['email'],\n        },\n        recommendations: ['Inspect these threads for sensitive coordination or escalation.'],\n      });\n    }\n\n    if (topPair) {\n      patterns.push({\n        id: 'network-top-pair',\n        type: 'network',\n        title: `Central communication pair: ${topPair[0]}`,\n        description: `The pair ${topPair[0]} appears in ${topPair[1]} messages, suggesting a central communication link within this investigation.`,\n        confidence: Math.min(100, 70 + topPair[1]),\n        severity: topPair[1] > 40 ? 'critical' : topPair[1] > 15 ? 'high' : 'medium',\n        participants: topPair[0].split(' ↔ ').filter(Boolean),\n        evidenceIds: [],\n        metadata: {\n          communicationChannels: ['email'],\n          messageCount: topPair[1],\n        },\n        recommendations: [\n          'Map all threads involving this pair of participants.',\n          'Cross-reference with relationship graph and entity risk levels.',\n        ],\n      });\n    }\n\n    setCommunicationPatterns(patterns);\n    setAnalysisProgress(100);\n    setIsAnalyzing(false);\n\n    if (onCommunicationPatternDetected) {\n      onCommunicationPatternDetected(patterns);\n    }\n  };\n\n  const getPatternIcon = (type: CommunicationPattern['type']) => {\n    const icons = {\n      frequency: TrendingUp,\n      timing: Clock,\n      content: MessageSquare,\n      network: Users,\n      anomaly: AlertTriangle,\n    };\n    return icons[type];\n  };\n\n  const getCommunicationIcon = (channel: string) => {\n    const icons = {\n      email: Mail,\n      phone: Phone,\n      text: MessageSquare,\n      meeting: Users,\n    };\n    return icons[channel as keyof typeof icons] || MessageSquare;\n  };\n\n  const getSeverityColor = (severity: CommunicationPattern['severity']) => {\n    const colors = {\n      low: 'bg-green-100 text-green-800 border-green-200',\n      medium: 'bg-yellow-100 text-yellow-800 border-yellow-200',\n      high: 'bg-orange-100 text-orange-800 border-orange-200',\n      critical: 'bg-red-100 text-red-800 border-red-200',\n    };\n    return colors[severity];\n  };\n\n  const getConfidenceColor = (confidence: number) => {\n    if (confidence >= 90) return 'text-green-600';\n    if (confidence >= 70) return 'text-yellow-600';\n    return 'text-red-600';\n  };\n\n  const filteredPatterns =\n    filterType === 'all'\n      ? communicationPatterns\n      : communicationPatterns.filter((pattern) => pattern.type === filterType);\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-lg\">\n      {/* Header */}\n      <div className=\"border-b border-gray-200 px-6 py-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h2 className=\"text-xl font-semibold text-gray-900\">Communication Forensics</h2>\n            <p className=\"text-sm text-gray-600 mt-1\">\n              Analyze communication patterns, timing, and network effects\n            </p>\n          </div>\n          <button\n            onClick={analyzeCommunications}\n            disabled={isAnalyzing}\n            className=\"flex items-center px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n          >\n            <Activity className=\"w-4 h-4 mr-2\" />\n            {isAnalyzing ? 'Analyzing...' : 'Start Communication Analysis'}\n          </button>\n        </div>\n      </div>\n\n      {/* Analysis Progress */}\n      {isAnalyzing && (\n        <div className=\"px-6 py-4 bg-red-50 border-b border-red-200\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <span className=\"text-sm font-medium text-red-900\">\n              Analyzing communication patterns...\n            </span>\n            <span className=\"text-sm text-red-700\">{analysisProgress}%</span>\n          </div>\n          <div className=\"w-full bg-red-200 rounded-full h-2\">\n            <div\n              className=\"bg-red-600 h-2 rounded-full transition-all duration-300\"\n              style={{ width: `${analysisProgress}%` }}\n            />\n          </div>\n        </div>\n      )}\n\n      {/* Filters */}\n      {!isAnalyzing && communicationPatterns.length > 0 && (\n        <div className=\"px-6 py-4 border-b border-gray-200\">\n          <div className=\"flex items-center gap-4\">\n            <Filter className=\"w-4 h-4 text-gray-500\" />\n            <span className=\"text-sm font-medium text-gray-700\">Filter by type:</span>\n            <div className=\"flex gap-2\">\n              {['all', 'frequency', 'timing', 'content', 'network', 'anomaly'].map((type) => (\n                <button\n                  key={type}\n                  onClick={() => setFilterType(type as any)}\n                  className={`px-3 py-1 text-xs font-medium rounded-full transition-colors ${\n                    filterType === type\n                      ? 'bg-red-100 text-red-700'\n                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\n                  }`}\n                >\n                  {type.charAt(0).toUpperCase() + type.slice(1)}\n                </button>\n              ))}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Pattern Results */}\n      {!isAnalyzing && filteredPatterns.length > 0 && (\n        <div className=\"p-6\">\n          <div className=\"mb-4\">\n            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\n              Detected Communication Patterns ({filteredPatterns.length})\n            </h3>\n            <p className=\"text-sm text-gray-600\">\n              Analysis identified {communicationPatterns.length} suspicious communication patterns\n              {filterType !== 'all' && ` (${filteredPatterns.length} matching current filter)`}\n            </p>\n          </div>\n\n          <div className=\"grid gap-4\">\n            {filteredPatterns.map((pattern) => {\n              const Icon = getPatternIcon(pattern.type);\n              return (\n                <div\n                  key={pattern.id}\n                  className={`border rounded-lg p-4 cursor-pointer transition-all hover:shadow-md ${\n                    selectedPattern?.id === pattern.id ? 'ring-2 ring-red-500' : ''\n                  }`}\n                  onClick={() => setSelectedPattern(pattern)}\n                >\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex items-start flex-1\">\n                      <div className={`p-2 rounded-lg ${getSeverityColor(pattern.severity)} mr-3`}>\n                        <Icon className=\"w-5 h-5\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center justify-between mb-1\">\n                          <h4 className=\"text-sm font-medium text-gray-900\">{pattern.title}</h4>\n                          <div className=\"flex items-center gap-2\">\n                            <span\n                              className={`text-sm font-medium ${getConfidenceColor(pattern.confidence)}`}\n                            >\n                              {pattern.confidence}% confidence\n                            </span>\n                            <span\n                              className={`px-2 py-1 text-xs font-medium rounded-full ${getSeverityColor(pattern.severity)}`}\n                            >\n                              {pattern.severity.toUpperCase()}\n                            </span>\n                          </div>\n                        </div>\n                        <p className=\"text-sm text-gray-600 mb-2\">{pattern.description}</p>\n                        <div className=\"flex items-center gap-4 text-xs text-gray-500\">\n                          <span>Type: {pattern.type}</span>\n                          <span>Participants: {pattern.participants.length}</span>\n                          <span>Evidence: {pattern.evidenceIds.length} items</span>\n                          {pattern.metadata.communicationChannels && (\n                            <span>Channels: {pattern.metadata.communicationChannels.length}</span>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      )}\n\n      {/* Pattern Detail Modal */}\n      {selectedPattern && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg p-6 w-full max-w-2xl max-h-96 overflow-auto\">\n            <div className=\"flex items-start justify-between mb-4\">\n              <div>\n                <h3 className=\"text-lg font-medium text-gray-900\">{selectedPattern.title}</h3>\n                <div className=\"flex items-center gap-2 mt-1\">\n                  <span\n                    className={`px-2 py-1 text-xs font-medium rounded-full ${getSeverityColor(selectedPattern.severity)}`}\n                  >\n                    {selectedPattern.severity.toUpperCase()}\n                  </span>\n                  <span\n                    className={`text-sm font-medium ${getConfidenceColor(selectedPattern.confidence)}`}\n                  >\n                    {selectedPattern.confidence}% confidence\n                  </span>\n                </div>\n              </div>\n              <button\n                onClick={() => setSelectedPattern(null)}\n                className=\"p-2 rounded-full hover:bg-slate-100 text-gray-400 hover:text-gray-600 transition-colors\"\n                aria-label=\"Close\"\n              >\n                <X className=\"w-5 h-5\" />\n              </button>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div>\n                <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Description</h4>\n                <p className=\"text-sm text-gray-600\">{selectedPattern.description}</p>\n              </div>\n\n              <div>\n                <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Participants</h4>\n                <div className=\"flex flex-wrap gap-2\">\n                  {selectedPattern.participants.map((participant, index) => (\n                    <span\n                      key={index}\n                      className=\"px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded\"\n                    >\n                      {participant}\n                    </span>\n                  ))}\n                </div>\n              </div>\n\n              {selectedPattern.metadata.timeRange && (\n                <div>\n                  <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Time Range</h4>\n                  <p className=\"text-sm text-gray-600\">\n                    {selectedPattern.metadata.timeRange.start} to{' '}\n                    {selectedPattern.metadata.timeRange.end}\n                  </p>\n                </div>\n              )}\n\n              {selectedPattern.metadata.communicationChannels &&\n                selectedPattern.metadata.communicationChannels.length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium text-gray-700 mb-1\">\n                      Communication Channels\n                    </h4>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {selectedPattern.metadata.communicationChannels.map((channel, index) => {\n                        const ChannelIcon = getCommunicationIcon(channel.toLowerCase());\n                        return (\n                          <span\n                            key={index}\n                            className=\"px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded flex items-center gap-1\"\n                          >\n                            <ChannelIcon className=\"w-3 h-3\" />\n                            {channel}\n                          </span>\n                        );\n                      })}\n                    </div>\n                  </div>\n                )}\n\n              <div>\n                <h4 className=\"text-sm font-medium text-gray-700 mb-2\">\n                  Investigation Recommendations\n                </h4>\n                <ul className=\"space-y-1\">\n                  {selectedPattern.recommendations.map((recommendation, index) => (\n                    <li key={index} className=\"text-sm text-gray-600 flex items-start\">\n                      <span className=\"w-1.5 h-1.5 rounded-full bg-red-600 mt-2 mr-2 flex-shrink-0\"></span>\n                      {recommendation}\n                    </li>\n                  ))}\n                </ul>\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-3 mt-6\">\n              <button\n                onClick={() => setSelectedPattern(null)}\n                className=\"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors\"\n              >\n                Close\n              </button>\n              <button className=\"px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors\">\n                Add to Investigation\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Empty State */}\n      {!isAnalyzing && communicationPatterns.length === 0 && (\n        <div className=\"p-12 text-center\">\n          <Activity className=\"w-12 h-12 text-gray-400 mx-auto mb-4\" />\n          <h3 className=\"text-sm font-medium text-gray-900 mb-2\">\n            No communication patterns detected yet\n          </h3>\n          <p className=\"text-sm text-gray-600 mb-4\">\n            Start communication analysis to identify suspicious patterns in timing, frequency,\n            content, and network behavior.\n          </p>\n          <button\n            onClick={analyzeCommunications}\n            className=\"px-4 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 transition-colors\"\n          >\n            Start Communication Analysis\n          </button>\n        </div>\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/CreateEntityModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/CreateRelationshipModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DataIntegrityPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DataQualityDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DataVisualization.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DataVisualizationEnhanced.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DesignSystemTest.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DocumentAnnotationSystem.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DocumentBrowser.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":308,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":308,"endColumn":15},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleDocumentSelect'. Either include it or remove the dependency array.","line":502,"column":6,"nodeType":"ArrayExpression","endLine":502,"endColumn":55,"suggestions":[{"desc":"Update the dependencies array to be: [selectedDocumentId, documents, selectedDocument, handleDocumentSelect]","fix":{"range":[18166,18215],"text":"[selectedDocumentId, documents, selectedDocument, handleDocumentSelect]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState, useCallback, useRef } from 'react';\nimport { createPortal } from 'react-dom';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport {\n  FixedSizeGrid as Grid,\n  FixedSizeList as List,\n  GridChildComponentProps,\n  ListChildComponentProps,\n  areEqual,\n} from 'react-window';\nimport AutoSizer from './AutoSizer';\nimport { Document, BrowseFilters, DocumentCollection } from '../types/documents';\nimport { DocumentProcessor } from '../services/documentProcessor';\nimport {\n  Search,\n  Filter,\n  FileText,\n  Users,\n  Tag,\n  ChevronDown,\n  ChevronRight,\n  Network,\n  Download,\n  Eye,\n} from 'lucide-react';\nimport { useNavigation } from '../services/ContentNavigationService.tsx';\nimport { apiClient } from '../services/apiClient';\nimport { DocumentAnnotationSystem } from './DocumentAnnotationSystem';\nimport { Breadcrumb } from './Breadcrumb';\nimport { SourceBadge } from './SourceBadge';\nimport DocumentSkeleton from './DocumentSkeleton';\nimport { AddToInvestigationButton } from './AddToInvestigationButton';\n// TODO: Apply OCR prettification - see UNUSED_VARIABLES_RECOMMENDATIONS.md\n// import { prettifyOCRText } from '../utils/prettifyOCR';\nimport { DocumentContentRenderer } from './DocumentContentRenderer';\nimport { useHighlightNavigation } from '../hooks/useHighlightNavigation';\nimport { HighlightNavigationControls } from './HighlightNavigationControls';\n\n// --- Virtualized Renderers for DocumentBrowser ---\n\ninterface DocItemData {\n  documents: Document[];\n  onDocumentSelect: (doc: Document) => void;\n  formatFileSize: (bytes: number) => string;\n  formatDate: (dateString?: string) => string;\n  searchTerm?: string;\n  columnCount?: number;\n}\n\n// Helper to highlight search terms\nconst highlightSearchTerm = (text: string, term?: string): React.ReactNode => {\n  if (!term || !text || typeof text !== 'string') return text;\n  try {\n    const escapeRegExp = (str: string) => str.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n    const terms = term.split(/\\s+/).filter((t) => t.length > 2);\n    if (terms.length === 0) return text;\n    const pattern = `(${terms.map(escapeRegExp).join('|')})`;\n    const regex = new RegExp(pattern, 'gi');\n    const highlighted = text.replace(\n      regex,\n      '<mark class=\"bg-yellow-500 text-black px-1 rounded\">$1</mark>',\n    );\n    if (highlighted === text) return text;\n    return <span dangerouslySetInnerHTML={{ __html: highlighted }} />;\n  } catch {\n    return text;\n  }\n};\n\n// Memoized Grid Cell for document grid view\nconst DocumentGridCell = React.memo(\n  ({ columnIndex, rowIndex, style, data }: GridChildComponentProps<DocItemData>) => {\n    const {\n      documents,\n      onDocumentSelect,\n      formatFileSize,\n      formatDate,\n      searchTerm,\n      columnCount = 1,\n    } = data;\n    const index = rowIndex * columnCount + columnIndex;\n\n    if (index >= documents.length) return null;\n\n    const doc = documents[index];\n    const displayTitle =\n      doc.title && doc.title !== doc.filename\n        ? doc.title\n        : (doc.filename || '').replace(/\\.[^/.]+$/, '').replace(/_/g, ' ');\n    const summary = (doc.content || '').substring(0, 200).trim();\n\n    return (\n      <div style={{ ...style, padding: '8px' }}>\n        <div\n          className=\"h-full bg-gray-900 border border-gray-700 rounded-lg p-4 hover:border-gray-500 transition-colors cursor-pointer flex flex-col\"\n          onClick={() => onDocumentSelect(doc)}\n        >\n          <div className=\"flex items-start justify-between mb-3\">\n            <div className=\"flex items-center space-x-2\">\n              <FileText className=\"w-4 h-4 text-blue-400\" />\n              <span className=\"text-xs text-gray-400 uppercase\">{doc.fileType}</span>\n            </div>\n            <div className=\"flex items-center space-x-1\">\n              <span className=\"text-xs text-gray-400\">{formatFileSize(doc.fileSize)}</span>\n              <span className=\"text-lg\">{doc.redFlagPeppers}</span>\n            </div>\n          </div>\n\n          <h3 className=\"font-semibold text-white mb-1 line-clamp-2 text-sm\">\n            {searchTerm ? highlightSearchTerm(displayTitle, searchTerm) : displayTitle}\n          </h3>\n\n          {summary && (\n            <p className=\"text-xs text-gray-300 mb-2 line-clamp-2 flex-grow\">\n              {searchTerm ? highlightSearchTerm(summary + '...', searchTerm) : summary + '...'}\n            </p>\n          )}\n\n          <div className=\"flex items-center justify-between text-xs text-gray-400 mt-auto\">\n            <span>{formatDate(doc.dateCreated)}</span>\n            <span>{doc.entities?.length || 0} entities</span>\n          </div>\n        </div>\n      </div>\n    );\n  },\n  areEqual,\n);\n\n// Memoized List Row for document list view\nconst DocumentListRow = React.memo(\n  ({ index, style, data }: ListChildComponentProps<DocItemData>) => {\n    const { documents, onDocumentSelect, formatFileSize, formatDate, searchTerm } = data;\n    const doc = documents[index];\n\n    return (\n      <div style={style}>\n        <div\n          className=\"mx-2 bg-gray-900 border border-gray-700 rounded-lg p-4 hover:border-gray-500 transition-colors cursor-pointer\"\n          onClick={() => onDocumentSelect(doc)}\n        >\n          <div className=\"flex items-start justify-between\">\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-center space-x-2 mb-2\">\n                <FileText className=\"w-4 h-4 text-blue-400\" />\n                <span className=\"text-xs text-gray-400 uppercase\">{doc.fileType}</span>\n                <span className=\"text-lg\">{doc.redFlagPeppers}</span>\n              </div>\n              <h3 className=\"font-semibold text-white mb-2 truncate\">\n                {searchTerm ? highlightSearchTerm(doc.title || '', searchTerm) : doc.title}\n              </h3>\n              <p className=\"text-sm text-gray-300 mb-3 line-clamp-2\">\n                {searchTerm\n                  ? highlightSearchTerm((doc.content || '').substring(0, 200) + '...', searchTerm)\n                  : (doc.content || '').substring(0, 200) + '...'}\n              </p>\n              <div className=\"flex items-center space-x-4 text-xs text-gray-400\">\n                <span>{formatFileSize(doc.fileSize)}</span>\n                <span>{formatDate(doc.dateCreated)}</span>\n                <span>{doc.entities?.length || 0} entities</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  },\n  areEqual,\n);\n\ninterface DocumentBrowserProps {\n  processor: DocumentProcessor;\n  searchTerm?: string;\n  onSearchTermChange?: (term: string) => void;\n  selectedDocumentId?: string;\n  onDocumentClose?: () => void;\n}\n\nexport const DocumentBrowser: React.FC<DocumentBrowserProps> = ({\n  processor,\n  searchTerm: externalSearchTerm,\n  onSearchTermChange,\n  selectedDocumentId,\n  onDocumentClose,\n}) => {\n  // Use navigation context for shared state\n  const navigation = useNavigation();\n  const { searchTerm: contextSearchTerm, setSearchTerm: setContextSearchTerm } = navigation;\n\n  // Initialize search from URL params\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    const searchParam = params.get('search');\n    if (searchParam && searchParam !== contextSearchTerm) {\n      if (onSearchTermChange) {\n        onSearchTermChange(searchParam);\n      } else {\n        setContextSearchTerm(searchParam);\n      }\n    }\n  }, [contextSearchTerm, onSearchTermChange, setContextSearchTerm]);\n\n  // Use either external searchTerm or context searchTerm\n  const effectiveSearchTerm =\n    externalSearchTerm !== undefined ? externalSearchTerm : contextSearchTerm;\n\n  const [documents, setDocuments] = useState<Document[]>([]);\n  const [filteredDocuments, setFilteredDocuments] = useState<Document[]>([]);\n  const [selectedDocument, setSelectedDocument] = useState<Document | null>(null);\n  const [relatedDocuments, setRelatedDocuments] = useState<Document[]>([]);\n  const [showFilters, setShowFilters] = useState(false);\n  const [sortBy, setSortBy] = useState<'relevance' | 'date' | 'red_flag' | 'fileType' | 'size'>(\n    'red_flag',\n  );\n  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');\n  // TODO: Implement document collections - see UNUSED_VARIABLES_RECOMMENDATIONS.md\n  const [collection, _setCollection] = useState<DocumentCollection | null>(null);\n  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid');\n  // const [useVirtualScrolling, setUseVirtualScrolling] = useState(false);\n  // const [displayLimit, setDisplayLimit] = useState(100); // Start with 100 documents\n  const [currentPage, setCurrentPage] = useState(1);\n  const [showMetadata, setShowMetadata] = useState(false);\n  const [hideLowCredibility, setHideLowCredibility] = useState(false);\n  const [itemsPerPage, setItemsPerPage] = useState(50);\n  const [totalDocuments, setTotalDocuments] = useState(0);\n\n  const [filters, setFilters] = useState<BrowseFilters>({\n    fileType: [],\n    dateRange: {},\n    entities: [],\n    categories: [],\n    redFlagLevel: { min: 0, max: 5 },\n    confidentiality: [],\n    source: [],\n  });\n\n  // Ref for highlight navigation\n  const documentContainerRef = useRef<HTMLDivElement>(null);\n\n  // Use highlight navigation hook\n  const { currentHighlightIndex, totalHighlights, nextHighlight, prevHighlight, hasHighlights } =\n    useHighlightNavigation(effectiveSearchTerm, documentContainerRef);\n\n  // Function to highlight search terms in text\n  const highlightText = (text: string, term?: string) => {\n    if (!term || !text || typeof text !== 'string') return text;\n\n    try {\n      // Escape special regex characters\n      const escapeRegExp = (str: string) => str.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n\n      // Split term into words and filter out short words to avoid noise\n      const terms = term.split(/\\s+/).filter((t) => t.length > 2);\n\n      if (terms.length === 0) {\n        // If no valid terms after filtering, try the full term if it's short but not empty\n        if (term.trim().length > 0) {\n          const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');\n          return text.replace(\n            regex,\n            '<mark class=\"bg-yellow-500 text-black px-1 rounded\">$1</mark>',\n          );\n        }\n        return text;\n      }\n\n      // Create pattern to match any of the terms\n      const pattern = `(${terms.map(escapeRegExp).join('|')})`;\n      const regex = new RegExp(pattern, 'gi');\n\n      return text.replace(regex, '<mark class=\"bg-yellow-500 text-black px-1 rounded\">$1</mark>');\n    } catch (e) {\n      console.warn('Error highlighting text:', e);\n      return text;\n    }\n  };\n\n  // Function to safely render highlighted text\n  const renderHighlightedText = (text: string, term?: string) => {\n    if (!term || !text || typeof text !== 'string') return text;\n\n    try {\n      const highlighted = highlightText(text, term);\n      if (highlighted === text) return text;\n\n      return <span dangerouslySetInnerHTML={{ __html: highlighted }} />;\n    } catch (e) {\n      console.warn('Error rendering highlighted text:', e);\n      return text;\n    }\n  };\n\n  // Helper to format date\n  const formatDate = (dateString?: string) => {\n    if (!dateString) return 'Unknown Date';\n    try {\n      const date = new Date(dateString);\n      // Check if valid date\n      if (isNaN(date.getTime())) return dateString;\n\n      // Format: Jan 1, 2000\n      return new Intl.DateTimeFormat('en-US', {\n        year: 'numeric',\n        month: 'short',\n        day: 'numeric',\n      }).format(date);\n    } catch (e) {\n      return dateString;\n    }\n  };\n\n  // Enable virtual scrolling for large datasets\n  useEffect(() => {\n    // setUseVirtualScrolling(filteredDocuments.length > 100);\n  }, [filteredDocuments.length]);\n\n  const [hasMore, setHasMore] = useState(true);\n  const [isFetching, setIsFetching] = useState(false);\n\n  // Fetch documents from API with pagination\n  useEffect(() => {\n    const fetchDocuments = async () => {\n      // Prevent duplicate fetches or fetching when no more data\n      if (isFetching || (currentPage > 1 && !hasMore)) return;\n\n      try {\n        setIsFetching(true);\n        console.log(`DocumentBrowser: Fetching page ${currentPage}...`);\n\n        // Build API query params\n        const params = new URLSearchParams();\n        params.append('page', currentPage.toString());\n        params.append('limit', itemsPerPage.toString());\n\n        if (effectiveSearchTerm && effectiveSearchTerm.trim()) {\n          params.append('search', effectiveSearchTerm);\n        }\n\n        if (sortBy) {\n          params.append('sortBy', sortBy);\n        }\n\n        // Add evidence type filter from categories\n        if (filters.categories && filters.categories.length > 0) {\n          params.append('evidenceType', filters.categories[0]);\n        }\n\n        const response = await fetch(`/api/documents?${params.toString()}`);\n        const result = await response.json();\n\n        // Map API response to Document type\n        const newDocs: Document[] = (result.data || []).map((doc: any) => ({\n          id: doc.id?.toString() || doc.fileName,\n          title: doc.title || doc.fileName,\n          filename: doc.fileName,\n          fileType: doc.fileType || 'unknown',\n          fileSize: doc.fileSize || 0,\n          dateCreated: doc.dateCreated,\n          dateModified: doc.dateModified,\n          content: doc.content || doc.contentPreview || '',\n          metadata: {\n            source: 'Epstein Files',\n            confidentiality: 'Public',\n            categories: [],\n            ...doc.metadata,\n            emailHeaders: doc.metadata?.emailHeaders,\n          },\n          entities: [],\n          passages: [],\n          redFlagScore: doc.redFlagRating || 0,\n          redFlagRating: doc.redFlagRating || 1,\n          redFlagPeppers: '🚩'.repeat(doc.redFlagRating || 1),\n          redFlagDescription: `Red Flag Index ${doc.redFlagRating || 1}`,\n          evidenceType: doc.evidenceType || doc.evidence_type || 'document',\n          parentDocumentId: doc.parentDocumentId || doc.parent_document_id,\n          threadId: doc.threadId || doc.thread_id,\n          threadPosition: doc.threadPosition || doc.thread_position,\n        }));\n\n        if (currentPage === 1) {\n          setDocuments(newDocs);\n        } else {\n          setDocuments((prev) => [...prev, ...newDocs]);\n        }\n\n        // Update total count and hasMore\n        if (result.total !== undefined) {\n          setTotalDocuments(result.total);\n          // If we received fewer items than requested, we've reached the end\n          setHasMore(newDocs.length === itemsPerPage);\n        }\n      } catch (error) {\n        console.error('DocumentBrowser: Error fetching documents:', error);\n        if (currentPage === 1) {\n          setDocuments([]);\n          setFilteredDocuments([]);\n        }\n      } finally {\n        setIsFetching(false);\n      }\n    };\n\n    fetchDocuments();\n  }, [\n    currentPage,\n    itemsPerPage,\n    effectiveSearchTerm,\n    sortBy,\n    filters.categories,\n    filters.source,\n    filters.fileType,\n    filters.redFlagLevel,\n    hasMore,\n    isFetching,\n  ]);\n\n  // Reset pagination when filters change\n  useEffect(() => {\n    setCurrentPage(1);\n    setHasMore(true);\n    setDocuments([]);\n    // We don't need to trigger fetch explicitly here because changing dependencies of the effect above will triggers it.\n    // However, we need to ensure the effect recognizes it's a reset.\n    // The effect depends on 'currentPage'. If we set it to 1, it runs.\n  }, [\n    itemsPerPage,\n    effectiveSearchTerm,\n    sortBy,\n    filters.categories,\n    filters.source,\n    filters.fileType,\n    filters.redFlagLevel,\n  ]);\n\n  // Apply client-side filters (credibility only - other filters handled by API)\n  useEffect(() => {\n    let results = documents;\n\n    // Apply credibility filter\n    if (hideLowCredibility) {\n      results = results.filter((d) => (d.metadata?.credibility_score ?? 1) >= 0.6);\n    }\n\n    setFilteredDocuments(results);\n  }, [documents, hideLowCredibility]);\n\n  // Auto-select document when selectedDocumentId changes\n  useEffect(() => {\n    if (selectedDocumentId) {\n      // If already selected, don't do anything\n      if (selectedDocument?.id === selectedDocumentId) return;\n\n      console.log('DocumentBrowser: selectedDocumentId changed to', selectedDocumentId);\n\n      if (documents.length > 0) {\n        const document = documents.find((doc) => doc.id === selectedDocumentId);\n        if (document) {\n          console.log('DocumentBrowser: Found document in current list, selecting');\n          handleDocumentSelect(document);\n          return;\n        }\n      }\n\n      // If we get here, document was not found in the list or list is empty\n      console.log('DocumentBrowser: Document NOT found in current list, fetching...');\n\n      apiClient\n        .getDocument(selectedDocumentId)\n        .then((docData) => {\n          if (docData) {\n            console.log('DocumentBrowser: Fetched document successfully');\n            // Map to Document type\n            const newDoc: Document = {\n              id: docData.id,\n              title: docData.fileName,\n              filename: docData.fileName,\n              fileType: docData.fileType || 'unknown',\n              fileSize: docData.fileSize || 0,\n              dateCreated: docData.dateCreated,\n              dateModified: docData.dateModified,\n              content: docData.content || '',\n              metadata: {\n                source: 'Epstein Files',\n                confidentiality: 'Public',\n                categories: [],\n                ...docData.metadata,\n              },\n              entities: [],\n              passages: [],\n              redFlagScore: docData.redFlagRating || 0,\n              redFlagRating: docData.redFlagRating || 1,\n              redFlagPeppers: '🚩'.repeat(docData.redFlagRating || 1),\n              redFlagDescription: `Red Flag Index ${docData.redFlagRating || 1}`,\n            };\n\n            handleDocumentSelect(newDoc);\n          }\n        })\n        .catch((err) => console.error('Error fetching selected document:', err));\n    }\n  }, [selectedDocumentId, documents, selectedDocument]);\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps -- collection is stable for this memo\n  const fileTypeOptions = useMemo(() => {\n    if (!collection) return [];\n    return Array.from(collection.fileTypes.entries()).map(([type, count]) => ({\n      value: type,\n      label: `${type} (${count})`,\n    }));\n  }, [collection]);\n\n  const sourceOptions = useMemo(() => {\n    if (!collection) return [];\n    const sources = [...new Set(documents.map((doc) => doc.metadata?.source || 'Unknown'))];\n    return sources.map((source) => ({\n      value: source,\n      label: source,\n    }));\n  }, [collection, documents]);\n\n  const handleFilterChange = (key: keyof BrowseFilters, value: any) => {\n    setFilters((prev) => ({\n      ...prev,\n      [key]: value,\n    }));\n  };\n\n  const handleFileTypeToggle = (fileType: string) => {\n    const current = filters.fileType || [];\n    const updated = current.includes(fileType)\n      ? current.filter((t) => t !== fileType)\n      : [...current, fileType];\n    handleFilterChange('fileType', updated);\n  };\n\n  const handleRedFlagLevelChange = (min: number, max: number) => {\n    handleFilterChange('redFlagLevel', { min, max });\n  };\n\n  const handleDocumentSelect = useCallback(\n    async (document: Document) => {\n      // Set initial document data immediately\n      setSelectedDocument(document);\n\n      try {\n        // Fetch full content from API\n        const fullDoc = await apiClient.getDocument(document.id);\n        if (fullDoc) {\n          setSelectedDocument((prev) =>\n            prev?.id === document.id ? { ...prev, ...fullDoc } : prev,\n          );\n        }\n      } catch (error) {\n        console.error('Error fetching full document content:', error);\n      }\n\n      const related = processor.findRelatedDocuments(document.id, 5);\n      setRelatedDocuments(related);\n    },\n    [processor],\n  );\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  // Virtualized document card for better performance with large lists\n  // const VirtualizedDocumentCard = ({ index, style }: { index: number; style: React.CSSProperties }) => {\n  //   const document = filteredDocuments[index];\n  //   if (!document) return null;\n  //\n  //   return (\n  //     <div style={style} className=\"p-1\">\n  //       <DocumentCard document={document} />\n  //     </div>\n  //   );\n  // };\n\n  const DocumentViewer: React.FC<{ document: Document; searchTerm?: string }> = ({\n    document,\n    searchTerm,\n  }) => {\n    const location = useLocation();\n    const navigate = useNavigate();\n    const [snippetText, setSnippetText] = useState<string>('');\n    const [addingSnippet, setAddingSnippet] = useState<boolean>(false);\n    const [investigationChoice, setInvestigationChoice] = useState<number | null>(null);\n    const [investigationsList, setInvestigationsList] = useState<any[]>([]);\n\n    // Determine active tab from URL\n    type DocumentTab =\n      | 'content'\n      | 'original'\n      | 'entities'\n      | 'related'\n      | 'annotations'\n      | 'redactions';\n\n    const getActiveTab = (): DocumentTab => {\n      const params = new URLSearchParams(location.search);\n      const tab = params.get('docTab') as DocumentTab | null;\n      if (\n        tab &&\n        ['content', 'original', 'entities', 'related', 'annotations', 'redactions'].includes(tab)\n      ) {\n        return tab;\n      }\n      return 'content'; // default\n    };\n\n    const activeTab = getActiveTab();\n\n    // Navigate to a tab\n    const navigateToTab = (tab: string) => {\n      const params = new URLSearchParams(location.search);\n      params.set('docTab', tab);\n      navigate(`${location.pathname}?${params.toString()}`);\n    };\n\n    const [pages, setPages] = useState<string[]>([]);\n    const [loadingPages, setLoadingPages] = useState(false);\n    const [showRaw, setShowRaw] = useState(false);\n    const [currentImageIndex, setCurrentImageIndex] = useState(0);\n    const [viewMode, setViewMode] = useState<'carousel' | 'list'>('carousel');\n    const contentRef = React.useRef<HTMLDivElement>(null);\n\n    // Failed redactions state\n    const [redactionData, setRedactionData] = useState<{\n      hasFailedRedactions: boolean;\n      count: number;\n      redactions: Array<{ page: number; text: string; bbox: number[] }>;\n    } | null>(null);\n    const [loadingRedactions, setLoadingRedactions] = useState(false);\n    const [revealedRedactions, setRevealedRedactions] = useState<Set<number>>(new Set());\n\n    // Reset pages when document changes\n    useEffect(() => {\n      setPages([]);\n      setCurrentImageIndex(0);\n    }, [document.id]);\n\n    // Fetch pages when tab is switched to original or document changes\n    useEffect(() => {\n      if (activeTab === 'original') {\n        const fetchPages = async () => {\n          setLoadingPages(true);\n          try {\n            const result = await apiClient.getDocumentPages(document.id);\n            setPages(result.pages);\n            // Default to carousel if many pages, list if few\n            setViewMode(result.pages.length > 5 ? 'carousel' : 'list');\n          } catch (error) {\n            console.error('Error fetching pages:', error);\n          } finally {\n            setLoadingPages(false);\n          }\n        };\n        fetchPages();\n      }\n    }, [activeTab, document.id]);\n\n    // Fetch redaction data when document changes or redactions tab is opened\n    useEffect(() => {\n      const fetchRedactions = async () => {\n        setLoadingRedactions(true);\n        try {\n          const response = await fetch(`/api/documents/${document.id}/redactions`);\n          if (response.ok) {\n            const data = await response.json();\n            setRedactionData(data);\n            setRevealedRedactions(new Set()); // Reset revealed state\n          }\n        } catch (error) {\n          console.error('Error fetching redaction data:', error);\n        } finally {\n          setLoadingRedactions(false);\n        }\n      };\n\n      fetchRedactions();\n    }, [document.id]);\n\n    // Scroll to first highlight when content or search term changes\n    useEffect(() => {\n      if (searchTerm && activeTab === 'content' && contentRef.current) {\n        // Small timeout to allow rendering to complete\n        const timer = setTimeout(() => {\n          const firstMark = contentRef.current?.querySelector('mark');\n          if (firstMark) {\n            firstMark.scrollIntoView({ behavior: 'smooth', block: 'center' });\n          }\n        }, 100);\n        return () => clearTimeout(timer);\n      }\n    }, [document.id, searchTerm, activeTab]);\n\n    useEffect(() => {\n      const handler = () => {\n        if (!contentRef.current) return;\n        const sel = window.getSelection();\n        if (!sel || sel.isCollapsed) {\n          setSnippetText('');\n          return;\n        }\n        const text = sel.toString();\n        setSnippetText(text.length > 0 ? text : '');\n      };\n      (window.document as any).addEventListener('mouseup', handler);\n      return () => (window.document as any).removeEventListener('mouseup', handler);\n      // We intentionally only depend on setSnippetText, which is stable from React state\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [setSnippetText]);\n\n    const addSnippet = async () => {\n      if (!snippetText || !snippetText.trim()) return;\n      try {\n        setAddingSnippet(true);\n        let invId = investigationChoice;\n        if (!invId) {\n          const resp = await fetch(\n            `/api/investigations/by-title?title=${encodeURIComponent('Sascha Barros Testimony')}`,\n          );\n          if (resp.ok) {\n            const inv = await resp.json();\n            invId = inv.id;\n          }\n        }\n        if (!invId) return;\n        const res = await fetch('/api/investigation/add-snippet', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            investigationId: invId,\n            documentId: document.id,\n            snippetText,\n            notes: '',\n            relevance: 'high',\n          }),\n        });\n        if (res.ok) {\n          setSnippetText('');\n        }\n      } finally {\n        setAddingSnippet(false);\n      }\n    };\n\n    const handleDownload = () => {\n      // Construct download URL for the text file\n      // We can use the file path from the document object if available, or construct it\n      // For now, let's try to download the text content as a file\n      const element = window.document.createElement('a');\n      const file = new Blob([document.content], { type: 'text/plain' });\n      element.href = URL.createObjectURL(file);\n      element.download = `${document.filename || 'document'}.txt`;\n      window.document.body.appendChild(element); // Required for this to work in FireFox\n      element.click();\n      window.document.body.removeChild(element);\n    };\n\n    return createPortal(\n      <div className=\"fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[100] p-0 md:p-4\">\n        <div className=\"bg-gray-900 rounded-none md:rounded-lg w-full h-full md:w-auto md:h-auto md:max-w-6xl md:max-h-[90vh] overflow-hidden flex flex-col shadow-2xl border-0 md:border border-gray-700\">\n          <div className=\"flex flex-col p-4 border-b border-gray-700 bg-gray-800\">\n            {/* Breadcrumb */}\n            <div className=\"mb-2\">\n              <Breadcrumb\n                items={[\n                  {\n                    label: 'Documents',\n                    onClick: () => {\n                      setSelectedDocument(null);\n                      if (onDocumentClose) onDocumentClose();\n                    },\n                  },\n                  { label: document.title || 'Unknown Document' },\n                ]}\n              />\n            </div>\n\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3 min-w-0 flex-1\">\n                <FileText className=\"w-5 h-5 text-blue-400 shrink-0\" />\n                <h2 className=\"text-lg font-semibold text-white truncate\">\n                  {searchTerm ? renderHighlightedText(document.title, searchTerm) : document.title}\n                </h2>\n                <span className=\"text-lg shrink-0\">{document.redFlagPeppers}</span>\n              </div>\n              <div className=\"flex items-center space-x-2 shrink-0\">\n                {/* Pretty/Raw Toggle */}\n                <button\n                  onClick={() => setShowRaw(!showRaw)}\n                  className={`p-2 hover:text-white ${showRaw ? 'text-gray-500' : 'text-blue-400'}`}\n                  title={showRaw ? 'Showing raw OCR text' : 'Showing cleaned text'}\n                >\n                  {showRaw ? <FileText className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                </button>\n                <button\n                  onClick={() => setShowMetadata(!showMetadata)}\n                  className=\"md:hidden p-2 text-gray-400 hover:text-white\"\n                  title=\"Toggle Metadata\"\n                >\n                  <Tag className=\"w-4 h-4\" />\n                </button>\n                <button\n                  onClick={handleDownload}\n                  className=\"p-2 text-gray-400 hover:text-white\"\n                  title=\"Download Text\"\n                >\n                  <Download className=\"w-4 h-4\" />\n                </button>\n                <AddToInvestigationButton\n                  item={{\n                    id: document.id,\n                    title: document.title || document.filename,\n                    description: document.content?.substring(0, 100) || 'Document evidence',\n                    type: 'document',\n                    sourceId: document.id,\n                  }}\n                  investigations={[]} // This needs to be populated from context or props\n                  onAddToInvestigation={(invId, item, relevance) => {\n                    console.log('Add to investigation', invId, item, relevance);\n                    const event = new CustomEvent('add-to-investigation', {\n                      detail: { investigationId: invId, item, relevance },\n                    });\n                    window.dispatchEvent(event);\n                  }}\n                  variant=\"icon\"\n                  className=\"hover:bg-slate-700\"\n                />\n                <button\n                  onClick={() => {\n                    setSelectedDocument(null);\n                    if (onDocumentClose) onDocumentClose();\n                  }}\n                  className=\"p-2 text-gray-400 hover:text-white\"\n                >\n                  ✕\n                </button>\n              </div>\n            </div>\n          </div>\n\n          {/* Tab Navigation */}\n          <div className=\"flex border-b border-gray-700 bg-gray-800 overflow-x-auto scrollbar-hide\">\n            <button\n              onClick={() => navigateToTab('content')}\n              className={`px-4 py-3 text-sm font-medium transition-colors ${\n                activeTab === 'content'\n                  ? 'text-blue-400 border-b-2 border-blue-400 bg-gray-700'\n                  : 'text-gray-400 hover:text-white hover:bg-gray-700'\n              }`}\n            >\n              Text Content\n            </button>\n            <button\n              onClick={() => navigateToTab('original')}\n              className={`px-4 py-3 text-sm font-medium transition-colors ${\n                activeTab === 'original'\n                  ? 'text-blue-400 border-b-2 border-blue-400 bg-gray-700'\n                  : 'text-gray-400 hover:text-white hover:bg-gray-700'\n              }`}\n            >\n              View Original ({pages.length > 0 ? pages.length : '...'})\n            </button>\n            <button\n              onClick={() => navigateToTab('entities')}\n              className={`px-4 py-3 text-sm font-medium transition-colors ${\n                activeTab === 'entities'\n                  ? 'text-blue-400 border-b-2 border-blue-400 bg-gray-700'\n                  : 'text-gray-400 hover:text-white hover:bg-gray-700'\n              }`}\n            >\n              Entities ({document.entities?.length || 0})\n            </button>\n            <button\n              onClick={() => navigateToTab('related')}\n              className={`px-4 py-3 text-sm font-medium transition-colors ${\n                activeTab === 'related'\n                  ? 'text-blue-400 border-b-2 border-blue-400 bg-gray-700'\n                  : 'text-gray-400 hover:text-white hover:bg-gray-700'\n              }`}\n            >\n              Related ({relatedDocuments.length})\n            </button>\n            <button\n              onClick={() => navigateToTab('annotations')}\n              className={`px-4 py-3 text-sm font-medium transition-colors ${\n                activeTab === 'annotations'\n                  ? 'text-blue-400 border-b-2 border-blue-400 bg-gray-700'\n                  : 'text-gray-400 hover:text-white hover:bg-gray-700'\n              }`}\n            >\n              Annotations\n            </button>\n            {/* Hidden Redactions Tab - only show prominently if redactions found */}\n            <button\n              onClick={() => navigateToTab('redactions')}\n              className={`px-4 py-3 text-sm font-medium transition-colors flex items-center gap-2 ${\n                activeTab === 'redactions'\n                  ? 'text-red-400 border-b-2 border-red-400 bg-red-900/30'\n                  : redactionData?.hasFailedRedactions\n                    ? 'text-red-400 hover:text-red-300 hover:bg-red-900/20 animate-pulse'\n                    : 'text-gray-500 hover:text-gray-400 hover:bg-gray-700'\n              }`}\n            >\n              {redactionData?.hasFailedRedactions && <span className=\"text-lg\">🔓</span>}\n              {loadingRedactions\n                ? '...'\n                : redactionData?.hasFailedRedactions\n                  ? `Hidden Text (${redactionData.count})`\n                  : 'Hidden Text'}\n            </button>\n          </div>\n\n          <div className=\"flex-1 overflow-hidden flex\">\n            <div className=\"flex-1 overflow-y-auto p-6 bg-gray-900\" ref={contentRef}>\n              {activeTab === 'content' && (\n                <DocumentContentRenderer\n                  document={document}\n                  searchTerm={searchTerm}\n                  showRaw={showRaw}\n                />\n              )}\n              {activeTab === 'content' && snippetText && (\n                <div className=\"fixed bottom-6 right-6 z-40 bg-gray-800 border border-gray-700 rounded-lg p-3 shadow-xl\">\n                  <div className=\"text-xs text-gray-300 max-w-xs line-clamp-3 mb-2\">\n                    {snippetText}\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <select\n                      value={investigationChoice ?? ''}\n                      onChange={(e) => setInvestigationChoice(parseInt(e.target.value) || null)}\n                      onFocus={async () => {\n                        if (investigationsList.length > 0) return;\n                        const r = await fetch('/api/investigations?page=1&limit=50');\n                        if (r.ok) {\n                          const data = await r.json();\n                          const list = Array.isArray(data?.data)\n                            ? data.data\n                            : Array.isArray(data)\n                              ? data\n                              : [];\n                          setInvestigationsList(list);\n                        }\n                      }}\n                      className=\"text-xs bg-gray-700 text-white border border-gray-600 rounded px-2 py-1\"\n                    >\n                      <option value=\"\">Sascha Barros Testimony</option>\n                      {investigationsList.map((inv: any) => (\n                        <option key={inv.id} value={inv.id}>\n                          {inv.title}\n                        </option>\n                      ))}\n                    </select>\n                    <button\n                      onClick={addSnippet}\n                      disabled={addingSnippet}\n                      className=\"px-3 py-1.5 text-xs rounded bg-blue-600 hover:bg-blue-500 text-white disabled:opacity-50\"\n                    >\n                      Add Snippet\n                    </button>\n                    <button\n                      onClick={() => setSnippetText('')}\n                      className=\"px-2 py-1.5 text-xs rounded bg-gray-700 text-gray-300\"\n                    >\n                      ✕\n                    </button>\n                  </div>\n                </div>\n              )}\n\n              {activeTab === 'original' && (\n                <div className=\"flex flex-col items-center space-y-4 min-h-full w-full\">\n                  {loadingPages ? (\n                    <div className=\"flex items-center justify-center h-64\">\n                      <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-400\"></div>\n                    </div>\n                  ) : pages.length > 0 ? (\n                    <>\n                      {/* View Mode Toggle */}\n                      <div className=\"flex justify-end w-full max-w-4xl px-4 sticky top-0 z-10 py-2 bg-gray-900/95 backdrop-blur\">\n                        <div className=\"bg-gray-800 rounded-lg p-1 flex space-x-1\">\n                          <button\n                            onClick={() => setViewMode('carousel')}\n                            className={`px-3 py-1 text-xs rounded transition-colors ${viewMode === 'carousel' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'}`}\n                          >\n                            Carousel\n                          </button>\n                          <button\n                            onClick={() => setViewMode('list')}\n                            className={`px-3 py-1 text-xs rounded transition-colors ${viewMode === 'list' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'}`}\n                          >\n                            List\n                          </button>\n                        </div>\n                      </div>\n\n                      {viewMode === 'carousel' ? (\n                        <div className=\"flex flex-col items-center w-full\">\n                          <div className=\"relative w-full max-w-4xl aspect-[3/4] md:aspect-auto md:h-[75vh] bg-black rounded-lg flex items-center justify-center overflow-hidden border border-gray-700\">\n                            <img\n                              src={\n                                pages[currentImageIndex].startsWith('/')\n                                  ? pages[currentImageIndex]\n                                  : `/${pages[currentImageIndex]}`\n                              }\n                              alt={`Page ${currentImageIndex + 1}`}\n                              className=\"max-w-full max-h-full object-contain\"\n                            />\n\n                            {/* Controls */}\n                            <button\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                setCurrentImageIndex((prev) => Math.max(0, prev - 1));\n                              }}\n                              disabled={currentImageIndex === 0}\n                              className=\"absolute left-4 top-1/2 -translate-y-1/2 p-3 bg-black/50 text-white rounded-full hover:bg-black/80 disabled:opacity-30 transition-all backdrop-blur-sm\"\n                            >\n                              <ChevronDown className=\"w-6 h-6 rotate-90\" />\n                            </button>\n\n                            <button\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                setCurrentImageIndex((prev) =>\n                                  Math.min(pages.length - 1, prev + 1),\n                                );\n                              }}\n                              disabled={currentImageIndex === pages.length - 1}\n                              className=\"absolute right-4 top-1/2 -translate-y-1/2 p-3 bg-black/50 text-white rounded-full hover:bg-black/80 disabled:opacity-30 transition-all backdrop-blur-sm\"\n                            >\n                              <ChevronDown className=\"w-6 h-6 -rotate-90\" />\n                            </button>\n\n                            <div className=\"absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/60 px-4 py-1.5 rounded-full text-sm text-white backdrop-blur-sm\">\n                              Page {currentImageIndex + 1} of {pages.length}\n                            </div>\n                          </div>\n\n                          {/* Thumbnail Strip */}\n                          <div className=\"mt-4 w-full max-w-4xl overflow-x-auto flex space-x-2 p-2 scrollbar-hide\">\n                            {pages.map((page, idx) => (\n                              <button\n                                key={idx}\n                                onClick={() => setCurrentImageIndex(idx)}\n                                className={`flex-shrink-0 w-16 h-20 rounded overflow-hidden border-2 transition-all ${idx === currentImageIndex ? 'border-blue-500 opacity-100 ring-2 ring-blue-500/30' : 'border-transparent opacity-40 hover:opacity-80'}`}\n                              >\n                                <img\n                                  src={page.startsWith('/') ? page : `/${page}`}\n                                  className=\"w-full h-full object-cover\"\n                                  loading=\"lazy\"\n                                />\n                              </button>\n                            ))}\n                          </div>\n                        </div>\n                      ) : (\n                        // List View\n                        pages.map((pageUrl, index) => (\n                          <div\n                            key={index}\n                            className=\"w-full max-w-3xl bg-white p-1 rounded shadow-lg\"\n                          >\n                            <img\n                              src={pageUrl.startsWith('/') ? pageUrl : `/${pageUrl}`}\n                              alt={`Page ${index + 1}`}\n                              className=\"w-full h-auto\"\n                              loading=\"lazy\"\n                            />\n                            <div className=\"text-center text-gray-500 text-xs py-1\">\n                              Page {index + 1}\n                            </div>\n                          </div>\n                        ))\n                      )}\n                    </>\n                  ) : (\n                    <div className=\"flex flex-col items-center justify-center h-64 text-gray-400\">\n                      <FileText className=\"w-16 h-16 mb-4 opacity-50\" />\n                      <p>No original images found for this document.</p>\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {activeTab === 'entities' && (\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-lg font-semibold text-white mb-4\">\n                    Entities Found in Document\n                  </h3>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    {(document.entities || []).map((entity, index) => (\n                      <div\n                        key={index}\n                        className=\"bg-gray-800 rounded-lg p-4 border border-gray-700\"\n                      >\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <h4 className=\"font-medium text-white\">\n                            {searchTerm\n                              ? renderHighlightedText(entity.name, searchTerm)\n                              : entity.name}\n                          </h4>\n                          <span className=\"text-xs text-gray-400 capitalize bg-gray-700 px-2 py-1 rounded\">\n                            {entity.type}\n                          </span>\n                        </div>\n                        <div className=\"text-sm text-gray-300 mb-2\">\n                          Mentioned {entity.mentions} times\n                        </div>\n                        <div className=\"text-xs text-gray-400 capitalize\">\n                          Significance: {entity.significance}\n                        </div>\n                        {entity.contexts.length > 0 && (\n                          <div className=\"mt-3 pt-3 border-t border-gray-700\">\n                            <div className=\"text-xs text-gray-400 mb-2\">Context:</div>\n                            <div className=\"text-xs text-gray-300 italic\">\n                              {searchTerm\n                                ? renderHighlightedText(\n                                    `\"${entity.contexts[0].context}\"`,\n                                    searchTerm,\n                                  )\n                                : `\"${entity.contexts[0].context}\"`}\n                            </div>\n                            {/* Source badge for entity context */}\n                            <div className=\"mt-2\">\n                              <SourceBadge\n                                source={entity.contexts[0]?.source || 'Seventh Production'}\n                              />\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {activeTab === 'related' && (\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-lg font-semibold text-white mb-4\">Related Documents</h3>\n                  {relatedDocuments.length > 0 ? (\n                    <div className=\"grid grid-cols-1 gap-4\">\n                      {relatedDocuments.map((relatedDoc) => (\n                        <div\n                          key={relatedDoc.id}\n                          className=\"bg-gray-800 rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition-colors border border-gray-700\"\n                          onClick={() => handleDocumentSelect(relatedDoc)}\n                        >\n                          <div className=\"flex items-start justify-between mb-2\">\n                            <h4 className=\"font-medium text-white line-clamp-1\">\n                              {searchTerm\n                                ? renderHighlightedText(relatedDoc.title, searchTerm)\n                                : relatedDoc.title}\n                              {relatedDoc.title !== relatedDoc.filename && (\n                                <span className=\"text-xs text-gray-400 ml-2 font-normal\">\n                                  ({relatedDoc.filename})\n                                </span>\n                              )}\n                            </h4>\n                            <span className=\"text-lg\">{relatedDoc.redFlagPeppers}</span>\n                          </div>\n                          <div className=\"text-sm text-gray-300 mb-2 line-clamp-2\">\n                            {searchTerm\n                              ? renderHighlightedText(\n                                  relatedDoc.content.substring(0, 150) + '...',\n                                  searchTerm,\n                                )\n                              : relatedDoc.content.substring(0, 150) + '...'}\n                          </div>\n                          <div className=\"flex items-center justify-between text-xs text-gray-400\">\n                            <span>{relatedDoc.fileType}</span>\n                            <span>{formatFileSize(relatedDoc.fileSize)}</span>\n                          </div>\n                          {/* Source badge for related document */}\n                          <div className=\"mt-2\">\n                            <SourceBadge\n                              source={relatedDoc.metadata?.source || 'Seventh Production'}\n                            />\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-8 text-gray-400\">\n                      <Network className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                      <p>No related documents found</p>\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {activeTab === 'annotations' && (\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h3 className=\"text-lg font-semibold text-white\">Document Annotations</h3>\n                    <div className=\"text-sm text-gray-400\">Evidence collection and analysis</div>\n                  </div>\n                  <DocumentAnnotationSystem\n                    documentId={document.id}\n                    content={document.content}\n                    searchTerm={searchTerm}\n                    renderHighlightedText={renderHighlightedText}\n                    mode=\"full\"\n                  />\n                </div>\n              )}\n\n              {activeTab === 'redactions' && (\n                <div className=\"space-y-6\">\n                  <div className=\"flex items-center justify-between\">\n                    <h3 className=\"text-2xl font-bold text-red-400 flex items-center gap-3\">\n                      <span className=\"text-3xl\">🔓</span>\n                      Failed Redactions Detected\n                    </h3>\n                    <div className=\"text-sm text-gray-400\">\n                      Text hidden under black boxes but still extractable\n                    </div>\n                  </div>\n\n                  {loadingRedactions ? (\n                    <div className=\"flex items-center justify-center h-64\">\n                      <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-red-400\"></div>\n                    </div>\n                  ) : redactionData?.hasFailedRedactions && redactionData.redactions.length > 0 ? (\n                    <div className=\"space-y-4\">\n                      {/* Warning banner */}\n                      <div className=\"bg-red-900/30 border border-red-700/50 rounded-lg p-4 text-red-200\">\n                        <div className=\"flex items-start gap-3\">\n                          <span className=\"text-2xl\">⚠️</span>\n                          <div>\n                            <h4 className=\"font-semibold\">Improperly Redacted Document</h4>\n                            <p className=\"text-sm text-red-300/80 mt-1\">\n                              This document appears to have {redactionData.count} redaction(s) that\n                              were improperly applied. The text was covered with black boxes but not\n                              actually removed from the PDF.\n                              <strong className=\"text-red-200\">\n                                {' '}\n                                Click each card below to reveal the hidden text.\n                              </strong>\n                            </p>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Reveal all button */}\n                      <div className=\"flex justify-end\">\n                        <button\n                          onClick={() => {\n                            const allIndices = new Set(redactionData.redactions.map((_, i) => i));\n                            setRevealedRedactions(allIndices);\n                          }}\n                          className=\"px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2\"\n                        >\n                          <span>👁️</span> Reveal All Hidden Text\n                        </button>\n                      </div>\n\n                      {/* Redaction cards */}\n                      <div className=\"grid gap-4\">\n                        {redactionData.redactions.map((redaction, index) => (\n                          <div\n                            key={index}\n                            onClick={() => {\n                              const newRevealed = new Set(revealedRedactions);\n                              newRevealed.add(index);\n                              setRevealedRedactions(newRevealed);\n                            }}\n                            className={`relative overflow-hidden rounded-lg border transition-all duration-500 cursor-pointer ${\n                              revealedRedactions.has(index)\n                                ? 'bg-gray-800 border-red-600'\n                                : 'bg-black border-gray-700 hover:border-red-500'\n                            }`}\n                          >\n                            {/* Page indicator */}\n                            <div className=\"absolute top-2 right-2 px-2 py-1 bg-gray-700 rounded text-xs text-gray-300\">\n                              Page {redaction.page}\n                            </div>\n\n                            {!revealedRedactions.has(index) ? (\n                              /* Hidden state - scratch card effect */\n                              <div className=\"p-6 min-h-[120px] flex flex-col items-center justify-center text-center\">\n                                <div className=\"relative\">\n                                  <div\n                                    className=\"absolute inset-0 bg-gradient-to-r from-gray-800 via-gray-700 to-gray-800 animate-pulse rounded\"\n                                    style={{ filter: 'blur(8px)' }}\n                                  />\n                                  <div className=\"relative z-10 text-6xl mb-3 opacity-80\">🔒</div>\n                                </div>\n                                <p className=\"text-gray-400 text-sm mb-2\">\n                                  Hidden text detected under redaction\n                                </p>\n                                <p className=\"text-red-400 text-xs font-medium animate-pulse\">\n                                  Click to reveal what they tried to hide\n                                </p>\n                              </div>\n                            ) : (\n                              /* Revealed state */\n                              <div className=\"p-6\">\n                                <div className=\"flex items-start gap-3\">\n                                  <span className=\"text-2xl\">📝</span>\n                                  <div className=\"flex-1\">\n                                    <div className=\"text-xs text-red-400 uppercase tracking-wide mb-2 font-semibold\">\n                                      Hidden Text Revealed\n                                    </div>\n                                    <blockquote className=\"text-white text-lg font-mono bg-red-900/20 p-4 rounded border-l-4 border-red-500 leading-relaxed\">\n                                      \"{redaction.text}\"\n                                    </blockquote>\n                                  </div>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  ) : (\n                    <div className=\"flex flex-col items-center justify-center h-64 text-gray-400\">\n                      <div className=\"text-6xl mb-4 opacity-50\">✓</div>\n                      <h4 className=\"text-xl font-medium text-gray-300 mb-2\">\n                        No Failed Redactions Found\n                      </h4>\n                      <p className=\"text-center max-w-md\">\n                        This document doesn't appear to have any improperly redacted text.\n                        Redactions were either applied correctly or this document wasn't redacted.\n                      </p>\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n\n            {/* Metadata Sidebar - Collapsible on Mobile */}\n            <div\n              className={`\n            ${showMetadata ? 'block' : 'hidden'} \n            md:block \n            w-full md:w-80 \n            border-t md:border-t-0 md:border-l border-gray-700 \n            p-4 \n            overflow-y-auto \n            bg-gray-800 md:bg-transparent\n            absolute md:static bottom-0 left-0 right-0 top-1/2 md:top-auto z-20\n          `}\n            >\n              <div className=\"flex justify-between items-center md:hidden mb-4\">\n                <h3 className=\"font-semibold text-white\">Document Metadata</h3>\n                <button\n                  onClick={() => setShowMetadata(false)}\n                  className=\"text-gray-400 hover:text-white\"\n                >\n                  ✕\n                </button>\n              </div>\n              <div className=\"space-y-6\">\n                <div>\n                  <h3 className=\"text-sm font-semibold text-white mb-2 flex items-center\">\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Document Info\n                  </h3>\n                  <div className=\"space-y-2 text-sm\">\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-400\">Filename:</span>\n                      <span className=\"text-gray-300\">\n                        {searchTerm\n                          ? renderHighlightedText(document.filename, searchTerm)\n                          : document.filename}\n                      </span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-400\">Size:</span>\n                      <span className=\"text-gray-300\">{formatFileSize(document.fileSize)}</span>\n                    </div>\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-400\">Source:</span>\n                      <span className=\"text-gray-300\">\n                        <SourceBadge\n                          source={\n                            document.metadata.source_collection ||\n                            document.metadata.source ||\n                            'Unknown'\n                          }\n                        />\n                      </span>\n                    </div>\n                    {document.metadata?.source_original_url && (\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-gray-400\">Source URL:</span>\n                        <a\n                          href={document.metadata.source_original_url}\n                          target=\"_blank\"\n                          rel=\"noreferrer\"\n                          className=\"text-blue-400 hover:text-blue-300 truncate max-w-[12rem]\"\n                        >\n                          {document.metadata.source_original_url}\n                        </a>\n                      </div>\n                    )}\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-400\">Confidentiality:</span>\n                      <span className=\"text-gray-300\">{document.metadata.confidentiality}</span>\n                    </div>\n                  </div>\n                  <div className=\"mt-3\">\n                    <h4 className=\"text-sm font-semibold text-white mb-1\">Credibility</h4>\n                    <div className=\"text-sm text-gray-300\">\n                      {typeof document.metadata?.credibility_score === 'number'\n                        ? `${Math.round((document.metadata.credibility_score as number) * 100) / 100}`\n                        : 'Unknown'}\n                    </div>\n                  </div>\n                  {Array.isArray(document.metadata?.sensitivity_flags) &&\n                    (document.metadata!.sensitivity_flags as any[]).length > 0 && (\n                      <div className=\"mt-3\">\n                        <h4 className=\"text-sm font-semibold text-white mb-1\">Sensitivity</h4>\n                        <div className=\"flex flex-wrap gap-1\">\n                          {(document.metadata!.sensitivity_flags as any[]).map(\n                            (flag: string, idx: number) => (\n                              <span\n                                key={idx}\n                                className=\"px-2 py-1 bg-yellow-900 text-yellow-200 text-xs rounded\"\n                              >\n                                {flag}\n                              </span>\n                            ),\n                          )}\n                        </div>\n                      </div>\n                    )}\n                </div>\n\n                {document.metadata?.categories?.length > 0 && (\n                  <div>\n                    <h3 className=\"text-sm font-semibold text-white mb-2 flex items-center\">\n                      <Tag className=\"w-4 h-4 mr-2\" />\n                      Categories\n                    </h3>\n                    <div className=\"flex flex-wrap gap-1\">\n                      {document.metadata.categories.map((cat, index) => (\n                        <span\n                          key={index}\n                          className=\"px-2 py-1 bg-blue-900 text-blue-200 text-xs rounded\"\n                        >\n                          {searchTerm ? renderHighlightedText(cat, searchTerm) : cat}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {document.entities?.length > 0 && (\n                  <div>\n                    <h3 className=\"text-sm font-semibold text-white mb-2 flex items-center\">\n                      <Users className=\"w-4 h-4 mr-2\" />\n                      Entities ({document.entities?.length})\n                    </h3>\n                    <div className=\"space-y-2\">\n                      {document.entities?.slice(0, 10).map((entity, index) => (\n                        <div key={index} className=\"text-sm\">\n                          <div className=\"flex justify-between items-center\">\n                            <span className=\"text-gray-300\">\n                              {searchTerm\n                                ? renderHighlightedText(entity.name, searchTerm)\n                                : entity.name}\n                            </span>\n                            <span className=\"text-xs text-gray-500\">{entity.mentions}x</span>\n                          </div>\n                          <div className=\"text-xs text-gray-500 capitalize\">{entity.type}</div>\n                        </div>\n                      ))}\n                      {(document.entities?.length || 0) > 10 && (\n                        <div className=\"text-xs text-gray-400\">\n                          +{(document.entities?.length || 0) - 10} more entities\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                )}\n\n                <div>\n                  <h3 className=\"text-sm font-semibold text-white mb-2\">Red Flag Index</h3>\n                  <div className=\"flex items-center space-x-2\">\n                    <span className=\"text-slate-400\">Red Flag Index:</span>\n                    <div className=\"flex space-x-1\">\n                      {Array.from({ length: 5 }).map((_, i) => (\n                        <span\n                          key={i}\n                          className={i < document.redFlagRating ? 'text-red-500' : 'text-slate-600'}\n                        >\n                          🚩\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>,\n      window.document.body,\n    );\n  };\n\n  return (\n    <div className=\"min-h-screen text-white overflow-x-hidden\">\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"mb-8\">\n          <h1 className=\"text-3xl font-bold mb-4\">Document Browser</h1>\n          <p className=\"text-gray-400\">Browse and search through the Epstein files collection</p>\n        </div>\n\n        {/* Search and Filters */}\n        <div className=\"mb-6 space-y-4\">\n          {/* Search bar and filter button - stack on mobile */}\n          <div className=\"flex flex-col sm:flex-row gap-3 sm:items-center\">\n            <div className=\"flex-1 relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400\" />\n              <input\n                type=\"text\"\n                placeholder=\"Search documents, entities, or content...\"\n                value={effectiveSearchTerm || ''}\n                onChange={(e) => {\n                  const newValue = e.target.value;\n                  // Update both external handler and context\n                  if (onSearchTermChange) {\n                    onSearchTermChange(newValue);\n                  } else {\n                    setContextSearchTerm(newValue);\n                  }\n                }}\n                className=\"w-full pl-10 pr-4 py-3 bg-gray-900 border border-gray-700 rounded-lg focus:outline-none focus:border-blue-500 min-h-[44px]\"\n              />\n            </div>\n            {hasHighlights && (\n              <HighlightNavigationControls\n                currentHighlightIndex={currentHighlightIndex}\n                totalHighlights={totalHighlights}\n                onNext={nextHighlight}\n                onPrev={prevHighlight}\n                className=\"bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 shrink-0\"\n              />\n            )}\n            <button\n              onClick={() => setShowFilters(!showFilters)}\n              className=\"flex items-center justify-center gap-2 px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 min-h-[44px] shrink-0\"\n            >\n              <Filter className=\"w-4 h-4\" />\n              <span>Filters</span>\n              {showFilters ? (\n                <ChevronDown className=\"w-4 h-4\" />\n              ) : (\n                <ChevronRight className=\"w-4 h-4\" />\n              )}\n            </button>\n          </div>\n\n          {/* Category Type Filter Buttons - Horizontal scroll on mobile */}\n          <div className=\"flex flex-wrap gap-2 items-center\">\n            {[\n              { type: 'all', label: 'All Documents', icon: '📁' },\n              { type: 'legal', label: 'Legal', icon: '⚖️' },\n              { type: 'email', label: 'Email', icon: '📧' },\n              { type: 'deposition', label: 'Deposition', icon: '📜' },\n              { type: 'article', label: 'Article', icon: '📰' },\n              { type: 'photo', label: 'Photo', icon: '📷' },\n              { type: 'financial', label: 'Financial', icon: '💰' },\n              { type: 'document', label: 'Document', icon: '📄' },\n            ].map(({ type, label, icon }) => (\n              <button\n                key={type}\n                onClick={() => {\n                  if (type === 'all') {\n                    handleFilterChange('categories', []);\n                  } else {\n                    handleFilterChange('categories', [type]);\n                  }\n                }}\n                className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-all shadow-sm backdrop-blur-sm shrink-0 ${\n                  (type === 'all' && (!filters.categories || filters.categories.length === 0)) ||\n                  filters.categories?.includes(type)\n                    ? 'bg-blue-600 text-white border border-blue-500 shadow-blue-500/20'\n                    : 'bg-gray-800 text-gray-300 border border-gray-700 hover:bg-gray-700 hover:text-white'\n                }`}\n              >\n                <span>{icon}</span>\n                <span>{label}</span>\n              </button>\n            ))}\n          </div>\n\n          {/* Significance and Sort Chips */}\n          <div className=\"flex flex-wrap items-center gap-2 mt-2\">\n            {/* High Significance Filter */}\n            <button\n              onClick={() => {\n                const isActive = filters.redFlagLevel?.min === 4 && filters.redFlagLevel?.max === 5;\n                handleRedFlagLevelChange(isActive ? 0 : 4, 5);\n              }}\n              className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-all shadow-sm backdrop-blur-sm shrink-0 ${\n                filters.redFlagLevel?.min === 4\n                  ? 'bg-red-900/80 text-white border border-red-500 shadow-red-500/20'\n                  : 'bg-gray-800 text-gray-300 border border-gray-700 hover:bg-gray-700 hover:text-white'\n              }`}\n            >\n              <div\n                className={`w-2 h-2 rounded-full ${filters.redFlagLevel?.min === 4 ? 'bg-red-400' : 'bg-red-600'}`}\n              ></div>\n              <span>High Significance</span>\n            </button>\n\n            {/* Medium Significance Filter */}\n            <button\n              onClick={() => {\n                const isActive = filters.redFlagLevel?.min === 2 && filters.redFlagLevel?.max === 3;\n                // If active, reset to default (0-5). If not, set to Medium (2-3)\n                handleRedFlagLevelChange(isActive ? 0 : 2, isActive ? 5 : 3);\n              }}\n              className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-all shadow-sm backdrop-blur-sm shrink-0 ${\n                filters.redFlagLevel?.min === 2 && filters.redFlagLevel?.max === 3\n                  ? 'bg-amber-900/80 text-white border border-amber-500 shadow-amber-500/20'\n                  : 'bg-gray-800 text-gray-300 border border-gray-700 hover:bg-gray-700 hover:text-white'\n              }`}\n            >\n              <div\n                className={`w-2 h-2 rounded-full ${filters.redFlagLevel?.min === 2 && filters.redFlagLevel?.max === 3 ? 'bg-amber-400' : 'bg-amber-600'}`}\n              ></div>\n              <span>Medium</span>\n            </button>\n\n            {/* Sort Chip - Pushed to Right */}\n            <div className=\"ml-auto\">\n              <button\n                onClick={() => {\n                  // Cycle sort: Date Desc -> Date Asc -> Red Flag Desc\n                  if (sortBy === 'date' && sortOrder === 'desc') {\n                    setSortBy('date');\n                    setSortOrder('asc');\n                  } else if (sortBy === 'date' && sortOrder === 'asc') {\n                    setSortBy('red_flag');\n                    setSortOrder('desc');\n                  } else {\n                    setSortBy('date');\n                    setSortOrder('desc');\n                  }\n                }}\n                className=\"flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium bg-slate-800 border border-slate-600 text-slate-300 hover:text-white hover:bg-slate-700 transition-colors shadow-sm\"\n              >\n                {sortOrder === 'desc' ? (\n                  <ChevronDown className=\"w-3 h-3\" />\n                ) : (\n                  <ChevronRight className=\"w-3 h-3 -rotate-90\" />\n                )}\n                <span>\n                  {sortBy === 'date' && sortOrder === 'desc'\n                    ? 'Newest First'\n                    : sortBy === 'date' && sortOrder === 'asc'\n                      ? 'Oldest First'\n                      : sortBy === 'red_flag'\n                        ? 'Highest Risk'\n                        : 'Sort'}\n                </span>\n              </button>\n            </div>\n          </div>\n\n          {/* Desktop inline filters (hidden on mobile) */}\n          {showFilters && (\n            <div className=\"hidden md:block bg-gray-900 border border-gray-700 rounded-lg p-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                {/* File Type Filter */}\n                <div>\n                  <label className=\"block text-sm font-medium mb-2\">File Type</label>\n                  <div className=\"space-y-1\">\n                    {fileTypeOptions.map((option) => (\n                      <label key={option.value} className=\"flex items-center\">\n                        <input\n                          type=\"checkbox\"\n                          checked={filters.fileType?.includes(option.value) || false}\n                          onChange={() => handleFileTypeToggle(option.value)}\n                          className=\"mr-2\"\n                        />\n                        <span className=\"text-sm\">{option.label}</span>\n                      </label>\n                    ))}\n                  </div>\n                </div>\n\n                {/* Source Filter */}\n                <div>\n                  <label className=\"block text-sm font-medium mb-2\">Source</label>\n                  <select\n                    multiple\n                    value={filters.source || []}\n                    onChange={(e) =>\n                      handleFilterChange(\n                        'source',\n                        Array.from(e.target.selectedOptions, (option) => option.value),\n                      )\n                    }\n                    className=\"w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm h-24\"\n                  >\n                    {sourceOptions.map((option) => (\n                      <option key={option.value} value={option.value}>\n                        {option.label}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n\n                {/* Spice Level Filter */}\n                <div>\n                  <label className=\"block text-sm font-medium mb-2\">Red Flag Index</label>\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center space-x-2\">\n                      <span className=\"text-xs text-gray-400\">🚩</span>\n                      <input\n                        type=\"range\"\n                        min=\"1\"\n                        max=\"5\"\n                        value={filters.redFlagLevel?.min || 0}\n                        onChange={(e) =>\n                          handleRedFlagLevelChange(\n                            parseInt(e.target.value),\n                            filters.redFlagLevel?.max || 5,\n                          )\n                        }\n                        className=\"flex-1\"\n                      />\n                      <span className=\"text-xs text-gray-400\">🚩🚩🚩🚩🚩</span>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <span className=\"text-xs text-gray-400\">\n                        Min: {filters.redFlagLevel?.min || 0}\n                      </span>\n                      <span className=\"text-xs text-gray-400\">\n                        Max: {filters.redFlagLevel?.max || 5}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Sort Options */}\n                <div>\n                  <label className=\"block text-sm font-medium mb-2\">Sort By</label>\n                  <select\n                    value={sortBy}\n                    onChange={(e) => setSortBy(e.target.value as any)}\n                    className=\"w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mb-2\"\n                  >\n                    <option value=\"relevance\">Relevance</option>\n                    <option value=\"date\">Date</option>\n                    <option value=\"red_flag\">Red Flag Index</option>\n                    <option value=\"fileType\">File Type</option>\n                    <option value=\"size\">File Size</option>\n                  </select>\n                  <select\n                    value={sortOrder}\n                    onChange={(e) => setSortOrder(e.target.value as any)}\n                    className=\"w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm\"\n                  >\n                    <option value=\"desc\">Descending</option>\n                    <option value=\"asc\">Ascending</option>\n                  </select>\n                </div>\n                {/* Credibility Filter */}\n                <div>\n                  <label className=\"block text-sm font-medium mb-2\">Reliability</label>\n                  <label\n                    className=\"flex items-center text-sm\"\n                    title=\"Hide documents flagged as low credibility based on source and provenance\"\n                  >\n                    <input\n                      type=\"checkbox\"\n                      checked={hideLowCredibility}\n                      onChange={(e) => setHideLowCredibility(e.target.checked)}\n                      className=\"mr-2\"\n                    />\n                    Hide low credibility material\n                  </label>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Mobile Filter Bottom Sheet */}\n          <AnimatePresence>\n            {showFilters && (\n              <>\n                <motion.div\n                  initial={{ opacity: 0 }}\n                  animate={{ opacity: 1 }}\n                  exit={{ opacity: 0 }}\n                  className=\"fixed inset-0 bg-black/60 z-40 md:hidden\"\n                  onClick={() => setShowFilters(false)}\n                />\n                <motion.div\n                  initial={{ y: '100%' }}\n                  animate={{ y: 0 }}\n                  exit={{ y: '100%' }}\n                  transition={{ type: 'spring', damping: 25, stiffness: 300 }}\n                  className=\"fixed bottom-0 left-0 right-0 bg-slate-900 rounded-t-3xl z-50 md:hidden max-h-[80vh] overflow-hidden\"\n                >\n                  <div className=\"flex justify-center py-3\">\n                    <div className=\"w-10 h-1 bg-slate-700 rounded-full\" />\n                  </div>\n                  <div className=\"px-4 pb-2 flex items-center justify-between\">\n                    <h2 className=\"text-lg font-bold text-white\">Filters</h2>\n                    <button\n                      onClick={() => setShowFilters(false)}\n                      className=\"p-2 text-slate-400 hover:text-white\"\n                    >\n                      ✕\n                    </button>\n                  </div>\n                  <div className=\"overflow-y-auto pb-8 px-4 space-y-6 max-h-[calc(80vh-80px)]\">\n                    {/* Sort Options */}\n                    <div>\n                      <label className=\"block text-sm font-medium mb-2 text-slate-300\">\n                        Sort By\n                      </label>\n                      <select\n                        value={sortBy}\n                        onChange={(e) => setSortBy(e.target.value as any)}\n                        className=\"w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-3 text-sm text-white\"\n                      >\n                        <option value=\"relevance\">Relevance</option>\n                        <option value=\"date\">Date</option>\n                        <option value=\"red_flag\">Red Flag Index</option>\n                        <option value=\"fileType\">File Type</option>\n                        <option value=\"size\">File Size</option>\n                      </select>\n                    </div>\n\n                    {/* Sort Order */}\n                    <div>\n                      <label className=\"block text-sm font-medium mb-2 text-slate-300\">Order</label>\n                      <div className=\"flex gap-2\">\n                        <button\n                          onClick={() => setSortOrder('desc')}\n                          className={`flex-1 py-3 rounded-lg text-sm font-medium transition-colors ${\n                            sortOrder === 'desc'\n                              ? 'bg-blue-600 text-white'\n                              : 'bg-slate-800 text-slate-300 border border-slate-700'\n                          }`}\n                        >\n                          Descending\n                        </button>\n                        <button\n                          onClick={() => setSortOrder('asc')}\n                          className={`flex-1 py-3 rounded-lg text-sm font-medium transition-colors ${\n                            sortOrder === 'asc'\n                              ? 'bg-blue-600 text-white'\n                              : 'bg-slate-800 text-slate-300 border border-slate-700'\n                          }`}\n                        >\n                          Ascending\n                        </button>\n                      </div>\n                    </div>\n\n                    {/* Red Flag Index */}\n                    <div>\n                      <label className=\"block text-sm font-medium mb-2 text-slate-300\">\n                        Red Flag Index\n                      </label>\n                      <div className=\"bg-slate-800 rounded-lg p-4 border border-slate-700\">\n                        <div className=\"flex items-center justify-between mb-3\">\n                          <span className=\"text-2xl\">🚩</span>\n                          <span className=\"text-slate-300 text-sm\">\n                            {filters.redFlagLevel?.min || 0} - {filters.redFlagLevel?.max || 5}\n                          </span>\n                          <span className=\"text-2xl\">🚩🚩🚩🚩🚩</span>\n                        </div>\n                        <input\n                          type=\"range\"\n                          min=\"0\"\n                          max=\"5\"\n                          value={filters.redFlagLevel?.min || 0}\n                          onChange={(e) =>\n                            handleRedFlagLevelChange(\n                              parseInt(e.target.value),\n                              filters.redFlagLevel?.max || 5,\n                            )\n                          }\n                          className=\"w-full\"\n                        />\n                      </div>\n                    </div>\n\n                    {/* Credibility Filter */}\n                    <div>\n                      <label className=\"flex items-center gap-3 p-4 bg-slate-800 rounded-lg border border-slate-700\">\n                        <input\n                          type=\"checkbox\"\n                          checked={hideLowCredibility}\n                          onChange={(e) => setHideLowCredibility(e.target.checked)}\n                          className=\"w-5 h-5 rounded\"\n                        />\n                        <span className=\"text-sm text-slate-300\">\n                          Hide low credibility material\n                        </span>\n                      </label>\n                    </div>\n\n                    {/* Apply Button */}\n                    <button\n                      onClick={() => setShowFilters(false)}\n                      className=\"w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-lg transition-colors\"\n                    >\n                      Apply Filters\n                    </button>\n                  </div>\n                </motion.div>\n              </>\n            )}\n          </AnimatePresence>\n        </div>\n\n        {/* Results Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6\">\n          <div className=\"flex items-center space-x-4 flex-wrap gap-2\">\n            <div className=\"text-gray-400\">\n              Showing {filteredDocuments.length} of {totalDocuments.toLocaleString()} documents\n            </div>\n            {/* Page Size Selector */}\n            <div className=\"flex items-center gap-2\">\n              <label className=\"text-sm text-gray-500\">Per page:</label>\n              <select\n                value={itemsPerPage}\n                onChange={(e) => {\n                  setItemsPerPage(Number(e.target.value));\n                  setCurrentPage(1); // Reset to first page\n                }}\n                className=\"bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm text-white\"\n              >\n                <option value={25}>25</option>\n                <option value={50}>50</option>\n                <option value={100}>100</option>\n                <option value={200}>200</option>\n              </select>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <button\n                onClick={() => setViewMode('grid')}\n                className={`p-2 rounded ${viewMode === 'grid' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}`}\n              >\n                <FileText className=\"w-4 h-4\" />\n              </button>\n              <button\n                onClick={() => setViewMode('list')}\n                className={`p-2 rounded ${viewMode === 'list' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}`}\n              >\n                <Search className=\"w-4 h-4\" />\n              </button>\n            </div>\n          </div>\n          <div className=\"text-sm text-gray-500\">\n            {effectiveSearchTerm && `Searching for: \"${effectiveSearchTerm}\"`}\n          </div>\n        </div>\n\n        {/* Document Grid/List - Virtualized */}\n        {documents.length === 0 && filteredDocuments.length === 0 ? (\n          <DocumentSkeleton count={12} />\n        ) : filteredDocuments.length > 0 && viewMode === 'grid' ? (\n          // Virtualized grid view\n          <div\n            ref={documentContainerRef}\n            style={{ height: 'calc(100vh - 400px)', minHeight: '500px' }}\n          >\n            <AutoSizer>\n              {({ height, width }) => {\n                const columnCount = width >= 1024 ? 3 : width >= 768 ? 2 : 1;\n                const columnWidth = Math.floor(width / columnCount);\n                const rowHeight = 280;\n                const rowCount = Math.ceil(filteredDocuments.length / columnCount);\n\n                const itemData: DocItemData = {\n                  documents: filteredDocuments,\n                  onDocumentSelect: handleDocumentSelect,\n                  formatFileSize,\n                  formatDate,\n                  searchTerm: effectiveSearchTerm,\n                  columnCount,\n                };\n\n                return (\n                  <Grid\n                    columnCount={columnCount}\n                    columnWidth={columnWidth}\n                    height={height}\n                    rowCount={rowCount}\n                    rowHeight={rowHeight}\n                    width={width}\n                    itemData={itemData}\n                    onItemsRendered={({ visibleRowStopIndex }) => {\n                      if (!isFetching && hasMore && visibleRowStopIndex >= rowCount - 3) {\n                        setCurrentPage((prev) => prev + 1);\n                      }\n                    }}\n                  >\n                    {DocumentGridCell}\n                  </Grid>\n                );\n              }}\n            </AutoSizer>\n          </div>\n        ) : filteredDocuments.length > 0 ? (\n          // Virtualized list view\n          <div\n            ref={documentContainerRef}\n            style={{ height: 'calc(100vh - 400px)', minHeight: '500px' }}\n          >\n            <AutoSizer>\n              {({ height, width }) => {\n                const itemData: DocItemData = {\n                  documents: filteredDocuments,\n                  onDocumentSelect: handleDocumentSelect,\n                  formatFileSize,\n                  formatDate,\n                  searchTerm: effectiveSearchTerm,\n                };\n\n                return (\n                  <List\n                    height={height}\n                    itemCount={filteredDocuments.length}\n                    itemSize={160} // Height of list item\n                    width={width}\n                    itemData={itemData}\n                    onItemsRendered={({ visibleStopIndex }) => {\n                      if (\n                        !isFetching &&\n                        hasMore &&\n                        visibleStopIndex >= filteredDocuments.length - 5\n                      ) {\n                        setCurrentPage((prev) => prev + 1);\n                      }\n                    }}\n                  >\n                    {DocumentListRow}\n                  </List>\n                );\n              }}\n            </AutoSizer>\n          </div>\n        ) : null}\n\n        {filteredDocuments.length === 0 && (\n          <div className=\"text-center py-12\">\n            <FileText className=\"w-12 h-12 text-gray-600 mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium text-gray-400 mb-2\">No documents found</h3>\n            <p className=\"text-gray-500\">\n              {effectiveSearchTerm\n                ? `No documents match your search for \"${effectiveSearchTerm}\"`\n                : 'Try adjusting your filters or search query'}\n            </p>\n          </div>\n        )}\n\n        {/* Pagination Controls */}\n        {filteredDocuments.length > 0 && (\n          <div className=\"flex items-center justify-center space-x-4 mt-8\">\n            <button\n              onClick={() => setCurrentPage((prev) => Math.max(1, prev - 1))}\n              disabled={currentPage === 1}\n              className=\"px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-700 transition-colors\"\n            >\n              Previous\n            </button>\n\n            <div className=\"text-sm text-gray-400 text-center\">\n              <div>\n                Page {currentPage} of {Math.ceil(totalDocuments / itemsPerPage) || 1}\n              </div>\n              <div className=\"text-xs mt-1\">\n                Showing {(currentPage - 1) * itemsPerPage + 1}-\n                {Math.min(currentPage * itemsPerPage, totalDocuments)} of{' '}\n                {totalDocuments.toLocaleString()} documents\n              </div>\n            </div>\n\n            <button\n              onClick={() => setCurrentPage((prev) => prev + 1)}\n              disabled={currentPage >= Math.ceil(totalDocuments / itemsPerPage)}\n              className=\"px-4 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-700 transition-colors\"\n            >\n              Next\n            </button>\n          </div>\n        )}\n\n        {/* Document Viewer Modal */}\n        {selectedDocument && (\n          <>\n            {console.log('Rendering DocumentViewer with searchTerm:', effectiveSearchTerm)}\n            <DocumentViewer document={selectedDocument} searchTerm={effectiveSearchTerm} />\n          </>\n        )}\n      </div>\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DocumentCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DocumentContentRenderer.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'linkEntitiesInText' function makes the dependencies of useMemo Hook (at line 201) change on every render. Move it inside the useMemo callback. Alternatively, wrap the definition of 'linkEntitiesInText' in its own useCallback() Hook.","line":104,"column":9,"nodeType":"VariableDeclarator","endLine":114,"endColumn":4,"suppressions":[{"kind":"directive","justification":"entityRegex/entityMap are stable across renders"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DocumentMetadataPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":27,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\nimport { Database, Tag, Shield, AlertTriangle, Globe, File } from 'lucide-react';\nimport { format } from 'date-fns';\n\ninterface DocumentMetadataPanelProps {\n  document: any;\n  analysis?: any;\n  className?: string;\n}\n\nexport const DocumentMetadataPanel: React.FC<DocumentMetadataPanelProps> = ({\n  document,\n  className = '',\n}) => {\n  if (!document) return null;\n\n  const metadata = document.metadata || {};\n  const technical = metadata.technical || {};\n  const structural = metadata.structure || {};\n  const linguistics = metadata.linguistics || {};\n  const network = metadata.network || {};\n\n  const formatDate = (dateString: string) => {\n    if (!dateString) return 'Unknown';\n    try {\n      return format(new Date(dateString), 'PP pp');\n    } catch (e) {\n      return dateString;\n    }\n  };\n\n  const formatSize = (bytes: number) => {\n    if (!bytes) return 'Unknown';\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n\n  return (\n    <div className={`space-y-6 ${className}`}>\n      {/* File Information */}\n      <section className=\"bg-slate-800/50 rounded-lg p-4 border border-slate-700\">\n        <h3 className=\"text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2\">\n          <File className=\"w-4 h-4\" />\n          File Information\n        </h3>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\">\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Filename</span>\n            <span className=\"text-slate-200 font-medium break-all\">\n              {document.fileName || document.file_name}\n            </span>\n          </div>\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Type</span>\n            <span className=\"text-slate-200 font-medium uppercase\">\n              {document.fileType || document.file_type || 'Unknown'}\n            </span>\n          </div>\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Size</span>\n            <span className=\"text-slate-200 font-medium\">\n              {formatSize(document.fileSize || document.file_size)}\n            </span>\n          </div>\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Hash (SHA-256)</span>\n            <span className=\"text-slate-200 font-mono text-xs break-all\">\n              {document.contentHash || document.content_hash || 'N/A'}\n            </span>\n          </div>\n        </div>\n      </section>\n\n      {/* Technical Metadata */}\n      <section className=\"bg-slate-800/50 rounded-lg p-4 border border-slate-700\">\n        <h3 className=\"text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2\">\n          <Database className=\"w-4 h-4\" />\n          Technical Details\n        </h3>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\">\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Created</span>\n            <span className=\"text-slate-200\">\n              {formatDate(document.dateCreated || document.date_created || technical.createDate)}\n            </span>\n          </div>\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Modified</span>\n            <span className=\"text-slate-200\">\n              {formatDate(document.dateModified || document.date_modified || technical.modifyDate)}\n            </span>\n          </div>\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Producer</span>\n            <span className=\"text-slate-200\">{technical.producer || 'Unknown'}</span>\n          </div>\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Creator Tool</span>\n            <span className=\"text-slate-200\">{technical.creator || 'Unknown'}</span>\n          </div>\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">PDF Version</span>\n            <span className=\"text-slate-200\">{structural.pdfVersion || 'N/A'}</span>\n          </div>\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Page Count</span>\n            <span className=\"text-slate-200\">\n              {structural.pageCount || document.pageCount || 'Unknown'}\n            </span>\n          </div>\n        </div>\n      </section>\n\n      {/* Analysis & Forensics */}\n      <section className=\"bg-slate-800/50 rounded-lg p-4 border border-slate-700\">\n        <h3 className=\"text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2\">\n          <Shield className=\"w-4 h-4\" />\n          Analysis & Risk\n        </h3>\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm\">\n          <div className=\"bg-slate-900/50 p-3 rounded border border-slate-700/50\">\n            <span className=\"text-slate-500 block text-xs mb-1\">Red Flag Rating</span>\n            <div className=\"flex items-center gap-1\">\n              <span className=\"text-lg font-bold text-white\">\n                {document.redFlagRating || document.red_flag_rating || 0}\n              </span>\n              <span className=\"text-xs text-slate-500\">/ 5</span>\n            </div>\n            <div className=\"flex mt-1\">\n              {[...Array(5)].map((_, i) => (\n                <span\n                  key={i}\n                  className={`text-xs ${i < (document.redFlagRating || 0) ? 'text-red-500' : 'text-slate-700'}`}\n                >\n                  🚩\n                </span>\n              ))}\n            </div>\n          </div>\n\n          <div className=\"bg-slate-900/50 p-3 rounded border border-slate-700/50\">\n            <span className=\"text-slate-500 block text-xs mb-1\">Readability (Grade)</span>\n            <span className=\"text-lg font-bold text-white\">\n              {linguistics.readingLevel?.toFixed(1) || 'N/A'}\n            </span>\n          </div>\n\n          <div className=\"bg-slate-900/50 p-3 rounded border border-slate-700/50\">\n            <span className=\"text-slate-500 block text-xs mb-1\">Sentiment</span>\n            <span\n              className={`text-lg font-bold capitalize ${\n                linguistics.sentiment === 'negative'\n                  ? 'text-red-400'\n                  : linguistics.sentiment === 'positive'\n                    ? 'text-green-400'\n                    : 'text-slate-300'\n              }`}\n            >\n              {linguistics.sentiment || 'Neutral'}\n            </span>\n          </div>\n        </div>\n\n        {/* Additional Flags */}\n        <div className=\"mt-4 flex flex-wrap gap-2\">\n          {structural.hasJavascript && (\n            <span className=\"px-2 py-1 bg-red-500/10 text-red-400 border border-red-500/20 rounded text-xs flex items-center gap-1\">\n              <AlertTriangle className=\"w-3 h-3\" /> JavaScript Detected\n            </span>\n          )}\n          {network.riskScore > 50 && (\n            <span className=\"px-2 py-1 bg-orange-500/10 text-orange-400 border border-orange-500/20 rounded text-xs flex items-center gap-1\">\n              <AlertTriangle className=\"w-3 h-3\" /> High Network Risk\n            </span>\n          )}\n        </div>\n      </section>\n\n      {/* Source & Tags */}\n      <section className=\"bg-slate-800/50 rounded-lg p-4 border border-slate-700\">\n        <h3 className=\"text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2\">\n          <Tag className=\"w-4 h-4\" />\n          Classification\n        </h3>\n        <div className=\"space-y-4\">\n          <div>\n            <span className=\"text-slate-500 block text-xs mb-1\">Source Collection</span>\n            <div className=\"flex items-center gap-2 text-slate-200 text-sm\">\n              <Globe className=\"w-3 h-3 text-slate-500\" />\n              {metadata.source_collection || 'Unclassified'}\n            </div>\n          </div>\n\n          {metadata.source_original_url && (\n            <div>\n              <span className=\"text-slate-500 block text-xs mb-1\">Original Source</span>\n              <a\n                href={metadata.source_original_url}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"text-blue-400 hover:text-blue-300 text-xs truncate block\"\n              >\n                {metadata.source_original_url}\n              </a>\n            </div>\n          )}\n\n          {(metadata.tags?.length > 0 || document.tags?.length > 0) && (\n            <div>\n              <span className=\"text-slate-500 block text-xs mb-2\">Tags</span>\n              <div className=\"flex flex-wrap gap-2\">\n                {[...(metadata.tags || []), ...(document.tags || [])].map(\n                  (tag: string, i: number) => (\n                    <span\n                      key={i}\n                      className=\"px-2 py-1 bg-slate-700 text-slate-300 rounded text-xs border border-slate-600\"\n                    >\n                      {tag}\n                    </span>\n                  ),\n                )}\n              </div>\n            </div>\n          )}\n        </div>\n      </section>\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DocumentModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DocumentProvenance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DocumentSkeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/DocumentUploader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EnhancedAnalytics.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EntityConfidenceDisplay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EntityEvidencePanel.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadEntityEvidence'. Either include it or remove the dependency array.","line":85,"column":6,"nodeType":"ArrayExpression","endLine":85,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [entityId, loadEntityEvidence]","fix":{"range":[1981,1991],"text":"[entityId, loadEntityEvidence]"}}],"suppressions":[{"kind":"directive","justification":"loadEntityEvidence is stable and only depends on entityId"}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EntityGraphPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EntityRelationshipMapper.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'x1' is defined but never used. Allowed unused args must match /^_/u.","line":114,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":114,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'y1' is defined but never used. Allowed unused args must match /^_/u.","line":114,"column":31,"nodeType":"Identifier","messageId":"unusedVar","endLine":114,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'x2' is defined but never used. Allowed unused args must match /^_/u.","line":114,"column":35,"nodeType":"Identifier","messageId":"unusedVar","endLine":114,"endColumn":37},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'getLinkColor', 'getNodeColor', 'handleNodeClick', 'transform.k', 'transform.x', and 'transform.y'. Either include them or remove the dependency array.","line":313,"column":6,"nodeType":"ArrayExpression","endLine":313,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [nodes, links, transform.x, transform.y, transform.k, getLinkColor, handleNodeClick, getNodeColor]","fix":{"range":[9593,9607],"text":"[nodes, links, transform.x, transform.y, transform.k, getLinkColor, handleNodeClick, getNodeColor]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef, useMemo } from 'react';\nimport * as d3Selection from 'd3-selection';\nimport * as d3Quadtree from 'd3-quadtree';\n\nexport interface Entity {\n  id: string;\n  type: 'person' | 'organization' | 'location' | 'document' | 'communication' | 'financial';\n  label: string;\n  properties: Record<string, any>;\n  confidence: number;\n  sources: string[];\n  x?: number;\n  y?: number;\n  vx?: number;\n  vy?: number;\n}\n\nexport interface Relationship {\n  id: string;\n  from: string;\n  to: string;\n  type: string;\n  strength: number;\n  confidence: number;\n  evidence: string[];\n  properties: Record<string, any>;\n}\n\ninterface EntityRelationshipMapperProps {\n  entities: Entity[];\n  relationships: Relationship[];\n  onEntitySelect?: (entity: Entity) => void;\n  onRelationshipSelect?: (relationship: Relationship) => void;\n}\n\nexport const EntityRelationshipMapper: React.FC<EntityRelationshipMapperProps> = ({\n  entities,\n  relationships,\n  onEntitySelect,\n}) => {\n  const svgRef = useRef<SVGSVGElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const [selectedEntity, setSelectedEntity] = useState<Entity | null>(null);\n  const [transform, setTransform] = useState({ x: 0, y: 0, k: 1 });\n  const [simulationRunning, setSimulationRunning] = useState(true);\n  const [exporting, setExporting] = useState(false);\n\n  // Memoize nodes with positions\n  const nodes = useMemo(() => {\n    return entities.map((e) => ({\n      ...e,\n      x: e.x ?? Math.random() * 800,\n      y: e.y ?? Math.random() * 600,\n      vx: 0,\n      vy: 0,\n    }));\n  }, [entities]);\n\n  // Memoize links\n  const links = useMemo(() => {\n    return relationships.map((r) => ({ ...r }));\n  }, [relationships]);\n\n  // Memoize link colors to avoid recomputing on every render\n  const getLinkColor = useMemo(() => {\n    return (d: Relationship) => {\n      const risk = typeof d.properties?.riskScore === 'number' ? d.properties.riskScore : undefined;\n      if (risk === undefined) return '#475569';\n      if (risk >= 8) return '#ef4444';\n      if (risk >= 5) return '#f59e0b';\n      if (risk >= 3) return '#eab308';\n      return '#10b981';\n    };\n  }, []);\n\n  // Memoize node colors to avoid recomputing on every render\n  const getNodeColor = useMemo(() => {\n    return (type: string) => {\n      switch (type) {\n        case 'person':\n          return '#3b82f6';\n        case 'organization':\n          return '#8b5cf6';\n        case 'location':\n          return '#06b6d4';\n        case 'document':\n          return '#10b981';\n        default:\n          return '#64748b';\n      }\n    };\n  }, []);\n\n  // Custom simple force simulation since d3-force is not available\n  useEffect(() => {\n    if (!simulationRunning) return;\n\n    const width = containerRef.current?.clientWidth || 800;\n    const height = containerRef.current?.clientHeight || 600;\n    const center = { x: width / 2, y: height / 2 };\n\n    let animationFrameId: number;\n\n    const tick = () => {\n      // 1. Repulsion using Quadtree (Barnes-Hut approximation)\n      // Build quadtree\n      const tree = d3Quadtree\n        .quadtree<Entity>()\n        .x((d) => d.x!)\n        .y((d) => d.y!)\n        .addAll(nodes);\n\n      nodes.forEach((_node) => {\n        tree.visit((quad, x1, y1, x2, _y2) => {\n          if (!quad.length) {\n            // Internal node\n            // d3-quadtree doesn't calculate center of mass by default without accumulation.\n            // We'll use a simpler collision detection approach instead of full Barnes-Hut if we don't implement the mass accumulation.\n            // Actually, a simpler repulsion is just visiting all nodes near us.\n          }\n          return false;\n        });\n      });\n\n      // Better approach: Use local repulsion window\n      // Revert to N^2 loop BUT use the quadtree to only check neighbors within radius\n      // This is efficient for collision/short-range repulsion. For long-range, we simplify.\n\n      // Let's implement a standard force accumulation visit\n      nodes.forEach((node) => {\n        tree.visit((quad, x1, y1, x2, y2) => {\n          if (!quad.length) {\n            // Internal node\n            // If we implemented center of mass, we could use BH here.\n            // For now, let's just descend if the quad is close enough\n            // Check if quad is far away\n            // Keep fully visiting leaves\n            return false;\n          }\n\n          const otherNode = (quad as any).data;\n          if (otherNode && otherNode !== node) {\n            const dx = node.x! - otherNode.x!;\n            const dy = node.y! - otherNode.y!;\n            const distSq = dx * dx + dy * dy || 1;\n\n            // Limit the range of interaction for performance (cutoff)\n            if (distSq < 40000) {\n              const force = 5000 / distSq;\n              const fx = (dx / Math.sqrt(distSq)) * force;\n              const fy = (dy / Math.sqrt(distSq)) * force;\n\n              node.vx! += fx * 0.05;\n              node.vy! += fy * 0.05;\n            }\n          }\n          // Prune if quad is out of range?\n          // The \"visit\" function returns true to stop descending.\n          // Calculate distance from node to quad center/bounds\n          const cx = (x1 + x2) / 2;\n          const cy = (y1 + y2) / 2;\n          const width = x2 - x1;\n          const qDx = node.x! - cx;\n          const qDy = node.y! - cy;\n          // If nearest point in quad is > 200 (sqrt(40000)), skip\n          // Simplified check:\n          if (Math.abs(qDx) - width / 2 > 200 || Math.abs(qDy) - width / 2 > 200) {\n            return true; // Skip this quad and children\n          }\n\n          return false;\n        });\n      });\n\n      // 2. Attraction (Links pull connected nodes together)\n      links.forEach((link) => {\n        const source = nodes.find((n) => n.id === link.from);\n        const target = nodes.find((n) => n.id === link.to);\n\n        if (source && target) {\n          const dx = target.x! - source.x!;\n          const dy = target.y! - source.y!;\n          const dist = Math.sqrt(dx * dx + dy * dy) || 1;\n          const targetDist = 100; // Desired link length\n\n          const force = (dist - targetDist) * 0.05; // Spring constant\n\n          const fx = (dx / dist) * force;\n          const fy = (dy / dist) * force;\n\n          source.vx! += fx;\n          source.vy! += fy;\n          target.vx! -= fx;\n          target.vy! -= fy;\n        }\n      });\n\n      // 3. Center Gravity (Pull everything to center)\n      nodes.forEach((node) => {\n        node.vx! += (center.x - node.x!) * 0.005;\n        node.vy! += (center.y - node.y!) * 0.005;\n\n        // Apply velocity\n        node.x! += node.vx!;\n        node.y! += node.vy!;\n\n        // Damping\n        node.vx! *= 0.9;\n        node.vy! *= 0.9;\n      });\n\n      // Update DOM directly for performance\n      const svg = d3Selection.select(svgRef.current);\n\n      svg.selectAll('.node-group').attr('transform', (d: any) => `translate(${d.x},${d.y})`);\n\n      svg\n        .selectAll('.link')\n        .attr('x1', (d: any) => {\n          const source = nodes.find((n) => n.id === d.from);\n          return source ? source.x : 0;\n        })\n        .attr('y1', (d: any) => {\n          const source = nodes.find((n) => n.id === d.from);\n          return source ? source.y : 0;\n        })\n        .attr('x2', (d: any) => {\n          const target = nodes.find((n) => n.id === d.to);\n          return target ? target.x : 0;\n        })\n        .attr('y2', (d: any) => {\n          const target = nodes.find((n) => n.id === d.to);\n          return target ? target.y : 0;\n        });\n\n      animationFrameId = requestAnimationFrame(tick);\n    };\n\n    tick();\n\n    // Stop simulation after 5 seconds to save resources\n    const timeout = setTimeout(() => {\n      cancelAnimationFrame(animationFrameId);\n      setSimulationRunning(false);\n    }, 5000);\n\n    return () => {\n      cancelAnimationFrame(animationFrameId);\n      clearTimeout(timeout);\n    };\n  }, [nodes, links, simulationRunning]);\n\n  // Handle node click\n  const handleNodeClick = (entity: Entity) => {\n    setSelectedEntity(entity);\n    if (onEntitySelect) {\n      onEntitySelect(entity);\n    }\n  };\n\n  // Initial Render\n  useEffect(() => {\n    if (!svgRef.current) return;\n\n    const svg = d3Selection.select(svgRef.current);\n    svg.selectAll('*').remove(); // Clear previous\n\n    const g = svg\n      .append('g')\n      .attr('class', 'zoom-layer')\n      .attr('transform', `translate(${transform.x},${transform.y}) scale(${transform.k})`);\n\n    // Draw Links\n    g.selectAll('.link')\n      .data(links)\n      .enter()\n      .append('line')\n      .attr('class', 'link')\n      .attr('stroke', (d: Relationship) => getLinkColor(d))\n      .attr('stroke-width', (d: Relationship) => Math.sqrt(d.strength || 1))\n      .attr('opacity', 0.6);\n\n    // Draw Nodes\n    const nodeGroups = g\n      .selectAll('.node-group')\n      .data(nodes)\n      .enter()\n      .append('g')\n      .attr('class', 'node-group')\n      .attr('cursor', 'pointer')\n      .on('click', (event: any, d: Entity) => {\n        event.stopPropagation();\n        handleNodeClick(d);\n      });\n\n    // Node Circles\n    nodeGroups\n      .append('circle')\n      .attr('r', (d: Entity) => (d.type === 'person' ? 15 : 10))\n      .attr('fill', (d: Entity) => getNodeColor(d.type))\n      .attr('stroke', '#fff')\n      .attr('stroke-width', 2);\n\n    // Node Labels\n    nodeGroups\n      .append('text')\n      .text((d: Entity) => d.label)\n      .attr('dy', 25)\n      .attr('text-anchor', 'middle')\n      .attr('fill', '#cbd5e1')\n      .attr('font-size', '10px')\n      .style('pointer-events', 'none');\n  }, [nodes, links]); // Re-render when data changes (positions handled by tick)\n\n  // Update transform\n  useEffect(() => {\n    if (!svgRef.current) return;\n    const svg = d3Selection.select(svgRef.current);\n    svg\n      .select('.zoom-layer')\n      .attr('transform', `translate(${transform.x},${transform.y}) scale(${transform.k})`);\n  }, [transform]);\n\n  // Handle zoom\n  const handleZoom = (delta: number) => {\n    setTransform((prev) => ({\n      ...prev,\n      k: Math.max(0.1, Math.min(5, prev.k + delta * 0.1)),\n    }));\n  };\n\n  // Handle pan\n  const handlePan = (dx: number, dy: number) => {\n    setTransform((prev) => ({\n      ...prev,\n      x: prev.x + dx,\n      y: prev.y + dy,\n    }));\n  };\n\n  // Export as PNG\n  const exportAsPNG = async () => {\n    if (!svgRef.current || !containerRef.current) return;\n\n    setExporting(true);\n    try {\n      const svg = svgRef.current;\n      const width = containerRef.current.clientWidth;\n      const height = containerRef.current.clientHeight;\n\n      // Serialize SVG\n      const serializer = new XMLSerializer();\n      const svgStr = serializer.serializeToString(svg);\n\n      // Create canvas\n      const canvas = document.createElement('canvas');\n      canvas.width = width;\n      canvas.height = height;\n      const ctx = canvas.getContext('2d');\n      if (!ctx) throw new Error('Could not get canvas context');\n\n      // Load SVG into image\n      const img = new Image();\n      const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });\n      const url = URL.createObjectURL(blob);\n\n      img.onload = () => {\n        // Draw background\n        ctx.fillStyle = '#0f172a'; // slate-900\n        ctx.fillRect(0, 0, width, height);\n\n        // Draw image\n        ctx.drawImage(img, 0, 0);\n\n        // Download\n        const pngUrl = canvas.toDataURL('image/png');\n        const downloadLink = document.createElement('a');\n        downloadLink.href = pngUrl;\n        downloadLink.download = `entity-graph-${new Date().toISOString().split('T')[0]}.png`;\n        document.body.appendChild(downloadLink);\n        downloadLink.click();\n        document.body.removeChild(downloadLink);\n\n        // Cleanup\n        URL.revokeObjectURL(url);\n        setExporting(false);\n      };\n\n      img.onerror = () => {\n        console.error('Failed to load SVG image');\n        URL.revokeObjectURL(url);\n        setExporting(false);\n      };\n\n      img.src = url;\n    } catch (error) {\n      console.error('Error exporting as PNG:', error);\n      setExporting(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-between items-center\">\n        <h2 className=\"text-xl font-bold text-white\">Entity Relationship Map</h2>\n        <div className=\"flex space-x-2\">\n          <button\n            onClick={() => handleZoom(1)}\n            className=\"px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 transition-colors\"\n            aria-label=\"Zoom in\"\n          >\n            +\n          </button>\n          <button\n            onClick={() => handleZoom(-1)}\n            className=\"px-3 py-1 bg-slate-700 text-white rounded hover:bg-slate-600 transition-colors\"\n            aria-label=\"Zoom out\"\n          >\n            -\n          </button>\n          <button\n            onClick={exportAsPNG}\n            disabled={exporting}\n            className=\"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 transition-colors\"\n          >\n            {exporting ? 'Exporting...' : 'Export PNG'}\n          </button>\n        </div>\n      </div>\n\n      <div\n        ref={containerRef}\n        className=\"w-full h-[600px] bg-slate-900 rounded-lg border border-slate-700 overflow-hidden relative\"\n        onMouseDown={(e) => {\n          const startX = e.clientX;\n          const startY = e.clientY;\n\n          const handleMouseMove = (moveEvent: MouseEvent) => {\n            const dx = moveEvent.clientX - startX;\n            const dy = moveEvent.clientY - startY;\n            handlePan(dx, dy);\n          };\n\n          const handleMouseUp = () => {\n            document.removeEventListener('mousemove', handleMouseMove);\n            document.removeEventListener('mouseup', handleMouseUp);\n          };\n\n          document.addEventListener('mousemove', handleMouseMove);\n          document.addEventListener('mouseup', handleMouseUp);\n        }}\n      >\n        <svg ref={svgRef} className=\"w-full h-full\" viewBox=\"0 0 800 600\" />\n\n        {simulationRunning && (\n          <div className=\"absolute top-4 left-4 bg-slate-800/80 text-white px-3 py-1 rounded text-sm\">\n            Simulating...\n          </div>\n        )}\n      </div>\n\n      {selectedEntity && (\n        <div className=\"bg-slate-800 p-4 rounded-lg border border-slate-700\">\n          <h3 className=\"text-lg font-bold text-white mb-2\">{selectedEntity.label}</h3>\n          <p className=\"text-slate-300\">Type: {selectedEntity.type}</p>\n          {selectedEntity.properties && (\n            <div className=\"mt-2\">\n              {Object.entries(selectedEntity.properties).map(([key, value]) => (\n                <p key={key} className=\"text-slate-400 text-sm\">\n                  <span className=\"font-medium\">{key}:</span> {String(value)}\n                </p>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default EntityRelationshipMapper;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EntityTypeFilter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EvidenceModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EvidenceNotebook.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":30,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":41,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'order'. Either include it or remove the dependency array.","line":73,"column":6,"nodeType":"ArrayExpression","endLine":73,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [investigationId, order]","fix":{"range":[2077,2094],"text":"[investigationId, order]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchMediaDetails'. Either include it or remove the dependency array.","line":108,"column":6,"nodeType":"ArrayExpression","endLine":108,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [fetchMediaDetails, grouped]","fix":{"range":[3333,3342],"text":"[fetchMediaDetails, grouped]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":140,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":140,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState } from 'react';\nimport { Link, useNavigate } from 'react-router-dom';\nimport { Mic, Film, FileText, Scissors, GripVertical } from 'lucide-react';\n\ninterface EvidenceRecord {\n  id: number;\n  evidence_type: string;\n  title?: string;\n  description?: string;\n  red_flag_rating?: number;\n  created_at?: string;\n  notes?: string;\n  relevance?: string;\n  metadata_json?: string;\n}\n\ninterface NotebookProps {\n  investigationId: number;\n}\n\nexport const EvidenceNotebook: React.FC<NotebookProps> = ({ investigationId }) => {\n  const navigate = useNavigate();\n  const [summary, setSummary] = useState<any | null>(null);\n  const [order, setOrder] = useState<number[]>([]);\n  const [mediaCache, setMediaCache] = useState<Record<number, any>>({});\n  const [loading, setLoading] = useState<boolean>(true);\n  const parseMeta = (s?: string) => {\n    try {\n      return s ? JSON.parse(s) : {};\n    } catch (e) {\n      return {};\n    }\n  };\n\n  useEffect(() => {\n    const existing = localStorage.getItem(`inv_outline_${investigationId}`);\n    if (existing) {\n      let arr: any = [];\n      try {\n        arr = JSON.parse(existing);\n      } catch (e) {\n        arr = [];\n      }\n      if (Array.isArray(arr)) setOrder(arr);\n    }\n  }, [investigationId]);\n\n  useEffect(() => {\n    const fetchSummary = async () => {\n      setLoading(true);\n      try {\n        const res = await fetch(`/api/investigation/${investigationId}/evidence-summary`);\n        if (res.ok) {\n          const json = await res.json();\n          setSummary(json);\n          if (!order || order.length === 0) {\n            const ids = (json.evidence || []).map((e: any) => e.id);\n            setOrder(ids);\n          }\n        }\n        const nbRes = await fetch(`/api/investigations/${investigationId}/notebook`);\n        if (nbRes.ok) {\n          const nb = await nbRes.json();\n          if (Array.isArray(nb?.order) && nb.order.length > 0) {\n            setOrder(nb.order);\n          }\n        }\n      } finally {\n        setLoading(false);\n      }\n    };\n    fetchSummary();\n  }, [investigationId]);\n\n  const grouped = useMemo(() => {\n    const result: Record<string, EvidenceRecord[]> = { snippet: [], audio: [], video: [], doc: [] };\n    const list: EvidenceRecord[] = (summary?.evidence || []) as EvidenceRecord[];\n    for (const e of list) {\n      const type = e.evidence_type || '';\n      if (type === 'audio') result.audio.push(e);\n      else if (type === 'video') result.video.push(e);\n      else if (\n        type === 'investigative_report' ||\n        type === 'correspondence' ||\n        type === 'court_filing' ||\n        type === 'court_deposition' ||\n        type === 'media_scan'\n      )\n        result.doc.push(e);\n      else result.snippet.push(e);\n    }\n    return result;\n  }, [summary]);\n\n  useEffect(() => {\n    const audioIds: number[] = [];\n    const videoIds: number[] = [];\n    for (const e of grouped.audio) {\n      const meta = parseMeta(e.metadata_json);\n      if (meta.media_item_id) audioIds.push(meta.media_item_id);\n    }\n    for (const e of grouped.video) {\n      const meta = parseMeta(e.metadata_json);\n      if (meta.media_item_id) videoIds.push(meta.media_item_id);\n    }\n    audioIds.forEach((id) => fetchMediaDetails(id, 'audio'));\n    videoIds.forEach((id) => fetchMediaDetails(id, 'video'));\n  }, [grouped]);\n\n  const saveOrder = (next: number[]) => {\n    setOrder(next);\n    localStorage.setItem(`inv_outline_${investigationId}`, JSON.stringify(next));\n    // Persist server-side\n    fetch(`/api/investigations/${investigationId}/notebook`, {\n      method: 'PUT',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ order: next }),\n    });\n  };\n\n  const move = (id: number, dir: -1 | 1) => {\n    const idx = order.indexOf(id);\n    if (idx === -1) return;\n    const ni = idx + dir;\n    if (ni < 0 || ni >= order.length) return;\n    const next = [...order];\n    const [row] = next.splice(idx, 1);\n    next.splice(ni, 0, row);\n    saveOrder(next);\n  };\n\n  const fetchMediaDetails = async (mediaItemId: number, kind: 'audio' | 'video') => {\n    if (mediaCache[mediaItemId]) return;\n    try {\n      const res = await fetch(`/api/media/${kind}/${mediaItemId}`);\n      if (res.ok) {\n        const json = await res.json();\n        setMediaCache((c) => ({ ...c, [mediaItemId]: json }));\n      }\n    } catch (e) {\n      return;\n    }\n  };\n\n  const openAudio = (mediaItemId: number, albumId?: number) => {\n    const url = albumId\n      ? `/media/audio?id=${mediaItemId}&albumId=${albumId}`\n      : `/media/audio?id=${mediaItemId}`;\n    navigate(url);\n  };\n  const openVideo = (mediaItemId: number, albumId?: number) => {\n    const url = albumId\n      ? `/media/video?id=${mediaItemId}&albumId=${albumId}`\n      : `/media/video?id=${mediaItemId}`;\n    navigate(url);\n  };\n\n  if (loading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"animate-pulse h-6 w-48 bg-slate-700 rounded mb-3\"></div>\n        <div className=\"animate-pulse h-3 w-96 bg-slate-800 rounded\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-8\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-xl text-white\">Evidence Notebook</h2>\n        <div className=\"flex items-center gap-2\">\n          <a\n            href={`/api/investigations/${investigationId}/briefing`}\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"text-xs px-3 py-1.5 rounded bg-blue-700 text-white\"\n          >\n            Publish Briefing\n          </a>\n          <div className=\"text-xs text-slate-400\">Drag to reorder outline</div>\n        </div>\n      </div>\n\n      <div className=\"space-y-6\">\n        <section>\n          <div className=\"flex items-center gap-2 text-slate-300 mb-3\">\n            <Scissors size={16} />\n            <span>Snippets</span>\n          </div>\n          <div className=\"space-y-3\">\n            {grouped.snippet.map((e) => {\n              const meta = parseMeta(e.metadata_json);\n              const docId = meta.document_id;\n              const highlight = (e as any).description || '';\n              const viewUrl = docId\n                ? `/documents?docId=${docId}&docTab=content&highlight=${encodeURIComponent(highlight.slice(0, 120))}`\n                : undefined;\n              return (\n                <div key={e.id} className=\"bg-slate-900 border border-slate-800 rounded p-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2 text-slate-200\">\n                      <GripVertical size={14} />\n                      <span>{e.title || 'Snippet'}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <button\n                        onClick={() => move(e.id, -1)}\n                        className=\"text-xs px-2 py-1 bg-slate-800 text-slate-200 rounded\"\n                      >\n                        ↑\n                      </button>\n                      <button\n                        onClick={() => move(e.id, 1)}\n                        className=\"text-xs px-2 py-1 bg-slate-800 text-slate-200 rounded\"\n                      >\n                        ↓\n                      </button>\n                      {viewUrl && (\n                        <Link\n                          to={viewUrl}\n                          className=\"text-xs px-2 py-1 bg-blue-700 text-white rounded\"\n                        >\n                          View Source\n                        </Link>\n                      )}\n                    </div>\n                  </div>\n                  {(e as any).description && (\n                    <div className=\"text-sm text-slate-300 mt-2 whitespace-pre-wrap\">\n                      {(e as any).description}\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        </section>\n\n        <section>\n          <div className=\"flex items-center gap-2 text-slate-300 mb-3\">\n            <Mic size={16} />\n            <span>Audio</span>\n          </div>\n          <div className=\"space-y-3\">\n            {grouped.audio.map((e) => {\n              const meta = parseMeta(e.metadata_json);\n              const mediaId = meta.media_item_id;\n              const albumId = meta.album_id;\n              const details = mediaId ? mediaCache[mediaId] : null;\n              const segments: any[] = details?.metadata?.transcript || [];\n              return (\n                <div key={e.id} className=\"bg-slate-900 border border-slate-800 rounded p-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2 text-slate-200\">\n                      <GripVertical size={14} />\n                      <span>{e.title || 'Audio'}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <button\n                        onClick={() => move(e.id, -1)}\n                        className=\"text-xs px-2 py-1 bg-slate-800 text-slate-200 rounded\"\n                      >\n                        ↑\n                      </button>\n                      <button\n                        onClick={() => move(e.id, 1)}\n                        className=\"text-xs px-2 py-1 bg-slate-800 text-slate-200 rounded\"\n                      >\n                        ↓\n                      </button>\n                      {mediaId && (\n                        <button\n                          onClick={() => openAudio(mediaId, albumId)}\n                          className=\"text-xs px-2 py-1 bg-blue-700 text-white rounded\"\n                        >\n                          Open\n                        </button>\n                      )}\n                    </div>\n                  </div>\n                  {segments && segments.length > 0 && (\n                    <div className=\"mt-2 space-y-1\">\n                      {segments.slice(0, 6).map((s, i) => (\n                        <button\n                          key={i}\n                          onClick={() => openAudio(mediaId, albumId)}\n                          className=\"block text-left w-full text-xs text-slate-300 bg-slate-800/60 hover:bg-slate-700 px-2 py-1 rounded\"\n                          title={`${s.speaker || ''} ${s.start || 0}s`}\n                        >\n                          {s.text}\n                        </button>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        </section>\n\n        <section>\n          <div className=\"flex items-center gap-2 text-slate-300 mb-3\">\n            <Film size={16} />\n            <span>Video</span>\n          </div>\n          <div className=\"space-y-3\">\n            {grouped.video.map((e) => {\n              const meta = parseMeta(e.metadata_json);\n              const mediaId = meta.media_item_id;\n              const albumId = meta.album_id;\n              const details = mediaId ? mediaCache[mediaId] : null;\n              const segments: any[] = details?.metadata?.transcript || [];\n              return (\n                <div key={e.id} className=\"bg-slate-900 border border-slate-800 rounded p-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2 text-slate-200\">\n                      <GripVertical size={14} />\n                      <span>{e.title || 'Video'}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <button\n                        onClick={() => move(e.id, -1)}\n                        className=\"text-xs px-2 py-1 bg-slate-800 text-slate-200 rounded\"\n                      >\n                        ↑\n                      </button>\n                      <button\n                        onClick={() => move(e.id, 1)}\n                        className=\"text-xs px-2 py-1 bg-slate-800 text-slate-200 rounded\"\n                      >\n                        ↓\n                      </button>\n                      {mediaId && (\n                        <button\n                          onClick={() => openVideo(mediaId, albumId)}\n                          className=\"text-xs px-2 py-1 bg-blue-700 text-white rounded\"\n                        >\n                          Open\n                        </button>\n                      )}\n                    </div>\n                  </div>\n                  {segments && segments.length > 0 && (\n                    <div className=\"mt-2 space-y-1\">\n                      {segments.slice(0, 6).map((s, i) => (\n                        <button\n                          key={i}\n                          onClick={() => openVideo(mediaId, albumId)}\n                          className=\"block text-left w-full text-xs text-slate-300 bg-slate-800/60 hover:bg-slate-700 px-2 py-1 rounded\"\n                          title={`${s.speaker || ''} ${s.start || 0}s`}\n                        >\n                          {s.text}\n                        </button>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        </section>\n\n        <section>\n          <div className=\"flex items-center gap-2 text-slate-300 mb-3\">\n            <FileText size={16} />\n            <span>Documents</span>\n          </div>\n          <div className=\"space-y-3\">\n            {grouped.doc.map((e) => {\n              return (\n                <div key={e.id} className=\"bg-slate-900 border border-slate-800 rounded p-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2 text-slate-200\">\n                      <GripVertical size={14} />\n                      <span>{e.title || 'Document'}</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <button\n                        onClick={() => move(e.id, -1)}\n                        className=\"text-xs px-2 py-1 bg-slate-800 text-slate-200 rounded\"\n                      >\n                        ↑\n                      </button>\n                      <button\n                        onClick={() => move(e.id, 1)}\n                        className=\"text-xs px-2 py-1 bg-slate-800 text-slate-200 rounded\"\n                      >\n                        ↓\n                      </button>\n                    </div>\n                  </div>\n                  {(e as any).description && (\n                    <div className=\"text-sm text-slate-300 mt-2 whitespace-pre-wrap\">\n                      {(e as any).description}\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EvidencePacketExporter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/EvidenceSearch.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadPeopleData'. Either include it or remove the dependency array.","line":60,"column":6,"nodeType":"ArrayExpression","endLine":60,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadPeopleData]","fix":{"range":[2514,2516],"text":"[loadPeopleData]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadPeopleData'. Either include it or remove the dependency array.","line":74,"column":6,"nodeType":"ArrayExpression","endLine":81,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [searchQuery, selectedRiskLevel, selectedEvidenceType, minRedFlagRating, maxRedFlagRating, sortBy, loadPeopleData]","fix":{"range":[3029,3156],"text":"[searchQuery, selectedRiskLevel, selectedEvidenceType, minRedFlagRating, maxRedFlagRating, sortBy, loadPeopleData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useMemo, useEffect } from 'react';\nimport { useLocation } from 'react-router-dom';\nimport { optimizedDataService } from '../services/OptimizedDataService';\nimport { Person } from '../types';\nimport { useNavigation } from '../services/ContentNavigationService.tsx';\nimport { RedFlagIndex } from './RedFlagIndex';\nimport { useUndo } from './UndoManager';\nimport FormField from './FormField';\nimport Tooltip from './Tooltip';\n// TODO: Add help text for search features\n// import HelpText from './HelpText';\nimport Icon from './Icon';\nimport ProgressBar from './ProgressBar';\nimport { AddToInvestigationButton } from './AddToInvestigationButton';\n\ninterface EvidenceSearchProps {\n  onPersonClick?: (person: Person, searchTerm: string) => void;\n}\n\nexport const EvidenceSearch: React.FC<EvidenceSearchProps> = ({ onPersonClick }) => {\n  const location = useLocation();\n  const [selectedRiskLevel, setSelectedRiskLevel] = useState<string>('ALL');\n  const [selectedEvidenceType, setSelectedEvidenceType] = useState<string>('ALL');\n  const [showRedFlagOnly, setShowRedFlagOnly] = useState(false);\n  const [minRedFlagRating, setMinRedFlagRating] = useState<number>(0);\n  const [maxRedFlagRating, setMaxRedFlagRating] = useState<number>(5);\n  const [sortBy, setSortBy] = useState<\n    'relevance' | 'mentions' | 'redflag_asc' | 'redflag_desc' | 'name'\n  >('relevance');\n  const [people, setPeople] = useState<Person[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [loadingProgress, setLoadingProgress] = useState<string>('Initializing search...');\n  const [loadingProgressValue, setLoadingProgressValue] = useState<number>(0);\n  const [showFilters, setShowFilters] = useState(false); // Mobile filter toggle\n\n  // Use undo functionality\n  const { addUndoAction } = useUndo();\n\n  // Use navigation context for shared state\n  const navigation = useNavigation();\n  const { searchTerm, setSearchTerm } = navigation;\n\n  // Extract query parameter from URL\n  const urlParams = new URLSearchParams(location.search);\n  const queryParam = urlParams.get('q') || '';\n  const [searchQuery, setSearchQuery] = useState(queryParam || searchTerm || '');\n\n  // Sync search term with navigation context\n  useEffect(() => {\n    setSearchQuery(queryParam || searchTerm || '');\n  }, [searchTerm, queryParam]);\n\n  // Update navigation context when search query changes\n  useEffect(() => {\n    setSearchTerm(searchQuery);\n  }, [searchQuery, setSearchTerm]);\n\n  useEffect(() => {\n    loadPeopleData();\n  }, []);\n\n  // Reload data when filters change\n  useEffect(() => {\n    loadPeopleData();\n\n    // Announce filter change for screen readers\n    const announcement = document.createElement('div');\n    announcement.setAttribute('aria-live', 'polite');\n    announcement.setAttribute('aria-atomic', 'true');\n    announcement.className = 'sr-only';\n    announcement.textContent = 'Search results updated';\n    document.body.appendChild(announcement);\n    setTimeout(() => document.body.removeChild(announcement), 1000);\n  }, [\n    searchQuery,\n    selectedRiskLevel,\n    selectedEvidenceType,\n    minRedFlagRating,\n    maxRedFlagRating,\n    sortBy,\n  ]);\n\n  const loadPeopleData = async () => {\n    try {\n      setLoading(true);\n      setLoadingProgress('Connecting to database...');\n      setLoadingProgressValue(10);\n      const dataService = optimizedDataService;\n      await dataService.initialize();\n\n      setLoadingProgress('Preparing search filters...');\n      setLoadingProgressValue(30);\n\n      // Build filters object\n      const filters: any = {\n        searchTerm: searchQuery || undefined,\n        minRedFlagIndex: minRedFlagRating,\n        maxRedFlagIndex: maxRedFlagRating,\n      };\n\n      // Add likelihood filter if not ALL\n      if (selectedRiskLevel !== 'ALL') {\n        filters.likelihoodScore = [selectedRiskLevel];\n      }\n\n      // Add evidence type filter if not ALL\n      if (selectedEvidenceType !== 'ALL') {\n        filters.evidenceTypes = [selectedEvidenceType];\n      }\n\n      // Add sort\n      if (sortBy === 'redflag_desc') {\n        filters.sortBy = 'spice';\n        filters.sortOrder = 'desc';\n      } else if (sortBy === 'redflag_asc') {\n        filters.sortBy = 'spice';\n        filters.sortOrder = 'asc';\n      } else if (sortBy === 'mentions') {\n        filters.sortBy = 'mentions';\n        filters.sortOrder = 'desc';\n      } else if (sortBy === 'name') {\n        filters.sortBy = 'name';\n        filters.sortOrder = 'asc';\n      }\n\n      setLoadingProgress('Searching database...');\n      setLoadingProgressValue(70);\n\n      const result = await dataService.getPaginatedData(filters, 1);\n\n      setLoadingProgress('Formatting results...');\n      setLoadingProgressValue(90);\n\n      setPeople(result.data);\n\n      setLoadingProgress('Complete');\n      setLoadingProgressValue(100);\n    } catch (error) {\n      console.error('Error loading people data for search:', error);\n      setLoadingProgress('Error occurred');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const allEvidenceTypes = useMemo(() => {\n    const types = new Set<string>();\n    people.forEach((person) => {\n      person.evidence_types.forEach((type) => types.add(type));\n    });\n    return Array.from(types).sort();\n  }, [people]);\n\n  const handlePersonClick = (person: Person) => {\n    if (onPersonClick) {\n      onPersonClick(person, searchQuery);\n    } else {\n      console.log('No onPersonClick handler provided, person clicked:', person.name);\n    }\n  };\n\n  // Enhanced filter setters with undo functionality\n  const setSelectedRiskLevelWithUndo = (value: string) => {\n    const previousValue = selectedRiskLevel;\n    setSelectedRiskLevel(value);\n\n    // Add undo action\n    addUndoAction({\n      description: 'Risk level filter change',\n      undo: () => setSelectedRiskLevel(previousValue),\n    });\n  };\n\n  const setSelectedEvidenceTypeWithUndo = (value: string) => {\n    const previousValue = selectedEvidenceType;\n    setSelectedEvidenceType(value);\n\n    // Add undo action\n    addUndoAction({\n      description: 'Evidence type filter change',\n      undo: () => setSelectedEvidenceType(previousValue),\n    });\n  };\n\n  const setShowRedFlagOnlyWithUndo = (value: boolean) => {\n    const previousValue = showRedFlagOnly;\n    setShowRedFlagOnly(value);\n\n    // Add undo action\n    addUndoAction({\n      description: 'Red flag only filter change',\n      undo: () => setShowRedFlagOnly(previousValue),\n    });\n  };\n\n  const setMinRedFlagRatingWithUndo = (value: number) => {\n    const previousValue = minRedFlagRating;\n    setMinRedFlagRating(value);\n\n    // Add undo action\n    addUndoAction({\n      description: 'Minimum red flag rating change',\n      undo: () => setMinRedFlagRating(previousValue),\n    });\n  };\n\n  const setMaxRedFlagRatingWithUndo = (value: number) => {\n    const previousValue = maxRedFlagRating;\n    setMaxRedFlagRating(value);\n\n    // Add undo action\n    addUndoAction({\n      description: 'Maximum red flag rating change',\n      undo: () => setMaxRedFlagRating(previousValue),\n    });\n  };\n\n  const setSortByWithUndo = (value: any) => {\n    const previousValue = sortBy;\n    setSortBy(value);\n\n    // Add undo action\n    addUndoAction({\n      description: 'Sort order change',\n      undo: () => setSortBy(previousValue),\n    });\n  };\n\n  const [docSnippetsState, setDocSnippets] = useState<\n    Array<{ id: number; title: string; redFlagRating: number; snippet?: string }>\n  >([]);\n\n  useEffect(() => {\n    const run = async () => {\n      const q = (searchQuery || '').trim();\n      if (!q) {\n        setDocSnippets([]);\n        return;\n      }\n      try {\n        const r = await fetch(`/api/search?q=${encodeURIComponent(q)}&limit=8&snippets=true`);\n        const json = await r.json();\n        const docs = Array.isArray(json.documents)\n          ? json.documents.map((d: any) => ({\n              id: d.id,\n              title: d.title,\n              redFlagRating: d.redFlagRating || 0,\n              snippet: d.snippet || d.contentPreview,\n            }))\n          : [];\n        setDocSnippets(docs);\n      } catch {\n        setDocSnippets([]);\n      }\n    };\n    run();\n  }, [searchQuery]);\n\n  // Memoize document snippets to avoid recomputing on every render\n  const docSnippets = useMemo(() => {\n    return docSnippetsState;\n  }, [docSnippetsState]);\n\n  // Memoize search results to avoid recomputing on every render\n  const searchResults = useMemo(() => {\n    if (loading) {\n      return [];\n    }\n\n    // Since filtering is now done server-side, we just need to format the results\n    return people.map((person) => ({\n      person,\n      matchingContexts: person.contexts.slice(0, 3),\n      matchingPassages: person.spicy_passages?.slice(0, 3) || [],\n      score: person.red_flag_score || person.mentions,\n    }));\n  }, [people, loading]);\n\n  // Memoize filter options to avoid recomputing\n  const filterOptions = useMemo(\n    () => ({\n      riskLevels: [\n        { value: 'ALL', label: 'All Levels' },\n        { value: 'HIGH', label: 'High Risk' },\n        { value: 'MEDIUM', label: 'Medium Risk' },\n        { value: 'LOW', label: 'Low Risk' },\n      ],\n      redFlagRatings: [\n        { value: 0, label: '⚪ 0 - No Red Flags' },\n        { value: 1, label: '🟡 1 - Minor Concerns' },\n        { value: 2, label: '🟠 2 - Moderate Red Flags' },\n        { value: 3, label: '🔴 3 - Significant Red Flags' },\n        { value: 4, label: '🟣 4 - High Red Flags' },\n        { value: 5, label: '⚫ 5 - Critical Red Flags' },\n      ],\n      sortByOptions: [\n        { value: 'relevance', label: 'Relevance' },\n        { value: 'mentions', label: 'Document mentions' },\n        { value: 'redflag_desc', label: 'Red Flag Index (high → low)' },\n        { value: 'redflag_asc', label: 'Red Flag Index (low → high)' },\n        { value: 'name', label: 'Name' },\n      ],\n    }),\n    [],\n  );\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Search Header */}\n      <div className=\"bg-gradient-to-r from-gray-900 to-gray-800 p-6 rounded-xl border border-gray-700\">\n        <h2 className=\"text-2xl font-bold text-white mb-4 flex items-center gap-2\">\n          <Icon name=\"Search\" size=\"lg\" />\n          Evidence Search\n        </h2>\n\n        {/* Microcopy for Evidence Search */}\n        <div className=\"text-sm text-gray-400 mb-4 flex items-start gap-2\">\n          <Icon name=\"Info\" size=\"sm\" className=\"mt-0.5 flex-shrink-0\" />\n          <span>\n            Search across all documents, entities, and evidence to find connections and patterns\n          </span>\n        </div>\n\n        {/* Loading State */}\n        {loading && (\n          <div className=\"mb-6 p-4 bg-slate-800/50 rounded-lg border border-slate-700\">\n            <div className=\"text-center\">\n              <div className=\"text-blue-400 text-sm mb-3\" role=\"status\">\n                {loadingProgress}\n              </div>\n              <ProgressBar\n                value={loadingProgressValue}\n                max={100}\n                showPercentage={true}\n                color=\"primary\"\n                size=\"md\"\n                label=\"Search progress\"\n              />\n              <div className=\"text-xs text-slate-500 mt-2\">Searching subjects and documents...</div>\n            </div>\n          </div>\n        )}\n\n        {/* Search Input */}\n        <FormField\n          label={\n            <div className=\"flex items-center gap-2\">\n              Search\n              <Tooltip content=\"Search by names, contexts, or evidence\">\n                <Icon name=\"Info\" size=\"sm\" color=\"gray\" className=\"cursor-help\" />\n              </Tooltip>\n            </div>\n          }\n          id=\"search-query\"\n        >\n          <div className=\"relative\">\n            <input\n              type=\"text\"\n              id=\"search-query\"\n              placeholder=\"Search names, contexts, or evidence...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              disabled={loading}\n              className=\"w-full pl-10 pr-4 h-10 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50 form-input\"\n              aria-label=\"Search for evidence by names, contexts, or keywords\"\n            />\n            <Icon\n              name=\"Search\"\n              size=\"sm\"\n              className=\"absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none\"\n              color=\"gray\"\n              aria-hidden=\"true\"\n            />\n          </div>\n        </FormField>\n\n        {/* Filters - Collapsible on mobile */}\n        <div className=\"md:hidden mb-4\">\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"w-full flex items-center justify-between px-4 py-3 bg-gray-800 border border-gray-600 rounded-lg text-white\"\n          >\n            <span className=\"flex items-center gap-2\">\n              <Icon name=\"Filter\" size=\"sm\" />\n              Filters\n            </span>\n            <Icon name={showFilters ? 'ChevronUp' : 'ChevronDown'} size=\"sm\" />\n          </button>\n        </div>\n\n        {/* Filters Grid - Hidden on mobile unless expanded */}\n        <div className={`${showFilters ? 'block' : 'hidden'} md:block`}>\n          <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-6\">\n            <FormField\n              label={\n                <div className=\"flex items-center gap-2\">\n                  Risk Level\n                  <Tooltip content=\"Filter results by subject risk assessment. Risk levels are determined by algorithmic analysis of evidence connections and document mentions.\">\n                    <Icon name=\"Info\" size=\"sm\" color=\"gray\" className=\"cursor-help\" />\n                  </Tooltip>\n                </div>\n              }\n              id=\"risk-level\"\n            >\n              <div className=\"relative\">\n                <select\n                  id=\"risk-level\"\n                  value={selectedRiskLevel}\n                  onChange={(e) => setSelectedRiskLevelWithUndo(e.target.value)}\n                  disabled={loading}\n                  aria-describedby=\"risk-level-description\"\n                  className=\"w-full bg-gray-800 border border-gray-600 rounded-lg px-3 h-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 form-select\"\n                >\n                  {filterOptions.riskLevels.map((level) => (\n                    <option key={level.value} value={level.value}>\n                      {level.label}\n                    </option>\n                  ))}\n                </select>\n              </div>\n              <p id=\"risk-level-description\" className=\"sr-only\">\n                Filter search results by risk level\n              </p>\n            </FormField>\n\n            <FormField\n              label={\n                <div className=\"flex items-center gap-2\">\n                  Evidence Type\n                  <Tooltip content=\"Evidence types categorize the nature of documents and references associated with subjects.\">\n                    <Icon name=\"Info\" size=\"sm\" color=\"gray\" className=\"cursor-help\" />\n                  </Tooltip>\n                </div>\n              }\n              id=\"evidence-type\"\n            >\n              <select\n                id=\"evidence-type\"\n                value={selectedEvidenceType}\n                onChange={(e) => setSelectedEvidenceTypeWithUndo(e.target.value)}\n                disabled={loading}\n                aria-describedby=\"evidence-type-description\"\n                className=\"w-full bg-gray-800 border border-gray-600 rounded-lg px-3 h-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 form-select\"\n              >\n                <option value=\"ALL\">All Types</option>\n                {allEvidenceTypes.map((type) => (\n                  <option key={type} value={type}>\n                    {type.replace('_', ' ').toUpperCase()}\n                  </option>\n                ))}\n              </select>\n              <p id=\"evidence-type-description\" className=\"sr-only\">\n                Filter search results by evidence type\n              </p>\n            </FormField>\n\n            <FormField\n              label={\n                <div className=\"flex items-center gap-2\">\n                  Min Red Flag Rating\n                  <Tooltip content=\"Set minimum red flag severity threshold. Red Flag Index measures the strength of evidence connections and potential significance of a subject.\">\n                    <Icon name=\"Info\" size=\"sm\" color=\"gray\" className=\"cursor-help\" />\n                  </Tooltip>\n                </div>\n              }\n              id=\"min-rating\"\n            >\n              <div className=\"relative\">\n                <select\n                  id=\"min-rating\"\n                  value={minRedFlagRating}\n                  onChange={(e) => setMinRedFlagRatingWithUndo(Number(e.target.value))}\n                  disabled={loading}\n                  aria-describedby=\"min-rating-description\"\n                  className=\"w-full bg-gray-800 border border-gray-600 rounded-lg px-3 h-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 form-select\"\n                >\n                  {filterOptions.redFlagRatings.map((rating) => (\n                    <option key={rating.value} value={rating.value}>\n                      {rating.label}\n                    </option>\n                  ))}\n                </select>\n              </div>\n              <p id=\"min-rating-description\" className=\"sr-only\">\n                Filter search results by minimum red flag rating\n              </p>\n            </FormField>\n\n            <FormField\n              label={\n                <div className=\"flex items-center gap-2\">\n                  Max Red Flag Rating\n                  <Tooltip content=\"Set maximum red flag severity threshold. Red Flag Index measures the strength of evidence connections and potential significance of a subject.\">\n                    <Icon name=\"Info\" size=\"sm\" color=\"gray\" className=\"cursor-help\" />\n                  </Tooltip>\n                </div>\n              }\n              id=\"max-rating\"\n            >\n              <div className=\"relative\">\n                <select\n                  id=\"max-rating\"\n                  value={maxRedFlagRating}\n                  onChange={(e) => setMaxRedFlagRatingWithUndo(Number(e.target.value))}\n                  disabled={loading}\n                  aria-describedby=\"max-rating-description\"\n                  className=\"w-full bg-gray-800 border border-gray-600 rounded-lg px-3 h-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 form-select\"\n                >\n                  {filterOptions.redFlagRatings.map((rating) => (\n                    <option key={rating.value} value={rating.value}>\n                      {rating.label}\n                    </option>\n                  ))}\n                </select>\n              </div>\n              <p id=\"max-rating-description\" className=\"sr-only\">\n                Filter search results by maximum red flag rating\n              </p>\n            </FormField>\n\n            <FormField\n              label={\n                <div className=\"flex items-center gap-2\">\n                  Sort By\n                  <Tooltip content=\"Order results by selected criteria. Sorting affects how results are ordered, with relevance using algorithmic matching.\">\n                    <Icon name=\"Info\" size=\"sm\" color=\"gray\" className=\"cursor-help\" />\n                  </Tooltip>\n                </div>\n              }\n              id=\"sort-by\"\n            >\n              <div className=\"relative\">\n                <select\n                  id=\"sort-by\"\n                  value={sortBy}\n                  onChange={(e) => setSortByWithUndo(e.target.value as any)}\n                  disabled={loading}\n                  aria-describedby=\"sort-by-description\"\n                  className=\"w-full bg-gray-800 border border-gray-600 rounded-lg px-3 h-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 form-select\"\n                >\n                  {filterOptions.sortByOptions.map((option) => (\n                    <option key={option.value} value={option.value}>\n                      {option.label}\n                    </option>\n                  ))}\n                </select>\n              </div>\n              <p id=\"sort-by-description\" className=\"sr-only\">\n                Sort search results by selected criteria\n              </p>\n            </FormField>\n\n            <FormField\n              label={\n                <div className=\"flex items-center gap-2\">\n                  Red Flag Only\n                  <Tooltip content=\"Show only results with red flags. Filter to show only subjects with flagged evidence.\">\n                    <Icon name=\"Info\" size=\"sm\" color=\"gray\" className=\"cursor-help\" />\n                  </Tooltip>\n                </div>\n              }\n              id=\"red-flag-only\"\n            >\n              <div className=\"flex items-center space-x-2\">\n                <input\n                  type=\"checkbox\"\n                  id=\"red-flag-only\"\n                  checked={showRedFlagOnly}\n                  onChange={(e) => setShowRedFlagOnlyWithUndo(e.target.checked)}\n                  disabled={loading}\n                  className=\"w-4 h-4 text-blue-600 bg-gray-800 border-gray-600 rounded focus:ring-blue-500 disabled:opacity-50 form-checkbox\"\n                  aria-label=\"Show only subjects with red flags\"\n                />\n                <Icon name=\"Flag\" size=\"sm\" color=\"danger\" aria-hidden=\"true\" />\n              </div>\n            </FormField>\n          </div>\n        </div>\n\n        <div className=\"flex justify-between items-center\">\n          <div className=\"text-sm text-gray-400\">{searchResults.length} results found</div>\n          <div className=\"text-xs text-gray-500\">\n            Red Flag Range: {minRedFlagRating} - {maxRedFlagRating}\n          </div>\n        </div>\n      </div>\n\n      {/* Search Results */}\n      <div className=\"space-y-4\">\n        {loading ? (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            {[...Array(6)].map((_, i) => (\n              <div\n                key={i}\n                className=\"bg-gray-800/50 border border-gray-700 rounded-xl p-5 relative overflow-hidden\"\n                aria-label=\"Loading search result\"\n              >\n                <div className=\"absolute inset-0 -translate-x-full animate-[shimmer_2s_infinite] bg-gradient-to-r from-transparent via-white/10 to-transparent\"></div>\n                <div className=\"flex items-start justify-between mb-4\">\n                  <div className=\"flex items-center space-x-3\">\n                    <div className=\"bg-gray-700 rounded-lg w-10 h-10 animate-pulse\"></div>\n                    <div>\n                      <div className=\"h-4 w-32 bg-gray-700 rounded mb-2 animate-pulse\"></div>\n                      <div className=\"h-3 w-24 bg-gray-700 rounded animate-pulse\"></div>\n                    </div>\n                  </div>\n                  <div className=\"h-6 w-16 bg-gray-700 rounded-full animate-pulse\"></div>\n                </div>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"h-3 w-full bg-gray-700 rounded animate-pulse\"></div>\n                  <div className=\"h-3 w-5/6 bg-gray-700 rounded animate-pulse\"></div>\n                  <div className=\"h-3 w-4/6 bg-gray-700 rounded animate-pulse\"></div>\n                </div>\n                <div className=\"flex items-center justify-between pt-3 border-t border-gray-700/50\">\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"h-3 w-16 bg-gray-700 rounded animate-pulse\"></div>\n                    <div className=\"h-3 w-12 bg-gray-700 rounded animate-pulse\"></div>\n                  </div>\n                  <div className=\"h-3 w-20 bg-gray-700 rounded animate-pulse\"></div>\n                </div>\n              </div>\n            ))}\n          </div>\n        ) : (\n          <>\n            {searchResults.length === 0 && searchQuery.trim() && (\n              <div className=\"text-center py-12\">\n                <Icon name=\"Search\" size=\"xl\" color=\"gray\" className=\"mx-auto mb-4\" />\n                <p className=\"text-gray-400 text-lg\">No results found for \"{searchQuery}\"</p>\n                <p className=\"text-gray-500 text-sm mt-2\">\n                  Try adjusting your search terms or filters\n                </p>\n              </div>\n            )}\n\n            {searchResults.length === 0 &&\n              !searchQuery.trim() &&\n              selectedRiskLevel === 'ALL' &&\n              selectedEvidenceType === 'ALL' &&\n              !showRedFlagOnly && (\n                <div className=\"text-center py-12\">\n                  <Icon name=\"Search\" size=\"xl\" color=\"gray\" className=\"mx-auto mb-4\" />\n                  <p className=\"text-gray-400 text-lg\">Start searching to find evidence</p>\n                  <p className=\"text-gray-500 text-sm mt-2\">\n                    Search for names, keywords, or apply filters\n                  </p>\n                </div>\n              )}\n\n            {searchResults.map((result, index) => (\n              <div\n                key={index}\n                className=\"bg-gray-800 rounded-xl border border-gray-700 overflow-hidden\"\n              >\n                {/* Person Header - Mobile-optimized with stacked layout */}\n                <div className=\"bg-gradient-to-r from-gray-900 to-gray-800 px-4 py-3 border-b border-gray-700\">\n                  {/* Entity Name - Always prominent at top */}\n                  <button\n                    onClick={() => handlePersonClick(result.person)}\n                    className=\"text-lg md:text-base font-bold text-white hover:text-blue-400 transition-colors mb-2 md:mb-0 block text-left w-full truncate\"\n                    title=\"Click to view full profile\"\n                  >\n                    {result.person.name}\n                  </button>\n\n                  {/* Metadata - Stacked on mobile, inline on desktop */}\n                  <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-2\">\n                    {/* Tags row */}\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <Icon\n                        name=\"User\"\n                        size=\"sm\"\n                        color=\"primary\"\n                        className=\"shrink-0 hidden md:block\"\n                      />\n                      <span\n                        className={`px-1.5 py-0.5 rounded text-[10px] font-semibold uppercase shrink-0 ${\n                          result.person.likelihood_score === 'HIGH'\n                            ? 'bg-red-900/80 text-red-200'\n                            : result.person.likelihood_score === 'MEDIUM'\n                              ? 'bg-yellow-900/80 text-yellow-200'\n                              : 'bg-green-900/80 text-green-200'\n                        }`}\n                      >\n                        {result.person.likelihood_score}\n                      </span>\n                      {result.person.red_flag_rating !== undefined && (\n                        <RedFlagIndex\n                          value={result.person.red_flag_rating}\n                          size=\"sm\"\n                          variant=\"combined\"\n                          showTextLabel={false}\n                        />\n                      )}\n                    </div>\n\n                    {/* Stats and actions - stacked text on mobile */}\n                    <div className=\"flex flex-col md:flex-row md:items-center gap-2 md:gap-3\">\n                      <div className=\"flex flex-col md:flex-row md:items-center gap-1 md:gap-2 text-xs text-gray-400\">\n                        <span>{result.person.mentions?.toLocaleString()} mentions</span>\n                        <span className=\"hidden md:inline text-gray-600\">•</span>\n                        <span>{result.person.files} files</span>\n                      </div>\n                      <AddToInvestigationButton\n                        item={{\n                          id: result.person.id || '',\n                          title: result.person.name,\n                          description: result.person.role || 'Person of interest',\n                          type: 'entity',\n                          sourceId: result.person.id || '',\n                        }}\n                        variant=\"quick\"\n                        className=\"hover:bg-slate-700 self-start md:self-auto\"\n                      />\n                    </div>\n                  </div>\n                </div>\n\n                {/* Evidence Types */}\n                <div className=\"p-4 border-b border-gray-700\">\n                  <div className=\"flex flex-wrap gap-2\">\n                    {result.person.evidence_types.map((type, i) => (\n                      <span key={i} className=\"px-2 py-1 bg-blue-900 text-blue-200 rounded text-xs\">\n                        {type.replace('_', ' ').toUpperCase()}\n                      </span>\n                    ))}\n                  </div>\n                </div>\n\n                {/* Matching Contexts */}\n                {result.matchingContexts.length > 0 && (\n                  <div className=\"p-4 border-b border-gray-700\">\n                    <h4\n                      className=\"text-sm font-medium text-gray-300 mb-3 flex items-center gap-2\"\n                      aria-level={3}\n                    >\n                      <Icon name=\"FileText\" size=\"sm\" />\n                      Contexts ({result.matchingContexts.length})\n                    </h4>\n                    {/* Microcopy for Contexts */}\n                    <div className=\"text-xs text-gray-400 mb-3 flex items-start gap-1\">\n                      <Icon name=\"Info\" size=\"xs\" className=\"mt-0.5 flex-shrink-0\" />\n                      <span>Relevant excerpts from documents mentioning this subject</span>\n                    </div>\n                    <div className=\"space-y-3\">\n                      {result.matchingContexts.map((context, i) => (\n                        <div key={i} className=\"bg-gray-900 p-3 rounded-lg\">\n                          <div className=\"text-sm text-gray-300 mb-2\">{context.context}</div>\n                          <div className=\"flex items-center gap-2 text-xs text-gray-500 overflow-hidden\">\n                            <Icon name=\"FileText\" size=\"xs\" className=\"shrink-0\" />\n                            <span className=\"truncate\">{context.file}</span>\n                            {context.date !== 'Unknown' && (\n                              <>\n                                <span>•</span>\n                                <Icon name=\"Calendar\" size=\"xs\" />\n                                <span>{context.date}</span>\n                              </>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* Matching Red Flag Passages */}\n                {result.matchingPassages.length > 0 && (\n                  <div className=\"p-4 bg-red-900 bg-opacity-20\">\n                    <h4\n                      className=\"text-sm font-medium text-red-300 mb-3 flex items-center gap-2\"\n                      aria-level={3}\n                    >\n                      <Icon name=\"AlertTriangle\" size=\"sm\" color=\"danger\" />\n                      Key Passages ({result.matchingPassages.length})\n                    </h4>\n                    {/* Microcopy for Key Passages */}\n                    <div className=\"text-xs text-red-200 mb-3 flex items-start gap-1\">\n                      <Icon name=\"Info\" size=\"xs\" className=\"mt-0.5 flex-shrink-0\" />\n                      <span>Excerpts containing flagged keywords or significant mentions</span>\n                    </div>\n                    <div className=\"space-y-3\">\n                      {result.matchingPassages.map((passage, i) => (\n                        <div\n                          key={i}\n                          className=\"bg-red-900 bg-opacity-30 p-3 rounded-lg border border-red-700\"\n                        >\n                          <div className=\"text-sm text-red-200 mb-2\">{passage.passage}</div>\n                          <div className=\"flex items-center gap-2 text-xs text-red-400\">\n                            <span className=\"px-2 py-1 bg-red-800 rounded\">\n                              {passage.keyword.toUpperCase()}\n                            </span>\n                            <span>•</span>\n                            <span>{passage.filename}</span>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* Matching Documents */}\n                {docSnippets.length > 0 && (\n                  <div className=\"p-4 border-t border-gray-700\">\n                    <h4\n                      className=\"text-sm font-medium text-gray-300 mb-3 flex items-center gap-2\"\n                      aria-level={3}\n                    >\n                      <Icon name=\"FileText\" size=\"sm\" />\n                      Matched Documents ({docSnippets.length})\n                    </h4>\n                    {/* Microcopy for Matched Documents */}\n                    <div className=\"text-xs text-gray-400 mb-3 flex items-start gap-1\">\n                      <Icon name=\"Info\" size=\"xs\" className=\"mt-0.5 flex-shrink-0\" />\n                      <span>Documents that match your search query with highlighted excerpts</span>\n                    </div>\n                    <div className=\"space-y-3\">\n                      {docSnippets.map((d) => (\n                        <div key={d.id} className=\"bg-gray-900 p-3 rounded-lg\">\n                          <div className=\"text-sm text-gray-200 mb-1 truncate\">{d.title}</div>\n                          {d.snippet && (\n                            <div\n                              className=\"text-xs text-gray-400\"\n                              dangerouslySetInnerHTML={{ __html: d.snippet }}\n                            />\n                          )}\n                          <div className=\"text-xs text-gray-500 mt-1\">Risk: {d.redFlagRating}</div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </div>\n            ))}\n          </>\n        )}\n      </div>\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/FileBrowser.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'filterFiles'. Either include it or remove the dependency array.","line":50,"column":6,"nodeType":"ArrayExpression","endLine":50,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [files, selectedCategory, searchTerm, filterFiles]","fix":{"range":[1570,1607],"text":"[files, selectedCategory, searchTerm, filterFiles]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport { createPortal } from 'react-dom';\nimport {\n  File,\n  Folder,\n  Eye,\n  Download,\n  Search,\n  User,\n  Mail,\n  FileText,\n  Image,\n  FileSpreadsheet,\n} from 'lucide-react';\n\ninterface FileItem {\n  name: string;\n  path: string;\n  type: 'file' | 'folder';\n  category: string;\n  size?: number;\n  modified?: string;\n  content?: string;\n}\n\nconst FileBrowser: React.FC = () => {\n  const [files, setFiles] = useState<FileItem[]>([]);\n  const [filteredFiles, setFilteredFiles] = useState<FileItem[]>([]);\n  const [selectedCategory, setSelectedCategory] = useState<string>('all');\n  const [searchTerm, setSearchTerm] = useState<string>('');\n  const [selectedFile, setSelectedFile] = useState<FileItem | null>(null);\n  const [loading, setLoading] = useState<boolean>(true);\n\n  const categories = [\n    { id: 'all', name: 'All Files', icon: Folder, color: 'text-blue-400' },\n    { id: 'emails', name: 'Emails & Communications', icon: Mail, color: 'text-green-400' },\n    { id: 'documents', name: 'Legal Documents', icon: FileText, color: 'text-red-400' },\n    { id: 'images', name: 'Images & Photos', icon: Image, color: 'text-purple-400' },\n    { id: 'flight_logs', name: 'Flight Records', icon: FileSpreadsheet, color: 'text-yellow-400' },\n    { id: 'testimonies', name: 'Testimonies', icon: User, color: 'text-cyan-400' },\n    { id: 'financial', name: 'Financial Records', icon: FileSpreadsheet, color: 'text-orange-400' },\n  ];\n\n  useEffect(() => {\n    loadFiles();\n  }, []);\n\n  useEffect(() => {\n    filterFiles();\n  }, [files, selectedCategory, searchTerm]);\n\n  const loadFiles = async () => {\n    try {\n      // This would typically load from your backend/API\n      // For now, we'll create sample file data based on the document structure\n      const sampleFiles: FileItem[] = [\n        // Emails & Communications\n        {\n          name: 'Epstein_Email_Archive_001.txt',\n          path: '/emails/epstein_emails_001.txt',\n          type: 'file',\n          category: 'emails',\n          size: 156789,\n          modified: '2024-01-15',\n        },\n        {\n          name: 'Clinton_Correspondence.txt',\n          path: '/emails/clinton_emails.txt',\n          type: 'file',\n          category: 'emails',\n          size: 89234,\n          modified: '2024-01-14',\n        },\n        {\n          name: 'Trump_Communications.txt',\n          path: '/emails/trump_emails.txt',\n          type: 'file',\n          category: 'emails',\n          size: 234567,\n          modified: '2024-01-13',\n        },\n\n        // Legal Documents\n        {\n          name: 'Indictment_Documents.pdf',\n          path: '/documents/indictment.pdf',\n          type: 'file',\n          category: 'documents',\n          size: 456789,\n          modified: '2024-01-12',\n        },\n        {\n          name: 'Plea_Agreement.txt',\n          path: '/documents/plea_agreement.txt',\n          type: 'file',\n          category: 'documents',\n          size: 123456,\n          modified: '2024-01-11',\n        },\n        {\n          name: 'Court_Transcripts.pdf',\n          path: '/documents/court_transcripts.pdf',\n          type: 'file',\n          category: 'documents',\n          size: 678901,\n          modified: '2024-01-10',\n        },\n\n        // Flight Records\n        {\n          name: 'Flight_Log_1995_2005.csv',\n          path: '/flight_logs/flight_log_1995_2005.csv',\n          type: 'file',\n          category: 'flight_logs',\n          size: 34567,\n          modified: '2024-01-09',\n        },\n        {\n          name: 'Passenger_Manifests.txt',\n          path: '/flight_logs/passenger_manifests.txt',\n          type: 'file',\n          category: 'flight_logs',\n          size: 234567,\n          modified: '2024-01-08',\n        },\n\n        // Testimonies\n        {\n          name: 'Virginia_Giuffre_Testimony.txt',\n          path: '/testimonies/virginia_giuffre.txt',\n          type: 'file',\n          category: 'testimonies',\n          size: 456789,\n          modified: '2024-01-07',\n        },\n        {\n          name: 'Survivor_Statements.pdf',\n          path: '/testimonies/survivor_statements.pdf',\n          type: 'file',\n          category: 'testimonies',\n          size: 567890,\n          modified: '2024-01-06',\n        },\n\n        // Financial Records\n        {\n          name: 'Bank_Statements_2000_2019.csv',\n          path: '/financial/bank_statements.csv',\n          type: 'file',\n          category: 'financial',\n          size: 1234567,\n          modified: '2024-01-05',\n        },\n        {\n          name: 'Real_Estate_Transactions.txt',\n          path: '/financial/real_estate.txt',\n          type: 'file',\n          category: 'financial',\n          size: 234567,\n          modified: '2024-01-04',\n        },\n\n        // Images\n        {\n          name: 'Evidence_Photos_001/',\n          path: '/images/evidence_photos/',\n          type: 'folder',\n          category: 'images',\n        },\n        { name: 'Property_Images/', path: '/images/property/', type: 'folder', category: 'images' },\n      ];\n\n      setFiles(sampleFiles);\n      setLoading(false);\n    } catch (error) {\n      console.error('Error loading files:', error);\n      setLoading(false);\n    }\n  };\n\n  const filterFiles = () => {\n    let filtered = files;\n\n    if (selectedCategory !== 'all') {\n      filtered = filtered.filter((file) => file.category === selectedCategory);\n    }\n\n    if (searchTerm) {\n      filtered = filtered.filter(\n        (file) =>\n          file.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n          file.path.toLowerCase().includes(searchTerm.toLowerCase()),\n      );\n    }\n\n    setFilteredFiles(filtered);\n  };\n\n  const handleFileClick = (file: FileItem) => {\n    if (file.type === 'file') {\n      setSelectedFile(file);\n    }\n  };\n\n  const getFileIcon = (file: FileItem) => {\n    if (file.type === 'folder') return Folder;\n\n    const ext = file.name.split('.').pop()?.toLowerCase();\n    switch (ext) {\n      case 'pdf':\n        return FileText;\n      case 'txt':\n        return FileText;\n      case 'csv':\n        return FileSpreadsheet;\n      case 'jpg':\n      case 'png':\n        return Image;\n      default:\n        return File;\n    }\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Category Filter */}\n      <div className=\"bg-gray-800 p-4 rounded-xl\">\n        <h3 className=\"text-lg font-semibold text-white mb-4\">Browse by Category</h3>\n        <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3\">\n          {categories.map((category) => {\n            const Icon = category.icon;\n            return (\n              <button\n                key={category.id}\n                onClick={() => setSelectedCategory(category.id)}\n                className={`flex flex-col items-center p-3 rounded-lg transition-all duration-200 ${\n                  selectedCategory === category.id\n                    ? 'bg-gradient-to-br from-cyan-600 to-blue-600 text-white shadow-lg'\n                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600'\n                }`}\n              >\n                <Icon className=\"h-6 w-6 mb-2\" />\n                <span className=\"text-xs text-center font-medium\">{category.name}</span>\n              </button>\n            );\n          })}\n        </div>\n      </div>\n\n      {/* Search */}\n      <div className=\"bg-gray-800 p-4 rounded-xl\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400\" />\n          <input\n            type=\"text\"\n            placeholder=\"Search files by name or content...\"\n            className=\"w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-500 focus:border-transparent\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n          />\n        </div>\n      </div>\n\n      {/* File List */}\n      <div className=\"bg-gray-800 rounded-xl overflow-hidden\">\n        <div className=\"p-4 border-b border-gray-700\">\n          <div className=\"flex items-center justify-between\">\n            <h3 className=\"text-lg font-semibold text-white\">\n              {selectedCategory === 'all'\n                ? 'All Files'\n                : categories.find((c) => c.id === selectedCategory)?.name}\n            </h3>\n            <span className=\"text-gray-400 text-sm\">\n              {filteredFiles.length} {filteredFiles.length === 1 ? 'item' : 'items'}\n            </span>\n          </div>\n        </div>\n\n        <div className=\"divide-y divide-gray-700\">\n          {filteredFiles.map((file, index) => {\n            const Icon = getFileIcon(file);\n            return (\n              <div\n                key={index}\n                onClick={() => handleFileClick(file)}\n                className=\"p-4 hover:bg-gray-700 cursor-pointer transition-colors duration-200\"\n              >\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-3\">\n                    <Icon className=\"h-5 w-5 text-cyan-400\" />\n                    <div>\n                      <h4 className=\"text-white font-medium\">{file.name}</h4>\n                      <p className=\"text-gray-400 text-sm\">{file.path}</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center space-x-4 text-sm text-gray-400\">\n                    {file.size && <span>{formatFileSize(file.size)}</span>}\n                    {file.modified && <span>{file.modified}</span>}\n                    <Eye className=\"h-4 w-4\" />\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n\n        {filteredFiles.length === 0 && (\n          <div className=\"p-8 text-center\">\n            <File className=\"h-12 w-12 text-gray-500 mx-auto mb-4\" />\n            <h4 className=\"text-gray-300 font-medium mb-2\">No files found</h4>\n            <p className=\"text-gray-500\">Try adjusting your search or category filter</p>\n          </div>\n        )}\n      </div>\n\n      {/* File Preview Modal */}\n      {selectedFile &&\n        createPortal(\n          <div className=\"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] p-4\">\n            <div className=\"bg-slate-800 rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden border border-slate-700\">\n              <div className=\"p-6 border-b border-slate-700\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-3\">\n                    <File className=\"h-6 w-6 text-cyan-400\" />\n                    <h3 className=\"text-xl font-semibold text-white\">{selectedFile.name}</h3>\n                  </div>\n                  <div className=\"flex items-center space-x-3\">\n                    <button className=\"flex items-center space-x-2 px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg text-white transition-colors\">\n                      <Download className=\"h-4 w-4\" />\n                      <span>Download</span>\n                    </button>\n                    <button\n                      onClick={() => setSelectedFile(null)}\n                      className=\"w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-white text-xl transition-colors\"\n                    >\n                      ×\n                    </button>\n                  </div>\n                </div>\n              </div>\n              <div className=\"p-6 overflow-y-auto max-h-[60vh]\">\n                <div className=\"space-y-4\">\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <span className=\"text-gray-400\">Path:</span>\n                      <p className=\"text-white\">{selectedFile.path}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-gray-400\">Category:</span>\n                      <p className=\"text-white capitalize\">{selectedFile.category}</p>\n                    </div>\n                    {selectedFile.size && (\n                      <div>\n                        <span className=\"text-gray-400\">Size:</span>\n                        <p className=\"text-white\">{formatFileSize(selectedFile.size)}</p>\n                      </div>\n                    )}\n                    {selectedFile.modified && (\n                      <div>\n                        <span className=\"text-gray-400\">Modified:</span>\n                        <p className=\"text-white\">{selectedFile.modified}</p>\n                      </div>\n                    )}\n                  </div>\n                  <div className=\"border-t border-gray-700 pt-4\">\n                    <h4 className=\"text-white font-medium mb-2\">Content Preview</h4>\n                    <div className=\"bg-gray-900 p-4 rounded-lg text-gray-300 font-mono text-sm max-h-64 overflow-y-auto\">\n                      {selectedFile.content || 'File content would be displayed here...'}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>,\n          document.body,\n        )}\n    </div>\n  );\n};\n\nexport default FileBrowser;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/FinancialTransactionAnalysis.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getFlowIcon' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":228,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":228,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\nimport {\n  DollarSign,\n  TrendingUp,\n  TrendingDown,\n  Calendar,\n  ArrowRight,\n  Filter,\n  AlertTriangle,\n  X,\n  MapPin,\n  Users,\n} from 'lucide-react';\n\ninterface FinancialTransactionAnalysisProps {\n  onTransactionPatternDetected?: (patterns: TransactionPattern[]) => void;\n}\n\nexport interface TransactionPattern {\n  id: string;\n  type: 'flow' | 'timing' | 'amount' | 'geographic' | 'entity' | 'anomaly';\n  title: string;\n  description: string;\n  confidence: number;\n  severity: 'low' | 'medium' | 'high' | 'critical';\n  entities: string[];\n  evidenceIds: string[];\n  metadata: {\n    totalAmount?: number;\n    transactionCount?: number;\n    timeRange?: { start: string; end: string };\n    locations?: string[];\n    averageAmount?: number;\n    largestTransaction?: number;\n    frequency?: number;\n    anomalyScore?: number;\n    flowDirection?: 'inflow' | 'outflow' | 'circular';\n  };\n  recommendations: string[];\n}\n\nexport const FinancialTransactionAnalysis: React.FC<FinancialTransactionAnalysisProps> = ({\n  onTransactionPatternDetected,\n}) => {\n  const [transactionPatterns, setTransactionPatterns] = useState<TransactionPattern[]>([]);\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [selectedPattern, setSelectedPattern] = useState<TransactionPattern | null>(null);\n  const [analysisProgress, setAnalysisProgress] = useState(0);\n  const [filterType, setFilterType] = useState<\n    'all' | 'flow' | 'timing' | 'amount' | 'geographic' | 'entity' | 'anomaly'\n  >('all');\n  const [sortBy, setSortBy] = useState<'date' | 'amount' | 'confidence' | 'severity'>('confidence');\n\n  const analyzeTransactions = async () => {\n    setIsAnalyzing(true);\n    setAnalysisProgress(0);\n\n    // Simulate progressive analysis\n    const progressSteps = [\n      { progress: 12, message: 'Parsing financial documents...' },\n      { progress: 25, message: 'Analyzing transaction flows...' },\n      { progress: 38, message: 'Detecting timing patterns...' },\n      { progress: 51, message: 'Mapping geographic distribution...' },\n      { progress: 64, message: 'Identifying entity relationships...' },\n      { progress: 77, message: 'Calculating anomaly scores...' },\n      { progress: 90, message: 'Cross-referencing with known patterns...' },\n      { progress: 100, message: 'Transaction analysis complete!' },\n    ];\n\n    for (const step of progressSteps) {\n      await new Promise((resolve) => setTimeout(resolve, 600));\n      setAnalysisProgress(step.progress);\n    }\n\n    // Generate mock financial patterns based on Epstein investigation\n    const mockPatterns: TransactionPattern[] = [\n      {\n        id: 'finance-001',\n        type: 'flow',\n        title: 'Unusual Circular Money Flows',\n        description:\n          'Complex circular transaction patterns where funds move through multiple entities before returning to origin, suggesting money laundering.',\n        confidence: 94,\n        severity: 'critical',\n        entities: ['Jeffrey Epstein', 'Shell Company A', 'Offshore Account', 'Real Estate LLC'],\n        evidenceIds: ['evidence-2'],\n        metadata: {\n          totalAmount: 15000000,\n          transactionCount: 47,\n          timeRange: { start: '2005-01-01', end: '2008-12-31' },\n          locations: ['US Virgin Islands', 'Delaware', 'New York'],\n          averageAmount: 319149,\n          largestTransaction: 2500000,\n          flowDirection: 'circular',\n          anomalyScore: 9.2,\n        },\n        recommendations: [\n          'Subpoena complete transaction records for all identified entities',\n          'Investigate beneficial ownership of shell companies',\n          'Coordinate with international financial intelligence units',\n        ],\n      },\n      {\n        id: 'finance-002',\n        type: 'timing',\n        title: 'Investigation-Linked Transactions',\n        description:\n          'Large financial transfers occurring immediately before or after key investigation milestones, suggesting influence attempts.',\n        confidence: 89,\n        severity: 'high',\n        entities: ['Jeffrey Epstein', 'Legal Defense Fund', 'Political Donations'],\n        evidenceIds: ['evidence-2'],\n        metadata: {\n          totalAmount: 8500000,\n          transactionCount: 23,\n          timeRange: { start: '2006-07-01', end: '2007-04-30' },\n          locations: ['Florida', 'New York', 'Washington DC'],\n          averageAmount: 369565,\n          largestTransaction: 2000000,\n          frequency: 23,\n          anomalyScore: 8.1,\n        },\n        recommendations: [\n          'Cross-reference transaction dates with investigation timeline',\n          'Analyze recipients of political donations',\n          'Trace ultimate beneficiaries of legal payments',\n        ],\n      },\n      {\n        id: 'finance-003',\n        type: 'amount',\n        title: 'Structured Transactions Below Reporting Threshold',\n        description:\n          'Multiple transactions just below $10,000 reporting threshold, consistent with structuring to avoid detection.',\n        confidence: 91,\n        severity: 'high',\n        entities: ['Jeffrey Epstein', 'Multiple Cash Recipients'],\n        evidenceIds: ['evidence-2'],\n        metadata: {\n          totalAmount: 485000,\n          transactionCount: 52,\n          timeRange: { start: '2009-01-01', end: '2009-12-31' },\n          locations: ['Palm Beach', 'New York', 'St. Thomas'],\n          averageAmount: 9327,\n          largestTransaction: 9950,\n          frequency: 52,\n          anomalyScore: 8.6,\n        },\n        recommendations: [\n          'Review all transactions in $9,000-$10,000 range',\n          'Interview bank personnel about suspicious activity reports',\n          'Analyze cash withdrawal patterns',\n        ],\n      },\n      {\n        id: 'finance-004',\n        type: 'geographic',\n        title: 'High-Risk Jurisdiction Activity',\n        description:\n          'Concentrated financial activity in jurisdictions with weak financial oversight and strong banking secrecy laws.',\n        confidence: 86,\n        severity: 'high',\n        entities: ['Jeffrey Epstein', 'Offshore Banks', 'Trust Companies'],\n        evidenceIds: ['evidence-2'],\n        metadata: {\n          totalAmount: 32000000,\n          transactionCount: 78,\n          timeRange: { start: '2000-01-01', end: '2019-12-31' },\n          locations: ['British Virgin Islands', 'Cayman Islands', 'Switzerland', 'Luxembourg'],\n          averageAmount: 410256,\n          largestTransaction: 8500000,\n          flowDirection: 'outflow',\n          anomalyScore: 7.9,\n        },\n        recommendations: [\n          'Request mutual legal assistance from relevant jurisdictions',\n          'Analyze beneficial ownership disclosure requirements',\n          'Map complete offshore corporate structure',\n        ],\n      },\n      {\n        id: 'finance-005',\n        type: 'entity',\n        title: 'Rapid Entity Creation and Dissolution',\n        description:\n          'Pattern of creating and dissolving corporate entities in rapid succession, potentially to obscure transaction trails.',\n        confidence: 83,\n        severity: 'medium',\n        entities: ['Jeffrey Epstein', 'Multiple Shell Companies'],\n        evidenceIds: ['evidence-2'],\n        metadata: {\n          transactionCount: 34,\n          timeRange: { start: '2010-01-01', end: '2015-12-31' },\n          locations: ['Delaware', 'Nevada', 'Wyoming'],\n          averageAmount: 127500,\n          largestTransaction: 750000,\n          frequency: 34,\n          anomalyScore: 7.2,\n        },\n        recommendations: [\n          'Review corporate formation and dissolution timeline',\n          'Analyze transaction patterns for each entity',\n          'Investigate registered agents and legal representatives',\n        ],\n      },\n    ];\n\n    setTransactionPatterns(mockPatterns);\n    setIsAnalyzing(false);\n\n    if (onTransactionPatternDetected) {\n      onTransactionPatternDetected(mockPatterns);\n    }\n  };\n\n  const getPatternIcon = (type: TransactionPattern['type']) => {\n    const icons = {\n      flow: ArrowRight,\n      timing: Calendar,\n      amount: DollarSign,\n      geographic: MapPin,\n      entity: Users,\n      anomaly: AlertTriangle,\n    };\n    return icons[type];\n  };\n\n  const getFlowIcon = (direction: string) => {\n    if (direction === 'inflow') return TrendingUp;\n    if (direction === 'outflow') return TrendingDown;\n    return ArrowRight;\n  };\n\n  const getSeverityColor = (severity: TransactionPattern['severity']) => {\n    const colors = {\n      low: 'bg-green-100 text-green-800 border-green-200',\n      medium: 'bg-yellow-100 text-yellow-800 border-yellow-200',\n      high: 'bg-orange-100 text-orange-800 border-orange-200',\n      critical: 'bg-red-100 text-red-800 border-red-200',\n    };\n    return colors[severity];\n  };\n\n  const getConfidenceColor = (confidence: number) => {\n    if (confidence >= 90) return 'text-green-600';\n    if (confidence >= 70) return 'text-yellow-600';\n    return 'text-red-600';\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'USD',\n      minimumFractionDigits: 0,\n      maximumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const filteredPatterns =\n    filterType === 'all'\n      ? transactionPatterns\n      : transactionPatterns.filter((pattern) => pattern.type === filterType);\n\n  const sortedPatterns = [...filteredPatterns].sort((a, b) => {\n    switch (sortBy) {\n      case 'confidence':\n        return b.confidence - a.confidence;\n      case 'severity': {\n        const severityOrder = { critical: 4, high: 3, medium: 2, low: 1 };\n        return severityOrder[b.severity] - severityOrder[a.severity];\n      }\n      case 'amount':\n        return (b.metadata.totalAmount || 0) - (a.metadata.totalAmount || 0);\n      default:\n        return 0;\n    }\n  });\n\n  return (\n    <div className=\"bg-white rounded-lg shadow-lg\">\n      {/* Header */}\n      <div className=\"border-b border-gray-200 px-6 py-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h2 className=\"text-xl font-semibold text-gray-900\">Financial Transaction Analysis</h2>\n            <p className=\"text-sm text-gray-600 mt-1\">\n              Analyze financial flows, timing patterns, and transaction anomalies\n            </p>\n          </div>\n          <button\n            onClick={analyzeTransactions}\n            disabled={isAnalyzing}\n            className=\"flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n          >\n            <DollarSign className=\"w-4 h-4 mr-2\" />\n            {isAnalyzing ? 'Analyzing...' : 'Start Financial Analysis'}\n          </button>\n        </div>\n      </div>\n\n      {/* Analysis Progress */}\n      {isAnalyzing && (\n        <div className=\"px-6 py-4 bg-green-50 border-b border-green-200\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <span className=\"text-sm font-medium text-green-900\">\n              Analyzing financial transaction patterns...\n            </span>\n            <span className=\"text-sm text-green-700\">{analysisProgress}%</span>\n          </div>\n          <div className=\"w-full bg-green-200 rounded-full h-2\">\n            <div\n              className=\"bg-green-600 h-2 rounded-full transition-all duration-300\"\n              style={{ width: `${analysisProgress}%` }}\n            />\n          </div>\n        </div>\n      )}\n\n      {/* Filters and Sorting */}\n      {!isAnalyzing && transactionPatterns.length > 0 && (\n        <div className=\"px-6 py-4 border-b border-gray-200\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-4\">\n              <Filter className=\"w-4 h-4 text-gray-500\" />\n              <span className=\"text-sm font-medium text-gray-700\">Filter by type:</span>\n              <div className=\"flex gap-2\">\n                {['all', 'flow', 'timing', 'amount', 'geographic', 'entity', 'anomaly'].map(\n                  (type) => (\n                    <button\n                      key={type}\n                      onClick={() => setFilterType(type as any)}\n                      className={`px-3 py-1 text-xs font-medium rounded-full transition-colors ${\n                        filterType === type\n                          ? 'bg-green-100 text-green-700'\n                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'\n                      }`}\n                    >\n                      {type.charAt(0).toUpperCase() + type.slice(1)}\n                    </button>\n                  ),\n                )}\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-sm font-medium text-gray-700\">Sort by:</span>\n              <select\n                value={sortBy}\n                onChange={(e) => setSortBy(e.target.value as any)}\n                className=\"px-3 py-1 text-xs border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-green-500\"\n              >\n                <option value=\"confidence\">Confidence</option>\n                <option value=\"severity\">Severity</option>\n                <option value=\"amount\">Total Amount</option>\n              </select>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Summary Statistics */}\n      {!isAnalyzing && transactionPatterns.length > 0 && (\n        <div className=\"px-6 py-4 bg-gray-50 border-b border-gray-200\">\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-6\">\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-gray-900\">\n                {formatCurrency(\n                  transactionPatterns.reduce(\n                    (sum, pattern) => sum + (pattern.metadata.totalAmount || 0),\n                    0,\n                  ),\n                )}\n              </div>\n              <div className=\"text-sm text-gray-600\">Total Analyzed</div>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-gray-900\">\n                {transactionPatterns.reduce(\n                  (sum, pattern) => sum + (pattern.metadata.transactionCount || 0),\n                  0,\n                )}\n              </div>\n              <div className=\"text-sm text-gray-600\">Transactions</div>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-gray-900\">\n                {transactionPatterns.filter((p) => p.severity === 'critical').length}\n              </div>\n              <div className=\"text-sm text-gray-600\">Critical Patterns</div>\n            </div>\n            <div className=\"text-center\">\n              <div className=\"text-2xl font-bold text-gray-900\">\n                {Math.round(\n                  transactionPatterns.reduce((sum, pattern) => sum + pattern.confidence, 0) /\n                    transactionPatterns.length,\n                )}\n                %\n              </div>\n              <div className=\"text-sm text-gray-600\">Avg Confidence</div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Pattern Results */}\n      {!isAnalyzing && sortedPatterns.length > 0 && (\n        <div className=\"p-6\">\n          <div className=\"mb-4\">\n            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\n              Detected Financial Patterns ({sortedPatterns.length})\n            </h3>\n            <p className=\"text-sm text-gray-600\">\n              Analysis identified {transactionPatterns.length} suspicious financial patterns\n              {filterType !== 'all' && ` (${sortedPatterns.length} matching current filter)`}\n            </p>\n          </div>\n\n          <div className=\"grid gap-4\">\n            {sortedPatterns.map((pattern) => {\n              const Icon = getPatternIcon(pattern.type);\n\n              return (\n                <div\n                  key={pattern.id}\n                  className={`border rounded-lg p-4 cursor-pointer transition-all hover:shadow-md ${\n                    selectedPattern?.id === pattern.id ? 'ring-2 ring-green-500' : ''\n                  }`}\n                  onClick={() => setSelectedPattern(pattern)}\n                >\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex items-start flex-1\">\n                      <div className={`p-2 rounded-lg ${getSeverityColor(pattern.severity)} mr-3`}>\n                        <Icon className=\"w-5 h-5\" />\n                      </div>\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center justify-between mb-1\">\n                          <h4 className=\"text-sm font-medium text-gray-900\">{pattern.title}</h4>\n                          <div className=\"flex items-center gap-2\">\n                            {pattern.metadata.totalAmount && (\n                              <span className=\"text-sm font-medium text-gray-900\">\n                                {formatCurrency(pattern.metadata.totalAmount)}\n                              </span>\n                            )}\n                            <span\n                              className={`text-sm font-medium ${getConfidenceColor(pattern.confidence)}`}\n                            >\n                              {pattern.confidence}% confidence\n                            </span>\n                            <span\n                              className={`px-2 py-1 text-xs font-medium rounded-full ${getSeverityColor(pattern.severity)}`}\n                            >\n                              {pattern.severity.toUpperCase()}\n                            </span>\n                          </div>\n                        </div>\n                        <p className=\"text-sm text-gray-600 mb-2\">{pattern.description}</p>\n                        <div className=\"flex items-center gap-4 text-xs text-gray-500\">\n                          <span>Type: {pattern.type}</span>\n                          <span>Entities: {pattern.entities.length}</span>\n                          <span>Evidence: {pattern.evidenceIds.length} items</span>\n                          {pattern.metadata.transactionCount && (\n                            <span>Transactions: {pattern.metadata.transactionCount}</span>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      )}\n\n      {/* Pattern Detail Modal */}\n      {selectedPattern && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg p-6 w-full max-w-2xl max-h-96 overflow-auto\">\n            <div className=\"flex items-start justify-between mb-4\">\n              <div>\n                <h3 className=\"text-lg font-medium text-gray-900\">{selectedPattern.title}</h3>\n                <div className=\"flex items-center gap-2 mt-1\">\n                  <span\n                    className={`px-2 py-1 text-xs font-medium rounded-full ${getSeverityColor(selectedPattern.severity)}`}\n                  >\n                    {selectedPattern.severity.toUpperCase()}\n                  </span>\n                  <span\n                    className={`text-sm font-medium ${getConfidenceColor(selectedPattern.confidence)}`}\n                  >\n                    {selectedPattern.confidence}% confidence\n                  </span>\n                </div>\n              </div>\n              <button\n                onClick={() => setSelectedPattern(null)}\n                className=\"p-2 rounded-full hover:bg-slate-100 text-gray-400 hover:text-gray-600 transition-colors\"\n                aria-label=\"Close\"\n              >\n                <X className=\"w-5 h-5\" />\n              </button>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div>\n                <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Description</h4>\n                <p className=\"text-sm text-gray-600\">{selectedPattern.description}</p>\n              </div>\n\n              <div>\n                <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Involved Entities</h4>\n                <div className=\"flex flex-wrap gap-2\">\n                  {selectedPattern.entities.map((entity, index) => (\n                    <span\n                      key={index}\n                      className=\"px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded\"\n                    >\n                      {entity}\n                    </span>\n                  ))}\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                {selectedPattern.metadata.totalAmount && (\n                  <div>\n                    <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Total Amount</h4>\n                    <p className=\"text-sm text-gray-900 font-medium\">\n                      {formatCurrency(selectedPattern.metadata.totalAmount)}\n                    </p>\n                  </div>\n                )}\n                {selectedPattern.metadata.transactionCount && (\n                  <div>\n                    <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Transaction Count</h4>\n                    <p className=\"text-sm text-gray-900 font-medium\">\n                      {selectedPattern.metadata.transactionCount}\n                    </p>\n                  </div>\n                )}\n                {selectedPattern.metadata.averageAmount && (\n                  <div>\n                    <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Average Amount</h4>\n                    <p className=\"text-sm text-gray-900 font-medium\">\n                      {formatCurrency(selectedPattern.metadata.averageAmount)}\n                    </p>\n                  </div>\n                )}\n                {selectedPattern.metadata.largestTransaction && (\n                  <div>\n                    <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Largest Transaction</h4>\n                    <p className=\"text-sm text-gray-900 font-medium\">\n                      {formatCurrency(selectedPattern.metadata.largestTransaction)}\n                    </p>\n                  </div>\n                )}\n              </div>\n\n              {selectedPattern.metadata.timeRange && (\n                <div>\n                  <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Time Range</h4>\n                  <p className=\"text-sm text-gray-600\">\n                    {selectedPattern.metadata.timeRange.start} to{' '}\n                    {selectedPattern.metadata.timeRange.end}\n                  </p>\n                </div>\n              )}\n\n              {selectedPattern.metadata.locations &&\n                selectedPattern.metadata.locations.length > 0 && (\n                  <div>\n                    <h4 className=\"text-sm font-medium text-gray-700 mb-1\">Locations</h4>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {selectedPattern.metadata.locations.map((location, index) => (\n                        <span\n                          key={index}\n                          className=\"px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded\"\n                        >\n                          {location}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n              <div>\n                <h4 className=\"text-sm font-medium text-gray-700 mb-2\">\n                  Investigation Recommendations\n                </h4>\n                <ul className=\"space-y-1\">\n                  {selectedPattern.recommendations.map((recommendation, index) => (\n                    <li key={index} className=\"text-sm text-gray-600 flex items-start\">\n                      <span className=\"w-1.5 h-1.5 rounded-full bg-green-600 mt-2 mr-2 flex-shrink-0\"></span>\n                      {recommendation}\n                    </li>\n                  ))}\n                </ul>\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-3 mt-6\">\n              <button\n                onClick={() => setSelectedPattern(null)}\n                className=\"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors\"\n              >\n                Close\n              </button>\n              <button className=\"px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition-colors\">\n                Add to Investigation\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Empty State */}\n      {!isAnalyzing && transactionPatterns.length === 0 && (\n        <div className=\"p-12 text-center\">\n          <DollarSign className=\"w-12 h-12 text-gray-400 mx-auto mb-4\" />\n          <h3 className=\"text-sm font-medium text-gray-900 mb-2\">\n            No financial patterns detected yet\n          </h3>\n          <p className=\"text-sm text-gray-600 mb-4\">\n            Start financial transaction analysis to identify suspicious patterns in money flows,\n            timing, amounts, and geographic distribution.\n          </p>\n          <button\n            onClick={analyzeTransactions}\n            className=\"px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 transition-colors\"\n          >\n            Start Financial Analysis\n          </button>\n        </div>\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/FinancialTransactionMapper.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'analyzeTransactionFlows' and 'detectFinancialPatterns'. Either include them or remove the dependency array.","line":126,"column":6,"nodeType":"ArrayExpression","endLine":126,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [analyzeTransactionFlows, detectFinancialPatterns, investigationId]","fix":{"range":[3998,4015],"text":"[analyzeTransactionFlows, detectFinancialPatterns, investigationId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport {\n  TrendingUp,\n  TrendingDown,\n  DollarSign,\n  AlertTriangle,\n  Filter,\n  Calendar,\n  Shield,\n  ShieldAlert,\n  ShieldCheck,\n  Search,\n  Download,\n  User,\n} from 'lucide-react';\nimport Icon from './Icon';\nimport { AddToInvestigationButton } from './AddToInvestigationButton';\n\ninterface Transaction {\n  id: string;\n  fromEntity: string;\n  toEntity: string;\n  amount: number;\n  currency: string;\n  date: string;\n  type: 'payment' | 'transfer' | 'investment' | 'loan' | 'shell_company' | 'offshore';\n  method: 'wire' | 'cash' | 'check' | 'crypto' | 'shell';\n  riskLevel: 'low' | 'medium' | 'high' | 'critical';\n  description: string;\n  suspiciousIndicators: string[];\n  sourceDocuments: string[];\n}\n\ninterface TransactionFlow {\n  entity: string;\n  inflow: number;\n  outflow: number;\n  netFlow: number;\n  transactionCount: number;\n  riskScore: number;\n  connections: string[];\n}\n\ninterface FinancialPattern {\n  type: 'layering' | 'structuring' | 'integration' | 'shell_network' | 'round_trip';\n  confidence: number;\n  transactions: string[];\n  description: string;\n  severity: 'low' | 'medium' | 'high' | 'critical';\n}\n\ninterface FinancialTransactionMapperProps {\n  investigationId?: string | number;\n}\n\nexport default function FinancialTransactionMapper({\n  investigationId,\n}: FinancialTransactionMapperProps = {}) {\n  const [transactions, setTransactions] = useState<Transaction[]>([]);\n  const [selectedTransaction, setSelectedTransaction] = useState<Transaction | null>(null);\n  const [flowAnalysis, setFlowAnalysis] = useState<TransactionFlow[]>([]);\n  const [detectedPatterns, setDetectedPatterns] = useState<FinancialPattern[]>([]);\n  const [viewMode, setViewMode] = useState<'flow' | 'network' | 'timeline' | 'patterns'>('flow');\n  const [filterRisk, setFilterRisk] = useState<string>('all');\n  const [filterAmount, setFilterAmount] = useState<string>('all');\n  const [searchTerm, setSearchTerm] = useState('');\n  const [dateRange, setDateRange] = useState({ start: '', end: '' });\n  const [, setLoading] = useState(true);\n  const [, setError] = useState<string | null>(null);\n\n  // Fetch real transaction data from API\n  useEffect(() => {\n    const fetchTransactions = async () => {\n      setLoading(true);\n      setError(null);\n\n      try {\n        // Use investigation-specific endpoint if ID provided, else global endpoint\n        const endpoint = investigationId\n          ? `/api/investigations/${investigationId}/transactions`\n          : '/api/financial/transactions';\n\n        const response = await fetch(endpoint);\n\n        if (!response.ok) {\n          throw new Error('Failed to fetch transactions');\n        }\n\n        const data = await response.json();\n\n        if (data && data.length > 0) {\n          // Map API response to Transaction interface\n          const mappedTransactions: Transaction[] = data.map((tx: any) => ({\n            id: `tx-${tx.id}`,\n            fromEntity: tx.from_entity,\n            toEntity: tx.to_entity,\n            amount: tx.amount,\n            currency: tx.currency || 'USD',\n            date: tx.transaction_date || '',\n            type: tx.transaction_type || 'transfer',\n            method: tx.method || 'wire',\n            riskLevel: tx.risk_level || 'medium',\n            description: tx.description || '',\n            suspiciousIndicators: tx.suspiciousIndicators || [],\n            sourceDocuments: tx.sourceDocumentIds || [],\n          }));\n\n          setTransactions(mappedTransactions);\n          analyzeTransactionFlows(mappedTransactions);\n          detectFinancialPatterns(mappedTransactions);\n        } else {\n          setTransactions([]);\n          setFlowAnalysis([]);\n          setDetectedPatterns([]);\n        }\n      } catch (err) {\n        console.error('Error fetching transactions:', err);\n        setError('Failed to load transaction data');\n        setTransactions([]);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchTransactions();\n  }, [investigationId]);\n\n  const analyzeTransactionFlows = (transactions: Transaction[]) => {\n    const entityMap = new Map<string, TransactionFlow>();\n\n    transactions.forEach((tx) => {\n      // From entity analysis\n      if (!entityMap.has(tx.fromEntity)) {\n        entityMap.set(tx.fromEntity, {\n          entity: tx.fromEntity,\n          inflow: 0,\n          outflow: 0,\n          netFlow: 0,\n          transactionCount: 0,\n          riskScore: 0,\n          connections: [],\n        });\n      }\n\n      // To entity analysis\n      if (!entityMap.has(tx.toEntity)) {\n        entityMap.set(tx.toEntity, {\n          entity: tx.toEntity,\n          inflow: 0,\n          outflow: 0,\n          netFlow: 0,\n          transactionCount: 0,\n          riskScore: 0,\n          connections: [],\n        });\n      }\n\n      const fromFlow = entityMap.get(tx.fromEntity)!;\n      const toFlow = entityMap.get(tx.toEntity)!;\n\n      fromFlow.outflow += tx.amount;\n      fromFlow.netFlow -= tx.amount;\n      fromFlow.transactionCount++;\n      fromFlow.riskScore += getRiskScore(tx.riskLevel);\n      if (!fromFlow.connections.includes(tx.toEntity)) {\n        fromFlow.connections.push(tx.toEntity);\n      }\n\n      toFlow.inflow += tx.amount;\n      toFlow.netFlow += tx.amount;\n      toFlow.transactionCount++;\n      toFlow.riskScore += getRiskScore(tx.riskLevel);\n      if (!toFlow.connections.includes(tx.fromEntity)) {\n        toFlow.connections.push(tx.fromEntity);\n      }\n    });\n\n    setFlowAnalysis(Array.from(entityMap.values()));\n  };\n\n  const detectFinancialPatterns = (transactions: Transaction[]) => {\n    const patterns: FinancialPattern[] = [];\n\n    // Detect layering pattern (multiple transfers to obscure source)\n    const layeringTxs = transactions.filter(\n      (tx) => tx.type === 'transfer' && tx.riskLevel === 'critical' && tx.amount > 5000000,\n    );\n\n    if (layeringTxs.length >= 2) {\n      patterns.push({\n        type: 'layering',\n        confidence: 85,\n        transactions: layeringTxs.map((tx) => tx.id),\n        description: 'Multiple large transfers suggesting money laundering layering phase',\n        severity: 'critical',\n      });\n    }\n\n    // Detect shell network pattern\n    const shellTxs = transactions.filter(\n      (tx) =>\n        tx.type === 'transfer' &&\n        (tx.method === 'shell' || tx.toEntity.includes('Trust') || tx.toEntity.includes('LLC')),\n    );\n\n    if (shellTxs.length >= 2) {\n      patterns.push({\n        type: 'shell_network',\n        confidence: 92,\n        transactions: shellTxs.map((tx) => tx.id),\n        description: 'Network of shell companies used to obscure beneficial ownership',\n        severity: 'high',\n      });\n    }\n\n    // Detect round-trip pattern\n    const epsteinTxs = transactions.filter(\n      (tx) => tx.fromEntity === 'Jeffrey Epstein' || tx.toEntity === 'Jeffrey Epstein',\n    );\n\n    const roundTripPattern = detectRoundTripPattern(epsteinTxs);\n    if (roundTripPattern) {\n      patterns.push(roundTripPattern);\n    }\n\n    setDetectedPatterns(patterns);\n  };\n\n  const detectRoundTripPattern = (transactions: Transaction[]): FinancialPattern | null => {\n    // Simplified round-trip detection\n    const epsteinOutflows = transactions.filter((tx) => tx.fromEntity === 'Jeffrey Epstein');\n    const epsteinInflows = transactions.filter((tx) => tx.toEntity === 'Jeffrey Epstein');\n\n    const suspiciousRoundTrip = epsteinOutflows.some((outTx) =>\n      epsteinInflows.some((inTx) => {\n        const outDate = new Date(outTx.date);\n        const inDate = new Date(inTx.date);\n        const daysDiff = Math.abs((inDate.getTime() - outDate.getTime()) / (1000 * 3600 * 24));\n\n        return (\n          daysDiff < 365 && // Within a year\n          Math.abs(inTx.amount - outTx.amount) < outTx.amount * 0.2\n        ); // Similar amounts\n      }),\n    );\n\n    if (suspiciousRoundTrip) {\n      return {\n        type: 'round_trip',\n        confidence: 78,\n        transactions: transactions.map((tx) => tx.id),\n        description: 'Suspicious round-trip transactions suggesting artificial fund movement',\n        severity: 'high',\n      };\n    }\n\n    return null;\n  };\n\n  const getRiskScore = (riskLevel: string): number => {\n    switch (riskLevel) {\n      case 'low':\n        return 1;\n      case 'medium':\n        return 3;\n      case 'high':\n        return 7;\n      case 'critical':\n        return 10;\n      default:\n        return 0;\n    }\n  };\n\n  const formatCurrency = (amount: number, currency: string = 'USD'): string => {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: currency,\n      minimumFractionDigits: 0,\n      maximumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const filteredTransactions = transactions.filter((tx) => {\n    const matchesSearch =\n      searchTerm === '' ||\n      tx.fromEntity.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      tx.toEntity.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      tx.description.toLowerCase().includes(searchTerm.toLowerCase());\n\n    const matchesRisk = filterRisk === 'all' || tx.riskLevel === filterRisk;\n\n    const matchesAmount =\n      filterAmount === 'all' ||\n      (filterAmount === 'small' && tx.amount < 100000) ||\n      (filterAmount === 'medium' && tx.amount >= 100000 && tx.amount < 5000000) ||\n      (filterAmount === 'large' && tx.amount >= 5000000);\n\n    const matchesDate =\n      (!dateRange.start || tx.date >= dateRange.start) &&\n      (!dateRange.end || tx.date <= dateRange.end);\n\n    return matchesSearch && matchesRisk && matchesAmount && matchesDate;\n  });\n\n  const exportTransactionData = () => {\n    const data = {\n      transactions: filteredTransactions,\n      flowAnalysis: flowAnalysis,\n      detectedPatterns: detectedPatterns,\n      exportDate: new Date().toISOString(),\n    };\n\n    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `epstein-financial-analysis-${new Date().toISOString().split('T')[0]}.json`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-900 text-gray-100 p-6\">\n      <div className=\"max-w-7xl mx-auto\">\n        {/* Header */}\n        <div className=\"mb-8\">\n          <h1 className=\"text-3xl font-bold text-red-400 mb-2\">Financial Transaction Mapper</h1>\n          <p className=\"text-gray-400\">\n            Advanced forensic analysis of financial flows and suspicious patterns\n          </p>\n        </div>\n\n        {/* Controls - Stacked Layout */}\n        <div className=\"bg-gray-800 rounded-lg p-6 mb-6\">\n          {/* Search Row */}\n          <div className=\"mb-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n              <input\n                type=\"text\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                placeholder=\"Search entities, descriptions, or transaction details...\"\n                className=\"w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n              />\n            </div>\n          </div>\n\n          {/* Filters Row - Stacked Layout */}\n          <div className=\"flex flex-col gap-3 mb-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n              <div>\n                <label className=\"block text-xs font-medium text-gray-400 mb-1\">Risk Level</label>\n                <select\n                  value={filterRisk}\n                  onChange={(e) => setFilterRisk(e.target.value)}\n                  className=\"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-red-500 text-sm\"\n                >\n                  <option value=\"all\">All Risk Levels</option>\n                  <option value=\"low\">Low Risk</option>\n                  <option value=\"medium\">Medium Risk</option>\n                  <option value=\"high\">High Risk</option>\n                  <option value=\"critical\">Critical Risk</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-xs font-medium text-gray-400 mb-1\">Amount Range</label>\n                <select\n                  value={filterAmount}\n                  onChange={(e) => setFilterAmount(e.target.value)}\n                  className=\"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-red-500 text-sm\"\n                >\n                  <option value=\"all\">All Amounts</option>\n                  <option value=\"small\">Under $100K</option>\n                  <option value=\"medium\">$100K - $5M</option>\n                  <option value=\"large\">Over $5M</option>\n                </select>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n              <div>\n                <label className=\"block text-xs font-medium text-gray-400 mb-1\">Start Date</label>\n                <input\n                  type=\"date\"\n                  value={dateRange.start}\n                  onChange={(e) => setDateRange((prev) => ({ ...prev, start: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-red-500 text-sm\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-xs font-medium text-gray-400 mb-1\">End Date</label>\n                <input\n                  type=\"date\"\n                  value={dateRange.end}\n                  onChange={(e) => setDateRange((prev) => ({ ...prev, end: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-red-500 text-sm\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* Actions Row */}\n          <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3\">\n            <div className=\"flex items-center gap-3\">\n              <select\n                value={viewMode}\n                onChange={(e) => setViewMode(e.target.value as any)}\n                className=\"px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-red-500 text-sm\"\n              >\n                <option value=\"flow\">Flow Analysis</option>\n                <option value=\"network\">Network View</option>\n                <option value=\"timeline\">Timeline</option>\n                <option value=\"patterns\">Detected Patterns</option>\n              </select>\n\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-xs text-gray-500\">\n                  {filteredTransactions.length} transactions\n                </span>\n              </div>\n            </div>\n\n            <button\n              onClick={exportTransactionData}\n              className=\"flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors text-sm\"\n            >\n              <Download className=\"w-4 h-4\" />\n              Export Data\n            </button>\n          </div>\n        </div>\n\n        {/* Summary Cards */}\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\n          <div className=\"bg-gray-800 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-gray-400 text-sm\">Total Transactions</p>\n                <p className=\"text-2xl font-bold text-blue-400\">{filteredTransactions.length}</p>\n              </div>\n              <TrendingUp className=\"w-8 h-8 text-blue-400\" />\n            </div>\n          </div>\n\n          <div className=\"bg-gray-800 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-gray-400 text-sm\">Total Value</p>\n                <p className=\"text-2xl font-bold text-green-400\">\n                  {formatCurrency(filteredTransactions.reduce((sum, tx) => sum + tx.amount, 0))}\n                </p>\n              </div>\n              <DollarSign className=\"w-8 h-8 text-green-400\" />\n            </div>\n          </div>\n\n          <div className=\"bg-gray-800 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-gray-400 text-sm\">High Risk</p>\n                <p className=\"text-2xl font-bold text-yellow-400\">\n                  {\n                    filteredTransactions.filter(\n                      (tx) => tx.riskLevel === 'high' || tx.riskLevel === 'critical',\n                    ).length\n                  }\n                </p>\n              </div>\n              <AlertTriangle className=\"w-8 h-8 text-yellow-400\" />\n            </div>\n          </div>\n\n          <div className=\"bg-gray-800 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-gray-400 text-sm\">Patterns Detected</p>\n                <p className=\"text-2xl font-bold text-red-400\">{detectedPatterns.length}</p>\n              </div>\n              <Filter className=\"w-8 h-8 text-red-400\" />\n            </div>\n          </div>\n        </div>\n\n        {/* Main Content */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          {/* Transaction List */}\n          <div className=\"lg:col-span-2\">\n            <div className=\"bg-gray-800 rounded-lg p-6\">\n              <h2 className=\"text-xl font-semibold text-gray-100 mb-4\">Transactions</h2>\n              <div className=\"space-y-4 max-h-96 overflow-y-auto\">\n                {filteredTransactions.map((transaction) => (\n                  <div\n                    key={transaction.id}\n                    onClick={() => setSelectedTransaction(transaction)}\n                    className={`p-4 rounded-lg cursor-pointer transition-colors ${\n                      selectedTransaction?.id === transaction.id\n                        ? 'bg-red-900 border border-red-500'\n                        : 'bg-gray-700 hover:bg-gray-600'\n                    }`}\n                  >\n                    <div className=\"flex flex-col gap-2\">\n                      <div className=\"flex justify-between items-start\">\n                        <div className=\"flex items-center gap-2 min-w-0 flex-1\">\n                          <User className=\"w-4 h-4 text-gray-400 shrink-0\" />\n                          <span\n                            className=\"font-medium text-gray-100 whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]\"\n                            title={transaction.fromEntity}\n                          >\n                            {transaction.fromEntity}\n                          </span>\n                          <TrendingDown className=\"w-4 h-4 text-red-400 shrink-0\" />\n                          <User className=\"w-4 h-4 text-gray-400 shrink-0\" />\n                          <span\n                            className=\"font-medium text-gray-100 whitespace-nowrap overflow-hidden text-ellipsis max-w-[120px]\"\n                            title={transaction.toEntity}\n                          >\n                            {transaction.toEntity}\n                          </span>\n                        </div>\n                        <div\n                          className=\"flex items-center gap-1\"\n                          title={`Risk Level: ${transaction.riskLevel.toUpperCase()}`}\n                        >\n                          {transaction.riskLevel === 'critical' && (\n                            <ShieldAlert className=\"w-5 h-5 text-red-400\" />\n                          )}\n                          {transaction.riskLevel === 'high' && (\n                            <Shield className=\"w-5 h-5 text-yellow-400\" />\n                          )}\n                          {transaction.riskLevel === 'medium' && (\n                            <ShieldCheck className=\"w-5 h-5 text-blue-400\" />\n                          )}\n                          {transaction.riskLevel === 'low' && (\n                            <Shield className=\"w-5 h-5 text-green-400\" />\n                          )}\n                          <div onClick={(e) => e.stopPropagation()}>\n                            <AddToInvestigationButton\n                              item={{\n                                id: transaction.id,\n                                title: `Transaction: ${transaction.fromEntity} -> ${transaction.toEntity}`,\n                                description: transaction.description,\n                                type: 'evidence',\n                                sourceId: transaction.id,\n                                metadata: {\n                                  amount: transaction.amount,\n                                  date: transaction.date,\n                                  type: transaction.type,\n                                },\n                              }}\n                              investigations={[]} // This needs to be populated from context or props\n                              onAddToInvestigation={(invId, item, relevance) => {\n                                console.log('Add to investigation', invId, item, relevance);\n                                const event = new CustomEvent('add-to-investigation', {\n                                  detail: { investigationId: invId, item, relevance },\n                                });\n                                window.dispatchEvent(event);\n                              }}\n                              variant=\"icon\"\n                              className=\"hover:bg-slate-600 p-1\"\n                            />\n                          </div>\n                        </div>\n                      </div>\n\n                      <div className=\"flex justify-between items-center text-sm text-gray-400\">\n                        <span className=\"font-semibold\">\n                          {formatCurrency(transaction.amount, transaction.currency)}\n                        </span>\n                        <span className=\"flex items-center gap-1\">\n                          <Calendar className=\"w-3 h-3\" />\n                          {transaction.date}\n                        </span>\n                        <span className=\"capitalize\">{transaction.type.replace('_', ' ')}</span>\n                      </div>\n\n                      <p className=\"text-sm text-gray-300 whitespace-normal break-words\">\n                        {transaction.description}\n                      </p>\n                    </div>\n\n                    {transaction.suspiciousIndicators.length > 0 && (\n                      <div className=\"mt-2\">\n                        <div className=\"flex flex-wrap gap-2\">\n                          {transaction.suspiciousIndicators.map((indicator, index) => (\n                            <span\n                              key={index}\n                              className=\"relative overflow-hidden px-2 py-1 bg-red-900/40 text-red-200 rounded text-xs border border-red-800/50 group\"\n                            >\n                              <span className=\"relative z-10 whitespace-normal\">{indicator}</span>\n                              <AlertTriangle className=\"absolute -right-1 -bottom-1 w-6 h-6 text-red-500/10 rotate-12\" />\n                            </span>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {/* Side Panel */}\n          <div className=\"space-y-6\">\n            {/* Entity Flow Analysis */}\n            <div className=\"bg-gray-800 rounded-lg p-6\">\n              <h3 className=\"text-lg font-semibold text-gray-100 mb-4\">Entity Flow Analysis</h3>\n              <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n                {flowAnalysis.slice(0, 5).map((flow, index) => (\n                  <div key={index} className=\"p-2 bg-gray-700 rounded\">\n                    <div className=\"flex justify-between items-center mb-1\">\n                      <span\n                        className=\"font-medium text-gray-100 text-xs truncate max-w-[120px]\"\n                        title={flow.entity}\n                      >\n                        {flow.entity}\n                      </span>\n                      <span\n                        className={`text-xs px-1 py-0.5 rounded ${\n                          flow.riskScore > 20\n                            ? 'bg-red-900 text-red-200'\n                            : flow.riskScore > 10\n                              ? 'bg-yellow-900 text-yellow-200'\n                              : 'bg-green-900 text-green-200'\n                        }`}\n                      >\n                        {flow.riskScore}\n                      </span>\n                    </div>\n                    <div className=\"grid grid-cols-3 gap-1 text-xs text-gray-400\">\n                      <div\n                        className=\"whitespace-nowrap overflow-hidden text-ellipsis\"\n                        title={`In: ${formatCurrency(flow.inflow)}`}\n                      >\n                        In: {formatCurrency(flow.inflow)}\n                      </div>\n                      <div\n                        className=\"whitespace-nowrap overflow-hidden text-ellipsis\"\n                        title={`Out: ${formatCurrency(flow.outflow)}`}\n                      >\n                        Out: {formatCurrency(flow.outflow)}\n                      </div>\n                      <div\n                        className=\"whitespace-nowrap overflow-hidden text-ellipsis\"\n                        title={`Net: ${formatCurrency(Math.abs(flow.netFlow))}`}\n                      >\n                        Net: {formatCurrency(Math.abs(flow.netFlow))}\n                      </div>\n                    </div>\n                    <div className=\"text-xs text-gray-500 mt-1 truncate\">\n                      {flow.transactionCount} tx • {flow.connections.length} conn\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n\n            {/* Detected Patterns */}\n            {detectedPatterns.length > 0 && (\n              <div className=\"bg-gray-800 rounded-lg p-6\">\n                <h3 className=\"text-lg font-semibold text-gray-100 mb-4\">Detected Patterns</h3>\n                <div className=\"space-y-2\">\n                  {detectedPatterns.map((pattern, index) => (\n                    <div key={index} className=\"p-2 bg-gray-700 rounded border-l-2 border-red-500\">\n                      <div className=\"flex justify-between items-center mb-1\">\n                        <span className=\"font-medium text-gray-100 capitalize text-xs\">\n                          {pattern.type.replace('_', ' ')}\n                        </span>\n                        <span\n                          className={`text-xs px-1 py-0.5 rounded ${\n                            pattern.severity === 'critical'\n                              ? 'bg-red-900 text-red-200'\n                              : pattern.severity === 'high'\n                                ? 'bg-yellow-900 text-yellow-200'\n                                : 'bg-blue-900 text-blue-200'\n                          }`}\n                        >\n                          {pattern.severity.substring(0, 1).toUpperCase()}\n                        </span>\n                      </div>\n                      <p\n                        className=\"text-xs text-gray-300 mb-1 line-clamp-2\"\n                        title={pattern.description}\n                      >\n                        {pattern.description}\n                      </p>\n                      <div className=\"flex justify-between items-center text-xs text-gray-400\">\n                        <span>{pattern.confidence}% conf</span>\n                        <span>{pattern.transactions.length} tx</span>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Transaction Details - Modal on Mobile, Inline on Desktop */}\n            {selectedTransaction && (\n              <div\n                className={`\n                fixed inset-0 z-50 bg-gray-900/95 backdrop-blur-sm p-4 overflow-y-auto flex items-center justify-center md:static md:bg-transparent md:backdrop-blur-none md:p-0 md:block\n              `}\n              >\n                <div className=\"bg-gray-800 rounded-lg p-6 w-full max-w-lg md:max-w-none shadow-2xl md:shadow-none border border-gray-700 md:border-0 relative\">\n                  {/* Mobile Close Button */}\n                  <button\n                    onClick={() => setSelectedTransaction(null)}\n                    className=\"absolute top-4 right-4 p-2 bg-gray-700 rounded-full text-gray-400 hover:text-white md:hidden\"\n                  >\n                    <Icon name=\"X\" className=\"w-5 h-5\" />\n                  </button>\n\n                  <div className=\"flex items-center justify-between mb-4 pr-10 md:pr-0\">\n                    <h3 className=\"text-lg font-semibold text-gray-100\">Transaction Details</h3>\n                    <AddToInvestigationButton\n                      item={{\n                        id: selectedTransaction.id,\n                        title: `Transaction: ${selectedTransaction.fromEntity} -> ${selectedTransaction.toEntity}`,\n                        description: selectedTransaction.description,\n                        type: 'evidence',\n                        sourceId: selectedTransaction.id,\n                        metadata: {\n                          amount: selectedTransaction.amount,\n                          date: selectedTransaction.date,\n                          type: selectedTransaction.type,\n                        },\n                      }}\n                      investigations={[]} // This needs to be populated from context or props\n                      onAddToInvestigation={(invId, item, relevance) => {\n                        console.log('Add to investigation', invId, item, relevance);\n                        const event = new CustomEvent('add-to-investigation', {\n                          detail: { investigationId: invId, item, relevance },\n                        });\n                        window.dispatchEvent(event);\n                      }}\n                      variant=\"button\"\n                      className=\"text-xs\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <div>\n                      <label className=\"block text-xs font-medium text-gray-400\">From</label>\n                      <p className=\"text-gray-100 text-sm\" title={selectedTransaction.fromEntity}>\n                        {selectedTransaction.fromEntity}\n                      </p>\n                    </div>\n                    <div>\n                      <label className=\"block text-xs font-medium text-gray-400\">To</label>\n                      <p className=\"text-gray-100 text-sm\" title={selectedTransaction.toEntity}>\n                        {selectedTransaction.toEntity}\n                      </p>\n                    </div>\n                    <div>\n                      <label className=\"block text-xs font-medium text-gray-400\">Amount</label>\n                      <p className=\"text-gray-100 font-semibold\">\n                        {formatCurrency(selectedTransaction.amount, selectedTransaction.currency)}\n                      </p>\n                    </div>\n                    <div>\n                      <label className=\"block text-xs font-medium text-gray-400\">Date</label>\n                      <p className=\"text-gray-100 text-sm\">{selectedTransaction.date}</p>\n                    </div>\n                    <div>\n                      <label className=\"block text-xs font-medium text-gray-400\">Type</label>\n                      <p className=\"text-gray-100 text-sm capitalize\">\n                        {selectedTransaction.type.replace('_', ' ')}\n                      </p>\n                    </div>\n                    <div>\n                      <label className=\"block text-xs font-medium text-gray-400\">Method</label>\n                      <p className=\"text-gray-100 text-sm capitalize\">\n                        {selectedTransaction.method}\n                      </p>\n                    </div>\n                    <div>\n                      <label className=\"block text-xs font-medium text-gray-400\">Description</label>\n                      <p className=\"text-gray-100 text-sm\">{selectedTransaction.description}</p>\n                    </div>\n\n                    {selectedTransaction.sourceDocuments.length > 0 && (\n                      <div>\n                        <label className=\"block text-xs font-medium text-gray-400 mb-1\">\n                          Source Documents\n                        </label>\n                        <div className=\"space-y-1\">\n                          {selectedTransaction.sourceDocuments.map((doc, index) => (\n                            <button\n                              key={index}\n                              className=\"block w-full text-left px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs text-blue-400 hover:text-blue-300 transition-colors truncate\"\n                              onClick={() => {\n                                /* TODO: Open document */\n                              }}\n                              title={doc}\n                            >\n                              📄 {doc}\n                            </button>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/FirstRunOnboarding.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/FlightTracker.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":49,"column":6,"nodeType":"ArrayExpression","endLine":49,"endColumn":57,"suggestions":[{"desc":"Update the dependencies array to be: [selectedPassenger, dateRange.start, dateRange.end, loadData]","fix":{"range":[1670,1721],"text":"[selectedPassenger, dateRange.start, dateRange.end, loadData]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has an unnecessary dependency: 'flights'. Either exclude it or remove the dependency array. Outer scope values like 'flights' aren't valid dependencies because mutating them doesn't re-render the component.","line":108,"column":8,"nodeType":"ArrayExpression","endLine":108,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: []","fix":{"range":[3675,3684],"text":"[]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used. Allowed unused args must match /^_/u.","line":230,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":230,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'toSvgCoords' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":346,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":346,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo } from 'react';\nimport { createPortal } from 'react-dom';\nimport Icon from './Icon';\nimport { Link } from 'react-router-dom';\nimport './FlightTracker.css';\n\ninterface Flight {\n  id: number;\n  date: string;\n  departure_airport: string;\n  departure_city: string;\n  departure_country: string;\n  arrival_airport: string;\n  arrival_city: string;\n  arrival_country: string;\n  aircraft_tail: string;\n  aircraft_type: string;\n  passengers?: { passenger_name: string; role: string; entity_id?: number }[];\n}\n\ninterface FlightStats {\n  totalFlights: number;\n  uniquePassengers: number;\n  topPassengers: { name: string; count: number }[];\n  topRoutes: { route: string; count: number }[];\n  flightsByYear: { year: string; count: number }[];\n  airports: { code: string; city: string; count: number }[];\n}\n\ninterface AirportCoords {\n  [code: string]: { lat: number; lng: number; city: string };\n}\n\ntype ViewMode = 'timeline' | 'map' | 'stats';\n\nconst FlightTracker: React.FC = () => {\n  const [flights, setFlights] = useState<Flight[]>([]);\n  const [stats, setStats] = useState<FlightStats | null>(null);\n  const [airports, setAirports] = useState<AirportCoords>({});\n  const [loading, setLoading] = useState(true);\n  const [viewMode, setViewMode] = useState<ViewMode>('timeline');\n  const [selectedPassenger, setSelectedPassenger] = useState<string>('');\n  const [dateRange, setDateRange] = useState({ start: '', end: '' });\n  const [passengers, setPassengers] = useState<{ name: string; flight_count: number }[]>([]);\n  const [selectedFlight, setSelectedFlight] = useState<Flight | null>(null);\n\n  useEffect(() => {\n    loadData();\n  }, [selectedPassenger, dateRange.start, dateRange.end]);\n\n  const loadData = async () => {\n    setLoading(true);\n    try {\n      const params = new URLSearchParams();\n      if (selectedPassenger) params.append('passenger', selectedPassenger);\n      if (dateRange.start) params.append('startDate', dateRange.start);\n      if (dateRange.end) params.append('endDate', dateRange.end);\n      params.append('limit', '100');\n\n      const [flightsRes, statsRes, airportsRes, passengersRes] = await Promise.all([\n        fetch(`/api/flights?${params}`),\n        fetch('/api/flights/stats'),\n        fetch('/api/flights/airports'),\n        fetch('/api/flights/passengers'),\n      ]);\n\n      const flightsData = await flightsRes.json();\n      const statsData = await statsRes.json();\n      const airportsData = await airportsRes.json();\n      const passengersData = await passengersRes.json();\n\n      setFlights(flightsData.flights || []);\n      setStats(statsData);\n      setAirports(airportsData);\n      // Ensure passengersData is an array\n      setPassengers(\n        Array.isArray(passengersData) ? passengersData : passengersData.passengers || [],\n      );\n    } catch (error) {\n      console.error('Failed to load flight data:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const formatDate = (dateStr: string) => {\n    const date = new Date(dateStr);\n    return date.toLocaleDateString('en-US', {\n      weekday: 'short',\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric',\n    });\n  };\n\n  // Simple SVG world map with flight routes\n  const MapView = () => {\n    const uniqueRoutes = useMemo(() => {\n      const routeMap = new Map<string, number>();\n      flights.forEach((f) => {\n        const key = `${f.departure_airport}-${f.arrival_airport}`;\n        routeMap.set(key, (routeMap.get(key) || 0) + 1);\n      });\n      return Array.from(routeMap.entries()).map(([key, count]) => {\n        const [from, to] = key.split('-');\n        return { from, to, count };\n      });\n    }, [flights]);\n\n    // Convert lat/lng to SVG coordinates (simple Mercator-like projection)\n    const toSvgCoords = (lat: number, lng: number) => {\n      const x = ((lng + 180) / 360) * 800;\n      const y = ((90 - lat) / 180) * 400;\n      return { x, y };\n    };\n\n    return (\n      <div className=\"flight-map-container\">\n        <svg viewBox=\"0 0 800 400\" className=\"flight-map\">\n          {/* Simple world background */}\n          <rect x=\"0\" y=\"0\" width=\"800\" height=\"400\" fill=\"#0a0a1a\" />\n\n          {/* Grid lines */}\n          {[...Array(9)].map((_, i) => (\n            <line\n              key={`h${i}`}\n              x1=\"0\"\n              y1={i * 50}\n              x2=\"800\"\n              y2={i * 50}\n              stroke=\"#1a1a2e\"\n              strokeWidth=\"0.5\"\n            />\n          ))}\n          {[...Array(17)].map((_, i) => (\n            <line\n              key={`v${i}`}\n              x1={i * 50}\n              y1=\"0\"\n              x2={i * 50}\n              y2=\"400\"\n              stroke=\"#1a1a2e\"\n              strokeWidth=\"0.5\"\n            />\n          ))}\n\n          {/* Draw routes */}\n          {uniqueRoutes.map((route, i) => {\n            const fromCoords = airports[route.from];\n            const toCoords = airports[route.to];\n            if (!fromCoords || !toCoords) return null;\n\n            const from = toSvgCoords(fromCoords.lat, fromCoords.lng);\n            const to = toSvgCoords(toCoords.lat, toCoords.lng);\n\n            // Calculate control point for curved line\n            const midX = (from.x + to.x) / 2;\n            const midY = (from.y + to.y) / 2 - 30;\n\n            return (\n              <g key={i}>\n                <path\n                  d={`M ${from.x} ${from.y} Q ${midX} ${midY} ${to.x} ${to.y}`}\n                  fill=\"none\"\n                  stroke={`rgba(0, 200, 255, ${Math.min(0.3 + route.count * 0.1, 0.9)})`}\n                  strokeWidth={Math.min(1 + route.count * 0.3, 3)}\n                  strokeDasharray=\"5,3\"\n                  className=\"flight-route\"\n                />\n              </g>\n            );\n          })}\n\n          {/* Draw airports */}\n          {Object.entries(airports).map(([code, coords]) => {\n            const { x, y } = toSvgCoords(coords.lat, coords.lng);\n            const flightCount = stats?.airports.find((a) => a.code === code)?.count || 0;\n\n            return (\n              <g key={code} className=\"airport-marker\">\n                <circle\n                  cx={x}\n                  cy={y}\n                  r={Math.min(4 + flightCount * 0.3, 10)}\n                  fill=\"#00c8ff\"\n                  opacity=\"0.8\"\n                />\n                <circle\n                  cx={x}\n                  cy={y}\n                  r={Math.min(4 + flightCount * 0.3, 10)}\n                  fill=\"none\"\n                  stroke=\"#00c8ff\"\n                  strokeWidth=\"2\"\n                  className=\"airport-pulse\"\n                />\n                <text\n                  x={x}\n                  y={y - 12}\n                  fill=\"#fff\"\n                  fontSize=\"8\"\n                  textAnchor=\"middle\"\n                  className=\"airport-label\"\n                >\n                  {code}\n                </text>\n              </g>\n            );\n          })}\n        </svg>\n\n        <div className=\"map-legend\">\n          <h4>Key Locations</h4>\n          <div className=\"legend-items\">\n            <div className=\"legend-item\">\n              <span className=\"legend-dot primary\" /> Primary Hubs\n            </div>\n            <div className=\"legend-item\">\n              <span className=\"legend-dot secondary\" /> Destinations\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  // Timeline view\n  const TimelineView = () => (\n    <div className=\"flight-timeline\">\n      {flights.map((flight, index) => (\n        <div key={flight.id} className=\"flight-card\" onClick={() => setSelectedFlight(flight)}>\n          <div className=\"flight-date\">\n            <span className=\"date-badge\">{formatDate(flight.date)}</span>\n          </div>\n\n          <div className=\"flight-route\">\n            <div className=\"airport departure\">\n              <span className=\"airport-code\">{flight.departure_airport}</span>\n              <span className=\"airport-city\">{flight.departure_city}</span>\n            </div>\n\n            <div className=\"flight-line\">\n              <div className=\"plane-icon\">✈</div>\n              <div className=\"dashed-line\" />\n            </div>\n\n            <div className=\"airport arrival\">\n              <span className=\"airport-code\">{flight.arrival_airport}</span>\n              <span className=\"airport-city\">{flight.arrival_city}</span>\n            </div>\n          </div>\n\n          <div className=\"flight-passengers\">\n            <span className=\"passenger-count\">\n              <Icon name=\"Users\" size=\"sm\" /> {flight.passengers?.length || 0} passengers\n            </span>\n            <div className=\"passenger-names\">\n              {flight.passengers?.slice(0, 3).map((p, i) => (\n                <span key={i} className={`passenger-tag ${p.role}`}>\n                  {p.passenger_name}\n                </span>\n              ))}\n              {(flight.passengers?.length || 0) > 3 && (\n                <span className=\"more-passengers\">\n                  +{(flight.passengers?.length || 0) - 3} more\n                </span>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flight-aircraft\">\n            <span className=\"tail-number\">{flight.aircraft_tail}</span>\n            <span className=\"aircraft-type\">{flight.aircraft_type}</span>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n\n  // Stats view\n  const StatsView = () => (\n    <div className=\"flight-stats-grid\">\n      <div className=\"stat-card primary\">\n        <div className=\"stat-icon\">✈</div>\n        <div className=\"stat-value\">{stats?.totalFlights || 0}</div>\n        <div className=\"stat-label\">Total Flights</div>\n      </div>\n\n      <div className=\"stat-card\">\n        <div className=\"stat-icon\">👥</div>\n        <div className=\"stat-value\">{stats?.uniquePassengers || 0}</div>\n        <div className=\"stat-label\">Unique Passengers</div>\n      </div>\n\n      <div className=\"stat-card full-width\">\n        <h3>Top Passengers</h3>\n        <div className=\"stat-bars\">\n          {stats?.topPassengers.slice(0, 8).map((p, i) => (\n            <div key={i} className=\"stat-bar-item\">\n              <span className=\"bar-label\">{p.name}</span>\n              <div className=\"bar-track\">\n                <div\n                  className=\"bar-fill\"\n                  style={{ width: `${(p.count / (stats.topPassengers[0]?.count || 1)) * 100}%` }}\n                />\n              </div>\n              <span className=\"bar-value\">{p.count}</span>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"stat-card\">\n        <h3>Top Routes</h3>\n        <div className=\"route-list\">\n          {stats?.topRoutes.slice(0, 5).map((r, i) => (\n            <div key={i} className=\"route-item\">\n              <span className=\"route-path\">{r.route}</span>\n              <span className=\"route-count\">{r.count}x</span>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"stat-card\">\n        <h3>Flights by Year</h3>\n        <div className=\"year-chart\">\n          {stats?.flightsByYear.map((y, i) => (\n            <div key={i} className=\"year-bar\">\n              <div\n                className=\"year-fill\"\n                style={{\n                  height: `${(y.count / Math.max(...stats.flightsByYear.map((x) => x.count))) * 100}%`,\n                }}\n              />\n              <span className=\"year-label\">{y.year}</span>\n              <span className=\"year-count\">{y.count}</span>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n\n  // Convert lat/lng to SVG coordinates for flight path map\n  const toSvgCoords = (lat: number, lng: number, width: number, height: number) => {\n    const x = ((lng + 180) / 360) * width;\n    const y = ((90 - lat) / 180) * height;\n    return { x, y };\n  };\n\n  // Flight path mini-map for modal using SVG (better control than iframe)\n  const FlightPathMap = ({ flight }: { flight: Flight }) => {\n    const fromCoords = airports[flight.departure_airport];\n    const toCoords = airports[flight.arrival_airport];\n\n    if (!fromCoords || !toCoords) {\n      return (\n        <div className=\"flight-path-map-placeholder\">\n          <Icon name=\"Globe\" size=\"lg\" />\n          <span>Map coordinates unavailable for this route</span>\n        </div>\n      );\n    }\n\n    // Determine bounds\n    const lats = [fromCoords.lat, toCoords.lat];\n    const lngs = [fromCoords.lng, toCoords.lng];\n    const minLat = Math.min(...lats);\n    const maxLat = Math.max(...lats);\n    const minLng = Math.min(...lngs);\n    const maxLng = Math.max(...lngs);\n\n    // Add 20% padding\n    const latPad = Math.max((maxLat - minLat) * 0.4, 2);\n    const lngPad = Math.max((maxLng - minLng) * 0.4, 2);\n\n    const viewBoxMinLng = minLng - lngPad;\n    const viewBoxMaxLng = maxLng + lngPad;\n    const viewBoxMinLat = minLat - latPad;\n    const viewBoxMaxLat = maxLat + latPad;\n\n    // Helper to project lat/lng to 0-100 coordinate space\n    const project = (lat: number, lng: number) => {\n      const x = ((lng - viewBoxMinLng) / (viewBoxMaxLng - viewBoxMinLng)) * 100;\n      // Invert Y because SVG Y grows downwards, but Latitude grows upwards\n      const y = 100 - ((lat - viewBoxMinLat) / (viewBoxMaxLat - viewBoxMinLat)) * 100;\n      return { x, y };\n    };\n\n    const start = project(fromCoords.lat, fromCoords.lng);\n    const end = project(toCoords.lat, toCoords.lng);\n\n    // Calculate curve control point (offset perpendicular to line)\n    // Simple approach: midpoint with Y offset?\n    // Better: offset based on direction. For simplicity, just arch \"up\" (lower Y)\n    const midX = (start.x + end.x) / 2;\n    const midY = Math.min(start.y, end.y) - 20;\n\n    const googleMapsUrl = `https://www.google.com/maps/dir/${fromCoords.lat},${fromCoords.lng}/${toCoords.lat},${toCoords.lng}`;\n\n    return (\n      <div className=\"flight-path-map\">\n        <div className=\"relative h-48 bg-slate-900 rounded-t-lg overflow-hidden border-b border-slate-800\">\n          {/* SVG Map */}\n          <svg\n            viewBox=\"0 0 100 100\"\n            className=\"w-full h-full\"\n            preserveAspectRatio=\"xMidYMid meeting\"\n          >\n            {/* Background gradient or solid color is handled by container */}\n\n            {/* Grid/Context cues - simplified */}\n            <rect x=\"0\" y=\"0\" width=\"100\" height=\"100\" fill=\"#0f172a\" />\n\n            {/* Route Line */}\n            <path\n              d={`M ${start.x} ${start.y} Q ${midX} ${midY} ${end.x} ${end.y}`}\n              fill=\"none\"\n              stroke=\"#06b6d4\" // cyan-500\n              strokeWidth=\"1.5\"\n              strokeDasharray=\"4 2\"\n              className=\"animate-[dash_20s_linear_infinite]\"\n            >\n              <animate\n                attributeName=\"stroke-dashoffset\"\n                from=\"100\"\n                to=\"0\"\n                dur=\"2s\"\n                repeatCount=\"indefinite\"\n              />\n            </path>\n\n            {/* Start Point */}\n            <circle cx={start.x} cy={start.y} r=\"2\" fill=\"#3b82f6\" />\n            <text x={start.x} y={start.y + 5} fill=\"#94a3b8\" fontSize=\"3\" textAnchor=\"middle\">\n              {flight.departure_airport}\n            </text>\n\n            {/* End Point */}\n            <circle cx={end.x} cy={end.y} r=\"2\" fill=\"#ef4444\" />\n            <text x={end.x} y={end.y + 5} fill=\"#94a3b8\" fontSize=\"3\" textAnchor=\"middle\">\n              {flight.arrival_airport}\n            </text>\n          </svg>\n\n          {/* Route overlay info */}\n          <div className=\"absolute bottom-2 left-2 right-2 flex justify-between items-center px-2 py-1 bg-black/60 backdrop-blur-sm rounded text-xs pointer-events-none\">\n            <span className=\"text-cyan-300 font-bold\">{flight.departure_airport}</span>\n            <span className=\"text-slate-400 text-[10px] uppercase tracking-wider\">Flight Path</span>\n            <span className=\"text-red-300 font-bold\">{flight.arrival_airport}</span>\n          </div>\n        </div>\n        <a\n          href={googleMapsUrl}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"flex items-center justify-center gap-2 py-2 bg-slate-800 hover:bg-slate-700 text-cyan-300 text-xs font-medium transition-colors rounded-b-lg group\"\n        >\n          <Icon\n            name=\"ExternalLink\"\n            size=\"sm\"\n            className=\"group-hover:scale-110 transition-transform\"\n          />\n          View Detailed Ground Map\n        </a>\n      </div>\n    );\n  };\n\n  // Flight detail modal\n  const FlightModal = () => {\n    if (!selectedFlight) return null;\n\n    return createPortal(\n      <div className=\"flight-modal-overlay\" onClick={() => setSelectedFlight(null)}>\n        <div className=\"flight-modal\" onClick={(e) => e.stopPropagation()}>\n          <button className=\"modal-close\" onClick={() => setSelectedFlight(null)}>\n            ×\n          </button>\n\n          <div className=\"modal-header\" style={{ paddingRight: '3rem' }}>\n            <h2>Flight Details</h2>\n            <span className=\"flight-date\">{formatDate(selectedFlight.date)}</span>\n          </div>\n\n          {/* Flight Path Map */}\n          <FlightPathMap flight={selectedFlight} />\n\n          <div className=\"modal-route\">\n            <div className=\"route-endpoint\">\n              <span className=\"code\">{selectedFlight.departure_airport}</span>\n              <span className=\"city\">{selectedFlight.departure_city}</span>\n            </div>\n            <div className=\"route-arrow\">→</div>\n            <div className=\"route-endpoint\">\n              <span className=\"code\">{selectedFlight.arrival_airport}</span>\n              <span className=\"city\">{selectedFlight.arrival_city}</span>\n            </div>\n          </div>\n\n          <div className=\"modal-section\">\n            <h3>Aircraft</h3>\n            <p>\n              {selectedFlight.aircraft_type} ({selectedFlight.aircraft_tail})\n            </p>\n          </div>\n\n          <div className=\"modal-section\">\n            <h3>Passenger Manifest ({selectedFlight.passengers?.length || 0})</h3>\n            <div className=\"passenger-list\">\n              {selectedFlight.passengers?.map((p, i) => (\n                <div key={i} className=\"passenger-row\">\n                  <span className={`role-badge ${p.role}`}>{p.role}</span>\n                  {p.entity_id ? (\n                    <Link to={`/entity/${p.entity_id}`} className=\"passenger-link\">\n                      {p.passenger_name}\n                    </Link>\n                  ) : (\n                    <span>{p.passenger_name}</span>\n                  )}\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </div>,\n      document.body,\n    );\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flight-tracker loading-state\">\n        <div className=\"loading-spinner\">\n          <div className=\"radar-sweep\" />\n          <span>Loading Flight Data...</span>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flight-tracker\">\n      <div className=\"tracker-header\">\n        <div className=\"header-left\">\n          <h1>\n            <Icon name=\"Navigation\" size=\"lg\" />\n            Flight Tracker\n          </h1>\n          <p className=\"subtitle\">Tracking flights on N908JE \"Lolita Express\"</p>\n        </div>\n\n        <div className=\"header-stats\">\n          <div className=\"mini-stat\">\n            <span className=\"value\">{stats?.totalFlights || 0}</span>\n            <span className=\"label\">Flights</span>\n          </div>\n          <div className=\"mini-stat\">\n            <span className=\"value\">{stats?.uniquePassengers || 0}</span>\n            <span className=\"label\">Passengers</span>\n          </div>\n          <div className=\"mini-stat\">\n            <span className=\"value\">{Object.keys(airports).length}</span>\n            <span className=\"label\">Airports</span>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"tracker-controls\">\n        <div className=\"view-toggle\">\n          <button\n            className={viewMode === 'timeline' ? 'active' : ''}\n            onClick={() => setViewMode('timeline')}\n          >\n            <Icon name=\"List\" size=\"sm\" /> Timeline\n          </button>\n          <button className={viewMode === 'map' ? 'active' : ''} onClick={() => setViewMode('map')}>\n            <Icon name=\"Globe\" size=\"sm\" /> Map\n          </button>\n          <button\n            className={viewMode === 'stats' ? 'active' : ''}\n            onClick={() => setViewMode('stats')}\n          >\n            <Icon name=\"BarChart3\" size=\"sm\" /> Stats\n          </button>\n        </div>\n\n        <div className=\"filters\">\n          <select\n            value={selectedPassenger}\n            onChange={(e) => setSelectedPassenger(e.target.value)}\n            className=\"passenger-filter\"\n          >\n            <option value=\"\">All Passengers</option>\n            {(passengers || []).map((p) => (\n              <option key={p.name} value={p.name}>\n                {p.name} ({p.flight_count})\n              </option>\n            ))}\n          </select>\n\n          <input\n            type=\"date\"\n            value={dateRange.start}\n            onChange={(e) => setDateRange((r) => ({ ...r, start: e.target.value }))}\n            placeholder=\"From\"\n            className=\"date-filter\"\n          />\n          <input\n            type=\"date\"\n            value={dateRange.end}\n            onChange={(e) => setDateRange((r) => ({ ...r, end: e.target.value }))}\n            placeholder=\"To\"\n            className=\"date-filter\"\n          />\n        </div>\n      </div>\n\n      <div className=\"tracker-content\">\n        {viewMode === 'timeline' && <TimelineView />}\n        {viewMode === 'map' && <MapView />}\n        {viewMode === 'stats' && <StatsView />}\n      </div>\n\n      <FlightModal />\n    </div>\n  );\n};\n\nexport default FlightTracker;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/Footer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ForensicAnalysisWorkspace.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ForensicDocumentAnalyzer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ForensicReportGenerator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/FormField.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/FormLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/GlobalSearch.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'performSearch'. Either include it or remove the dependency array.","line":67,"column":6,"nodeType":"ArrayExpression","endLine":67,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [performSearch, searchTerm]","fix":{"range":[2252,2264],"text":"[performSearch, searchTerm]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'applyFilters'. Either include it or remove the dependency array.","line":71,"column":6,"nodeType":"ArrayExpression","endLine":71,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [results, filters, applyFilters]","fix":{"range":[2313,2331],"text":"[results, filters, applyFilters]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport { createPortal } from 'react-dom';\nimport { Search, Filter, Calendar, Eye, Download, ChevronDown, User, Building } from 'lucide-react';\nimport { apiClient } from '../services/apiClient';\nimport { Person } from '../types';\n\ninterface SearchResult {\n  file: string;\n  filename: string;\n  category: string;\n  entities: string[];\n  dates: string[];\n  word_count: number;\n  score: number;\n  highlights: string[];\n}\n\ninterface SearchFilters {\n  category: string;\n  entity: string;\n  date_range: { start: string; end: string };\n  min_word_count: number;\n}\n\nconst GlobalSearch: React.FC = () => {\n  const [searchTerm, setSearchTerm] = useState<string>('');\n  const [results, setResults] = useState<SearchResult[]>([]);\n  const [entityResults, setEntityResults] = useState<Person[]>([]);\n  const [filteredResults, setFilteredResults] = useState<SearchResult[]>([]);\n  const [selectedResult, setSelectedResult] = useState<SearchResult | null>(null);\n  const [loading, setLoading] = useState<boolean>(false);\n  const [showFilters, setShowFilters] = useState<boolean>(false);\n  const [filters, setFilters] = useState<SearchFilters>({\n    category: 'all',\n    entity: '',\n    date_range: { start: '', end: '' },\n    min_word_count: 0,\n  });\n  const [stats, setStats] = useState<any>(null);\n\n  useEffect(() => {\n    apiClient.getStats().then(setStats).catch(console.error);\n  }, []);\n\n  const categories = [\n    { id: 'all', name: 'All Categories', color: 'bg-gray-600' },\n    { id: 'emails', name: 'Emails', color: 'bg-green-600' },\n    { id: 'legal_documents', name: 'Legal Documents', color: 'bg-red-600' },\n    { id: 'flight_logs', name: 'Flight Records', color: 'bg-yellow-600' },\n    { id: 'testimonies', name: 'Testimonies', color: 'bg-cyan-600' },\n    { id: 'financial_records', name: 'Financial', color: 'bg-orange-600' },\n    { id: 'general_documents', name: 'General', color: 'bg-blue-600' },\n  ];\n\n  useEffect(() => {\n    if (searchTerm.length > 2) {\n      const delayDebounceFn = setTimeout(() => {\n        performSearch();\n      }, 500);\n\n      return () => clearTimeout(delayDebounceFn);\n    } else {\n      setResults([]);\n      setEntityResults([]);\n      setFilteredResults([]);\n    }\n  }, [searchTerm]);\n\n  useEffect(() => {\n    applyFilters();\n  }, [results, filters]);\n\n  const performSearch = async () => {\n    setLoading(true);\n\n    try {\n      const data = await apiClient.search(searchTerm, 100);\n\n      if (data.entities) {\n        setEntityResults(data.entities);\n      }\n\n      if (data.documents) {\n        const searchResults: SearchResult[] = data.documents.map((doc: any) => ({\n          file: doc.filePath,\n          filename: doc.fileName,\n          category: doc.evidenceType || 'general_documents',\n          entities: [],\n          dates: [],\n          word_count: doc.wordCount || 0,\n          score: doc.score || 0,\n          highlights: doc.contentPreview ? [doc.contentPreview] : [],\n        }));\n        setResults(searchResults);\n        setFilteredResults(searchResults);\n      }\n    } catch (error) {\n      console.error('Search error:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const applyFilters = () => {\n    let filtered = [...results];\n\n    // Filter by category\n    if (filters.category !== 'all') {\n      filtered = filtered.filter((result) => result.category === filters.category);\n    }\n\n    // Filter by entity\n    if (filters.entity) {\n      filtered = filtered.filter((result) =>\n        result.entities.some((entity) =>\n          entity.toLowerCase().includes(filters.entity.toLowerCase()),\n        ),\n      );\n    }\n\n    // Filter by word count\n    if (filters.min_word_count > 0) {\n      filtered = filtered.filter((result) => result.word_count >= filters.min_word_count);\n    }\n\n    setFilteredResults(filtered);\n  };\n\n  const getCategoryColor = (category: string) => {\n    const cat = categories.find((c) => c.id === category);\n    return cat?.color || 'bg-gray-600';\n  };\n\n  const formatWordCount = (count: number) => {\n    if (count >= 1000000) return `${(count / 1000000).toFixed(1)}M`;\n    if (count >= 1000) return `${(count / 1000).toFixed(1)}K`;\n    return count.toString();\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Search Header */}\n      <div className=\"bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl border border-gray-700\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <h2 className=\"text-2xl font-bold text-white flex items-center space-x-2\">\n            <Search className=\"h-6 w-6 text-cyan-400\" />\n            <span>Global Evidence Search</span>\n          </h2>\n          <button\n            onClick={() => setShowFilters(!showFilters)}\n            className=\"flex items-center space-x-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors\"\n          >\n            <Filter className=\"h-4 w-4\" />\n            <span>Filters</span>\n            <ChevronDown\n              className={`h-4 w-4 transition-transform ${showFilters ? 'rotate-180' : ''}`}\n            />\n          </button>\n        </div>\n\n        {/* Search Input */}\n        <div className=\"relative\">\n          <Search className=\"absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400\" />\n          <input\n            type=\"text\"\n            placeholder=\"Search across all evidence files... (e.g., Trump, Clinton, Epstein, flight logs, emails)\"\n            className=\"w-full pl-12 pr-4 py-4 bg-gray-900/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-lg\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n          />\n          {loading && (\n            <div className=\"absolute right-4 top-1/2 transform -translate-y-1/2\">\n              <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-cyan-400\"></div>\n            </div>\n          )}\n        </div>\n\n        <p className=\"text-gray-400 text-sm mt-2\">\n          Search across {stats?.totalDocuments?.toLocaleString() || 'thousands of'} evidence files.\n          Try names, dates, document types, or key terms.\n        </p>\n      </div>\n\n      {/* Filters Panel */}\n      {showFilters && (\n        <div className=\"bg-gray-800/50 backdrop-blur-sm p-6 rounded-xl border border-gray-700\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n            <div>\n              <label className=\"block text-white text-sm font-medium mb-2\">Category</label>\n              <select\n                value={filters.category}\n                onChange={(e) => setFilters({ ...filters, category: e.target.value })}\n                className=\"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-cyan-500\"\n              >\n                {categories.map((cat) => (\n                  <option key={cat.id} value={cat.id}>\n                    {cat.name}\n                  </option>\n                ))}\n              </select>\n            </div>\n\n            <div>\n              <label className=\"block text-white text-sm font-medium mb-2\">Entity</label>\n              <input\n                type=\"text\"\n                placeholder=\"e.g., Trump, Epstein, Clinton\"\n                value={filters.entity}\n                onChange={(e) => setFilters({ ...filters, entity: e.target.value })}\n                className=\"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-500\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block text-white text-sm font-medium mb-2\">Min Word Count</label>\n              <input\n                type=\"number\"\n                min=\"0\"\n                value={filters.min_word_count}\n                onChange={(e) =>\n                  setFilters({ ...filters, min_word_count: parseInt(e.target.value) || 0 })\n                }\n                className=\"w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-cyan-500\"\n              />\n            </div>\n\n            <div className=\"flex items-end\">\n              <button\n                onClick={() =>\n                  setFilters({\n                    category: 'all',\n                    entity: '',\n                    date_range: { start: '', end: '' },\n                    min_word_count: 0,\n                  })\n                }\n                className=\"w-full px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white transition-colors\"\n              >\n                Clear Filters\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Entity Results */}\n      {entityResults.length > 0 && (\n        <div className=\"bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700 p-6\">\n          <h3 className=\"text-xl font-semibold text-white mb-4 flex items-center gap-2\">\n            <User className=\"h-5 w-5 text-cyan-400\" />\n            Matched Entities\n          </h3>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {entityResults.map((entity) => (\n              <div\n                key={entity.id}\n                className=\"bg-gray-700/50 p-4 rounded-lg border border-gray-600 hover:border-cyan-500 transition-colors cursor-pointer\"\n              >\n                <div className=\"flex items-start justify-between\">\n                  <div>\n                    <h4 className=\"text-white font-medium\">{entity.name}</h4>\n                    <p className=\"text-sm text-gray-400\">{entity.role || 'Unknown Role'}</p>\n                  </div>\n                  <div\n                    className={`px-2 py-1 rounded text-xs font-bold ${\n                      (entity.red_flag_rating || 0) > 3\n                        ? 'bg-red-900 text-red-200'\n                        : 'bg-gray-600 text-gray-300'\n                    }`}\n                  >\n                    🚩 {entity.red_flag_rating || 0}\n                  </div>\n                </div>\n                <div className=\"mt-3 flex items-center gap-4 text-xs text-gray-400\">\n                  <span className=\"flex items-center gap-1\">\n                    <Eye className=\"h-3 w-3\" />\n                    {entity.files || 0} docs\n                  </span>\n                  <span className=\"flex items-center gap-1\">\n                    <Building className=\"h-3 w-3\" />\n                    {entity.mentions || 0} mentions\n                  </span>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Document Results */}\n      <div className=\"bg-gray-800/50 backdrop-blur-sm rounded-xl border border-gray-700\">\n        <div className=\"p-6 border-b border-gray-700\">\n          <div className=\"flex items-center justify-between\">\n            <h3 className=\"text-xl font-semibold text-white\">\n              Document Results {searchTerm && `for \"${searchTerm}\"`}\n            </h3>\n            <span className=\"text-gray-400\">{filteredResults.length.toLocaleString()} results</span>\n          </div>\n        </div>\n\n        <div className=\"divide-y divide-gray-700\">\n          {filteredResults.map((result, index) => (\n            <div\n              key={index}\n              className=\"p-6 hover:bg-gray-800/30 cursor-pointer transition-colors\"\n              onClick={() => setSelectedResult(result)}\n            >\n              <div className=\"flex items-start justify-between\">\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center space-x-3 mb-2\">\n                    <span\n                      className={`px-2 py-1 rounded-full text-xs font-medium text-white ${getCategoryColor(result.category)}`}\n                    >\n                      {categories.find((c) => c.id === result.category)?.name || result.category}\n                    </span>\n                    <span className=\"text-gray-400 text-sm\">\n                      {formatWordCount(result.word_count)} words\n                    </span>\n                    <span className=\"text-cyan-400 text-sm font-medium\">Score: {result.score}</span>\n                  </div>\n\n                  <h4 className=\"text-white font-medium text-lg mb-2\">{result.filename}</h4>\n\n                  <p className=\"text-gray-400 text-sm mb-3\">{result.file}</p>\n\n                  {result.highlights.length > 0 && (\n                    <div className=\"space-y-1\">\n                      {result.highlights.slice(0, 3).map((highlight, idx) => (\n                        <div key={idx} className=\"text-gray-300 text-sm flex items-start space-x-2\">\n                          <span className=\"mt-1 text-cyan-500\">•</span>\n                          <span\n                            dangerouslySetInnerHTML={{\n                              __html: highlight.replace(\n                                /<mark>/g,\n                                '<mark class=\"bg-yellow-500/30 text-yellow-200 rounded px-0.5\">',\n                              ),\n                            }}\n                          />\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  {result.entities.length > 0 && (\n                    <div className=\"mt-3\">\n                      <p className=\"text-gray-400 text-xs mb-1\">Entities mentioned:</p>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {result.entities.slice(0, 5).map((entity, idx) => (\n                          <span\n                            key={idx}\n                            className=\"px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs\"\n                          >\n                            {entity}\n                          </span>\n                        ))}\n                        {result.entities.length > 5 && (\n                          <span className=\"px-2 py-1 bg-gray-700 text-gray-400 rounded text-xs\">\n                            +{result.entities.length - 5} more\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                  )}\n\n                  {result.dates.length > 0 && (\n                    <div className=\"mt-2 flex items-center space-x-2 text-gray-400 text-xs\">\n                      <Calendar className=\"h-3 w-3\" />\n                      <span>{result.dates.slice(0, 3).join(', ')}</span>\n                      {result.dates.length > 3 && <span>+{result.dates.length - 3} more</span>}\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"ml-4 flex items-center space-x-2\">\n                  <button\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      // Handle file preview\n                    }}\n                    className=\"p-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg text-white transition-colors\"\n                  >\n                    <Eye className=\"h-4 w-4\" />\n                  </button>\n                  <button\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      // Handle file download\n                    }}\n                    className=\"p-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white transition-colors\"\n                  >\n                    <Download className=\"h-4 w-4\" />\n                  </button>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n\n        {filteredResults.length === 0 && entityResults.length === 0 && searchTerm && (\n          <div className=\"p-12 text-center\">\n            <Search className=\"h-12 w-12 text-gray-500 mx-auto mb-4\" />\n            <h4 className=\"text-gray-300 font-medium mb-2\">No results found</h4>\n            <p className=\"text-gray-500 mb-4\">Try adjusting your search terms or filters</p>\n            <p className=\"text-gray-600 text-sm\">\n              Search tips: Try different spellings, use fewer keywords, or check entity names\n            </p>\n          </div>\n        )}\n\n        {!searchTerm && (\n          <div className=\"p-12 text-center\">\n            <Search className=\"h-12 w-12 text-gray-500 mx-auto mb-4\" />\n            <h4 className=\"text-gray-300 font-medium mb-2\">Start your investigation</h4>\n            <p className=\"text-gray-500\">\n              Enter a search term to begin exploring the evidence archive\n            </p>\n          </div>\n        )}\n      </div>\n\n      {/* Result Detail Modal */}\n      {selectedResult &&\n        createPortal(\n          <div className=\"fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999] p-4\">\n            <div className=\"bg-slate-800 rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden border border-slate-700\">\n              <div className=\"p-6 border-b border-slate-700\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-3\">\n                    <span\n                      className={`px-3 py-1 rounded-full text-sm font-medium text-white ${getCategoryColor(selectedResult.category)}`}\n                    >\n                      {categories.find((c) => c.id === selectedResult.category)?.name}\n                    </span>\n                    <h3 className=\"text-xl font-semibold text-white\">{selectedResult.filename}</h3>\n                  </div>\n                  <button\n                    onClick={() => setSelectedResult(null)}\n                    className=\"w-8 h-8 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 text-white text-xl transition-colors\"\n                  >\n                    ×\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"p-6 overflow-y-auto max-h-[60vh]\">\n                <div className=\"grid grid-cols-2 gap-4 mb-6\">\n                  <div>\n                    <label className=\"block text-gray-400 text-sm mb-1\">File Path</label>\n                    <p className=\"text-white text-sm font-mono\">{selectedResult.file}</p>\n                  </div>\n                  <div>\n                    <label className=\"block text-gray-400 text-sm mb-1\">Word Count</label>\n                    <p className=\"text-white\">{selectedResult.word_count.toLocaleString()}</p>\n                  </div>\n                  <div>\n                    <label className=\"block text-gray-400 text-sm mb-1\">Search Score</label>\n                    <p className=\"text-cyan-400 font-medium\">{selectedResult.score}</p>\n                  </div>\n                  <div>\n                    <label className=\"block text-gray-400 text-sm mb-1\">Category</label>\n                    <p className=\"text-white\">{selectedResult.category}</p>\n                  </div>\n                </div>\n\n                {selectedResult.entities.length > 0 && (\n                  <div className=\"mb-6\">\n                    <label className=\"block text-gray-400 text-sm mb-2\">Entities Mentioned</label>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {selectedResult.entities.map((entity, idx) => (\n                        <span\n                          key={idx}\n                          className=\"px-3 py-1 bg-gray-700 text-gray-300 rounded-full text-sm\"\n                        >\n                          {entity}\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {selectedResult.dates.length > 0 && (\n                  <div className=\"mb-6\">\n                    <label className=\"block text-gray-400 text-sm mb-2\">Dates Mentioned</label>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {selectedResult.dates.map((date, idx) => (\n                        <span\n                          key={idx}\n                          className=\"px-3 py-1 bg-gray-700 text-gray-300 rounded-full text-sm flex items-center space-x-2\"\n                        >\n                          <Calendar className=\"h-3 w-3\" />\n                          <span>{date}</span>\n                        </span>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {selectedResult.highlights.length > 0 && (\n                  <div>\n                    <label className=\"block text-gray-400 text-sm mb-2\">Search Highlights</label>\n                    <div className=\"space-y-2\">\n                      {selectedResult.highlights.map((highlight, idx) => (\n                        <div key={idx} className=\"p-3 bg-gray-900 rounded-lg\">\n                          <p className=\"text-cyan-300 text-sm\">{highlight}</p>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"p-6 border-t border-gray-700 flex justify-end space-x-3\">\n                <button\n                  onClick={() => setSelectedResult(null)}\n                  className=\"px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white transition-colors\"\n                >\n                  Close\n                </button>\n                <button\n                  onClick={() => {\n                    // Handle file preview\n                  }}\n                  className=\"px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg text-white transition-colors flex items-center space-x-2\"\n                >\n                  <Eye className=\"h-4 w-4\" />\n                  <span>View File</span>\n                </button>\n              </div>\n            </div>\n          </div>,\n          document.body,\n        )}\n    </div>\n  );\n};\n\nexport default GlobalSearch;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/HelpText.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/HighlightNavigationControls.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/HypothesisTestingFramework.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'hypotheses.length', 'initialHypothesis', and 'onHypothesesUpdate'. Either include them or remove the dependency array. If 'onHypothesesUpdate' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":122,"column":6,"nodeType":"ArrayExpression","endLine":122,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [hypotheses.length, initialHypothesis, investigationId, onHypothesesUpdate]","fix":{"range":[4023,4040],"text":"[hypotheses.length, initialHypothesis, investigationId, onHypothesesUpdate]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport { Target, Plus, Edit3, Trash2, Link, User, FileText } from 'lucide-react';\nimport { EvidenceItem, Hypothesis as BaseHypothesis } from '../types/investigation';\n\n// Extended Hypothesis type with additional fields for testing\n// Extended Hypothesis type with additional fields for testing\ninterface Hypothesis extends Omit<BaseHypothesis, 'status'> {\n  status: 'draft' | 'testing' | 'supported' | 'refuted' | 'revised' | BaseHypothesis['status'];\n  evidenceLinks: EvidenceLink[];\n  revisions: HypothesisRevision[];\n  updatedAt: Date;\n}\n\ninterface EvidenceLink {\n  id: string;\n  evidenceId: string;\n  hypothesisId: string;\n  relevance: 'supporting' | 'contradicting' | 'neutral';\n  weight: number; // 1-10\n  notes: string;\n  createdAt: Date;\n}\n\ninterface HypothesisRevision {\n  id: string;\n  hypothesisId: string;\n  title: string;\n  description: string;\n  confidence: number;\n  reason: string;\n  createdAt: Date;\n  createdBy: string;\n}\n\ninterface HypothesisTestingFrameworkProps {\n  investigationId: string;\n  initialHypothesis?: string;\n  evidenceItems: EvidenceItem[];\n  onHypothesesUpdate: (hypotheses: Hypothesis[]) => void;\n}\n\nexport const HypothesisTestingFramework: React.FC<HypothesisTestingFrameworkProps> = ({\n  investigationId,\n  initialHypothesis = '',\n  evidenceItems,\n  onHypothesesUpdate,\n}) => {\n  const [hypotheses, setHypotheses] = useState<Hypothesis[]>([]);\n  const [activeHypothesis, setActiveHypothesis] = useState<Hypothesis | null>(null);\n  const [showNewForm, setShowNewForm] = useState(false);\n  const [newHypothesis, setNewHypothesis] = useState({\n    title: '',\n    description: '',\n  });\n  const [linkingEvidence, setLinkingEvidence] = useState<{ [key: string]: boolean }>({});\n  const [linkData, setLinkData] = useState({\n    evidenceId: '',\n    relevance: 'supporting' as 'supporting' | 'contradicting' | 'neutral',\n    weight: 5,\n    notes: '',\n  });\n\n  // Fetch hypotheses from API on mount\n  useEffect(() => {\n    const fetchHypotheses = async () => {\n      try {\n        const response = await fetch(`/api/investigations/${investigationId}/hypotheses`);\n        if (response.ok) {\n          const data = await response.json();\n          if (data && data.length > 0) {\n            const loadedHypotheses: Hypothesis[] = data.map((h: any) => ({\n              id: `hyp-${h.id}`,\n              investigationId,\n              title: h.title,\n              description: h.description || '',\n              status: (h.status || 'proposed') as Hypothesis['status'],\n              confidence: h.confidence || 50,\n              createdAt: new Date(h.created_at || Date.now()),\n              updatedAt: new Date(h.updated_at || Date.now()),\n              createdBy: 'System',\n              evidenceLinks: [],\n              revisions: [],\n              evidence: [],\n              relatedHypotheses: [],\n            }));\n            setHypotheses(loadedHypotheses);\n            setActiveHypothesis(loadedHypotheses[0]);\n            onHypothesesUpdate(loadedHypotheses);\n            return;\n          }\n        }\n      } catch (error) {\n        console.error('Error fetching hypotheses:', error);\n      }\n\n      // Fallback: If no hypotheses from API and we have an initialHypothesis, create one\n      if (initialHypothesis && hypotheses.length === 0) {\n        const defaultHypothesis: Hypothesis = {\n          id: 'hyp-1',\n          investigationId,\n          title: 'Initial Investigation Hypothesis',\n          description: initialHypothesis,\n          status: 'testing',\n          confidence: 50,\n          createdAt: new Date(),\n          updatedAt: new Date(),\n          createdBy: 'CurrentUser',\n          evidenceLinks: [],\n          revisions: [],\n          evidence: [],\n          relatedHypotheses: [],\n        };\n        setHypotheses([defaultHypothesis]);\n        setActiveHypothesis(defaultHypothesis);\n        onHypothesesUpdate([defaultHypothesis]);\n      }\n    };\n\n    if (investigationId) {\n      fetchHypotheses();\n    }\n  }, [investigationId]);\n\n  const createHypothesis = () => {\n    if (!newHypothesis.title.trim()) return;\n\n    const hypothesis: Hypothesis = {\n      id: `hyp-${Date.now()}`,\n      investigationId,\n      title: newHypothesis.title,\n      description: newHypothesis.description,\n      status: 'draft',\n      confidence: 50,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n      createdBy: 'CurrentUser',\n      evidenceLinks: [],\n      revisions: [],\n      evidence: [],\n      relatedHypotheses: [],\n    };\n\n    const updatedHypotheses = [...hypotheses, hypothesis];\n    setHypotheses(updatedHypotheses);\n    setActiveHypothesis(hypothesis);\n    setShowNewForm(false);\n    setNewHypothesis({ title: '', description: '' });\n    onHypothesesUpdate(updatedHypotheses);\n  };\n\n  const updateHypothesisStatus = (hypothesisId: string, status: Hypothesis['status']) => {\n    const updatedHypotheses = hypotheses.map((hyp) =>\n      hyp.id === hypothesisId ? { ...hyp, status, updatedAt: new Date() } : hyp,\n    );\n    setHypotheses(updatedHypotheses);\n    if (activeHypothesis?.id === hypothesisId) {\n      setActiveHypothesis({ ...activeHypothesis, status, updatedAt: new Date() });\n    }\n    onHypothesesUpdate(updatedHypotheses);\n  };\n\n  const linkEvidenceToHypothesis = (hypothesisId: string) => {\n    if (!linkData.evidenceId) return;\n\n    const evidenceLink: EvidenceLink = {\n      id: `link-${Date.now()}`,\n      evidenceId: linkData.evidenceId,\n      hypothesisId,\n      relevance: linkData.relevance,\n      weight: linkData.weight,\n      notes: linkData.notes,\n      createdAt: new Date(),\n    };\n\n    const updatedHypotheses = hypotheses.map((hyp) =>\n      hyp.id === hypothesisId\n        ? {\n            ...hyp,\n            evidenceLinks: [...hyp.evidenceLinks, evidenceLink],\n            updatedAt: new Date(),\n          }\n        : hyp,\n    );\n\n    setHypotheses(updatedHypotheses);\n    if (activeHypothesis?.id === hypothesisId) {\n      setActiveHypothesis({\n        ...activeHypothesis,\n        evidenceLinks: [...activeHypothesis.evidenceLinks, evidenceLink],\n        updatedAt: new Date(),\n      });\n    }\n    setLinkingEvidence({ ...linkingEvidence, [hypothesisId]: false });\n    setLinkData({\n      evidenceId: '',\n      relevance: 'supporting',\n      weight: 5,\n      notes: '',\n    });\n    onHypothesesUpdate(updatedHypotheses);\n  };\n\n  const unlinkEvidence = (hypothesisId: string, linkId: string) => {\n    const updatedHypotheses = hypotheses.map((hyp) =>\n      hyp.id === hypothesisId\n        ? {\n            ...hyp,\n            evidenceLinks: hyp.evidenceLinks.filter((link) => link.id !== linkId),\n            updatedAt: new Date(),\n          }\n        : hyp,\n    );\n\n    setHypotheses(updatedHypotheses);\n    if (activeHypothesis?.id === hypothesisId) {\n      setActiveHypothesis({\n        ...activeHypothesis,\n        evidenceLinks: activeHypothesis.evidenceLinks.filter((link) => link.id !== linkId),\n        updatedAt: new Date(),\n      });\n    }\n    onHypothesesUpdate(updatedHypotheses);\n  };\n\n  const reviseHypothesis = (\n    hypothesisId: string,\n    revisionData: { title: string; description: string; reason: string },\n  ) => {\n    const hypothesis = hypotheses.find((hyp) => hyp.id === hypothesisId);\n    if (!hypothesis) return;\n\n    const revision: HypothesisRevision = {\n      id: `rev-${Date.now()}`,\n      hypothesisId,\n      title: revisionData.title,\n      description: revisionData.description,\n      confidence: hypothesis.confidence,\n      reason: revisionData.reason,\n      createdAt: new Date(),\n      createdBy: 'CurrentUser',\n    };\n\n    const updatedHypotheses = hypotheses.map((hyp) =>\n      hyp.id === hypothesisId\n        ? {\n            ...hyp,\n            title: revisionData.title,\n            description: revisionData.description,\n            revisions: [...hyp.revisions, revision],\n            updatedAt: new Date(),\n            status: 'revised' as Hypothesis['status'],\n          }\n        : hyp,\n    );\n\n    setHypotheses(updatedHypotheses);\n    if (activeHypothesis?.id === hypothesisId) {\n      setActiveHypothesis({\n        ...activeHypothesis,\n        title: revisionData.title,\n        description: revisionData.description,\n        revisions: [...activeHypothesis.revisions, revision],\n        updatedAt: new Date(),\n        status: 'revised' as Hypothesis['status'],\n      });\n    }\n    onHypothesesUpdate(updatedHypotheses);\n  };\n\n  const getEvidenceItemById = (id: string) => {\n    return evidenceItems.find((item) => item.id === id);\n  };\n\n  return (\n    <div className=\"bg-slate-900 rounded-xl border border-slate-700\">\n      {/* Header */}\n      <div className=\"border-b border-slate-700 p-6\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center space-x-3\">\n            <Target className=\"w-6 h-6 text-blue-400\" />\n            <h2 className=\"text-2xl font-bold text-white\">Hypothesis Testing Framework</h2>\n          </div>\n          <button\n            onClick={() => setShowNewForm(true)}\n            className=\"flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\n          >\n            <Plus className=\"w-4 h-4\" />\n            <span className=\"hidden sm:inline\">New Hypothesis</span>\n            <span className=\"sm:hidden\">New</span>\n          </button>\n        </div>\n        <p className=\"text-slate-400 mt-2\">\n          Systematic hypothesis testing with evidence linking, confidence scoring, and revision\n          tracking\n        </p>\n      </div>\n\n      {/* New Hypothesis Form */}\n      {showNewForm && (\n        <div className=\"border-b border-slate-700 p-6 bg-slate-800/50\">\n          <h3 className=\"text-lg font-semibold text-white mb-4\">Create New Hypothesis</h3>\n          <div className=\"space-y-4\">\n            <div>\n              <label className=\"block text-sm font-medium text-slate-300 mb-1\">Title</label>\n              <input\n                type=\"text\"\n                value={newHypothesis.title}\n                onChange={(e) => setNewHypothesis({ ...newHypothesis, title: e.target.value })}\n                className=\"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white\"\n                placeholder=\"Enter hypothesis title\"\n              />\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium text-slate-300 mb-1\">Description</label>\n              <textarea\n                value={newHypothesis.description}\n                onChange={(e) =>\n                  setNewHypothesis({ ...newHypothesis, description: e.target.value })\n                }\n                className=\"w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white\"\n                rows={3}\n                placeholder=\"Describe your hypothesis\"\n              />\n            </div>\n            <div className=\"flex justify-end space-x-3\">\n              <button\n                onClick={() => setShowNewForm(false)}\n                className=\"px-4 py-2 text-sm font-medium text-slate-300 bg-slate-700 rounded-lg hover:bg-slate-600 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={createHypothesis}\n                className=\"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors\"\n              >\n                Create Hypothesis\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Hypotheses List */}\n      <div className=\"p-6\">\n        {hypotheses.length === 0 ? (\n          <div className=\"text-center py-12\">\n            <Target className=\"w-12 h-12 text-slate-500 mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium text-white mb-2\">No hypotheses yet</h3>\n            <p className=\"text-slate-400 mb-4\">Create your first hypothesis to begin testing</p>\n            <button\n              onClick={() => setShowNewForm(true)}\n              className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\n            >\n              Create Hypothesis\n            </button>\n          </div>\n        ) : (\n          <div className=\"space-y-6\">\n            {hypotheses.map((hypothesis) => (\n              <div\n                key={hypothesis.id}\n                className={`border rounded-xl p-5 transition-all ${\n                  activeHypothesis?.id === hypothesis.id\n                    ? 'border-blue-500 bg-blue-900/20'\n                    : 'border-slate-700 bg-slate-800/50 hover:bg-slate-800'\n                }`}\n              >\n                <div\n                  className=\"cursor-pointer\"\n                  onClick={() =>\n                    setActiveHypothesis(activeHypothesis?.id === hypothesis.id ? null : hypothesis)\n                  }\n                >\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center space-x-3 mb-2\">\n                        <h3 className=\"text-lg font-semibold text-white truncate\">\n                          {hypothesis.title}\n                        </h3>\n                        <span\n                          className={`px-2 py-1 text-xs rounded-full ${\n                            hypothesis.status === 'draft'\n                              ? 'bg-gray-700 text-gray-300'\n                              : hypothesis.status === 'testing'\n                                ? 'bg-blue-900 text-blue-300'\n                                : hypothesis.status === 'supported'\n                                  ? 'bg-green-900 text-green-300'\n                                  : hypothesis.status === 'refuted'\n                                    ? 'bg-red-900 text-red-300'\n                                    : 'bg-yellow-900 text-yellow-300'\n                          }`}\n                        >\n                          {hypothesis.status}\n                        </span>\n                      </div>\n                      <p className=\"text-slate-300 text-sm mb-3 break-words\">\n                        {hypothesis.description}\n                      </p>\n\n                      {/* Confidence Meter */}\n                      <div className=\"flex items-center space-x-3 mb-3\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex justify-between text-xs text-slate-400 mb-1\">\n                            <span>Confidence</span>\n                            <span>{hypothesis.confidence}%</span>\n                          </div>\n                          <div className=\"w-full bg-slate-700 rounded-full h-2\">\n                            <div\n                              className={`h-2 rounded-full ${\n                                hypothesis.confidence < 30\n                                  ? 'bg-red-500'\n                                  : hypothesis.confidence < 70\n                                    ? 'bg-yellow-500'\n                                    : 'bg-green-500'\n                              }`}\n                              style={{ width: `${hypothesis.confidence}%` }}\n                            ></div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"flex items-center space-x-2 ml-4\">\n                      <button className=\"p-2 text-slate-400 hover:text-white rounded-lg hover:bg-slate-700\">\n                        <Edit3 className=\"w-4 h-4\" />\n                      </button>\n                      <button className=\"p-2 text-slate-400 hover:text-white rounded-lg hover:bg-slate-700\">\n                        <Trash2 className=\"w-4 h-4\" />\n                      </button>\n                    </div>\n                  </div>\n\n                  <div className=\"flex items-center text-xs text-slate-500 space-x-4\">\n                    <span>Created by {hypothesis.createdBy}</span>\n                    <span>•</span>\n                    <span>{hypothesis.createdAt.toLocaleDateString()}</span>\n                    <span>•</span>\n                    <span>{hypothesis.evidenceLinks.length} evidence items</span>\n                  </div>\n                </div>\n\n                {/* Expanded Details */}\n                {activeHypothesis?.id === hypothesis.id && (\n                  <div className=\"mt-5 pt-5 border-t border-slate-700\">\n                    {/* Evidence Links */}\n                    <div className=\"mb-6\">\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <h4 className=\"text-sm font-medium text-slate-300\">Linked Evidence</h4>\n                        <button\n                          onClick={() =>\n                            setLinkingEvidence({\n                              ...linkingEvidence,\n                              [hypothesis.id]: !linkingEvidence[hypothesis.id],\n                            })\n                          }\n                          className=\"text-xs text-blue-400 hover:text-blue-300 flex items-center\"\n                        >\n                          <Link className=\"w-3 h-3 mr-1\" />\n                          Link Evidence\n                        </button>\n                      </div>\n\n                      {/* Link Evidence Form */}\n                      {linkingEvidence[hypothesis.id] && (\n                        <div className=\"mb-4 p-4 bg-slate-700 rounded-lg\">\n                          <h5 className=\"text-sm font-medium text-white mb-3\">\n                            Link Evidence to Hypothesis\n                          </h5>\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                            <div>\n                              <label className=\"block text-xs text-slate-400 mb-1\">\n                                Evidence Item\n                              </label>\n                              <select\n                                value={linkData.evidenceId}\n                                onChange={(e) =>\n                                  setLinkData({ ...linkData, evidenceId: e.target.value })\n                                }\n                                className=\"w-full px-2 py-1 bg-slate-600 border border-slate-500 rounded text-white text-sm\"\n                              >\n                                <option value=\"\">Select evidence</option>\n                                {evidenceItems.map((item) => (\n                                  <option key={item.id} value={item.id}>\n                                    {item.title}\n                                  </option>\n                                ))}\n                              </select>\n                            </div>\n                            <div>\n                              <label className=\"block text-xs text-slate-400 mb-1\">Relevance</label>\n                              <select\n                                value={linkData.relevance}\n                                onChange={(e) =>\n                                  setLinkData({\n                                    ...linkData,\n                                    relevance: e.target.value as any,\n                                  })\n                                }\n                                className=\"w-full px-2 py-1 bg-slate-600 border border-slate-500 rounded text-white text-sm\"\n                              >\n                                <option value=\"supporting\">Supporting</option>\n                                <option value=\"contradicting\">Contradicting</option>\n                                <option value=\"neutral\">Neutral</option>\n                              </select>\n                            </div>\n                            <div>\n                              <label className=\"block text-xs text-slate-400 mb-1\">\n                                Weight: {linkData.weight}\n                              </label>\n                              <input\n                                type=\"range\"\n                                min=\"1\"\n                                max=\"10\"\n                                value={linkData.weight}\n                                onChange={(e) =>\n                                  setLinkData({\n                                    ...linkData,\n                                    weight: parseInt(e.target.value),\n                                  })\n                                }\n                                className=\"w-full\"\n                              />\n                            </div>\n                            <div>\n                              <label className=\"block text-xs text-slate-400 mb-1\">Notes</label>\n                              <input\n                                type=\"text\"\n                                value={linkData.notes}\n                                onChange={(e) =>\n                                  setLinkData({ ...linkData, notes: e.target.value })\n                                }\n                                className=\"w-full px-2 py-1 bg-slate-600 border border-slate-500 rounded text-white text-sm\"\n                                placeholder=\"Add notes about this link\"\n                              />\n                            </div>\n                          </div>\n                          <div className=\"flex justify-end space-x-2 mt-3\">\n                            <button\n                              onClick={() =>\n                                setLinkingEvidence({\n                                  ...linkingEvidence,\n                                  [hypothesis.id]: false,\n                                })\n                              }\n                              className=\"px-3 py-1 text-xs text-slate-300 bg-slate-600 rounded hover:bg-slate-500\"\n                            >\n                              Cancel\n                            </button>\n                            <button\n                              onClick={() => linkEvidenceToHypothesis(hypothesis.id)}\n                              className=\"px-3 py-1 text-xs text-white bg-blue-600 rounded hover:bg-blue-700\"\n                            >\n                              Link Evidence\n                            </button>\n                          </div>\n                        </div>\n                      )}\n\n                      {/* Evidence List */}\n                      {hypothesis.evidenceLinks.length > 0 ? (\n                        <div className=\"space-y-2\">\n                          {hypothesis.evidenceLinks.map((link) => {\n                            const evidenceItem = getEvidenceItemById(link.evidenceId);\n                            return (\n                              <div\n                                key={link.id}\n                                className=\"flex items-center justify-between p-3 bg-slate-700 rounded-lg\"\n                              >\n                                <div className=\"flex items-center space-x-3\">\n                                  <div\n                                    className={`w-3 h-3 rounded-full ${\n                                      link.relevance === 'supporting'\n                                        ? 'bg-green-500'\n                                        : link.relevance === 'contradicting'\n                                          ? 'bg-red-500'\n                                          : 'bg-gray-500'\n                                    }`}\n                                  ></div>\n                                  <div>\n                                    <div className=\"flex items-center space-x-2\">\n                                      <FileText className=\"w-4 h-4 text-slate-400\" />\n                                      <span className=\"text-sm font-medium text-white truncate\">\n                                        {evidenceItem?.title || 'Unknown Evidence'}\n                                      </span>\n                                      <span\n                                        className={`text-xs px-2 py-0.5 rounded ${\n                                          link.relevance === 'supporting'\n                                            ? 'bg-green-900 text-green-300'\n                                            : link.relevance === 'contradicting'\n                                              ? 'bg-red-900 text-red-300'\n                                              : 'bg-gray-700 text-gray-300'\n                                        }`}\n                                      >\n                                        {link.relevance}\n                                      </span>\n                                    </div>\n                                    {link.notes && (\n                                      <p className=\"text-xs text-slate-400 mt-1\">{link.notes}</p>\n                                    )}\n                                  </div>\n                                </div>\n                                <div className=\"flex items-center space-x-3\">\n                                  <span className=\"text-xs text-slate-400\">\n                                    Weight: {link.weight}\n                                  </span>\n                                  <button\n                                    onClick={() => unlinkEvidence(hypothesis.id, link.id)}\n                                    className=\"text-slate-400 hover:text-red-400\"\n                                  >\n                                    <Trash2 className=\"w-4 h-4\" />\n                                  </button>\n                                </div>\n                              </div>\n                            );\n                          })}\n                        </div>\n                      ) : (\n                        <div className=\"text-center py-4 text-slate-500\">\n                          <p>No evidence linked to this hypothesis yet</p>\n                        </div>\n                      )}\n                    </div>\n\n                    {/* Revision History */}\n                    {hypothesis.revisions.length > 0 && (\n                      <div className=\"mb-6\">\n                        <h4 className=\"text-sm font-medium text-slate-300 mb-3\">\n                          Revision History\n                        </h4>\n                        <div className=\"space-y-3\">\n                          {hypothesis.revisions.map((revision) => (\n                            <div key={revision.id} className=\"p-3 bg-slate-700 rounded-lg\">\n                              <div className=\"flex items-center justify-between mb-2\">\n                                <div className=\"flex items-center space-x-2\">\n                                  <User className=\"w-4 h-4 text-slate-400\" />\n                                  <span className=\"text-sm text-white\">{revision.createdBy}</span>\n                                </div>\n                                <span className=\"text-xs text-slate-500\">\n                                  {revision.createdAt.toLocaleDateString()}\n                                </span>\n                              </div>\n                              <p className=\"text-xs text-slate-400 mb-2\">{revision.reason}</p>\n                              <div className=\"text-sm text-slate-300\">\n                                <p className=\"font-medium truncate\">{revision.title}</p>\n                                <p className=\"mt-1 break-words\">{revision.description}</p>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n\n                    {/* Action Buttons */}\n                    <div className=\"flex flex-wrap gap-2\">\n                      <button\n                        onClick={() =>\n                          updateHypothesisStatus(\n                            hypothesis.id,\n                            hypothesis.status === 'testing' ? 'supported' : 'testing',\n                          )\n                        }\n                        className={`px-3 py-1.5 text-xs rounded-lg ${\n                          hypothesis.status === 'supported'\n                            ? 'bg-green-900 text-green-300 hover:bg-green-800'\n                            : 'bg-green-700 text-white hover:bg-green-600'\n                        }`}\n                      >\n                        {hypothesis.status === 'supported' ? 'Mark as Tested' : 'Mark as Supported'}\n                      </button>\n                      <button\n                        onClick={() =>\n                          updateHypothesisStatus(\n                            hypothesis.id,\n                            hypothesis.status === 'testing' ? 'refuted' : 'testing',\n                          )\n                        }\n                        className={`px-3 py-1.5 text-xs rounded-lg ${\n                          hypothesis.status === 'refuted'\n                            ? 'bg-red-900 text-red-300 hover:bg-red-800'\n                            : 'bg-red-700 text-white hover:bg-red-600'\n                        }`}\n                      >\n                        {hypothesis.status === 'refuted' ? 'Mark as Tested' : 'Mark as Refuted'}\n                      </button>\n                      <button\n                        onClick={() => {\n                          const newTitle = prompt('New hypothesis title:', hypothesis.title);\n                          const newDescription = prompt(\n                            'New hypothesis description:',\n                            hypothesis.description,\n                          );\n                          const reason = prompt('Reason for revision:');\n\n                          if (newTitle && newDescription && reason) {\n                            reviseHypothesis(hypothesis.id, {\n                              title: newTitle,\n                              description: newDescription,\n                              reason,\n                            });\n                          }\n                        }}\n                        className=\"px-3 py-1.5 text-xs bg-yellow-700 text-white rounded-lg hover:bg-yellow-600\"\n                      >\n                        Revise Hypothesis\n                      </button>\n                    </div>\n                  </div>\n                )}\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/Icon.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/InvestigationEvidencePanel.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadEvidenceSummary'. Either include it or remove the dependency array.","line":62,"column":6,"nodeType":"ArrayExpression","endLine":62,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [investigationId, loadEvidenceSummary]","fix":{"range":[1696,1713],"text":"[investigationId, loadEvidenceSummary]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\n// TODO: Add evidence deletion feature - see UNUSED_VARIABLES_RECOMMENDATIONS.md\nimport {\n  FileText,\n  Plus,\n  X,\n  Search,\n  AlertTriangle,\n  FileSearch,\n  User,\n  Calendar,\n  Tag,\n  ExternalLink,\n  Filter,\n  BarChart3,\n} from 'lucide-react';\nimport { ENTITY_CATEGORY_ICONS } from '../config/entityIcons';\n\ninterface Evidence {\n  id: number;\n  evidence_type: string;\n  title: string;\n  description: string;\n  source_path: string;\n  red_flag_rating: number;\n  created_at: string;\n  notes?: string;\n  relevance?: 'high' | 'medium' | 'low';\n  added_at?: string;\n}\n\ninterface Entity {\n  id: number;\n  full_name: string;\n  entity_category: string;\n  evidence_count: number;\n}\n\ninterface InvestigationEvidencePanelProps {\n  investigationId: string;\n  onClose?: () => void;\n}\n\nexport const InvestigationEvidencePanel: React.FC<InvestigationEvidencePanelProps> = ({\n  investigationId,\n  onClose,\n}) => {\n  const [evidence, setEvidence] = useState<Evidence[]>([]);\n  const [entityCoverage, setEntityCoverage] = useState<Entity[]>([]);\n  const [typeBreakdown, setTypeBreakdown] = useState<Record<string, number>>({});\n  const [loading, setLoading] = useState(true);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [filterType, setFilterType] = useState<string>('all');\n  const [filterRelevance, setFilterRelevance] = useState<string>('all');\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [searchResults, setSearchResults] = useState<any[]>([]);\n  const [searchQuery, setSearchQuery] = useState('');\n  const [, setSelectedEvidence] = useState<Evidence | null>(null);\n\n  useEffect(() => {\n    loadEvidenceSummary();\n  }, [investigationId]);\n\n  const loadEvidenceSummary = async () => {\n    setLoading(true);\n    try {\n      const response = await fetch(`/api/investigation/${investigationId}/evidence-summary`);\n      const data = await response.json();\n      setEvidence(data.evidence || []);\n      setEntityCoverage(data.entityCoverage || []);\n      setTypeBreakdown(data.typeBreakdown || {});\n    } catch (error) {\n      console.error('Error loading evidence summary:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const searchEvidence = async () => {\n    if (!searchQuery.trim()) return;\n\n    try {\n      // Search across full dataset - documents, entities, and external sources\n      const [evidenceResponse, documentsResponse, entitiesResponse] = await Promise.all([\n        fetch(`/api/evidence/search?q=${encodeURIComponent(searchQuery)}&limit=20`),\n        fetch(`/api/documents/search?q=${encodeURIComponent(searchQuery)}&limit=20`),\n        fetch(`/api/entities/search?q=${encodeURIComponent(searchQuery)}&limit=20`),\n      ]);\n\n      const [evidenceData, documentsData, entitiesData] = await Promise.all([\n        evidenceResponse.json(),\n        documentsResponse.json(),\n        entitiesResponse.json(),\n      ]);\n\n      // Combine all search results\n      const combinedResults = [\n        ...(evidenceData.results || []).map((item: any) => ({ ...item, source: 'evidence' })),\n        ...(documentsData.results || []).map((item: any) => ({ ...item, source: 'document' })),\n        ...(entitiesData.results || []).map((item: any) => ({ ...item, source: 'entity' })),\n      ];\n\n      setSearchResults(combinedResults);\n    } catch (error) {\n      console.error('Error searching evidence:', error);\n    }\n  };\n\n  const addEvidence = async (evidenceId: number, relevance: 'high' | 'medium' | 'low') => {\n    try {\n      await fetch('/api/investigation/add-evidence', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          investigationId,\n          evidenceId,\n          relevance,\n        }),\n      });\n      loadEvidenceSummary();\n      setShowAddModal(false);\n      setSearchQuery('');\n      setSearchResults([]);\n    } catch (error) {\n      console.error('Error adding evidence:', error);\n    }\n  };\n\n  const filteredEvidence = evidence.filter((e) => {\n    const matchesSearch =\n      !searchTerm ||\n      e.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      e.description?.toLowerCase().includes(searchTerm.toLowerCase());\n    const matchesType = filterType === 'all' || e.evidence_type === filterType;\n    const matchesRelevance = filterRelevance === 'all' || e.relevance === filterRelevance;\n    return matchesSearch && matchesType && matchesRelevance;\n  });\n\n  const getEvidenceTypeLabel = (type: string) => {\n    return type\n      .split('_')\n      .map((w) => w.charAt(0).toUpperCase() + w.slice(1))\n      .join(' ');\n  };\n\n  const getRelevanceBadge = (relevance: string) => {\n    const colors = {\n      high: 'bg-red-100 text-red-800',\n      medium: 'bg-yellow-100 text-yellow-800',\n      low: 'bg-gray-100 text-gray-800',\n    };\n    return colors[relevance as keyof typeof colors] || 'bg-gray-100 text-gray-800';\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-gray-500\">Loading evidence...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-slate-800 rounded-lg shadow-lg border border-slate-700\">\n      {/* Header */}\n      <div className=\"border-b border-slate-700 p-6\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center space-x-3\">\n            <FileSearch className=\"w-6 h-6 text-blue-400\" />\n            <h2 className=\"text-2xl font-bold text-white\">Evidence Collection</h2>\n          </div>\n          {onClose && (\n            <button\n              onClick={onClose}\n              className=\"p-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-colors\"\n            >\n              <X className=\"w-6 h-6\" />\n            </button>\n          )}\n        </div>\n\n        {/* Stats */}\n        <div className=\"grid grid-cols-3 gap-4\">\n          <div className=\"bg-slate-700 p-4 rounded-lg\">\n            <div className=\"text-sm text-slate-300\">Total Evidence</div>\n            <div className=\"text-2xl font-bold text-blue-400\">{evidence.length}</div>\n          </div>\n          <div className=\"bg-slate-700 p-4 rounded-lg\">\n            <div className=\"text-sm text-slate-300\">Entities Covered</div>\n            <div className=\"text-2xl font-bold text-green-400\">{entityCoverage.length}</div>\n          </div>\n          <div className=\"bg-slate-700 p-4 rounded-lg\">\n            <div className=\"text-sm text-slate-300\">Evidence Types</div>\n            <div className=\"text-2xl font-bold text-purple-400\">\n              {Object.keys(typeBreakdown).length}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Type Breakdown Chart */}\n      <div className=\"border-b border-slate-700 p-6\">\n        <div className=\"flex items-center space-x-2 mb-4\">\n          <BarChart3 className=\"w-5 h-5 text-slate-400\" />\n          <h3 className=\"text-lg font-semibold text-white\">Evidence Type Breakdown</h3>\n        </div>\n        <div className=\"space-y-2\">\n          {Object.entries(typeBreakdown)\n            .sort(([, a], [, b]) => b - a)\n            .map(([type, count]) => (\n              <div key={type} className=\"flex items-center justify-between\">\n                <div className=\"flex items-center space-x-2\">\n                  <span className=\"text-sm text-slate-300\">{getEvidenceTypeLabel(type)}</span>\n                </div>\n                <div className=\"flex items-center space-x-3\">\n                  <div className=\"w-48 bg-slate-600 rounded-full h-2\">\n                    <div\n                      className=\"bg-blue-500 h-2 rounded-full\"\n                      style={{ width: `${(count / evidence.length) * 100}%` }}\n                    />\n                  </div>\n                  <span className=\"text-sm font-semibold text-slate-200 w-8 text-right\">\n                    {count}\n                  </span>\n                </div>\n              </div>\n            ))}\n        </div>\n      </div>\n\n      {/* Entity Coverage */}\n      <div className=\"border-b border-slate-700 p-6\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center space-x-2\">\n            <User className=\"w-5 h-5 text-slate-400\" />\n            <h3 className=\"text-lg font-semibold text-white\">Entity Coverage</h3>\n          </div>\n        </div>\n        <div className=\"grid grid-cols-2 gap-3 max-h-48 overflow-y-auto\">\n          {entityCoverage.slice(0, 20).map((entity) => {\n            const IconComponent = (ENTITY_CATEGORY_ICONS as any)[entity.entity_category] || User;\n            return (\n              <div\n                key={entity.id}\n                className=\"flex items-center justify-between p-2 bg-slate-700 rounded\"\n              >\n                <div className=\"flex items-center space-x-2 flex-1 min-w-0\">\n                  <IconComponent className=\"w-4 h-4 text-slate-400 flex-shrink-0\" />\n                  <span className=\"text-sm text-slate-200 truncate\">{entity.full_name}</span>\n                </div>\n                <span className=\"text-xs font-semibold text-blue-400 ml-2\">\n                  {entity.evidence_count}\n                </span>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n\n      {/* Search and Filters */}\n      <div className=\"border-b border-slate-700 p-6\">\n        <div className=\"flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-3 mb-4\">\n          <div className=\"flex-1 relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400\" />\n            <input\n              type=\"text\"\n              placeholder=\"Search evidence...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"w-full pl-10 pr-4 h-10 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-slate-700 text-white\"\n            />\n          </div>\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"flex items-center justify-center space-x-2 px-4 h-10 bg-blue-600 text-white rounded-lg hover:bg-blue-700 w-full md:w-auto whitespace-nowrap\"\n          >\n            <Plus className=\"w-5 h-5\" />\n            <span>Add Evidence</span>\n          </button>\n        </div>\n\n        <div className=\"flex flex-col md:flex-row items-stretch md:items-center space-y-3 md:space-y-0 md:space-x-3\">\n          <div className=\"hidden md:block\">\n            <Filter className=\"w-5 h-5 text-slate-400\" />\n          </div>\n          <div className=\"flex items-center space-x-2 md:hidden mb-1\">\n            <Filter className=\"w-4 h-4 text-slate-400\" />\n            <span className=\"text-sm text-slate-400 font-medium\">Filters</span>\n          </div>\n          <select\n            value={filterType}\n            onChange={(e) => setFilterType(e.target.value)}\n            className=\"border border-slate-600 rounded-lg px-3 h-10 text-sm bg-slate-700 text-white w-full md:w-auto\"\n          >\n            <option value=\"all\">All Types</option>\n            {Object.keys(typeBreakdown).map((type) => (\n              <option key={type} value={type}>\n                {getEvidenceTypeLabel(type)}\n              </option>\n            ))}\n          </select>\n          <select\n            value={filterRelevance}\n            onChange={(e) => setFilterRelevance(e.target.value)}\n            className=\"border border-slate-600 rounded-lg px-3 h-10 text-sm bg-slate-700 text-white w-full md:w-auto\"\n          >\n            <option value=\"all\">All Relevance</option>\n            <option value=\"high\">High Relevance</option>\n            <option value=\"medium\">Medium Relevance</option>\n            <option value=\"low\">Low Relevance</option>\n          </select>\n        </div>\n      </div>\n\n      {/* Evidence List */}\n      <div className=\"p-6 max-h-96 overflow-y-auto\">\n        <div className=\"space-y-3\">\n          {filteredEvidence.map((item) => (\n            <div\n              key={item.id}\n              className=\"border border-slate-700 rounded-lg p-4 hover:bg-slate-700 transition cursor-pointer bg-slate-800\"\n              onClick={() => setSelectedEvidence(item)}\n            >\n              <div className=\"flex items-start justify-between mb-2\">\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center space-x-2 mb-1\">\n                    <FileText className=\"w-4 h-4 text-slate-400\" />\n                    <h4 className=\"font-semibold text-white truncate\">\n                      {item.title || 'Untitled'}\n                    </h4>\n                  </div>\n                  <p className=\"text-sm text-slate-300 line-clamp-2\">{item.description}</p>\n                </div>\n                <div className=\"flex flex-col items-end space-y-1 ml-4\">\n                  {item.relevance && (\n                    <span\n                      className={`text-xs px-2 py-1 rounded ${getRelevanceBadge(item.relevance)}`}\n                    >\n                      {item.relevance}\n                    </span>\n                  )}\n                  {item.red_flag_rating > 0 && (\n                    <div className=\"flex items-center space-x-1\">\n                      <AlertTriangle className=\"w-4 h-4 text-red-500\" />\n                      <span className=\"text-xs font-semibold text-red-400\">\n                        {item.red_flag_rating}\n                      </span>\n                    </div>\n                  )}\n                </div>\n              </div>\n              <div className=\"flex items-center justify-between text-xs text-slate-400\">\n                <div className=\"flex items-center space-x-3\">\n                  <span className=\"flex items-center space-x-1\">\n                    <Tag className=\"w-3 h-3\" />\n                    <span>{getEvidenceTypeLabel(item.evidence_type)}</span>\n                  </span>\n                  <span className=\"flex items-center space-x-1\">\n                    <Calendar className=\"w-3 h-3\" />\n                    <span>{new Date(item.created_at).toLocaleDateString()}</span>\n                  </span>\n                </div>\n                <a\n                  href={`/evidence/${item.id}`}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"flex items-center space-x-1 text-blue-400 hover:text-blue-300\"\n                  onClick={(e) => e.stopPropagation()}\n                >\n                  <span>View</span>\n                  <ExternalLink className=\"w-3 h-3\" />\n                </a>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      {/* Add Evidence Modal */}\n      {showAddModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50\">\n          <div className=\"bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-hidden border border-slate-700\">\n            <div className=\"border-b border-slate-700 p-6\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-xl font-bold text-white\">Add Evidence</h3>\n                <button\n                  onClick={() => setShowAddModal(false)}\n                  className=\"p-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-colors\"\n                >\n                  <X className=\"w-6 h-6\" />\n                </button>\n              </div>\n            </div>\n            <div className=\"p-6\">\n              <div className=\"flex items-center space-x-3 mb-4\">\n                <input\n                  type=\"text\"\n                  placeholder=\"Search evidence database...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  onKeyPress={(e) => e.key === 'Enter' && searchEvidence()}\n                  className=\"flex-1 px-4 py-2 border border-slate-600 rounded-lg bg-slate-700 text-white\"\n                />\n                <button\n                  onClick={searchEvidence}\n                  className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\n                >\n                  Search\n                </button>\n              </div>\n              <div className=\"space-y-2 max-h-96 overflow-y-auto\">\n                {searchResults.map((result) => (\n                  <div\n                    key={`${result.source}-${result.id}`}\n                    className=\"border border-slate-700 rounded-lg p-4 bg-slate-700\"\n                  >\n                    <div className=\"flex items-start justify-between mb-2\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          <span\n                            className={`text-xs px-2 py-1 rounded ${\n                              result.source === 'evidence'\n                                ? 'bg-blue-900 text-blue-200'\n                                : result.source === 'document'\n                                  ? 'bg-green-900 text-green-200'\n                                  : 'bg-purple-900 text-purple-200'\n                            }`}\n                          >\n                            {result.source}\n                          </span>\n                          <h4 className=\"font-semibold text-white truncate\">\n                            {result.title || result.full_name || 'Untitled'}\n                          </h4>\n                        </div>\n                        <p className=\"text-sm text-slate-300 line-clamp-2\">{result.description}</p>\n                        {result.source === 'entity' && (\n                          <p className=\"text-xs text-slate-400 mt-1\">\n                            Category: {result.entity_category}\n                          </p>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-xs text-slate-400\">\n                        {result.source === 'evidence'\n                          ? getEvidenceTypeLabel(result.evidence_type)\n                          : result.source === 'document'\n                            ? 'Document'\n                            : 'Entity'}\n                      </span>\n                      <div className=\"flex items-center space-x-2\">\n                        <button\n                          onClick={() => addEvidence(result.id, 'high')}\n                          className=\"text-xs px-3 py-1 bg-red-900 text-red-200 rounded hover:bg-red-800\"\n                        >\n                          High\n                        </button>\n                        <button\n                          onClick={() => addEvidence(result.id, 'medium')}\n                          className=\"text-xs px-3 py-1 bg-yellow-900 text-yellow-200 rounded hover:bg-yellow-800\"\n                        >\n                          Medium\n                        </button>\n                        <button\n                          onClick={() => addEvidence(result.id, 'low')}\n                          className=\"text-xs px-3 py-1 bg-slate-600 text-slate-200 rounded hover:bg-slate-500\"\n                        >\n                          Low\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/InvestigationExportTools.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/InvestigationOnboarding.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/InvestigationTeamManagement.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'ensureFirstAuthor'. Either include it or remove the dependency array.","line":53,"column":6,"nodeType":"ArrayExpression","endLine":53,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [ensureFirstAuthor]","fix":{"range":[1747,1749],"text":"[ensureFirstAuthor]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\nimport { Investigation, Investigator } from '../types/investigation';\nimport { Users, Mail, UserPlus, Crown, Shield, Building, Eye, User } from 'lucide-react';\nimport { useToasts } from './ToastProvider';\n\ninterface InvestigationTeamManagementProps {\n  investigation: Investigation;\n  currentUser: Investigator;\n  onTeamUpdate: (investigation: Investigation) => void;\n}\n\nexport const InvestigationTeamManagement: React.FC<InvestigationTeamManagementProps> = ({\n  investigation,\n  currentUser,\n  onTeamUpdate,\n}) => {\n  const [showInviteModal, setShowInviteModal] = useState(false);\n  const [inviteEmail, setInviteEmail] = useState('');\n  const [inviteRole, setInviteRole] = useState<'researcher' | 'analyst' | 'reviewer'>('researcher');\n  const [inviteMessage, setInviteMessage] = useState('');\n  const { addToast } = useToasts();\n\n  // Ensure current user is first author if team is empty\n  const ensureFirstAuthor = () => {\n    if (investigation.team.length === 0) {\n      const firstAuthor: Investigator = {\n        id: currentUser.id,\n        name: currentUser.name || 'Unknown Investigator',\n        email: currentUser.email,\n        role: 'lead',\n        permissions: ['read', 'write', 'admin'],\n        joinedAt: new Date(),\n        organization: currentUser.organization,\n        expertise: currentUser.expertise || [],\n        status: 'active',\n      };\n\n      const updatedInvestigation = {\n        ...investigation,\n        team: [firstAuthor],\n        leadInvestigator: currentUser.id,\n      };\n\n      onTeamUpdate(updatedInvestigation);\n      return true;\n    }\n    return false;\n  };\n\n  // Auto-populate first author on component mount\n  React.useEffect(() => {\n    ensureFirstAuthor();\n  }, []);\n\n  // Handle email invitation\n  const handleEmailInvitation = async (\n    email: string,\n    role: 'researcher' | 'analyst' | 'reviewer',\n    message?: string,\n  ) => {\n    try {\n      // Call API to send invitation\n      const response = await fetch('/api/investigations/invite', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          investigationId: investigation.id,\n          email,\n          role,\n          message,\n          invitedBy: currentUser.id,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to send invitation');\n      }\n\n      const result = await response.json();\n\n      // Create a pending member while waiting for acceptance\n      const invitedMember: Investigator = {\n        id: result.invitationId || `invited-${Date.now()}`,\n        name: email.split('@')[0], // Temporary name from email\n        email: email,\n        role: role,\n        permissions: getRolePermissions(role),\n        joinedAt: new Date(),\n        organization: '',\n        expertise: [],\n        status: 'pending',\n      };\n\n      const updatedInvestigation = {\n        ...investigation,\n        team: [...investigation.team, invitedMember],\n      };\n\n      onTeamUpdate(updatedInvestigation);\n\n      return true;\n    } catch (error) {\n      console.error('Error sending invitation:', error);\n      return false;\n    }\n  };\n\n  const handleInviteMember = async () => {\n    if (!inviteEmail.trim()) return;\n\n    // Send email invitation\n    const success = await handleEmailInvitation(inviteEmail, inviteRole, inviteMessage);\n\n    if (success) {\n      // Reset form\n      setInviteEmail('');\n      setInviteRole('researcher');\n      setInviteMessage('');\n      setShowInviteModal(false);\n\n      // Show success message\n      addToast({\n        text: `Invitation sent to ${inviteEmail}. They will be added to the team once they accept.`,\n        type: 'success',\n      });\n    } else {\n      addToast({ text: 'Failed to send invitation. Please try again.', type: 'error' });\n    }\n  };\n\n  const getRolePermissions = (role: string): string[] => {\n    switch (role) {\n      case 'lead':\n        return ['read', 'write', 'admin'];\n      case 'researcher':\n      case 'analyst':\n        return ['read', 'write'];\n      case 'reviewer':\n        return ['read', 'comment'];\n      case 'external':\n        return ['read'];\n      default:\n        return ['read'];\n    }\n  };\n\n  const getRoleIcon = (role: string) => {\n    switch (role) {\n      case 'lead':\n        return Crown;\n      case 'researcher':\n        return User;\n      case 'analyst':\n        return Shield;\n      case 'reviewer':\n        return Eye;\n      default:\n        return User;\n    }\n  };\n\n  const getRoleColor = (role: string) => {\n    switch (role) {\n      case 'lead':\n        return 'text-yellow-400 bg-yellow-900/30';\n      case 'researcher':\n        return 'text-blue-400 bg-blue-900/30';\n      case 'analyst':\n        return 'text-green-400 bg-green-900/30';\n      case 'reviewer':\n        return 'text-purple-400 bg-purple-900/30';\n      default:\n        return 'text-gray-400 bg-gray-900/30';\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h3 className=\"text-xl font-bold text-white\">Investigation Team</h3>\n          <p className=\"text-sm text-slate-400 mt-1\">Manage team members and their permissions</p>\n        </div>\n        <button\n          onClick={() => setShowInviteModal(true)}\n          className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors\"\n        >\n          <UserPlus className=\"w-4 h-4\" />\n          Invite Member\n        </button>\n      </div>\n\n      {/* Team Lead Info */}\n      <div className=\"bg-slate-800/50 border border-slate-700 rounded-xl p-4\">\n        <div className=\"flex items-center gap-3\">\n          <Crown className=\"w-5 h-5 text-yellow-400\" />\n          <div>\n            <p className=\"text-white font-medium\">Lead Investigator</p>\n            <p className=\"text-slate-400 text-sm\">\n              {investigation.team.find((member) => member.id === investigation.leadInvestigator)\n                ?.name || investigation.leadInvestigator}\n            </p>\n          </div>\n        </div>\n      </div>\n\n      {/* Team Members */}\n      <div className=\"space-y-4\">\n        {investigation.team.map((member) => {\n          const RoleIcon = getRoleIcon(member.role);\n          const roleColorClass = getRoleColor(member.role);\n\n          return (\n            <div\n              key={member.id}\n              className=\"flex items-center justify-between p-4 bg-slate-800/50 border border-slate-700 rounded-xl\"\n            >\n              <div className=\"flex items-center gap-4\">\n                <div\n                  className={`w-12 h-12 rounded-full flex items-center justify-center border ${roleColorClass}`}\n                >\n                  <RoleIcon className=\"w-6 h-6\" />\n                </div>\n                <div>\n                  <div className=\"flex items-center gap-2\">\n                    <p className=\"text-lg font-medium text-white\">{member.name}</p>\n                    <span className={`text-xs px-2 py-1 rounded-full ${roleColorClass}`}>\n                      {member.role}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center gap-4 text-sm text-slate-400 mt-1\">\n                    <div className=\"flex items-center gap-1\">\n                      <Mail className=\"w-3 h-3\" />\n                      {member.email}\n                    </div>\n                    {member.organization && (\n                      <div className=\"flex items-center gap-1\">\n                        <Building className=\"w-3 h-3\" />\n                        {member.organization}\n                      </div>\n                    )}\n                  </div>\n                  <p className=\"text-xs text-slate-500 mt-1\">\n                    Joined {member.joinedAt.toLocaleDateString()}\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"text-right\">\n                <div className=\"flex items-center gap-2 text-xs text-slate-400 mb-2\">\n                  {member.permissions.map((permission) => (\n                    <span key={permission} className=\"px-2 py-1 bg-slate-700 rounded\">\n                      {permission}\n                    </span>\n                  ))}\n                </div>\n                {member.role !== 'lead' && (\n                  <div className=\"flex gap-2 mt-2\">\n                    <button className=\"text-xs text-blue-400 hover:text-blue-300\">\n                      Manage Permissions\n                    </button>\n                    {member.status === 'pending' && (\n                      <span className=\"text-xs text-yellow-400\">Pending acceptance</span>\n                    )}\n                  </div>\n                )}\n              </div>\n            </div>\n          );\n        })}\n      </div>\n\n      {/* Invite Modal */}\n      {showInviteModal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n          <div className=\"bg-slate-800 rounded-xl shadow-xl w-full max-w-md\">\n            <div className=\"border-b border-slate-700 p-6\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-xl font-bold text-white\">Invite Team Member</h3>\n                <button\n                  onClick={() => setShowInviteModal(false)}\n                  className=\"text-slate-400 hover:text-slate-200\"\n                >\n                  <Users className=\"w-6 h-6\" />\n                </button>\n              </div>\n            </div>\n\n            <div className=\"p-6 space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n                  Email Address\n                </label>\n                <input\n                  type=\"email\"\n                  value={inviteEmail}\n                  onChange={(e) => setInviteEmail(e.target.value)}\n                  placeholder=\"colleague@example.com\"\n                  className=\"w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-slate-300 mb-2\">Role</label>\n                <select\n                  value={inviteRole}\n                  onChange={(e) => setInviteRole(e.target.value as any)}\n                  className=\"w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                >\n                  <option value=\"researcher\">Researcher</option>\n                  <option value=\"analyst\">Analyst</option>\n                  <option value=\"reviewer\">Reviewer</option>\n                  <option value=\"external\">External Consultant</option>\n                </select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-slate-300 mb-2\">\n                  Message (Optional)\n                </label>\n                <textarea\n                  value={inviteMessage}\n                  onChange={(e) => setInviteMessage(e.target.value)}\n                  placeholder=\"Add a personal message to the invitation...\"\n                  rows={3}\n                  className=\"w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                />\n              </div>\n            </div>\n\n            <div className=\"border-t border-slate-700 p-6 flex justify-end gap-3\">\n              <button\n                onClick={() => setShowInviteModal(false)}\n                className=\"px-4 py-2 text-slate-300 hover:text-white rounded-lg transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleInviteMember}\n                disabled={!inviteEmail.trim()}\n                className=\"px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-lg transition-colors\"\n              >\n                Send Invitation\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/InvestigationTimelineBuilder.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'generateAutoMilestones'. Either include it or remove the dependency array.","line":115,"column":6,"nodeType":"ArrayExpression","endLine":115,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [evidence.length, generateAutoMilestones, hypotheses.length]","fix":{"range":[3598,3634],"text":"[evidence.length, generateAutoMilestones, hypotheses.length]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'events', 'evidence', and 'onEventsUpdate'. Either include them or remove the dependency array. If 'onEventsUpdate' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":150,"column":6,"nodeType":"ArrayExpression","endLine":150,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [events, evidence, evidence.length, onEventsUpdate]","fix":{"range":[4926,4943],"text":"[events, evidence, evidence.length, onEventsUpdate]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'events', 'hypotheses', and 'onEventsUpdate'. Either include them or remove the dependency array. If 'onEventsUpdate' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":184,"column":6,"nodeType":"ArrayExpression","endLine":184,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [events, hypotheses, hypotheses.length, onEventsUpdate]","fix":{"range":[6216,6235],"text":"[events, hypotheses, hypotheses.length, onEventsUpdate]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'groupIndex' is defined but never used. Allowed unused args must match /^_/u.","line":533,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":533,"endColumn":49},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'eventIndex' is defined but never used. Allowed unused args must match /^_/u.","line":545,"column":43,"nodeType":"Identifier","messageId":"unusedVar","endLine":545,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\nimport { TimelineEvent, EvidenceItem, Investigation, Hypothesis } from '../types/investigation';\nimport { format, parseISO, isValid } from 'date-fns';\nimport {\n  ChevronRight,\n  Calendar,\n  Clock,\n  Link2,\n  FileText,\n  Users,\n  MapPin,\n  Plus,\n  Edit2,\n  Trash2,\n  Eye,\n} from 'lucide-react';\n\ninterface TimelineBuilderProps {\n  investigation: Investigation;\n  events: TimelineEvent[];\n  evidence: EvidenceItem[];\n  hypotheses: Hypothesis[];\n  onEventsUpdate: (events: TimelineEvent[]) => void;\n  onSaveEvent?: (event: Partial<TimelineEvent>) => Promise<void>;\n  onDeleteEvent?: (eventId: string) => Promise<void>;\n}\n\ninterface TimelineGroup {\n  startDate: string;\n  events: TimelineEvent[];\n}\n\nexport const InvestigationTimelineBuilder: React.FC<TimelineBuilderProps> = ({\n  investigation,\n  events,\n  evidence,\n  hypotheses,\n  onEventsUpdate,\n  onSaveEvent,\n  onDeleteEvent,\n}) => {\n  const [isAddingEvent, setIsAddingEvent] = useState(false);\n  const [editingEvent, setEditingEvent] = useState<TimelineEvent | null>(null);\n  const [timelineScale, setTimelineScale] = useState<'day' | 'week' | 'month' | 'year'>('day');\n  const [showFilters, setShowFilters] = useState(false);\n  const [filterTypes, setFilterTypes] = useState<string[]>([]);\n  const [draggedEvent, setDraggedEvent] = useState<TimelineEvent | null>(null);\n  const [autoMilestones, setAutoMilestones] = useState<TimelineEvent[]>([]);\n  const timelineRef = useRef<HTMLDivElement>(null);\n\n  const [newEvent, setNewEvent] = useState<Partial<TimelineEvent> & { startDateString: string }>({\n    title: '',\n    description: '',\n    startDateString: new Date().toISOString(),\n    type: 'document',\n    confidence: 80,\n    documents: [],\n    hypothesisIds: [],\n  });\n\n  const eventTypes = [\n    { value: 'document', label: 'Document', icon: FileText, color: 'bg-blue-500' },\n    { value: 'meeting', label: 'Meeting', icon: Users, color: 'bg-green-500' },\n    { value: 'location', label: 'Location', icon: MapPin, color: 'bg-purple-500' },\n    { value: 'communication', label: 'Communication', icon: Link2, color: 'bg-orange-500' },\n    { value: 'hypothesis', label: 'Hypothesis', icon: ChevronRight, color: 'bg-red-500' },\n  ];\n\n  const groupEventsByDate = (events: TimelineEvent[]): TimelineGroup[] => {\n    const groups: { [key: string]: TimelineEvent[] } = {};\n\n    events.forEach((event) => {\n      const eventDate = new Date(event.startDate);\n      let groupKey = '';\n\n      switch (timelineScale) {\n        case 'day':\n          groupKey = format(eventDate, 'yyyy-MM-dd');\n          break;\n        case 'week':\n          groupKey = format(eventDate, 'yyyy-MM-dd'); // First day of week\n          break;\n        case 'month':\n          groupKey = format(eventDate, 'yyyy-MM');\n          break;\n        case 'year':\n          groupKey = format(eventDate, 'yyyy');\n          break;\n      }\n\n      if (!groups[groupKey]) {\n        groups[groupKey] = [];\n      }\n      groups[groupKey].push(event);\n    });\n\n    return Object.keys(groups)\n      .sort()\n      .map((key) => ({\n        startDate: key,\n        events: groups[key].sort(\n          (a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime(),\n        ),\n      }));\n  };\n\n  const filteredEvents =\n    filterTypes.length > 0 ? events.filter((event) => filterTypes.includes(event.type)) : events;\n\n  const timelineGroups = groupEventsByDate([...filteredEvents, ...autoMilestones]);\n\n  // Auto-generate milestones when evidence or hypotheses change\n  useEffect(() => {\n    generateAutoMilestones();\n  }, [evidence.length, hypotheses.length]);\n\n  // Auto-add milestones when evidence items are added\n  useEffect(() => {\n    if (evidence.length > 0) {\n      const latestEvidence = evidence[evidence.length - 1];\n      const evidenceMilestoneExists = events.some(\n        (event) => event.type === 'document' && event.title.includes('New Evidence Added'),\n      );\n\n      if (!evidenceMilestoneExists) {\n        const evidenceMilestone: TimelineEvent = {\n          id: `milestone-evidence-added-${latestEvidence.id}`,\n          title: `New Evidence Added: ${latestEvidence.title}`,\n          description:\n            latestEvidence.description || 'A new piece of evidence was added to the investigation',\n          startDate: new Date(latestEvidence.extractedAt || Date.now()),\n          type: 'document',\n          confidence: latestEvidence.credibility === 'verified' ? 100 : 80,\n          documents: [latestEvidence.id],\n          hypothesisIds: [],\n          createdAt: new Date(),\n          updatedAt: new Date(),\n          layerId: 'auto-milestone',\n          entities: [],\n          evidence: [],\n          importance: 'medium',\n          tags: ['auto-generated', 'evidence-milestone'],\n          sources: [],\n          createdBy: 'system',\n        };\n\n        onEventsUpdate([...events, evidenceMilestone]);\n      }\n    }\n  }, [evidence.length]);\n\n  // Auto-add milestones when hypotheses are created or updated\n  useEffect(() => {\n    if (hypotheses.length > 0) {\n      const latestHypothesis = hypotheses[hypotheses.length - 1];\n      const hypothesisMilestoneExists = events.some(\n        (event) => event.type === 'hypothesis' && event.title.includes(latestHypothesis.title),\n      );\n\n      if (!hypothesisMilestoneExists) {\n        const hypothesisMilestone: TimelineEvent = {\n          id: `milestone-hypothesis-${latestHypothesis.id}`,\n          title: `Hypothesis Created: ${latestHypothesis.title}`,\n          description: latestHypothesis.description || 'A new hypothesis was formulated',\n          startDate: new Date(latestHypothesis.createdAt || Date.now()),\n          type: 'hypothesis',\n          confidence: latestHypothesis.confidence || 50,\n          documents: [],\n          hypothesisIds: [latestHypothesis.id],\n          createdAt: new Date(),\n          updatedAt: new Date(),\n          layerId: 'auto-milestone',\n          entities: [],\n          evidence: [],\n          importance: 'high',\n          tags: ['auto-generated', 'hypothesis-milestone'],\n          sources: [],\n          createdBy: 'system',\n        };\n\n        onEventsUpdate([...events, hypothesisMilestone]);\n      }\n    }\n  }, [hypotheses.length]);\n\n  const handleAddEvent = async () => {\n    if (!newEvent.title || !newEvent.startDateString) return;\n\n    if (onSaveEvent) {\n      await onSaveEvent({\n        title: newEvent.title,\n        description: newEvent.description || '',\n        startDate: new Date(newEvent.startDateString),\n        type: newEvent.type || 'document',\n        confidence: newEvent.confidence || 80,\n        documents: newEvent.documents || [],\n        hypothesisIds: newEvent.hypothesisIds || [],\n        importance: 'medium',\n        tags: [],\n        entities: [],\n      });\n    } else {\n      const event: TimelineEvent = {\n        id: `event-${Date.now()}`,\n        title: newEvent.title,\n        description: newEvent.description || '',\n        startDate: new Date(newEvent.startDateString),\n        type: newEvent.type || 'document',\n        confidence: newEvent.confidence || 80,\n        documents: newEvent.documents || [],\n        hypothesisIds: newEvent.hypothesisIds || [],\n        createdAt: new Date(),\n        updatedAt: new Date(),\n        layerId: 'default',\n        entities: [],\n        evidence: [],\n        importance: 'medium',\n        tags: [],\n        sources: [],\n        createdBy: 'current-user',\n      };\n      onEventsUpdate([...events, event]);\n    }\n\n    setNewEvent({\n      title: '',\n      description: '',\n      startDateString: new Date().toISOString(),\n      type: 'document',\n      confidence: 80,\n      documents: [],\n      hypothesisIds: [],\n    });\n    setIsAddingEvent(false);\n  };\n\n  const handleEditEvent = (event: TimelineEvent) => {\n    setEditingEvent(event);\n    setNewEvent({\n      title: event.title,\n      description: event.description,\n      startDateString: event.startDate.toISOString(),\n      type: event.type,\n      confidence: event.confidence,\n      documents: event.documents,\n      hypothesisIds: event.hypothesisIds,\n    });\n  };\n\n  const handleUpdateEvent = async () => {\n    if (!editingEvent || !newEvent.title || !newEvent.startDateString) return;\n\n    if (onSaveEvent) {\n      await onSaveEvent({\n        id: editingEvent.id,\n        title: newEvent.title,\n        description: newEvent.description || '',\n        startDate: new Date(newEvent.startDateString),\n        type: newEvent.type || 'document',\n        confidence: newEvent.confidence || 80,\n        documents: newEvent.documents || [],\n        hypothesisIds: newEvent.hypothesisIds || [],\n      });\n    } else {\n      const updatedEvent: TimelineEvent = {\n        ...editingEvent,\n        title: newEvent.title,\n        description: newEvent.description || '',\n        startDate: new Date(newEvent.startDateString),\n        type: newEvent.type || 'document',\n        confidence: newEvent.confidence || 80,\n        documents: newEvent.documents || [],\n        hypothesisIds: newEvent.hypothesisIds || [],\n        updatedAt: new Date(),\n      };\n\n      const updatedEvents = events.map((e) => (e.id === editingEvent.id ? updatedEvent : e));\n      onEventsUpdate(updatedEvents);\n    }\n    setEditingEvent(null);\n    setNewEvent({\n      title: '',\n      description: '',\n      startDateString: new Date().toISOString(),\n      type: 'document',\n      confidence: 80,\n      documents: [],\n      hypothesisIds: [],\n    });\n  };\n\n  const handleDeleteEvent = async (eventId: string) => {\n    if (window.confirm('Are you sure you want to delete this timeline event?')) {\n      if (onDeleteEvent) {\n        await onDeleteEvent(eventId);\n      } else {\n        onEventsUpdate(events.filter((e) => e.id !== eventId));\n        // Also remove from auto-milestones if it exists there\n        setAutoMilestones(autoMilestones.filter((m) => m.id !== eventId));\n      }\n    }\n  };\n\n  const generateAutoMilestones = () => {\n    const milestones: TimelineEvent[] = [];\n\n    // Auto-generate investigation milestones based on evidence and patterns\n    if (evidence.length > 0) {\n      // Evidence discovery milestone\n      const earliestEvidence = evidence.reduce((earliest, current) => {\n        const currentDate = new Date(current.extractedAt || Date.now());\n        const earliestDate = new Date(earliest.extractedAt || Date.now());\n        return currentDate < earliestDate ? current : earliest;\n      });\n\n      milestones.push({\n        id: `milestone-evidence-${investigation.id}`,\n        title: 'Evidence Collection Started',\n        description: `Initial evidence discovered: ${earliestEvidence.title}`,\n        startDate: new Date(earliestEvidence.extractedAt || Date.now()),\n        type: 'document',\n        confidence: 100,\n        documents: [earliestEvidence.id],\n        hypothesisIds: [],\n        createdAt: new Date(),\n        updatedAt: new Date(),\n        layerId: 'auto-milestone',\n        entities: [],\n        evidence: [],\n        importance: 'high',\n        tags: ['auto-generated', 'milestone'],\n        sources: [],\n        createdBy: 'system',\n      });\n    }\n\n    // Hypothesis formation milestone\n    if (hypotheses.length > 0) {\n      const primaryHypothesis = hypotheses[0];\n      milestones.push({\n        id: `milestone-hypothesis-${investigation.id}`,\n        title: 'Primary Hypothesis Formed',\n        description:\n          primaryHypothesis.description || 'Initial investigation hypothesis established',\n        startDate: new Date(primaryHypothesis.createdAt || Date.now()),\n        type: 'hypothesis',\n        confidence: primaryHypothesis.confidence || 80,\n        documents: [],\n        hypothesisIds: [primaryHypothesis.id],\n        createdAt: new Date(),\n        updatedAt: new Date(),\n        layerId: 'auto-milestone',\n        entities: [],\n        evidence: [],\n        importance: 'high',\n        tags: ['auto-generated', 'milestone', 'hypothesis'],\n        sources: [],\n        createdBy: 'system',\n      });\n    }\n\n    // Investigation creation milestone\n    milestones.push({\n      id: `milestone-investigation-${investigation.id}`,\n      title: 'Investigation Initiated',\n      description: `Investigation \"${investigation.title}\" created`,\n      startDate: investigation.createdAt,\n      type: 'document',\n      confidence: 100,\n      documents: [],\n      hypothesisIds: [],\n      createdAt: new Date(),\n      updatedAt: new Date(),\n      layerId: 'auto-milestone',\n      entities: [],\n      evidence: [],\n      importance: 'critical',\n      tags: ['auto-generated', 'milestone', 'investigation-start'],\n      sources: [],\n      createdBy: 'system',\n    });\n\n    // Evidence threshold milestones\n    const evidenceThresholds = [5, 10, 25, 50, 100];\n    evidenceThresholds.forEach((threshold) => {\n      if (evidence.length >= threshold) {\n        const thresholdEvidence = evidence[threshold - 1];\n        milestones.push({\n          id: `milestone-evidence-${threshold}-${investigation.id}`,\n          title: `Evidence Milestone: ${threshold} Items`,\n          description: `Investigation reached ${threshold} evidence items`,\n          startDate: new Date(thresholdEvidence.extractedAt || Date.now()),\n          type: 'document',\n          confidence: 90,\n          documents: evidence.slice(0, threshold).map((e) => e.id),\n          hypothesisIds: [],\n          createdAt: new Date(),\n          updatedAt: new Date(),\n          layerId: 'auto-milestone',\n          entities: [],\n          evidence: [],\n          importance: threshold >= 25 ? 'high' : 'medium',\n          tags: ['auto-generated', 'milestone', 'evidence-threshold'],\n          sources: [],\n          createdBy: 'system',\n        });\n      }\n    });\n\n    setAutoMilestones(milestones);\n  };\n\n  const handleDragStart = (event: TimelineEvent) => {\n    setDraggedEvent(event);\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n  };\n\n  const handleDrop = (e: React.DragEvent, targetDate: string) => {\n    e.preventDefault();\n    if (!draggedEvent) return;\n\n    const updatedEvent = { ...draggedEvent, startDate: new Date(targetDate) };\n    const updatedEvents = events.map((ev) => (ev.id === draggedEvent.id ? updatedEvent : ev));\n    onEventsUpdate(updatedEvents);\n    setDraggedEvent(null);\n  };\n\n  const getEventTypeIcon = (type: string) => {\n    const eventType = eventTypes.find((et) => et.value === type);\n    return eventType ? eventType.icon : FileText;\n  };\n\n  const getEventTypeColor = (type: string) => {\n    const eventType = eventTypes.find((et) => et.value === type);\n    return eventType ? eventType.color : 'bg-gray-500';\n  };\n\n  const formatGroupDate = (dateStr: string) => {\n    const date = parseISO(dateStr);\n    if (!isValid(date)) return dateStr;\n\n    switch (timelineScale) {\n      case 'day':\n        return format(date, 'EEEE, MMMM d, yyyy');\n      case 'week':\n        return `Week of ${format(date, 'MMMM d, yyyy')}`;\n      case 'month':\n        return format(date, 'MMMM yyyy');\n      case 'year':\n        return format(date, 'yyyy');\n      default:\n        return dateStr;\n    }\n  };\n\n  return (\n    <div className=\"bg-gray-900 text-gray-100 min-h-screen p-6\">\n      <div className=\"max-w-7xl mx-auto\">\n        {/* Header */}\n        <div className=\"mb-8\">\n          <h1 className=\"text-3xl font-bold text-white mb-2\">Investigation Timeline</h1>\n          <p className=\"text-gray-400\">\n            Build and visualize the chronological sequence of events and evidence\n          </p>\n        </div>\n\n        {/* Controls */}\n        <div className=\"bg-gray-800 rounded-lg p-4 mb-6\">\n          <div className=\"flex flex-wrap items-center gap-4\">\n            <div className=\"flex items-center gap-2\">\n              <Calendar className=\"w-5 h-5 text-gray-400\" />\n              <select\n                value={timelineScale}\n                onChange={(e) => setTimelineScale(e.target.value as any)}\n                className=\"bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white\"\n              >\n                <option value=\"day\">Daily</option>\n                <option value=\"week\">Weekly</option>\n                <option value=\"month\">Monthly</option>\n                <option value=\"year\">Yearly</option>\n              </select>\n            </div>\n\n            <button\n              onClick={() => setShowFilters(!showFilters)}\n              className=\"flex items-center gap-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors\"\n            >\n              <Eye className=\"w-4 h-4\" />\n              Filters\n            </button>\n\n            <button\n              onClick={() => setIsAddingEvent(true)}\n              className=\"flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors\"\n            >\n              <Plus className=\"w-4 h-4\" />\n              Add Event\n            </button>\n          </div>\n\n          {/* Filters */}\n          {showFilters && (\n            <div className=\"mt-4 p-4 bg-gray-700 rounded-lg\">\n              <h3 className=\"text-sm font-semibold text-gray-300 mb-3\">Filter by Event Type</h3>\n              <div className=\"flex flex-wrap gap-2\">\n                {eventTypes.map((type) => (\n                  <label key={type.value} className=\"flex items-center gap-2 cursor-pointer\">\n                    <input\n                      type=\"checkbox\"\n                      checked={filterTypes.includes(type.value)}\n                      onChange={(e) => {\n                        if (e.target.checked) {\n                          setFilterTypes([...filterTypes, type.value]);\n                        } else {\n                          setFilterTypes(filterTypes.filter((t) => t !== type.value));\n                        }\n                      }}\n                      className=\"rounded\"\n                    />\n                    <span className=\"text-sm text-gray-300\">{type.label}</span>\n                  </label>\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Timeline */}\n        <div className=\"space-y-6\" ref={timelineRef}>\n          {timelineGroups.map((group, groupIndex) => (\n            <div key={group.startDate} className=\"relative\">\n              {/* Date Header */}\n              <div className=\"flex items-center mb-4\">\n                <div className=\"bg-red-600 text-white px-4 py-2 rounded-lg font-semibold\">\n                  {formatGroupDate(group.startDate)}\n                </div>\n                <div className=\"flex-1 h-px bg-gray-700 ml-4\"></div>\n              </div>\n\n              {/* Events */}\n              <div className=\"ml-8 space-y-4\">\n                {group.events.map((event, eventIndex) => (\n                  <div\n                    key={event.id}\n                    draggable\n                    onDragStart={() => handleDragStart(event)}\n                    onDragOver={handleDragOver}\n                    onDrop={(e) => handleDrop(e, group.startDate)}\n                    className=\"relative bg-gray-800 rounded-lg p-4 border-l-4 hover:bg-gray-750 transition-colors cursor-move\"\n                    style={{ borderLeftColor: getEventTypeColor(event.type).replace('bg-', '#') }}\n                  >\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <div\n                            className={`w-8 h-8 rounded-full ${getEventTypeColor(event.type)} flex items-center justify-center`}\n                          >\n                            {React.createElement(getEventTypeIcon(event.type), {\n                              className: 'w-4 h-4 text-white',\n                            })}\n                          </div>\n                          <h3 className=\"text-lg font-semibold text-white truncate\">\n                            {event.title}\n                          </h3>\n                          <span className=\"text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded\">\n                            {Math.round(event.confidence)}% confidence\n                          </span>\n                        </div>\n\n                        {event.description && (\n                          <p className=\"text-gray-300 mb-3 ml-11 break-words\">\n                            {event.description}\n                          </p>\n                        )}\n\n                        <div className=\"flex items-center gap-4 text-sm text-gray-400 ml-11\">\n                          <div className=\"flex items-center gap-1\">\n                            <Clock className=\"w-4 h-4\" />\n                            {format(event.startDate, 'HH:mm')}\n                          </div>\n\n                          {event.documents.length > 0 && (\n                            <div className=\"flex items-center gap-1\">\n                              <FileText className=\"w-4 h-4\" />\n                              {event.documents.length} evidence items\n                            </div>\n                          )}\n\n                          {event.hypothesisIds && event.hypothesisIds.length > 0 && (\n                            <div className=\"flex items-center gap-1\">\n                              <Link2 className=\"w-4 h-4\" />\n                              {event.hypothesisIds.length} hypotheses\n                            </div>\n                          )}\n                        </div>\n                      </div>\n\n                      <div className=\"flex items-center gap-2\">\n                        <button\n                          onClick={() => handleEditEvent(event)}\n                          className=\"p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors\"\n                        >\n                          <Edit2 className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => handleDeleteEvent(event.id)}\n                          className=\"p-2 text-gray-400 hover:text-red-400 hover:bg-gray-700 rounded transition-colors\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n          ))}\n        </div>\n\n        {/* Add/Edit Event Modal */}\n        {(isAddingEvent || editingEvent) && (\n          <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n            <div className=\"bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n              <h2 className=\"text-xl font-bold text-white mb-4\">\n                {editingEvent ? 'Edit Timeline Event' : 'Add Timeline Event'}\n              </h2>\n\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">Title *</label>\n                  <input\n                    type=\"text\"\n                    value={newEvent.title || ''}\n                    onChange={(e) => setNewEvent({ ...newEvent, title: e.target.value })}\n                    className=\"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white\"\n                    placeholder=\"Enter event title\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Description\n                  </label>\n                  <textarea\n                    value={newEvent.description || ''}\n                    onChange={(e) => setNewEvent({ ...newEvent, description: e.target.value })}\n                    className=\"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white h-20\"\n                    placeholder=\"Enter event description\"\n                  />\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                      Date & Time *\n                    </label>\n                    <input\n                      type=\"datetime-local\"\n                      value={\n                        newEvent.startDateString\n                          ? format(parseISO(newEvent.startDateString), \"yyyy-MM-dd'T'HH:mm\")\n                          : ''\n                      }\n                      onChange={(e) =>\n                        setNewEvent({\n                          ...newEvent,\n                          startDateString: new Date(e.target.value).toISOString(),\n                        })\n                      }\n                      className=\"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white\"\n                    />\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                      Event Type\n                    </label>\n                    <select\n                      value={newEvent.type || 'document'}\n                      onChange={(e) =>\n                        setNewEvent({ ...newEvent, type: e.target.value as TimelineEvent['type'] })\n                      }\n                      className=\"w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white\"\n                    >\n                      {eventTypes.map((type) => (\n                        <option key={type.value} value={type.value}>\n                          {type.label}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Confidence Level\n                  </label>\n                  <div className=\"flex items-center gap-4\">\n                    <input\n                      type=\"range\"\n                      min=\"0\"\n                      max=\"100\"\n                      value={newEvent.confidence || 80}\n                      onChange={(e) =>\n                        setNewEvent({ ...newEvent, confidence: parseInt(e.target.value) })\n                      }\n                      className=\"flex-1\"\n                    />\n                    <span className=\"text-white font-medium w-12 text-right\">\n                      {newEvent.confidence || 80}%\n                    </span>\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Linked Evidence\n                  </label>\n                  <div className=\"space-y-2 max-h-32 overflow-y-auto\">\n                    {evidence.map((ev) => (\n                      <label key={ev.id} className=\"flex items-center gap-2 cursor-pointer\">\n                        <input\n                          type=\"checkbox\"\n                          checked={newEvent.documents?.includes(ev.id) || false}\n                          onChange={(e) => {\n                            const documents = newEvent.documents || [];\n                            if (e.target.checked) {\n                              setNewEvent({ ...newEvent, documents: [...documents, ev.id] });\n                            } else {\n                              setNewEvent({\n                                ...newEvent,\n                                documents: documents.filter((id) => id !== ev.id),\n                              });\n                            }\n                          }}\n                          className=\"rounded\"\n                        />\n                        <span className=\"text-sm text-gray-300 truncate\">{ev.title}</span>\n                      </label>\n                    ))}\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Linked Hypotheses\n                  </label>\n                  <div className=\"space-y-2 max-h-32 overflow-y-auto\">\n                    {hypotheses.map((hyp) => (\n                      <label key={hyp.id} className=\"flex items-center gap-2 cursor-pointer\">\n                        <input\n                          type=\"checkbox\"\n                          checked={newEvent.hypothesisIds?.includes(hyp.id) || false}\n                          onChange={(e) => {\n                            const hypothesisIds = newEvent.hypothesisIds || [];\n                            if (e.target.checked) {\n                              setNewEvent({\n                                ...newEvent,\n                                hypothesisIds: [...hypothesisIds, hyp.id],\n                              });\n                            } else {\n                              setNewEvent({\n                                ...newEvent,\n                                hypothesisIds: hypothesisIds.filter((id: string) => id !== hyp.id),\n                              });\n                            }\n                          }}\n                          className=\"rounded\"\n                        />\n                        <span className=\"text-sm text-gray-300 truncate\">{hyp.title}</span>\n                      </label>\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex justify-end gap-3 mt-6\">\n                <button\n                  onClick={() => {\n                    setIsAddingEvent(false);\n                    setEditingEvent(null);\n                    setNewEvent({\n                      title: '',\n                      description: '',\n                      startDateString: new Date().toISOString(),\n                      type: 'document',\n                      confidence: 80,\n                      documents: [],\n                      hypothesisIds: [],\n                    });\n                  }}\n                  className=\"px-4 py-2 text-gray-300 hover:text-white transition-colors\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={editingEvent ? handleUpdateEvent : handleAddEvent}\n                  className=\"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors\"\n                >\n                  {editingEvent ? 'Update Event' : 'Add Event'}\n                </button>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/InvestigationWorkspace.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'EvidenceChainService' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":30,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"EvidenceChainService"},"fix":{"range":[174,246],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setAnnotations' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":77,"column":23,"nodeType":"Identifier","messageId":"unusedVar","endLine":77,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'evidenceLoading' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":78,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":78,"endColumn":25},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'investigations' and 'navigateToTab'. Either include them or remove the dependency array. You can also replace multiple useState variables with useReducer if 'setSelectedInvestigation' needs the current value of 'investigations'.","line":209,"column":6,"nodeType":"ArrayExpression","endLine":209,"endColumn":69,"suggestions":[{"desc":"Update the dependencies array to be: [location.search, investigations.length, selectedInvestigation, investigations, navigateToTab]","fix":{"range":[7463,7526],"text":"[location.search, investigations.length, selectedInvestigation, investigations, navigateToTab]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'addToast'. Either include it or remove the dependency array.","line":277,"column":6,"nodeType":"ArrayExpression","endLine":277,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [addToast, selectedInvestigation]","fix":{"range":[10349,10372],"text":"[addToast, selectedInvestigation]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedInvestigation'. Either include it or remove the dependency array.","line":315,"column":6,"nodeType":"ArrayExpression","endLine":315,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [selectedInvestigation, selectedInvestigation.id]","fix":{"range":[11527,11554],"text":"[selectedInvestigation, selectedInvestigation.id]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadInvestigation'. Either include it or remove the dependency array.","line":321,"column":6,"nodeType":"ArrayExpression","endLine":321,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [investigationId, loadInvestigation]","fix":{"range":[11658,11675],"text":"[investigationId, loadInvestigation]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'relError' is defined but never used. Allowed unused caught errors must match /^_/u.","line":420,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":420,"endColumn":28},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedInvestigation'. Either include it or remove the dependency array.","line":448,"column":6,"nodeType":"ArrayExpression","endLine":448,"endColumn":66,"suggestions":[{"desc":"Update the dependencies array to be: [selectedInvestigation.id, evidenceItems, useGlobalContext, selectedInvestigation]","fix":{"range":[16344,16404],"text":"[selectedInvestigation.id, evidenceItems, useGlobalContext, selectedInvestigation]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport {\n  Investigation,\n  EvidenceItem,\n  TimelineEvent,\n  Annotation,\n  Investigator,\n} from '../types/investigation';\nimport { EvidenceChainService } from '../services/evidenceChainService';\nimport {\n  Calendar,\n  User,\n  ArrowRight,\n  Search,\n  Download,\n  Plus,\n  Users,\n  Target,\n  FileText,\n  BarChart3,\n  Share2,\n  Microscope,\n  Network,\n  DollarSign,\n  MessageSquare,\n} from 'lucide-react';\nimport FinancialTransactionMapper from './FinancialTransactionMapper';\n// Removed unused ChainOfCustodyModal import\nimport { NetworkVisualization, NetworkNode, NetworkEdge } from './NetworkVisualization';\nimport { InvestigationTimelineBuilder } from './InvestigationTimelineBuilder';\nimport { InvestigationExportTools } from './InvestigationExportTools';\nimport { ForensicAnalysisWorkspace } from './ForensicAnalysisWorkspace';\nimport { useInvestigationOnboarding } from '../hooks/useInvestigationOnboarding';\nimport { InvestigationOnboarding } from './InvestigationOnboarding';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { DataIntegrityPanel } from './DataIntegrityPanel';\nimport { EvidencePacketExporter } from './EvidencePacketExporter';\nimport { InvestigationEvidencePanel } from './InvestigationEvidencePanel';\nimport { EvidenceNotebook } from './EvidenceNotebook';\nimport { HypothesisTestingFramework } from './HypothesisTestingFramework';\nimport { InvestigationTeamManagement } from './InvestigationTeamManagement';\nimport { AddToInvestigationButton } from './AddToInvestigationButton';\nimport { useToasts } from './ToastProvider';\nimport { CreateRelationshipModal } from './CreateRelationshipModal';\nimport { CommunicationAnalysis } from './CommunicationAnalysis';\n\ninterface InvestigationWorkspaceProps {\n  investigationId?: string;\n  onInvestigationSelect?: (investigation: Investigation) => void;\n  currentUser: Investigator;\n}\n\nexport const InvestigationWorkspace: React.FC<InvestigationWorkspaceProps> = ({\n  investigationId,\n  onInvestigationSelect,\n  currentUser,\n}) => {\n  const location = useLocation();\n  const navigate = useNavigate();\n  const { addToast } = useToasts();\n\n  const [investigations, setInvestigations] = useState<Investigation[]>([]);\n  const [selectedInvestigation, setSelectedInvestigation] = useState<Investigation | null>(null);\n  const [isLoading, setIsLoading] = useState(false);\n  const [showNewInvestigationModal, setShowNewInvestigationModal] = useState(false);\n  const [showCreateRelationshipModal, setShowCreateRelationshipModal] = useState(false);\n  const [newInvestigation, setNewInvestigation] = useState({\n    title: '',\n    description: '',\n    hypothesis: '',\n    priority: 'medium' as const,\n    dueDate: '',\n  });\n  const [timelineEvents, setTimelineEvents] = useState<TimelineEvent[]>([]);\n  const [evidenceItems, setEvidenceItems] = useState<EvidenceItem[]>([]);\n  const [hypotheses, setHypotheses] = useState<any[]>([]);\n  const [annotations, setAnnotations] = useState<Annotation[]>([]);\n  const [evidenceLoading, setEvidenceLoading] = useState(false);\n  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);\n  const [selectedNetworkNode, setSelectedNetworkNode] = useState<NetworkNode | null>(null);\n  const [selectedNetworkEdge, setSelectedNetworkEdge] = useState<NetworkEdge | null>(null);\n  const [networkNodes, setNetworkNodes] = useState<NetworkNode[]>([]);\n  const [networkEdges, setNetworkEdges] = useState<NetworkEdge[]>([]);\n  const [dbStats, setDbStats] = useState({\n    totalEntities: 0,\n    totalDocuments: 0,\n    entitiesWithDocuments: 0,\n    documentsWithMetadata: 0,\n  });\n  const [shareCopied, setShareCopied] = useState(false);\n  const [useGlobalContext, setUseGlobalContext] = useState(false);\n\n  // Determine active tab from URL\n  type ActiveTab =\n    | 'overview'\n    | 'evidence'\n    | 'hypotheses'\n    | 'financial'\n    | 'timeline'\n    | 'communications'\n    | 'team'\n    | 'analytics'\n    | 'forensic'\n    | 'export';\n\n  const getActiveTab = (): ActiveTab => {\n    const params = new URLSearchParams(location.search);\n    const tab = params.get('tab') as ActiveTab | null;\n    const did = params.get('docId');\n\n    if (did) return 'forensic'; // Special handling for docId\n    if (\n      tab &&\n      [\n        'overview',\n        'evidence',\n        'hypotheses',\n        'financial',\n        'timeline',\n        'team',\n        'analytics',\n        'forensic',\n        'export',\n      ].includes(tab)\n    ) {\n      return tab;\n    }\n    return 'overview'; // default\n  };\n\n  const activeTab = getActiveTab();\n\n  // Navigate to a tab\n  const navigateToTab = (tab: string) => {\n    const params = new URLSearchParams(location.search);\n    params.set('tab', tab);\n    navigate(`${location.pathname}?${params.toString()}`);\n  };\n\n  // Copy shareable URL to clipboard\n  const copyShareUrl = () => {\n    if (selectedInvestigation) {\n      // Use uuid if available (format: maxwell-epstein-network-001), otherwise use id\n      const shareId = (selectedInvestigation as any).uuid || selectedInvestigation.id;\n      const shareUrl = `${window.location.origin}/investigations/${shareId}`;\n      navigator.clipboard.writeText(shareUrl).then(() => {\n        setShareCopied(true);\n        setTimeout(() => setShareCopied(false), 2000);\n      });\n    }\n  };\n  // Handle special URL parameters (focus on entity)\n  useEffect(() => {\n    try {\n      const params = new URLSearchParams(location.search);\n      const focusId = params.get('focus');\n\n      if (focusId) {\n        // If focusing on an entity, ensure we're on the analytics tab\n        const tab = params.get('tab');\n        if (!tab) {\n          navigateToTab('analytics');\n        }\n\n        // Fetch validity of the ID and get details\n        fetch(`/api/entities/${focusId}`)\n          .then((res) => res.json())\n          .then((entity) => {\n            if (entity && !entity.error) {\n              const node: NetworkNode = {\n                id: String(entity.id),\n                type:\n                  entity.entity_type === 'ORGANIZATION'\n                    ? 'organization'\n                    : entity.entity_type === 'LOCATION'\n                      ? 'location'\n                      : 'person',\n                label: entity.full_name,\n                description: entity.primary_role || entity.title || 'Person of Interest',\n                importance: entity.red_flag_rating || 0,\n                metadata: {\n                  mentions: entity.mentions || 0,\n                  riskLevel:\n                    (entity.red_flag_rating || 0) >= 5\n                      ? 'critical'\n                      : (entity.red_flag_rating || 0) >= 4\n                        ? 'high'\n                        : (entity.red_flag_rating || 0) >= 2\n                          ? 'medium'\n                          : 'low',\n                  category: entity.primary_role || entity.title || 'Person of Interest',\n                  documents: [],\n                  connections: [],\n                },\n              };\n              setSelectedNetworkNode(node);\n            }\n          })\n          .catch((err) => console.error('Error fetching focused entity:', err));\n      }\n\n      // Auto-select first investigation if needed\n      if (!selectedInvestigation && investigations.length > 0) {\n        setSelectedInvestigation(investigations[0]);\n      }\n    } catch (error) {\n      console.error('Error parsing URL parameters:', error);\n    }\n  }, [location.search, investigations.length, selectedInvestigation]);\n\n  // Handle \"Add to Investigation\" custom event\n  useEffect(() => {\n    const handleAddToInvestigation = async (event: CustomEvent) => {\n      const { investigationId, item, relevance } = event.detail;\n\n      // If no investigation ID provided, use the currently selected one if available\n      const targetInvestigationId = investigationId || selectedInvestigation?.id;\n\n      if (!targetInvestigationId) {\n        // Prompt user to select investigation or create new one (could be improved)\n        addToast({ text: 'Please select an investigation first.', type: 'error' });\n        return;\n      }\n\n      try {\n        const response = await fetch(`/api/investigations/${targetInvestigationId}/evidence`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            title: item.title,\n            description: item.description,\n            type: item.type,\n            sourceId: item.sourceId,\n            documentId: item.sourceId, // Assuming sourceId is documentId for documents\n            relevance: relevance || 'high',\n          }),\n        });\n\n        if (response.ok) {\n          // If we are currently viewing this investigation, refresh evidence\n          if (selectedInvestigation?.id === targetInvestigationId) {\n            const ev = await fetch(`/api/investigations/${targetInvestigationId}/evidence`).then(\n              (r) => r.json(),\n            );\n            setEvidenceItems(\n              ev.map((row: any) => ({\n                id: String(row.id),\n                title: row.title,\n                description: row.description || '',\n                type: 'document',\n                sourceId: String(row.document_id || ''),\n                source: '',\n                relevance: row.relevance || 'high',\n                credibility: row.credibility || 'verified',\n                extractedAt: new Date(row.extracted_at),\n                extractedBy: row.extracted_by || 'system',\n              })),\n            );\n            addToast({ text: 'Item added to investigation successfully.', type: 'success' });\n          } else {\n            addToast({ text: 'Item added to investigation successfully.', type: 'success' });\n          }\n        } else {\n          console.error('Failed to add item to investigation');\n          addToast({ text: 'Failed to add item to investigation.', type: 'error' });\n        }\n      } catch (error) {\n        console.error('Error adding to investigation:', error);\n        addToast({ text: 'Error adding item to investigation.', type: 'error' });\n      }\n    };\n\n    window.addEventListener('add-to-investigation' as any, handleAddToInvestigation as any);\n    return () => {\n      window.removeEventListener('add-to-investigation' as any, handleAddToInvestigation as any);\n    };\n  }, [selectedInvestigation]);\n\n  // Investigation onboarding hook\n  const { hasSeenOnboarding, markOnboardingAsSeen } = useInvestigationOnboarding();\n\n  useEffect(() => {\n    loadInvestigations();\n  }, []);\n\n  useEffect(() => {\n    const fetchEvidence = async () => {\n      if (!selectedInvestigation) return;\n      try {\n        setEvidenceLoading(true);\n        const ev = await fetch(`/api/investigations/${selectedInvestigation.id}/evidence`).then(\n          (r) => r.json(),\n        );\n        setEvidenceItems(\n          ev.map((row: any) => ({\n            id: String(row.id),\n            title: row.title,\n            description: row.description || '',\n            type: 'document',\n            sourceId: String(row.document_id || ''),\n            source: '',\n            relevance: row.relevance || 'high',\n            credibility: row.credibility || 'verified',\n            extractedAt: new Date(row.extracted_at),\n            extractedBy: row.extracted_by || 'system',\n          })),\n        );\n      } catch (error) {\n        console.error('Error fetching evidence:', error);\n      } finally {\n        setEvidenceLoading(false);\n      }\n    };\n    fetchEvidence();\n  }, [selectedInvestigation?.id]);\n\n  useEffect(() => {\n    if (investigationId) {\n      loadInvestigation(investigationId);\n    }\n  }, [investigationId]);\n\n  // Fetch real network data and database stats\n  useEffect(() => {\n    const fetchNetworkData = async () => {\n      try {\n        let entities: any[] = [];\n\n        if (useGlobalContext) {\n          // Fetch top global entities\n          const entitiesResp = await fetch(\n            '/api/entities?limit=100&sortBy=red_flag_rating&sortOrder=desc',\n          );\n          const entitiesData = await entitiesResp.json();\n          entities = entitiesData.data || [];\n        } else {\n          // Fetch entities scoped to investigation evidence\n          // Filter evidenceItems for entities\n          const entityEvidence = evidenceItems.filter(\n            (e) => e.type === 'entity' || e.type === 'person' || e.type === 'organization',\n          );\n\n          if (entityEvidence.length > 0) {\n            // Fetch details for each entity\n            const entityPromises = entityEvidence.map((e) =>\n              fetch(`/api/entities/${e.sourceId}`).then((r) => (r.ok ? r.json() : null)),\n            );\n            const results = await Promise.all(entityPromises);\n            entities = results.filter((e) => e !== null);\n          }\n        }\n\n        // Transform entities to network nodes\n        const nodes: NetworkNode[] = entities.map((e: any) => ({\n          id: String(e.id),\n          type:\n            e.entity_type === 'ORGANIZATION'\n              ? 'organization'\n              : e.entity_type === 'LOCATION'\n                ? 'location'\n                : 'person',\n          label: e.full_name,\n          description: e.primary_role || e.title || 'Person of Interest',\n          importance: e.red_flag_rating || 0,\n          metadata: {\n            mentions: e.mentions || 0,\n            riskLevel:\n              (e.red_flag_rating || 0) >= 5\n                ? 'critical'\n                : (e.red_flag_rating || 0) >= 4\n                  ? 'high'\n                  : (e.red_flag_rating || 0) >= 2\n                    ? 'medium'\n                    : 'low',\n            category: e.primary_role || e.title || 'Person of Interest',\n            documents: [],\n            connections: [],\n          },\n        }));\n\n        // Fetch real relationships for nodes\n        const edges: NetworkEdge[] = [];\n        // Limit to top nodes to prevent exploding requests if list is huge\n        const nodeIds = nodes.slice(0, 20).map((n) => n.id);\n\n        for (const entityId of nodeIds) {\n          try {\n            const relResp = await fetch(`/api/relationships?entityId=${entityId}&limit=5`);\n            const relData = await relResp.json();\n            const relationships = relData.relationships || [];\n\n            for (const rel of relationships) {\n              const targetId = String(rel.related_entity_id || rel.entity_id);\n              // Only add edge if target is in our nodes list\n              if (\n                nodes.some((n) => n.id === targetId) &&\n                !edges.some(\n                  (e) =>\n                    (e.source === entityId && e.target === targetId) ||\n                    (e.source === targetId && e.target === entityId),\n                )\n              ) {\n                edges.push({\n                  id: `edge-${entityId}-${targetId}`,\n                  source: entityId,\n                  target: targetId,\n                  type: 'connection',\n                  strength: Math.min(10, rel.weight || rel.strength || 5),\n                  direction: 'bidirectional',\n                  metadata: {\n                    frequency: rel.co_occurrences || rel.frequency || 0,\n                    context: rel.relationship_type || 'Document co-occurrence',\n                    confidence: rel.confidence || 0.8,\n                    dates: [],\n                    evidence: [],\n                  },\n                });\n              }\n            }\n          } catch (relError) {\n            // Skip this entity's relationships on error\n          }\n        }\n\n        setNetworkNodes(nodes);\n        setNetworkEdges(edges);\n\n        // Fetch database stats\n        const statsResp = await fetch('/api/stats');\n        const stats = await statsResp.json();\n        setDbStats({\n          totalEntities: stats.totalEntities || 0,\n          totalDocuments: stats.totalDocuments || 0,\n          entitiesWithDocuments: stats.entitiesWithDocuments || 0,\n          documentsWithMetadata: stats.documentsWithMetadata || 0,\n        });\n      } catch (error) {\n        console.error('Error fetching network data:', error);\n        // Set empty arrays on error - no mock data\n        setNetworkNodes([]);\n        setNetworkEdges([]);\n      }\n    };\n\n    if (selectedInvestigation) {\n      fetchNetworkData();\n    }\n  }, [selectedInvestigation?.id, evidenceItems, useGlobalContext]);\n\n  const loadInvestigations = async () => {\n    setIsLoading(true);\n    try {\n      const resp = await fetch('/api/investigations');\n      const data = await resp.json();\n      const mapped: Investigation[] = (data.data || []).map((inv: any) => ({\n        id: String(inv.id),\n        title: inv.title,\n        description: inv.description || '',\n        hypothesis: inv.scope || '',\n        status:\n          inv.status === 'open'\n            ? 'active'\n            : inv.status === 'in_review'\n              ? 'review'\n              : inv.status === 'closed'\n                ? 'published'\n                : 'archived',\n        createdAt: new Date(inv.created_at),\n        updatedAt: new Date(inv.updated_at),\n        team: inv.team || [\n          {\n            id: inv.owner_id,\n            name: inv.owner_name || 'Investigation Owner',\n            email: inv.owner_email || '',\n            role: 'lead',\n            permissions: ['read', 'write', 'admin'],\n            joinedAt: new Date(inv.created_at),\n            organization: inv.owner_organization || '',\n            expertise: [],\n          },\n        ],\n        leadInvestigator: inv.owner_id,\n        permissions: [],\n        tags: [],\n        priority: 'medium',\n        uuid: inv.uuid, // Include UUID for shareable links\n      }));\n      setInvestigations(mapped);\n    } catch (error) {\n      console.error('Error loading investigations:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const loadInvestigation = async (id: string) => {\n    setIsLoading(true);\n    try {\n      const resp = await fetch(`/api/investigations/${id}`);\n      if (resp.ok) {\n        const inv = await resp.json();\n        const investigation: Investigation = {\n          id: String(inv.id),\n          title: inv.title,\n          description: inv.description || '',\n          hypothesis: inv.scope || '',\n          status:\n            inv.status === 'open'\n              ? 'active'\n              : inv.status === 'in_review'\n                ? 'review'\n                : inv.status === 'closed'\n                  ? 'published'\n                  : 'archived',\n          createdAt: new Date(inv.created_at),\n          updatedAt: new Date(inv.updated_at),\n          team: [\n            {\n              id: inv.owner_id,\n              name: inv.owner_name || 'Investigation Creator',\n              email: inv.owner_email || '',\n              role: 'lead',\n              permissions: ['read', 'write', 'admin'],\n              joinedAt: new Date(inv.created_at),\n              organization: inv.owner_organization || '',\n              expertise: [],\n            },\n          ],\n          leadInvestigator: inv.owner_id,\n          permissions: [],\n          tags: [],\n          priority: 'medium',\n          uuid: inv.uuid, // Include UUID for shareable links\n        } as Investigation & { uuid?: string };\n        setSelectedInvestigation(investigation);\n\n        // Update URL to shareable investigation path\n        const shareId = inv.uuid || inv.id;\n        navigate(`/investigations/${shareId}`, { replace: true });\n\n        // Fetch timeline events\n        try {\n          const timelineResp = await fetch(`/api/investigations/${id}/timeline-events`);\n          if (timelineResp.ok) {\n            const timelineData = await timelineResp.json();\n            const events = timelineData.map((e: any) => ({\n              id: String(e.id),\n              title: e.title,\n              date: e.start_date, // Assuming backend returns start_date\n              description: e.description || '',\n              type: e.type,\n              confidence: e.confidence || 'medium', // Default to medium if not present\n              relatedEntities: JSON.parse(e.entities_json || '[]'),\n              relatedDocuments: JSON.parse(e.documents_json || '[]'),\n            }));\n            setTimelineEvents(events);\n          }\n        } catch (err) {\n          console.error('Error fetching timeline events:', err);\n        }\n\n        if (onInvestigationSelect) onInvestigationSelect(investigation);\n      }\n    } catch (error) {\n      console.error('Error loading investigation:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const createInvestigation = async () => {\n    if (!newInvestigation.title || !newInvestigation.description) {\n      return;\n    }\n\n    setIsLoading(true);\n    try {\n      const resp = await fetch('/api/investigations', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          title: newInvestigation.title,\n          description: newInvestigation.description,\n          ownerId: currentUser.id,\n          scope: newInvestigation.hypothesis,\n        }),\n      });\n      const inv = await resp.json();\n      await loadInvestigations();\n      setSelectedInvestigation({\n        id: String(inv.id),\n        title: inv.title,\n        description: inv.description || '',\n        hypothesis: inv.scope || '',\n        status:\n          inv.status === 'open'\n            ? 'active'\n            : inv.status === 'in_review'\n              ? 'review'\n              : inv.status === 'closed'\n                ? 'published'\n                : 'archived',\n        createdAt: new Date(inv.created_at),\n        updatedAt: new Date(inv.updated_at),\n        team: [\n          {\n            id: currentUser.id,\n            name: currentUser.name || 'Current User',\n            email: currentUser.email || '',\n            role: 'lead',\n            permissions: ['read', 'write', 'admin'],\n            joinedAt: new Date(inv.created_at),\n            organization: currentUser.organization || '',\n            expertise: currentUser.expertise || [],\n            status: 'active',\n          },\n        ],\n        leadInvestigator: currentUser.id,\n        permissions: [],\n        tags: [],\n        priority: 'medium',\n      });\n      setShowNewInvestigationModal(false);\n      setNewInvestigation({\n        title: '',\n        description: '',\n        hypothesis: '',\n        priority: 'medium',\n        dueDate: '',\n      });\n    } catch (error) {\n      console.error('Error creating investigation:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const getStatusColor = (status: Investigation['status']) => {\n    switch (status) {\n      case 'active':\n        return 'bg-green-100 text-green-800';\n      case 'review':\n        return 'bg-yellow-100 text-yellow-800';\n      case 'published':\n        return 'bg-blue-100 text-blue-800';\n      case 'archived':\n        return 'bg-gray-100 text-gray-800';\n      default:\n        return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const getPriorityColor = (priority: Investigation['priority']) => {\n    switch (priority) {\n      case 'critical':\n        return 'bg-red-100 text-red-800';\n      case 'high':\n        return 'bg-orange-100 text-orange-800';\n      case 'medium':\n        return 'bg-yellow-100 text-yellow-800';\n      case 'low':\n        return 'bg-green-100 text-green-800';\n      default:\n        return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const deleteTimelineEvent = async (eventId: string) => {\n    if (!selectedInvestigation) return;\n    try {\n      await fetch(`/api/investigations/${selectedInvestigation.id}/timeline-events/${eventId}`, {\n        method: 'DELETE',\n      });\n      // Refresh\n      const timelineResp = await fetch(\n        `/api/investigations/${selectedInvestigation.id}/timeline-events`,\n      );\n      if (timelineResp.ok) {\n        const timelineData = await timelineResp.json();\n        const events = timelineData.map((e: any) => ({\n          id: String(e.id),\n          title: e.title,\n          startDate: new Date(e.start_date),\n          description: e.description || '',\n          type: e.type,\n          confidence: e.confidence || 80,\n          documents: JSON.parse(e.documents_json || '[]'),\n          hypothesisIds: [], // Add if schema supports\n          entities: JSON.parse(e.entities_json || '[]'),\n          evidence: [],\n          importance: 'medium',\n          tags: [],\n          sources: [],\n          createdBy: 'system',\n          updatedAt: new Date(),\n        }));\n        setTimelineEvents(events);\n      }\n    } catch (e) {\n      console.error('Error deleting event:', e);\n    }\n  };\n\n  const saveTimelineEvent = async (event: Partial<TimelineEvent>) => {\n    if (!selectedInvestigation) return;\n    try {\n      const isNew = !event.id || event.id.startsWith('event-');\n      const url = isNew\n        ? `/api/investigations/${selectedInvestigation.id}/timeline-events`\n        : `/api/investigations/${selectedInvestigation.id}/timeline-events/${event.id}`;\n\n      const method = isNew ? 'POST' : 'PATCH';\n\n      await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          title: event.title,\n          description: event.description,\n          type: event.type,\n          startDate: event.startDate?.toISOString(),\n          confidence: event.confidence,\n          documents: event.documents,\n          entities: event.entities,\n        }),\n      });\n\n      // Refresh\n      const timelineResp = await fetch(\n        `/api/investigations/${selectedInvestigation.id}/timeline-events`,\n      );\n      if (timelineResp.ok) {\n        const timelineData = await timelineResp.json();\n        const events = timelineData.map((e: any) => ({\n          id: String(e.id),\n          title: e.title,\n          startDate: new Date(e.start_date),\n          description: e.description || '',\n          type: e.type,\n          confidence: e.confidence || 80,\n          documents: JSON.parse(e.documents_json || '[]'),\n          hypothesisIds: [],\n          entities: JSON.parse(e.entities_json || '[]'),\n          evidence: [],\n          importance: 'medium',\n          tags: [],\n          sources: [],\n          createdBy: 'system',\n          updatedAt: new Date(),\n        }));\n        setTimelineEvents(events);\n      }\n    } catch (e) {\n      console.error('Error saving event:', e);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"investigation-workspace liquid-glass-workspace rounded-xl h-[calc(100vh-8rem)] flex flex-col phthalo-gradient-bottom\">\n      {/* Investigation Onboarding Overlay */}\n      {!hasSeenOnboarding && !selectedInvestigation && (\n        <InvestigationOnboarding onComplete={markOnboardingAsSeen} onSkip={markOnboardingAsSeen} />\n      )}\n\n      {/* Example Investigation Link - REMOVED per user request */}\n\n      {/* Header */}\n      <div className=\"border-b border-slate-700 px-6 py-4 shrink-0\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h2 className=\"text-xl font-semibold text-white\">Investigation Workspace</h2>\n            <p className=\"text-sm text-slate-400 mt-1\">\n              Collaborative investigation platform for journalists and researchers\n            </p>\n          </div>\n\n          <div className=\"flex items-center gap-4\">\n            {selectedInvestigation && (\n              <div className=\"flex items-center bg-slate-800 rounded-lg p-1 border border-slate-700\">\n                <button\n                  onClick={() => setUseGlobalContext(false)}\n                  className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${\n                    !useGlobalContext\n                      ? 'bg-blue-600 text-white shadow-sm'\n                      : 'text-slate-400 hover:text-white'\n                  }`}\n                >\n                  Investigation Scope\n                </button>\n                <button\n                  onClick={() => setUseGlobalContext(true)}\n                  className={`px-3 py-1 text-xs font-medium rounded-md transition-colors ${\n                    useGlobalContext\n                      ? 'bg-blue-600 text-white shadow-sm'\n                      : 'text-slate-400 hover:text-white'\n                  }`}\n                >\n                  Global Context\n                </button>\n              </div>\n            )}\n\n            <button\n              onClick={() => setShowNewInvestigationModal(true)}\n              className=\"flex items-center justify-center sm:justify-start px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors shadow-lg shadow-blue-900/20 h-10 whitespace-nowrap\"\n            >\n              <Plus className=\"w-5 h-5 sm:w-4 sm:h-4 sm:mr-2 shrink-0\" />\n              <span className=\"hidden sm:inline\">New Investigation</span>\n            </button>\n          </div>\n        </div>\n      </div>\n\n      {/* Investigation List */}\n      {!selectedInvestigation && (\n        <div className=\"p-6 overflow-y-auto flex-1\">\n          {investigations.length === 0 ? (\n            <div className=\"text-center py-12 border border-slate-700 rounded-xl bg-slate-800/30\">\n              <h3 className=\"text-lg font-medium text-white\">No investigations yet</h3>\n              <p className=\"text-slate-400 mt-2\">\n                Create your first investigation to start building evidence.\n              </p>\n              <button\n                onClick={() => setShowNewInvestigationModal(true)}\n                className=\"mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm\"\n              >\n                New Investigation\n              </button>\n            </div>\n          ) : (\n            <div className=\"grid gap-4\">\n              {investigations.map((investigation) => (\n                <div\n                  key={investigation.id}\n                  className=\"liquid-glass-card rounded-xl p-4 cursor-pointer group\"\n                  onClick={() => loadInvestigation(investigation.id)}\n                >\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <h3 className=\"text-lg font-medium text-white group-hover:text-blue-400 transition-colors\">\n                        {investigation.title}\n                      </h3>\n                      <p className=\"text-sm text-slate-400 mt-1\">{investigation.description}</p>\n                      <div className=\"flex items-center gap-2 mt-3\">\n                        <span\n                          className={`px-2 py-1 text-xs font-medium rounded-full ${getStatusColor(investigation.status)}`}\n                        >\n                          {investigation.status}\n                        </span>\n                        <span\n                          className={`px-2 py-1 text-xs font-medium rounded-full ${getPriorityColor(investigation.priority)}`}\n                        >\n                          {investigation.priority} priority\n                        </span>\n                      </div>\n                    </div>\n                    <div className=\"text-right\">\n                      <p className=\"text-xs text-slate-500\">\n                        Created {investigation.createdAt.toLocaleDateString()}\n                      </p>\n                      <p className=\"text-xs text-slate-500 mt-1\">\n                        Lead: {investigation.leadInvestigator}\n                      </p>\n                      {/* Only show delete button for admin/moderator users */}\n                      {currentUser.permissions?.includes('admin') && (\n                        <button\n                          onClick={(e) => {\n                            e.stopPropagation();\n                            if (confirm('Are you sure you want to delete this investigation?')) {\n                              // Call API to delete\n                              fetch(`/api/investigations/${investigation.id}`, {\n                                method: 'DELETE',\n                              }).then(() => loadInvestigations());\n                            }\n                          }}\n                          className=\"mt-2 text-xs text-red-400 hover:text-red-300 hover:underline\"\n                        >\n                          Delete\n                        </button>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Main Layout - Column on mobile, Row on desktop */}\n      {selectedInvestigation && (\n        <div className=\"flex flex-1 overflow-hidden flex-col md:flex-row\">\n          {/* Navigation - Horizontal scroll on mobile, Vertical sidebar on desktop */}\n          <div\n            className={`\n              shrink-0 bg-slate-900/50 backdrop-blur-sm border-b md:border-b-0 md:border-r border-slate-700/50\n              md:transition-all md:duration-300\n              ${sidebarCollapsed ? 'md:w-16' : 'md:w-64'}\n              w-full overflow-x-auto md:overflow-x-visible\n            `}\n          >\n            <div className=\"p-2 md:p-4 flex md:block items-center md:space-y-0 gap-2 md:gap-0\">\n              {/* Desktop Expand/Collapse & Back - Hidden on Mobile */}\n              <div className=\"hidden md:flex items-center justify-between mb-6\">\n                <button\n                  onClick={() => setSelectedInvestigation(null)}\n                  className={`text-sm text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors h-10 px-2 ${sidebarCollapsed ? 'hidden' : ''}`}\n                >\n                  <ArrowRight className=\"w-5 h-5 rotate-180\" />\n                  Back\n                </button>\n                <button\n                  onClick={() => setSidebarCollapsed(!sidebarCollapsed)}\n                  className=\"p-2 text-slate-400 hover:text-white transition-colors rounded-md hover:bg-slate-700\"\n                  title={sidebarCollapsed ? 'Expand menu' : 'Collapse menu'}\n                >\n                  {sidebarCollapsed ? (\n                    <ArrowRight className=\"w-5 h-5\" />\n                  ) : (\n                    <ArrowRight className=\"w-5 h-5 rotate-180\" />\n                  )}\n                </button>\n              </div>\n\n              {/* Desktop Title - Hidden on Mobile */}\n              <div className={`hidden md:block mb-6 px-2 ${sidebarCollapsed ? 'hidden' : ''}`}>\n                <h3 className=\"font-medium text-white truncate\" title={selectedInvestigation.title}>\n                  {selectedInvestigation.title}\n                </h3>\n                <button\n                  onClick={copyShareUrl}\n                  className=\"mt-2 flex items-center gap-1.5 text-xs text-slate-400 hover:text-blue-400 transition-colors\"\n                >\n                  <Share2 className=\"w-3.5 h-3.5\" />\n                  {shareCopied ? 'Copied!' : 'Share'}\n                </button>\n              </div>\n\n              {/* Mobile Back Button */}\n              <button\n                onClick={() => setSelectedInvestigation(null)}\n                className=\"md:hidden p-2 text-slate-400 hover:text-white shrink-0 h-10 w-10 flex items-center justify-center rounded-lg hover:bg-slate-800\"\n              >\n                <ArrowRight className=\"w-5 h-5 rotate-180\" />\n              </button>\n\n              {/* Mobile Navigation - Horizontal Scrollable Pills */}\n              <div className=\"md:hidden w-full overflow-x-auto border-b border-slate-700/50 bg-slate-900/95 no-scrollbar\">\n                <div className=\"flex px-4 py-3 gap-2 min-w-max\">\n                  {[\n                    { id: 'overview', label: 'Overview' },\n                    { id: 'evidence', label: 'Evidence' },\n                    { id: 'hypotheses', label: 'Hypotheses' },\n                    { id: 'notebook', label: 'Notebook' },\n                    { id: 'financial', label: 'Financial' },\n                    { id: 'timeline', label: 'Timeline' },\n                    { id: 'communications', label: 'Communications' },\n                    { id: 'forensic', label: 'Forensic' },\n                    { id: 'team', label: 'Team' },\n                    { id: 'analytics', label: 'Analytics' },\n                    { id: 'export', label: 'Export' },\n                  ].map((option) => (\n                    <button\n                      key={option.id}\n                      onClick={() => navigateToTab(option.id)}\n                      className={`\n                          px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all\n                          ${\n                            activeTab === option.id\n                              ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/30'\n                              : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white border border-slate-700'\n                          }\n                        `}\n                    >\n                      {option.label}\n                    </button>\n                  ))}\n                </div>\n              </div>\n\n              {/* Desktop Navigation Sidebar */}\n              <nav className=\"hidden md:block space-y-1 min-w-max p-1\">\n                {[\n                  { id: 'overview', label: 'Overview', icon: Search },\n                  { id: 'evidence', label: 'Evidence', icon: FileText },\n                  { id: 'hypotheses', label: 'Hypotheses', icon: Target },\n                  { id: 'notebook', label: 'Notebook', icon: FileText },\n                  { id: 'financial', label: 'Financial', icon: DollarSign },\n                  { id: 'timeline', label: 'Timeline', icon: Calendar },\n                  { id: 'communications', label: 'Communications', icon: MessageSquare },\n                  { id: 'forensic', label: 'Forensic', icon: Microscope },\n                  { id: 'team', label: 'Team', icon: Users },\n                  { id: 'analytics', label: 'Analytics', icon: BarChart3 },\n                  { id: 'export', label: 'Export', icon: Download },\n                ].map((tab) => (\n                  <button\n                    key={tab.id}\n                    onClick={() => navigateToTab(tab.id)}\n                    className={`\n                        flex items-center px-3 py-3 text-sm font-medium rounded-lg transition-all\n                        whitespace-nowrap\n                        ${\n                          activeTab === tab.id\n                            ? 'bg-blue-900/40 text-blue-400 border border-blue-500/30 shadow-sm relative z-10'\n                            : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'\n                        }\n                        ${sidebarCollapsed ? 'justify-center px-2 py-4' : 'w-full'}\n                      `}\n                    title={tab.label}\n                  >\n                    <tab.icon\n                      className={`${sidebarCollapsed ? 'w-6 h-6 shrink-0' : 'w-5 h-5 mr-3 shrink-0'}`}\n                    />\n                    <span className={`${sidebarCollapsed ? 'hidden' : 'block'}`}>{tab.label}</span>\n                  </button>\n                ))}\n              </nav>\n            </div>\n          </div>\n\n          {/* Main Content */}\n          <div className=\"flex-1 p-6 overflow-y-auto bg-slate-900\">\n            {activeTab === 'overview' && (\n              <div className=\"max-w-4xl\">\n                <h3 className=\"text-xl font-bold text-white mb-6\">Investigation Overview</h3>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-8\">\n                  <div className=\"bg-slate-800/50 border border-slate-700 rounded-xl p-5\">\n                    <h4 className=\"text-sm font-medium text-slate-400 mb-3 uppercase tracking-wider\">\n                      Hypothesis\n                    </h4>\n                    <p className=\"text-slate-200 leading-relaxed\">\n                      {selectedInvestigation.hypothesis}\n                    </p>\n                  </div>\n\n                  <div className=\"bg-slate-800/50 border border-slate-700 rounded-xl p-5\">\n                    <h4 className=\"text-sm font-medium text-slate-400 mb-3 uppercase tracking-wider\">\n                      Status & Priority\n                    </h4>\n                    <div className=\"space-y-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <span\n                          className={`px-3 py-1 text-sm font-medium rounded-full ${getStatusColor(selectedInvestigation.status)}`}\n                        >\n                          {selectedInvestigation.status}\n                        </span>\n                        <span\n                          className={`px-3 py-1 text-sm font-medium rounded-full ${getPriorityColor(selectedInvestigation.priority)}`}\n                        >\n                          {selectedInvestigation.priority} priority\n                        </span>\n                      </div>\n                      {selectedInvestigation.dueDate && (\n                        <div className=\"flex items-center gap-2 text-slate-400\">\n                          <Calendar className=\"w-4 h-4\" />\n                          <span className=\"text-sm\">\n                            Due: {selectedInvestigation.dueDate.toLocaleDateString()}\n                          </span>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n\n                {/* Data Integrity Panel */}\n                <div className=\"mb-8\">\n                  <DataIntegrityPanel\n                    stats={{\n                      entitiesWithDocuments: dbStats.entitiesWithDocuments,\n                      totalEntities: dbStats.totalEntities,\n                      documentsWithMetadata: dbStats.documentsWithMetadata,\n                      totalDocuments: dbStats.totalDocuments,\n                      lastRefresh: new Date().toISOString().replace('T', ' ').slice(0, 19) + ' UTC',\n                    }}\n                  />\n                </div>\n\n                <div>\n                  <h4 className=\"text-sm font-medium text-slate-400 mb-3 uppercase tracking-wider\">\n                    Recent Activity\n                  </h4>\n                  <div className=\"bg-slate-800/50 border border-slate-700 rounded-xl p-5\">\n                    <div className=\"flex items-start gap-4\">\n                      <div className=\"w-8 h-8 rounded-full bg-blue-900/30 flex items-center justify-center border border-blue-500/30\">\n                        <User className=\"w-4 h-4 text-blue-400\" />\n                      </div>\n                      <div>\n                        <p className=\"text-slate-200 text-sm\">\n                          Investigation created by{' '}\n                          <span className=\"text-white font-medium\">\n                            {selectedInvestigation.leadInvestigator}\n                          </span>\n                        </p>\n                        <p className=\"text-xs text-slate-500 mt-1\">\n                          {selectedInvestigation.createdAt.toLocaleDateString()} at{' '}\n                          {selectedInvestigation.createdAt.toLocaleTimeString()}\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {activeTab === 'evidence' && selectedInvestigation && (\n              <div>\n                <InvestigationEvidencePanel investigationId={selectedInvestigation.id} />\n              </div>\n            )}\n\n            {activeTab === 'hypotheses' && (\n              <HypothesisTestingFramework\n                investigationId={selectedInvestigation.id}\n                initialHypothesis={selectedInvestigation.hypothesis}\n                evidenceItems={evidenceItems}\n                onHypothesesUpdate={setHypotheses}\n              />\n            )}\n            {activeTab === ('notebook' as any) && selectedInvestigation && (\n              <div>\n                <EvidenceNotebook investigationId={Number(selectedInvestigation.id)} />\n              </div>\n            )}\n\n            {activeTab === 'financial' && (\n              <FinancialTransactionMapper\n                investigationId={useGlobalContext ? undefined : selectedInvestigation?.id}\n              />\n            )}\n\n            {activeTab === 'communications' && selectedInvestigation && (\n              <CommunicationAnalysis\n                investigation={selectedInvestigation}\n                evidence={evidenceItems}\n              />\n            )}\n\n            {activeTab === 'timeline' && selectedInvestigation && (\n              <InvestigationTimelineBuilder\n                investigation={selectedInvestigation}\n                events={timelineEvents}\n                evidence={evidenceItems}\n                hypotheses={hypotheses}\n                onEventsUpdate={setTimelineEvents}\n                onSaveEvent={saveTimelineEvent}\n                onDeleteEvent={deleteTimelineEvent}\n              />\n            )}\n\n            {activeTab === 'forensic' && selectedInvestigation && (\n              <ForensicAnalysisWorkspace\n                investigation={selectedInvestigation}\n                evidence={evidenceItems}\n                onEvidenceUpdate={setEvidenceItems}\n                timelineEvents={timelineEvents}\n                useGlobalContext={useGlobalContext}\n              />\n            )}\n\n            {activeTab === 'team' && (\n              <InvestigationTeamManagement\n                investigation={selectedInvestigation}\n                currentUser={currentUser}\n                onTeamUpdate={(updatedInvestigation) => {\n                  setSelectedInvestigation(updatedInvestigation);\n                  // Update the investigations list as well\n                  setInvestigations(\n                    investigations.map((inv) =>\n                      inv.id === updatedInvestigation.id ? updatedInvestigation : inv,\n                    ),\n                  );\n                }}\n              />\n            )}\n\n            {activeTab === 'export' && selectedInvestigation && (\n              <div>\n                <h3 className=\"text-xl font-bold text-white mb-6\">\n                  Export & Publish Investigation\n                </h3>\n\n                <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8\">\n                  <InvestigationExportTools\n                    investigation={selectedInvestigation}\n                    evidence={evidenceItems}\n                    timelineEvents={timelineEvents}\n                    hypotheses={hypotheses}\n                    annotations={annotations}\n                  />\n\n                  <div>\n                    <div className=\"bg-slate-800/50 border border-slate-700 rounded-xl p-6 mb-6\">\n                      <h4 className=\"text-lg font-semibold text-white mb-4\">\n                        Evidence Packet Export\n                      </h4>\n                      <p className=\"text-slate-400 mb-4\">\n                        Export this investigation as a comprehensive evidence packet containing\n                        entities, documents, metadata, and Red Flag Index scores.\n                      </p>\n                      <EvidencePacketExporter\n                        investigationId={selectedInvestigation.id}\n                        investigationTitle={selectedInvestigation.title}\n                        onExport={(format: 'json' | 'zip') => {\n                          console.log(\n                            `Exporting investigation ${selectedInvestigation.id} as ${format}`,\n                          );\n                          // In a real implementation, this would trigger the actual export\n                          addToast({\n                            text: `Exporting investigation as ${format.toUpperCase()} format`,\n                            type: 'info',\n                          });\n                        }}\n                      />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {activeTab === 'analytics' && (\n              <div>\n                <div className=\"flex items-center justify-between mb-6\">\n                  <h3 className=\"text-xl font-bold text-white\">\n                    Investigation Analytics & Network Analysis\n                  </h3>\n                  <button\n                    onClick={() => setShowCreateRelationshipModal(true)}\n                    className=\"flex items-center gap-2 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors text-sm font-medium shadow-lg shadow-purple-500/20\"\n                  >\n                    <Network className=\"w-4 h-4\" />\n                    <span>Add Connection</span>\n                  </button>\n                </div>\n\n                {/* Network Visualization */}\n                <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8\">\n                  <div className=\"lg:col-span-2 liquid-glass-card rounded-xl overflow-hidden\">\n                    <NetworkVisualization\n                      nodes={networkNodes}\n                      edges={networkEdges}\n                      onNodeClick={(node) => {\n                        console.log('Node clicked:', node);\n                        setSelectedNetworkNode(node);\n                        setSelectedNetworkEdge(null);\n                      }}\n                      onEdgeClick={(edge) => {\n                        console.log('Edge clicked:', edge);\n                        setSelectedNetworkEdge(edge);\n                        setSelectedNetworkNode(null);\n                      }}\n                      selectedNodeId={selectedNetworkNode?.id}\n                      selectedEdgeId={selectedNetworkEdge?.id}\n                      height={500}\n                      showFilters={true}\n                      showLegend={true}\n                      interactive={true}\n                    />\n                  </div>\n\n                  {/* Selected Node/Edge Details */}\n                  <div className=\"liquid-glass-card rounded-xl p-6\">\n                    <h4 className=\"text-lg font-semibold text-white mb-4\">\n                      {selectedNetworkNode\n                        ? 'Node Details'\n                        : selectedNetworkEdge\n                          ? 'Connection Details'\n                          : 'Details'}\n                    </h4>\n                    {selectedNetworkNode ? (\n                      <div className=\"space-y-4\">\n                        <div className=\"flex items-start justify-between\">\n                          <div>\n                            <h5 className=\"text-base font-medium text-white\">\n                              {selectedNetworkNode.label}\n                            </h5>\n                            <p className=\"text-sm text-slate-400 capitalize\">\n                              {selectedNetworkNode.type}\n                            </p>\n                          </div>\n                          <AddToInvestigationButton\n                            item={{\n                              id: selectedNetworkNode.id,\n                              title: selectedNetworkNode.label,\n                              description: selectedNetworkNode.description || 'Network entity',\n                              type: 'entity',\n                              sourceId: selectedNetworkNode.id,\n                              metadata: selectedNetworkNode.metadata,\n                            }}\n                            investigations={[]} // This needs to be populated from context or props\n                            onAddToInvestigation={(invId, item, relevance) => {\n                              console.log('Add to investigation', invId, item, relevance);\n                              const event = new CustomEvent('add-to-investigation', {\n                                detail: { investigationId: invId, item, relevance },\n                              });\n                              window.dispatchEvent(event);\n                            }}\n                            variant=\"icon\"\n                            className=\"hover:bg-slate-700\"\n                          />\n                        </div>\n\n                        <p className=\"text-sm text-slate-300\">{selectedNetworkNode.description}</p>\n\n                        <div className=\"space-y-2\">\n                          <div className=\"flex justify-between text-sm\">\n                            <span className=\"text-slate-400\">Risk Level</span>\n                            <span\n                              className={`px-2 py-0.5 rounded text-xs font-medium ${\n                                selectedNetworkNode.metadata.riskLevel === 'critical'\n                                  ? 'bg-red-900 text-red-200'\n                                  : selectedNetworkNode.metadata.riskLevel === 'high'\n                                    ? 'bg-orange-900 text-orange-200'\n                                    : selectedNetworkNode.metadata.riskLevel === 'medium'\n                                      ? 'bg-yellow-900 text-yellow-200'\n                                      : 'bg-green-900 text-green-200'\n                              }`}\n                            >\n                              {(selectedNetworkNode.metadata.riskLevel || 'low').toUpperCase()}\n                            </span>\n                          </div>\n                          <div className=\"flex justify-between text-sm\">\n                            <span className=\"text-slate-400\">Mentions</span>\n                            <span className=\"text-white\">\n                              {selectedNetworkNode.metadata.mentions || 0}\n                            </span>\n                          </div>\n                          <div className=\"flex justify-between text-sm\">\n                            <span className=\"text-slate-400\">Category</span>\n                            <span className=\"text-white\">\n                              {selectedNetworkNode.metadata.category || 'Uncategorized'}\n                            </span>\n                          </div>\n                        </div>\n\n                        {selectedNetworkNode.metadata.documents &&\n                          selectedNetworkNode.metadata.documents.length > 0 && (\n                            <div>\n                              <h6 className=\"text-xs font-medium text-slate-400 uppercase tracking-wider mb-2\">\n                                Related Documents\n                              </h6>\n                              <div className=\"space-y-1\">\n                                {selectedNetworkNode.metadata.documents.map((doc, idx) => (\n                                  <div\n                                    key={idx}\n                                    className=\"flex items-center gap-2 text-sm text-blue-400 hover:text-blue-300 cursor-pointer\"\n                                  >\n                                    <FileText className=\"w-3 h-3\" />\n                                    <span>{doc}</span>\n                                  </div>\n                                ))}\n                              </div>\n                            </div>\n                          )}\n                      </div>\n                    ) : selectedNetworkEdge ? (\n                      <div className=\"space-y-4\">\n                        <div>\n                          <h5 className=\"text-base font-medium text-white capitalize\">\n                            {selectedNetworkEdge.type}\n                          </h5>\n                          <p className=\"text-sm text-slate-400\">\n                            Strength: {selectedNetworkEdge.strength}/10\n                          </p>\n                        </div>\n\n                        <div className=\"space-y-2\">\n                          <div className=\"flex justify-between text-sm\">\n                            <span className=\"text-slate-400\">Confidence</span>\n                            <span className=\"text-white\">\n                              {Math.round((selectedNetworkEdge.metadata.confidence || 0) * 100)}%\n                            </span>\n                          </div>\n                          <div className=\"flex justify-between text-sm\">\n                            <span className=\"text-slate-400\">Evidence Count</span>\n                            <span className=\"text-white\">\n                              {(selectedNetworkEdge.metadata as any).evidence_count || 0}\n                            </span>\n                          </div>\n                          {(selectedNetworkEdge.metadata as any).date_range && (\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-slate-400\">Timeframe</span>\n                              <span className=\"text-white\">\n                                {(selectedNetworkEdge.metadata as any).date_range}\n                              </span>\n                            </div>\n                          )}\n                        </div>\n\n                        {(selectedNetworkEdge.metadata as any).evidence_types &&\n                          (selectedNetworkEdge.metadata as any).evidence_types.length > 0 && (\n                            <div>\n                              <h6 className=\"text-xs font-medium text-slate-400 uppercase tracking-wider mb-2\">\n                                Evidence Types\n                              </h6>\n                              <div className=\"flex flex-wrap gap-2\">\n                                {(selectedNetworkEdge.metadata as any).evidence_types.map(\n                                  (type: string, idx: number) => (\n                                    <span\n                                      key={idx}\n                                      className=\"px-2 py-1 bg-slate-800 rounded text-xs text-slate-300 border border-slate-700\"\n                                    >\n                                      {type}\n                                    </span>\n                                  ),\n                                )}\n                              </div>\n                            </div>\n                          )}\n                      </div>\n                    ) : (\n                      <div className=\"text-center py-8 text-slate-500\">\n                        <Network className=\"w-12 h-12 mx-auto mb-3 opacity-20\" />\n                        <p>Select a node or connection to view details</p>\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* Summary Statistics */}\n                <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                  <div className=\"liquid-glass-card p-4 rounded-xl\">\n                    <h4 className=\"text-sm font-medium text-slate-400 uppercase tracking-wider\">\n                      People Identified\n                    </h4>\n                    <p className=\"text-3xl font-bold text-white mt-2\">\n                      {networkNodes.filter((n) => n.type === 'person').length}\n                    </p>\n                  </div>\n                  <div className=\"liquid-glass-card p-4 rounded-xl\">\n                    <h4 className=\"text-sm font-medium text-slate-400 uppercase tracking-wider\">\n                      Organizations\n                    </h4>\n                    <p className=\"text-3xl font-bold text-white mt-2\">\n                      {networkNodes.filter((n) => n.type === 'organization').length}\n                    </p>\n                  </div>\n                  <div className=\"liquid-glass-card p-4 rounded-xl\">\n                    <h4 className=\"text-sm font-medium text-slate-400 uppercase tracking-wider\">\n                      Key Locations\n                    </h4>\n                    <p className=\"text-3xl font-bold text-white mt-2\">\n                      {networkNodes.filter((n) => n.type === 'location').length}\n                    </p>\n                  </div>\n                  <div className=\"liquid-glass-card p-4 rounded-xl\">\n                    <h4 className=\"text-sm font-medium text-slate-400 uppercase tracking-wider\">\n                      Connections\n                    </h4>\n                    <p className=\"text-3xl font-bold text-white mt-2\">{networkEdges.length}</p>\n                  </div>\n                </div>\n\n                {/* Relationship Legend */}\n                <div className=\"mt-6 liquid-glass-panel p-4 rounded-xl border border-white/5\">\n                  <h4 className=\"text-sm font-medium text-slate-400 uppercase tracking-wider mb-3\">\n                    Connection Types\n                  </h4>\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"w-3 h-3 rounded-full bg-blue-500\"></div>\n                      <div className=\"text-sm\">\n                        <span className=\"text-slate-200 font-medium\">Email</span>\n                        <p className=\"text-slate-500 text-xs\">\n                          Direct communication (From/To/CC) from metadata\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"w-3 h-3 rounded-full bg-purple-500\"></div>\n                      <div className=\"text-sm\">\n                        <span className=\"text-slate-200 font-medium\">Co-occurrence</span>\n                        <p className=\"text-slate-500 text-xs\">\n                          Appearing in the same document (weighted by frequency)\n                        </p>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"w-3 h-3 rounded-full bg-red-500\"></div>\n                      <div className=\"text-sm\">\n                        <span className=\"text-slate-200 font-medium\">Flight Log</span>\n                        <p className=\"text-slate-500 text-xs\">\n                          Appearing on the same flight manifest\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      {/* New Investigation Modal */}\n      {showNewInvestigationModal && (\n        <div className=\"fixed inset-0 bg-black/60 backdrop-blur-md flex items-center justify-center z-50 p-4\">\n          <div className=\"liquid-glass-modal rounded-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto\">\n            <h3 className=\"text-xl font-bold text-white mb-6\">Create New Investigation</h3>\n\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-slate-300 mb-1\">Title *</label>\n                <input\n                  type=\"text\"\n                  name=\"title\"\n                  value={newInvestigation.title}\n                  onChange={(e) =>\n                    setNewInvestigation({ ...newInvestigation, title: e.target.value })\n                  }\n                  className=\"w-full px-3 h-10 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-slate-500\"\n                  placeholder=\"Enter investigation title\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-slate-300 mb-1\">\n                  Description *\n                </label>\n                <textarea\n                  value={newInvestigation.description}\n                  name=\"description\"\n                  onChange={(e) =>\n                    setNewInvestigation({ ...newInvestigation, description: e.target.value })\n                  }\n                  className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-slate-500\"\n                  rows={3}\n                  placeholder=\"Describe the investigation focus\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-slate-300 mb-1\">Hypothesis</label>\n                <textarea\n                  value={newInvestigation.hypothesis}\n                  onChange={(e) =>\n                    setNewInvestigation({ ...newInvestigation, hypothesis: e.target.value })\n                  }\n                  className=\"w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-slate-500\"\n                  rows={2}\n                  placeholder=\"What do you aim to prove or disprove?\"\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-slate-300 mb-1\">Priority</label>\n                  <select\n                    value={newInvestigation.priority}\n                    onChange={(e) =>\n                      setNewInvestigation({ ...newInvestigation, priority: e.target.value as any })\n                    }\n                    className=\"w-full px-3 h-10 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white\"\n                  >\n                    <option value=\"low\">Low</option>\n                    <option value=\"medium\">Medium</option>\n                    <option value=\"high\">High</option>\n                    <option value=\"critical\">Critical</option>\n                  </select>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-slate-300 mb-1\">Due Date</label>\n                  <input\n                    type=\"date\"\n                    value={newInvestigation.dueDate}\n                    onChange={(e) =>\n                      setNewInvestigation({ ...newInvestigation, dueDate: e.target.value })\n                    }\n                    className=\"w-full px-3 h-10 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-3 mt-8\">\n              <button\n                onClick={() => setShowNewInvestigationModal(false)}\n                className=\"px-4 h-10 flex items-center justify-center text-sm font-medium text-slate-300 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={createInvestigation}\n                disabled={!newInvestigation.title || !newInvestigation.description}\n                className=\"px-4 h-10 flex items-center justify-center text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg shadow-blue-900/20\"\n              >\n                Create Investigation\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {showCreateRelationshipModal && (\n        <CreateRelationshipModal\n          onClose={() => setShowCreateRelationshipModal(false)}\n          onSuccess={() => {\n            // Refresh network data logic would go here\n            // Since we use useEffect based on selectedInvestigation, we might need to force a refresh\n            // But for now, user can manually refresh or navigate back/forth\n            // A better way would be to expose a refresh function from the effect\n            // or toggle a version counter\n          }}\n          initialSourceId={selectedNetworkNode?.id}\n        />\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/KeyboardShortcutsModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/Layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/LazyImage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/LoadingIndicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/LoadingPill.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":19,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":19,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, createContext, useContext, useCallback, ReactNode } from 'react';\n\ninterface LoadingTask {\n  id: string;\n  label: string;\n  progress?: number;\n  startTime: number;\n}\n\ninterface LoadingContextType {\n  addTask: (id: string, label: string) => void;\n  updateTask: (id: string, progress: number) => void;\n  removeTask: (id: string) => void;\n  tasks: LoadingTask[];\n}\n\nconst LoadingContext = createContext<LoadingContextType | null>(null);\n\nexport const useLoading = () => {\n  const ctx = useContext(LoadingContext);\n  if (!ctx) {\n    // Fallback for components not wrapped in provider\n    return {\n      addTask: () => {},\n      updateTask: () => {},\n      removeTask: () => {},\n      tasks: [],\n    };\n  }\n  return ctx;\n};\n\ninterface LoadingProviderProps {\n  children: ReactNode;\n}\n\nexport const LoadingProvider: React.FC<LoadingProviderProps> = ({ children }) => {\n  const [tasks, setTasks] = useState<LoadingTask[]>([]);\n\n  const addTask = useCallback((id: string, label: string) => {\n    setTasks((prev) => {\n      // Prevent duplicates\n      if (prev.some((t) => t.id === id)) {\n        return prev.map((t) => (t.id === id ? { ...t, label, startTime: Date.now() } : t));\n      }\n      return [...prev, { id, label, startTime: Date.now() }];\n    });\n  }, []);\n\n  const updateTask = useCallback((id: string, progress: number) => {\n    setTasks((prev) => prev.map((t) => (t.id === id ? { ...t, progress } : t)));\n  }, []);\n\n  const removeTask = useCallback((id: string) => {\n    setTasks((prev) => prev.filter((t) => t.id !== id));\n  }, []);\n\n  return (\n    <LoadingContext.Provider value={{ addTask, updateTask, removeTask, tasks }}>\n      {children}\n      <LoadingPillDisplay tasks={tasks} />\n    </LoadingContext.Provider>\n  );\n};\n\ninterface LoadingPillDisplayProps {\n  tasks: LoadingTask[];\n}\n\nconst LoadingPillDisplay: React.FC<LoadingPillDisplayProps> = ({ tasks }) => {\n  const [hovered, setHovered] = useState(false);\n\n  if (tasks.length === 0) return null;\n\n  // Calculate overall progress\n  const totalProgress = tasks.reduce((sum, t) => sum + (t.progress ?? 50), 0) / tasks.length;\n  const mainTask = tasks[0];\n\n  return (\n    <div\n      className=\"fixed top-3 right-3 z-50\"\n      onMouseEnter={() => setHovered(true)}\n      onMouseLeave={() => setHovered(false)}\n    >\n      {/* Main compact pill */}\n      <div className=\"flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900/90 border border-slate-700/60 shadow-lg backdrop-blur-sm cursor-pointer transition-all duration-200 hover:bg-slate-800/90\">\n        <div\n          className=\"w-3 h-3 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin\"\n          aria-hidden\n        />\n        <span className=\"text-xs text-slate-300 truncate max-w-[120px]\" aria-live=\"polite\">\n          {tasks.length === 1 ? mainTask.label : `${tasks.length} tasks`}\n        </span>\n        <div\n          className=\"w-12 h-1 bg-slate-700/70 rounded-full overflow-hidden\"\n          role=\"progressbar\"\n          aria-valuenow={Math.round(totalProgress)}\n          aria-valuemin={0}\n          aria-valuemax={100}\n          aria-label=\"Loading progress\"\n        >\n          <div\n            className=\"h-full bg-cyan-400 rounded-full transition-all duration-300 ease-out\"\n            style={{ width: `${totalProgress}%` }}\n          />\n        </div>\n      </div>\n\n      {/* Hover tooltip with all tasks */}\n      {hovered && tasks.length > 0 && (\n        <div className=\"absolute top-full right-0 mt-2 min-w-[200px] bg-slate-900/95 border border-slate-700/60 rounded-lg shadow-xl backdrop-blur-sm p-3\">\n          <div className=\"text-xs text-slate-400 mb-2 font-medium\">Active Tasks</div>\n          <div className=\"space-y-2\">\n            {tasks.map((task) => (\n              <div key={task.id} className=\"flex items-center gap-2\">\n                <div className=\"w-2 h-2 border border-cyan-400 border-t-transparent rounded-full animate-spin\" />\n                <span className=\"text-xs text-slate-300 flex-1 truncate\">{task.label}</span>\n                {task.progress !== undefined && (\n                  <span className=\"text-xs text-cyan-400 font-mono\">\n                    {Math.round(task.progress)}%\n                  </span>\n                )}\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\n// Legacy simple pill for backward compatibility\ninterface LoadingPillProps {\n  label?: string;\n  value?: number;\n}\n\nconst LoadingPill: React.FC<LoadingPillProps> = ({ label, value }) => {\n  const pct = typeof value === 'number' ? Math.min(100, Math.max(0, Math.round(value))) : undefined;\n  return (\n    <div className=\"fixed top-3 right-3 z-50\">\n      <div className=\"flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900/90 border border-slate-700/60 shadow-lg backdrop-blur-sm\">\n        <div\n          className=\"w-3 h-3 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin\"\n          aria-hidden\n        />\n        <span className=\"text-xs text-slate-300 truncate max-w-[120px]\" aria-live=\"polite\">\n          {label || 'Loading'}\n        </span>\n        {pct !== undefined && (\n          <div\n            className=\"w-12 h-1 bg-slate-700/70 rounded-full overflow-hidden\"\n            role=\"progressbar\"\n            aria-valuenow={pct}\n            aria-valuemin={0}\n            aria-valuemax={100}\n          >\n            <div\n              className=\"h-full bg-cyan-400 rounded-full transition-all duration-300 ease-out\"\n              style={{ width: `${pct}%` }}\n            />\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default LoadingPill;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/LocationMap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/MediaAndArticlesTab.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'location.search'. Either include it or remove the dependency array.","line":34,"column":6,"nodeType":"ArrayExpression","endLine":34,"endColumn":35,"suggestions":[{"desc":"Update the dependencies array to be: [location.pathname, location.search, navigate]","fix":{"range":[1426,1455],"text":"[location.pathname, location.search, navigate]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { Suspense, useEffect } from 'react';\nimport { useLocation, useNavigate } from 'react-router-dom';\nimport { Newspaper, Image, Music, Film } from 'lucide-react';\nimport ScopedErrorBoundary from './ScopedErrorBoundary';\n\n// Lazy load the tabs to prevent crashes\nconst ArticlesTab = React.lazy(() => import('./ArticlesTab'));\nconst MediaTab = React.lazy(() => import('./MediaTab'));\nconst AudioTab = React.lazy(() => import('./AudioTab'));\nconst VideoTab = React.lazy(() => import('./VideoTab'));\n\nexport const MediaAndArticlesTab: React.FC = () => {\n  const location = useLocation();\n  const navigate = useNavigate();\n\n  // Determine active sub-tab from URL path\n  const getActiveSubTab = (): 'articles' | 'photos' | 'audio' | 'video' => {\n    if (location.pathname === '/media/articles') return 'articles';\n    if (location.pathname === '/media/photos') return 'photos';\n    if (location.pathname === '/media/audio') return 'audio';\n    if (location.pathname === '/media/video') return 'video';\n    return 'photos'; // default\n  };\n\n  const activeSubTab = getActiveSubTab();\n\n  // Redirect /media to /media/photos by default\n  useEffect(() => {\n    if (location.pathname === '/media') {\n      const params = new URLSearchParams(location.search);\n      const hasAudioHints = params.has('albumId') || params.has('id');\n      navigate(hasAudioHints ? '/media/audio' : '/media/photos', { replace: true });\n    }\n  }, [location.pathname, navigate]);\n\n  const navigateToTab = (tab: string) => {\n    navigate(`/media/${tab}`);\n  };\n\n  return (\n    <div className=\"flex flex-col h-full bg-slate-950 overflow-hidden\">\n      {/* Sub-tab Navigation */}\n      <div className=\"flex-none flex gap-2 border-b border-slate-800 bg-slate-900 px-4 pt-2 z-20 overflow-x-auto scrollbar-thin scrollbar-thumb-slate-700/60 scrollbar-track-transparent -mx-4 sm:mx-0\">\n        <button\n          onClick={() => navigateToTab('articles')}\n          className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${\n            activeSubTab === 'articles'\n              ? 'border-blue-500 text-blue-500 bg-blue-500/5'\n              : 'border-transparent text-slate-500 hover:text-slate-300 hover:bg-slate-800/50'\n          }`}\n        >\n          <Newspaper className=\"h-4 w-4\" />\n          <span className=\"font-medium text-sm\">Articles</span>\n        </button>\n        <button\n          onClick={() => navigateToTab('photos')}\n          className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${\n            activeSubTab === 'photos'\n              ? 'border-blue-500 text-blue-500 bg-blue-500/5'\n              : 'border-transparent text-slate-500 hover:text-slate-300 hover:bg-slate-800/50'\n          }`}\n        >\n          <Image className=\"h-4 w-4\" />\n          <span className=\"font-medium text-sm\">Images</span>\n        </button>\n        <button\n          onClick={() => navigateToTab('audio')}\n          className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${\n            activeSubTab === 'audio'\n              ? 'border-blue-500 text-blue-500 bg-blue-500/5'\n              : 'border-transparent text-slate-500 hover:text-slate-300 hover:bg-slate-800/50'\n          }`}\n        >\n          <Music className=\"h-4 w-4\" />\n          <span className=\"font-medium text-sm\">Audio</span>\n        </button>\n        <button\n          onClick={() => navigateToTab('video')}\n          className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${\n            activeSubTab === 'video'\n              ? 'border-blue-500 text-blue-500 bg-blue-500/5'\n              : 'border-transparent text-slate-500 hover:text-slate-300 hover:bg-slate-800/50'\n          }`}\n        >\n          <Film className=\"h-4 w-4\" />\n          <span className=\"font-medium text-sm\">Video</span>\n        </button>\n      </div>\n\n      {/* Content Area with isolation */}\n      <div className=\"flex-grow relative min-h-0 bg-slate-950\">\n        <ScopedErrorBoundary>\n          <Suspense\n            fallback={\n              <div className=\"absolute inset-0 flex items-center justify-center bg-slate-950\">\n                <div className=\"flex flex-col items-center gap-3\">\n                  <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500\"></div>\n                  <p className=\"text-slate-500 text-xs font-mono tracking-widest uppercase\">\n                    Decryption in progress...\n                  </p>\n                </div>\n              </div>\n            }\n          >\n            {activeSubTab === 'articles' && (\n              <ScopedErrorBoundary>\n                <ArticlesTab />\n              </ScopedErrorBoundary>\n            )}\n            {activeSubTab === 'photos' && (\n              <ScopedErrorBoundary>\n                <MediaTab />\n              </ScopedErrorBoundary>\n            )}\n            {activeSubTab === 'audio' && (\n              <ScopedErrorBoundary>\n                <AudioTab />\n              </ScopedErrorBoundary>\n            )}\n            {activeSubTab === 'video' && (\n              <ScopedErrorBoundary>\n                <VideoTab />\n              </ScopedErrorBoundary>\n            )}\n          </Suspense>\n        </ScopedErrorBoundary>\n      </div>\n    </div>\n  );\n};\n\nexport default MediaAndArticlesTab;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/MediaCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/MediaTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/MediaViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/MediaViewerModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/MemoryDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/MobileMenu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/MultiSourceCorrelationEngine.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalAmount' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":149,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":149,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\nimport {\n  Link,\n  Search,\n  Download,\n  AlertTriangle,\n  CheckCircle,\n  MapPin,\n  Mail,\n  DollarSign,\n  User,\n  Building,\n  Calendar,\n  TrendingUp,\n  Activity,\n} from 'lucide-react';\nimport { AddToInvestigationButton } from './AddToInvestigationButton';\n\ninterface DataSource {\n  id: string;\n  type: 'financial' | 'communication' | 'travel' | 'document' | 'social' | 'legal';\n  name: string;\n  description: string;\n  lastUpdated: string;\n  reliability: 'low' | 'medium' | 'high' | 'verified';\n  recordCount: number;\n  coverage: number; // percentage of complete data\n}\n\ninterface CorrelationResult {\n  id: string;\n  type: 'temporal' | 'spatial' | 'entity' | 'financial' | 'behavioral' | 'communication';\n  confidence: number;\n  description: string;\n  sources: string[];\n  entities: string[];\n  timeRange: { start: string; end: string };\n  location?: string;\n  significance: 'low' | 'medium' | 'high' | 'critical';\n  evidence: string[];\n  anomalies: string[];\n}\n\ninterface CorrelationRule {\n  id: string;\n  name: string;\n  description: string;\n  type: 'automatic' | 'manual' | 'ml_suggested';\n  enabled: boolean;\n  sensitivity: 'low' | 'medium' | 'high';\n  lastTriggered?: string;\n  triggerCount: number;\n}\n\nexport default function MultiSourceCorrelationEngine() {\n  const [dataSources, setDataSources] = useState<DataSource[]>([]);\n  const [correlations, setCorrelations] = useState<CorrelationResult[]>([]);\n  const [correlationRules, setCorrelationRules] = useState<CorrelationRule[]>([]);\n  const [selectedCorrelation, setSelectedCorrelation] = useState<CorrelationResult | null>(null);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [filterType, setFilterType] = useState<string>('all');\n  const [filterSignificance, setFilterSignificance] = useState<string>('all');\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [analysisProgress, setAnalysisProgress] = useState(0);\n\n  const recomputeCorrelations = async () => {\n    try {\n      setIsAnalyzing(true);\n      setAnalysisProgress(5);\n\n      // Get a representative entity (top by mentions)\n      const entsResp = await fetch('/api/entities?limit=1&sortBy=mentions');\n      const entsJson = await entsResp.json();\n      const topEntity = Array.isArray(entsJson?.entities) ? entsJson.entities[0] : undefined;\n\n      // Build data sources summary from DB stats\n      const statsResp = await fetch('/api/stats');\n      const stats = await statsResp.json().catch(() => ({}));\n      const ds: DataSource[] = [\n        {\n          id: 'documents',\n          type: 'document',\n          name: 'Documents',\n          description: 'Indexed evidence documents',\n          lastUpdated: new Date().toISOString().slice(0, 10),\n          reliability: 'verified',\n          recordCount: stats?.totalDocuments || 0,\n          coverage: 100,\n        },\n        {\n          id: 'entities',\n          type: 'legal',\n          name: 'Entities',\n          description: 'People and organisations with mentions',\n          lastUpdated: new Date().toISOString().slice(0, 10),\n          reliability: 'high',\n          recordCount: stats?.totalEntities || 0,\n          coverage: 100,\n        },\n      ];\n      setDataSources(ds);\n\n      const nextCorrelations: CorrelationResult[] = [];\n\n      if (topEntity?.id) {\n        // Relationship-based correlations\n        const relResp = await fetch(\n          `/api/relationships?entityId=${topEntity.id}&includeBreakdown=true&minConfidence=0`,\n        );\n        const relJson = await relResp.json();\n        const rels = Array.isArray(relJson?.relationships) ? relJson.relationships : [];\n        rels.forEach((r: any, idx: number) => {\n          nextCorrelations.push({\n            id: `rel-${idx}`,\n            type: 'entity',\n            confidence: Math.round((r.confidence || 0) * 100) || 75,\n            description: `Relationship ${r.relationship_type} with entity ${r.target_id}`,\n            sources: ['entities', 'documents'],\n            entities: [\n              String(topEntity.fullName || topEntity.name || topEntity.id),\n              String(r.target_id),\n            ],\n            timeRange: { start: 'Unknown', end: 'Unknown' },\n            significance:\n              (r.proximity_score || 0) > 0.7\n                ? 'high'\n                : (r.proximity_score || 0) > 0.4\n                  ? 'medium'\n                  : 'low',\n            evidence: [],\n            anomalies: [],\n          });\n        });\n\n        setAnalysisProgress(40);\n\n        // Financial correlations (if API available)\n        try {\n          const txResp = await fetch('/api/financial/transactions');\n          const txJson = await txResp.json().catch(() => []);\n          const txs: any[] = Array.isArray(txJson) ? txJson : [];\n\n          if (txs.length > 0) {\n            const highRisk = txs.filter((t) =>\n              ['high', 'critical'].includes(String(t.risk_level || '').toLowerCase()),\n            );\n\n            if (highRisk.length > 0) {\n              const totalAmount = highRisk.reduce((sum, t) => sum + (Number(t.amount) || 0), 0);\n              // totalAmount currently unused but kept for future detailed reporting\n              const counterparties = Array.from(\n                new Set(\n                  highRisk\n                    .flatMap((t) => [t.from_entity, t.to_entity])\n                    .filter(Boolean)\n                    .map(String),\n                ),\n              );\n\n              nextCorrelations.push({\n                id: 'financial-high-risk',\n                type: 'financial',\n                confidence: 80,\n                description: `High-risk financial transfers involving ${counterparties.length} counterparties and ${highRisk.length} flagged transactions for ${\n                  topEntity.fullName || topEntity.name || topEntity.id\n                }`,\n                sources: ['financial'],\n                entities: [\n                  String(topEntity.fullName || topEntity.name || topEntity.id),\n                  ...counterparties,\n                ],\n                timeRange: { start: 'Unknown', end: 'Unknown' },\n                significance:\n                  highRisk.length > 50 ? 'critical' : highRisk.length > 10 ? 'high' : 'medium',\n                evidence: [],\n                anomalies: [],\n              });\n            }\n          }\n        } catch {\n          // ignore financial correlation errors\n        }\n\n        setAnalysisProgress(70);\n\n        // Communication correlations (if API available)\n        try {\n          const commResp = await fetch(\n            `/api/entities/${topEntity.id}/communications?limit=200&topic=flight_logistics`,\n          );\n          const commJson = await commResp.json().catch(() => ({ data: [] }));\n          const events: any[] = Array.isArray(commJson?.data) ? commJson.data : [];\n\n          if (events.length > 0) {\n            const peers = Array.from(\n              new Set(\n                events\n                  .flatMap((e) => [e.from, ...(Array.isArray(e.to) ? e.to : [])])\n                  .filter(Boolean)\n                  .map(String),\n              ),\n            );\n\n            nextCorrelations.push({\n              id: 'communication-flight',\n              type: 'communication',\n              confidence: 75,\n              description:\n                'Cluster of communications referencing flight or logistics activity around a key entity.',\n              sources: ['communication'],\n              entities: [String(topEntity.fullName || topEntity.name || topEntity.id), ...peers],\n              timeRange: { start: 'Unknown', end: 'Unknown' },\n              significance: events.length > 30 ? 'high' : 'medium',\n              evidence: [],\n              anomalies: [],\n            });\n          }\n        } catch {\n          // ignore communication correlation errors\n        }\n      }\n\n      setCorrelations(nextCorrelations);\n      setCorrelationRules([]);\n      setAnalysisProgress(100);\n    } catch {\n      setDataSources([]);\n      setCorrelationRules([]);\n      setCorrelations([]);\n    } finally {\n      setIsAnalyzing(false);\n    }\n  };\n\n  // Load real data initially\n  useEffect(() => {\n    recomputeCorrelations();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const runCorrelationAnalysis = async () => {\n    await recomputeCorrelations();\n  };\n\n  const getSourceIcon = (type: string) => {\n    switch (type) {\n      case 'financial':\n        return <DollarSign className=\"w-5 h-5\" />;\n      case 'communication':\n        return <Mail className=\"w-5 h-5\" />;\n      case 'travel':\n        return <MapPin className=\"w-5 h-5\" />;\n      case 'document':\n        return <Activity className=\"w-5 h-5\" />;\n      case 'social':\n        return <User className=\"w-5 h-5\" />;\n      case 'legal':\n        return <Building className=\"w-5 h-5\" />;\n      default:\n        return <Activity className=\"w-5 h-5\" />;\n    }\n  };\n\n  const getReliabilityColor = (reliability: string) => {\n    switch (reliability) {\n      case 'verified':\n        return 'text-green-400 bg-green-900';\n      case 'high':\n        return 'text-blue-400 bg-blue-900';\n      case 'medium':\n        return 'text-yellow-400 bg-yellow-900';\n      case 'low':\n        return 'text-red-400 bg-red-900';\n      default:\n        return 'text-gray-400 bg-gray-900';\n    }\n  };\n\n  const getSignificanceColor = (significance: string) => {\n    switch (significance) {\n      case 'critical':\n        return 'border-red-500 bg-red-900';\n      case 'high':\n        return 'border-yellow-500 bg-yellow-900';\n      case 'medium':\n        return 'border-blue-500 bg-blue-900';\n      case 'low':\n        return 'border-green-500 bg-green-900';\n      default:\n        return 'border-gray-500 bg-gray-900';\n    }\n  };\n\n  const getConfidenceColor = (confidence: number) => {\n    if (confidence >= 90) return 'text-green-400';\n    if (confidence >= 80) return 'text-yellow-400';\n    if (confidence >= 70) return 'text-orange-400';\n    return 'text-red-400';\n  };\n\n  const filteredCorrelations = correlations.filter((correlation) => {\n    const matchesSearch =\n      searchTerm === '' ||\n      correlation.description.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      correlation.entities.some((entity) =>\n        entity.toLowerCase().includes(searchTerm.toLowerCase()),\n      );\n\n    const matchesType = filterType === 'all' || correlation.type === filterType;\n    const matchesSignificance =\n      filterSignificance === 'all' || correlation.significance === filterSignificance;\n\n    return matchesSearch && matchesType && matchesSignificance;\n  });\n\n  const exportCorrelations = () => {\n    const data = {\n      correlations: filteredCorrelations,\n      dataSources: dataSources,\n      correlationRules: correlationRules,\n      exportDate: new Date().toISOString(),\n      summary: {\n        totalCorrelations: filteredCorrelations.length,\n        criticalCorrelations: filteredCorrelations.filter((c) => c.significance === 'critical')\n          .length,\n        averageConfidence:\n          filteredCorrelations.reduce((sum, c) => sum + c.confidence, 0) /\n          filteredCorrelations.length,\n      },\n    };\n\n    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `correlation-analysis-${new Date().toISOString().split('T')[0]}.json`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-900 text-gray-100 p-6\">\n      <div className=\"max-w-7xl mx-auto\">\n        {/* Header */}\n        <div className=\"mb-8\">\n          <h1 className=\"text-3xl font-bold text-red-400 mb-2\">Multi-Source Correlation Engine</h1>\n          <p className=\"text-gray-400\">\n            Advanced cross-reference analysis connecting disparate data sources\n          </p>\n        </div>\n\n        {/* Controls */}\n        <div className=\"bg-gray-800 rounded-lg p-6 mb-6\">\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-4\">\n            <div>\n              <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                Search Correlations\n              </label>\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n                <input\n                  type=\"text\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  placeholder=\"Search descriptions or entities...\"\n                  className=\"w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-red-500 focus:border-transparent\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                Correlation Type\n              </label>\n              <select\n                value={filterType}\n                onChange={(e) => setFilterType(e.target.value)}\n                className=\"w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-red-500\"\n              >\n                <option value=\"all\">All Types</option>\n                <option value=\"temporal\">Temporal</option>\n                <option value=\"spatial\">Spatial</option>\n                <option value=\"entity\">Entity</option>\n                <option value=\"financial\">Financial</option>\n                <option value=\"behavioral\">Behavioral</option>\n                <option value=\"communication\">Communication</option>\n              </select>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-gray-300 mb-2\">Significance</label>\n              <select\n                value={filterSignificance}\n                onChange={(e) => setFilterSignificance(e.target.value)}\n                className=\"w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-red-500\"\n              >\n                <option value=\"all\">All Levels</option>\n                <option value=\"critical\">Critical</option>\n                <option value=\"high\">High</option>\n                <option value=\"medium\">Medium</option>\n                <option value=\"low\">Low</option>\n              </select>\n            </div>\n\n            <div className=\"flex items-end\">\n              <button\n                onClick={runCorrelationAnalysis}\n                disabled={isAnalyzing}\n                className=\"w-full px-4 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg transition-colors flex items-center justify-center gap-2 whitespace-nowrap min-w-[160px]\"\n              >\n                {isAnalyzing ? (\n                  <>\n                    <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\"></div>\n                    Analyzing...\n                  </>\n                ) : (\n                  <>\n                    <Link className=\"w-4 h-4\" />\n                    Run Analysis\n                  </>\n                )}\n              </button>\n            </div>\n          </div>\n\n          {isAnalyzing && (\n            <div className=\"mb-4\">\n              <div className=\"flex justify-between text-sm text-gray-400 mb-2\">\n                <span>Analysis Progress</span>\n                <span>{analysisProgress}%</span>\n              </div>\n              <div className=\"w-full bg-gray-700 rounded-full h-2\">\n                <div\n                  className=\"bg-red-600 h-2 rounded-full transition-all duration-300\"\n                  style={{ width: `${analysisProgress}%` }}\n                ></div>\n              </div>\n            </div>\n          )}\n\n          <div className=\"flex justify-between items-center\">\n            <div className=\"text-sm text-gray-400\">\n              Found {filteredCorrelations.length} correlations from {dataSources.length} data\n              sources\n            </div>\n            <button\n              onClick={exportCorrelations}\n              className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors\"\n            >\n              <Download className=\"w-4 h-4\" />\n              Export Results\n            </button>\n          </div>\n        </div>\n\n        {/* Summary Cards */}\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-6\">\n          <div className=\"bg-gray-800 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-gray-400 text-sm whitespace-nowrap\">Active Sources</p>\n                <p className=\"text-2xl font-bold text-blue-400\">{dataSources.length}</p>\n              </div>\n              <Activity className=\"w-8 h-8 text-blue-400\" />\n            </div>\n          </div>\n\n          <div className=\"bg-gray-800 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-gray-400 text-sm whitespace-nowrap\">Total Correlations</p>\n                <p className=\"text-2xl font-bold text-green-400\">{filteredCorrelations.length}</p>\n              </div>\n              <Link className=\"w-8 h-8 text-green-400\" />\n            </div>\n          </div>\n\n          <div className=\"bg-gray-800 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-gray-400 text-sm whitespace-nowrap\">Critical Findings</p>\n                <p className=\"text-2xl font-bold text-yellow-400\">\n                  {filteredCorrelations.filter((c) => c.significance === 'critical').length}\n                </p>\n              </div>\n              <AlertTriangle className=\"w-8 h-8 text-yellow-400\" />\n            </div>\n          </div>\n\n          <div className=\"bg-gray-800 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-gray-400 text-sm whitespace-nowrap\">Avg Confidence</p>\n                <p className=\"text-2xl font-bold text-purple-400\">\n                  {filteredCorrelations.length > 0\n                    ? Math.round(\n                        filteredCorrelations.reduce((sum, c) => sum + c.confidence, 0) /\n                          filteredCorrelations.length,\n                      )\n                    : 0}\n                  %\n                </p>\n              </div>\n              <TrendingUp className=\"w-8 h-8 text-purple-400\" />\n            </div>\n          </div>\n        </div>\n\n        {/* Main Content */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6\">\n          {/* Correlation Results */}\n          <div className=\"md:col-span-1 xl:col-span-2\">\n            <div className=\"bg-gray-800 rounded-lg p-6\">\n              <h2 className=\"text-xl font-semibold text-gray-100 mb-4\">Correlation Results</h2>\n              <div className=\"space-y-4 max-h-96 overflow-y-auto\">\n                {filteredCorrelations.map((correlation) => (\n                  <div\n                    key={correlation.id}\n                    onClick={() => setSelectedCorrelation(correlation)}\n                    className={`p-4 rounded-lg cursor-pointer transition-colors border-l-4 ${\n                      selectedCorrelation?.id === correlation.id\n                        ? 'bg-red-900 border-red-500'\n                        : `${getSignificanceColor(correlation.significance)} border-opacity-50`\n                    }`}\n                  >\n                    <div className=\"flex justify-between items-start mb-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <span\n                          className={`px-2 py-1 rounded text-xs font-medium capitalize ${\n                            correlation.type === 'temporal'\n                              ? 'bg-blue-900 text-blue-200'\n                              : correlation.type === 'spatial'\n                                ? 'bg-green-900 text-green-200'\n                                : correlation.type === 'financial'\n                                  ? 'bg-yellow-900 text-yellow-200'\n                                  : correlation.type === 'communication'\n                                    ? 'bg-purple-900 text-purple-200'\n                                    : 'bg-gray-900 text-gray-200'\n                          }`}\n                        >\n                          {correlation.type}\n                        </span>\n                        <span\n                          className={`text-sm font-medium ${getConfidenceColor(correlation.confidence)}`}\n                        >\n                          {correlation.confidence}% confidence\n                        </span>\n                      </div>\n                      <span\n                        className={`px-2 py-1 rounded text-xs font-medium ${\n                          correlation.significance === 'critical'\n                            ? 'bg-red-900 text-red-200'\n                            : correlation.significance === 'high'\n                              ? 'bg-yellow-900 text-yellow-200'\n                              : correlation.significance === 'medium'\n                                ? 'bg-blue-900 text-blue-200'\n                                : 'bg-green-900 text-green-200'\n                        }`}\n                      >\n                        {correlation.significance.toUpperCase()}\n                      </span>\n                      <div onClick={(e) => e.stopPropagation()}>\n                        <AddToInvestigationButton\n                          item={{\n                            id: correlation.id,\n                            title: `Correlation: ${correlation.description.substring(0, 50)}...`,\n                            description: correlation.description,\n                            type: 'evidence',\n                            sourceId: correlation.id,\n                            metadata: {\n                              confidence: correlation.confidence,\n                              type: correlation.type,\n                              significance: correlation.significance,\n                            },\n                          }}\n                          investigations={[]} // This needs to be populated from context or props\n                          onAddToInvestigation={(invId, item, relevance) => {\n                            console.log('Add to investigation', invId, item, relevance);\n                            const event = new CustomEvent('add-to-investigation', {\n                              detail: { investigationId: invId, item, relevance },\n                            });\n                            window.dispatchEvent(event);\n                          }}\n                          variant=\"icon\"\n                          className=\"hover:bg-slate-600 p-1\"\n                        />\n                      </div>\n                    </div>\n\n                    <p className=\"text-gray-100 mb-3\">{correlation.description}</p>\n\n                    <div className=\"flex flex-wrap gap-2 mb-3\">\n                      {correlation.entities.map((entity, index) => (\n                        <span\n                          key={index}\n                          className=\"px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs\"\n                        >\n                          {entity}\n                        </span>\n                      ))}\n                    </div>\n\n                    <div className=\"flex items-center gap-4 text-xs text-gray-400\">\n                      <span className=\"flex items-center gap-1\">\n                        <Calendar className=\"w-3 h-3\" />\n                        {correlation.timeRange.start} to {correlation.timeRange.end}\n                      </span>\n                      {correlation.location && (\n                        <span className=\"flex items-center gap-1\">\n                          <MapPin className=\"w-3 h-3\" />\n                          {correlation.location}\n                        </span>\n                      )}\n                      <span>{correlation.sources.length} sources</span>\n                    </div>\n\n                    {correlation.anomalies.length > 0 && (\n                      <div className=\"mt-2\">\n                        <p className=\"text-xs text-red-400 font-medium mb-1\">Anomalies:</p>\n                        <div className=\"flex flex-wrap gap-1\">\n                          {correlation.anomalies.map((anomaly, index) => (\n                            <span\n                              key={index}\n                              className=\"px-2 py-1 bg-red-900 text-red-200 rounded text-xs\"\n                            >\n                              {anomaly}\n                            </span>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {/* Side Panel */}\n          <div className=\"space-y-6\">\n            {/* Data Sources */}\n            <div className=\"bg-gray-800 rounded-lg p-6\">\n              <h3 className=\"text-lg font-semibold text-gray-100 mb-4\">Data Sources</h3>\n              <div className=\"space-y-3 max-h-48 overflow-y-auto\">\n                {dataSources.map((source) => (\n                  <div key={source.id} className=\"p-3 bg-gray-700 rounded-lg\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      {getSourceIcon(source.type)}\n                      <span className=\"font-medium text-gray-100 text-sm\">{source.name}</span>\n                    </div>\n                    <p className=\"text-xs text-gray-400 mb-2\">{source.description}</p>\n                    <div className=\"flex justify-between items-center text-xs\">\n                      <span\n                        className={`px-2 py-1 rounded ${getReliabilityColor(source.reliability)}`}\n                      >\n                        {source.reliability.toUpperCase()}\n                      </span>\n                      <span className=\"text-gray-500\">{source.recordCount} records</span>\n                    </div>\n                    <div className=\"mt-2\">\n                      <div className=\"flex justify-between text-xs text-gray-400 mb-1\">\n                        <span>Coverage</span>\n                        <span>{source.coverage}%</span>\n                      </div>\n                      <div className=\"w-full bg-gray-600 rounded-full h-1\">\n                        <div\n                          className=\"bg-blue-600 h-1 rounded-full\"\n                          style={{ width: `${source.coverage}%` }}\n                        ></div>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </div>\n\n            {/* Correlation Rules */}\n            <div className=\"bg-gray-800 rounded-lg p-6\">\n              <h3 className=\"text-lg font-semibold text-gray-100 mb-4\">Correlation Rules</h3>\n              <div className=\"space-y-3 max-h-48 overflow-y-auto\">\n                {correlationRules.map((rule) => (\n                  <div key={rule.id} className=\"p-3 bg-gray-700 rounded-lg\">\n                    <div className=\"flex justify-between items-center mb-2\">\n                      <span className=\"font-medium text-gray-100 text-sm\">{rule.name}</span>\n                      <span\n                        className={`px-2 py-1 rounded text-xs ${\n                          rule.enabled ? 'bg-green-900 text-green-200' : 'bg-gray-900 text-gray-200'\n                        }`}\n                      >\n                        {rule.enabled ? 'ACTIVE' : 'INACTIVE'}\n                      </span>\n                    </div>\n                    <p className=\"text-xs text-gray-400 mb-2\">{rule.description}</p>\n                    <div className=\"flex justify-between items-center text-xs text-gray-500\">\n                      <span>Sensitivity: {rule.sensitivity}</span>\n                      <span>Triggers: {rule.triggerCount}</span>\n                    </div>\n                    {rule.lastTriggered && (\n                      <div className=\"text-xs text-gray-500 mt-1\">\n                        Last: {new Date(rule.lastTriggered).toLocaleDateString()}\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n            </div>\n\n            {/* Correlation Details */}\n            {selectedCorrelation && (\n              <div className=\"bg-gray-800 rounded-lg p-6\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h3 className=\"text-lg font-semibold text-gray-100\">Correlation Details</h3>\n                  <AddToInvestigationButton\n                    item={{\n                      id: selectedCorrelation.id,\n                      title: `Correlation: ${selectedCorrelation.description.substring(0, 50)}...`,\n                      description: selectedCorrelation.description,\n                      type: 'evidence',\n                      sourceId: selectedCorrelation.id,\n                      metadata: {\n                        confidence: selectedCorrelation.confidence,\n                        type: selectedCorrelation.type,\n                        significance: selectedCorrelation.significance,\n                      },\n                    }}\n                    investigations={[]} // This needs to be populated from context or props\n                    onAddToInvestigation={(invId, item, relevance) => {\n                      console.log('Add to investigation', invId, item, relevance);\n                      const event = new CustomEvent('add-to-investigation', {\n                        detail: { investigationId: invId, item, relevance },\n                      });\n                      window.dispatchEvent(event);\n                    }}\n                    variant=\"button\"\n                    className=\"text-xs\"\n                  />\n                </div>\n                <div className=\"space-y-3\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-400\">Type</label>\n                    <p className=\"text-gray-100 capitalize\">{selectedCorrelation.type}</p>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-400\">Confidence</label>\n                    <p\n                      className={`text-gray-100 text-lg font-semibold ${getConfidenceColor(selectedCorrelation.confidence)}`}\n                    >\n                      {selectedCorrelation.confidence}%\n                    </p>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-400\">Time Range</label>\n                    <p className=\"text-gray-100\">\n                      {selectedCorrelation.timeRange.start} to {selectedCorrelation.timeRange.end}\n                    </p>\n                  </div>\n                  {selectedCorrelation.location && (\n                    <div>\n                      <label className=\"block text-sm font-medium text-gray-400\">Location</label>\n                      <p className=\"text-gray-100\">{selectedCorrelation.location}</p>\n                    </div>\n                  )}\n\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-400 mb-2\">Evidence</label>\n                    <div className=\"space-y-1\">\n                      {selectedCorrelation.evidence.map((evidence, index) => (\n                        <div key={index} className=\"flex items-start gap-2\">\n                          <CheckCircle className=\"w-4 h-4 text-green-400 mt-0.5 flex-shrink-0\" />\n                          <span className=\"text-sm text-gray-300\">{evidence}</span>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-400 mb-2\">\n                      Data Sources\n                    </label>\n                    <div className=\"space-y-1\">\n                      {selectedCorrelation.sources.map((sourceId, index) => {\n                        const source = dataSources.find((s) => s.id === sourceId);\n                        return (\n                          <div key={index} className=\"flex items-center gap-2\">\n                            {source && getSourceIcon(source.type)}\n                            <span className=\"text-sm text-gray-300\">\n                              {source?.name || sourceId}\n                            </span>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/NetworkGraph.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'nodes'. Either include it or remove the dependency array.","line":260,"column":6,"nodeType":"ArrayExpression","endLine":260,"endColumn":33,"suggestions":[{"desc":"Update the dependencies array to be: [nodes.length, draggedNode, nodes]","fix":{"range":[8060,8087],"text":"[nodes.length, draggedNode, nodes]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo, useState, useRef, useEffect, useCallback } from 'react';\nimport { ZoomIn, ZoomOut, Move, RefreshCw, AlertTriangle, Link2, Filter } from 'lucide-react';\n\ninterface EntityNode {\n  id: number;\n  name: string;\n  role?: string;\n  type?: string;\n  riskLevel?: number;\n  connectionCount: number;\n  mentions?: number;\n  photoUrl?: string;\n}\n\ninterface Relationship {\n  source: string;\n  target: string;\n  type?: string;\n  weight?: number;\n}\n\ninterface NetworkGraphProps {\n  entities: EntityNode[];\n  relationships: Relationship[];\n  onEntityClick?: (entity: EntityNode) => void;\n  maxNodes?: number;\n  onFilterUpdate?: (stats: { visible: number; total: number; label: string }) => void;\n}\n\ninterface Point {\n  x: number;\n  y: number;\n}\n\ninterface GraphNode extends EntityNode {\n  x: number;\n  y: number;\n  vx: number;\n  vy: number;\n  radius: number;\n}\n\n// Risk-based colors with better visibility\nconst getRiskColor = (riskLevel: number): string => {\n  if (riskLevel >= 5) return '#a855f7'; // Purple - Critical\n  if (riskLevel >= 4) return '#ef4444'; // Red - High\n  if (riskLevel >= 3) return '#f59e0b'; // Amber - Medium\n  if (riskLevel >= 2) return '#3b82f6'; // Blue - Low\n  return '#10b981'; // Green - Minimal\n};\n\nconst getNodeSize = (connectionCount: number, maxConnections: number): number => {\n  const minSize = 3;\n  const maxSize = 12;\n  const ratio = connectionCount / Math.max(maxConnections, 1);\n  return minSize + (maxSize - minSize) * Math.sqrt(ratio);\n};\n\n// Simple collision resolution for main thread (small datasets)\nconst applyCollisionResolution = (nodes: GraphNode[], draggedNode: number | null): GraphNode[] => {\n  const newNodes = nodes.map((n) => ({ ...n }));\n\n  for (let i = 0; i < newNodes.length; i++) {\n    const node = newNodes[i];\n    if (node.id === draggedNode) continue;\n\n    for (let j = 0; j < newNodes.length; j++) {\n      if (i === j) continue;\n      const other = newNodes[j];\n      const dx = node.x - other.x;\n      const dy = node.y - other.y;\n      const dist = Math.sqrt(dx * dx + dy * dy);\n      const minDist = (node.radius / 2 + other.radius / 2) * 1.5;\n\n      if (dist < minDist && dist > 0) {\n        const overlap = minDist - dist;\n        const moveX = (dx / dist) * overlap * 0.1;\n        const moveY = (dy / dist) * overlap * 0.1;\n\n        node.x += moveX;\n        node.y += moveY;\n      }\n    }\n  }\n  return newNodes;\n};\n\nexport const NetworkGraph: React.FC<NetworkGraphProps> = ({\n  entities,\n  relationships,\n  onEntityClick,\n  maxNodes = 600,\n  onFilterUpdate,\n}) => {\n  const svgRef = useRef<SVGSVGElement>(null);\n  const [nodes, setNodes] = useState<GraphNode[]>([]);\n  const [transform, setTransform] = useState({ x: 0, y: 0, k: 0.8 });\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragStart, setDragStart] = useState<Point>({ x: 0, y: 0 });\n  const [draggedNode, setDraggedNode] = useState<number | null>(null);\n  const [hoveredNode, setHoveredNode] = useState<string | null>(null);\n  const [modifierKeyPressed, setModifierKeyPressed] = useState(false);\n  // TODO: Track space key for pan mode - see UNUSED_VARIABLES_RECOMMENDATIONS.md\n  const [spacePressed, _setSpacePressed] = useState(false);\n  const [totalDragDistance, setTotalDragDistance] = useState(0);\n  const workerRef = useRef<Worker | null>(null);\n  const useWorkerRef = useRef(false);\n\n  // Filter state\n  const [minSeverity, setMinSeverity] = useState(0);\n  const [minConnections, setMinConnections] = useState(0);\n  const [showFilters, setShowFilters] = useState(false);\n  const [hasInteractedWithFilter, setHasInteractedWithFilter] = useState(false);\n\n  // Track modifier keys (Shift or Alt for forced node dragging)\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.shiftKey || e.altKey) setModifierKeyPressed(true);\n    };\n    const handleKeyUp = (e: KeyboardEvent) => {\n      if (!e.shiftKey && !e.altKey) setModifierKeyPressed(false);\n    };\n    window.addEventListener('keydown', handleKeyDown);\n    window.addEventListener('keyup', handleKeyUp);\n    return () => {\n      window.removeEventListener('keydown', handleKeyDown);\n      window.removeEventListener('keyup', handleKeyUp);\n    };\n  }, []);\n\n  // Compute max values for sliders\n  const maxSeverityInData = useMemo(\n    () => Math.max(1, ...entities.map((e) => e.riskLevel || 0)),\n    [entities],\n  );\n  const maxConnectionsInData = useMemo(\n    () => Math.max(1, ...entities.map((e) => e.connectionCount)),\n    [entities],\n  );\n\n  // Initialize nodes with Spiral Layout\n  useEffect(() => {\n    const topEntities = entities.slice(0, maxNodes);\n\n    const goldenAngle = Math.PI * (3 - Math.sqrt(5));\n    const count = topEntities.length;\n    const rStep = count > 100 ? 4 : 6;\n\n    const initialNodes = topEntities.map((entity, index) => {\n      const r = rStep * Math.sqrt(index + 2);\n      const theta = index * goldenAngle;\n\n      const x = 50 + r * Math.cos(theta);\n      const y = 50 + r * Math.sin(theta);\n\n      const maxConn = Math.max(1, ...topEntities.map((n) => n.connectionCount));\n      const size = getNodeSize(entity.connectionCount, maxConn);\n\n      return {\n        ...entity,\n        x,\n        y,\n        vx: 0,\n        vy: 0,\n        radius: size,\n      };\n    });\n    setNodes(initialNodes);\n    useWorkerRef.current = initialNodes.length > 40;\n  }, [entities, maxNodes]);\n\n  // Filtered nodes based on sliders\n  const filteredNodes = useMemo(() => {\n    return nodes.filter(\n      (n) => (n.riskLevel || 0) >= minSeverity && n.connectionCount >= minConnections,\n    );\n  }, [nodes, minSeverity, minConnections]);\n\n  // Update parent with filter stats\n  useEffect(() => {\n    if (onFilterUpdate) {\n      const total = nodes.length;\n      const visible = filteredNodes.length;\n      let label = `Showing ${visible} of ${total} Nodes`;\n\n      if (minSeverity > 0) label += ` • Min Severity: ${minSeverity}`;\n      if (minConnections > 0) label += ` • Min Conn: ${minConnections}`;\n\n      onFilterUpdate({ visible, total, label });\n    }\n  }, [filteredNodes.length, nodes.length, minSeverity, minConnections, onFilterUpdate]);\n\n  // Links data\n  const links = useMemo(() => {\n    if (filteredNodes.length === 0) return [];\n\n    const nodeMap = new Map(filteredNodes.map((n) => [n.name, n]));\n\n    // Normalize weights if available, otherwise default\n    const maxWeight = Math.max(1, ...relationships.map((r) => r.weight || 1));\n\n    return relationships\n      .filter((r) => nodeMap.has(r.source) && nodeMap.has(r.target))\n      .map((r) => ({\n        source: nodeMap.get(r.source)!,\n        target: nodeMap.get(r.target)!,\n        type: r.type,\n        weight: r.weight || 1,\n        normalizedWeight: (r.weight || 1) / maxWeight,\n      }))\n      .slice(0, 500);\n  }, [filteredNodes, relationships]);\n\n  // Physics simulation\n  useEffect(() => {\n    if (nodes.length === 0) return;\n\n    if (useWorkerRef.current && typeof Worker !== 'undefined') {\n      try {\n        workerRef.current = new Worker(\n          new URL('../workers/networkGraph.worker.ts', import.meta.url),\n          { type: 'module' },\n        );\n\n        workerRef.current.onmessage = (e) => {\n          if (e.data.type === 'nodes' && e.data.nodes) {\n            setNodes(e.data.nodes);\n          }\n        };\n\n        workerRef.current.postMessage({ type: 'init', nodes });\n\n        return () => {\n          workerRef.current?.postMessage({ type: 'stop' });\n          workerRef.current?.terminate();\n          workerRef.current = null;\n        };\n      } catch (e) {\n        console.warn('Web Worker failed, using main thread:', e);\n        useWorkerRef.current = false;\n      }\n    }\n\n    let tickCount = 0;\n    const maxTicks = 60;\n\n    const tick = () => {\n      if (tickCount >= maxTicks) return;\n      setNodes((prevNodes) => applyCollisionResolution(prevNodes, draggedNode));\n      tickCount++;\n    };\n\n    const interval = setInterval(tick, 33);\n    const timeout = setTimeout(() => clearInterval(interval), 2000);\n\n    return () => {\n      clearInterval(interval);\n      clearTimeout(timeout);\n    };\n  }, [nodes.length, draggedNode]);\n\n  // Update worker when node is dragged\n  useEffect(() => {\n    if (workerRef.current && draggedNode !== null) {\n      const node = nodes.find((n) => n.id === draggedNode);\n      if (node) {\n        workerRef.current.postMessage({\n          type: 'updateNode',\n          nodeUpdate: { id: node.id, x: node.x, y: node.y },\n          draggedNodeId: draggedNode,\n        });\n      }\n    }\n  }, [draggedNode, nodes]);\n\n  // Find nearest node to a point (for modifier key drag)\n  const findNearestNode = useCallback(\n    (clientX: number, clientY: number): GraphNode | null => {\n      if (!svgRef.current || filteredNodes.length === 0) return null;\n\n      const rect = svgRef.current.getBoundingClientRect();\n      const svgX = (((clientX - rect.left) / rect.width) * 100 - transform.x) / transform.k;\n      const svgY = (((clientY - rect.top) / rect.height) * 100 - transform.y) / transform.k;\n\n      let nearest: GraphNode | null = null;\n      let minDist = Infinity;\n\n      for (const node of filteredNodes) {\n        const dx = node.x - svgX;\n        const dy = node.y - svgY;\n        const dist = Math.sqrt(dx * dx + dy * dy);\n        if (dist < minDist) {\n          minDist = dist;\n          nearest = node;\n        }\n      }\n\n      return nearest;\n    },\n    [filteredNodes, transform],\n  );\n\n  // Pan/Zoom handlers\n  const handleWheel = (e: React.WheelEvent) => {\n    e.preventDefault();\n    if (!svgRef.current) return;\n\n    const scaleFactor = 1.1;\n    const direction = e.deltaY < 0 ? 1 : -1;\n    const factor = direction > 0 ? scaleFactor : 1 / scaleFactor;\n\n    const newK = Math.max(0.2, Math.min(5, transform.k * factor));\n\n    const rect = svgRef.current.getBoundingClientRect();\n    const relX = ((e.clientX - rect.left) / rect.width) * 100;\n    const relY = ((e.clientY - rect.top) / rect.height) * 100;\n\n    const newX = relX - (relX - transform.x) * (newK / transform.k);\n    const newY = relY - (relY - transform.y) * (newK / transform.k);\n\n    setTransform({ x: newX, y: newY, k: newK });\n  };\n\n  const handleMouseDown = (e: React.MouseEvent) => {\n    if (e.button !== 0) return;\n\n    setTotalDragDistance(0);\n\n    // Space key = Pan mode\n    if (spacePressed) {\n      setIsDragging(true);\n      setDragStart({ x: e.clientX, y: e.clientY });\n      return;\n    }\n\n    // Modifier key = Drag node mode\n    if (modifierKeyPressed) {\n      const nearest = findNearestNode(e.clientX, e.clientY);\n      if (nearest) {\n        setDraggedNode(nearest.id);\n        setDragStart({ x: e.clientX, y: e.clientY });\n        return;\n      }\n    }\n\n    // Default - start pan, but check for node click later\n    setIsDragging(true);\n    setDragStart({ x: e.clientX, y: e.clientY });\n  };\n\n  const handleMouseMove = (e: React.MouseEvent) => {\n    if (draggedNode !== null) {\n      const dx = (e.clientX - dragStart.x) / transform.k;\n      const dy = (e.clientY - dragStart.y) / transform.k;\n\n      const svgWidth = svgRef.current?.getBoundingClientRect().width || 1;\n      const scaleToUnits = 100 / svgWidth;\n\n      // Accumulate drag distance\n      setTotalDragDistance((prev) => prev + Math.abs(dx) + Math.abs(dy));\n\n      setNodes((prev) =>\n        prev.map((n) => {\n          if (n.id === draggedNode) {\n            return {\n              ...n,\n              x: n.x + dx * scaleToUnits,\n              y: n.y + dy * scaleToUnits,\n            };\n          }\n          return n;\n        }),\n      );\n      setDragStart({ x: e.clientX, y: e.clientY });\n    } else if (isDragging) {\n      const svgWidth = svgRef.current?.getBoundingClientRect().width || 1;\n      const scaleToUnits = 100 / svgWidth;\n\n      const dx = (e.clientX - dragStart.x) * scaleToUnits;\n      const dy = (e.clientY - dragStart.y) * scaleToUnits;\n\n      setTransform((prev) => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));\n      setDragStart({ x: e.clientX, y: e.clientY });\n    }\n  };\n\n  const handleMouseUp = () => {\n    setIsDragging(false);\n    setDraggedNode(null);\n  };\n\n  const zoomFromCenter = (factor: number) => {\n    const newK = Math.max(0.2, Math.min(5, transform.k * factor));\n    const center = 50;\n    const newX = center - (center - transform.x) * (newK / transform.k);\n    const newY = center - (center - transform.y) * (newK / transform.k);\n    setTransform({ x: newX, y: newY, k: newK });\n  };\n\n  const zoomIn = () => zoomFromCenter(1.2);\n  const zoomOut = () => zoomFromCenter(1 / 1.2);\n  const resetView = () => setTransform({ x: 0, y: 0, k: 1 });\n\n  return (\n    <div\n      className={`relative w-full h-[600px] bg-slate-900/50 rounded-xl border border-slate-700/50 overflow-hidden select-none ${spacePressed ? 'cursor-grab active:cursor-grabbing' : ''}`}\n    >\n      {/* Controls */}\n      <div className=\"absolute top-4 right-4 z-20 flex flex-col gap-2\">\n        <button\n          onClick={zoomIn}\n          className=\"p-2 bg-slate-800 hover:bg-slate-700 rounded-lg border border-slate-700 text-slate-300\"\n        >\n          <ZoomIn className=\"w-5 h-5\" />\n        </button>\n        <button\n          onClick={zoomOut}\n          className=\"p-2 bg-slate-800 hover:bg-slate-700 rounded-lg border border-slate-700 text-slate-300\"\n        >\n          <ZoomOut className=\"w-5 h-5\" />\n        </button>\n        <button\n          onClick={resetView}\n          className=\"p-2 bg-slate-800 hover:bg-slate-700 rounded-lg border border-slate-700 text-slate-300\"\n        >\n          <RefreshCw className=\"w-5 h-5\" />\n        </button>\n        <button\n          onClick={() => {\n            setShowFilters(!showFilters);\n            setHasInteractedWithFilter(true);\n          }}\n          className={`p-2 rounded-lg border text-slate-300 relative ${showFilters ? 'bg-cyan-700 border-cyan-600' : 'bg-slate-800 hover:bg-slate-700 border-slate-700'}`}\n        >\n          <Filter className=\"w-5 h-5\" />\n          {!hasInteractedWithFilter && !showFilters && (\n            <span className=\"absolute -top-1 -right-1 w-3 h-3 bg-cyan-500 rounded-full animate-ping\" />\n          )}\n          {!hasInteractedWithFilter && !showFilters && (\n            <span className=\"absolute -top-1 -right-1 w-3 h-3 bg-cyan-500 rounded-full\" />\n          )}\n        </button>\n      </div>\n\n      {/* Filter Panel */}\n      {showFilters && (\n        <div className=\"absolute top-4 right-16 z-20 bg-slate-800/95 backdrop-blur-sm rounded-lg p-4 border border-slate-700/50 shadow-xl w-64\">\n          <p className=\"text-xs text-slate-400 mb-3 font-bold uppercase tracking-wider flex items-center gap-2\">\n            <Filter className=\"w-3 h-3\" /> Node Filters\n          </p>\n\n          <div className=\"space-y-4\">\n            {/* Severity Filter */}\n            <div>\n              <label className=\"flex items-center gap-2 text-xs text-slate-300 mb-2\">\n                <AlertTriangle className=\"w-3 h-3 text-amber-400\" />\n                Min Severity: {minSeverity}\n              </label>\n              <input\n                type=\"range\"\n                min={0}\n                max={maxSeverityInData}\n                value={minSeverity}\n                onChange={(e) => setMinSeverity(parseInt(e.target.value))}\n                className=\"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-amber-500\"\n              />\n              <div className=\"flex justify-between text-[10px] text-slate-500 mt-1\">\n                <span>All</span>\n                <span>{maxSeverityInData}</span>\n              </div>\n            </div>\n\n            {/* Connections Filter */}\n            <div>\n              <label className=\"flex items-center gap-2 text-xs text-slate-300 mb-2\">\n                <Link2 className=\"w-3 h-3 text-cyan-400\" />\n                Min Connections: {minConnections}\n              </label>\n              <input\n                type=\"range\"\n                min={0}\n                max={Math.min(50, maxConnectionsInData)}\n                value={minConnections}\n                onChange={(e) => setMinConnections(parseInt(e.target.value))}\n                className=\"w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500\"\n              />\n              <div className=\"flex justify-between text-[10px] text-slate-500 mt-1\">\n                <span>All</span>\n                <span>{Math.min(50, maxConnectionsInData)}+</span>\n              </div>\n            </div>\n\n            {/* Stats */}\n            <div className=\"pt-2 border-t border-slate-700/50 text-xs text-slate-400\">\n              Showing {filteredNodes.length} of {nodes.length} nodes\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Legend */}\n      <div className=\"absolute top-4 left-4 z-20 bg-slate-800/90 backdrop-blur-sm rounded-lg p-4 border border-slate-700/50 shadow-xl pointer-events-none sm:pointer-events-auto opacity-80 sm:opacity-100 hover:opacity-100 transition-opacity\">\n        <p className=\"text-xs text-slate-400 mb-3 font-bold uppercase tracking-wider\">\n          Risk Levels\n        </p>\n        <div className=\"space-y-2\">\n          {[\n            { level: 5, label: 'Critical Risk', color: '#a855f7' },\n            { level: 4, label: 'High Risk', color: '#ef4444' },\n            { level: 3, label: 'Medium Risk', color: '#f59e0b' },\n            { level: 2, label: 'Low Risk', color: '#3b82f6' },\n            { level: 1, label: 'Minimal', color: '#10b981' },\n          ].map(({ level, label, color }) => (\n            <div key={level} className=\"flex items-center gap-3\">\n              <div\n                className=\"w-3 h-3 rounded-full shadow-[0_0_8px]\"\n                style={{ backgroundColor: color, boxShadow: `0 0 8px ${color}` }}\n              />\n              <span className=\"text-xs text-slate-300\">{label}</span>\n            </div>\n          ))}\n        </div>\n        <div className=\"mt-4 pt-3 border-t border-slate-700/50\">\n          <div className=\"flex items-center gap-2 text-xs text-slate-400\">\n            <Move className=\"w-3 h-3\" />\n            <span>Drag Background to Pan</span>\n          </div>\n          <div className=\"flex items-center gap-2 text-xs text-slate-400 mt-1\">\n            <span className=\"w-3 h-3 rounded-full border border-slate-500 block\"></span>\n            <span>Drag Nodes to Rearrange</span>\n          </div>\n          <div className=\"flex items-center gap-2 text-xs text-cyan-400 mt-1\">\n            <span className=\"text-[10px] bg-slate-700 px-1 rounded\">Shift</span>\n            <span>+ Drag = Force Move Nearest</span>\n          </div>\n        </div>\n      </div>\n\n      {/* Graph Area */}\n      <svg\n        ref={svgRef}\n        viewBox=\"0 0 100 100\"\n        className={`w-full h-full ${modifierKeyPressed ? 'cursor-crosshair' : 'cursor-move'}`}\n        style={{\n          background:\n            'radial-gradient(circle at 50% 50%, rgba(15, 23, 42, 0.5) 0%, rgba(2, 6, 23, 0.8) 100%)',\n        }}\n        onWheel={handleWheel}\n        onMouseDown={handleMouseDown}\n        onMouseMove={handleMouseMove}\n        onMouseUp={handleMouseUp}\n        onMouseLeave={handleMouseUp}\n      >\n        <defs>\n          <filter id=\"nodeGlow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\n            <feGaussianBlur stdDeviation=\"0.5\" result=\"blur\" />\n            <feMerge>\n              <feMergeNode in=\"blur\" />\n              <feMergeNode in=\"SourceGraphic\" />\n            </feMerge>\n          </filter>\n          {filteredNodes\n            .filter((n) => n.photoUrl)\n            .map((n) => (\n              <pattern\n                key={`photo-${n.id}`}\n                id={`photo-${n.id}`}\n                x=\"0\"\n                y=\"0\"\n                height=\"1\"\n                width=\"1\"\n                viewBox=\"0 0 100 100\"\n                preserveAspectRatio=\"xMidYMid slice\"\n              >\n                <image\n                  href={n.photoUrl}\n                  x=\"0\"\n                  y=\"0\"\n                  width=\"100\"\n                  height=\"100\"\n                  preserveAspectRatio=\"xMidYMid slice\"\n                />\n              </pattern>\n            ))}\n        </defs>\n\n        <g transform={`translate(${transform.x}, ${transform.y}) scale(${transform.k})`}>\n          {/* Links */}\n          <g className=\"links\">\n            {links.map((link, i) => {\n              const isHighlight =\n                hoveredNode === link.source.name || hoveredNode === link.target.name;\n              // Dynamic width based on weight (0.05 to 0.3 base)\n              // @ts-ignore - normalizedWeight added in useMemo\n              const weightBonus = (link.normalizedWeight || 0) * 0.15;\n              const baseWidth = 0.05 + weightBonus;\n              const highlightWidth = 0.3 + weightBonus;\n\n              return (\n                <line\n                  key={i}\n                  x1={link.source.x}\n                  y1={link.source.y}\n                  x2={link.target.x}\n                  y2={link.target.y}\n                  stroke={isHighlight ? '#bae6fd' : '#334155'}\n                  strokeWidth={isHighlight ? highlightWidth : baseWidth}\n                  strokeOpacity={isHighlight ? 0.8 : 0.2 + (link.normalizedWeight || 0) * 0.2}\n                  className=\"transition-all duration-300\"\n                />\n              );\n            })}\n          </g>\n\n          {/* Nodes */}\n          <g className=\"nodes\">\n            {filteredNodes.map((node) => {\n              const color = getRiskColor(node.riskLevel || 0);\n              const isHovered = hoveredNode === node.name;\n              const size = node.radius || 4;\n\n              return (\n                <g\n                  key={node.id}\n                  transform={`translate(${node.x}, ${node.y})`}\n                  onMouseEnter={() => setHoveredNode(node.name)}\n                  onMouseLeave={() => setHoveredNode(null)}\n                  onMouseDown={(e) => {\n                    e.stopPropagation();\n                    // Only drag node if NOT panning with space\n                    if (!spacePressed) {\n                      setDraggedNode(node.id);\n                      setDragStart({ x: e.clientX, y: e.clientY });\n                      setTotalDragDistance(0);\n                    }\n                  }}\n                  onClick={(_e) => {\n                    // Only trigger click if drag distance is small (was just a click)\n                    if (totalDragDistance < 5) {\n                      onEntityClick?.(node);\n                    }\n                  }}\n                  className={`${spacePressed ? '' : 'cursor-pointer'}`}\n                  style={{\n                    transition:\n                      isDragging && draggedNode === node.id ? 'none' : 'transform 0.1s ease-out',\n                  }}\n                >\n                  {/* Outer Glow */}\n                  <circle\n                    r={(size / 2) * 2.5}\n                    fill={color}\n                    opacity={isHovered ? 0.3 : 0.05}\n                    className=\"transition-opacity duration-300\"\n                  />\n\n                  {/* Node Body */}\n                  <circle\n                    r={size / 2}\n                    fill={color}\n                    stroke=\"white\"\n                    strokeWidth={isHovered ? 0.2 : 0.05}\n                    filter=\"url(#nodeGlow)\"\n                    className=\"transition-all duration-300\"\n                  />\n\n                  {/* Photo or Default Fill */}\n                  {node.photoUrl ? (\n                    <circle\n                      r={size / 2}\n                      fill={`url(#photo-${node.id})`}\n                      className=\"pointer-events-none\"\n                    />\n                  ) : null}\n\n                  {/* Label */}\n                  {(size > 4 || isHovered || transform.k > 2) && (\n                    <text\n                      y={size / 2 + 2}\n                      textAnchor=\"middle\"\n                      fill={isHovered ? 'white' : '#94a3b8'}\n                      fontSize={Math.max(1, 4 / Math.sqrt(transform.k))}\n                      className=\"pointer-events-none select-none\"\n                      style={{ textShadow: '0 1px 2px rgba(0,0,0,0.8)' }}\n                    >\n                      {node.name}\n                    </text>\n                  )}\n                </g>\n              );\n            })}\n          </g>\n        </g>\n      </svg>\n    </div>\n  );\n};\n\nexport default NetworkGraph;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/NetworkVisualization.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Filter' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Filter"},"fix":{"range":[94,102],"text":""},"desc":"Remove unused variable \"Filter\"."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'centerNetwork'. Either include it or remove the dependency array.","line":105,"column":6,"nodeType":"ArrayExpression","endLine":105,"endColumn":34,"suggestions":[{"desc":"Update the dependencies array to be: [initialNodes, initialEdges, centerNetwork]","fix":{"range":[3419,3447],"text":"[initialNodes, initialEdges, centerNetwork]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'drawNetwork'. Either include it or remove the dependency array.","line":379,"column":6,"nodeType":"ArrayExpression","endLine":379,"endColumn":79,"suggestions":[{"desc":"Update the dependencies array to be: [filteredNodes, filteredEdges, selectedNodeId, selectedEdgeId, zoom, pan, drawNetwork]","fix":{"range":[11710,11783],"text":"[filteredNodes, filteredEdges, selectedNodeId, selectedEdgeId, zoom, pan, drawNetwork]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef } from 'react';\nimport { Network, FileText, Search, Filter, Download } from 'lucide-react';\n\nexport interface NetworkNode {\n  id: string;\n  type: 'person' | 'document' | 'organization' | 'location' | 'event' | 'evidence';\n  label: string;\n  description?: string;\n  importance: number; // 1-5 scale\n  metadata: {\n    mentions?: number;\n    documents?: string[];\n    connections?: string[];\n    category?: string;\n    riskLevel?: 'low' | 'medium' | 'high' | 'critical';\n    evidenceStrength?: 'weak' | 'moderate' | 'strong' | 'crucial';\n  };\n  position?: { x: number; y: number };\n  color?: string;\n  size?: number;\n}\n\nexport interface NetworkEdge {\n  id: string;\n  source: string;\n  target: string;\n  type: 'connection' | 'communication' | 'financial' | 'legal' | 'family' | 'business' | 'evidence';\n  strength: number; // 1-10 scale\n  direction?: 'unidirectional' | 'bidirectional';\n  metadata: {\n    frequency?: number;\n    dates?: string[];\n    context?: string;\n    evidence?: string[];\n    confidence?: number;\n  };\n}\n\nexport interface NetworkVisualizationProps {\n  nodes: NetworkNode[];\n  edges: NetworkEdge[];\n  onNodeClick?: (node: NetworkNode) => void;\n  onEdgeClick?: (edge: NetworkEdge) => void;\n  selectedNodeId?: string;\n  selectedEdgeId?: string;\n  showFilters?: boolean;\n  showLegend?: boolean;\n  interactive?: boolean;\n  height?: number;\n}\n\nexport const NetworkVisualization: React.FC<NetworkVisualizationProps> = ({\n  nodes: initialNodes,\n  edges: initialEdges,\n  onNodeClick,\n  onEdgeClick,\n  selectedNodeId,\n  selectedEdgeId,\n  showFilters = true,\n  showLegend = true,\n  interactive = true,\n  height = 600,\n}) => {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [nodes, setNodes] = useState<NetworkNode[]>([]);\n  const [edges, setEdges] = useState<NetworkEdge[]>([]);\n  const [filteredNodes, setFilteredNodes] = useState<NetworkNode[]>([]);\n  const [filteredEdges, setFilteredEdges] = useState<NetworkEdge[]>([]);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [filterType, setFilterType] = useState<string>('all');\n  const [filterRisk, setFilterRisk] = useState<string>('all');\n  const [isDragging, setIsDragging] = useState(false);\n  const [dragStart, setDragStart] = useState({ x: 0, y: 0 });\n  const [zoom, setZoom] = useState(1);\n  const [pan, setPan] = useState({ x: 0, y: 0 });\n  const [lastPan, setLastPan] = useState({ x: 0, y: 0 });\n  const [showTableView, setShowTableView] = useState(false);\n\n  // Initialize with force-directed layout\n  useEffect(() => {\n    // Spread nodes more evenly across the canvas initially\n    const spreadNodes = initialNodes.map((node, index) => {\n      const angle = (index / initialNodes.length) * 2 * Math.PI;\n      const radius = 200 + (index % 5) * 50; // Vary radius to create layers\n\n      return {\n        ...node,\n        position: node.position || {\n          x: 400 + Math.cos(angle) * radius,\n          y: 300 + Math.sin(angle) * radius,\n        },\n        color: node.color || getNodeColor(node.type, node.metadata.riskLevel),\n        size: node.size || getNodeSize(node.importance),\n      };\n    });\n\n    setNodes(spreadNodes);\n    setEdges(initialEdges);\n\n    // Apply force-directed layout with more iterations for better spacing\n    applyForceLayout(spreadNodes, initialEdges, 150);\n\n    // Center the network after layout\n    setTimeout(() => centerNetwork(), 1000);\n  }, [initialNodes, initialEdges]);\n\n  // Apply filters\n  useEffect(() => {\n    let filtered = nodes;\n\n    if (searchTerm) {\n      filtered = filtered.filter(\n        (node) =>\n          node.label.toLowerCase().includes(searchTerm.toLowerCase()) ||\n          node.description?.toLowerCase().includes(searchTerm.toLowerCase()),\n      );\n    }\n\n    if (filterType !== 'all') {\n      filtered = filtered.filter((node) => node.type === filterType);\n    }\n\n    if (filterRisk !== 'all') {\n      filtered = filtered.filter((node) => node.metadata.riskLevel === filterRisk);\n    }\n\n    setFilteredNodes(filtered);\n\n    // Filter edges to only show connections between filtered nodes\n    const filteredNodeIds = new Set(filtered.map((n) => n.id));\n    setFilteredEdges(\n      edges.filter((edge) => filteredNodeIds.has(edge.source) && filteredNodeIds.has(edge.target)),\n    );\n  }, [nodes, edges, searchTerm, filterType, filterRisk]);\n\n  const getNodeColor = (type: NetworkNode['type'], riskLevel?: string): string => {\n    const baseColors = {\n      person: '#3b82f6', // Blue\n      document: '#10b981', // Green\n      organization: '#f59e0b', // Amber\n      location: '#8b5cf6', // Purple\n      event: '#ef4444', // Red\n      evidence: '#f97316', // Orange\n    };\n\n    const riskColors: Record<string, string> = {\n      low: '#22c55e', // Green\n      medium: '#eab308', // Yellow\n      high: '#f97316', // Orange\n      critical: '#dc2626', // Red\n    };\n\n    return riskLevel ? riskColors[riskLevel] || baseColors[type] : baseColors[type];\n  };\n\n  const getNodeSize = (importance: number): number => {\n    return 8 + importance * 4; // 12-28px\n  };\n\n  const getEdgeColor = (type: NetworkEdge['type']): string => {\n    const colors = {\n      connection: '#6b7280',\n      communication: '#3b82f6',\n      financial: '#10b981',\n      legal: '#dc2626',\n      family: '#ec4899',\n      business: '#f59e0b',\n      evidence: '#f97316',\n    };\n    return colors[type];\n  };\n\n  const applyForceLayout = (nodes: NetworkNode[], edges: NetworkEdge[], iterations = 150) => {\n    const centerX = 400;\n    const centerY = 300;\n    const repulsionStrength = 3000; // Further increased repulsion to spread nodes further apart\n    const attractionStrength = 0.03; // Further reduced attraction to prevent clustering\n    const damping = 0.9;\n\n    for (let i = 0; i < iterations; i++) {\n      // Apply repulsion between all nodes (increased to spread out more)\n      for (let j = 0; j < nodes.length; j++) {\n        for (let k = j + 1; k < nodes.length; k++) {\n          const nodeA = nodes[j];\n          const nodeB = nodes[k];\n\n          if (!nodeA.position || !nodeB.position) continue;\n\n          const dx = nodeB.position.x - nodeA.position.x;\n          const dy = nodeB.position.y - nodeA.position.y;\n          const distance = Math.sqrt(dx * dx + dy * dy) || 1;\n\n          // Increase minimum distance to prevent overlap\n          const minDistance = (nodeA.size || 12) + (nodeB.size || 12) + 30;\n          const force = (repulsionStrength * 4) / (distance * distance + 1);\n          const fx = (dx / (distance + 1)) * force;\n          const fy = (dy / (distance + 1)) * force;\n\n          nodeA.position.x -= fx;\n          nodeA.position.y -= fy;\n          nodeB.position.x += fx;\n          nodeB.position.y += fy;\n\n          // Additional separation if nodes are too close\n          if (distance < minDistance) {\n            const separationX = (dx / (distance + 1)) * (minDistance - distance);\n            const separationY = (dy / (distance + 1)) * (minDistance - distance);\n            nodeA.position.x -= separationX * 0.7;\n            nodeA.position.y -= separationY * 0.7;\n            nodeB.position.x += separationX * 0.7;\n            nodeB.position.y += separationY * 0.7;\n          }\n        }\n      }\n\n      // Apply attraction for connected nodes\n      edges.forEach((edge) => {\n        const source = nodes.find((n) => n.id === edge.source);\n        const target = nodes.find((n) => n.id === edge.target);\n\n        if (!source?.position || !target?.position) return;\n\n        const dx = target.position.x - source.position.x;\n        const dy = target.position.y - source.position.y;\n        const distance = Math.sqrt(dx * dx + dy * dy) || 1;\n\n        // Reduce attraction strength to prevent tight clustering\n        const force = attractionStrength * distance * edge.strength * 0.3;\n        const fx = (dx / (distance + 1)) * force;\n        const fy = (dy / (distance + 1)) * force;\n\n        source.position.x += fx;\n        source.position.y += fy;\n        target.position.x -= fx;\n        target.position.y -= fy;\n      });\n\n      // Apply center gravity\n      nodes.forEach((node) => {\n        if (!node.position) return;\n\n        const dx = centerX - node.position.x;\n        const dy = centerY - node.position.y;\n\n        node.position.x += dx * 0.003; // Further reduced center gravity\n        node.position.y += dy * 0.003;\n      });\n\n      // Apply damping\n      nodes.forEach((node) => {\n        if (!node.position) return;\n\n        // Simulate velocity damping (simplified)\n        const dx = node.position.x - centerX;\n        const dy = node.position.y - centerY;\n\n        node.position.x = centerX + dx * damping;\n        node.position.y = centerY + dy * damping;\n      });\n    }\n  };\n\n  const drawNetwork = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext('2d');\n    if (!ctx) return;\n\n    // Clear canvas\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n    // Apply zoom and pan\n    ctx.save();\n    ctx.translate(pan.x, pan.y);\n    ctx.scale(zoom, zoom);\n\n    // Draw edges\n    filteredEdges.forEach((edge) => {\n      const source = filteredNodes.find((n) => n.id === edge.source);\n      const target = filteredNodes.find((n) => n.id === edge.target);\n\n      if (!source?.position || !target?.position) return;\n\n      ctx.beginPath();\n      ctx.moveTo(source.position.x, source.position.y);\n      ctx.lineTo(target.position.x, target.position.y);\n\n      ctx.strokeStyle = getEdgeColor(edge.type);\n      ctx.lineWidth = edge.strength;\n      ctx.globalAlpha = 0.6;\n\n      if (edge.direction === 'bidirectional') {\n        ctx.setLineDash([]);\n      } else {\n        ctx.setLineDash([5, 5]);\n      }\n\n      ctx.stroke();\n      ctx.setLineDash([]);\n      ctx.globalAlpha = 1;\n\n      // Draw edge strength indicator\n      const midX = (source.position.x + target.position.x) / 2;\n      const midY = (source.position.y + target.position.y) / 2;\n\n      ctx.fillStyle = '#ffffff';\n      ctx.font = '12px sans-serif';\n      ctx.textAlign = 'center';\n      ctx.fillText(edge.strength.toString(), midX, midY - 5);\n    });\n\n    // Draw nodes\n    filteredNodes.forEach((node) => {\n      if (!node.position) return;\n\n      const isSelected = node.id === selectedNodeId;\n\n      // Draw node circle\n      ctx.beginPath();\n      ctx.arc(node.position.x, node.position.y, node.size || 12, 0, 2 * Math.PI);\n\n      ctx.fillStyle = node.color || '#3b82f6';\n      ctx.fill();\n\n      if (isSelected) {\n        ctx.strokeStyle = '#ffffff';\n        ctx.lineWidth = 3;\n        ctx.stroke();\n      }\n\n      // Draw node icon\n      ctx.fillStyle = '#ffffff';\n      ctx.font = '14px sans-serif';\n      ctx.textAlign = 'center';\n      ctx.textBaseline = 'middle';\n\n      const icon = getNodeIcon(node.type);\n      ctx.fillText(icon, node.position.x, node.position.y);\n\n      // Draw node label\n      ctx.fillStyle = '#ffffff';\n      ctx.font = '12px sans-serif';\n      ctx.textAlign = 'center';\n      ctx.fillText(node.label, node.position.x, node.position.y + (node.size || 12) + 15);\n\n      // Draw importance indicator\n      if (node.importance > 3) {\n        ctx.beginPath();\n        ctx.arc(\n          node.position.x + (node.size || 12) - 3,\n          node.position.y - (node.size || 12) + 3,\n          3,\n          0,\n          2 * Math.PI,\n        );\n        ctx.fillStyle = '#fbbf24';\n        ctx.fill();\n      }\n    });\n\n    ctx.restore();\n  };\n\n  const getNodeIcon = (type: NetworkNode['type']): string => {\n    const icons = {\n      person: '👤',\n      document: '📄',\n      organization: '🏢',\n      location: '📍',\n      event: '📅',\n      evidence: '🔍',\n    };\n    return icons[type];\n  };\n\n  useEffect(() => {\n    drawNetwork();\n  }, [filteredNodes, filteredEdges, selectedNodeId, selectedEdgeId, zoom, pan]);\n\n  const handleCanvasClick = (event: React.MouseEvent<HTMLCanvasElement>) => {\n    if (!interactive) return;\n\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const rect = canvas.getBoundingClientRect();\n    const scaleX = canvas.width / rect.width;\n    const scaleY = canvas.height / rect.height;\n\n    const x = ((event.clientX - rect.left) * scaleX - pan.x) / zoom;\n    const y = ((event.clientY - rect.top) * scaleY - pan.y) / zoom;\n\n    // Check if click is on a node\n    const clickedNode = filteredNodes.find((node) => {\n      if (!node.position) return false;\n      const distance = Math.sqrt(\n        Math.pow(x - node.position.x, 2) + Math.pow(y - node.position.y, 2),\n      );\n      return distance <= (node.size || 12);\n    });\n\n    if (clickedNode) {\n      onNodeClick?.(clickedNode);\n      return;\n    }\n\n    // Check if click is on an edge\n    const clickedEdge = filteredEdges.find((edge) => {\n      const source = filteredNodes.find((n) => n.id === edge.source);\n      const target = filteredNodes.find((n) => n.id === edge.target);\n\n      if (!source?.position || !target?.position) return false;\n\n      // Distance from point to line segment\n      const A = x - source.position.x;\n      const B = y - source.position.y;\n      const C = target.position.x - source.position.x;\n      const D = target.position.y - source.position.y;\n\n      const dot = A * C + B * D;\n      const len_sq = C * C + D * D;\n      let param = -1;\n      if (len_sq !== 0)\n        // in case of 0 length line\n        param = dot / len_sq;\n\n      let xx, yy;\n\n      if (param < 0) {\n        xx = source.position.x;\n        yy = source.position.y;\n      } else if (param > 1) {\n        xx = target.position.x;\n        yy = target.position.y;\n      } else {\n        xx = source.position.x + param * C;\n        yy = source.position.y + param * D;\n      }\n\n      const dx = x - xx;\n      const dy = y - yy;\n      const distance = Math.sqrt(dx * dx + dy * dy);\n\n      return distance < 5; // 5px tolerance\n    });\n\n    if (clickedEdge) {\n      onEdgeClick?.(clickedEdge);\n    }\n  };\n\n  // Touch Event Handlers for Mobile Support\n  const handleTouchStart = (event: React.TouchEvent<HTMLCanvasElement>) => {\n    if (!interactive) return;\n    // Prevent scrolling page while panning canvas\n    if (event.cancelable) event.preventDefault();\n\n    if (event.touches.length === 1) {\n      const touch = event.touches[0];\n      setIsDragging(true);\n      setDragStart({ x: touch.clientX, y: touch.clientY });\n      setLastPan({ x: pan.x, y: pan.y });\n    }\n  };\n\n  const handleTouchMove = (event: React.TouchEvent<HTMLCanvasElement>) => {\n    if (!interactive || !isDragging) return;\n    if (event.cancelable) event.preventDefault();\n\n    if (event.touches.length === 1) {\n      const touch = event.touches[0];\n      const deltaX = touch.clientX - dragStart.x; // Drag factor 1:1 on screen pixels\n      const deltaY = touch.clientY - dragStart.y;\n\n      // Need to account for canvas scaling if we want 1:1 visual movement\n      // But typically pan is in logical canvas coords.\n      // If we move finger 100px, we want canvas to shift 100px visually.\n      // So we map screen delta to canvas scale?\n      // current pan is in canvas units.\n      // We want to update canvas units.\n\n      const canvas = canvasRef.current;\n      if (!canvas) return;\n\n      const rect = canvas.getBoundingClientRect();\n      const scaleX = canvas.width / rect.width;\n      const scaleY = canvas.height / rect.height;\n\n      setPan({\n        x: lastPan.x + deltaX * scaleX,\n        y: lastPan.y + deltaY * scaleY,\n      });\n    }\n  };\n\n  const handleTouchEnd = () => {\n    setIsDragging(false);\n  };\n\n  // Enhanced zoom to center on mouse position\n  const handleWheelEnhanced = (event: React.WheelEvent<HTMLCanvasElement>) => {\n    if (!interactive) return;\n\n    event.preventDefault();\n    const delta = event.deltaY > 0 ? 0.9 : 1.1;\n\n    // Get mouse position relative to canvas\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const rect = canvas.getBoundingClientRect();\n    const mouseX = event.clientX - rect.left;\n    const mouseY = event.clientY - rect.top;\n\n    // Scale for internal resolution\n    const scaleX = canvas.width / rect.width;\n    const scaleY = canvas.height / rect.height;\n\n    // Convert screen coordinates to world coordinates\n    const worldMouseX = (mouseX * scaleX - pan.x) / zoom;\n    const worldMouseY = (mouseY * scaleY - pan.y) / zoom;\n\n    // Apply zoom\n    const newZoom = Math.max(0.1, Math.min(3, zoom * delta));\n\n    // Adjust pan to keep mouse position fixed\n    const newPanX = mouseX * scaleX - worldMouseX * newZoom;\n    const newPanY = mouseY * scaleY - worldMouseY * newZoom;\n\n    setZoom(newZoom);\n    setPan({ x: newPanX, y: newPanY });\n  };\n\n  const centerNetwork = () => {\n    if (filteredNodes.length === 0) return;\n\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    // Calculate center of all nodes\n    const bounds = filteredNodes.reduce(\n      (acc, node) => {\n        if (!node.position) return acc;\n        return {\n          minX: Math.min(acc.minX, node.position.x),\n          maxX: Math.max(acc.maxX, node.position.x),\n          minY: Math.min(acc.minY, node.position.y),\n          maxY: Math.max(acc.maxY, node.position.y),\n        };\n      },\n      { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity },\n    );\n\n    const centerX = (bounds.minX + bounds.maxX) / 2;\n    const centerY = (bounds.minY + bounds.maxY) / 2;\n\n    // Center the network on canvas\n    const canvasCenterX = canvas.width / 2;\n    const canvasCenterY = canvas.height / 2;\n\n    setPan({\n      x: canvasCenterX - centerX * zoom,\n      y: canvasCenterY - centerY * zoom,\n    });\n  };\n\n  const handleMouseDown = (event: React.MouseEvent<HTMLCanvasElement>) => {\n    if (!interactive) return;\n\n    setIsDragging(true);\n    setDragStart({ x: event.clientX, y: event.clientY });\n    setLastPan({ x: pan.x, y: pan.y });\n  };\n\n  const handleMouseMove = (event: React.MouseEvent<HTMLCanvasElement>) => {\n    if (!interactive || !isDragging) return;\n\n    const rect = (event.target as HTMLCanvasElement).getBoundingClientRect();\n    const scaleX = (event.target as HTMLCanvasElement).width / rect.width;\n    const scaleY = (event.target as HTMLCanvasElement).height / rect.height;\n\n    const deltaX = (event.clientX - dragStart.x) * scaleX;\n    const deltaY = (event.clientY - dragStart.y) * scaleY;\n\n    setPan({\n      x: lastPan.x + deltaX,\n      y: lastPan.y + deltaY,\n    });\n  };\n\n  const handleMouseUp = () => {\n    setIsDragging(false);\n  };\n\n  const exportNetwork = () => {\n    const data = {\n      nodes: filteredNodes,\n      edges: filteredEdges,\n      exportDate: new Date().toISOString(),\n      totalNodes: nodes.length,\n      totalEdges: edges.length,\n    };\n\n    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `network-analysis-${new Date().toISOString().split('T')[0]}.json`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n  };\n\n  return (\n    <div className=\"bg-slate-900 rounded-xl border border-slate-700/50 overflow-hidden\">\n      {/* Header */}\n      <div className=\"p-4 border-b border-slate-700/50\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <div className=\"flex items-center gap-2\">\n            <Network className=\"w-5 h-5 text-blue-400\" />\n            <h3 className=\"text-lg font-semibold text-white\">Network Analysis</h3>\n            <span className=\"text-xs text-slate-400 bg-slate-800 px-2 py-0.5 rounded-full\">\n              {filteredNodes.length} nodes • {filteredEdges.length} connections\n            </span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <button\n              onClick={exportNetwork}\n              className=\"h-9 w-9 flex items-center justify-center bg-slate-800 border border-slate-600 rounded-lg text-slate-300 hover:text-white hover:bg-slate-700\"\n              title=\"Export Network Data\"\n            >\n              <Download className=\"w-4 h-4\" />\n            </button>\n            <button\n              onClick={() => setShowTableView(!showTableView)}\n              className={`h-9 px-3 flex items-center gap-2 border rounded-lg text-sm font-medium transition-colors ${\n                showTableView\n                  ? 'bg-blue-600 border-blue-500 text-white'\n                  : 'bg-slate-800 border-slate-600 text-slate-300 hover:text-white hover:bg-slate-700'\n              }`}\n            >\n              {showTableView ? <Network className=\"w-4 h-4\" /> : <FileText className=\"w-4 h-4\" />}\n              <span className=\"hidden sm:inline\">{showTableView ? 'Graph' : 'Table'}</span>\n            </button>\n          </div>\n        </div>\n\n        {/* Filters */}\n        {showFilters && (\n          <div className=\"flex flex-wrap gap-2\">\n            <div className=\"relative flex-1 min-w-[150px] max-w-[250px]\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400\" />\n              <input\n                type=\"text\"\n                placeholder=\"Search nodes...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"w-full h-9 pl-9 pr-3 bg-slate-800 border border-slate-600 rounded-lg text-white text-sm focus:outline-none focus:border-blue-500\"\n              />\n            </div>\n            <select\n              value={filterType}\n              onChange={(e) => setFilterType(e.target.value)}\n              className=\"h-9 px-3 bg-slate-800 border border-slate-600 rounded-lg text-white text-sm focus:outline-none focus:border-blue-500\"\n            >\n              <option value=\"all\">All Types</option>\n              <option value=\"person\">People</option>\n              <option value=\"document\">Documents</option>\n              <option value=\"organization\">Organizations</option>\n              <option value=\"location\">Locations</option>\n              <option value=\"event\">Events</option>\n              <option value=\"evidence\">Evidence</option>\n            </select>\n            <select\n              value={filterRisk}\n              onChange={(e) => setFilterRisk(e.target.value)}\n              className=\"h-9 px-3 bg-slate-800 border border-slate-600 rounded-lg text-white text-sm focus:outline-none focus:border-blue-500\"\n            >\n              <option value=\"all\">All Risk</option>\n              <option value=\"low\">Low Risk</option>\n              <option value=\"medium\">Medium Risk</option>\n              <option value=\"high\">High Risk</option>\n              <option value=\"critical\">Critical</option>\n            </select>\n          </div>\n        )}\n      </div>\n\n      {/* Table View (Accessible) */}\n      {showTableView ? (\n        <div\n          className=\"overflow-x-auto p-4 bg-slate-900\"\n          style={{ height: height, overflowY: 'auto' }}\n        >\n          <h4 className=\"text-white font-medium mb-4\">Network Nodes ({filteredNodes.length})</h4>\n          <table className=\"w-full text-left border-collapse mb-8\" aria-label=\"Network Nodes Table\">\n            <thead>\n              <tr className=\"border-b border-gray-700 text-gray-400 text-sm\">\n                <th className=\"p-2\">Name</th>\n                <th className=\"p-2\">Type</th>\n                <th className=\"p-2\">Importance</th>\n                <th className=\"p-2\">Mentions</th>\n                <th className=\"p-2\">Risk Level</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filteredNodes.map((node) => (\n                <tr\n                  key={node.id}\n                  className={`border-b border-gray-800 hover:bg-slate-800 cursor-pointer ${selectedNodeId === node.id ? 'bg-blue-900/30' : ''}`}\n                  onClick={() => onNodeClick?.(node)}\n                  tabIndex={0}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' || e.key === ' ') {\n                      onNodeClick?.(node);\n                    }\n                  }}\n                >\n                  <td className=\"p-2 text-white font-medium\">{node.label}</td>\n                  <td className=\"p-2 text-gray-300 capitalize\">{node.type}</td>\n                  <td className=\"p-2 text-gray-300\">\n                    <div className=\"flex\">\n                      {[...Array(5)].map((_, i) => (\n                        <div\n                          key={i}\n                          className={`w-2 h-2 rounded-full mr-1 ${i < node.importance ? 'bg-blue-500' : 'bg-gray-700'}`}\n                        />\n                      ))}\n                    </div>\n                  </td>\n                  <td className=\"p-2 text-gray-300\">{node.metadata.mentions || 0}</td>\n                  <td className=\"p-2\">\n                    <span\n                      className={`px-2 py-0.5 rounded text-xs font-medium ${\n                        node.metadata.riskLevel === 'critical'\n                          ? 'bg-red-900 text-red-200'\n                          : node.metadata.riskLevel === 'high'\n                            ? 'bg-orange-900 text-orange-200'\n                            : node.metadata.riskLevel === 'medium'\n                              ? 'bg-yellow-900 text-yellow-200'\n                              : 'bg-green-900 text-green-200'\n                      }`}\n                    >\n                      {(node.metadata.riskLevel || 'low').toUpperCase()}\n                    </span>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n\n          <h4 className=\"text-white font-medium mb-4\">\n            Network Connections ({filteredEdges.length})\n          </h4>\n          <table\n            className=\"w-full text-left border-collapse\"\n            aria-label=\"Network Connections Table\"\n          >\n            <thead>\n              <tr className=\"border-b border-gray-700 text-gray-400 text-sm\">\n                <th className=\"p-2\">Source</th>\n                <th className=\"p-2\">Target</th>\n                <th className=\"p-2\">Type</th>\n                <th className=\"p-2\">Strength</th>\n                <th className=\"p-2\">Confidence</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filteredEdges.map((edge) => {\n                const source = nodes.find((n) => n.id === edge.source);\n                const target = nodes.find((n) => n.id === edge.target);\n                return (\n                  <tr\n                    key={edge.id}\n                    className={`border-b border-gray-800 hover:bg-slate-800 cursor-pointer ${selectedEdgeId === edge.id ? 'bg-blue-900/30' : ''}`}\n                    onClick={() => onEdgeClick?.(edge)}\n                    tabIndex={0}\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter' || e.key === ' ') {\n                        onEdgeClick?.(edge);\n                      }\n                    }}\n                  >\n                    <td className=\"p-2 text-white\">{source?.label || edge.source}</td>\n                    <td className=\"p-2 text-white\">{target?.label || edge.target}</td>\n                    <td className=\"p-2 text-gray-300 capitalize\">{edge.type}</td>\n                    <td className=\"p-2 text-gray-300\">{edge.strength}/10</td>\n                    <td className=\"p-2 text-gray-300\">\n                      {Math.round((edge.metadata.confidence || 0) * 100)}%\n                    </td>\n                  </tr>\n                );\n              })}\n            </tbody>\n          </table>\n        </div>\n      ) : (\n        /* Canvas */\n        <div className=\"relative\" style={{ height }}>\n          <canvas\n            ref={canvasRef}\n            width={800}\n            height={height}\n            className=\"w-full h-full cursor-grab active:cursor-grabbing\"\n            onClick={handleCanvasClick}\n            onWheel={handleWheelEnhanced}\n            onMouseDown={handleMouseDown}\n            onMouseMove={handleMouseMove}\n            onMouseUp={handleMouseUp}\n            onMouseLeave={handleMouseUp}\n            onTouchStart={handleTouchStart}\n            onTouchMove={handleTouchMove}\n            onTouchEnd={handleTouchEnd}\n            style={{ maxWidth: '100%', height: 'auto', touchAction: 'none' }}\n            role=\"img\"\n            aria-label={`Network visualization of ${filteredNodes.length} nodes and ${filteredEdges.length} connections. Use mouse wheel to zoom, drag to pan.`}\n          >\n            <p>\n              Your browser does not support the canvas element. This visualization shows connections\n              between entities.\n            </p>\n          </canvas>\n\n          {/* Controls */}\n          {interactive && (\n            <div className=\"absolute top-4 right-4 flex flex-col space-y-2\">\n              <button\n                onClick={() => setZoom((prev) => Math.min(3, prev * 1.2))}\n                className=\"p-2 bg-gray-800 border border-gray-600 rounded-lg text-white hover:bg-gray-700\"\n                title=\"Zoom In\"\n                aria-label=\"Zoom In\"\n              >\n                +\n              </button>\n              <button\n                onClick={() => setZoom((prev) => Math.max(0.1, prev * 0.8))}\n                className=\"p-2 bg-gray-800 border border-gray-600 rounded-lg text-white hover:bg-gray-700\"\n                title=\"Zoom Out\"\n                aria-label=\"Zoom Out\"\n              >\n                -\n              </button>\n              <button\n                onClick={() => {\n                  setZoom(1);\n                  setPan({ x: 0, y: 0 });\n                }}\n                className=\"p-2 bg-gray-800 border border-gray-600 rounded-lg text-white hover:bg-gray-700 text-xs\"\n                title=\"Reset View\"\n                aria-label=\"Reset View\"\n              >\n                Reset\n              </button>\n              <button\n                onClick={centerNetwork}\n                className=\"p-2 bg-gray-800 border border-gray-600 rounded-lg text-white hover:bg-gray-700 text-xs\"\n                title=\"Center Network\"\n                aria-label=\"Center Network\"\n              >\n                Center\n              </button>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Legend */}\n      {showLegend && (\n        <div className=\"p-4 border-t border-gray-700\">\n          <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4\">\n            <div className=\"text-sm\">\n              <div className=\"flex items-center space-x-2 mb-2\">\n                <div className=\"w-3 h-3 bg-blue-500 rounded-full\"></div>\n                <span className=\"text-gray-300\">Person</span>\n              </div>\n            </div>\n            <div className=\"text-sm\">\n              <div className=\"flex items-center space-x-2 mb-2\">\n                <div className=\"w-3 h-3 bg-green-500 rounded-full\"></div>\n                <span className=\"text-gray-300\">Document</span>\n              </div>\n            </div>\n            <div className=\"text-sm\">\n              <div className=\"flex items-center space-x-2 mb-2\">\n                <div className=\"w-3 h-3 bg-amber-500 rounded-full\"></div>\n                <span className=\"text-gray-300\">Organization</span>\n              </div>\n            </div>\n            <div className=\"text-sm\">\n              <div className=\"flex items-center space-x-2 mb-2\">\n                <div className=\"w-3 h-3 bg-purple-500 rounded-full\"></div>\n                <span className=\"text-gray-300\">Location</span>\n              </div>\n            </div>\n            <div className=\"text-sm\">\n              <div className=\"flex items-center space-x-2 mb-2\">\n                <div className=\"w-3 h-3 bg-red-500 rounded-full\"></div>\n                <span className=\"text-gray-300\">Event</span>\n              </div>\n            </div>\n            <div className=\"text-sm\">\n              <div className=\"flex items-center space-x-2 mb-2\">\n                <div className=\"w-3 h-3 bg-orange-500 rounded-full\"></div>\n                <span className=\"text-gray-300\">Evidence</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/PatternRecognitionAI.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/PeopleSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/PersonCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/PersonCardRefined.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/PersonCardSkeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/PhotoBrowser.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isPending' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":193,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":193,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchImages'. Either include it or remove the dependency array.","line":294,"column":6,"nodeType":"ArrayExpression","endLine":303,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [initialized, selectedAlbum, selectedTag, selectedPerson, hasPeopleOnly, sortField, sortOrder, searchQuery, fetchImages]","fix":{"range":[10988,11132],"text":"[initialized, selectedAlbum, selectedTag, selectedPerson, hasPeopleOnly, sortField, sortOrder, searchQuery, fetchImages]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchImages'. Either include it or remove the dependency array.","line":430,"column":6,"nodeType":"ArrayExpression","endLine":443,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [page, loading, hasMore, autoLoading, initialized, selectedAlbum, selectedTag, selectedPerson, hasPeopleOnly, sortField, sortOrder, searchQuery, fetchImages]","fix":{"range":[15488,15685],"text":"[page, loading, hasMore, autoLoading, initialized, selectedAlbum, selectedTag, selectedPerson, hasPeopleOnly, sortField, sortOrder, searchQuery, fetchImages]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchImages'. Either include it or remove the dependency array.","line":456,"column":6,"nodeType":"ArrayExpression","endLine":456,"endColumn":30,"suggestions":[{"desc":"Update the dependencies array to be: [page, loading, hasMore, fetchImages]","fix":{"range":[15996,16020],"text":"[page, loading, hasMore, fetchImages]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'selectAllImages' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":547,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":547,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":830,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":830,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useCallback, useTransition, useRef } from 'react';\nimport { createPortal } from 'react-dom';\nimport {\n  FixedSizeGrid as Grid,\n  FixedSizeList as List,\n  GridChildComponentProps,\n  ListChildComponentProps,\n  areEqual,\n} from 'react-window';\nimport AutoSizer from './AutoSizer';\nimport { MediaImage, Album } from '../types/media.types';\nimport Icon from './Icon';\nimport MediaViewerModal from './MediaViewerModal';\nimport BatchToolbar from './BatchToolbar';\nimport LazyImage from './LazyImage';\nimport { SensitiveContent } from './SensitiveContent';\n\ninterface PhotoBrowserProps {\n  onImageClick?: (image: MediaImage) => void;\n}\n\ntype ViewMode = 'grid' | 'list';\ntype SortField = 'date_added' | 'date_taken' | 'filename' | 'file_size' | 'title';\ntype SortOrder = 'asc' | 'desc';\n\n// --- Virtualized Renderers ---\n\ninterface ItemData {\n  images: MediaImage[];\n  selectedImages: Set<number>;\n  isBatchMode: boolean;\n  onImageClick: (image: MediaImage, index: number, event: React.MouseEvent) => void;\n  onToggleSelection: (imageId: number, index: number, event: React.MouseEvent) => void;\n  columnCount?: number;\n  formatDate: (d: string | undefined | null) => string;\n  formatFileSize: (b: number | string | undefined) => string;\n}\n\nconst GridCell = React.memo(\n  ({ columnIndex, rowIndex, style, data }: GridChildComponentProps<ItemData>) => {\n    const {\n      images,\n      selectedImages,\n      isBatchMode,\n      onImageClick,\n      onToggleSelection,\n      columnCount = 1,\n      formatDate,\n      formatFileSize,\n    } = data;\n    const index = rowIndex * columnCount + columnIndex;\n\n    // Handle empty cells in the last row\n    if (index >= images.length) return null;\n\n    const img = images[index];\n    const isSelected = selectedImages.has(img.id);\n\n    return (\n      <div style={{ ...style, padding: '4px' }}>\n        <button\n          className={`w-full h-full group relative bg-black border rounded-lg overflow-hidden transition-all shadow-lg hover:shadow-cyan-900/20 ${isSelected ? 'border-cyan-500 ring-2 ring-cyan-500/30' : 'border-slate-800 hover:border-cyan-500/50'}`}\n          onClick={(e) => onImageClick(img, index, e)}\n          onKeyDown={(e) => {\n            if (isBatchMode && e.key === 'Enter') {\n              onToggleSelection(img.id, index, e as any);\n            }\n          }}\n          tabIndex={isBatchMode ? 0 : -1}\n        >\n          {/* Selection indicator */}\n          {isBatchMode && (\n            <div className=\"absolute top-2 left-2 w-6 h-6 flex items-center justify-center rounded-full bg-cyan-500 text-white text-xs font-bold z-10\">\n              {isSelected ? '✓' : index + 1}\n            </div>\n          )}\n          <SensitiveContent isSensitive={img.isSensitive} className=\"w-full h-full relative\">\n            <LazyImage\n              src={`/api/media/images/${img.id}/thumbnail?v=${new Date(img.dateModified || img.dateAdded || 0).getTime()}`}\n              alt={img.title}\n              className=\"w-full h-full object-contain bg-slate-900/50\"\n            />\n          </SensitiveContent>\n          {/* Title overlay */}\n          <div className=\"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 to-transparent p-3 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity duration-200\">\n            <div className=\"text-xs text-white font-medium truncate\" title={img.title}>\n              {img.title}\n            </div>\n            <div className=\"text-[10px] text-slate-400 flex justify-between mt-1\">\n              <span>{formatDate(img.dateTaken)}</span>\n              <span>{formatFileSize(img.fileSize)}</span>\n            </div>\n          </div>\n        </button>\n      </div>\n    );\n  },\n  areEqual,\n);\n\nconst ListRow = React.memo(({ index, style, data }: ListChildComponentProps<ItemData>) => {\n  const {\n    images,\n    selectedImages,\n    isBatchMode,\n    onImageClick,\n    onToggleSelection,\n    formatDate,\n    formatFileSize,\n  } = data;\n  const img = images[index];\n  const isSelected = selectedImages.has(img.id);\n\n  return (\n    <div style={style}>\n      <button\n        className={`flex items-center gap-4 p-2 border-b border-slate-800/50 w-full text-left group transition-colors h-full ${isSelected ? 'bg-cyan-900/20 border-cyan-500/30' : 'hover:bg-slate-900'}`}\n        onClick={(e) => onImageClick(img, index, e)}\n        onKeyDown={(e) => {\n          if (isBatchMode && e.key === 'Enter') {\n            onToggleSelection(img.id, index, e as any);\n          }\n        }}\n        tabIndex={isBatchMode ? 0 : -1}\n      >\n        {/* Selection indicator */}\n        {isBatchMode && (\n          <div className=\"w-6 h-6 flex items-center justify-center rounded-full bg-cyan-500 text-white text-xs font-bold mr-2\">\n            {isSelected ? '✓' : index + 1}\n          </div>\n        )}\n        <div className=\"w-12 h-12 bg-black border border-slate-800 rounded flex items-center justify-center shrink-0\">\n          <SensitiveContent isSensitive={img.isSensitive} className=\"w-full h-full\">\n            <LazyImage\n              src={`/api/media/images/${img.id}/thumbnail?v=${new Date(img.dateModified || img.dateAdded || 0).getTime()}`}\n              alt={img.title}\n              className=\"w-full h-full object-contain\"\n            />\n          </SensitiveContent>\n        </div>\n        <div className=\"flex-1 min-w-0\">\n          <div\n            className=\"text-sm text-slate-300 font-medium truncate group-hover:text-cyan-400 transition-colors\"\n            title={img.title}\n          >\n            {img.title}\n          </div>\n          <div className=\"text-xs text-slate-500 truncate\">\n            {img.title !== img.filename ? img.filename : ''}\n          </div>\n        </div>\n\n        <div className=\"w-32 text-xs text-slate-500 text-right shrink-0\">\n          {formatDate(img.dateTaken || img.dateAdded)}\n        </div>\n        <div className=\"w-20 text-xs text-slate-500 text-right shrink-0 font-mono\">\n          {formatFileSize(img.fileSize)}\n        </div>\n      </button>\n    </div>\n  );\n}, areEqual);\n\nexport const PhotoBrowser: React.FC<PhotoBrowserProps> = React.memo(({ onImageClick }) => {\n  const [albums, setAlbums] = useState<Album[]>([]);\n  const [images, setImages] = useState<MediaImage[]>([]);\n  const [selectedAlbum, setSelectedAlbum] = useState<number | null>(null);\n  const [selectedTag, setSelectedTag] = useState<number | null>(null);\n  const [selectedPerson, setSelectedPerson] = useState<number | null>(null);\n  const [viewMode, setViewMode] = useState<ViewMode>('grid');\n  const [sortField, setSortField] = useState<SortField>('date_added');\n  const [sortOrder, setSortOrder] = useState<SortOrder>('desc');\n  const [searchQuery, setSearchQuery] = useState('');\n  const [loading, setLoading] = useState(true);\n  const [viewerStartIndex, setViewerStartIndex] = useState<number | null>(null);\n  const [showAlbumDropdown, setShowAlbumDropdown] = useState(false); // Mobile album dropdown\n  const [hasPeopleOnly, setHasPeopleOnly] = useState(true); // Default to people-linked images\n  const [availableTags, setAvailableTags] = useState<any[]>([]);\n  const [availablePeople, setAvailablePeople] = useState<any[]>([]);\n\n  // Batch selection state\n  const [selectedImages, setSelectedImages] = useState<Set<number>>(new Set());\n  const [lastSelectedIndex, setLastSelectedIndex] = useState<number | null>(null);\n  const [isBatchMode, setIsBatchMode] = useState(false);\n\n  // Undo stack for batch operations\n  const [undoStack, setUndoStack] = useState<\n    Array<{ action: string; imageIds: number[]; prevState: MediaImage[] }>\n  >([]);\n\n  const [page, setPage] = useState(1);\n  const [hasMore, setHasMore] = useState(true);\n  const [isPending, startTransition] = useTransition();\n  const imagesAbortRef = useRef<AbortController | null>(null);\n  const filtersAbortRef = useRef<AbortController | null>(null);\n  const [libraryTotalCount, setLibraryTotalCount] = useState<number>(0);\n  const sentinelRef = useRef<HTMLDivElement | null>(null);\n  const [autoLoading, setAutoLoading] = useState(false);\n  const prefetchRef = useRef<number | null>(null);\n\n  // Track if URL params have been initialized\n  const [initialized, setInitialized] = useState(false);\n\n  // Initialize from URL - runs first\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    const albumId = params.get('albumId');\n    const tagId = params.get('tagId');\n    const personId = params.get('personId');\n    const hasPeople = params.get('hasPeople');\n\n    if (albumId) setSelectedAlbum(parseInt(albumId));\n    if (tagId) setSelectedTag(parseInt(tagId));\n    if (personId) setSelectedPerson(parseInt(personId));\n    if (hasPeople === 'true') setHasPeopleOnly(true);\n\n    // Mark as initialized after URL params are processed\n    setInitialized(true);\n  }, []);\n\n  // Load available tags\n  useEffect(() => {\n    const loadFilters = async () => {\n      try {\n        filtersAbortRef.current?.abort();\n        filtersAbortRef.current = new AbortController();\n        const tagsRes = await fetch('/api/media/tags', { signal: filtersAbortRef.current.signal });\n        if (tagsRes.ok) {\n          const tags = await tagsRes.json();\n          setAvailableTags(tags);\n        }\n      } catch {\n        void 0;\n      }\n    };\n    loadFilters();\n    return () => {\n      filtersAbortRef.current?.abort();\n    };\n  }, []);\n\n  useEffect(() => {\n    loadAlbums();\n  }, []);\n  useEffect(() => {\n    const loadLibraryTotal = async () => {\n      try {\n        const res = await fetch('/api/media/stats');\n        if (res.ok) {\n          const json = await res.json();\n          if (typeof json?.totalImages === 'number') {\n            setLibraryTotalCount(json.totalImages);\n            return;\n          }\n        }\n        const res2 = await fetch('/api/media/images?page=1&limit=1&slim=true');\n        const totalHeader = res2.headers.get('X-Total-Count');\n        if (totalHeader) setLibraryTotalCount(parseInt(totalHeader) || 0);\n      } catch {\n        // leave default 0\n      }\n    };\n    loadLibraryTotal();\n  }, []);\n\n  // Sync URL with filters\n  useEffect(() => {\n    if (!initialized) return;\n\n    const url = new URL(window.location.href);\n\n    if (selectedAlbum) url.searchParams.set('albumId', selectedAlbum.toString());\n    else url.searchParams.delete('albumId');\n\n    if (selectedTag) url.searchParams.set('tagId', selectedTag.toString());\n    else url.searchParams.delete('tagId');\n\n    if (selectedPerson) url.searchParams.set('personId', selectedPerson.toString());\n    else url.searchParams.delete('personId');\n\n    if (hasPeopleOnly) url.searchParams.set('hasPeople', 'true');\n    else url.searchParams.delete('hasPeople');\n\n    window.history.replaceState({}, '', url);\n  }, [initialized, selectedAlbum, selectedTag, selectedPerson, hasPeopleOnly]);\n\n  // Main data fetch efffect\n  useEffect(() => {\n    if (!initialized) return;\n\n    // Reset to page 1 for any filter change\n    setPage(1);\n    fetchImages(1, false);\n  }, [\n    initialized,\n    selectedAlbum,\n    selectedTag,\n    selectedPerson,\n    hasPeopleOnly,\n    sortField,\n    sortOrder,\n    searchQuery,\n  ]);\n\n  const loadAlbums = async () => {\n    try {\n      const response = await fetch('/api/media/albums');\n      const data = await response.json();\n      if (Array.isArray(data)) {\n        setAlbums(data);\n      } else {\n        console.error('Expected array for albums, got:', data);\n        setAlbums([]);\n      }\n    } catch (error) {\n      console.error('Failed to load albums:', error);\n    }\n  };\n\n  const fetchImages = async (pageNum: number, append: boolean) => {\n    if (append && !hasMore) return;\n\n    // Use startTransition to make loading state non-blocking (allows tab switching)\n    startTransition(() => {\n      setLoading(true);\n    });\n    try {\n      imagesAbortRef.current?.abort();\n      imagesAbortRef.current = new AbortController();\n      const params = new URLSearchParams();\n      if (selectedAlbum) params.append('albumId', selectedAlbum.toString());\n      if (selectedTag) params.append('tagId', selectedTag.toString());\n      if (selectedPerson) params.append('personId', selectedPerson.toString());\n      if (hasPeopleOnly) params.append('hasPeople', 'true');\n      params.append('verificationStatus', 'verified');\n      params.append('minRedFlagRating', '2');\n      params.append('sortField', 'date_added');\n      params.append('sortOrder', 'desc');\n      if (sortField) params.append('sortField', sortField);\n      if (sortOrder) params.append('sortOrder', sortOrder);\n      if (searchQuery) params.append('search', searchQuery);\n\n      // Pagination\n      const limit = 24;\n      params.append('page', pageNum.toString());\n      params.append('limit', limit.toString());\n\n      // Request slim response for faster grid view loading\n      params.append('slim', 'true');\n\n      // Removed cache busting to enable browser caching - thumbnails rarely change\n      const response = await fetch(`/api/media/images?${params}`, {\n        signal: imagesAbortRef.current.signal,\n      });\n      const data = await response.json();\n\n      // Backend now returns consistent camelCase in slim mode - minimal normalization needed\n      const normalized: MediaImage[] = Array.isArray(data)\n        ? data.map((img: any) => ({\n            ...img,\n            isSensitive: Boolean(img.isSensitive),\n            fileSize: img.fileSize || 0,\n          }))\n        : [];\n\n      if (append) {\n        startTransition(() => {\n          setImages((prev) => [...prev, ...normalized]);\n        });\n      } else {\n        startTransition(() => {\n          setImages(normalized);\n        });\n      }\n\n      // Determine if there are more items\n      const totalCountHeader = response.headers.get('X-Total-Count');\n      if (totalCountHeader) {\n        const total = parseInt(totalCountHeader);\n        const currentCount = (pageNum - 1) * limit + normalized.length;\n        setHasMore(currentCount < total);\n      } else {\n        setHasMore(normalized.length === limit);\n      }\n\n      // Check for photoId deep link (only on initial load)\n      if (pageNum === 1) {\n        const urlParams = new URLSearchParams(window.location.search);\n        const photoId = urlParams.get('photoId');\n        if (photoId) {\n          // If the photo is not in the first page, we might miss it.\n          // Ideally, we'd fetch that specific photo or jump to its page.\n          // For now, check if it's in the loaded batch.\n          const index = normalized.findIndex((img) => img.id.toString() === photoId);\n          if (index !== -1) {\n            setViewerStartIndex(index);\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Failed to load images:', error);\n      startTransition(() => {\n        setImages([]);\n      });\n    } finally {\n      // Use startTransition here too to keep UI responsive\n      startTransition(() => {\n        setLoading(false);\n      });\n    }\n  };\n\n  useEffect(() => {\n    const el = sentinelRef.current;\n    if (!el) return;\n    const obs = new IntersectionObserver(\n      (entries) => {\n        const entry = entries[0];\n        if (entry.isIntersecting && !loading && hasMore && !autoLoading) {\n          setAutoLoading(true);\n          const next = page + 1;\n          fetchImages(next, true).finally(() => setAutoLoading(false));\n          setPage(next);\n        }\n      },\n      { root: null, rootMargin: '200px', threshold: 0.1 },\n    );\n    obs.observe(el);\n    return () => obs.disconnect();\n  }, [\n    page,\n    loading,\n    hasMore,\n    autoLoading,\n    initialized,\n    selectedAlbum,\n    selectedTag,\n    selectedPerson,\n    hasPeopleOnly,\n    sortField,\n    sortOrder,\n    searchQuery,\n  ]);\n\n  useEffect(() => {\n    const id = setTimeout(() => {\n      if (!loading && hasMore) {\n        const next = page + 1;\n        if (prefetchRef.current !== next) {\n          prefetchRef.current = next;\n          fetchImages(next, true);\n        }\n      }\n    }, 2000);\n    return () => clearTimeout(id);\n  }, [page, loading, hasMore]);\n\n  // Lazy load people list when dropdown focused\n  const loadPeopleOptions = async () => {\n    try {\n      if (availablePeople.length > 0) return;\n      filtersAbortRef.current?.abort();\n      filtersAbortRef.current = new AbortController();\n      const res = await fetch('/api/entities?page=1&limit=100', {\n        signal: filtersAbortRef.current.signal,\n      });\n      if (res.ok) {\n        const json = await res.json();\n        const data = Array.isArray(json?.data) ? json.data : Array.isArray(json) ? json : [];\n        setAvailablePeople(data.map((p: any) => ({ id: p.id, name: p.fullName || p.name })));\n      }\n    } catch {\n      void 0;\n    }\n  };\n\n  const toggleImageSelection = useCallback(\n    (imageId: number, index: number, event: React.MouseEvent) => {\n      let newSelectedImages = new Set(selectedImages);\n\n      if (event.shiftKey && lastSelectedIndex !== null) {\n        // Shift+click: Select range (add to existing selection)\n        const start = Math.min(lastSelectedIndex, index);\n        const end = Math.max(lastSelectedIndex, index);\n        for (let i = start; i <= end; i++) {\n          newSelectedImages.add(images[i].id);\n        }\n      } else if (event.ctrlKey || event.metaKey) {\n        // Ctrl/Cmd+click: Toggle selection (add/remove from existing)\n        if (newSelectedImages.has(imageId)) {\n          newSelectedImages.delete(imageId);\n        } else {\n          newSelectedImages.add(imageId);\n        }\n        setLastSelectedIndex(index);\n      } else {\n        // Regular click: If in batch mode, deselect all and select only this one\n        if (isBatchMode) {\n          newSelectedImages = new Set([imageId]);\n          setLastSelectedIndex(index);\n        } else {\n          // If external handler provided, use it (legacy), otherwise open viewer\n          if (onImageClick) {\n            onImageClick(images[index]);\n          } else {\n            setViewerStartIndex(index);\n            // URL update handled by MediaViewerModal or here?\n            // MediaViewerModal handles param set.\n          }\n        }\n      }\n\n      setSelectedImages(newSelectedImages);\n    },\n    [selectedImages, lastSelectedIndex, images, isBatchMode, onImageClick],\n  );\n\n  const handleImageClick = useCallback(\n    (image: MediaImage, index: number, event: React.MouseEvent) => {\n      // If in batch mode, handle selection\n      if (isBatchMode) {\n        toggleImageSelection(image.id, index, event);\n      } else {\n        // If external handler provided, use it (legacy), otherwise open viewer\n        if (onImageClick) {\n          onImageClick(image);\n        } else {\n          setViewerStartIndex(index);\n          // URL update handled by MediaViewerModal or here?\n          // MediaViewerModal handles param set.\n        }\n      }\n    },\n    [isBatchMode, toggleImageSelection, onImageClick],\n  );\n\n  const enterBatchMode = () => {\n    setIsBatchMode(true);\n  };\n\n  const exitBatchMode = () => {\n    setIsBatchMode(false);\n    setSelectedImages(new Set());\n    setLastSelectedIndex(null);\n  };\n\n  const selectAllImages = () => {\n    const allImageIds = new Set(images.map((img) => img.id));\n    setSelectedImages(allImageIds);\n  };\n\n  const clearSelection = () => {\n    setSelectedImages(new Set());\n    setLastSelectedIndex(null);\n  };\n\n  const [showCopied, setShowCopied] = useState(false);\n  const handleShare = () => {\n    navigator.clipboard.writeText(window.location.href).then(() => {\n      setShowCopied(true);\n      setTimeout(() => setShowCopied(false), 2000);\n    });\n  };\n\n  // Handle grid container click (for click-outside-to-deselect)\n  const handleGridClick = (e: React.MouseEvent<HTMLDivElement>) => {\n    // Only clear selection if in batch mode and clicked directly on the grid container (not an image)\n    if (isBatchMode && e.target === e.currentTarget) {\n      clearSelection();\n    }\n  };\n\n  // Undo the last batch operation\n  const handleUndo = () => {\n    if (undoStack.length === 0) return;\n\n    const lastAction = undoStack[undoStack.length - 1];\n\n    // Restore previous state\n    const updatedImages = [...images];\n    for (const prevImg of lastAction.prevState) {\n      const index = updatedImages.findIndex((img) => img.id === prevImg.id);\n      if (index !== -1) {\n        updatedImages[index] = prevImg;\n      }\n    }\n    setImages(updatedImages);\n\n    // Remove from undo stack\n    setUndoStack((prev) => prev.slice(0, -1));\n\n    console.log(`Undid ${lastAction.action} on ${lastAction.imageIds.length} images`);\n  };\n\n  const handleBatchRotate = async (direction: 'left' | 'right') => {\n    if (selectedImages.size === 0) return;\n\n    // Save state for undo\n    const affectedImageIds = Array.from(selectedImages);\n    const prevState = images.filter((img) => selectedImages.has(img.id)).map((img) => ({ ...img }));\n\n    try {\n      const response = await fetch('/api/media/images/batch/rotate', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          imageIds: affectedImageIds,\n          direction,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to batch rotate images');\n      }\n\n      const { results } = await response.json();\n\n      // Push to undo stack\n      setUndoStack((prev) => [\n        ...prev.slice(-9),\n        { action: `rotate-${direction}`, imageIds: affectedImageIds, prevState },\n      ]);\n\n      // Update images with rotated versions\n      const updatedImages = [...images];\n      for (const result of results) {\n        if (result.success) {\n          const index = updatedImages.findIndex((img) => img.id === result.id);\n          if (index !== -1) {\n            // Normalize backend response to match frontend model\n            const raw = result.image;\n            const normalizedUpdate = {\n              ...raw,\n              dateModified: raw.date_modified || raw.dateModified,\n              width: raw.width,\n              height: raw.height,\n              orientation: raw.orientation,\n            };\n            updatedImages[index] = { ...updatedImages[index], ...normalizedUpdate };\n          }\n        }\n      }\n      setImages(updatedImages);\n\n      // Show success message\n      console.log(`Successfully rotated ${results.filter((r: any) => r.success).length} images`);\n    } catch (error) {\n      console.error('Error batch rotating images:', error);\n      alert('Failed to rotate images');\n    }\n  };\n\n  const handleBatchRate = async (rating: number) => {\n    if (selectedImages.size === 0) return;\n\n    try {\n      const response = await fetch('/api/media/images/batch/rate', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          imageIds: Array.from(selectedImages),\n          rating,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to batch rate images');\n      }\n\n      const { results } = await response.json();\n\n      // Update images with new ratings\n      const updatedImages = [...images];\n      for (const result of results) {\n        if (result.success) {\n          const index = updatedImages.findIndex((img) => img.id === result.id);\n          if (index !== -1) {\n            updatedImages[index] = { ...updatedImages[index], rating };\n          }\n        }\n      }\n      setImages(updatedImages);\n\n      // Show success message\n      console.log(`Successfully tagged ${results.filter((r: any) => r.success).length} images`);\n    } catch (error) {\n      console.error('Error batch rating images:', error);\n      alert('Failed to rate images');\n    }\n  };\n\n  const handleBatchTag = async (tagIds: number[], action: 'add' | 'remove') => {\n    if (selectedImages.size === 0) return;\n\n    try {\n      const response = await fetch('/api/media/images/batch/tags', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          imageIds: Array.from(selectedImages),\n          tagIds,\n          action,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(`Failed to batch ${action} tags`);\n      }\n\n      const { results } = await response.json();\n\n      // For simplicity, we're not updating the UI with tag changes\n      // In a real implementation, we might want to refetch tags for affected images\n\n      // Show success message\n      console.log(\n        `Successfully ${action}ed tags to ${results.filter((r: any) => r.success).length} images`,\n      );\n    } catch (error) {\n      console.error(`Error batch ${action}ing tags:`, error);\n      alert(`Failed to ${action} tags`);\n    }\n  };\n\n  const handleBatchPeople = async (entityIds: number[], action: 'add' | 'remove') => {\n    if (selectedImages.size === 0) return;\n\n    try {\n      const response = await fetch('/api/media/images/batch/people', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          imageIds: Array.from(selectedImages),\n          entityIds,\n          action,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(`Failed to batch ${action} people`);\n      }\n\n      const { results } = await response.json();\n\n      // For simplicity, we're not updating the UI with people changes\n      // In a real implementation, we might want to refetch people for affected images\n\n      // Show success message\n      console.log(\n        `Successfully tagged people for ${results.filter((r: any) => r.success).length} images`,\n      );\n    } catch (error) {\n      console.error(`Error batch ${action}ing people:`, error);\n      alert(`Failed to ${action} people`);\n    }\n  };\n\n  const handleBatchMetadata = async (updates: { title?: string; description?: string }) => {\n    if (selectedImages.size === 0) return;\n\n    try {\n      const response = await fetch('/api/media/images/batch/metadata', {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          imageIds: Array.from(selectedImages),\n          updates,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to batch update metadata');\n      }\n\n      const { results } = await response.json();\n\n      // Update images with new metadata\n      const updatedImages = [...images];\n      for (const result of results) {\n        if (result.success) {\n          const index = updatedImages.findIndex((img) => img.id === result.id);\n          if (index !== -1) {\n            updatedImages[index] = { ...updatedImages[index], ...updates };\n          }\n        }\n      }\n      setImages(updatedImages);\n\n      // Show success message\n      console.log(\n        `Successfully updated metadata for ${results.filter((r: any) => r.success).length} images`,\n      );\n    } catch (error) {\n      console.error('Error batch updating metadata:', error);\n      alert('Failed to update metadata');\n    }\n  };\n\n  // Memoize formatters to prevent recreation on every render (performance optimization)\n  const formatFileSize = useCallback((bytes: number | string | undefined): string => {\n    const numBytes = Number(bytes);\n    if (bytes === undefined || bytes === null || bytes === '' || !Number.isFinite(numBytes))\n      return 'Unknown';\n    if (numBytes === 0) return '0 B';\n    if (numBytes < 1024) return `${numBytes} B`;\n    if (numBytes < 1024 * 1024) return `${(numBytes / 1024).toFixed(1)} KB`;\n    return `${(numBytes / (1024 * 1024)).toFixed(1)} MB`;\n  }, []);\n\n  const formatDate = useCallback((dateString: string | undefined | null): string => {\n    if (!dateString) return 'Unknown';\n    try {\n      const date = new Date(dateString);\n      if (isNaN(date.getTime())) return 'Unknown';\n      return date.toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'short',\n        day: 'numeric',\n      });\n    } catch (e) {\n      return 'Unknown';\n    }\n  }, []);\n\n  const handleCloseViewer = () => {\n    setViewerStartIndex(null);\n    const url = new URL(window.location.href);\n    url.searchParams.delete('photoId');\n    window.history.replaceState({}, '', url);\n  };\n\n  return (\n    <div className=\"flex flex-col h-full min-h-[500px] bg-slate-950 border border-slate-800 shadow-2xl overflow-hidden rounded-lg\">\n      {/* Header with controls */}\n      <div className=\"bg-slate-900 border-b border-slate-800 flex flex-col md:flex-row md:items-center justify-between px-3 py-2 md:px-4 md:h-14 shrink-0 z-10 gap-2\">\n        {/* Mobile Album Dropdown */}\n        <div className=\"md:hidden\">\n          <button\n            onClick={() => setShowAlbumDropdown(!showAlbumDropdown)}\n            className=\"w-full flex items-center justify-between px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm h-8\"\n          >\n            <span className=\"flex items-center gap-2\">\n              <Icon name=\"Folder\" size=\"sm\" />\n              {selectedAlbum ? albums.find((a) => a.id === selectedAlbum)?.name : 'All Photos'}\n            </span>\n            <Icon name={showAlbumDropdown ? 'ChevronUp' : 'ChevronDown'} size=\"sm\" />\n          </button>\n          {showAlbumDropdown && (\n            <div className=\"absolute left-3 right-3 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-30 max-h-60 overflow-y-auto\">\n              <button\n                className={`w-full px-4 py-3 text-left text-sm flex items-center justify-between ${selectedAlbum === null ? 'bg-cyan-900/20 text-cyan-400' : 'text-slate-300 hover:bg-slate-700'}`}\n                onClick={() => {\n                  setSelectedAlbum(null);\n                  setShowAlbumDropdown(false);\n                }}\n              >\n                <span>All Photos</span>\n                <span className=\"text-xs opacity-70\">{libraryTotalCount}</span>\n              </button>\n              {albums.map((album) => (\n                <button\n                  key={album.id}\n                  className={`w-full px-4 py-3 text-left text-sm flex items-center justify-between border-t border-slate-700/50 ${selectedAlbum === album.id ? 'bg-cyan-900/20 text-cyan-400' : 'text-slate-300 hover:bg-slate-700'}`}\n                  onClick={() => {\n                    setSelectedAlbum(album.id);\n                    setShowAlbumDropdown(false);\n                  }}\n                >\n                  <span className=\"truncate\">{album.name}</span>\n                  <span className=\"text-xs opacity-70\">{album.imageCount || 0}</span>\n                </button>\n              ))}\n            </div>\n          )}\n        </div>\n\n        {/* Search - Smaller on mobile */}\n        <div className=\"w-full md:w-64 flex gap-2\">\n          <div className=\"relative flex-1\">\n            <Icon\n              name=\"Search\"\n              size=\"sm\"\n              className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none\"\n            />\n            <input\n              type=\"text\"\n              placeholder=\"Search images...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"w-full bg-slate-800 border border-slate-700 rounded-lg text-slate-200 pl-9 pr-3 py-2 md:py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500 placeholder-slate-500 transition-all h-8\"\n            />\n          </div>\n          {/* Mobile share button */}\n          <button\n            onClick={handleShare}\n            className=\"md:hidden flex items-center justify-center w-10 bg-slate-800 border border-slate-700 rounded-lg text-slate-400 hover:text-white h-8\"\n          >\n            {showCopied ? (\n              <Icon name=\"Check\" size=\"sm\" className=\"text-green-500\" />\n            ) : (\n              <Icon name=\"Share2\" size=\"sm\" />\n            )}\n          </button>\n        </div>\n\n        {/* Desktop Sort and View Controls - Hidden on mobile */}\n        <div className=\"hidden md:flex items-center gap-3\">\n          <button\n            onClick={handleShare}\n            className=\"flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white border border-slate-700 rounded text-xs transition-colors h-8\"\n          >\n            {showCopied ? (\n              <Icon name=\"Check\" size=\"sm\" className=\"text-green-500\" />\n            ) : (\n              <Icon name=\"Share2\" size=\"sm\" />\n            )}\n            Share\n          </button>\n\n          {/* Filters */}\n          <div className=\"flex items-center gap-2\">\n            <select\n              value={selectedTag || ''}\n              onChange={(e) => setSelectedTag(e.target.value ? parseInt(e.target.value) : null)}\n              className=\"bg-slate-800 border border-slate-700 rounded text-slate-300 text-xs px-2 py-1 focus:outline-none focus:border-cyan-500 h-8 max-w-[100px]\"\n            >\n              <option value=\"\">All Tags</option>\n              {availableTags.map((tag) => (\n                <option key={tag.id} value={tag.id}>\n                  {tag.name}\n                </option>\n              ))}\n            </select>\n\n            <select\n              value={selectedPerson || ''}\n              onChange={(e) => setSelectedPerson(e.target.value ? parseInt(e.target.value) : null)}\n              onFocus={loadPeopleOptions}\n              className=\"bg-slate-800 border border-slate-700 rounded text-slate-300 text-xs px-2 py-1 focus:outline-none focus:border-cyan-500 h-8 max-w-[100px]\"\n            >\n              <option value=\"\">All People</option>\n              {availablePeople.map((p) => (\n                <option key={p.id} value={p.id}>\n                  {p.name}\n                </option>\n              ))}\n            </select>\n\n            <button\n              onClick={() => setHasPeopleOnly(!hasPeopleOnly)}\n              className={`flex items-center gap-2 px-3 py-1.5 border rounded text-xs transition-colors h-8 ${hasPeopleOnly ? 'bg-cyan-900/50 border-cyan-500 text-cyan-400' : 'bg-slate-800 border-slate-700 text-slate-300 hover:text-white'}`}\n              title=\"Show only images with people\"\n            >\n              <Icon name=\"Users\" size=\"sm\" />\n            </button>\n          </div>\n\n          <div className=\"w-px h-6 bg-slate-700 mx-1\"></div>\n\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-xs text-slate-500 font-medium\">Sort by:</span>\n            <select\n              value={sortField}\n              onChange={(e) => setSortField(e.target.value as SortField)}\n              className=\"bg-slate-800 border border-slate-700 rounded text-slate-300 text-xs px-2 py-1 focus:outline-none focus:border-cyan-500 h-8\"\n            >\n              <option value=\"date_added\">Date Added</option>\n              <option value=\"date_taken\">Date Taken</option>\n              <option value=\"filename\">Name</option>\n              <option value=\"file_size\">Size</option>\n              <option value=\"title\">Title</option>\n            </select>\n          </div>\n\n          <button\n            onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}\n            className=\"w-8 h-8 flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white border border-slate-700 rounded transition-colors\"\n            title={sortOrder === 'asc' ? 'Ascending' : 'Descending'}\n          >\n            <Icon name={sortOrder === 'asc' ? 'ArrowUp' : 'ArrowDown'} size=\"sm\" />\n          </button>\n\n          <div className=\"flex bg-slate-800 p-0.5 rounded border border-slate-700 h-8\">\n            <button\n              className={`w-8 h-full flex items-center justify-center rounded ${viewMode === 'grid' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-white'}`}\n              onClick={() => setViewMode('grid')}\n              title=\"Grid View\"\n            >\n              <Icon name=\"Grid\" size=\"sm\" />\n            </button>\n            <button\n              className={`w-8 h-full flex items-center justify-center rounded ${viewMode === 'list' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-white'}`}\n              onClick={() => setViewMode('list')}\n              title=\"List View\"\n            >\n              <Icon name=\"List\" size=\"sm\" />\n            </button>\n          </div>\n\n          {/* Batch Mode Toggle */}\n          <button\n            onClick={isBatchMode ? exitBatchMode : enterBatchMode}\n            className={`flex items-center gap-2 px-3 py-1.5 rounded text-xs font-medium transition-colors ${isBatchMode ? 'bg-cyan-600 hover:bg-cyan-500 text-white' : 'bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white border border-slate-700'} h-8`}\n          >\n            <Icon name=\"CheckSquare\" size=\"sm\" />\n            {isBatchMode ? 'Exit Batch Mode' : 'Batch Edit'}\n          </button>\n        </div>\n      </div>\n\n      <div className=\"flex flex-1 overflow-hidden relative\">\n        {/* Albums sidebar - Hidden on mobile */}\n        <aside className=\"hidden md:flex w-60 bg-slate-900 border-r border-slate-800 flex-col shrink-0\">\n          <h3 className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3\">\n            Albums\n          </h3>\n          <div className=\"flex-1 overflow-y-auto\">\n            <button\n              className={`w-full px-4 py-2 text-left text-sm flex items-center justify-between transition-colors ${selectedAlbum === null ? 'bg-cyan-900/20 text-cyan-400 border-l-2 border-cyan-400' : 'text-slate-400 hover:bg-slate-800 hover:text-white border-l-2 border-transparent'}`}\n              onClick={() => setSelectedAlbum(null)}\n            >\n              <span className=\"truncate\">All Photos</span>\n              <span className=\"text-xs opacity-70 bg-slate-800 px-1.5 py-0.5 rounded-full\">\n                {libraryTotalCount}\n              </span>\n            </button>\n            {albums.map((album) => (\n              <button\n                key={album.id}\n                className={`w-full px-4 py-2 text-left text-sm flex items-center justify-between transition-colors ${selectedAlbum === album.id ? 'bg-cyan-900/20 text-cyan-400 border-l-2 border-cyan-400' : 'text-slate-400 hover:bg-slate-800 hover:text-white border-l-2 border-transparent'}`}\n                onClick={() => setSelectedAlbum(album.id)}\n                title={album.name}\n              >\n                <span className=\"truncate\">{album.name}</span>\n                <span className=\"text-xs opacity-70 bg-slate-800 px-1.5 py-0.5 rounded-full\">\n                  {album.imageCount || 0}\n                </span>\n              </button>\n            ))}\n          </div>\n        </aside>\n\n        {/* Main Content */}\n        <div className=\"flex-1 bg-slate-950 flex flex-col overflow-hidden relative\">\n          {loading ? (\n            <div className=\"absolute inset-0 flex items-center justify-center z-20 bg-slate-950/50 backdrop-blur-sm pointer-events-none\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-cyan-500\"></div>\n            </div>\n          ) : null}\n\n          {/* Warning Banner for Fake/Unconfirmed Albums */}\n          {selectedAlbum &&\n            albums.find((a) => a.id === selectedAlbum)?.name.match(/Fake|Unconfirmed/i) && (\n              <div className=\"bg-red-900/80 border-b border-red-700 px-4 py-3 flex items-start gap-3\">\n                <Icon name=\"AlertTriangle\" className=\"text-red-400 shrink-0 mt-0.5\" />\n                <div>\n                  <h4 className=\"text-red-200 font-bold text-sm uppercase tracking-wider\">\n                    {albums.find((a) => a.id === selectedAlbum)?.name.includes('Fake')\n                      ? 'Confirmed Fake Media'\n                      : 'Unconfirmed / Unverified Content'}\n                  </h4>\n                  <p className=\"text-red-300/90 text-sm mt-1\">\n                    {albums.find((a) => a.id === selectedAlbum)?.name.includes('Fake')\n                      ? 'These images have been confirmed as AI-generated or photoshopped. They are distributed to spread misinformation and discredit survivors. Viewing them may be harmful.'\n                      : 'These images currently lack provenance or verification. Treat with extreme caution as they may be manipulated or out of context.'}\n                  </p>\n                </div>\n              </div>\n            )}\n\n          {/* Active Filters */}\n          {(selectedTag || selectedPerson) && (\n            <div className=\"flex items-center gap-2 px-4 py-2 bg-slate-900 border-b border-slate-800\">\n              <span className=\"text-xs text-slate-500 uppercase tracking-wider font-semibold\">\n                Filtered by:\n              </span>\n\n              {selectedTag && (\n                <button\n                  onClick={() => setSelectedTag(null)}\n                  className=\"flex items-center gap-1.5 px-2 py-0.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-full text-xs transition-colors group\"\n                >\n                  <span>Tag: {selectedTag}</span>\n                  <Icon name=\"X\" size=\"xs\" className=\"text-slate-500 group-hover:text-white\" />\n                </button>\n              )}\n\n              {selectedPerson && (\n                <button\n                  onClick={() => setSelectedPerson(null)}\n                  className=\"flex items-center gap-1.5 px-2 py-0.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-full text-xs transition-colors group\"\n                >\n                  <span>Person: {selectedPerson}</span>\n                  <Icon name=\"X\" size=\"xs\" className=\"text-slate-500 group-hover:text-white\" />\n                </button>\n              )}\n\n              <button\n                onClick={() => {\n                  setSelectedTag(null);\n                  setSelectedPerson(null);\n                }}\n                className=\"text-xs text-slate-500 hover:text-slate-400 ml-auto\"\n              >\n                Clear all\n              </button>\n            </div>\n          )}\n\n          <div\n            className=\"flex-1 min-h-[360px] overflow-hidden relative bg-slate-950\"\n            onClick={handleGridClick}\n          >\n            {!loading && images.length === 0 ? (\n              <div className=\"flex flex-col items-center justify-center h-full text-slate-500\">\n                <Icon name=\"Image\" size=\"lg\" className=\"mb-2 opacity-50\" />\n                <p>No images found</p>\n              </div>\n            ) : (\n              <AutoSizer>\n                {({ width, height }) => {\n                  if (width < 50) return null; // Avoid invalid calculations\n                  if (viewMode === 'grid') {\n                    const minColumnWidth = 200;\n                    const gap = 16; // gap-4\n                    const availableWidth = width - 48; // p-6 equivalent padding\n                    const columnCount = Math.max(\n                      1,\n                      Math.floor((availableWidth + gap) / (minColumnWidth + gap)),\n                    );\n                    const columnWidth = (availableWidth - gap * (columnCount - 1)) / columnCount;\n                    const rowCount = Math.ceil(images.length / columnCount);\n                    // Aspect ratio 3:2 roughly plus padding\n                    const rowHeight = columnWidth / 1.5 + 8;\n\n                    const itemData = {\n                      images,\n                      selectedImages,\n                      isBatchMode,\n                      onImageClick: handleImageClick,\n                      onToggleSelection: toggleImageSelection,\n                      columnCount,\n                      formatDate,\n                      formatFileSize,\n                    };\n\n                    return (\n                      <Grid\n                        columnCount={columnCount}\n                        columnWidth={columnWidth + gap}\n                        height={height}\n                        rowCount={rowCount}\n                        rowHeight={rowHeight + gap}\n                        width={width}\n                        itemData={itemData}\n                        className=\"scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent p-6\"\n                        style={{ overflowX: 'hidden' }}\n                        onItemsRendered={({ visibleRowStopIndex }) => {\n                          const visibleIndex = visibleRowStopIndex * columnCount;\n                          if (visibleIndex >= images.length - 20 && hasMore && !loading) {\n                            const nextPage = page + 1;\n                            setPage(nextPage);\n                            fetchImages(nextPage, true);\n                          }\n                        }}\n                      >\n                        {GridCell}\n                      </Grid>\n                    );\n                  } else {\n                    // List View\n                    const itemData = {\n                      images,\n                      selectedImages,\n                      isBatchMode,\n                      onImageClick: handleImageClick,\n                      onToggleSelection: toggleImageSelection,\n                      formatDate,\n                      formatFileSize,\n                    };\n\n                    return (\n                      <List\n                        height={height}\n                        itemCount={images.length}\n                        itemSize={72} // Height of list item\n                        width={width}\n                        itemData={itemData}\n                        className=\"scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent p-6\"\n                        onItemsRendered={({ visibleStopIndex }) => {\n                          if (visibleStopIndex >= images.length - 10 && hasMore && !loading) {\n                            const nextPage = page + 1;\n                            setPage(nextPage);\n                            fetchImages(nextPage, true);\n                          }\n                        }}\n                      >\n                        {ListRow}\n                      </List>\n                    );\n                  }\n                }}\n              </AutoSizer>\n            )}\n\n            {/* Batch Toolbar - Rendered via Portal for true viewport positioning */}\n            {isBatchMode &&\n              createPortal(\n                <div className=\"fixed bottom-8 left-0 right-0 flex justify-center z-[1000] pointer-events-none\">\n                  <div className=\"mx-4 max-w-[calc(100vw-2rem)] md:max-w-fit pointer-events-auto\">\n                    <BatchToolbar\n                      selectedCount={selectedImages.size}\n                      onRotate={handleBatchRotate}\n                      onAssignTags={(tags) => {\n                        // For now, we'll just add tags\n                        handleBatchTag(tags, 'add');\n                      }}\n                      onAssignPeople={(people) => {\n                        // For now, we'll just add people\n                        handleBatchPeople(people, 'add');\n                      }}\n                      onAssignRating={handleBatchRate}\n                      onEditMetadata={(field, value) => {\n                        // Create updates object based on field\n                        const updates: any = {};\n                        if (field === 'title') {\n                          updates.title = value;\n                        } else if (field === 'description') {\n                          updates.description = value;\n                        }\n                        handleBatchMetadata(updates);\n                      }}\n                      onCancel={exitBatchMode}\n                      onDeselect={clearSelection}\n                      onUndo={handleUndo}\n                      canUndo={undoStack.length > 0}\n                    />\n                  </div>\n                </div>,\n                document.body,\n              )}\n          </div>\n        </div>\n      </div>\n\n      {/* Footer Status Bar */}\n      <div className=\"h-6 bg-slate-900 border-t border-slate-800 flex items-center justify-between px-3 text-[10px] text-slate-500 select-none shrink-0\">\n        <div>{images.length} items</div>\n        <div>{selectedAlbum ? albums.find((a) => a.id === selectedAlbum)?.name : 'All Photos'}</div>\n      </div>\n\n      {/* Full Screen Viewer */}\n      {viewerStartIndex !== null && (\n        <MediaViewerModal\n          images={images}\n          initialIndex={viewerStartIndex}\n          onClose={handleCloseViewer}\n          onImageUpdate={(updatedImage) => {\n            const newImages = [...images];\n            const index = newImages.findIndex((img) => img.id === updatedImage.id);\n            if (index !== -1) {\n              newImages[index] = updatedImage;\n              setImages(newImages);\n            }\n          }}\n        />\n      )}\n      <div ref={sentinelRef} className=\"h-4 w-full\"></div>\n    </div>\n  );\n});\n\nexport default PhotoBrowser;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ProgressBar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/RedFlagIndex.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/RedFlagIndex.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/RedactedLogo.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ReleaseNotesPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ScopedErrorBoundary.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":26,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { Component, ReactNode } from 'react';\nimport { TailoredErrorFallback } from './TailoredErrorFallback';\n\ninterface ScopedErrorBoundaryProps {\n  children: ReactNode;\n  fallback?: ReactNode;\n  onError?: (error: Error) => void;\n  retryLabel?: string;\n}\n\ntype State = { hasError: boolean; error?: Error };\n\nclass ScopedErrorBoundary extends Component<ScopedErrorBoundaryProps, State> {\n  state: State = { hasError: false };\n\n  static getDerivedStateFromError(error: Error) {\n    return { hasError: true, error };\n  }\n\n  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {\n    try {\n      console.error('ScopedErrorBoundary caught an error:', error, errorInfo);\n      if (this.props.onError) {\n        this.props.onError(error);\n      }\n    } catch (e) {\n      // Silently ignore logging errors to prevent infinite loops\n    }\n  }\n\n  handleRetry = () => {\n    this.setState({ hasError: false, error: undefined });\n  };\n\n  handleGoHome = () => {\n    window.location.href = '/';\n  };\n\n  render() {\n    if (this.state.hasError) {\n      // Use custom fallback if provided\n      if (this.props.fallback) {\n        return this.props.fallback;\n      }\n\n      const msg = this.state.error?.message || 'An unexpected error occurred';\n\n      // Determine error type and provide tailored message\n      let errorType: 'network' | 'database' | 'document' | 'generic' = 'generic';\n\n      if (\n        msg.includes('API') ||\n        msg.includes('fetch') ||\n        msg.includes('network') ||\n        msg.includes('Failed to fetch')\n      ) {\n        errorType = 'network';\n      } else if (msg.includes('database') || msg.includes('DB') || msg.includes('SQL')) {\n        errorType = 'database';\n      } else if (msg.includes('document') || msg.includes('file') || msg.includes('not found')) {\n        errorType = 'document';\n      }\n\n      return (\n        <TailoredErrorFallback\n          errorType={errorType}\n          onRetry={this.handleRetry}\n          onGoHome={this.handleGoHome}\n        />\n      );\n    }\n    return this.props.children;\n  }\n}\n\nexport default ScopedErrorBoundary;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/SearchFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/SensitiveContent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/SortFilter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/SourceBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/StatsDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/StatsDisplay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/StatsSkeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/SunburstChart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/TagSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/TailoredErrorFallback.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/Timeline.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/TimelineVisualization.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/TimelineWithFlights.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/ToastProvider.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":19,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":19,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, {\n  createContext,\n  useContext,\n  useState,\n  useCallback,\n  ReactNode,\n  useEffect,\n} from 'react';\n\ntype Toast = {\n  id: string;\n  text: string;\n  type?: 'info' | 'success' | 'error' | 'warning' | 'loading';\n  action?: { label: string; onClick: () => void };\n};\n\nconst ToastCtx = createContext<{ addToast: (t: Omit<Toast, 'id'>) => void } | null>(null);\n\nexport function useToasts() {\n  const ctx = useContext(ToastCtx);\n  if (!ctx) throw new Error('ToastProvider missing');\n  return ctx;\n}\n\nexport default function ToastProvider({ children }: { children: ReactNode }) {\n  const [toasts, setToasts] = useState<Toast[]>([]);\n  const addToast = useCallback((t: Omit<Toast, 'id'>) => {\n    const id = Math.random().toString(36).slice(2);\n    const toast: Toast = { id, text: t.text, type: t.type || 'info', action: t.action };\n    setToasts((prev) => [...prev, toast]);\n\n    // Auto-dismiss logic - don't auto-dismiss loading toasts\n    if (t.type !== 'loading') {\n      setTimeout(() => setToasts((prev) => prev.filter((x) => x.id !== id)), 3500);\n    }\n  }, []);\n\n  const removeToast = useCallback((id: string) => {\n    setToasts((prev) => prev.filter((x) => x.id !== id));\n  }, []);\n\n  useEffect(() => {\n    if (toasts.length > 6) setToasts((prev) => prev.slice(-6));\n  }, [toasts]);\n\n  return (\n    <ToastCtx.Provider value={{ addToast }}>\n      {children}\n      <div className=\"fixed top-3 right-3 z-[100] space-y-2\">\n        {toasts.map((t) => (\n          <div\n            key={t.id}\n            className={`px-3 py-2 rounded-lg text-xs shadow-md border flex items-center justify-between ${t.type === 'success' ? 'bg-emerald-900/70 border-emerald-700 text-emerald-200' : t.type === 'error' ? 'bg-red-900/70 border-red-700 text-red-200' : t.type === 'warning' ? 'bg-yellow-900/70 border-yellow-700 text-yellow-200' : t.type === 'loading' ? 'bg-blue-900/70 border-blue-700 text-blue-200' : 'bg-slate-900/70 border-slate-700 text-slate-200'}`}\n          >\n            <div className=\"flex items-center\">\n              {t.text}\n              {t.type === 'loading' && (\n                <div className=\"ml-2 w-3 h-3 border-2 border-current border-t-transparent rounded-full animate-spin\" />\n              )}\n            </div>\n            {t.action && (\n              <button\n                onClick={() => {\n                  t.action!.onClick();\n                  removeToast(t.id);\n                }}\n                className=\"ml-2 px-2 py-1 text-xs rounded hover:bg-white/10 transition-colors\"\n              >\n                {t.action.label}\n              </button>\n            )}\n            {t.type !== 'loading' && (\n              <button\n                onClick={() => removeToast(t.id)}\n                className=\"ml-2 text-xs hover:text-white/80\"\n              >\n                ×\n              </button>\n            )}\n          </div>\n        ))}\n      </div>\n    </ToastCtx.Provider>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/Tooltip.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'hideTooltip'. Either include it or remove the dependency array.","line":61,"column":6,"nodeType":"ArrayExpression","endLine":61,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [isVisible, delayTimeout, hideTooltip]","fix":{"range":[1541,1566],"text":"[isVisible, delayTimeout, hideTooltip]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\n\ninterface TooltipProps {\n  content: string;\n  children: React.ReactNode;\n  position?: 'top' | 'right' | 'bottom' | 'left' | 'top-end' | 'bottom-end';\n  delay?: number;\n  className?: string;\n}\n\nconst Tooltip: React.FC<TooltipProps> = ({\n  content,\n  children,\n  position = 'top',\n  delay = 500,\n  className = '',\n}) => {\n  const [isVisible, setIsVisible] = useState(false);\n  const [delayTimeout, setDelayTimeout] = useState<NodeJS.Timeout | null>(null);\n  const tooltipRef = useRef<HTMLDivElement>(null);\n  const triggerRef = useRef<HTMLSpanElement>(null);\n\n  const showTooltip = () => {\n    const timeout = setTimeout(() => {\n      setIsVisible(true);\n    }, delay);\n    setDelayTimeout(timeout);\n  };\n\n  const hideTooltip = () => {\n    if (delayTimeout) {\n      clearTimeout(delayTimeout);\n      setDelayTimeout(null);\n    }\n    setIsVisible(false);\n  };\n\n  // Close tooltip when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        tooltipRef.current &&\n        !tooltipRef.current.contains(event.target as Node) &&\n        triggerRef.current &&\n        !triggerRef.current.contains(event.target as Node)\n      ) {\n        hideTooltip();\n      }\n    };\n\n    if (isVisible) {\n      document.addEventListener('mousedown', handleClickOutside);\n    }\n\n    return () => {\n      document.removeEventListener('mousedown', handleClickOutside);\n      if (delayTimeout) {\n        clearTimeout(delayTimeout);\n      }\n    };\n  }, [isVisible, delayTimeout]);\n\n  const getPositionClasses = () => {\n    const baseClasses =\n      'absolute z-[100] px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-lg whitespace-normal min-w-[200px] max-w-[300px]';\n\n    switch (position) {\n      case 'top':\n        return `${baseClasses} bottom-full left-1/2 transform -translate-x-1/2 mb-2`;\n      case 'top-end':\n        return `${baseClasses} bottom-full right-0 mb-2`;\n      case 'right':\n        return `${baseClasses} left-full top-1/2 transform -translate-y-1/2 ml-2`;\n      case 'bottom':\n        return `${baseClasses} top-full left-1/2 transform -translate-x-1/2 mt-2`;\n      case 'bottom-end':\n        return `${baseClasses} top-full right-0 mt-2`;\n      case 'left':\n        return `${baseClasses} right-full top-1/2 transform -translate-y-1/2 mr-2`;\n      default:\n        return `${baseClasses} bottom-full left-1/2 transform -translate-x-1/2 mb-2`;\n    }\n  };\n\n  const getArrowClasses = () => {\n    const baseClasses = 'absolute w-2 h-2 bg-gray-900 rotate-45';\n\n    switch (position) {\n      case 'top':\n        return `${baseClasses} top-full left-1/2 transform -translate-x-1/2 -translate-y-1/2`;\n      case 'top-end':\n        return `${baseClasses} top-full right-3 transform -translate-y-1/2`;\n      case 'right':\n        return `${baseClasses} left-full top-1/2 transform -translate-y-1/2 -translate-x-1/2`;\n      case 'bottom':\n        return `${baseClasses} bottom-full left-1/2 transform -translate-x-1/2 translate-y-1/2`;\n      case 'bottom-end':\n        return `${baseClasses} bottom-full right-3 transform translate-y-1/2`;\n      case 'left':\n        return `${baseClasses} right-full top-1/2 transform -translate-y-1/2 translate-x-1/2`;\n      default:\n        return `${baseClasses} top-full left-1/2 transform -translate-x-1/2 -translate-y-1/2`;\n    }\n  };\n\n  return (\n    <span\n      className={`inline-block relative ${className}`}\n      ref={triggerRef}\n      onMouseEnter={showTooltip}\n      onMouseLeave={hideTooltip}\n      onFocus={showTooltip}\n      onBlur={hideTooltip}\n      aria-describedby=\"tooltip-content\"\n    >\n      {children}\n      {isVisible && (\n        <div ref={tooltipRef} className={getPositionClasses()} role=\"tooltip\" id=\"tooltip-content\">\n          <div className={getArrowClasses()}></div>\n          <div>{content}</div>\n        </div>\n      )}\n    </span>\n  );\n};\n\nexport default Tooltip;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/TreeMap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/UndoManager.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'showNotification'. Either include it or remove the dependency array.","line":102,"column":6,"nodeType":"ArrayExpression","endLine":102,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [showNotification]","fix":{"range":[2811,2813],"text":"[showNotification]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'showNotification'. Either include it or remove the dependency array.","line":118,"column":5,"nodeType":"ArrayExpression","endLine":118,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [showNotification, state.actions]","fix":{"range":[3300,3315],"text":"[showNotification, state.actions]"}}]},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":171,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":171,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useReducer, useCallback, useEffect } from 'react';\n\n// Define types for our undo system\ninterface UndoAction {\n  id: string;\n  description: string;\n  timestamp: number;\n  undo: () => Promise<void> | void;\n}\n\ninterface UndoState {\n  actions: UndoAction[];\n  notification: {\n    message: string;\n    visible: boolean;\n    action?: UndoAction;\n  } | null;\n}\n\ntype UndoActionType =\n  | { type: 'ADD_ACTION'; payload: UndoAction }\n  | { type: 'REMOVE_ACTION'; payload: string }\n  | { type: 'SHOW_NOTIFICATION'; payload: { message: string; action?: UndoAction } }\n  | { type: 'HIDE_NOTIFICATION' }\n  | { type: 'CLEAR_ALL' };\n\n// Create reducer for undo state\nconst undoReducer = (state: UndoState, action: UndoActionType): UndoState => {\n  switch (action.type) {\n    case 'ADD_ACTION':\n      return {\n        ...state,\n        actions: [action.payload, ...state.actions].slice(0, 10), // Keep only last 10 actions\n      };\n    case 'REMOVE_ACTION':\n      return {\n        ...state,\n        actions: state.actions.filter((a) => a.id !== action.payload),\n      };\n    case 'SHOW_NOTIFICATION':\n      return {\n        ...state,\n        notification: {\n          message: action.payload.message,\n          visible: true,\n          action: action.payload.action,\n        },\n      };\n    case 'HIDE_NOTIFICATION':\n      return {\n        ...state,\n        notification: null,\n      };\n    case 'CLEAR_ALL':\n      return {\n        actions: [],\n        notification: null,\n      };\n    default:\n      return state;\n  }\n};\n\n// Create context\nconst UndoContext = createContext<\n  | {\n      state: UndoState;\n      dispatch: React.Dispatch<UndoActionType>;\n      addUndoAction: (action: Omit<UndoAction, 'id' | 'timestamp'>) => void;\n      performUndo: (actionId: string) => Promise<void>;\n      showNotification: (message: string, action?: UndoAction) => void;\n      hideNotification: () => void;\n    }\n  | undefined\n>(undefined);\n\n// Provider component\nexport const UndoProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\n  const [state, dispatch] = useReducer(undoReducer, {\n    actions: [],\n    notification: null,\n  });\n\n  // Hide notification after 5 seconds\n  useEffect(() => {\n    if (state.notification?.visible) {\n      const timer = setTimeout(() => {\n        dispatch({ type: 'HIDE_NOTIFICATION' });\n      }, 5000);\n      return () => clearTimeout(timer);\n    }\n  }, [state.notification]);\n\n  const addUndoAction = useCallback((action: Omit<UndoAction, 'id' | 'timestamp'>) => {\n    const undoAction: UndoAction = {\n      ...action,\n      id: Math.random().toString(36).substr(2, 9),\n      timestamp: Date.now(),\n    };\n    dispatch({ type: 'ADD_ACTION', payload: undoAction });\n    showNotification(`${action.description} completed.`, undoAction);\n  }, []);\n\n  const performUndo = useCallback(\n    async (actionId: string) => {\n      const action = state.actions.find((a) => a.id === actionId);\n      if (action) {\n        try {\n          await action.undo();\n          dispatch({ type: 'REMOVE_ACTION', payload: actionId });\n          showNotification('Action undone successfully.');\n        } catch (error) {\n          showNotification('Failed to undo action.');\n          console.error('Undo failed:', error);\n        }\n      }\n    },\n    [state.actions],\n  );\n\n  const showNotification = useCallback((message: string, action?: UndoAction) => {\n    dispatch({\n      type: 'SHOW_NOTIFICATION',\n      payload: { message, action },\n    });\n  }, []);\n\n  const hideNotification = useCallback(() => {\n    dispatch({ type: 'HIDE_NOTIFICATION' });\n  }, []);\n\n  const value = {\n    state,\n    dispatch,\n    addUndoAction,\n    performUndo,\n    showNotification,\n    hideNotification,\n  };\n\n  return (\n    <UndoContext.Provider value={value}>\n      {children}\n      {state.notification?.visible && (\n        <div className=\"fixed bottom-4 right-4 bg-slate-800 border border-slate-700 rounded-lg p-4 shadow-lg z-50 max-w-md\">\n          <div className=\"flex items-center justify-between\">\n            <p className=\"text-white text-sm\">{state.notification.message}</p>\n            {state.notification.action && (\n              <button\n                onClick={() => performUndo(state.notification!.action!.id)}\n                className=\"ml-4 px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition-colors\"\n              >\n                Undo\n              </button>\n            )}\n            <button\n              onClick={hideNotification}\n              className=\"ml-2 text-slate-400 hover:text-white\"\n              aria-label=\"Close notification\"\n            >\n              ×\n            </button>\n          </div>\n        </div>\n      )}\n    </UndoContext.Provider>\n  );\n};\n\n// Hook to use undo functionality\nexport const useUndo = () => {\n  const context = useContext(UndoContext);\n  if (!context) {\n    throw new Error('useUndo must be used within an UndoProvider');\n  }\n  return context;\n};\n\nexport default UndoProvider;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/VideoBrowser.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'List' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":24,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"List"},"fix":{"range":[114,139],"text":""},"desc":"Remove unused variable \"List\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Film' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Film"},"fix":{"range":[300,308],"text":""},"desc":"Remove unused variable \"Film\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Square' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":9,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Square"},"fix":{"range":[335,345],"text":""},"desc":"Remove unused variable \"Square\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used. Allowed unused vars must match /^_/u.","line":17,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"User"},"fix":{"range":[362,370],"text":""},"desc":"Remove unused variable \"User\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'toggleSelection' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":61,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":61,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pickerOpenId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":153,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":153,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setPickerOpenId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":153,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":153,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'investigationsList' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":154,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":154,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setInvestigationsList' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":154,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":154,"endColumn":51},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'addingId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":155,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":155,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setAddingId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":155,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":155,"endColumn":31},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchVideos'. Either include it or remove the dependency array.","line":194,"column":6,"nodeType":"ArrayExpression","endLine":194,"endColumn":39,"suggestions":[{"desc":"Update the dependencies array to be: [fetchVideos, selectedAlbum, transcriptSearch]","fix":{"range":[6557,6590],"text":"[fetchVideos, selectedAlbum, transcriptSearch]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'toggleSelection' function makes the dependencies of useCallback Hook (at line 317) change on every render. To fix this, wrap the definition of 'toggleSelection' in its own useCallback() Hook.","line":208,"column":9,"nodeType":"VariableDeclarator","endLine":213,"endColumn":4,"suggestions":[{"desc":"Wrap the definition of 'toggleSelection' in its own useCallback() Hook.","fix":{"range":[6948,7110],"text":"useCallback((id: number) => {\n    const newSet = new Set(selectedItems);\n    if (newSet.has(id)) newSet.delete(id);\n    else newSet.add(id);\n    setSelectedItems(newSet);\n  })"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'toggleSelection' function makes the dependencies of useMemo Hook (at line 329) change on every render. To fix this, wrap the definition of 'toggleSelection' in its own useCallback() Hook.","line":208,"column":9,"nodeType":"VariableDeclarator","endLine":213,"endColumn":4,"suggestions":[{"desc":"Wrap the definition of 'toggleSelection' in its own useCallback() Hook.","fix":{"range":[6948,7110],"text":"useCallback((id: number) => {\n    const newSet = new Set(selectedItems);\n    if (newSet.has(id)) newSet.delete(id);\n    else newSet.add(id);\n    setSelectedItems(newSet);\n  })"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'fetchVideos'. Either include it or remove the dependency array.","line":301,"column":6,"nodeType":"ArrayExpression","endLine":301,"endColumn":30,"suggestions":[{"desc":"Update the dependencies array to be: [loading, hasMore, fetchVideos, page]","fix":{"range":[9655,9679],"text":"[loading, hasMore, fetchVideos, page]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used. Allowed unused args must match /^_/u.","line":310,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":310,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":16,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';\nimport {\n  FixedSizeGrid as Grid,\n  FixedSizeList as List,\n  GridChildComponentProps,\n  areEqual,\n} from 'react-window';\nimport AutoSizer from './AutoSizer';\nimport { VideoPlayer } from './VideoPlayer';\nimport {\n  Play,\n  Film,\n  Calendar,\n  CheckSquare,\n  Square,\n  AlertTriangle,\n  User,\n  Clock,\n} from 'lucide-react';\nimport { SensitiveContent } from './SensitiveContent';\nimport BatchToolbar from './BatchToolbar';\nimport Icon from './Icon';\n\ninterface VideoItem {\n  id: number;\n  title: string;\n  description?: string;\n  filePath: string;\n  fileType: string;\n  isSensitive: boolean;\n  albumId?: number;\n  albumName?: string;\n  metadata: {\n    duration?: number;\n    thumbnailPath?: string;\n    transcript?: any[];\n    chapters?: any[];\n    [key: string]: any;\n  };\n  createdAt: string;\n  entityName?: string;\n  entityId?: number;\n  tags?: Array<{ id: number; name: string }>;\n  people?: Array<{ id: number; name: string }>;\n}\n\ninterface Album {\n  id: number;\n  name: string;\n  description?: string;\n  itemCount: number;\n  sensitiveCount?: number;\n}\n\nconst VideoCell = React.memo(({ columnIndex, rowIndex, style, data }: GridChildComponentProps) => {\n  const {\n    items,\n    selectedItems,\n    isBatchMode,\n    onVideoClick,\n    toggleSelection,\n    columnCount,\n    formatDate,\n  } = data as any;\n  const index = rowIndex * columnCount + columnIndex;\n\n  if (index >= items.length) return null;\n\n  const video = items[index];\n  const isSelected = selectedItems.has(video.id);\n\n  return (\n    <div style={{ ...style, padding: '4px' }}>\n      <button\n        className={`w-full h-full group relative bg-slate-900 border rounded-xl overflow-hidden cursor-pointer transition-all duration-300 shadow-lg hover:shadow-blue-500/20 ${\n          isSelected\n            ? 'border-blue-500 ring-2 ring-blue-500/30'\n            : 'border-slate-800 hover:border-slate-700'\n        }`}\n        onClick={() => onVideoClick(video, index)}\n        tabIndex={isBatchMode ? 0 : -1}\n      >\n        <div className=\"aspect-video relative overflow-hidden bg-black\">\n          <SensitiveContent isSensitive={video.isSensitive} className=\"w-full h-full\">\n            <img\n              src={`/api/media/video/${video.id}/thumbnail?v=${new Date(video.createdAt).getTime()}`}\n              alt={video.title}\n              className=\"w-full h-full object-cover transition-transform duration-500 group-hover:scale-110\"\n              loading=\"lazy\"\n              onError={(e) => {\n                (e.target as HTMLImageElement).src =\n                  'https://images.unsplash.com/photo-1626814026160-2237a95fc5a0?w=800&q=80';\n              }}\n            />\n            <div className=\"absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity\">\n              <div className=\"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-xl transform scale-90 group-hover:scale-100 transition-transform\">\n                <Play className=\"text-white fill-white h-6 w-6 ml-1\" />\n              </div>\n            </div>\n          </SensitiveContent>\n\n          {isBatchMode && (\n            <div\n              className={`absolute top-2 left-2 z-10 w-6 h-6 rounded-md border flex items-center justify-center transition-colors ${\n                isSelected ? 'bg-blue-600 border-blue-500' : 'bg-black/50 border-slate-400'\n              }`}\n            >\n              {isSelected && <CheckSquare className=\"h-4 w-4 text-white\" />}\n            </div>\n          )}\n\n          {video.metadata?.duration && (\n            <div className=\"absolute bottom-2 right-2 bg-black/80 px-1.5 py-0.5 rounded text-[10px] text-white font-medium flex items-center gap-1\">\n              <Clock className=\"h-3 w-3\" />\n              {Math.floor(video.metadata.duration / 60)}:\n              {\n                Math.floor(video.metadata.duration % 60)\n                  .toString()\n                  .padStart(2, '0')\n                  .split('.')[0]\n              }\n            </div>\n          )}\n        </div>\n\n        <div className=\"p-3\">\n          <h3 className=\"text-sm font-medium text-slate-100 truncate group-hover:text-blue-400 transition-colors\">\n            {video.title}\n          </h3>\n          <div className=\"flex items-center gap-3 mt-1.5\">\n            <div className=\"text-[10px] text-slate-500 flex items-center gap-1\">\n              <Calendar className=\"h-3 w-3\" />\n              {formatDate(video.createdAt)}\n            </div>\n          </div>\n        </div>\n      </button>\n    </div>\n  );\n}, areEqual);\n\nexport const VideoBrowser: React.FC = () => {\n  const [items, setItems] = useState<VideoItem[]>([]);\n  const [albums, setAlbums] = useState<Album[]>([]);\n  const [selectedAlbum, setSelectedAlbum] = useState<number | null>(null);\n  const [selectedItem, setSelectedItem] = useState<VideoItem | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [page, setPage] = useState(1);\n  const [hasMore, setHasMore] = useState(true);\n  const [showAlbumDropdown, setShowAlbumDropdown] = useState(false);\n  const [libraryTotalCount, setLibraryTotalCount] = useState(0);\n  const [pickerOpenId, setPickerOpenId] = useState<number | null>(null);\n  const [investigationsList, setInvestigationsList] = useState<any[]>([]);\n  const [addingId, setAddingId] = useState<number | null>(null);\n\n  // Transcript search (within album or across all videos)\n  const [transcriptSearch, setTranscriptSearch] = useState('');\n\n  // Batch Mode State\n  const [isBatchMode, setIsBatchMode] = useState(false);\n  const [selectedItems, setSelectedItems] = useState<Set<number>>(new Set());\n\n  const abortControllerRef = useRef<AbortController | null>(null);\n\n  const currentAlbum = useMemo(\n    () => albums.find((a) => a.id === selectedAlbum),\n    [albums, selectedAlbum],\n  );\n\n  // Load albums on mount\n  useEffect(() => {\n    loadAlbums();\n    return () => abortControllerRef.current?.abort();\n  }, []);\n\n  useEffect(() => {\n    const loadTotals = async () => {\n      try {\n        const res = await fetch('/api/media/video?page=1&limit=1');\n        if (res.ok) {\n          const json = await res.json();\n          if (typeof json?.total === 'number') setLibraryTotalCount(json.total);\n        }\n      } catch {\n        void 0;\n      }\n    };\n    loadTotals();\n  }, []);\n  // Load items when album selection or transcript search changes\n  useEffect(() => {\n    fetchVideos(1);\n  }, [selectedAlbum, transcriptSearch]);\n\n  const loadAlbums = async () => {\n    try {\n      const res = await fetch('/api/media/video/albums');\n      if (!res.ok) throw new Error('Failed to load albums');\n      const data = await res.json();\n      setAlbums(data);\n    } catch (err) {\n      console.error('Failed to load albums:', err);\n    }\n  };\n\n  // Batch Handlers\n  const toggleSelection = (id: number) => {\n    const newSet = new Set(selectedItems);\n    if (newSet.has(id)) newSet.delete(id);\n    else newSet.add(id);\n    setSelectedItems(newSet);\n  };\n\n  const handleBatchTag = async (tagIds: number[], action: 'add' | 'remove') => {\n    try {\n      await fetch('/api/media/items/batch/tags', {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ itemIds: Array.from(selectedItems), tagIds, action }),\n      });\n      fetchVideos(1);\n      setSelectedItems(new Set());\n      setIsBatchMode(false);\n    } catch (e) {\n      console.error(e);\n    }\n  };\n\n  const handleBatchPeople = async (personIds: number[]) => {\n    try {\n      await fetch('/api/media/items/batch/people', {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ itemIds: Array.from(selectedItems), personIds, action: 'add' }),\n      });\n      fetchVideos(1);\n      setSelectedItems(new Set());\n      setIsBatchMode(false);\n    } catch (e) {\n      console.error(e);\n    }\n  };\n\n  const fetchVideos = async (pageNum: number) => {\n    try {\n      setLoading(true);\n\n      // Abort previous request\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort();\n      }\n      abortControllerRef.current = new AbortController();\n\n      const params = new URLSearchParams({\n        page: pageNum.toString(),\n        limit: '24',\n      });\n      if (selectedAlbum) params.append('albumId', selectedAlbum.toString());\n      if (transcriptSearch.trim()) params.append('transcriptQuery', transcriptSearch.trim());\n      // Always sort by title as requested\n      params.append('sortBy', 'title');\n\n      const res = await fetch(`/api/media/video?${params}`, {\n        signal: abortControllerRef.current.signal,\n      });\n      if (!res.ok) throw new Error('Failed to load video files');\n\n      const data = await res.json();\n      const newItems = data.mediaItems || [];\n\n      if (pageNum === 1) {\n        setItems(newItems);\n      } else {\n        setItems((prev) => [...prev, ...newItems]);\n      }\n\n      setHasMore(newItems.length === 24);\n      setPage(pageNum);\n    } catch (err) {\n      if (err instanceof Error && err.name === 'AbortError') return;\n      console.error(err);\n      setError('Failed to load video content');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const formatDate = useCallback((dateStr: string) => {\n    return new Date(dateStr).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n    });\n  }, []);\n\n  const loadMoreItems = useCallback(() => {\n    if (!loading && hasMore) {\n      fetchVideos(page + 1);\n    }\n  }, [loading, hasMore, page]);\n\n  const showSensitiveWarning =\n    currentAlbum &&\n    (currentAlbum.name.match(/Sensitive|Disturbing|Testimony|Victim|Survivor/i) ||\n      (currentAlbum.sensitiveCount && currentAlbum.sensitiveCount > 0));\n\n  // Handle video click\n  const handleVideoClick = useCallback(\n    (video: VideoItem, index: number) => {\n      if (isBatchMode) {\n        toggleSelection(video.id);\n      } else {\n        setSelectedItem(video);\n      }\n    },\n    [isBatchMode, toggleSelection],\n  );\n\n  const gridData = useMemo(\n    () => ({\n      items,\n      selectedItems,\n      isBatchMode,\n      onVideoClick: handleVideoClick,\n      toggleSelection,\n      formatDate,\n    }),\n    [items, selectedItems, isBatchMode, handleVideoClick, toggleSelection, formatDate],\n  );\n\n  // Update URL when item or album is selected\n  useEffect(() => {\n    const url = new URL(window.location.href);\n\n    // For video items, we might not be tracking id in URL as strictly or we need to check how VideoBrowser handles item selection via URL.\n    // Assuming we want to track albumId primarily here based on user request \"route when I select album\".\n\n    if (selectedAlbum) {\n      url.searchParams.set('albumId', selectedAlbum.toString());\n    } else {\n      url.searchParams.delete('albumId');\n    }\n\n    // Preserve other params if needed, or push state.\n    window.history.pushState({}, '', url.toString());\n  }, [selectedAlbum]); // Intentionally not tracking selectedItem here unless requested, as Video modal usually manages its own state or overlay.\n\n  return (\n    <div className=\"flex flex-col h-full min-h-[500px] bg-slate-950 border border-slate-800 shadow-2xl overflow-hidden rounded-lg\">\n      {/* Header */}\n      <div className=\"bg-slate-900 border-b border-slate-800 flex flex-col md:flex-row md:items-center justify-between px-3 py-2 md:px-6 md:h-14 shrink-0 z-10 gap-2\">\n        {/* Mobile Album Dropdown */}\n        <div className=\"md:hidden\">\n          <button\n            onClick={() => setShowAlbumDropdown(!showAlbumDropdown)}\n            className=\"w-full flex items-center justify-between px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm h-8\"\n          >\n            <span className=\"flex items-center gap-2\">\n              <Icon name=\"Folder\" size=\"sm\" />\n              {selectedAlbum ? currentAlbum?.name : 'All Videos'}\n            </span>\n            <Icon name={showAlbumDropdown ? 'ChevronUp' : 'ChevronDown'} size=\"sm\" />\n          </button>\n          {showAlbumDropdown && (\n            <div className=\"absolute left-3 right-3 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-30 max-h-60 overflow-y-auto\">\n              <button\n                className={`w-full px-4 py-3 text-left text-sm flex items-center justify-between ${selectedAlbum === null ? 'bg-cyan-900/20 text-cyan-400' : 'text-slate-300 hover:bg-slate-700'}`}\n                onClick={() => {\n                  setSelectedAlbum(null);\n                  setShowAlbumDropdown(false);\n                }}\n              >\n                <span>All Videos</span>\n                <span className=\"text-xs opacity-70\">{libraryTotalCount}</span>\n              </button>\n              {albums.map((album) => (\n                <button\n                  key={album.id}\n                  className={`w-full px-4 py-3 text-left text-sm flex items-center justify-between border-t border-slate-700/50 ${selectedAlbum === album.id ? 'bg-cyan-900/20 text-cyan-400' : 'text-slate-300 hover:bg-slate-700'}`}\n                  onClick={() => {\n                    setSelectedAlbum(album.id);\n                    setShowAlbumDropdown(false);\n                  }}\n                >\n                  <span className=\"truncate\">{album.name}</span>\n                  <span className=\"text-xs opacity-70\">{album.itemCount || 0}</span>\n                </button>\n              ))}\n            </div>\n          )}\n        </div>\n\n        <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-3 flex-1\">\n          <div>\n            <h2 className=\"text-lg font-light text-white\">Video Recordings</h2>\n            <p className=\"text-slate-400 text-xs hidden md:block\">Forensic video evidence</p>\n          </div>\n          <div className=\"flex-1 flex items-center gap-3 justify-end\">\n            {/* Transcript search within current album / all videos */}\n            <div className=\"relative w-full max-w-xs\">\n              <Icon\n                name=\"Search\"\n                size=\"sm\"\n                className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none\"\n              />\n              <input\n                type=\"text\"\n                value={transcriptSearch}\n                onChange={(e) => setTranscriptSearch(e.target.value)}\n                placeholder={\n                  selectedAlbum ? 'Search transcripts in this album…' : 'Search transcripts…'\n                }\n                className=\"w-full bg-slate-800 border border-slate-700 rounded-lg text-slate-200 pl-9 pr-3 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-cyan-500 placeholder-slate-500\"\n              />\n            </div>\n            <span className=\"text-xs text-slate-400 whitespace-nowrap\">\n              {items.length} loaded{libraryTotalCount ? ` / ${libraryTotalCount}` : ''}\n            </span>\n            <button\n              onClick={() => fetchVideos(1)}\n              className=\"px-2 py-1 rounded-lg text-xs bg-slate-800 text-slate-300 hover:text-white border border-slate-700\"\n              title=\"Reload\"\n            >\n              Reload\n            </button>\n          </div>\n          <button\n            onClick={() => setIsBatchMode(!isBatchMode)}\n            className={`px-3 py-1.5 rounded-lg text-xs transition-colors ${isBatchMode ? 'bg-cyan-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white border border-slate-700'}`}\n          >\n            {isBatchMode ? 'Exit Batch' : 'Batch Edit'}\n          </button>\n        </div>\n      </div>\n\n      <div className=\"flex flex-1 overflow-hidden relative\">\n        {/* Albums sidebar - Hidden on mobile */}\n        <aside className=\"hidden md:flex w-60 bg-slate-900 border-r border-slate-800 flex-col shrink-0\">\n          <h3 className=\"text-xs font-semibold text-slate-500 uppercase tracking-wider px-4 py-3\">\n            Albums\n          </h3>\n          <div className=\"flex-1 overflow-y-auto\">\n            <button\n              className={`w-full px-4 py-2 text-left text-sm flex items-center justify-between transition-colors ${selectedAlbum === null ? 'bg-cyan-900/20 text-cyan-400 border-l-2 border-cyan-400' : 'text-slate-400 hover:bg-slate-800 hover:text-white border-l-2 border-transparent'}`}\n              onClick={() => setSelectedAlbum(null)}\n            >\n              <span className=\"truncate\">All Videos</span>\n              <span className=\"text-xs opacity-70 bg-slate-800 px-1.5 py-0.5 rounded-full\">\n                {libraryTotalCount}\n              </span>\n            </button>\n            {albums.map((album) => (\n              <button\n                key={album.id}\n                className={`w-full px-4 py-2 text-left text-sm flex items-center justify-between transition-colors ${selectedAlbum === album.id ? 'bg-cyan-900/20 text-cyan-400 border-l-2 border-cyan-400' : 'text-slate-400 hover:bg-slate-800 hover:text-white border-l-2 border-transparent'}`}\n                onClick={() => setSelectedAlbum(album.id)}\n                title={album.name}\n              >\n                <span className=\"truncate\">{album.name}</span>\n                <span className=\"text-xs opacity-70 bg-slate-800 px-1.5 py-0.5 rounded-full\">\n                  {album.itemCount || 0}\n                </span>\n              </button>\n            ))}\n          </div>\n        </aside>\n\n        {/* Main Content */}\n        <div className=\"flex-1 bg-slate-950 flex flex-col overflow-hidden\">\n          {loading && page === 1 ? (\n            <div className=\"absolute inset-0 flex items-center justify-center z-20 bg-slate-950/50 backdrop-blur-sm\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-cyan-500\"></div>\n            </div>\n          ) : null}\n\n          {/* Sensitive Content Warning Banner */}\n          {showSensitiveWarning && (\n            <div className=\"bg-red-900/80 border-b border-red-700 px-4 py-3 flex items-start gap-3\">\n              <AlertTriangle className=\"text-red-400 shrink-0 mt-0.5\" size={20} />\n              <div>\n                <h4 className=\"text-red-200 font-bold text-sm uppercase tracking-wider\">\n                  Sensitive & Disturbing Content\n                </h4>\n                <p className=\"text-red-300/90 text-sm mt-1\">\n                  This album contains video testimony from victims and survivors. Content may be\n                  graphic, traumatic, and disturbing. Viewer discretion is strongly advised.\n                </p>\n              </div>\n            </div>\n          )}\n\n          {error && (\n            <div className=\"bg-red-900/20 border border-red-500/50 text-red-200 p-4 mx-6 mt-6 rounded-lg\">\n              {error}\n            </div>\n          )}\n\n          <div className=\"flex-1 min-h-[360px] overflow-hidden relative\">\n            <AutoSizer>\n              {({ width, height }) => {\n                if (width < 50) return null;\n\n                // Match PhotoBrowser padding and gap logic, but tuned for 16:9 video cards\n                const minColumnWidth = 220;\n                const gap = 16;\n                const availableWidth = width - 48; // p-6 equivalent padding\n                const columnCount = Math.max(\n                  1,\n                  Math.floor((availableWidth + gap) / (minColumnWidth + gap)),\n                );\n                const columnWidth = (availableWidth - gap * (columnCount - 1)) / columnCount;\n                const rowCount = Math.ceil(items.length / columnCount);\n                // Video thumbnail (16:9) plus title/metadata block\n                const rowHeight = (columnWidth * 9) / 16 + 72;\n\n                return (\n                  <Grid\n                    columnCount={columnCount}\n                    columnWidth={columnWidth + gap}\n                    height={height}\n                    rowCount={rowCount}\n                    rowHeight={rowHeight + gap}\n                    width={width}\n                    itemData={{ ...gridData, columnCount }}\n                    className=\"scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent p-6\"\n                    style={{ overflowX: 'hidden' }}\n                    onItemsRendered={({ visibleRowStopIndex }) => {\n                      if (\n                        visibleRowStopIndex * columnCount >= items.length - 12 &&\n                        hasMore &&\n                        !loading\n                      ) {\n                        loadMoreItems();\n                      }\n                    }}\n                  >\n                    {VideoCell}\n                  </Grid>\n                );\n              }}\n            </AutoSizer>\n\n            {loading && items.length === 0 && (\n              <div className=\"absolute inset-0 flex items-center justify-center bg-slate-950/50 backdrop-blur-sm z-10\">\n                <div className=\"flex flex-col items-center gap-3\">\n                  <div className=\"w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\n                  <p className=\"text-slate-400 font-medium font-mono text-xs uppercase tracking-widest animate-pulse\">\n                    Crunching Evidence...\n                  </p>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Footer Status Bar */}\n      <div className=\"h-6 bg-slate-900 border-t border-slate-800 flex items-center justify-between px-3 text-[10px] text-slate-500 select-none shrink-0\">\n        <div>{items.length} items</div>\n        <div>{selectedAlbum ? currentAlbum?.name : 'All Videos'}</div>\n      </div>\n\n      {/* Batch Toolbar */}\n      {isBatchMode && selectedItems.size > 0 && (\n        <div className=\"fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-4xl px-4\">\n          <BatchToolbar\n            selectedCount={selectedItems.size}\n            onRotate={() => {}}\n            onAssignTags={(tags) => handleBatchTag(tags, 'add')}\n            onAssignPeople={handleBatchPeople}\n            onAssignRating={() => {}}\n            onEditMetadata={() => {}}\n            onCancel={() => setSelectedItems(new Set())}\n            onDeselect={() => setSelectedItems(new Set())}\n          />\n        </div>\n      )}\n\n      {/* Video Player Modal */}\n      {selectedItem && (\n        <div className=\"fixed inset-0 z-[2000] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 md:p-8\">\n          <div className=\"w-full max-w-6xl h-[85vh]\">\n            <VideoPlayer\n              src={`/api/media/video/${selectedItem.id}/stream`}\n              title={selectedItem.title}\n              transcript={selectedItem.metadata.transcript}\n              chapters={selectedItem.metadata.chapters}\n              onClose={() => setSelectedItem(null)}\n              autoPlay\n              isSensitive={selectedItem.isSensitive}\n              warningText={selectedItem.description}\n              documentId={selectedItem.metadata.documentId || (selectedItem as any).documentId}\n            />\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/VideoPlayer.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":43,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'playbackRate' and 'volume'. Either include them or remove the dependency array.","line":148,"column":6,"nodeType":"ArrayExpression","endLine":148,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [autoPlay, isSensitive, playbackRate, volume]","fix":{"range":[4835,4858],"text":"[autoPlay, isSensitive, playbackRate, volume]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'goToNextTranscriptMatch' function makes the dependencies of useEffect Hook (at line 247) change on every render. To fix this, wrap the definition of 'goToNextTranscriptMatch' in its own useCallback() Hook.","line":214,"column":9,"nodeType":"VariableDeclarator","endLine":214,"endColumn":85,"suggestions":[{"desc":"Wrap the definition of 'goToNextTranscriptMatch' in its own useCallback() Hook.","fix":{"range":[6984,7034],"text":"useCallback(() => jumpToTranscriptMatch(currentMatchIndex + 1))"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'goToPrevTranscriptMatch' function makes the dependencies of useEffect Hook (at line 247) change on every render. To fix this, wrap the definition of 'goToPrevTranscriptMatch' in its own useCallback() Hook.","line":215,"column":9,"nodeType":"VariableDeclarator","endLine":215,"endColumn":85,"suggestions":[{"desc":"Wrap the definition of 'goToPrevTranscriptMatch' in its own useCallback() Hook.","fix":{"range":[7070,7120],"text":"useCallback(() => jumpToTranscriptMatch(currentMatchIndex - 1))"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport {\n  Play,\n  Pause,\n  Volume2,\n  VolumeX,\n  Maximize2,\n  X,\n  Minimize2,\n  Shield,\n  Share2,\n  Check,\n} from 'lucide-react';\nimport { TranscriptSegment, Chapter } from './AudioPlayer'; // Reuse types\n\ninterface VideoPlayerProps {\n  src: string;\n  title: string;\n  transcript?: TranscriptSegment[];\n  chapters?: Chapter[];\n  onClose?: () => void;\n  autoPlay?: boolean;\n  isSensitive?: boolean;\n  warningText?: string;\n  documentId?: number;\n}\n\nexport const VideoPlayer: React.FC<VideoPlayerProps> = ({\n  src,\n  title,\n  transcript = [],\n  chapters = [],\n  onClose,\n  autoPlay = false,\n  isSensitive = false,\n  warningText = 'This content contains graphic descriptions of violence, sexual assault, child exploitation and murder.',\n  documentId,\n}) => {\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const transcriptRef = useRef<HTMLDivElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const navigate = useNavigate();\n\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [duration, setDuration] = useState(0);\n  const [currentTime, setCurrentTime] = useState(0);\n  const [volume, setVolume] = useState(1);\n  const [playbackRate, setPlaybackRate] = useState(1);\n  const [isMuted, setIsMuted] = useState(false);\n  const [showTranscript, setShowTranscript] = useState(() => {\n    try {\n      const saved =\n        typeof window !== 'undefined'\n          ? window.localStorage.getItem('video-player-show-transcript')\n          : null;\n      if (saved !== null) return saved === 'true';\n      // Default closed on mobile where sidebar can crowd controls\n      if (typeof window !== 'undefined' && window.innerWidth < 768) return false;\n      return true;\n    } catch {\n      return false;\n    }\n  });\n  const [activeSegmentIndex, setActiveSegmentIndex] = useState<number>(-1);\n  const [showChapters, setShowChapters] = useState(false);\n  const [isFullscreen, setIsFullscreen] = useState(false);\n  const [showControls, setShowControls] = useState(true);\n  const controlsTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const [showFullTranscriptOverlay, setShowFullTranscriptOverlay] = useState(false);\n  const overlayRef = useRef<HTMLDivElement>(null);\n  const lastInteractionRef = useRef<number>(Date.now());\n  const [showCopied, setShowCopied] = useState(false);\n  const sidebarSearchInputRef = useRef<HTMLInputElement | null>(null);\n  const overlaySearchInputRef = useRef<HTMLInputElement | null>(null);\n\n  // In-player transcript search state\n  const [transcriptSearch, setTranscriptSearch] = useState('');\n  const [currentMatchIndex, setCurrentMatchIndex] = useState(0);\n\n  const normalizedTranscriptQuery = React.useMemo(\n    () => transcriptSearch.trim().toLowerCase(),\n    [transcriptSearch],\n  );\n\n  const transcriptMatches = React.useMemo(() => {\n    if (!normalizedTranscriptQuery || !Array.isArray(transcript)) return [] as number[];\n    return transcript\n      .map((seg, index) => ({\n        index,\n        text: `${seg.text || ''} ${seg.speaker || ''}`.toLowerCase(),\n      }))\n      .filter(({ text }) => text.includes(normalizedTranscriptQuery))\n      .map(({ index }) => index);\n  }, [transcript, normalizedTranscriptQuery]);\n\n  useEffect(() => {\n    setCurrentMatchIndex(0);\n  }, [normalizedTranscriptQuery, transcriptMatches.length]);\n\n  const [hasRevealed, setHasRevealed] = useState(!isSensitive);\n\n  // Toggle transcript visibility and persist preference\n  const toggleTranscript = () => {\n    setShowTranscript((prev) => {\n      const newValue = !prev;\n      try {\n        if (typeof window !== 'undefined') {\n          window.localStorage.setItem('video-player-show-transcript', String(newValue));\n        }\n      } catch {\n        // ignore storage errors\n      }\n      return newValue;\n    });\n  };\n\n  const handleShare = () => {\n    try {\n      const url = new URL(window.location.href);\n      // Encode current playback position so shared links restore time.\n      url.searchParams.set('t', Math.floor(currentTime).toString());\n      if (documentId != null) {\n        url.searchParams.set('id', String(documentId));\n      }\n      navigator.clipboard.writeText(url.toString()).then(() => {\n        setShowCopied(true);\n        setTimeout(() => setShowCopied(false), 2000);\n      });\n    } catch (e) {\n      console.error('Failed to copy link', e);\n    }\n  };\n\n  // Reset hasRevealed if isSensitive changes\n  useEffect(() => {\n    setHasRevealed(!isSensitive);\n  }, [isSensitive]);\n\n  useEffect(() => {\n    if (videoRef.current) {\n      videoRef.current.volume = volume;\n      videoRef.current.playbackRate = playbackRate;\n      if (autoPlay && !isSensitive) {\n        videoRef.current.play().catch((e) => console.warn('Autoplay failed:', e));\n      }\n    }\n  }, [autoPlay, isSensitive]);\n\n  // Handle fullscreen change\n  useEffect(() => {\n    const handleFullscreenChange = () => {\n      setIsFullscreen(!!document.fullscreenElement);\n    };\n    document.addEventListener('fullscreenchange', handleFullscreenChange);\n    return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);\n  }, []);\n\n  // Handle time update\n  const handleTimeUpdate = () => {\n    if (videoRef.current) {\n      const time = videoRef.current.currentTime;\n      setCurrentTime(time);\n\n      if (transcript.length > 0) {\n        const index = transcript.findIndex((seg) => time >= seg.start && time < seg.end);\n        if (index !== -1 && index !== activeSegmentIndex) {\n          setActiveSegmentIndex(index);\n          scrollToSegment(index);\n        }\n      }\n    }\n  };\n\n  const scrollToSegment = (index: number) => {\n    if (transcriptRef.current && transcriptRef.current.parentElement) {\n      const container = transcriptRef.current.parentElement;\n      const element = transcriptRef.current.children[index] as HTMLElement;\n\n      if (element) {\n        const offset = element.offsetTop - container.offsetTop;\n\n        container.scrollTo({\n          top: offset - container.clientHeight / 2 + element.clientHeight / 2,\n          behavior: 'smooth',\n        });\n      }\n    }\n  };\n\n  const scrollOverlayToSegment = (index: number) => {\n    if (!overlayRef.current) return;\n    const element = overlayRef.current.children[index] as HTMLElement;\n    if (element) {\n      overlayRef.current.scrollTo({\n        top: element.offsetTop - overlayRef.current.clientHeight / 2 + element.clientHeight / 2,\n        behavior: 'smooth',\n      });\n    }\n  };\n\n  const jumpToTranscriptMatch = (nextIndex: number) => {\n    if (!transcriptMatches.length) return;\n    const wrapped = (nextIndex + transcriptMatches.length) % transcriptMatches.length;\n    const segIndex = transcriptMatches[wrapped];\n    const seg = transcript[segIndex];\n    if (!seg) return;\n    setCurrentMatchIndex(wrapped);\n    seek(seg.start);\n    scrollToSegment(segIndex);\n    scrollOverlayToSegment(segIndex);\n  };\n\n  const goToNextTranscriptMatch = () => jumpToTranscriptMatch(currentMatchIndex + 1);\n  const goToPrevTranscriptMatch = () => jumpToTranscriptMatch(currentMatchIndex - 1);\n\n  // Keyboard shortcuts for transcript navigation\n  useEffect(() => {\n    const handler = (e: KeyboardEvent) => {\n      const target = e.target as HTMLElement | null;\n      if (target instanceof HTMLInputElement || target instanceof HTMLTextAreaElement) {\n        return;\n      }\n      if (!showTranscript && !showFullTranscriptOverlay) return;\n\n      if (e.key === '/') {\n        e.preventDefault();\n        if (showFullTranscriptOverlay && overlaySearchInputRef.current) {\n          overlaySearchInputRef.current.focus();\n        } else if (sidebarSearchInputRef.current) {\n          sidebarSearchInputRef.current.focus();\n        }\n        return;\n      }\n\n      if (e.key === 'n' && !e.shiftKey) {\n        e.preventDefault();\n        goToNextTranscriptMatch();\n      } else if (e.key === 'N' || (e.key === 'n' && e.shiftKey)) {\n        e.preventDefault();\n        goToPrevTranscriptMatch();\n      }\n    };\n\n    window.addEventListener('keydown', handler);\n    return () => window.removeEventListener('keydown', handler);\n  }, [showTranscript, showFullTranscriptOverlay, goToNextTranscriptMatch, goToPrevTranscriptMatch]);\n\n  const formatTime = (time: number) => {\n    const mins = Math.floor(time / 60);\n    const secs = Math.floor(time % 60);\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  const togglePlay = () => {\n    if (videoRef.current) {\n      if (isPlaying) videoRef.current.pause();\n      else videoRef.current.play();\n      setIsPlaying(!isPlaying);\n    }\n  };\n\n  const handleReveal = () => {\n    setHasRevealed(true);\n    if (videoRef.current) {\n      videoRef.current.play().catch(console.error);\n      setIsPlaying(true);\n    }\n  };\n\n  const toggleFullscreen = () => {\n    if (!containerRef.current) return;\n\n    // Standard Request Method\n    const req =\n      (containerRef.current as any).requestFullscreen ||\n      (containerRef.current as any).webkitRequestFullscreen ||\n      (containerRef.current as any).mozRequestFullScreen ||\n      (containerRef.current as any).msRequestFullscreen;\n\n    if (!document.fullscreenElement && req) {\n      req.call(containerRef.current).catch((err: any) => {\n        console.error(`Error attempting to enable fullscreen mode: ${err.message}`);\n      });\n    } else if (document.exitFullscreen) {\n      document.exitFullscreen();\n    } else if ((document as any).webkitExitFullscreen) {\n      (document as any).webkitExitFullscreen();\n    }\n  };\n\n  const seek = (time: number) => {\n    if (videoRef.current) {\n      videoRef.current.currentTime = Math.max(0, Math.min(time, duration));\n      setCurrentTime(videoRef.current.currentTime);\n    }\n  };\n\n  const handleMouseMove = () => {\n    setShowControls(true);\n    if (controlsTimeoutRef.current) clearTimeout(controlsTimeoutRef.current);\n    controlsTimeoutRef.current = setTimeout(() => {\n      if (isPlaying) setShowControls(false);\n    }, 3000);\n  };\n\n  return (\n    <div className=\"flex flex-col h-full bg-slate-950 border border-slate-800 rounded-lg shadow-2xl overflow-hidden\">\n      {/* Header */}\n      <div className=\"px-4 py-3 bg-slate-900 border-b border-slate-800 shrink-0\">\n        <div className=\"flex flex-col gap-2 md:flex-row md:items-center md:justify-between\">\n          <div className=\"flex items-center gap-3 overflow-hidden\">\n            <div className=\"w-8 h-8 rounded bg-cyan-900/30 flex items-center justify-center text-cyan-400\">\n              <Play size={16} />\n            </div>\n            <div className=\"min-w-0\">\n              <h3 className=\"text-sm font-medium text-slate-200 truncate\" title={title}>\n                {title}\n              </h3>\n              <p className=\"text-xs text-slate-500\">\n                {chapters.length > 0 ? `${chapters.length} chapters` : 'Video Recording'}\n              </p>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2 flex-wrap justify-start md:justify-end\">\n            <button\n              onClick={handleShare}\n              className=\"p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors\"\n              title=\"Copy link\"\n            >\n              {showCopied ? <Check size={16} className=\"text-green-400\" /> : <Share2 size={16} />}\n            </button>\n            <button\n              onClick={() => {\n                setShowFullTranscriptOverlay(true);\n                lastInteractionRef.current = Date.now();\n                setTimeout(() => {\n                  if (!overlayRef.current) return;\n                  const idx = transcript.findIndex(\n                    (seg) => currentTime >= seg.start && currentTime < seg.end,\n                  );\n                  const el = overlayRef.current.children[idx] as HTMLElement;\n                  if (el)\n                    overlayRef.current.scrollTo({\n                      top: el.offsetTop - overlayRef.current.clientHeight / 2 + el.clientHeight / 2,\n                      behavior: 'smooth',\n                    });\n                }, 50);\n              }}\n              className=\"px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-xs text-cyan-400 rounded-full transition-colors flex items-center gap-2 border border-slate-700\"\n              title=\"Read full transcript overlay\"\n            >\n              <svg className=\"w-3 h-3\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"\n                />\n              </svg>\n              Read Full Transcript\n            </button>\n            {(transcript.length > 0 || chapters.length > 0) && (\n              <button\n                onClick={toggleTranscript}\n                className=\"p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors\"\n                title={showTranscript ? 'Hide transcript' : 'Show transcript'}\n              >\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"\n                  />\n                </svg>\n              </button>\n            )}\n            {onClose && (\n              <button\n                onClick={onClose}\n                className=\"p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white\"\n              >\n                <X size={18} />\n              </button>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <div className=\"flex flex-1 min-h-0 overflow-hidden flex-col md:flex-row\">\n        {/* Main Content (Video) */}\n        <div\n          ref={containerRef}\n          className=\"flex-1 bg-black relative flex items-center justify-center overflow-hidden group\"\n          onMouseMove={handleMouseMove}\n          onMouseLeave={() => isPlaying && setShowControls(false)}\n        >\n          {/* Sensitive Content Warning Overlay */}\n          {!hasRevealed && (\n            <div className=\"absolute inset-0 z-50 bg-slate-950/95 flex flex-col items-center justify-center p-6 text-center animate-in fade-in duration-300\">\n              <div className=\"w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mb-6 ring-1 ring-red-500/30\">\n                <Shield className=\"h-8 w-8 text-red-500\" />\n              </div>\n              <h3 className=\"text-xl font-bold text-white mb-2\">Graphic Content Warning</h3>\n              <p className=\"text-slate-400 max-w-md mb-8 leading-relaxed\">{warningText}</p>\n              <div className=\"flex gap-4\">\n                {onClose && (\n                  <button\n                    onClick={onClose}\n                    className=\"px-6 py-2 rounded-lg border border-slate-700 hover:bg-slate-800 text-slate-300 transition-colors font-medium\"\n                  >\n                    Cancel\n                  </button>\n                )}\n                <button\n                  onClick={handleReveal}\n                  className=\"px-6 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white font-medium shadow-lg shadow-red-900/20 transition-all hover:scale-105\"\n                >\n                  Reveal & Play\n                </button>\n              </div>\n            </div>\n          )}\n\n          <video\n            ref={videoRef}\n            src={src}\n            className=\"w-full h-full object-contain\"\n            onTimeUpdate={handleTimeUpdate}\n            onLoadedMetadata={() => setDuration(videoRef.current?.duration || 0)}\n            onEnded={() => {\n              setIsPlaying(false);\n              setShowControls(true);\n            }}\n            onPlay={() => setIsPlaying(true)}\n            onPause={() => {\n              setIsPlaying(false);\n              setShowControls(true);\n            }}\n            onClick={togglePlay}\n          />\n\n          {/* Video Controls Overlay */}\n          <div\n            className={`absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent p-4 transition-opacity duration-300 ${showControls ? 'opacity-100' : 'opacity-0'}`}\n          >\n            {/* Progress Bar with Chapters */}\n            <div className=\"mb-4 relative group/progress\">\n              <input\n                type=\"range\"\n                min=\"0\"\n                max={duration || 100}\n                value={currentTime}\n                onChange={(e) => seek(parseFloat(e.target.value))}\n                className=\"w-full h-1.5 bg-white/20 rounded-lg appearance-none cursor-pointer accent-cyan-500 hover:h-2 transition-all\"\n              />\n              {/* Chapter Markers */}\n              {chapters.map((chapter, i) => (\n                <div\n                  key={i}\n                  className=\"absolute top-0 w-0.5 h-1.5 bg-yellow-500 hover:bg-white cursor-pointer z-10 transition-colors\"\n                  style={{ left: `${(chapter.startTime / duration) * 100}%` }}\n                  title={chapter.title}\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    seek(chapter.startTime);\n                  }}\n                />\n              ))}\n              <div className=\"flex justify-between text-xs text-slate-300 font-mono mt-1\">\n                <span>{formatTime(currentTime)}</span>\n                <span>{formatTime(duration)}</span>\n              </div>\n            </div>\n\n            {/* Bottom Controls Row */}\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-4\">\n                <button\n                  onClick={togglePlay}\n                  className=\"text-white hover:text-cyan-400 transition-colors\"\n                >\n                  {isPlaying ? (\n                    <Pause size={24} fill=\"currentColor\" />\n                  ) : (\n                    <Play size={24} fill=\"currentColor\" />\n                  )}\n                </button>\n\n                <div className=\"flex items-center gap-2 group/vol\">\n                  <button\n                    onClick={() => {\n                      setIsMuted(!isMuted);\n                      if (videoRef.current) videoRef.current.muted = !isMuted;\n                    }}\n                    className=\"text-slate-300 hover:text-white\"\n                  >\n                    {isMuted ? <VolumeX size={20} /> : <Volume2 size={20} />}\n                  </button>\n                  <input\n                    type=\"range\"\n                    min=\"0\"\n                    max=\"1\"\n                    step=\"0.05\"\n                    value={volume}\n                    onChange={(e) => {\n                      setVolume(parseFloat(e.target.value));\n                      if (videoRef.current) videoRef.current.volume = parseFloat(e.target.value);\n                    }}\n                    className=\"w-0 overflow-hidden group-hover/vol:w-20 transition-all h-1 bg-white/30 rounded-lg appearance-none cursor-pointer accent-white\"\n                  />\n                </div>\n\n                <div className=\"text-sm text-white truncate max-w-[200px]\">\n                  {/* Current Chapter Display */}\n                  {chapters.length > 0 && (\n                    <span className=\"opacity-80\">\n                      {\n                        chapters\n                          .slice()\n                          .reverse()\n                          .find((c) => currentTime >= c.startTime)?.title\n                      }\n                    </span>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"flex items-center gap-4\">\n                <div className=\"flex items-center gap-1 bg-white/10 rounded px-1\">\n                  {[0.5, 1, 1.5, 2].map((rate) => (\n                    <button\n                      key={rate}\n                      onClick={() => {\n                        setPlaybackRate(rate);\n                        if (videoRef.current) videoRef.current.playbackRate = rate;\n                      }}\n                      className={`px-2 py-0.5 text-xs rounded ${playbackRate === rate ? 'bg-white/20 text-white' : 'text-slate-400 hover:text-white'}`}\n                    >\n                      {rate}x\n                    </button>\n                  ))}\n                </div>\n\n                <button onClick={toggleFullscreen} className=\"text-slate-300 hover:text-white\">\n                  {isFullscreen ? <Minimize2 size={20} /> : <Maximize2 size={20} />}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Sidebar (Transcript/Chapters) */}\n        {(transcript.length > 0 || chapters.length > 0) && (\n          <div\n            className={`fixed md:relative inset-0 md:inset-auto z-40 md:z-0 md:w-80 border-l border-slate-800 bg-slate-900 md:bg-slate-900/30 flex flex-col transition-transform duration-300 ${showTranscript ? 'translate-x-0' : 'translate-x-full md:hidden'} md:translate-x-0 shrink-0`}\n          >\n            <div className=\"flex border-b border-slate-800 shrink-0\">\n              <button\n                onClick={() => setShowChapters(false)}\n                className={`flex-1 py-3 text-xs font-medium uppercase tracking-wider ${!showChapters ? 'text-cyan-400 border-b-2 border-cyan-500 bg-slate-800/50' : 'text-slate-500 hover:text-slate-300'}`}\n              >\n                Transcript\n              </button>\n              {chapters.length > 0 && (\n                <button\n                  onClick={() => setShowChapters(true)}\n                  className={`flex-1 py-3 text-xs font-medium uppercase tracking-wider ${showChapters ? 'text-cyan-400 border-b-2 border-cyan-500 bg-slate-800/50' : 'text-slate-500 hover:text-slate-300'}`}\n                >\n                  Chapters\n                </button>\n              )}\n              <button\n                onClick={() => setShowTranscript(false)}\n                className=\"md:hidden px-4 text-slate-400 hover:text-white\"\n              >\n                <X size={18} />\n              </button>\n            </div>\n\n            <div className=\"flex-1 overflow-y-auto p-0 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent max-h-[40vh] md:max-h-none\">\n              {!showChapters ? (\n                <>\n                  {transcript.length > 0 && (\n                    <div className=\"sticky top-0 z-10 bg-slate-900/95 px-3 py-2 border-b border-slate-800 flex items-center gap-2\">\n                      <input\n                        ref={sidebarSearchInputRef}\n                        type=\"text\"\n                        value={transcriptSearch}\n                        onChange={(e) => {\n                          setTranscriptSearch(e.target.value);\n                          lastInteractionRef.current = Date.now();\n                        }}\n                        placeholder=\"Search in transcript…\"\n                        className=\"flex-1 bg-slate-800 border border-slate-700 rounded text-slate-200 text-xs px-2 py-1 focus:outline-none focus:ring-1 focus:ring-cyan-500 placeholder-slate-500\"\n                      />\n                      {normalizedTranscriptQuery && (\n                        <div className=\"flex items-center gap-1 text-[10px] text-slate-400\">\n                          <span>\n                            {transcriptMatches.length\n                              ? `${currentMatchIndex + 1}/${transcriptMatches.length}`\n                              : '0/0'}\n                          </span>\n                          <button\n                            type=\"button\"\n                            onClick={goToPrevTranscriptMatch}\n                            disabled={!transcriptMatches.length}\n                            className=\"px-1 py-0.5 rounded bg-slate-800 border border-slate-700 disabled:opacity-40\"\n                          >\n                            ↑\n                          </button>\n                          <button\n                            type=\"button\"\n                            onClick={goToNextTranscriptMatch}\n                            disabled={!transcriptMatches.length}\n                            className=\"px-1 py-0.5 rounded bg-slate-800 border border-slate-700 disabled:opacity-40\"\n                          >\n                            ↓\n                          </button>\n                        </div>\n                      )}\n                    </div>\n                  )}\n                  <div ref={transcriptRef} className=\"flex flex-col\">\n                    {transcript.length > 0 ? (\n                      transcript.map((seg, i) => {\n                        const isMatch =\n                          !!normalizedTranscriptQuery && transcriptMatches.includes(i);\n                        const isCurrent = isMatch && transcriptMatches[currentMatchIndex] === i;\n                        return (\n                          <button\n                            key={i}\n                            onClick={() => seek(seg.start)}\n                            className={`p-4 text-left border-b border-slate-800/50 transition-colors hover:bg-slate-800/50 ${\n                              activeSegmentIndex === i ? 'bg-cyan-900/20' : ''\n                            } ${isCurrent ? 'ring-1 ring-amber-400 border-amber-400' : ''} ${\n                              !isCurrent && isMatch ? 'border-amber-500/60' : ''\n                            }`}\n                          >\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <span className=\"text-xs font-mono text-slate-500\">\n                                {formatTime(seg.start)}\n                              </span>\n                              {seg.speaker && (\n                                <span className=\"text-xs font-bold text-slate-300\">\n                                  {seg.speaker}\n                                </span>\n                              )}\n                            </div>\n                            <p\n                              className={`text-sm leading-relaxed ${\n                                activeSegmentIndex === i ? 'text-white' : 'text-slate-400'\n                              }`}\n                            >\n                              {seg.text}\n                            </p>\n                          </button>\n                        );\n                      })\n                    ) : (\n                      <div className=\"p-8 text-center text-slate-500 text-sm\">\n                        No transcript available.\n                      </div>\n                    )}\n                  </div>\n                </>\n              ) : (\n                <div className=\"flex flex-col\">\n                  {chapters.map((chapter, i) => (\n                    <button\n                      key={i}\n                      onClick={() => seek(chapter.startTime)}\n                      className={`p-4 text-left border-b border-slate-800/50 flex items-center gap-3 hover:bg-slate-800/50 group`}\n                    >\n                      <div className=\"text-xs font-mono text-slate-500 w-12\">\n                        {formatTime(chapter.startTime)}\n                      </div>\n                      <div className=\"flex-1 text-sm text-slate-300 group-hover:text-cyan-400 transition-colors\">\n                        {chapter.title}\n                      </div>\n                      <Play size={12} className=\"opacity-0 group-hover:opacity-100 text-cyan-500\" />\n                    </button>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n      </div>\n      {showFullTranscriptOverlay && (\n        <div className=\"fixed inset-0 z-[1300] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4\">\n          <div className=\"w-full max-w-5xl h-[80vh] bg-slate-950 border border-slate-800 rounded-lg shadow-2xl overflow-hidden flex flex-col\">\n            <div className=\"flex items-center justify-between p-3 bg-slate-900 border-b border-slate-800\">\n              <div className=\"flex items-center gap-2\">\n                <button\n                  onClick={togglePlay}\n                  className=\"px-3 py-1 rounded bg-cyan-600 hover:bg-cyan-500 text-white text-xs\"\n                >\n                  {isPlaying ? 'Pause' : 'Play'}\n                </button>\n                <button\n                  onClick={() => {\n                    setIsMuted(!isMuted);\n                    if (videoRef.current) videoRef.current.muted = !isMuted;\n                  }}\n                  className=\"px-3 py-1 rounded bg-slate-800 hover:bg-slate-700 text-slate-200 text-xs\"\n                >\n                  {isMuted ? 'Unmute' : 'Mute'}\n                </button>\n              </div>\n              <button\n                onClick={() => setShowFullTranscriptOverlay(false)}\n                className=\"p-2 text-slate-400 hover:text-white\"\n              >\n                <X size={18} />\n              </button>\n            </div>\n            <div className=\"flex-1 flex flex-col\">\n              <div className=\"px-4 py-2 bg-slate-900/80 border-b border-slate-800 flex items-center gap-2\">\n                <input\n                  ref={overlaySearchInputRef}\n                  type=\"text\"\n                  value={transcriptSearch}\n                  onChange={(e) => {\n                    setTranscriptSearch(e.target.value);\n                    lastInteractionRef.current = Date.now();\n                  }}\n                  placeholder=\"Search in transcript…\"\n                  className=\"flex-1 bg-slate-800 border border-slate-700 rounded text-slate-200 text-xs px-2 py-1 focus:outline-none focus:ring-1 focus:ring-cyan-500 placeholder-slate-500\"\n                />\n                {normalizedTranscriptQuery && (\n                  <div className=\"flex items-center gap-1 text-[10px] text-slate-400\">\n                    <span>\n                      {transcriptMatches.length\n                        ? `${currentMatchIndex + 1}/${transcriptMatches.length}`\n                        : '0/0'}\n                    </span>\n                    <button\n                      type=\"button\"\n                      onClick={goToPrevTranscriptMatch}\n                      disabled={!transcriptMatches.length}\n                      className=\"px-1 py-0.5 rounded bg-slate-800 border border-slate-700 disabled:opacity-40\"\n                    >\n                      ↑\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={goToNextTranscriptMatch}\n                      disabled={!transcriptMatches.length}\n                      className=\"px-1 py-0.5 rounded bg-slate-800 border border-slate-700 disabled:opacity-40\"\n                    >\n                      ↓\n                    </button>\n                  </div>\n                )}\n              </div>\n              <div\n                ref={overlayRef}\n                className=\"flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent\"\n                onScroll={() => {\n                  lastInteractionRef.current = Date.now();\n                }}\n                onWheel={() => {\n                  lastInteractionRef.current = Date.now();\n                }}\n                onTouchMove={() => {\n                  lastInteractionRef.current = Date.now();\n                }}\n              >\n                {transcript.map((seg, i) => {\n                  const isMatch = !!normalizedTranscriptQuery && transcriptMatches.includes(i);\n                  const isCurrent = isMatch && transcriptMatches[currentMatchIndex] === i;\n                  return (\n                    <button\n                      key={i}\n                      onClick={() => seek(seg.start)}\n                      className={`w-full text-left p-3 rounded border border-slate-800/50 hover:bg-slate-800/50 transition-colors ${\n                        currentTime >= seg.start && currentTime < seg.end ? 'bg-cyan-900/20' : ''\n                      } ${isCurrent ? 'ring-1 ring-amber-400 border-amber-400' : ''} ${\n                        !isCurrent && isMatch ? 'border-amber-500/60' : ''\n                      }`}\n                    >\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span className=\"text-xs font-mono text-slate-500\">\n                          {formatTime(seg.start)}\n                        </span>\n                        {seg.speaker && (\n                          <span className=\"text-xs font-bold text-slate-300\">{seg.speaker}</span>\n                        )}\n                      </div>\n                      <p className=\"text-sm text-slate-300\">{seg.text}</p>\n                    </button>\n                  );\n                })}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/VideoTab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/VirtualList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/email/EmailClient.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadInitialEmails'. Either include it or remove the dependency array.","line":101,"column":6,"nodeType":"ArrayExpression","endLine":101,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadInitialEmails]","fix":{"range":[2864,2866],"text":"[loadInitialEmails]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'processDocsToThreads'. Either include it or remove the dependency array.","line":141,"column":6,"nodeType":"ArrayExpression","endLine":141,"endColumn":50,"suggestions":[{"desc":"Update the dependencies array to be: [loadingMore, hasMore, currentPage, allDocs, processDocsToThreads]","fix":{"range":[4127,4171],"text":"[loadingMore, hasMore, currentPage, allDocs, processDocsToThreads]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';\nimport {\n  Mail,\n  Inbox,\n  Search,\n  ChevronDown,\n  ChevronRight,\n  ChevronLeft,\n  Clock,\n  User,\n  Loader2,\n  Archive,\n  Reply,\n  Forward,\n  Trash2,\n} from 'lucide-react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { apiClient } from '../../services/apiClient';\nimport { Document } from '../../types/documents';\n\n// --- Types ---\n\ninterface Email extends Document {\n  sender?: string;\n  recipient?: string;\n  subject?: string;\n  threadId?: string;\n  isRead?: boolean;\n  date: string;\n  summary?: string;\n}\n\ninterface Thread {\n  id: string;\n  subject: string;\n  lastMessageDate: string;\n  messages: Email[];\n  participantNames: string[];\n  snippet: string;\n  hasAttachments: boolean;\n  unreadCount: number;\n}\n\ninterface Mailbox {\n  id: string;\n  label: string;\n  icon: React.ElementType;\n  count?: number;\n}\n\ntype SortField = 'date' | 'sender' | 'subject';\ntype SortOrder = 'asc' | 'desc';\n\nconst PAGE_SIZE = 500;\n\n// --- iOS Mail-Style Email Client ---\n\nexport const EmailClient: React.FC = () => {\n  const [loading, setLoading] = useState(true);\n  const [loadingMore, setLoadingMore] = useState(false);\n  const [threads, setThreads] = useState<Thread[]>([]);\n  const [selectedThreadId, setSelectedThreadId] = useState<string | null>(null);\n  const [selectedAccount, setSelectedAccount] = useState<string>('all');\n  const [searchTerm, setSearchTerm] = useState('');\n  const [debouncedSearchTerm, setDebouncedSearchTerm] = useState('');\n  const [sortField, setSortField] = useState<SortField>('date');\n  const [sortOrder, setSortOrder] = useState<SortOrder>('desc');\n  const [showMailboxDrawer, setShowMailboxDrawer] = useState(false);\n\n  const [currentPage, setCurrentPage] = useState(1);\n  const [totalEmails, setTotalEmails] = useState(0);\n  const [loadedEmails, setLoadedEmails] = useState(0);\n  const [hasMore, setHasMore] = useState(true);\n  const [allDocs, setAllDocs] = useState<any[]>([]);\n\n  const listRef = useRef<HTMLDivElement>(null);\n  const isMobileDetail = !!selectedThreadId;\n\n  // Mailbox definitions\n  const mailboxes: Mailbox[] = useMemo(\n    () => [\n      { id: 'all', label: 'All Inboxes', icon: Inbox, count: totalEmails },\n      { id: 'barak', label: 'Ehud Barak', icon: Mail },\n      { id: 'jee', label: 'Jeffrey Epstein', icon: Mail },\n      { id: 'gmax', label: 'Ghislaine Maxwell', icon: Mail },\n      { id: 'oversight', label: 'House Oversight', icon: Mail },\n    ],\n    [totalEmails],\n  );\n\n  const currentMailbox = mailboxes.find((m) => m.id === selectedAccount) || mailboxes[0];\n\n  // Debounce search term for performance\n  useEffect(() => {\n    const timer = setTimeout(() => setDebouncedSearchTerm(searchTerm), 300);\n    return () => clearTimeout(timer);\n  }, [searchTerm]);\n\n  useEffect(() => {\n    loadInitialEmails();\n  }, []);\n\n  const loadInitialEmails = async () => {\n    setLoading(true);\n    try {\n      const response = await apiClient.getDocuments({ evidenceType: 'email' }, 1, PAGE_SIZE);\n      setAllDocs(response.data);\n      setTotalEmails(response.total);\n      setLoadedEmails(response.data.length);\n      setHasMore(response.data.length < response.total);\n      setCurrentPage(1);\n      processDocsToThreads(response.data);\n    } catch (e) {\n      console.error('Failed to load emails', e);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const loadMoreEmails = useCallback(async () => {\n    if (loadingMore || !hasMore) return;\n    setLoadingMore(true);\n    try {\n      const nextPage = currentPage + 1;\n      const response = await apiClient.getDocuments({ evidenceType: 'email' }, nextPage, PAGE_SIZE);\n      if (response.data.length === 0) {\n        setHasMore(false);\n        return;\n      }\n      const newDocs = [...allDocs, ...response.data];\n      setAllDocs(newDocs);\n      setLoadedEmails(newDocs.length);\n      setCurrentPage(nextPage);\n      setHasMore(newDocs.length < response.total);\n      processDocsToThreads(newDocs);\n    } catch (e) {\n      console.error('Failed to load more emails', e);\n    } finally {\n      setLoadingMore(false);\n    }\n  }, [loadingMore, hasMore, currentPage, allDocs]);\n\n  const processDocsToThreads = (docs: any[]) => {\n    const threadsMap = new Map<string, Thread>();\n\n    for (const doc of docs) {\n      const threadId = doc.metadata?.thread_id || doc.id;\n      const sender = doc.metadata?.from || doc.metadata?.sender || 'Unknown Sender';\n      const recipient = doc.metadata?.to || doc.metadata?.recipient || '';\n      const subject = doc.metadata?.subject || doc.title || 'No Subject';\n      const snippet = cleanSnippet(doc.content || doc.summary || '');\n\n      const email: Email = {\n        ...doc,\n        sender,\n        recipient,\n        subject,\n        threadId,\n        date: doc.date || doc.created_at || new Date().toISOString(),\n        isRead: true,\n      };\n\n      if (threadsMap.has(threadId)) {\n        const thread = threadsMap.get(threadId)!;\n        thread.messages.push(email);\n        if (new Date(email.date) > new Date(thread.lastMessageDate)) {\n          thread.lastMessageDate = email.date;\n          thread.snippet = snippet;\n        }\n        if (!thread.participantNames.includes(sender)) {\n          thread.participantNames.push(sender);\n        }\n      } else {\n        threadsMap.set(threadId, {\n          id: threadId,\n          subject,\n          lastMessageDate: email.date,\n          messages: [email],\n          participantNames: [sender],\n          snippet,\n          hasAttachments: false,\n          unreadCount: 0,\n        });\n      }\n    }\n\n    setThreads(Array.from(threadsMap.values()));\n  };\n\n  function cleanSnippet(text: string): string {\n    return text\n      .replace(/From:.*?\\n/gi, '')\n      .replace(/To:.*?\\n/gi, '')\n      .replace(/Subject:.*?\\n/gi, '')\n      .replace(/Date:.*?\\n/gi, '')\n      .replace(/\\n+/g, ' ')\n      .trim()\n      .slice(0, 150);\n  }\n\n  const handleScroll = useCallback(\n    (e: React.UIEvent<HTMLDivElement>) => {\n      const target = e.target as HTMLDivElement;\n      const scrollBottom = target.scrollHeight - target.scrollTop - target.clientHeight;\n      if (scrollBottom < 200 && !loadingMore && hasMore) loadMoreEmails();\n    },\n    [loadMoreEmails, loadingMore, hasMore],\n  );\n\n  const filteredThreads = useMemo(() => {\n    let t = [...threads];\n    if (selectedAccount !== 'all') {\n      const accLower = selectedAccount.toLowerCase();\n      t = t.filter((th) => {\n        const first = th.messages[0];\n        const src = (first.metadata as any)?.source_collection || '';\n        const sender = (first.sender || '').toLowerCase();\n        const recipient = (first.recipient || '').toLowerCase();\n\n        if (accLower === 'gmax') {\n          return (\n            sender.includes('gmax') ||\n            sender.includes('ellmax.com') ||\n            sender.includes('ghislaine') ||\n            recipient.includes('gmax') ||\n            recipient.includes('ellmax.com') ||\n            src.toLowerCase().includes('gmax') ||\n            src.toLowerCase().includes('maxwell')\n          );\n        }\n        return src.toLowerCase().includes(accLower) || sender.includes(accLower);\n      });\n    }\n    if (debouncedSearchTerm) {\n      const s = debouncedSearchTerm.toLowerCase();\n      t = t.filter(\n        (th) =>\n          th.subject.toLowerCase().includes(s) ||\n          th.participantNames.some((p) => p.toLowerCase().includes(s)) ||\n          th.snippet.toLowerCase().includes(s),\n      );\n    }\n    t.sort((a, b) => {\n      let valA: any, valB: any;\n      switch (sortField) {\n        case 'date':\n          valA = new Date(a.lastMessageDate).getTime();\n          valB = new Date(b.lastMessageDate).getTime();\n          break;\n        case 'sender':\n          valA = a.participantNames[0] || '';\n          valB = b.participantNames[0] || '';\n          break;\n        case 'subject':\n          valA = a.subject;\n          valB = b.subject;\n          break;\n      }\n      if (valA < valB) return sortOrder === 'asc' ? -1 : 1;\n      if (valA > valB) return sortOrder === 'asc' ? 1 : -1;\n      return 0;\n    });\n    return t;\n  }, [threads, selectedAccount, debouncedSearchTerm, sortField, sortOrder]);\n\n  const selectedThread = useMemo(\n    () => threads.find((t) => t.id === selectedThreadId),\n    [threads, selectedThreadId],\n  );\n\n  const handleSort = (field: SortField) => {\n    if (sortField === field) setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');\n    else {\n      setSortField(field);\n      setSortOrder('desc');\n    }\n  };\n\n  const formatDate = (dateStr: string) => {\n    const date = new Date(dateStr);\n    const now = new Date();\n    const diff = now.getTime() - date.getTime();\n    const days = diff / (1000 * 60 * 60 * 24);\n    if (days < 1) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n    if (days < 7) return date.toLocaleDateString([], { weekday: 'short' });\n    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });\n  };\n\n  const getInitials = (name: string) => {\n    const parts = name.split(/[\\s@]+/);\n    if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();\n    return name.slice(0, 2).toUpperCase();\n  };\n\n  const getAvatarColor = (name: string) => {\n    const colors = [\n      'from-blue-500 to-blue-600',\n      'from-purple-500 to-purple-600',\n      'from-green-500 to-green-600',\n      'from-orange-500 to-orange-600',\n      'from-pink-500 to-pink-600',\n      'from-cyan-500 to-cyan-600',\n      'from-red-500 to-red-600',\n    ];\n    const hash = name.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);\n    return colors[hash % colors.length];\n  };\n\n  const handleMailboxSelect = (id: string) => {\n    setSelectedAccount(id);\n    setShowMailboxDrawer(false);\n  };\n\n  return (\n    <div className=\"flex flex-col h-[calc(100vh-64px)] bg-slate-950 md:bg-gradient-to-br md:from-slate-100 md:via-blue-50/30 md:to-purple-50/20 md:dark:from-slate-950 md:dark:via-slate-900 md:dark:to-slate-950 overflow-hidden\">\n      {/* Mobile Header - iOS Style */}\n      <div className=\"md:hidden flex items-center justify-between px-4 py-3 bg-slate-900 border-b border-slate-800\">\n        <button\n          onClick={() => setShowMailboxDrawer(true)}\n          className=\"flex items-center gap-2 text-blue-400 font-semibold\"\n        >\n          <span className=\"text-lg\">{currentMailbox.label}</span>\n          <ChevronDown className=\"w-4 h-4\" />\n        </button>\n        <div className=\"text-slate-400 text-sm\">{filteredThreads.length.toLocaleString()}</div>\n      </div>\n\n      {/* Desktop Sidebar - Hidden on Mobile */}\n      <div className=\"flex flex-1 overflow-hidden\">\n        <aside className=\"hidden md:flex w-60 flex-col m-3 mr-0 rounded-2xl bg-white/40 dark:bg-white/5 backdrop-blur-2xl border border-white/60 dark:border-white/10 shadow-xl shadow-black/5 dark:shadow-black/20\">\n          <div className=\"p-5 pb-3\">\n            <h2 className=\"text-[11px] font-bold text-slate-500/80 dark:text-white/40 uppercase tracking-widest\">\n              Mailboxes\n            </h2>\n          </div>\n\n          <nav className=\"flex-1 px-3 space-y-1 overflow-y-auto\">\n            {mailboxes.map((mb) => (\n              <DesktopSidebarItem\n                key={mb.id}\n                icon={mb.icon}\n                label={mb.label}\n                count={mb.count}\n                active={selectedAccount === mb.id}\n                onClick={() => setSelectedAccount(mb.id)}\n              />\n            ))}\n          </nav>\n\n          <div className=\"p-4 border-t border-white/30 dark:border-white/5\">\n            <div className=\"text-[11px] text-slate-500/70 dark:text-white/30 text-center font-medium\">\n              {loadedEmails.toLocaleString()} of {totalEmails.toLocaleString()}\n            </div>\n          </div>\n        </aside>\n\n        {/* Main Content Area */}\n        <div className=\"flex-1 flex flex-col md:flex-row md:p-3 md:gap-3 min-w-0\">\n          {/* Message List */}\n          <div\n            className={`w-full md:w-[400px] flex flex-col md:rounded-2xl bg-slate-950 md:bg-white/60 md:dark:bg-white/5 md:backdrop-blur-2xl md:border md:border-white/80 md:dark:border-white/10 md:shadow-xl overflow-hidden ${isMobileDetail ? 'hidden md:flex' : 'flex'}`}\n          >\n            {/* Search Bar - iOS Style */}\n            <div className=\"p-3 bg-slate-900 md:bg-transparent md:p-4 md:border-b md:border-black/5 md:dark:border-white/5\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 md:text-slate-400 md:dark:text-white/40\" />\n                <input\n                  type=\"text\"\n                  placeholder=\"Search\"\n                  className=\"w-full pl-10 pr-4 py-2 bg-slate-800 md:bg-black/5 md:dark:bg-white/10 rounded-lg text-sm text-white md:text-slate-900 md:dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 placeholder-slate-500 md:placeholder-slate-400 md:dark:placeholder-white/30\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                />\n              </div>\n            </div>\n\n            {/* Sort Header - Hidden on Mobile */}\n            <div className=\"hidden md:flex px-5 py-3 items-center justify-between text-[11px] text-slate-500 dark:text-white/40 border-b border-black/5 dark:border-white/5 font-semibold uppercase tracking-wide\">\n              <span>{filteredThreads.length.toLocaleString()} conversations</span>\n              <div className=\"flex items-center gap-4\">\n                <button\n                  onClick={() => handleSort('date')}\n                  className={`flex items-center gap-1.5 transition-colors ${sortField === 'date' ? 'text-blue-600 dark:text-blue-400' : 'hover:text-slate-700 dark:hover:text-white/60'}`}\n                >\n                  <Clock className=\"w-3.5 h-3.5\" /> Date\n                </button>\n                <button\n                  onClick={() => handleSort('sender')}\n                  className={`flex items-center gap-1.5 transition-colors ${sortField === 'sender' ? 'text-blue-600 dark:text-blue-400' : 'hover:text-slate-700 dark:hover:text-white/60'}`}\n                >\n                  <User className=\"w-3.5 h-3.5\" /> From\n                </button>\n              </div>\n            </div>\n\n            {/* Message List */}\n            <div ref={listRef} className=\"flex-1 overflow-y-auto\" onScroll={handleScroll}>\n              {loading ? (\n                <div className=\"p-10 text-center text-slate-500\">\n                  <Loader2 className=\"w-10 h-10 mx-auto mb-4 animate-spin opacity-40\" />\n                  <div className=\"font-medium\">Loading messages...</div>\n                </div>\n              ) : (\n                <>\n                  {filteredThreads.map((thread) => (\n                    <IOSMessageRow\n                      key={thread.id}\n                      thread={thread}\n                      selected={selectedThreadId === thread.id}\n                      onClick={() => setSelectedThreadId(thread.id)}\n                      formatDate={formatDate}\n                      getInitials={getInitials}\n                      getAvatarColor={getAvatarColor}\n                    />\n                  ))}\n                  {loadingMore && (\n                    <div className=\"p-5 text-center\">\n                      <Loader2 className=\"w-5 h-5 mx-auto animate-spin text-blue-500/50\" />\n                    </div>\n                  )}\n                  {hasMore && !loadingMore && (\n                    <div className=\"p-5 text-center\">\n                      <button\n                        onClick={loadMoreEmails}\n                        className=\"text-sm text-blue-400 font-medium\"\n                      >\n                        Load more ({(totalEmails - loadedEmails).toLocaleString()} remaining)\n                      </button>\n                    </div>\n                  )}\n                  {!hasMore && loadedEmails > 0 && (\n                    <div className=\"p-5 text-center text-[11px] text-slate-600 font-medium\">\n                      All {loadedEmails.toLocaleString()} emails loaded\n                    </div>\n                  )}\n                </>\n              )}\n              {!loading && filteredThreads.length === 0 && (\n                <div className=\"p-10 text-center text-slate-500\">\n                  <Mail className=\"w-14 h-14 mx-auto mb-4 opacity-20\" />\n                  <p className=\"font-medium\">No messages found</p>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Thread Detail View */}\n          <div\n            className={`flex-1 flex flex-col bg-slate-950 md:rounded-2xl md:bg-white/60 md:dark:bg-white/5 md:backdrop-blur-2xl md:border md:border-white/80 md:dark:border-white/10 md:shadow-xl overflow-hidden ${!selectedThreadId ? 'hidden md:flex' : 'flex'}`}\n          >\n            {selectedThread ? (\n              <>\n                {/* iOS-Style Header */}\n                <div className=\"flex items-center justify-between px-4 py-3 bg-slate-900 md:bg-gradient-to-b md:from-white/50 md:to-transparent md:dark:from-white/5 border-b border-slate-800 md:border-black/5 md:dark:border-white/5\">\n                  <button\n                    className=\"flex items-center text-blue-400 md:text-blue-600 md:dark:text-blue-400 font-semibold\"\n                    onClick={() => setSelectedThreadId(null)}\n                  >\n                    <ChevronLeft className=\"w-5 h-5 -ml-1\" />\n                    <span className=\"text-sm\">{currentMailbox.label}</span>\n                  </button>\n                  <div className=\"flex items-center gap-4\">\n                    <button className=\"text-blue-400 md:text-slate-500 md:dark:text-white/50\">\n                      <Archive className=\"w-5 h-5\" />\n                    </button>\n                    <button className=\"text-blue-400 md:text-slate-500 md:dark:text-white/50\">\n                      <Trash2 className=\"w-5 h-5\" />\n                    </button>\n                    <button className=\"text-blue-400 md:text-slate-500 md:dark:text-white/50\">\n                      <Reply className=\"w-5 h-5\" />\n                    </button>\n                  </div>\n                </div>\n\n                {/* Thread Subject */}\n                <div className=\"px-4 py-4 bg-slate-900/50 md:bg-transparent md:px-6 md:py-5 border-b border-slate-800 md:border-black/5 md:dark:border-white/5\">\n                  <h1 className=\"text-xl md:text-2xl font-bold text-white md:text-slate-800 md:dark:text-white leading-tight\">\n                    {selectedThread.subject}\n                  </h1>\n                  <div className=\"flex items-center gap-2 mt-2 text-sm text-slate-400 md:text-slate-500 md:dark:text-white/50\">\n                    <span>\n                      {selectedThread.messages.length} message\n                      {selectedThread.messages.length !== 1 ? 's' : ''}\n                    </span>\n                  </div>\n                </div>\n\n                {/* Messages */}\n                <div className=\"flex-1 overflow-y-auto\">\n                  {selectedThread.messages.map((msg, idx) => (\n                    <IOSMessageBubble\n                      key={msg.id}\n                      email={msg}\n                      expanded={idx === selectedThread.messages.length - 1}\n                      getInitials={getInitials}\n                      getAvatarColor={getAvatarColor}\n                    />\n                  ))}\n                </div>\n\n                {/* Bottom Action Bar - Mobile Only */}\n                <div className=\"md:hidden flex items-center justify-around py-3 bg-slate-900 border-t border-slate-800\">\n                  <button className=\"flex flex-col items-center text-blue-400\">\n                    <Archive className=\"w-6 h-6\" />\n                    <span className=\"text-[10px] mt-1\">Archive</span>\n                  </button>\n                  <button className=\"flex flex-col items-center text-blue-400\">\n                    <Trash2 className=\"w-6 h-6\" />\n                    <span className=\"text-[10px] mt-1\">Delete</span>\n                  </button>\n                  <button className=\"flex flex-col items-center text-blue-400\">\n                    <Reply className=\"w-6 h-6\" />\n                    <span className=\"text-[10px] mt-1\">Reply</span>\n                  </button>\n                  <button className=\"flex flex-col items-center text-blue-400\">\n                    <Forward className=\"w-6 h-6\" />\n                    <span className=\"text-[10px] mt-1\">Forward</span>\n                  </button>\n                </div>\n              </>\n            ) : (\n              <div className=\"hidden md:flex flex-1 items-center justify-center bg-gradient-to-b from-slate-50/30 to-transparent dark:from-transparent\">\n                <div className=\"text-center text-slate-400 dark:text-white/20\">\n                  <Mail className=\"w-20 h-20 mx-auto mb-5 opacity-15\" />\n                  <p className=\"text-lg font-semibold\">Select a message to read</p>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {/* Mailbox Drawer - Mobile Only */}\n      <AnimatePresence>\n        {showMailboxDrawer && (\n          <>\n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              className=\"fixed inset-0 bg-black/60 z-40 md:hidden\"\n              onClick={() => setShowMailboxDrawer(false)}\n            />\n            <motion.div\n              initial={{ y: '100%' }}\n              animate={{ y: 0 }}\n              exit={{ y: '100%' }}\n              transition={{ type: 'spring', damping: 25, stiffness: 300 }}\n              className=\"fixed bottom-0 left-0 right-0 bg-slate-900 rounded-t-3xl z-50 md:hidden max-h-[70vh] overflow-hidden\"\n            >\n              <div className=\"flex justify-center py-3\">\n                <div className=\"w-10 h-1 bg-slate-700 rounded-full\" />\n              </div>\n              <div className=\"px-4 pb-2\">\n                <h2 className=\"text-lg font-bold text-white\">Mailboxes</h2>\n              </div>\n              <div className=\"overflow-y-auto pb-8\">\n                {mailboxes.map((mb) => (\n                  <button\n                    key={mb.id}\n                    onClick={() => handleMailboxSelect(mb.id)}\n                    className={`w-full flex items-center justify-between px-4 py-4 border-b border-slate-800 ${\n                      selectedAccount === mb.id ? 'bg-blue-600/20' : ''\n                    }`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <mb.icon\n                        className={`w-5 h-5 ${selectedAccount === mb.id ? 'text-blue-400' : 'text-slate-400'}`}\n                      />\n                      <span\n                        className={`font-medium ${selectedAccount === mb.id ? 'text-blue-400' : 'text-white'}`}\n                      >\n                        {mb.label}\n                      </span>\n                    </div>\n                    {mb.count !== undefined && (\n                      <span className=\"text-slate-500 text-sm\">{mb.count.toLocaleString()}</span>\n                    )}\n                  </button>\n                ))}\n              </div>\n            </motion.div>\n          </>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n};\n\n// --- iOS-Style Components ---\n\nconst DesktopSidebarItem = ({ icon: Icon, label, count, active, onClick }: any) => (\n  <button\n    onClick={onClick}\n    className={`w-full flex items-center justify-between px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 ${\n      active\n        ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg shadow-blue-500/25'\n        : 'text-slate-600 dark:text-white/70 hover:bg-black/5 dark:hover:bg-white/10'\n    }`}\n  >\n    <div className=\"flex items-center gap-3\">\n      <Icon\n        className={`w-[18px] h-[18px] ${active ? 'text-white' : 'text-slate-400 dark:text-white/40'}`}\n      />\n      <span>{label}</span>\n    </div>\n    {count !== undefined && (\n      <span\n        className={`text-[11px] px-2 py-0.5 rounded-full font-semibold ${active ? 'bg-white/25' : 'bg-black/5 dark:bg-white/10 text-slate-500 dark:text-white/50'}`}\n      >\n        {count.toLocaleString()}\n      </span>\n    )}\n  </button>\n);\n\nconst IOSMessageRow = React.memo(\n  ({\n    thread,\n    selected,\n    onClick,\n    formatDate,\n    getInitials,\n    getAvatarColor,\n  }: {\n    thread: Thread;\n    selected: boolean;\n    onClick: () => void;\n    formatDate: (d: string) => string;\n    getInitials: (name: string) => string;\n    getAvatarColor: (name: string) => string;\n  }) => {\n    const sender = thread.participantNames[0] || 'Unknown';\n\n    return (\n      <div\n        onClick={onClick}\n        className={`flex items-start gap-3 px-4 py-3 border-b cursor-pointer transition-colors ${\n          selected\n            ? 'bg-blue-600/20 border-blue-800/50 md:bg-gradient-to-r md:from-blue-500 md:to-blue-600 md:border-transparent'\n            : 'border-slate-800 md:border-black/5 md:dark:border-white/5 hover:bg-slate-800/50 md:hover:bg-black/[0.02] md:dark:hover:bg-white/[0.03]'\n        }`}\n      >\n        {/* Avatar */}\n        <div\n          className={`w-10 h-10 rounded-full bg-gradient-to-br ${getAvatarColor(sender)} flex items-center justify-center text-white text-sm font-bold shrink-0`}\n        >\n          {getInitials(sender)}\n        </div>\n\n        {/* Content */}\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center justify-between mb-0.5\">\n            <span\n              className={`font-semibold text-[15px] truncate ${selected ? 'text-blue-300 md:text-white' : 'text-white md:text-slate-800 md:dark:text-white'}`}\n            >\n              {sender}\n            </span>\n            <div className=\"flex items-center gap-2 shrink-0 ml-2\">\n              <span\n                className={`text-xs ${selected ? 'text-blue-300/80 md:text-white/80' : 'text-slate-500 md:text-slate-400 md:dark:text-white/40'}`}\n              >\n                {formatDate(thread.lastMessageDate)}\n              </span>\n              <ChevronRight\n                className={`w-4 h-4 ${selected ? 'text-blue-300/60 md:text-white/60' : 'text-slate-600 md:text-slate-300 md:dark:text-white/20'}`}\n              />\n            </div>\n          </div>\n          <div\n            className={`text-sm truncate mb-0.5 ${selected ? 'text-blue-200 md:text-white/90' : 'text-slate-300 md:text-slate-700 md:dark:text-white/80'}`}\n          >\n            {thread.subject}\n          </div>\n          <div\n            className={`text-sm truncate ${selected ? 'text-blue-200/60 md:text-white/70' : 'text-slate-500 md:text-slate-400 md:dark:text-white/40'}`}\n          >\n            {thread.snippet}\n          </div>\n        </div>\n      </div>\n    );\n  },\n);\n\nconst IOSMessageBubble = ({\n  email,\n  expanded,\n  getInitials,\n  getAvatarColor,\n}: {\n  email: Email;\n  expanded: boolean;\n  getInitials: (name: string) => string;\n  getAvatarColor: (name: string) => string;\n}) => {\n  const [isExpanded, setExpanded] = useState(expanded);\n  const sender = email.sender || 'Unknown';\n\n  return (\n    <div className=\"border-b border-slate-800 md:border-black/5 md:dark:border-white/5\">\n      <div\n        className=\"flex items-start gap-3 p-4 cursor-pointer hover:bg-slate-800/30 md:hover:bg-black/[0.02] md:dark:hover:bg-white/[0.02] transition-colors\"\n        onClick={() => setExpanded(!isExpanded)}\n      >\n        {/* Avatar */}\n        <div\n          className={`w-10 h-10 rounded-full bg-gradient-to-br ${getAvatarColor(sender)} flex items-center justify-center text-white text-sm font-bold shrink-0`}\n        >\n          {getInitials(sender)}\n        </div>\n\n        {/* Header */}\n        <div className=\"flex-1 min-w-0\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"font-semibold text-white md:text-slate-800 md:dark:text-white truncate\">\n              {sender}\n            </span>\n            <span className=\"text-xs text-slate-500 md:text-slate-400 md:dark:text-white/40 ml-2 shrink-0\">\n              {new Date(email.date).toLocaleDateString([], {\n                month: 'short',\n                day: 'numeric',\n                hour: '2-digit',\n                minute: '2-digit',\n              })}\n            </span>\n          </div>\n          <div className=\"text-sm text-slate-400 md:text-slate-500 md:dark:text-white/50 truncate\">\n            To: {email.recipient || 'Unknown'}\n          </div>\n        </div>\n\n        <ChevronDown\n          className={`w-4 h-4 text-slate-500 transition-transform shrink-0 ${isExpanded ? 'rotate-180' : ''}`}\n        />\n      </div>\n\n      <AnimatePresence>\n        {isExpanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: 'auto', opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n            className=\"overflow-hidden\"\n          >\n            <div className=\"px-4 pb-4 md:pl-[68px]\">\n              <div className=\"text-sm text-slate-300 md:text-slate-600 md:dark:text-white/70 whitespace-pre-wrap leading-relaxed\">\n                {email.content || email.summary || 'No content available'}\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n};\n\nexport default EmailClient;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/evidence/ContactListViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/evidence/DepositionViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/evidence/DocumentViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/evidence/EmailViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/evidence/ImageViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/evidence/PDFViewer.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadPDF'. Either include it or remove the dependency array.","line":52,"column":6,"nodeType":"ArrayExpression","endLine":52,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [filePath, loadPDF]","fix":{"range":[1736,1746],"text":"[filePath, loadPDF]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * PDF Viewer Component\n *\n * Displays PDF files with navigation controls and basic features\n */\n\nimport React, { useState, useEffect } from 'react';\nimport { Document, Page, pdfjs } from 'react-pdf';\nimport { Download, ZoomIn, ZoomOut, RotateCw, ChevronLeft, ChevronRight } from 'lucide-react';\nimport 'react-pdf/dist/Page/AnnotationLayer.css';\nimport 'react-pdf/dist/Page/TextLayer.css';\n\n// Set up worker for PDF.js\npdfjs.GlobalWorkerOptions.workerSrc = `//cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjs.version}/pdf.worker.min.js`;\n\ninterface PDFViewerProps {\n  filePath: string;\n  title: string;\n}\n\nexport function PDFViewer({ filePath, title }: PDFViewerProps) {\n  const [numPages, setNumPages] = useState<number | null>(null);\n  const [pageNumber, setPageNumber] = useState<number>(1);\n  const [scale, setScale] = useState<number>(1.0);\n  const [rotation, setRotation] = useState<number>(0);\n  const [loading, setLoading] = useState<boolean>(true);\n  const [error, setError] = useState<string | null>(null);\n\n  // Function to load PDF from local file path\n  const loadPDF = async () => {\n    try {\n      setLoading(true);\n      setError(null);\n\n      // For local files, we need to serve them through the API\n      // The filePath will be converted to an API endpoint\n      const apiUrl = `/api/media/pdf?filePath=${encodeURIComponent(filePath)}`;\n\n      // Test if the file is accessible\n      const response = await fetch(apiUrl, { method: 'HEAD' });\n      if (!response.ok) {\n        throw new Error(`PDF not accessible: ${response.status}`);\n      }\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to load PDF');\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    loadPDF();\n  }, [filePath]);\n\n  const onDocumentLoadSuccess = ({ numPages }: { numPages: number }) => {\n    setNumPages(numPages);\n    setLoading(false);\n  };\n\n  const onDocumentLoadError = (error: Error) => {\n    console.error('Error loading PDF:', error);\n    setError(error.message);\n    setLoading(false);\n  };\n\n  const goToPrevPage = () => {\n    setPageNumber((prev) => Math.max(prev - 1, 1));\n  };\n\n  const goToNextPage = () => {\n    setPageNumber((prev) => (numPages ? Math.min(prev + 1, numPages) : prev));\n  };\n\n  const zoomIn = () => {\n    setScale((prev) => Math.min(prev + 0.2, 3));\n  };\n\n  const zoomOut = () => {\n    setScale((prev) => Math.max(prev - 0.2, 0.5));\n  };\n\n  const rotate = () => {\n    setRotation((prev) => (prev + 90) % 360);\n  };\n\n  const downloadPDF = () => {\n    const link = document.createElement('a');\n    link.href = `/api/media/pdf?filePath=${encodeURIComponent(filePath)}`;\n    link.download = title + '.pdf';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  };\n\n  if (error) {\n    return (\n      <div className=\"flex flex-col items-center justify-center h-full p-8 text-center\">\n        <div className=\"text-red-500 mb-4\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            className=\"h-16 w-16 mx-auto\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={2}\n              d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"\n            />\n          </svg>\n        </div>\n        <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">Unable to Load PDF</h3>\n        <p className=\"text-gray-600 mb-4\">{error}</p>\n        <button\n          onClick={loadPDF}\n          className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\n        >\n          Retry\n        </button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col h-full\">\n      {/* Toolbar */}\n      <div className=\"flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200\">\n        <div className=\"flex items-center space-x-2\">\n          <h2 className=\"text-lg font-semibold text-gray-900 truncate max-w-md\">{title}</h2>\n        </div>\n\n        <div className=\"flex items-center space-x-2\">\n          <button\n            onClick={downloadPDF}\n            className=\"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-lg transition-colors\"\n            title=\"Download PDF\"\n          >\n            <Download className=\"h-5 w-5\" />\n          </button>\n\n          <div className=\"h-6 w-px bg-gray-300\"></div>\n\n          <button\n            onClick={zoomOut}\n            className=\"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-lg transition-colors\"\n            disabled={scale <= 0.5}\n            title=\"Zoom Out\"\n          >\n            <ZoomOut className=\"h-5 w-5\" />\n          </button>\n\n          <span className=\"text-sm text-gray-600 min-w-[40px] text-center\">\n            {Math.round(scale * 100)}%\n          </span>\n\n          <button\n            onClick={zoomIn}\n            className=\"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-lg transition-colors\"\n            disabled={scale >= 3}\n            title=\"Zoom In\"\n          >\n            <ZoomIn className=\"h-5 w-5\" />\n          </button>\n\n          <div className=\"h-6 w-px bg-gray-300\"></div>\n\n          <button\n            onClick={rotate}\n            className=\"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-lg transition-colors\"\n            title=\"Rotate\"\n          >\n            <RotateCw className=\"h-5 w-5\" />\n          </button>\n        </div>\n      </div>\n\n      {/* Navigation and PDF Display */}\n      <div className=\"flex-1 flex flex-col overflow-hidden\">\n        {/* Page navigation */}\n        <div className=\"flex items-center justify-between p-2 bg-gray-100 border-b border-gray-200\">\n          <button\n            onClick={goToPrevPage}\n            disabled={pageNumber <= 1}\n            className=\"p-2 text-gray-600 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed\"\n            title=\"Previous Page\"\n          >\n            <ChevronLeft className=\"h-5 w-5\" />\n          </button>\n\n          <span className=\"text-sm text-gray-600\">\n            Page {pageNumber} of {numPages || '--'}\n          </span>\n\n          <button\n            onClick={goToNextPage}\n            disabled={!numPages || pageNumber >= numPages}\n            className=\"p-2 text-gray-600 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed\"\n            title=\"Next Page\"\n          >\n            <ChevronRight className=\"h-5 w-5\" />\n          </button>\n        </div>\n\n        {/* PDF Content */}\n        <div className=\"flex-1 overflow-auto bg-gray-200 flex items-center justify-center p-4\">\n          {loading ? (\n            <div className=\"flex flex-col items-center\">\n              <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4\"></div>\n              <p className=\"text-gray-600\">Loading PDF...</p>\n            </div>\n          ) : (\n            <div className=\"flex justify-center\">\n              <Document\n                file={`/api/media/pdf?filePath=${encodeURIComponent(filePath)}`}\n                onLoadSuccess={onDocumentLoadSuccess}\n                onLoadError={onDocumentLoadError}\n                loading={\n                  <div className=\"flex flex-col items-center\">\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4\"></div>\n                    <p className=\"text-gray-600\">Loading PDF...</p>\n                  </div>\n                }\n                error={\n                  <div className=\"text-red-500 p-4 text-center\">Failed to load PDF document</div>\n                }\n              >\n                <Page\n                  pageNumber={pageNumber}\n                  scale={scale}\n                  rotate={rotation}\n                  renderTextLayer={true}\n                  renderAnnotationLayer={true}\n                  className=\"shadow-lg\"\n                />\n              </Document>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/evidence/TableViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/shared/AlbumSidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/shared/MediaBrowserLayout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/shared/MobileAlbumDropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/shared/SensitiveWarningBanner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/components/shared/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/config/entityBlacklist.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/config/entityIcons.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/config/index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/contexts/AuthContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":78,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":78,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';\n\nexport interface User {\n  id: string;\n  username: string;\n  role: string;\n  email?: string | null;\n}\n\ninterface AuthContextType {\n  user: User | null;\n  token: string | null;\n  login: (token: any, user: User) => void;\n  logout: () => void;\n  isAuthenticated: boolean;\n  isAdmin: boolean;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport const AuthProvider = ({ children }: { children: ReactNode }) => {\n  const [user, setUser] = useState<User | null>(null);\n  const [, setIsLoading] = useState(true);\n\n  const checkAuth = async () => {\n    try {\n      const res = await fetch('/api/auth/me');\n      if (res.ok) {\n        const data = await res.json();\n        setUser(data.user);\n      } else {\n        setUser(null);\n      }\n    } catch (e) {\n      console.error('Auth check failed', e);\n      setUser(null);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    checkAuth();\n  }, []);\n\n  const login = (userData: User) => {\n    setUser(userData);\n    // No local storage for token anymore\n    localStorage.setItem('auth_user', JSON.stringify(userData)); // Optional: cache user info\n  };\n\n  const logout = async () => {\n    try {\n      await fetch('/api/auth/logout', { method: 'POST' });\n    } catch (e) {\n      console.error('Logout failed', e);\n    }\n    setUser(null);\n    localStorage.removeItem('auth_user');\n  };\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user,\n        token: null, // Deprecated\n        login: (token: any, user: User) => login(user), // Adapt for existing consumers temporarily\n        logout,\n        isAuthenticated: !!user,\n        isAdmin: user?.role === 'admin',\n      }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n};\n\nexport const useAuth = () => {\n  const context = useContext(AuthContext);\n  if (!context) throw new Error('useAuth must be used within AuthProvider');\n  return context;\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/contexts/InvestigationsContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":204,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":204,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';\nimport { Investigation } from '../types/investigation';\n\ninterface InvestigationsContextType {\n  investigations: Investigation[];\n  selectedInvestigation: Investigation | null;\n  isLoading: boolean;\n  error: string | null;\n  loadInvestigations: () => Promise<void>;\n  selectInvestigation: (id: string) => void;\n  createInvestigation: (\n    data: Omit<Investigation, 'id' | 'createdAt' | 'updatedAt' | 'team' | 'permissions' | 'tags'>,\n  ) => Promise<Investigation | null>;\n  addToInvestigation: (\n    investigationId: string,\n    item: any,\n    relevance: 'high' | 'medium' | 'low',\n  ) => Promise<void>;\n}\n\nconst InvestigationsContext = createContext<InvestigationsContextType | undefined>(undefined);\n\ninterface InvestigationsProviderProps {\n  children: ReactNode;\n}\n\nexport const InvestigationsProvider: React.FC<InvestigationsProviderProps> = ({ children }) => {\n  const [investigations, setInvestigations] = useState<Investigation[]>([]);\n  const [selectedInvestigation, setSelectedInvestigation] = useState<Investigation | null>(null);\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const loadInvestigations = async () => {\n    setIsLoading(true);\n    setError(null);\n    try {\n      const resp = await fetch('/api/investigations');\n      const data = await resp.json();\n      const mapped: Investigation[] = (data.data || []).map((inv: any) => ({\n        id: String(inv.id),\n        title: inv.title,\n        description: inv.description || '',\n        hypothesis: inv.scope || '',\n        status:\n          inv.status === 'open'\n            ? 'active'\n            : inv.status === 'in_review'\n              ? 'review'\n              : inv.status === 'closed'\n                ? 'published'\n                : 'archived',\n        createdAt: new Date(inv.created_at),\n        updatedAt: new Date(inv.updated_at),\n        team: inv.team || [\n          {\n            id: inv.owner_id,\n            name: inv.owner_name || 'Investigation Owner',\n            email: inv.owner_email || '',\n            role: 'lead',\n            permissions: ['read', 'write', 'admin'],\n            joinedAt: new Date(inv.created_at),\n            organization: inv.owner_organization || '',\n            expertise: [],\n          },\n        ],\n        leadInvestigator: inv.owner_id,\n        permissions: [],\n        tags: [],\n        priority: 'medium',\n      }));\n      setInvestigations(mapped);\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to load investigations';\n      setError(errorMessage);\n      console.error('Error loading investigations:', err);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const selectInvestigation = (id: string) => {\n    const investigation = investigations.find((inv) => inv.id === id) || null;\n    setSelectedInvestigation(investigation);\n  };\n\n  const createInvestigation = async (\n    data: Omit<Investigation, 'id' | 'createdAt' | 'updatedAt' | 'team' | 'permissions' | 'tags'>,\n  ): Promise<Investigation | null> => {\n    setIsLoading(true);\n    setError(null);\n    try {\n      const resp = await fetch('/api/investigations', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          title: data.title,\n          description: data.description,\n          ownerId: '1', // This should come from auth context\n          scope: data.hypothesis,\n        }),\n      });\n\n      if (!resp.ok) {\n        throw new Error('Failed to create investigation');\n      }\n\n      const inv = await resp.json();\n      await loadInvestigations(); // Refresh the list\n\n      const newInvestigation: Investigation = {\n        id: String(inv.id),\n        title: inv.title,\n        description: inv.description || '',\n        hypothesis: inv.scope || '',\n        status:\n          inv.status === 'open'\n            ? 'active'\n            : inv.status === 'in_review'\n              ? 'review'\n              : inv.status === 'closed'\n                ? 'published'\n                : 'archived',\n        createdAt: new Date(inv.created_at),\n        updatedAt: new Date(inv.updated_at),\n        team: [\n          {\n            id: '1', // This should come from auth context\n            name: 'Current User',\n            email: '',\n            role: 'lead',\n            permissions: ['read', 'write', 'admin'],\n            joinedAt: new Date(inv.created_at),\n            organization: '',\n            expertise: [],\n            status: 'active',\n          },\n        ],\n        leadInvestigator: '1',\n        permissions: [],\n        tags: [],\n        priority: 'medium',\n      };\n\n      return newInvestigation;\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Failed to create investigation';\n      setError(errorMessage);\n      console.error('Error creating investigation:', err);\n      return null;\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const addToInvestigation = async (\n    investigationId: string,\n    item: any,\n    relevance: 'high' | 'medium' | 'low',\n  ) => {\n    setIsLoading(true);\n    setError(null);\n    try {\n      // In a real implementation, this would call the API to add the item to the investigation\n      // For now, we'll just simulate the action\n      console.log('Adding item to investigation:', { investigationId, item, relevance });\n\n      // Dispatch a custom event for other components to listen to\n      const event = new CustomEvent('investigation-item-added', {\n        detail: { investigationId, item, relevance },\n      });\n      window.dispatchEvent(event);\n    } catch (err) {\n      const errorMessage =\n        err instanceof Error ? err.message : 'Failed to add item to investigation';\n      setError(errorMessage);\n      console.error('Error adding to investigation:', err);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    loadInvestigations();\n  }, []);\n\n  return (\n    <InvestigationsContext.Provider\n      value={{\n        investigations,\n        selectedInvestigation,\n        isLoading,\n        error,\n        loadInvestigations,\n        selectInvestigation,\n        createInvestigation,\n        addToInvestigation,\n      }}\n    >\n      {children}\n    </InvestigationsContext.Provider>\n  );\n};\n\nexport const useInvestigations = () => {\n  const context = useContext(InvestigationsContext);\n  if (context === undefined) {\n    throw new Error('useInvestigations must be used within an InvestigationsProvider');\n  }\n  return context;\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/contexts/MemoryContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":267,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":267,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useReducer, ReactNode } from 'react';\nimport { MemoryEntry, MemorySearchFilters } from '../types/memory';\n\n// Define the context state and actions\ninterface MemoryState {\n  memoryEntries: MemoryEntry[];\n  selectedMemoryEntry: MemoryEntry | null;\n  loading: boolean;\n  error: string | null;\n  currentPage: number;\n  totalPages: number;\n  totalEntries: number;\n}\n\ntype MemoryAction =\n  | { type: 'SET_LOADING'; payload: boolean }\n  | { type: 'SET_ERROR'; payload: string | null }\n  | {\n      type: 'SET_MEMORY_ENTRIES';\n      payload: { data: MemoryEntry[]; page: number; totalPages: number; total: number };\n    }\n  | { type: 'ADD_MEMORY_ENTRY'; payload: MemoryEntry }\n  | { type: 'UPDATE_MEMORY_ENTRY'; payload: MemoryEntry }\n  | { type: 'DELETE_MEMORY_ENTRY'; payload: number }\n  | { type: 'SET_SELECTED_MEMORY_ENTRY'; payload: MemoryEntry | null };\n\nconst initialState: MemoryState = {\n  memoryEntries: [],\n  selectedMemoryEntry: null,\n  loading: false,\n  error: null,\n  currentPage: 1,\n  totalPages: 0,\n  totalEntries: 0,\n};\n\nconst memoryReducer = (state: MemoryState, action: MemoryAction): MemoryState => {\n  switch (action.type) {\n    case 'SET_LOADING':\n      return { ...state, loading: action.payload };\n    case 'SET_ERROR':\n      return { ...state, error: action.payload };\n    case 'SET_MEMORY_ENTRIES':\n      return {\n        ...state,\n        memoryEntries: action.payload.data,\n        currentPage: action.payload.page,\n        totalPages: action.payload.totalPages,\n        totalEntries: action.payload.total,\n        loading: false,\n        error: null,\n      };\n    case 'ADD_MEMORY_ENTRY':\n      return {\n        ...state,\n        memoryEntries: [action.payload, ...state.memoryEntries],\n        totalEntries: state.totalEntries + 1,\n      };\n    case 'UPDATE_MEMORY_ENTRY':\n      return {\n        ...state,\n        memoryEntries: state.memoryEntries.map((entry) =>\n          entry.id === action.payload.id ? action.payload : entry,\n        ),\n        selectedMemoryEntry:\n          state.selectedMemoryEntry?.id === action.payload.id\n            ? action.payload\n            : state.selectedMemoryEntry,\n      };\n    case 'DELETE_MEMORY_ENTRY':\n      return {\n        ...state,\n        memoryEntries: state.memoryEntries.filter((entry) => entry.id !== action.payload),\n        totalEntries: Math.max(0, state.totalEntries - 1),\n      };\n    case 'SET_SELECTED_MEMORY_ENTRY':\n      return { ...state, selectedMemoryEntry: action.payload };\n    default:\n      return state;\n  }\n};\n\n// Create the context\ninterface MemoryContextType {\n  state: MemoryState;\n  loadMemoryEntries: (\n    filters?: MemorySearchFilters,\n    page?: number,\n    limit?: number,\n  ) => Promise<void>;\n  createMemoryEntry: (input: {\n    memoryType: 'declarative' | 'episodic' | 'working' | 'procedural';\n    content: string;\n    contextTags?: string[];\n    importanceScore?: number;\n    sourceId?: number;\n    sourceType?: string;\n    provenance?: any;\n  }) => Promise<void>;\n  updateMemoryEntry: (\n    id: number,\n    input: {\n      content?: string;\n      contextTags?: string[];\n      importanceScore?: number;\n      status?: 'active' | 'archived' | 'deprecated';\n      provenance?: any;\n    },\n  ) => Promise<void>;\n  deleteMemoryEntry: (id: number) => Promise<void>;\n  selectMemoryEntry: (entry: MemoryEntry | null) => void;\n  searchMemoryEntries: (query: string) => Promise<void>;\n}\n\nconst MemoryContext = createContext<MemoryContextType | undefined>(undefined);\n\n// Create the provider component\nexport const MemoryProvider: React.FC<{ children: ReactNode }> = ({ children }) => {\n  const [state, dispatch] = useReducer(memoryReducer, initialState);\n\n  const loadMemoryEntries = async (\n    filters?: MemorySearchFilters,\n    page: number = 1,\n    limit: number = 20,\n  ): Promise<void> => {\n    dispatch({ type: 'SET_LOADING', payload: true });\n    dispatch({ type: 'SET_ERROR', payload: null });\n\n    try {\n      const queryParams = new URLSearchParams();\n      if (page) queryParams.append('page', page.toString());\n      if (limit) queryParams.append('limit', limit.toString());\n      if (filters?.memoryType) queryParams.append('memoryType', filters.memoryType);\n      if (filters?.status) queryParams.append('status', filters.status);\n      if (filters?.searchQuery) queryParams.append('q', filters.searchQuery);\n\n      const response = await fetch(`/api/memory?${queryParams.toString()}`);\n      if (!response.ok) throw new Error('Failed to fetch memory entries');\n\n      const result = await response.json();\n      dispatch({\n        type: 'SET_MEMORY_ENTRIES',\n        payload: {\n          data: result.data,\n          page: result.page,\n          totalPages: result.totalPages,\n          total: result.total,\n        },\n      });\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Failed to load memory entries';\n      dispatch({ type: 'SET_ERROR', payload: errorMessage });\n      throw error;\n    } finally {\n      dispatch({ type: 'SET_LOADING', payload: false });\n    }\n  };\n\n  const createMemoryEntry = async (input: {\n    memoryType: 'declarative' | 'episodic' | 'working' | 'procedural';\n    content: string;\n    contextTags?: string[];\n    importanceScore?: number;\n    sourceId?: number;\n    sourceType?: string;\n    provenance?: any;\n  }) => {\n    dispatch({ type: 'SET_LOADING', payload: true });\n    dispatch({ type: 'SET_ERROR', payload: null });\n\n    try {\n      const response = await fetch('/api/memory', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(input),\n      });\n\n      if (!response.ok) throw new Error('Failed to create memory entry');\n\n      const newEntry = await response.json();\n      dispatch({ type: 'ADD_MEMORY_ENTRY', payload: newEntry });\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Failed to create memory entry';\n      dispatch({ type: 'SET_ERROR', payload: errorMessage });\n      throw error;\n    } finally {\n      dispatch({ type: 'SET_LOADING', payload: false });\n    }\n  };\n\n  const updateMemoryEntry = async (\n    id: number,\n    input: {\n      content?: string;\n      contextTags?: string[];\n      importanceScore?: number;\n      status?: 'active' | 'archived' | 'deprecated';\n      provenance?: any;\n    },\n  ) => {\n    dispatch({ type: 'SET_LOADING', payload: true });\n    dispatch({ type: 'SET_ERROR', payload: null });\n\n    try {\n      const response = await fetch(`/api/memory/${id}`, {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(input),\n      });\n\n      if (!response.ok) throw new Error('Failed to update memory entry');\n\n      const updatedEntry = await response.json();\n      dispatch({ type: 'UPDATE_MEMORY_ENTRY', payload: updatedEntry });\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Failed to update memory entry';\n      dispatch({ type: 'SET_ERROR', payload: errorMessage });\n      throw error;\n    } finally {\n      dispatch({ type: 'SET_LOADING', payload: false });\n    }\n  };\n\n  const deleteMemoryEntry = async (id: number) => {\n    dispatch({ type: 'SET_LOADING', payload: true });\n    dispatch({ type: 'SET_ERROR', payload: null });\n\n    try {\n      const response = await fetch(`/api/memory/${id}`, {\n        method: 'DELETE',\n      });\n\n      if (!response.ok) throw new Error('Failed to delete memory entry');\n\n      dispatch({ type: 'DELETE_MEMORY_ENTRY', payload: id });\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Failed to delete memory entry';\n      dispatch({ type: 'SET_ERROR', payload: errorMessage });\n      throw error;\n    } finally {\n      dispatch({ type: 'SET_LOADING', payload: false });\n    }\n  };\n\n  const selectMemoryEntry = (entry: MemoryEntry | null) => {\n    dispatch({ type: 'SET_SELECTED_MEMORY_ENTRY', payload: entry });\n  };\n\n  const searchMemoryEntries = async (query: string) => {\n    return loadMemoryEntries({ searchQuery: query });\n  };\n\n  const value = {\n    state,\n    loadMemoryEntries,\n    createMemoryEntry,\n    updateMemoryEntry,\n    deleteMemoryEntry,\n    selectMemoryEntry,\n    searchMemoryEntries,\n  };\n\n  return <MemoryContext.Provider value={value}>{children}</MemoryContext.Provider>;\n};\n\n// Custom hook to use the memory context\nexport const useMemory = (): MemoryContextType => {\n  const context = useContext(MemoryContext);\n  if (context === undefined) {\n    throw new Error('useMemory must be used within a MemoryProvider');\n  }\n  return context;\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/contexts/SensitiveSettingsContext.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":34,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":34,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { createContext, useContext, useState } from 'react';\n\ninterface SensitiveSettingsContextType {\n  showAllSensitive: boolean;\n  setShowAllSensitive: (show: boolean) => void;\n  toggleShowAllSensitive: () => void;\n}\n\nconst SensitiveSettingsContext = createContext<SensitiveSettingsContextType | undefined>(undefined);\n\nexport const SensitiveSettingsProvider: React.FC<{ children: React.ReactNode }> = ({\n  children,\n}) => {\n  const [showAllSensitive, setShowAllSensitiveState] = useState(() => {\n    return localStorage.getItem('epstein-archive-show-sensitive') === 'true';\n  });\n\n  const setShowAllSensitive = (show: boolean) => {\n    setShowAllSensitiveState(show);\n    localStorage.setItem('epstein-archive-show-sensitive', String(show));\n  };\n\n  const toggleShowAllSensitive = () => setShowAllSensitive(!showAllSensitive);\n\n  return (\n    <SensitiveSettingsContext.Provider\n      value={{ showAllSensitive, setShowAllSensitive, toggleShowAllSensitive }}\n    >\n      {children}\n    </SensitiveSettingsContext.Provider>\n  );\n};\n\nexport const useSensitiveSettings = () => {\n  const context = useContext(SensitiveSettingsContext);\n  if (!context) {\n    throw new Error('useSensitiveSettings must be used within a SensitiveSettingsProvider');\n  }\n  return context;\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/designTokens.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/hooks/useCountUp.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/hooks/useFirstRunOnboarding.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/hooks/useHighlightNavigation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/hooks/useInvestigationOnboarding.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/hooks/useMediaBrowser.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/hooks/useModalFocusTrap.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/hooks/useSharedIntersectionObserver.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'options'. Either include it or remove the dependency array.","line":59,"column":6,"nodeType":"ArrayExpression","endLine":59,"endColumn":67,"suggestions":[{"desc":"Update the dependencies array to be: [elementRef, callback, options.threshold, options.rootMargin, options]","fix":{"range":[1722,1783],"text":"[elementRef, callback, options.threshold, options.rootMargin, options]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useState } from 'react';\n\n/**\n * Shared IntersectionObserver hook - creates ONE observer for all images\n * instead of one per image. Massive performance improvement for large grids.\n */\n\ntype ObserverCallback = (isIntersecting: boolean) => void;\n\n// Global singleton observer\nlet globalObserver: IntersectionObserver | null = null;\nconst observerCallbacks = new Map<Element, ObserverCallback>();\n\nfunction getGlobalObserver(options: IntersectionObserverInit): IntersectionObserver {\n  if (!globalObserver) {\n    globalObserver = new IntersectionObserver((entries) => {\n      entries.forEach((entry) => {\n        const callback = observerCallbacks.get(entry.target);\n        if (callback) {\n          callback(entry.isIntersecting);\n        }\n      });\n    }, options);\n  }\n  return globalObserver;\n}\n\nexport function useSharedIntersectionObserver(\n  elementRef: React.RefObject<Element>,\n  callback: ObserverCallback,\n  options: IntersectionObserverInit = { threshold: 0.1, rootMargin: '200px' },\n) {\n  const [isIntersecting, setIsIntersecting] = useState(false);\n\n  useEffect(() => {\n    const element = elementRef.current;\n    if (!element) return;\n\n    const observer = getGlobalObserver(options);\n\n    const wrappedCallback = (intersecting: boolean) => {\n      setIsIntersecting(intersecting);\n      callback(intersecting);\n\n      // Unobserve after first intersection to save memory\n      if (intersecting) {\n        observer.unobserve(element);\n        observerCallbacks.delete(element);\n      }\n    };\n\n    observerCallbacks.set(element, wrappedCallback);\n    observer.observe(element);\n\n    return () => {\n      observer.unobserve(element);\n      observerCallbacks.delete(element);\n    };\n  }, [elementRef, callback, options.threshold, options.rootMargin]);\n\n  return isIntersecting;\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/hooks/useVirtualScroll.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/pages/AdminDashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/pages/EvidenceDetail.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchEvidence'. Either include it or remove the dependency array.","line":61,"column":6,"nodeType":"ArrayExpression","endLine":61,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [fetchEvidence, id]","fix":{"range":[1609,1613],"text":"[fetchEvidence, id]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Evidence Detail Page\n *\n * Displays evidence with type-specific viewers and linked entities\n */\n\nimport React, { useEffect, useState } from 'react';\nimport { useParams, Link } from 'react-router-dom';\nimport {\n  FileText,\n  Calendar,\n  Tag,\n  AlertTriangle,\n  Users,\n  Download,\n  Share2,\n  Bookmark,\n  ChevronLeft,\n} from 'lucide-react';\nimport { EmailViewer } from '../components/evidence/EmailViewer';\nimport { DepositionViewer } from '../components/evidence/DepositionViewer';\nimport { TableViewer } from '../components/evidence/TableViewer';\nimport { ImageViewer } from '../components/evidence/ImageViewer';\nimport { DocumentViewer } from '../components/evidence/DocumentViewer';\nimport { ContactListViewer } from '../components/evidence/ContactListViewer';\nimport { getEntityCategoryIcon } from '../config/entityIcons';\n\ninterface Evidence {\n  id: number;\n  evidenceType: string;\n  title: string;\n  description: string;\n  originalFilename: string;\n  sourcePath: string;\n  extractedText: string;\n  createdAt: string;\n  modifiedAt: string;\n  redFlagRating: number;\n  tags: string[];\n  metadata: any;\n  entities: Array<{\n    id: number;\n    name: string;\n    category: string;\n    role: string;\n    confidence: number;\n    contextSnippet: string;\n  }>;\n  wordCount: number;\n  fileSize: number;\n}\n\nexport function EvidenceDetail() {\n  const { id } = useParams<{ id: string }>();\n  const [evidence, setEvidence] = useState<Evidence | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    fetchEvidence();\n  }, [id]);\n\n  const fetchEvidence = async () => {\n    try {\n      setLoading(true);\n      const response = await fetch(`/api/evidence/${id}`);\n\n      if (!response.ok) {\n        throw new Error('Evidence not found');\n      }\n\n      const data = await response.json();\n      setEvidence(data);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to load evidence');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const renderViewer = () => {\n    if (!evidence) return null;\n\n    switch (evidence.evidenceType) {\n      case 'correspondence':\n        return <EmailViewer evidence={evidence} />;\n      case 'court_deposition':\n        return <DepositionViewer evidence={evidence} />;\n      case 'financial_record':\n        return <TableViewer evidence={evidence} />;\n      case 'contact_directory':\n        return <ContactListViewer evidence={evidence} />;\n      case 'media_scan':\n        return <ImageViewer evidence={evidence} />;\n      default:\n        return <DocumentViewer evidence={evidence} />;\n    }\n  };\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes < 1024) return bytes + ' B';\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';\n    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';\n  };\n\n  const formatDate = (dateString: string): string => {\n    return new Date(dateString).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n    });\n  };\n\n  const getRedFlagColor = (rating: number): string => {\n    if (rating >= 4) return 'text-red-600 bg-red-50';\n    if (rating >= 2) return 'text-orange-600 bg-orange-50';\n    return 'text-gray-600 bg-gray-50';\n  };\n\n  const getEvidenceTypeLabel = (type: string): string => {\n    return type.replace(/_/g, ' ').replace(/\\b\\w/g, (l) => l.toUpperCase());\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto\"></div>\n          <p className=\"mt-4 text-gray-600\">Loading evidence...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !evidence) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center\">\n          <AlertTriangle className=\"h-12 w-12 text-red-600 mx-auto\" />\n          <p className=\"mt-4 text-gray-600\">{error || 'Evidence not found'}</p>\n          <Link to=\"/evidence\" className=\"mt-4 inline-block text-blue-600 hover:underline\">\n            ← Back to Evidence List\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      {/* Header */}\n      <div className=\"bg-white border-b border-gray-200\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <Link to=\"/evidence\" className=\"text-gray-600 hover:text-gray-900 flex items-center\">\n                <ChevronLeft className=\"h-5 w-5\" />\n                <span className=\"ml-1\">Back</span>\n              </Link>\n              <div>\n                <h1 className=\"text-2xl font-bold text-gray-900\">{evidence.title}</h1>\n                <p className=\"text-xs font-light text-gray-500 mt-1 truncate\">\n                  {evidence.originalFilename}\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-center space-x-2\">\n              <button className=\"p-2 text-gray-600 hover:bg-gray-100 rounded\">\n                <Share2 className=\"h-5 w-5\" />\n              </button>\n              <button className=\"p-2 text-gray-600 hover:bg-gray-100 rounded\">\n                <Bookmark className=\"h-5 w-5\" />\n              </button>\n              <button className=\"p-2 text-gray-600 hover:bg-gray-100 rounded\">\n                <Download className=\"h-5 w-5\" />\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Metadata Bar */}\n      <div className=\"bg-white border-b border-gray-200\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3\">\n          <div className=\"flex items-center justify-between flex-wrap gap-4\">\n            <div className=\"flex items-center space-x-4\">\n              <span className=\"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800\">\n                <FileText className=\"h-4 w-4 mr-1\" />\n                {getEvidenceTypeLabel(evidence.evidenceType)}\n              </span>\n\n              <span\n                className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getRedFlagColor(evidence.redFlagRating)}`}\n              >\n                <AlertTriangle className=\"h-4 w-4 mr-1\" />\n                Red Flag: {evidence.redFlagRating}/5\n              </span>\n\n              {evidence.createdAt && (\n                <span className=\"inline-flex items-center text-sm text-gray-600\">\n                  <Calendar className=\"h-4 w-4 mr-1\" />\n                  {formatDate(evidence.createdAt)}\n                </span>\n              )}\n            </div>\n\n            <div className=\"flex items-center space-x-4 text-sm text-gray-600\">\n              <span>{evidence.wordCount?.toLocaleString()} words</span>\n              <span>{formatFileSize(evidence.fileSize)}</span>\n            </div>\n          </div>\n\n          {evidence.tags && evidence.tags.length > 0 && (\n            <div className=\"mt-3 flex items-center space-x-2\">\n              <Tag className=\"h-4 w-4 text-gray-400\" />\n              <div className=\"flex flex-wrap gap-2\">\n                {evidence.tags.map((tag, index) => (\n                  <span key={index} className=\"px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded\">\n                    {tag}\n                  </span>\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6\">\n        <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n          {/* Main Content */}\n          <div className=\"lg:col-span-3\">\n            <div className=\"bg-white rounded-lg shadow\">{renderViewer()}</div>\n          </div>\n\n          {/* Sidebar */}\n          <div className=\"lg:col-span-1 space-y-6\">\n            {/* Linked Entities */}\n            {evidence.entities && evidence.entities.length > 0 && (\n              <div className=\"bg-white rounded-lg shadow p-4\">\n                <h3 className=\"font-semibold text-gray-900 mb-4 flex items-center\">\n                  <Users className=\"h-5 w-5 mr-2\" />\n                  Linked Entities ({evidence.entities.length})\n                </h3>\n                <div className=\"space-y-3\">\n                  {evidence.entities.map((entity) => {\n                    const iconConfig = getEntityCategoryIcon(entity.category || 'person_associate');\n                    return (\n                      <Link\n                        key={entity.id}\n                        to={`/entities/${entity.id}`}\n                        className=\"block p-3 border border-gray-200 rounded-lg hover:border-blue-500 hover:shadow-sm transition\"\n                      >\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm font-medium text-gray-900 truncate\">\n                              {entity.name}\n                            </p>\n                            <p className=\"text-xs text-gray-600 mt-1\">Role: {entity.role}</p>\n                            {entity.confidence < 1 && (\n                              <p className=\"text-xs text-gray-500 mt-1\">\n                                Confidence: {(entity.confidence * 100).toFixed(0)}%\n                              </p>\n                            )}\n                          </div>\n                          <span className={`text-sm ${iconConfig.color}`}>{iconConfig.icon}</span>\n                        </div>\n                      </Link>\n                    );\n                  })}\n                </div>\n              </div>\n            )}\n\n            {/* Metadata */}\n            {evidence.metadata && Object.keys(evidence.metadata).length > 0 && (\n              <div className=\"bg-white rounded-lg shadow p-4\">\n                <h3 className=\"font-semibold text-gray-900 mb-4\">Metadata</h3>\n                <dl className=\"space-y-2 text-sm\">\n                  {Object.entries(evidence.metadata).map(([key, value]) => (\n                    <div key={key}>\n                      <dt className=\"text-gray-600 font-medium\">\n                        {key.replace(/([A-Z])/g, ' $1').replace(/^./, (str) => str.toUpperCase())}\n                      </dt>\n                      <dd className=\"text-gray-900 mt-1\">\n                        {typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value)}\n                      </dd>\n                    </div>\n                  ))}\n                </dl>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/pages/LoginPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/routes/entityEvidenceRoutes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/routes/evidenceRoutes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/routes/investigationEvidenceRoutes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getEnv' is defined but never used. Allowed unused vars must match /^_/u.","line":23,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"getEnv"},"fix":{"range":[1195,1251],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":655,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":655,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from 'express';\nimport cors from 'cors';\nimport helmet from 'helmet';\nimport compression from 'compression';\nimport rateLimit from 'express-rate-limit';\nimport cookieParser from 'cookie-parser';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n// import { databaseService } from './services/DatabaseService.js';\n// import { getEnv } from './src/config/env.js';\nimport { entitiesRepository } from './server/db/entitiesRepository.js';\nimport { documentsRepository } from './server/db/documentsRepository.js';\nimport { statsRepository } from './server/db/statsRepository.js';\nimport { mediaRepository } from './server/db/mediaRepository.js';\nimport { searchRepository } from './server/db/searchRepository.js';\nimport { timelineRepository } from './server/db/timelineRepository.js';\nimport { forensicRepository } from './server/db/forensicRepository.js';\nimport { runMigrations } from './server/db/migrator.js';\nimport { validateStartup } from './server/utils/startupValidation.js';\nimport { authenticateRequest, requireRole } from './server/auth/middleware.js';\nimport authRoutes from './server/auth/routes.js';\nimport { logAudit } from './server/utils/auditLogger.js';\nimport { getEnv } from './server/utils/envValidator.js';\nimport { MediaService } from './services/MediaService.js';\nimport investigationEvidenceRoutes from './routes/investigationEvidenceRoutes.js';\nimport investigationsRouter from './server/routes/investigations.js';\nimport evidenceRoutes from './routes/evidenceRoutes.js';\nimport advancedAnalyticsRoutes from './server/routes/advancedAnalytics.js';\nimport entityEvidenceRoutes from './routes/entityEvidenceRoutes.js';\nimport investigativeTasksRoutes from './server/routes/investigativeTasks.js';\nimport { communicationsRepository } from './server/db/communicationsRepository.js';\nimport crypto from 'crypto';\nimport multer from 'multer';\nimport fs from 'fs';\nimport bcrypt from 'bcryptjs';\nimport { SearchFilters, SortOption } from './types';\nimport { config } from './config/index.js';\nimport { blackBookRepository } from './server/db/blackBookRepository.js';\nimport { globalErrorHandler } from './server/utils/errorHandler.js';\nimport { memoryRepository } from './server/db/memoryRepository.js';\nimport NodeCache from 'node-cache';\nimport { getDb } from './server/db/connection.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\n// API Response Cache - 5 minute TTL for high-traffic endpoints\nconst apiCache = new NodeCache({\n  stdTTL: 300, // 5 minutes\n  checkperiod: 60, // Check for expired keys every 60s\n  useClones: false, // Don't clone objects (faster, but be careful with mutations)\n});\n\n// Cache middleware helper\nconst cacheMiddleware = (ttl?: number) => {\n  return (req: express.Request, res: express.Response, next: express.NextFunction) => {\n    // Generate cache key from URL + query params\n    const cacheKey = req.originalUrl || req.url;\n\n    // Try to get cached response\n    const cachedResponse = apiCache.get(cacheKey);\n    if (cachedResponse) {\n      // Send cached response\n      res.set('X-Cache', 'HIT');\n      return res.json(cachedResponse);\n    }\n\n    // Store original res.json to intercept response\n    const originalJson = res.json.bind(res);\n    res.json = function (body: any) {\n      // Cache the response\n      apiCache.set(cacheKey, body, ttl || 300);\n      res.set('X-Cache', 'MISS');\n      return originalJson(body);\n    };\n\n    next();\n  };\n};\n\n// Paths\nconst CORPUS_BASE_PATH = process.env.RAW_CORPUS_BASE_PATH || '';\n// Warn if corpus path not configured (documents may not be accessible)\nif (!CORPUS_BASE_PATH) {\n  console.warn('WARNING: RAW_CORPUS_BASE_PATH not set. Document file serving will be limited.');\n}\n\nconst app = express();\n// Enable trust proxy for Nginx/Load Balancer\napp.set('trust proxy', 1);\n\n// databaseService is already initialized at module level in its file, but let's make sure we use the same connection\nconst mediaService = new MediaService(getDb());\n\n// Request logging - AT THE VERY TOP\napp.use((req, res, next) => {\n  const start = Date.now();\n  res.on('finish', () => {\n    const duration = Date.now() - start;\n    // Log originalUrl to see exactly what reached Express\n    console.log(\n      `${new Date().toISOString()} ${req.method} ${req.originalUrl} ${res.statusCode} ${duration}ms`,\n    );\n  });\n  next();\n});\n\n// Basic middleware\napp.use(\n  cors({\n    origin: config.corsOrigin,\n    credentials: config.corsCredentials,\n  }),\n);\n\napp.use(cookieParser());\n\n// Security headers (CSP, HSTS, X-Frame-Options, etc.)\napp.use(\n  helmet({\n    contentSecurityPolicy: {\n      directives: {\n        defaultSrc: [\"'self'\"],\n        scriptSrc: [\"'self'\", \"'unsafe-inline'\", \"'unsafe-eval'\"], // Required for React\n        styleSrc: [\"'self'\", \"'unsafe-inline'\"],\n        imgSrc: [\"'self'\", 'data:', 'blob:', '*'],\n        connectSrc: [\n          \"'self'\",\n          ...(Array.isArray(config.corsOrigin) ? config.corsOrigin : [config.corsOrigin]),\n          'http://localhost:*',\n        ],\n        fontSrc: [\"'self'\", 'https://fonts.gstatic.com', 'data:'],\n        objectSrc: [\"'none'\"],\n        mediaSrc: [\"'self'\", 'blob:', '*'],\n        frameSrc: [\"'none'\"],\n      },\n    },\n    crossOriginEmbedderPolicy: false, // Required for some media\n    crossOriginResourcePolicy: false, // Required for mobile image loading\n  }),\n);\n\n// Compress all responses\napp.use(compression());\n\n// Rate limiting (100 requests per 15 minutes per IP)\nconst apiLimiter = rateLimit({\n  windowMs: config.rateLimitWindowMs,\n  max: config.rateLimitMaxRequests,\n  message: { error: 'Too many requests, please try again later.' },\n  standardHeaders: true,\n  legacyHeaders: false,\n});\napp.use('/api/', apiLimiter);\n\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: true, limit: '10mb' }));\n\n// Input validation and sanitization middleware\nimport { inputValidationMiddleware } from './server/middleware/validation.js';\napp.use(inputValidationMiddleware);\n\n// Mount specialized routes\nimport downloadRoutes from './server/routes/downloads.js';\napp.use('/api/downloads', downloadRoutes);\n\n// app.use('/api/relationships', relationshipsRepository.router); // relationshipsRepository has no router\napp.use('/api/investigations', investigationsRouter);\napp.use('/api/investigation', investigationEvidenceRoutes);\napp.use('/api/evidence', evidenceRoutes);\napp.use('/api/entities', entityEvidenceRoutes);\nimport emailRoutes from './server/routes/emailRoutes.js';\n// Authentication middleware will be applied below\n\n// Serve static frontend from dist\n\n// Serve static frontend from dist\nconst distPath = path.join(process.cwd(), 'dist');\nif (fs.existsSync(distPath)) {\n  // Serve static frontend from dist\n  app.use(\n    express.static(distPath, {\n      setHeaders: (res, path) => {\n        // Don't cache index.html to ensure updates are seen immediately\n        if (path.endsWith('index.html')) {\n          res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');\n          res.setHeader('Pragma', 'no-cache');\n          res.setHeader('Expires', '0');\n        } else {\n          // Cache other assets (they have hash chunks)\n          res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');\n        }\n      },\n    }),\n  );\n}\n// Serve project data (images) statically\nconst dataPath = path.join(process.cwd(), 'data');\nif (fs.existsSync(dataPath)) {\n  app.use('/data', express.static(dataPath));\n}\n// Also try resolving relative to project root (handles different CWDs)\ntry {\n  const projectDataPath = path.join(__dirname, '..', 'data');\n  if (fs.existsSync(projectDataPath)) {\n    app.use('/data', express.static(projectDataPath));\n  }\n} catch {\n  void 0;\n}\n// And absolute /data (Docker/host volume)\nconst absDataPath = '/data';\ntry {\n  if (fs.existsSync(absDataPath)) {\n    app.use('/data', express.static(absDataPath));\n  }\n} catch {\n  void 0;\n}\n// Local development document images (\n// maps absolute dataset folder to /files)\ntry {\n  if (fs.existsSync(CORPUS_BASE_PATH)) {\n    app.use('/files', express.static(CORPUS_BASE_PATH));\n  }\n} catch {\n  void 0;\n}\n\n// Robust static resolver for files under /data\napp.get('/api/static', async (req, res, next) => {\n  try {\n    let raw = String(req.query.path || '');\n    if (!raw) return res.status(400).json({ error: 'path required' });\n\n    // Normalize common forms:\n    // - \"data/...\"   → \"/data/...\"\n    // - already absolute \"/data/...\" is left as-is\n    if (raw.startsWith('data/')) {\n      raw = '/data/' + raw.substring('data/'.length);\n    }\n\n    if (!raw.includes('/data/')) return res.status(400).json({ error: 'invalid path' });\n\n    const rel = raw.replace(/^.*[/\\\\]data[/\\\\]/, '').replace(/\\\\/g, '/');\n    const candidates: string[] = [];\n    candidates.push(path.join(process.cwd(), 'data', rel));\n    candidates.push(path.join(__dirname, '..', 'data', rel));\n    candidates.push(path.join('/data', rel.startsWith('/') ? rel.substring(1) : rel));\n\n    for (const fp of candidates) {\n      if (fs.existsSync(fp)) {\n        return res.sendFile(fp);\n      }\n    }\n    return res.status(404).json({ error: 'File not found' });\n  } catch (e) {\n    next(e);\n  }\n});\n\n// Health check endpoint\napp.get('/api/health', (_req, res) => {\n  let dbStatus = 'not_initialized';\n  let stats = { entities: 0, documents: 0 };\n\n  try {\n    const db = getDb();\n    if (db) {\n      dbStatus = 'connected';\n      const entityCount = db.prepare('SELECT COUNT(*) as count FROM entities').get() as {\n        count: number;\n      };\n      const docCount = db.prepare('SELECT COUNT(*) as count FROM documents').get() as {\n        count: number;\n      };\n      stats = { entities: entityCount.count, documents: docCount.count };\n    }\n  } catch (e) {\n    dbStatus = 'error';\n    console.error('Health check DB error:', e);\n  }\n\n  const healthCheck = {\n    status: dbStatus === 'connected' && stats.entities > 0 ? 'healthy' : 'degraded',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime(),\n    database: dbStatus,\n    data: stats,\n    memory: process.memoryUsage(),\n    environment: config.nodeEnv,\n  };\n\n  res.status(healthCheck.status === 'healthy' ? 200 : 503).json(healthCheck);\n});\n\n// Readiness check for Kubernetes/Docker\napp.get('/api/ready', (_req, res) => {\n  if (getDb()) {\n    res.status(200).json({ status: 'ready' });\n  } else {\n    res.status(503).json({ status: 'not_ready', reason: 'database_not_initialized' });\n  }\n});\n\n// Auth Login Endpoint (Public)\n// Auth Routes (Login/Logout)\napp.use('/api/auth', authRoutes);\n\n// Enhanced Analytics API (PUBLIC) - Aggregated data for visualizations\napp.get('/api/analytics/enhanced', async (_req, res, next) => {\n  try {\n    console.log('📊 Starting Enhanced Analytics Fetch...');\n    console.time('analytics-total');\n    const db = getDb();\n\n    // Document breakdown by type\n    console.time('analytics-docs-by-type');\n    const documentsByType = db\n      .prepare(\n        `\n      SELECT \n        evidence_type as type,\n        COUNT(*) as count,\n        SUM(CASE WHEN has_redactions = 1 THEN 1 ELSE 0 END) as redacted,\n        AVG(red_flag_rating) as avgRisk\n      FROM documents \n      WHERE evidence_type IS NOT NULL \n      GROUP BY evidence_type \n      ORDER BY count DESC\n    `,\n      )\n      .all();\n    console.timeEnd('analytics-docs-by-type');\n\n    console.time('analytics-timeline');\n    const timelineData = db\n      .prepare(\n        `\n      SELECT \n        substr(date_created, 1, 7) as period,\n        COUNT(*) as total,\n        SUM(CASE WHEN evidence_type = 'email' THEN 1 ELSE 0 END) as emails,\n        SUM(CASE WHEN evidence_type = 'photo' THEN 1 ELSE 0 END) as photos,\n        SUM(CASE WHEN evidence_type = 'document' THEN 1 ELSE 0 END) as documents,\n        SUM(CASE WHEN evidence_type = 'financial' THEN 1 ELSE 0 END) as financial\n      FROM documents \n      WHERE date_created IS NOT NULL AND length(date_created) >= 7\n      GROUP BY period \n      ORDER BY period ASC\n    `,\n      )\n      .all();\n    console.timeEnd('analytics-timeline');\n\n    console.time('analytics-top-connected');\n    // Top connected entities (by relationship count)\n    const topConnectedEntities = db\n      .prepare(\n        `\n      WITH rel_counts AS (\n        SELECT entity_id, SUM(cnt) as cnt FROM (\n          SELECT source_entity_id as entity_id, COUNT(*) as cnt FROM entity_relationships GROUP BY source_entity_id\n          UNION ALL\n          SELECT target_entity_id as entity_id, COUNT(*) as cnt FROM entity_relationships GROUP BY target_entity_id\n        ) t\n        GROUP BY entity_id\n      )\n      SELECT \n        e.id,\n        e.full_name as name,\n        e.primary_role as role,\n        e.entity_type as type,\n        e.red_flag_rating as riskLevel,\n        COALESCE(rc.cnt, 0) as connectionCount,\n        e.mentions\n      FROM rel_counts rc\n      JOIN entities e ON e.id = rc.entity_id\n      WHERE e.entity_type = 'Person'\n      ORDER BY rc.cnt DESC\n      LIMIT 1000\n    `,\n      )\n      .all();\n    console.timeEnd('analytics-top-connected');\n\n    console.time('analytics-entity-dist');\n    // Entity type distribution\n    const entityTypeDistribution = db\n      .prepare(\n        `\n      SELECT \n        entity_type as type,\n        COUNT(*) as count,\n        AVG(red_flag_rating) as avgRisk\n      FROM entities \n      WHERE entity_type IS NOT NULL \n      GROUP BY entity_type \n      ORDER BY count DESC\n    `,\n      )\n      .all();\n    console.timeEnd('analytics-entity-dist');\n\n    console.time('analytics-risk-by-type');\n    // Risk distribution by entity type\n    const riskByType = db\n      .prepare(\n        `\n      SELECT \n        entity_type as type,\n        red_flag_rating as riskLevel,\n        COUNT(*) as count\n      FROM entities \n      WHERE entity_type IS NOT NULL AND red_flag_rating IS NOT NULL\n      GROUP BY entity_type, red_flag_rating \n      ORDER BY entity_type, red_flag_rating DESC\n    `,\n      )\n      .all();\n    console.timeEnd('analytics-risk-by-type');\n\n    console.time('analytics-redaction-stats');\n    // Overall redaction stats\n    const redactionStats = db\n      .prepare(\n        `\n      SELECT \n        COUNT(*) as totalDocuments,\n        SUM(CASE WHEN has_redactions = 1 THEN 1 ELSE 0 END) as redactedDocuments,\n        (SUM(CASE WHEN has_redactions = 1 THEN 1.0 ELSE 0 END) / COUNT(*) * 100) as redactionPercentage,\n        SUM(redaction_count) as totalRedactions\n      FROM documents\n    `,\n      )\n      .get();\n    console.timeEnd('analytics-redaction-stats');\n\n    console.time('analytics-top-relationships');\n    // Top relationships\n    const topRelationships = db\n      .prepare(\n        `\n      SELECT \n        e1.full_name as source,\n        e2.full_name as target,\n        er.relationship_type as type,\n        er.strength as weight\n      FROM entity_relationships er\n      JOIN entities e1 ON er.source_entity_id = e1.id\n      JOIN entities e2 ON er.target_entity_id = e2.id\n      ORDER BY er.strength DESC\n      LIMIT 2000\n    `,\n      )\n      .all();\n    console.timeEnd('analytics-top-relationships');\n\n    res.set('Cache-Control', 'public, max-age=300'); // 5 min cache\n    res.json({\n      documentsByType,\n      timelineData,\n      topConnectedEntities,\n      entityTypeDistribution,\n      riskByType,\n      redactionStats,\n      topRelationships,\n      totalCounts: {\n        entities: db.prepare('SELECT COUNT(*) as count FROM entities').get().count,\n        documents: db.prepare('SELECT COUNT(*) as count FROM documents').get().count,\n        relationships: db.prepare('SELECT COUNT(*) as count FROM entity_relationships').get().count,\n      },\n      generatedAt: new Date().toISOString(),\n    });\n    console.timeEnd('analytics-total');\n  } catch (error) {\n    console.error('❌ Error fetching enhanced analytics:', error);\n    next(error);\n  }\n});\n\n// Apply Auth Middleware to all other API routes\n// Authentication middleware - Selective protection\napp.use('/api', (req, res, next) => {\n  // 1. User management and profile info always require auth\n  if (req.path.startsWith('/users') || req.path.startsWith('/auth/me')) {\n    return authenticateRequest(req, res, next);\n  }\n\n  // 2. All investigative browsing (GET/HEAD/OPTIONS requests) is public per user request\n  // (media, entities, search, analytics, flights, memory)\n  // OPTIONS is whitelisted to allow CORS preflights to succeed for public routes.\n  if (req.method === 'GET' || req.method === 'HEAD' || req.method === 'OPTIONS') {\n    return next();\n  }\n\n  // 3. All mutations (POST, PUT, PATCH, DELETE) require authentication\n  // This protects media editing, adding entities, and document uploads.\n  authenticateRequest(req, res, next);\n});\n\n// Email routes (protected)\napp.use('/api/emails', emailRoutes);\n\n// User Management Endpoints\napp.get('/api/users', async (_req, res, next) => {\n  try {\n    const db = getDb();\n    const users = db.prepare('SELECT * FROM users ORDER BY username ASC').all();\n    res.json(users);\n  } catch (e) {\n    next(e);\n  }\n});\n\napp.get('/api/users/current', async (req, res, next) => {\n  // Simple simulation of session/auth\n  try {\n    const db = getDb();\n    // Default to the first user if no header (in real app, would use session/token)\n    const userId = req.headers['x-user-id'] || 'user-1';\n    const user = db.prepare('SELECT * FROM users WHERE id = ?').get(userId);\n    if (!user) return res.status(404).json({ error: 'User not found' });\n    res.json(user);\n  } catch (e) {\n    next(e);\n  }\n});\n\n// Create new user (Admin only)\napp.post('/api/users', authenticateRequest, requireRole('admin'), async (req, res, next) => {\n  try {\n    const { username, password, email, role } = req.body;\n\n    if (!username || !password) {\n      return res.status(400).json({ error: 'Username and password required' });\n    }\n\n    const id = `user-${Date.now()}`;\n    const db = getDb();\n\n    // Hash password\n    const passwordHash = bcrypt.hashSync(password, 10);\n\n    db.prepare(\n      `\n      INSERT INTO users (id, username, email, role, password_hash, created_at, last_active)\n      VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)\n    `,\n    ).run(id, username, email || null, role || 'viewer', passwordHash);\n\n    logAudit('create_user', (req as any).user?.id, 'user', id, { username, role });\n    res.status(201).json({ id, username, email, role });\n  } catch (e) {\n    next(e);\n  }\n});\n\n// Update user (Admin only)\napp.put('/api/users/:id', authenticateRequest, requireRole('admin'), async (req, res, next) => {\n  try {\n    const { id } = req.params;\n    const { email, role, password } = req.body;\n    const db = getDb();\n\n    let query = 'UPDATE users SET last_active = CURRENT_TIMESTAMP';\n    const params: any[] = [];\n\n    if (email !== undefined) {\n      query += ', email = ?';\n      params.push(email);\n    }\n\n    if (role !== undefined) {\n      // Prevent self-lockout? simplified for now\n      query += ', role = ?';\n      params.push(role);\n    }\n\n    if (password) {\n      const hash = bcrypt.hashSync(password, 10);\n      query += ', password_hash = ?';\n      params.push(hash);\n    }\n\n    query += ' WHERE id = ?';\n    params.push(id);\n\n    const result = db.prepare(query).run(...params);\n\n    if (result.changes === 0) return res.status(404).json({ error: 'User not found' });\n\n    logAudit('update_user', (req as any).user?.id, 'user', id, {\n      role,\n      emailUpdated: !!email,\n      passwordUpdated: !!password,\n    });\n    res.json({ success: true });\n  } catch (e) {\n    next(e);\n  }\n});\n\n// Delete user (Admin only)\napp.delete('/api/users/:id', authenticateRequest, requireRole('admin'), async (req, res, next) => {\n  try {\n    const { id } = req.params;\n    const db = getDb();\n\n    // Prevent self-deletion\n    if ((req as any).user?.id === id) {\n      return res.status(400).json({ error: 'Cannot delete yourself' });\n    }\n\n    const result = db.prepare('DELETE FROM users WHERE id = ?').run(id);\n\n    if (result.changes === 0) return res.status(404).json({ error: 'User not found' });\n\n    logAudit('delete_user', (req as any).user?.id, 'user', id, {});\n    res.json({ success: true });\n  } catch (e) {\n    next(e);\n  }\n});\n\n// Admin Audit Log Endpoint\napp.get(\n  '/api/admin/audit-logs',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const limit = Math.min(1000, parseInt(req.query.limit as string) || 100); // Increased limit\n      const db = getDb();\n\n      // Check if audit_log table exists (it should, but safety first)\n      try {\n        const logs = db\n          .prepare(\n            `\n        SELECT a.*, u.username as performed_by\n        FROM audit_log a \n        LEFT JOIN users u ON a.user_id = u.id \n        ORDER BY a.timestamp DESC \n        LIMIT ?\n      `,\n          )\n          .all(limit);\n\n        // Parse payload_json safely\n        const parsedLogs = logs.map((log: any) => {\n          let payload = null;\n          try {\n            payload = log.payload_json ? JSON.parse(log.payload_json) : null;\n          } catch (e) {\n            payload = { error: 'Invalid JSON', raw: log.payload_json };\n          }\n          return { ...log, payload };\n        });\n\n        res.json(parsedLogs);\n      } catch (dbError: any) {\n        if (dbError.message.includes('no such table')) {\n          // Create table if missing (auto-heal)\n          db.exec(`\n          CREATE TABLE IF NOT EXISTS audit_log (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            user_id TEXT,\n            action TEXT NOT NULL,\n            object_type TEXT,\n            object_id TEXT,\n            payload_json TEXT,\n            timestamp TEXT DEFAULT CURRENT_TIMESTAMP\n          )\n        `);\n          return res.json([]);\n        }\n        throw dbError;\n      }\n    } catch (e) {\n      next(e);\n    }\n  },\n);\n\n// Document Upload Endpoint with Security Validation (Issue 20)\nconst ALLOWED_MIME_TYPES = [\n  'application/pdf',\n  'text/plain',\n  'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n  'image/jpeg',\n  'image/png',\n];\nconst ALLOWED_EXTENSIONS = ['.pdf', '.txt', '.docx', '.jpg', '.jpeg', '.png'];\nconst MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB\n\nconst uploadStorage = multer.diskStorage({\n  destination: (_req, _file, cb) => {\n    const uploadDir = path.join(process.cwd(), 'uploads');\n    if (!fs.existsSync(uploadDir)) {\n      fs.mkdirSync(uploadDir, { recursive: true });\n    }\n    cb(null, uploadDir);\n  },\n  filename: (_req, file, cb) => {\n    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);\n    const ext = path.extname(file.originalname).toLowerCase();\n    cb(null, `doc-${uniqueSuffix}${ext}`);\n  },\n});\n\nconst uploadFilter = (_req: any, file: Express.Multer.File, cb: multer.FileFilterCallback) => {\n  const ext = path.extname(file.originalname).toLowerCase();\n  if (!ALLOWED_EXTENSIONS.includes(ext)) {\n    return cb(new Error(`File type not allowed. Allowed: ${ALLOWED_EXTENSIONS.join(', ')}`));\n  }\n  if (!ALLOWED_MIME_TYPES.includes(file.mimetype)) {\n    return cb(new Error(`MIME type not allowed: ${file.mimetype}`));\n  }\n  cb(null, true);\n};\n\nconst upload = multer({\n  storage: uploadStorage,\n  fileFilter: uploadFilter,\n  limits: { fileSize: MAX_FILE_SIZE },\n});\n\napp.post('/api/upload-document', upload.single('document'), async (req, res, next) => {\n  try {\n    const file = req.file;\n    if (!file) {\n      return res.status(400).json({ error: 'No file uploaded' });\n    }\n\n    const userId = (req as any).user?.id || 'system';\n    const db = getDb();\n\n    // Calculate file hash for integrity\n    const fileBuffer = fs.readFileSync(file.path);\n    const contentHash = crypto.createHash('md5').update(fileBuffer).digest('hex');\n\n    // Determine evidence type from extension\n    const ext = path.extname(file.originalname).toLowerCase();\n    const evidenceType =\n      ext === '.pdf'\n        ? 'Legal Document'\n        : ['.jpg', '.jpeg', '.png'].includes(ext)\n          ? 'Photograph'\n          : 'Text Document';\n\n    // Insert document record\n    const result = db\n      .prepare(\n        `\n      INSERT INTO documents (file_name, file_path, file_type, file_size, evidence_type, content_hash, created_at, metadata_json)\n      VALUES (?, ?, ?, ?, ?, ?, datetime('now'), ?)\n    `,\n      )\n      .run(\n        file.originalname,\n        file.path,\n        ext.replace('.', ''),\n        file.size,\n        evidenceType,\n        contentHash,\n        JSON.stringify({ uploadedBy: userId, ingestionMethod: 'upload', scanStatus: 'pending' }),\n      );\n\n    const documentId = result.lastInsertRowid;\n\n    // Create initial chain of custody entry\n    try {\n      db.prepare(\n        `\n        INSERT INTO chain_of_custody (evidence_id, action, performed_by, timestamp, details, hash_before, hash_after)\n        VALUES (?, 'acquired', ?, datetime('now'), ?, ?, ?)\n      `,\n      ).run(documentId, userId, 'Document uploaded via API', contentHash, contentHash);\n    } catch (e) {\n      // chain_of_custody might not be set up for document IDs, continue anyway\n      console.warn('Could not create chain_of_custody entry:', e);\n    }\n\n    // Audit log\n    logAudit('upload_document', userId, 'document', String(documentId), {\n      filename: file.originalname,\n      size: file.size,\n      hash: contentHash,\n    });\n\n    res.status(201).json({\n      id: documentId,\n      fileName: file.originalname,\n      filePath: file.path,\n      fileSize: file.size,\n      contentHash,\n      evidenceType,\n      message: 'Document uploaded successfully',\n    });\n  } catch (error) {\n    console.error('Upload error:', error);\n    next(error);\n  }\n});\n\n// API routes with comprehensive error handling\napp.get('/api/entities', cacheMiddleware(300), async (req, res, next) => {\n  try {\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\n    const limit = Math.min(100, Math.max(1, parseInt(req.query.limit as string) || 24));\n    const search = req.query.search as string;\n    const role = req.query.role as string;\n    const likelihood = req.query.likelihood as string | string[];\n    const entityType = req.query.type as string;\n    const sortBy = req.query.sortBy as string;\n    const sortOrder = req.query.sortOrder as 'asc' | 'desc';\n\n    // Validate and sanitize inputs\n    if (search && search.length > 100) {\n      return res.status(400).json({ error: 'Search term too long' });\n    }\n\n    const filters: SearchFilters = {\n      likelihood: 'all',\n      role: 'all',\n      status: 'all',\n      minMentions: 0,\n      searchTerm: undefined,\n      evidenceTypes: undefined,\n      likelihoodScore: undefined,\n      entityType: undefined,\n      sortBy: undefined,\n      sortOrder: undefined,\n    };\n\n    if (search) filters.searchTerm = search.trim();\n    if (role) filters.evidenceTypes = [role.trim()];\n    if (likelihood) {\n      if (Array.isArray(likelihood)) {\n        filters.likelihoodScore = likelihood.map((l) => l as 'HIGH' | 'MEDIUM' | 'LOW');\n      } else {\n        filters.likelihoodScore = [likelihood as 'HIGH' | 'MEDIUM' | 'LOW'];\n      }\n    }\n    if (entityType) filters.entityType = entityType.trim();\n    if (sortBy) filters.sortBy = sortBy.trim() as any;\n    if (sortOrder) filters.sortOrder = sortOrder;\n\n    const result = entitiesRepository.getEntities(page, limit, filters, sortBy as SortOption);\n\n    // Batch fetch photos for these entities\n    const entityIds = result.entities.map((e: any) => e.id);\n    const photosByEntity: Record<string, any[]> = {};\n\n    if (entityIds.length > 0) {\n      try {\n        const photos = mediaRepository.getPhotosForEntities(entityIds);\n        photos.forEach((p: any) => {\n          if (!photosByEntity[p.entityId]) photosByEntity[p.entityId] = [];\n          photosByEntity[p.entityId].push(p);\n        });\n      } catch (err) {\n        console.error('Error fetching entity photos:', err);\n      }\n    }\n\n    // Transform the result to match the expected format\n    const transformedData = result.entities.map((entity: any) => ({\n      id: entity.id,\n      name: entity.full_name || entity.fullName,\n      fullName: entity.full_name || entity.fullName,\n      entity_type: entity.entity_type || entity.entityType || 'Person',\n      primaryRole: entity.primary_role || entity.primaryRole || 'Person of Interest',\n      secondaryRoles: entity.secondary_roles || entity.secondaryRoles || [],\n      mentions: entity.mentions,\n      files: entity.document_count || entity.files || entity.documentCount || 0,\n      contexts: entity.contexts || [],\n      evidence_types: entity.evidence_types || entity.evidenceTypes || [],\n      evidenceTypes: entity.evidence_types || entity.evidenceTypes || [],\n      photos: photosByEntity[entity.id] || [],\n      spicy_passages: entity.red_flag_passages || entity.spicyPassages || [],\n      likelihood_score:\n        entity.likelihood_level || entity.likelihoodScore || entity.likelihoodLevel || 'LOW',\n      red_flag_score: entity.red_flag_score || entity.redFlagScore || 0,\n      red_flag_rating: entity.red_flag_rating || entity.redFlagRating || 0,\n      red_flag_peppers:\n        entity.red_flag_rating || entity.redFlagRating\n          ? '🚩'.repeat(entity.red_flag_rating || entity.redFlagRating)\n          : '🏳️',\n      red_flag_description:\n        entity.red_flag_description ||\n        entity.redFlagDescription ||\n        `Red Flag Index ${entity.red_flag_rating || entity.redFlagRating || 0}`,\n      connectionsToEpstein: entity.connections_summary || entity.connectionsSummary || '',\n    }));\n\n    // Add cache headers for performance\n    res.set({\n      'Cache-Control': 'private, max-age=60',\n      'X-Total-Count': result.total.toString(),\n      'X-Page': page.toString(),\n      'X-Page-Size': limit.toString(),\n      'X-Total-Pages': Math.ceil(result.total / limit).toString(),\n    });\n\n    res.json({\n      data: transformedData,\n      total: result.total,\n      page: page,\n      pageSize: limit,\n      totalPages: Math.ceil(result.total / limit),\n    });\n  } catch (error) {\n    console.error('Error fetching entities:', error);\n    next(error);\n  }\n});\n\n// Entity name validation patterns - reject common extraction artifacts\nconst JUNK_ENTITY_PATTERNS = [\n  /^(The|A|An|Of|To|In|For|And|Or|But|With|At|By|From|On|As|Is|Was|Although|Actually)\\s/i,\n  /^.{1,2}$/, // Too short (1-2 chars)\n  /^\\d+$/, // Numbers only\n  /^[^a-zA-Z]*$/, // No letters\n  /^Page\\s+\\d+/i,\n  /^Section\\s+\\d+/i,\n  /^Document\\s+/i,\n  /^(Unknown|None|Null|N\\/A|TBD)$/i,\n];\n\napp.post('/api/entities', async (req, res, next) => {\n  try {\n    const { full_name } = req.body;\n\n    // Validate entity name to prevent junk data\n    if (full_name) {\n      for (const pattern of JUNK_ENTITY_PATTERNS) {\n        if (pattern.test(full_name)) {\n          return res.status(400).json({\n            error: 'Invalid entity name',\n            message: 'Name appears to be an extraction artifact rather than a valid entity',\n          });\n        }\n      }\n    }\n\n    const id = entitiesRepository.createEntity(req.body);\n    logAudit('create_entity', (req as any).user?.id, 'entity', String(id), {\n      name: req.body.full_name,\n    });\n    res.status(201).json({ id });\n  } catch (e) {\n    next(e);\n  }\n});\n\napp.patch('/api/entities/:id', async (req, res, next) => {\n  try {\n    const id = req.params.id;\n    const changes = entitiesRepository.updateEntity(id, req.body);\n    if (changes === 0) return res.status(404).json({ error: 'Not found or no changes' });\n    logAudit('update_entity', (req as any).user?.id, 'entity', String(id), req.body);\n    res.json({ success: true });\n  } catch (e) {\n    next(e);\n  }\n});\n\n// Get all entities for document linking\napp.get('/api/entities/all', cacheMiddleware(300), async (_req, res, next) => {\n  try {\n    const entities = entitiesRepository.getAllEntities();\n    res.json(entities);\n  } catch (error) {\n    console.error('Error fetching all entities:', error);\n    next(error);\n  }\n});\n\n// Get single entity with error handling\napp.get('/api/entities/:id', async (req, res, next) => {\n  try {\n    const entityId = req.params.id;\n\n    // Validate ID format\n    if (!/^\\d+$/.test(entityId)) {\n      // Special case: if id is 'all', return all entities\n      if (entityId === 'all') {\n        const entities = entitiesRepository.getAllEntities();\n        return res.json(entities);\n      }\n      return res.status(400).json({ error: 'Invalid entity ID format' });\n    }\n\n    const entity = entitiesRepository.getEntityById(entityId) as any;\n\n    if (!entity) {\n      return res.status(404).json({ error: 'Entity not found' });\n    }\n\n    // Transform entity to match expected API format\n    const transformedEntity = {\n      id: entity.id,\n      name: entity.fullName,\n      fullName: entity.fullName,\n      entity_type: entity.entityType || 'Person',\n      primaryRole: entity.primaryRole,\n      secondaryRoles: entity.secondaryRoles || [],\n      mentions: entity.mentions,\n      files: entity.documentCount || (entity.fileReferences ? entity.fileReferences.length : 0),\n      contexts: entity.contexts || [],\n      evidence_types: entity.evidence_types || entity.evidenceTypes || [],\n      evidenceTypes: entity.evidence_types || entity.evidenceTypes || [],\n      spicy_passages: entity.spicyPassages || [],\n      likelihood_score: entity.likelihoodLevel,\n      red_flag_score: entity.redFlagScore !== undefined ? entity.redFlagScore : 0,\n      red_flag_rating: entity.redFlagRating !== undefined ? entity.redFlagRating : 0,\n      red_flag_peppers:\n        entity.redFlagRating !== undefined ? '🚩'.repeat(entity.redFlagRating) : '🏳️',\n      red_flag_description:\n        entity.redFlagDescription ||\n        `Red Flag Index ${entity.redFlagRating !== undefined ? entity.redFlagRating : 0}`,\n      connectionsToEpstein: entity.connectionsSummary || '',\n      fileReferences: entity.fileReferences || [],\n      timelineEvents: entity.timelineEvents || [],\n      networkConnections: entity.networkConnections || [],\n      // Include Black Book information if available\n      blackBookEntry: entity.blackBookEntry || null,\n    };\n    res.json(transformedEntity);\n  } catch (error) {\n    console.error('Error fetching entity:', error);\n    next(error);\n  }\n});\n\n// Communications for an entity (email-based)\napp.get('/api/entities/:id/communications', async (req, res, next) => {\n  try {\n    const entityId = req.params.id;\n    if (!/^\\d+$/.test(entityId)) {\n      return res.status(400).json({ error: 'Invalid entity ID format' });\n    }\n\n    const topic = (req.query.topic as string | undefined) || undefined;\n    const from = (req.query.from as string | undefined) || undefined;\n    const to = (req.query.to as string | undefined) || undefined;\n    const start = (req.query.start as string | undefined) || undefined;\n    const end = (req.query.end as string | undefined) || undefined;\n    const limit = req.query.limit ? parseInt(req.query.limit as string, 10) : undefined;\n\n    const events = communicationsRepository.getCommunicationsForEntity(entityId, {\n      topic,\n      from,\n      to,\n      start,\n      end,\n      limit,\n    });\n\n    res.json({ data: events, total: events.length });\n  } catch (error) {\n    console.error('Error fetching entity communications:', error);\n    next(error);\n  }\n});\n\n// Get all articles\napp.get('/api/articles', async (_req, res, next) => {\n  try {\n    // statsRepository doesn't have getArticles, need to migrate or keep using DB\n    const articles = getDb()\n      .prepare('SELECT * FROM articles ORDER BY red_flag_rating DESC, pub_date DESC')\n      .all();\n    res.json(articles);\n  } catch (error) {\n    console.error('Error fetching articles:', error);\n    next(error);\n  }\n});\n\n// Get documents for a specific entity\napp.get('/api/entities/:id/documents', async (req, res, next) => {\n  try {\n    const entityId = req.params.id;\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\n    const limit = Math.min(100, Math.max(1, parseInt(req.query.limit as string) || 50));\n\n    // Get entity name first\n    const entity = getDb()\n      .prepare('SELECT full_name as name FROM entities WHERE id = ?')\n      .get(entityId) as { name: string };\n\n    if (!entity) {\n      return res.json({ data: [], total: 0, page, pageSize: limit, totalPages: 0 });\n    }\n\n    // Query documents that mention this entity (using simple name search)\n    const offset = (page - 1) * limit;\n    const searchTerm = `%${entity.name}%`;\n\n    const query = `\n      SELECT \n        d.id,\n        d.file_name as fileName,\n        d.file_path as filePath,\n        d.file_type as fileType,\n        d.file_size as fileSize,\n        d.date_created as dateCreated,\n        substr(d.content, 1, 300) as contentPreview,\n        d.evidence_type as evidenceType,\n        0 as mentionsCount,\n        d.content,\n        d.metadata_json as metadata,\n        d.word_count as wordCount,\n        d.red_flag_rating as redFlagRating,\n        d.content_hash as contentHash,\n        d.file_name as title,\n        0 as entityMentions\n      FROM documents d\n      WHERE d.content LIKE ? OR d.file_name LIKE ?\n      ORDER BY d.red_flag_rating DESC\n      LIMIT ? OFFSET ?\n    `;\n\n    const countQuery = `\n      SELECT COUNT(*) as total\n      FROM documents d\n      WHERE d.content LIKE ? OR d.file_name LIKE ?\n    `;\n\n    let documents = getDb().prepare(query).all(searchTerm, searchTerm, limit, offset) as any[];\n\n    // Map file paths to URLs\n    documents = documents.map((doc) => {\n      if (doc.filePath && doc.filePath.startsWith(CORPUS_BASE_PATH)) {\n        doc.filePath = doc.filePath.replace(CORPUS_BASE_PATH, '/files');\n      }\n      return doc;\n    });\n\n    const totalResult = getDb().prepare(countQuery).get(searchTerm, searchTerm) as {\n      total: number;\n    };\n\n    res.json({\n      data: documents,\n      total: totalResult.total,\n      page,\n      pageSize: limit,\n      totalPages: Math.ceil(totalResult.total / limit),\n    });\n  } catch (error) {\n    console.error('Error fetching entity documents:', error);\n    next(error);\n  }\n});\n\n// Black Book endpoint - returns entries from Black Book table\napp.get('/api/black-book', cacheMiddleware(300), async (req, res, next) => {\n  try {\n    const filters = {\n      letter: req.query.letter as string | undefined,\n      search: req.query.search as string | undefined,\n      hasPhone: req.query.hasPhone === 'true',\n      hasEmail: req.query.hasEmail === 'true',\n      hasAddress: req.query.hasAddress === 'true',\n      limit: req.query.limit ? parseInt(req.query.limit as string) : undefined,\n    };\n\n    // Get data\n    const entries = blackBookRepository.getBlackBookEntries(filters);\n\n    // Get total count (inefficient but accurate for now - better to add a count method to repo)\n    // Actually, let's just do a quick count query here or modify repo.\n    // For now, removing limit to get total would be slow.\n    // Let's use the repository to get the count if possible, or just hack it:\n    // We'll create a lightweight count query using existing filters but no limit.\n    // OR just use SQL here directly since we have getDb.\n\n    const db = getDb();\n    // Reconstruct where clause logic roughly or use repo?\n    // Repo doesn't expose count. Let's add count support to repo or just query all IDs.\n    // Simplest fix: Just query a count.\n    const countQuery = `SELECT COUNT(*) as total FROM black_book_entries`;\n    // Note: this ignores filters. But AboutPage uses it for \"Total Black Book entries\", so ignoring filters is actually CORRECT behavior for the stats use case!\n    // The About Page calls it with limit=1 but wants \"Total Entries in DB\".\n\n    const totalResult = db.prepare(countQuery).get() as { total: number };\n\n    res.json({\n      data: entries,\n      total: totalResult.total,\n      page: 1,\n      pageSize: entries.length,\n      totalPages: Math.ceil(totalResult.total / (filters.limit || totalResult.total || 1)),\n    });\n  } catch (error) {\n    console.error('Error fetching Black Book:', error);\n    next(error);\n  }\n});\n\n// Get database statistics\napp.get('/api/stats', cacheMiddleware(300), async (_req, res, next) => {\n  try {\n    const stats = statsRepository.getStatistics();\n    res.set('Cache-Control', 'public, max-age=300'); // 5 min cache\n    res.json(stats);\n  } catch (error) {\n    console.error('Error fetching statistics:', error);\n    next(error);\n  }\n});\n\n// ============ DATA QUALITY & PROVENANCE APIs ============\n// These endpoints support the audit/trust features of the platform\n\n// Get comprehensive data quality metrics\napp.get('/api/data-quality/metrics', async (_req, res, next) => {\n  try {\n    const db = getDb();\n\n    // 1. Basic Document Stats\n    const totalDocs = db.prepare('SELECT COUNT(*) as c FROM documents').get() as { c: number };\n    const docsWithProvenance = db\n      .prepare(\n        \"SELECT COUNT(*) as c FROM documents WHERE source_collection IS NOT NULL AND source_collection != ''\",\n      )\n      .get() as { c: number };\n\n    const sourceCollections = db\n      .prepare(\n        `\n      SELECT COALESCE(source_collection, 'Unknown/Untagged') as name, COUNT(*) as count\n      FROM documents GROUP BY source_collection ORDER BY count DESC LIMIT 20\n    `,\n      )\n      .all();\n\n    const evidenceTypes = db\n      .prepare(\n        `\n      SELECT COALESCE(evidence_type, 'unclassified') as type, COUNT(*) as count\n      FROM documents GROUP BY evidence_type ORDER BY count DESC\n    `,\n      )\n      .all();\n\n    // 2. Entity Quality Metrics\n    const entityStats = db\n      .prepare(\n        `\n      SELECT \n        COUNT(*) as total,\n        SUM(CASE WHEN primary_role IS NOT NULL AND primary_role != 'Unknown' AND primary_role != '' THEN 1 ELSE 0 END) as withRoles,\n        SUM(CASE WHEN red_flag_description IS NOT NULL AND red_flag_description != '' THEN 1 ELSE 0 END) as withDescription,\n        SUM(CASE WHEN (red_flag_rating IS NULL OR red_flag_rating = 0) AND mentions > 0 THEN 1 ELSE 0 END) as missingRatings,\n        SUM(CASE WHEN red_flag_rating IS NULL THEN 1 ELSE 0 END) as nullRedFlagRating\n      FROM entities\n    `,\n      )\n      .get() as any;\n\n    // 3. Data Integrity & Junk Detection\n    const orphanedMentions = db\n      .prepare(\n        `\n      SELECT COUNT(*) as c FROM entity_mentions em\n      LEFT JOIN entities e ON em.entity_id = e.id\n      WHERE e.id IS NULL\n    `,\n      )\n      .get() as { c: number };\n\n    // Optimized junk detection (one query instead of many)\n    const junkPatterns = [\n      'On %',\n      'And %',\n      'The %',\n      'Although %',\n      'Actually %',\n      'Mr %',\n      'Ms %',\n      'Dr %',\n      'However %',\n      'But %',\n      'If %',\n      'When %',\n      'Then %',\n      'So %',\n      'Yet %',\n      'Or %',\n      'As %',\n      'At %',\n      'In %',\n      'To %',\n      'For %',\n      'Of %',\n      'With %',\n      'By %',\n      'About %',\n      'Into %',\n      'Through %',\n      'During %',\n      'Before %',\n      'After %',\n      'Above %',\n      'Below %',\n      'Between %',\n      'Among %',\n      'Within %',\n      'Without %',\n      'Under %',\n      'Over %',\n      'Near %',\n      'Since %',\n      'Until %',\n      'Against %',\n      'Throughout %',\n      'Despite %',\n      'Upon %',\n      'Besides %',\n      'Beyond %',\n      'Inside %',\n      'Outside %',\n    ];\n\n    // Build a single query to count all junk patterns at once\n    const junkWhereClause = junkPatterns.map(() => 'full_name LIKE ?').join(' OR ');\n    const junkEntities = db\n      .prepare(\n        `\n      SELECT COUNT(*) as c FROM entities\n      WHERE LENGTH(full_name) <= 2\n        OR ${junkWhereClause}\n        OR full_name GLOB '[0-9]*' -- Starts with a number\n    `,\n      )\n      .get(...junkPatterns) as { c: number };\n\n    // 4. Score Calculation\n    const totalEntities = entityStats.total || 1;\n    const junkRatio = junkEntities.c / totalEntities;\n    const orphanedRatio = orphanedMentions.c / Math.max(1, totalDocs.c);\n\n    const dataQualityScore = Math.max(0, Math.min(100, 100 - junkRatio * 50 - orphanedRatio * 30));\n\n    res.json({\n      totalDocuments: totalDocs.c,\n      documentsWithProvenance: docsWithProvenance.c,\n      provenanceCoverage:\n        totalDocs.c > 0 ? Math.round((docsWithProvenance.c / totalDocs.c) * 100 * 10) / 10 : 0,\n      sourceCollections,\n      evidenceTypeDistribution: evidenceTypes,\n      entityQuality: {\n        total: entityStats.total,\n        withRoles: entityStats.withRoles,\n        withRedFlagDescription: entityStats.withDescription,\n        nullRedFlagRating: entityStats.nullRedFlagRating || 0,\n        missingRedFlagRatings: entityStats.missingRatings,\n      },\n      dataIntegrity: {\n        orphanedEntityMentions: orphanedMentions.c,\n        potentialJunkEntities: junkEntities.c,\n        dataQualityScore: Math.round(dataQualityScore * 10) / 10,\n      },\n      lastUpdated: new Date().toISOString(),\n    });\n  } catch (error) {\n    console.error('Error fetching data quality metrics:', error);\n    next(error);\n  }\n});\n\n// Get document lineage/provenance\napp.get('/api/documents/:id/lineage', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const docId = req.params.id;\n\n    const doc = db\n      .prepare(\n        `\n      SELECT d.*, orig.file_name as original_file_name, orig.file_path as original_file_path\n      FROM documents d\n      LEFT JOIN documents orig ON d.original_file_id = orig.id\n      WHERE d.id = ?\n    `,\n      )\n      .get(docId) as any;\n\n    if (!doc) return res.status(404).json({ error: 'Document not found' });\n\n    const children = db\n      .prepare(\n        `\n      SELECT id, file_name, page_number FROM documents WHERE parent_id = ? ORDER BY page_number ASC\n    `,\n      )\n      .all(docId);\n\n    const auditEntries = db\n      .prepare(\n        `\n      SELECT timestamp, user_id, action, payload_json FROM audit_log\n      WHERE object_type = 'document' AND object_id = ? ORDER BY timestamp DESC LIMIT 20\n    `,\n      )\n      .all(String(docId));\n\n    res.json({\n      document: {\n        id: doc.id,\n        fileName: doc.file_name,\n        sourceCollection: doc.source_collection,\n        sourceOriginalUrl: doc.source_original_url,\n        credibilityScore: doc.credibility_score,\n        ocrEngine: doc.ocr_engine,\n        ocrQualityScore: doc.ocr_quality_score,\n        processedAt: doc.ocr_processed_at,\n      },\n      originalDocument: doc.original_file_id\n        ? { id: doc.original_file_id, fileName: doc.original_file_name }\n        : null,\n      childDocuments: children,\n      auditTrail: auditEntries.map((e: any) => ({\n        timestamp: e.timestamp,\n        user: e.user_id,\n        action: e.action,\n        details: e.payload_json ? JSON.parse(e.payload_json) : null,\n      })),\n    });\n  } catch (error) {\n    console.error('Error fetching document lineage:', error);\n    next(error);\n  }\n});\n\n// Get entity confidence scoring\napp.get('/api/entities/:id/confidence', async (req, res, next) => {\n  try {\n    const db = getDb();\n    const entityId = req.params.id;\n\n    const entity = db\n      .prepare('SELECT id, full_name FROM entities WHERE id = ?')\n      .get(entityId) as any;\n    if (!entity) return res.status(404).json({ error: 'Entity not found' });\n\n    const mentionsByType = db\n      .prepare(\n        `\n      SELECT d.evidence_type, COUNT(*) as count FROM entity_mentions em\n      JOIN documents d ON em.document_id = d.id WHERE em.entity_id = ? GROUP BY d.evidence_type\n    `,\n      )\n      .all(entityId) as { evidence_type: string; count: number }[];\n\n    const typeWeights: Record<string, number> = {\n      legal: 1.0,\n      testimony: 0.9,\n      flight_log: 0.85,\n      financial: 0.8,\n      email: 0.7,\n      document: 0.6,\n      photo: 0.5,\n    };\n    let weightedScore = 0,\n      totalWeight = 0;\n    for (const m of mentionsByType) {\n      const w = typeWeights[m.evidence_type] || 0.5;\n      weightedScore += w * m.count;\n      totalWeight += m.count;\n    }\n    const confidence =\n      totalWeight > 0 ? Math.min(100, Math.round((weightedScore / totalWeight) * 100)) : 0;\n\n    res.json({\n      entityId,\n      entityName: entity.full_name,\n      confidenceScore: confidence,\n      evidenceBreakdown: mentionsByType,\n      totalMentions: totalWeight,\n      confidenceLevel: confidence >= 80 ? 'High' : confidence >= 50 ? 'Medium' : 'Low',\n    });\n  } catch (error) {\n    console.error('Error calculating entity confidence:', error);\n    next(error);\n  }\n});\n\n// Enhanced Analytics API - Aggregated data for visualizations\n// Forensic Metrics Summary (Tier 3 - Advanced Analytics)\n\n// Forensic Metrics Summary (Tier 3 - Advanced Analytics)\napp.get('/api/forensic/metrics-summary', async (_req, res, next) => {\n  try {\n    const summary = forensicRepository.getMetricsSummary();\n    res.json(summary);\n  } catch (error) {\n    console.error('Error fetching forensic metrics summary:', error);\n    next(error);\n  }\n});\n\n// Documents endpoint - returns paginated documents\napp.get('/api/documents', async (req, res, next) => {\n  try {\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\n    const limit = Math.min(50000, Math.max(1, parseInt(req.query.limit as string) || 50));\n    const sortBy = (req.query.sortBy as string) || 'red_flag';\n    const search = req.query.search as string;\n    const fileType = req.query.fileType as string;\n    const evidenceType = req.query.evidenceType as string;\n    const minRedFlag = parseInt(req.query.minRedFlag as string) || 0;\n    const maxRedFlag = parseInt(req.query.maxRedFlag as string) || 5;\n\n    // Build WHERE clause\n    const whereConditions: string[] = [];\n    const params: any[] = [];\n\n    if (search && search.trim()) {\n      whereConditions.push('(file_name LIKE ? OR content LIKE ?)');\n      const searchPattern = `%${search}%`;\n      params.push(searchPattern, searchPattern);\n    }\n\n    if (fileType && fileType !== 'all') {\n      const types = fileType.split(',');\n      whereConditions.push(`file_type IN (${types.map(() => '?').join(',')})`);\n      params.push(...types);\n    }\n\n    // Evidence type filter (category)\n    if (evidenceType && evidenceType !== 'all') {\n      whereConditions.push('evidence_type = ?');\n      params.push(evidenceType);\n    }\n\n    // Only apply Red Flag filter if explicitly requested (not default values)\n    if (req.query.minRedFlag || req.query.maxRedFlag) {\n      whereConditions.push(\n        '(red_flag_rating IS NULL OR (red_flag_rating >= ? AND red_flag_rating <= ?))',\n      );\n      params.push(minRedFlag, maxRedFlag);\n    }\n\n    // Filter for documents with failed redactions\n    if (req.query.hasFailedRedactions === 'true') {\n      whereConditions.push('has_failed_redactions = 1');\n    }\n\n    const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';\n\n    // Build ORDER BY clause (kept for future use; currently unused in query construction)\n    const _orderByClause = (() => {\n      switch (sortBy) {\n        case 'date':\n          return 'date_created DESC';\n        case 'title':\n          return 'file_name ASC';\n        case 'red_flag':\n        default:\n          return 'red_flag_rating DESC, date_created DESC';\n      }\n    })();\n\n    // Query documents from database\n    const offset = (page - 1) * limit;\n\n    // Use simple count\n    const countQuery = `SELECT COUNT(*) as total FROM documents ${whereClause}`;\n\n    params.push(limit, offset);\n    // Use try-catch for the query itself to catch column errors specifically\n    const result = documentsRepository.getDocuments(page, limit, {\n      search: search,\n      fileType: fileType,\n      evidenceType: evidenceType,\n      minRedFlag: minRedFlag,\n      maxRedFlag: maxRedFlag,\n      sortBy: sortBy,\n    });\n\n    // Map file paths to URLs\n    const mappedDocuments = result.documents.map((doc: any) => {\n      if (doc.filePath && doc.filePath.startsWith(CORPUS_BASE_PATH)) {\n        doc.filePath = doc.filePath.replace(CORPUS_BASE_PATH, '/files');\n      }\n      return doc;\n    });\n\n    // Remove limit/offset for count query\n    const countParams = params.slice(0, -2);\n    const totalResult = getDb()\n      .prepare(countQuery)\n      .get(...countParams) as { total: number };\n\n    res.json({\n      data: mappedDocuments,\n      total: totalResult.total,\n      page,\n      pageSize: limit,\n      totalPages: Math.ceil(totalResult.total / limit),\n    });\n  } catch (error) {\n    console.error('Error fetching documents:', error);\n    next(error);\n  }\n});\n\n// Get single document by ID\napp.get('/api/documents/:id', async (req, res, next) => {\n  try {\n    const id = req.params.id as string;\n    const doc = documentsRepository.getDocumentById(id) as any;\n    if (!doc) {\n      return res.status(404).json({ error: 'not_found' });\n    }\n\n    // Transform file paths to accessible URLs\n    // First check if it's in the local data directory (using loose check for migrated paths)\n    if (doc.file_path && (doc.file_path.includes('/data/') || doc.file_path.includes('\\\\data\\\\'))) {\n      // Replace everything up to and including /data/ with /data/\n      doc.fileUrl = doc.file_path.replace(/^.*[/\\\\]data[/\\\\]/, '/data/').replace(/\\\\/g, '/');\n    } else if (doc.file_path && doc.file_path.startsWith(CORPUS_BASE_PATH)) {\n      doc.fileUrl = doc.file_path.replace(CORPUS_BASE_PATH, '/files');\n    }\n\n    if (doc.original_file_path) {\n      if (\n        doc.original_file_path.includes('/data/') ||\n        doc.original_file_path.includes('\\\\data\\\\')\n      ) {\n        doc.originalFileUrl = doc.original_file_path\n          .replace(/^.*[/\\\\]data[/\\\\]/, '/data/')\n          .replace(/\\\\/g, '/');\n      } else if (doc.original_file_path.startsWith(CORPUS_BASE_PATH)) {\n        doc.originalFileUrl = doc.original_file_path.replace(CORPUS_BASE_PATH, '/files');\n      } else if (doc.original_file_path.startsWith('data/')) {\n        // Handle relative paths like 'data/originals/filename.pdf'\n        doc.originalFileUrl = '/' + doc.original_file_path;\n      } else {\n        // Fallback: serve from /files\n        doc.originalFileUrl = '/files/' + doc.original_file_path;\n      }\n    }\n\n    // Also check if this is an image with OCR content - provide link to view original\n    if (doc.file_type === 'image' || doc.file_type === 'pdf') {\n      doc.isScannedDocument = true;\n    }\n\n    res.json(doc);\n  } catch (error) {\n    console.error('Error fetching document by id:', error);\n    next(error);\n  }\n});\n\n// Email thread context for a document\napp.get('/api/documents/:id/thread', async (req, res, next) => {\n  try {\n    const id = req.params.id as string;\n    const thread = communicationsRepository.getThreadForDocument(id);\n    if (!thread) {\n      return res.status(404).json({ error: 'thread_not_found' });\n    }\n    res.json(thread);\n  } catch (error) {\n    console.error('Error fetching email thread for document:', error);\n    next(error);\n  }\n});\n\n// Get failed redactions for a document\napp.get('/api/documents/:id/redactions', async (req, res, next) => {\n  try {\n    const id = req.params.id as string;\n\n    const doc = getDb()\n      .prepare(\n        `\n      SELECT \n        id,\n        has_failed_redactions,\n        failed_redaction_count,\n        failed_redaction_data\n      FROM documents\n      WHERE id = ?\n    `,\n      )\n      .get(id) as any;\n\n    if (!doc) {\n      return res.status(404).json({ error: 'not_found' });\n    }\n\n    if (!doc.has_failed_redactions) {\n      return res.json({\n        hasFailedRedactions: false,\n        count: 0,\n        redactions: [],\n      });\n    }\n\n    let redactions = [];\n    try {\n      redactions = doc.failed_redaction_data ? JSON.parse(doc.failed_redaction_data) : [];\n    } catch (e) {\n      console.error('Error parsing redaction data:', e);\n    }\n\n    res.json({\n      hasFailedRedactions: true,\n      count: doc.failed_redaction_count || redactions.length,\n      redactions,\n    });\n  } catch (error) {\n    console.error('Error fetching document redactions:', error);\n    next(error);\n  }\n});\n\n// Get original pages for a document\napp.get('/api/documents/:id/pages', async (req, res, next) => {\n  try {\n    const id = req.params.id as string;\n\n    // First check if there's a document_pages table entry (if table exists)\n    let dbPages: any[] = [];\n    try {\n      dbPages = getDb()\n        .prepare('SELECT * FROM document_pages WHERE document_id = ? ORDER BY page_number ASC')\n        .all(id) as any[];\n    } catch {\n      // Table doesn't exist, continue with other methods\n    }\n\n    if (dbPages.length > 0) {\n      // Return pages from the document_pages table\n      const pages = dbPages.map((p: any) => {\n        if (p.page_path && p.page_path.startsWith(CORPUS_BASE_PATH)) {\n          return p.page_path.replace(CORPUS_BASE_PATH, '/files');\n        }\n        return p.page_path || p.page_url;\n      });\n      return res.json({ pages, total: pages.length });\n    }\n\n    // Otherwise, check if request is an OCR document and find its original image\n    const doc = documentsRepository.getDocumentById(id) as any;\n    if (!doc) {\n      return res.status(404).json({ error: 'not_found' });\n    }\n\n    // Check for \"House Oversight XXX-OCR.txt\" pattern\n    // Also check for explicit image folder path in metadata\n    let imageFolder = null;\n    try {\n      if (doc.metadataJson) {\n        const meta = JSON.parse(doc.metadataJson);\n        if (meta.image_folder_path) {\n          imageFolder = meta.image_folder_path;\n        }\n      }\n    } catch {\n      // Ignore JSON parse errors - imageFolder remains empty\n    }\n\n    const oversightMatch = doc.fileName.match(/^House Oversight (\\d+)-OCR\\.txt$/i);\n\n    if (imageFolder || oversightMatch) {\n      const folderNum = imageFolder ? path.basename(imageFolder) : oversightMatch![1]; // e.g., \"001\"\n\n      // Construct path to images folder\n      // Assuming structure: CORPUS_BASE_PATH/Epstein Estate Documents - Seventh Production/IMAGES/{folderNum}/\n      const pathLib = path;\n\n      let imagesBase = '';\n      if (imageFolder) {\n        // If we have an explicit path (e.g. /IMAGES/001), try to construct full path\n        // The stored path is relative to the \"root\" of the corpus usually, or just the folder name.\n        // Let's assume it's relative to CORPUS_BASE_PATH + 'Epstein Estate Documents - Seventh Production'\n        // OR just relative to CORPUS_BASE_PATH.\n        // The migration script set it to `/IMAGES/${volNum}`.\n        imagesBase = pathLib.join(\n          CORPUS_BASE_PATH,\n          'Epstein Estate Documents - Seventh Production',\n          imageFolder,\n        );\n        if (!fs.existsSync(imagesBase)) {\n          imagesBase = pathLib.join(CORPUS_BASE_PATH, imageFolder);\n        }\n      } else {\n        // Fallback to old logic\n        imagesBase = pathLib.join(\n          CORPUS_BASE_PATH,\n          'Epstein Estate Documents - Seventh Production',\n          'IMAGES',\n          folderNum,\n        );\n      }\n\n      if (!fs.existsSync(imagesBase)) {\n        // Try without the \"Seventh Production\" folder just in case\n        // If folderNum is derived from regex\n        if (folderNum) {\n          imagesBase = pathLib.join(CORPUS_BASE_PATH, 'IMAGES', folderNum);\n        }\n      }\n\n      if (fs.existsSync(imagesBase)) {\n        try {\n          const files = fs.readdirSync(imagesBase);\n          const imageFiles = files\n            .filter((f: string) => /\\.(jpg|jpeg|png)$/i.test(f))\n            .sort() // Ensure alphanumeric sort\n            .map((f: string) => {\n              // Construct URL relative to /files\n              // We need to map absolute path to /files URL\n              const absPath = pathLib.join(imagesBase, f);\n              if (absPath.startsWith(CORPUS_BASE_PATH)) {\n                return absPath.replace(CORPUS_BASE_PATH, '/files').replace('//', '/');\n              }\n              return '/files/' + pathLib.relative(CORPUS_BASE_PATH, absPath);\n            });\n\n          if (imageFiles.length > 0) {\n            return res.json({ pages: imageFiles, total: imageFiles.length });\n          }\n        } catch (e) {\n          console.error('Error reading image directory:', e);\n        }\n      }\n    }\n\n    // Check for linked original file\n    if (doc.original_file_path) {\n      let url = doc.original_file_path;\n      if (CORPUS_BASE_PATH && url.startsWith(CORPUS_BASE_PATH)) {\n        url = url.replace(CORPUS_BASE_PATH, '/files');\n      }\n      // Handle potential double slashes\n      url = url.replace('//', '/');\n      return res.json({ pages: [url], total: 1 });\n    }\n\n    // If this document IS an image/PDF, return its own path\n    if (doc.file_type === 'image' || doc.file_type === 'pdf') {\n      let url = doc.file_path;\n      if (url && url.startsWith(CORPUS_BASE_PATH)) {\n        url = url.replace(CORPUS_BASE_PATH, '/files');\n      }\n      if (url) {\n        return res.json({ pages: [url], total: 1 });\n      }\n    }\n\n    // No pages found\n    res.json({ pages: [], total: 0 });\n  } catch (error) {\n    console.error('Error fetching document pages:', error);\n    next(error);\n  }\n});\n\n// Get original file for a document (images, PDFs, etc.)\napp.get('/api/documents/:id/file', async (req, res, next) => {\n  try {\n    const id = req.params.id as string;\n    const doc = documentsRepository.getDocumentById(id) as any;\n    if (!doc) {\n      return res.status(404).json({ error: 'not_found' });\n    }\n\n    // Try to find the original file\n    const filePath = doc.filePath || doc.file_path;\n    if (!filePath) {\n      return res.status(404).json({ error: 'no_file_path' });\n    }\n\n    // Resolve the file path using existing imports\n\n    // Check various possible locations\n    const possiblePaths = [\n      path.resolve(filePath),\n      path.resolve('data', filePath),\n      path.resolve('data', 'documents', filePath),\n      path.resolve('public', filePath),\n    ];\n\n    for (const tryPath of possiblePaths) {\n      if (fs.existsSync(tryPath)) {\n        return res.sendFile(tryPath);\n      }\n    }\n\n    res.status(404).json({ error: 'file_not_found', tried: possiblePaths });\n  } catch (error) {\n    console.error('Error fetching document file:', error);\n    next(error);\n  }\n});\n\n// Evidence search endpoint with Red Flag Index support\napp.get('/api/evidence/search', async (req, res, next) => {\n  try {\n    const query = req.query.query as string;\n    const redFlagMin = parseInt(req.query.redFlagMin as string) || 0;\n    const redFlagMax = parseInt(req.query.redFlagMax as string) || 5;\n    const limit = parseInt(req.query.limit as string) || 50;\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\n\n    if (!query) {\n      return res.status(400).json({ error: 'Search query is required' });\n    }\n\n    const result = await searchRepository.search(query, limit);\n\n    // Filter by Red Flag Index range\n    const filteredEntities = result.entities.filter((entity: any) => {\n      const redFlagRating = entity.redFlagRating || 0;\n      return redFlagRating >= redFlagMin && redFlagRating <= redFlagMax;\n    });\n\n    // Transform entities to match expected API format with Red Flag Index\n    const transformedEntities = filteredEntities.map((entity: any) => {\n      const redFlagRating = entity.redFlagRating || 0;\n      const redFlagIndicators = ['⚪', '🟡', '🟠', '🔴', '🟣', '⚫'][redFlagRating] || '⚪';\n      const redFlagDescriptions = [\n        'No Red Flags',\n        'Minor Red Flags',\n        'Moderate Red Flags',\n        'Significant Red Flags',\n        'Major Red Flags',\n        'Critical Red Flags',\n      ];\n\n      return {\n        id: entity.id,\n        name: entity.fullName,\n        fullName: entity.fullName,\n        primaryRole: entity.primaryRole,\n        secondaryRoles: entity.secondaryRoles || [],\n        mentions: entity.mentions,\n        files: entity.documentCount || (entity.fileReferences ? entity.fileReferences.length : 0),\n        contexts: entity.contexts || [],\n        evidence_types: entity.evidence_types || entity.evidenceTypes || [],\n        spicy_passages: entity.spicyPassages || [],\n        likelihood_score: entity.likelihoodLevel,\n        red_flag_score: entity.redFlagScore !== undefined ? entity.redFlagScore : 0,\n        red_flag_rating: redFlagRating,\n        red_flag_peppers:\n          redFlagRating !== undefined ? redFlagIndicators.repeat(redFlagRating) : '🏳️',\n        red_flag_description: redFlagDescriptions[redFlagRating] || 'No Red Flags',\n        connectionsToEpstein: entity.connectionsSummary || '',\n      };\n    });\n\n    // Pagination\n    const startIndex = (page - 1) * limit;\n    const endIndex = startIndex + limit;\n    const paginatedEntities = transformedEntities.slice(startIndex, endIndex);\n\n    res.json({\n      data: paginatedEntities,\n      total: transformedEntities.length,\n      page: page,\n      pageSize: limit,\n      totalPages: Math.ceil(transformedEntities.length / limit),\n    });\n  } catch (error) {\n    console.error('Error searching evidence:', error);\n    next(error);\n  }\n});\n\n// Legacy search endpoint for backward compatibility\napp.get('/api/search', async (req, res, next) => {\n  try {\n    const query = req.query.q as string;\n    const limit = parseInt(req.query.limit as string) || 50;\n    const type = (req.query.type as string) || 'all';\n    const evidenceType = req.query.evidenceType as string | undefined;\n    const redFlagBand = req.query.redFlagBand as string | undefined;\n    const snippets = ((req.query.snippets as string) || 'true') === 'true';\n    const from = req.query.from as string | undefined;\n    const to = req.query.to as string | undefined;\n\n    if (!query) {\n      return res.status(400).json({ error: 'Search query is required' });\n    }\n\n    const result = await searchRepository.search(query, limit);\n\n    const transformedEntities = result.entities.map((entity: any) => ({\n      id: entity.id,\n      name: entity.fullName,\n      fullName: entity.fullName,\n      primaryRole: entity.primaryRole,\n      secondaryRoles: entity.secondaryRoles || [],\n      mentions: entity.mentions,\n      files: entity.documentCount || (entity.fileReferences ? entity.fileReferences.length : 0),\n      contexts: entity.contexts || [],\n      evidence_types: entity.evidence_types || entity.evidenceTypes || [],\n      spicy_passages: entity.spicyPassages || [],\n      likelihood_score: entity.likelihoodLevel,\n      red_flag_score: entity.redFlagScore !== undefined ? entity.redFlagScore : 0,\n      red_flag_rating: entity.redFlagRating !== undefined ? entity.redFlagRating : 0,\n      red_flag_peppers:\n        entity.redFlagRating !== undefined ? '🚩'.repeat(entity.redFlagRating) : '🏳️',\n      red_flag_description:\n        entity.redFlagDescription ||\n        `Red Flag Index ${entity.redFlagRating !== undefined ? entity.redFlagRating : 0}`,\n      connectionsToEpstein: entity.connectionsSummary || '',\n    }));\n\n    let transformedDocuments = result.documents.map((doc: any) => ({\n      id: doc.id,\n      fileName: doc.fileName,\n      filePath: doc.filePath,\n      fileType: doc.fileType,\n      evidenceType: doc.evidenceType,\n      snippet: snippets ? doc.snippet : undefined,\n      contentPreview: snippets ? doc.snippet || doc.contentPreview : doc.contentPreview,\n      createdAt: doc.createdAt,\n      redFlagBand:\n        typeof doc.redFlagRating === 'number'\n          ? doc.redFlagRating >= 5\n            ? 'critical'\n            : doc.redFlagRating >= 4\n              ? 'high'\n              : doc.redFlagRating >= 2\n                ? 'medium'\n                : 'low'\n          : 'unknown',\n    }));\n\n    if (type === 'entity') {\n      transformedDocuments = [];\n    }\n\n    if (evidenceType) {\n      transformedDocuments = transformedDocuments.filter(\n        (d: any) => (d.evidenceType || '').toLowerCase() === evidenceType.toLowerCase(),\n      );\n    }\n    if (redFlagBand) {\n      transformedDocuments = transformedDocuments.filter((d: any) => d.redFlagBand === redFlagBand);\n    }\n    if (from) {\n      transformedDocuments = transformedDocuments.filter(\n        (d: any) => d.createdAt && d.createdAt >= from,\n      );\n    }\n    if (to) {\n      transformedDocuments = transformedDocuments.filter(\n        (d: any) => d.createdAt && d.createdAt <= to,\n      );\n    }\n\n    res.json({\n      entities: transformedEntities,\n      documents: transformedDocuments,\n    });\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Analytics endpoint\napp.get('/api/analytics', async (_req, res, next) => {\n  try {\n    const stats = statsRepository.getStatistics();\n    res.json(stats);\n  } catch (error) {\n    console.error('Error fetching analytics:', error);\n    next(error);\n  }\n});\n\n// Get timeline events\napp.get('/api/timeline', async (_req, res, next) => {\n  try {\n    const events = timelineRepository.getTimelineEvents();\n    res.set('Cache-Control', 'public, max-age=300'); // 5 min cache\n    res.json(events);\n  } catch (error) {\n    console.error('Error fetching timeline events:', error);\n    next(error);\n  }\n});\n\n// ============================================\n// Photo Browser API Endpoints\n// ============================================\n\n// Get all albums\napp.get('/api/media/albums', async (_req, res, next) => {\n  try {\n    const albums = mediaService.getAllAlbums();\n    res.set('Cache-Control', 'public, max-age=120'); // 2 min cache\n    res.json(albums);\n  } catch (error) {\n    console.error('Error fetching albums:', error);\n    next(error);\n  }\n});\n\n// Get single album by ID\napp.get('/api/media/albums/:id', async (req, res, next) => {\n  try {\n    const albumId = parseInt(req.params.id);\n    if (isNaN(albumId)) {\n      return res.status(400).json({ error: 'Invalid album ID' });\n    }\n\n    const album = mediaService.getAlbumById(albumId);\n    if (!album) {\n      return res.status(404).json({ error: 'Album not found' });\n    }\n\n    res.json(album);\n  } catch (error) {\n    console.error('Error fetching album:', error);\n    next(error);\n  }\n});\n\n// Get images in an album\napp.get('/api/media/albums/:id/images', async (req, res, next) => {\n  try {\n    const albumId = parseInt(req.params.id);\n    if (isNaN(albumId)) {\n      return res.status(400).json({ error: 'Invalid album ID' });\n    }\n\n    const images = mediaService.getAllImages({ albumId });\n    res.json(images);\n  } catch (error) {\n    console.error('Error fetching album images:', error);\n    next(error);\n  }\n});\n// Get albums for audio\napp.get('/api/media/audio/albums', async (_req, res, next) => {\n  try {\n    const albums = mediaRepository.getAlbumsByMediaType('audio');\n    res.json(albums);\n  } catch (error) {\n    console.error('Error fetching audio albums:', error);\n    next(error);\n  }\n});\n\n// Get audio files\napp.get('/api/media/audio', async (req, res, next) => {\n  try {\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\n    const limit = Math.min(100, parseInt(req.query.limit as string) || 24);\n    const albumId = req.query.albumId ? parseInt(req.query.albumId as string) : undefined;\n    const transcriptQuery = (req.query.transcriptQuery as string | undefined)?.trim() || undefined;\n\n    // Use mediaRepository with fileType='audio'\n    // Note: getMediaItemsPaginated on mediaRepository queries the media_items table\n    const result = await mediaRepository.getMediaItemsPaginated(page, limit, {\n      fileType: 'audio',\n      entityId: req.query.entityId as string,\n      albumId,\n      sortBy: req.query.sortBy as 'title' | 'date' | 'rating' | undefined,\n      transcriptQuery,\n    });\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error fetching audio:', error);\n    next(error);\n  }\n});\n\n// Get single audio item metadata by ID (used for deep-linking into AudioBrowser)\napp.get('/api/media/audio/:id', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    if (Number.isNaN(id)) {\n      return res.status(400).json({ error: 'Invalid audio ID' });\n    }\n\n    const item = mediaRepository.getMediaItemById(id);\n    if (!item) {\n      return res.status(404).json({ error: 'Audio not found' });\n    }\n\n    res.json(item);\n  } catch (error) {\n    console.error('Error fetching audio item by id:', error);\n    next(error);\n  }\n});\n\napp.get('/api/media/audio/:id/stream', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    const item = mediaRepository.getMediaItemById(id);\n    if (!item) return res.status(404).json({ error: 'Audio not found' });\n\n    // Resolve path similar to images\n    // Resolve path robustly\n    let filePath = item.file_path || item.filePath;\n\n    // If path is relative, resolve it against CWD\n    if (!path.isAbsolute(filePath)) {\n      // Remove leading slash if present to avoid joining issues (though path.join handles it usually, consistent logic is better)\n      if (filePath.startsWith('/')) filePath = filePath.slice(1);\n      filePath = path.join(process.cwd(), filePath);\n    }\n\n    console.log(`[Stream] Resolved path for ID ${id}: ${filePath}`); // Debug log\n\n    if (!fs.existsSync(filePath)) {\n      return res.status(404).json({ error: 'Audio file not found on server' });\n    }\n\n    res.sendFile(filePath);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Get albums for video\napp.get('/api/media/video/albums', async (_req, res, next) => {\n  try {\n    const albums = mediaRepository.getAlbumsByMediaType('video');\n    res.json(albums);\n  } catch (error) {\n    console.error('Error fetching video albums:', error);\n    next(error);\n  }\n});\n\n// Get video files\napp.get('/api/media/video', async (req, res, next) => {\n  try {\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\n    const limit = Math.min(100, parseInt(req.query.limit as string) || 24);\n    const albumId = req.query.albumId ? parseInt(req.query.albumId as string) : undefined;\n    const transcriptQuery = (req.query.transcriptQuery as string | undefined)?.trim() || undefined;\n\n    // Use mediaRepository with fileType='video'\n    const result = await mediaRepository.getMediaItemsPaginated(page, limit, {\n      fileType: 'video',\n      entityId: req.query.entityId as string,\n      albumId,\n      sortBy: req.query.sortBy as 'title' | 'date' | 'rating' | undefined,\n      transcriptQuery,\n    });\n\n    res.json(result);\n  } catch (error) {\n    console.error('Error fetching video:', error);\n    next(error);\n  }\n});\n\napp.get('/api/media/video/:id/stream', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    const item = mediaRepository.getMediaItemById(id);\n    if (!item) return res.status(404).json({ error: 'Video not found' });\n\n    // Resolve path similar to images\n    // Resolve path robustly\n    let filePath = item.file_path || item.filePath;\n\n    // If path is relative, resolve it against CWD\n    if (!path.isAbsolute(filePath)) {\n      if (filePath.startsWith('/')) filePath = filePath.slice(1);\n      filePath = path.join(process.cwd(), filePath);\n    }\n\n    if (!fs.existsSync(filePath)) {\n      return res.status(404).json({ error: 'Video file not found on server' });\n    }\n\n    // sendFile handles Range requests automatically\n    res.sendFile(filePath);\n  } catch (error) {\n    next(error);\n  }\n});\n\napp.get('/api/media/video/:id/thumbnail', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    const item = mediaRepository.getMediaItemById(id);\n    if (!item) return res.status(404).json({ error: 'Video not found' });\n\n    // Check metadata for thumbnail path\n    const thumbnailPath = item.metadata?.thumbnailPath;\n\n    if (!thumbnailPath) {\n      // Fallback or 404?\n      return res.status(404).json({ error: 'Thumbnail not found' });\n    }\n\n    // Resolve path robustly\n    const filePath = thumbnailPath;\n\n    // Check various possible locations\n    const candidates: string[] = [];\n\n    // If it starts with /data/ or data/, try resolving relative to CWD\n    if (filePath.startsWith('/data/')) {\n      candidates.push(path.join(process.cwd(), filePath.substring(1)));\n      candidates.push(path.join('/data', filePath.substring('/data/'.length)));\n    } else if (filePath.startsWith('data/')) {\n      candidates.push(path.join(process.cwd(), filePath));\n      candidates.push(path.join('/data', filePath.substring('data/'.length)));\n    } else if (path.isAbsolute(filePath)) {\n      candidates.push(filePath);\n      // Also try stripping root if it looks like a container path\n      if (filePath.startsWith('/')) {\n        candidates.push(path.join(process.cwd(), filePath.substring(1)));\n      }\n    } else {\n      candidates.push(path.join(process.cwd(), 'data', filePath));\n      candidates.push(path.join('/data', filePath));\n    }\n\n    const absPath = candidates.find((c) => fs.existsSync(c)) || candidates[0];\n\n    if (!fs.existsSync(absPath)) {\n      console.error(\n        `[Thumbnail] Failed to resolve video thumbnail for ID ${id}. Tried:`,\n        candidates,\n      );\n      return res.status(404).json({ error: 'Thumbnail file not found on server' });\n    }\n\n    res.sendFile(absPath);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Get all images with filtering and sorting\napp.get('/api/media/images', async (req, res, next) => {\n  try {\n    const filter: any = {};\n    const sort: any = {};\n    const slim = req.query.slim === 'true'; // Return minimal fields for grid view\n\n    // Pagination params - apply defaults if not provided to prevent loading all images\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\n    const limit = Math.min(1000, Math.max(1, parseInt(req.query.limit as string) || 50));\n    const offset = (page - 1) * limit;\n    filter.limit = limit;\n    filter.offset = offset;\n\n    if (req.query.albumId) {\n      filter.albumId = parseInt(req.query.albumId as string);\n    }\n    if (req.query.format) {\n      filter.format = req.query.format as string;\n    }\n    if (req.query.dateFrom) {\n      filter.dateFrom = req.query.dateFrom as string;\n    }\n    if (req.query.dateTo) {\n      filter.dateTo = req.query.dateTo as string;\n    }\n    if (req.query.search) {\n      filter.searchQuery = req.query.search as string;\n    }\n    if (req.query.tagId) {\n      filter.tagId = parseInt(req.query.tagId as string);\n    }\n    if (req.query.personId) {\n      filter.personId = parseInt(req.query.personId as string);\n    }\n    if (req.query.hasPeople === 'true') {\n      filter.hasPeople = true;\n    }\n\n    if (req.query.sortField) {\n      sort.field = req.query.sortField as string;\n    }\n    if (req.query.sortOrder) {\n      sort.order = req.query.sortOrder as 'asc' | 'desc';\n    }\n\n    const images = mediaService.getAllImages(filter, sort);\n    const totalCount = mediaService.getImageCount(filter);\n    res.set('X-Total-Count', totalCount.toString());\n    res.set('Access-Control-Expose-Headers', 'X-Total-Count');\n\n    // If slim mode, return only essential fields for grid view (minimize payload)\n    if (slim && Array.isArray(images)) {\n      const slimImages = images.map((img: any) => ({\n        id: img.id,\n        title: img.title,\n        isSensitive: img.is_sensitive,\n        albumId: img.album_id,\n        dateTaken: img.date_taken,\n        dateAdded: img.date_added,\n        dateModified: img.date_modified,\n        fileSize: img.file_size,\n      }));\n      return res.json(slimImages);\n    }\n\n    res.json(images);\n  } catch (error) {\n    console.error('Error fetching images:', error);\n    next(error);\n  }\n});\n\n// Get single image by ID\napp.get('/api/media/images/:id', async (req, res, next) => {\n  try {\n    const imageId = parseInt(req.params.id);\n    if (isNaN(imageId)) {\n      return res.status(400).json({ error: 'Invalid image ID' });\n    }\n\n    const image = mediaService.getImageById(imageId);\n    if (!image) {\n      return res.status(404).json({ error: 'Image not found' });\n    }\n\n    res.json(image);\n  } catch (error) {\n    console.error('Error fetching image:', error);\n    next(error);\n  }\n});\n\napp.get('/api/media/images/:id/file', async (req, res, next) => {\n  try {\n    const imageId = parseInt(req.params.id);\n    if (isNaN(imageId)) {\n      return res.status(400).json({ error: 'Invalid image ID' });\n    }\n    const image = mediaService.getImageById(imageId);\n    if (!image) {\n      return res.status(404).json({ error: 'Image not found' });\n    }\n    const p = ((image as any).path || (image as any).file_path || '').toString();\n    if (!p) {\n      return res.status(404).json({ error: 'Image path missing' });\n    }\n\n    // Since all real data is in /data, we'll resolve paths relative to that\n    let absPath = p;\n    const candidates: string[] = [];\n    if (p.startsWith('/data/')) {\n      candidates.push(path.join(process.cwd(), p.substring(1)));\n      candidates.push(path.join('/data', p.substring('/data/'.length)));\n    } else if (p.startsWith('data/')) {\n      candidates.push(path.join(process.cwd(), p));\n      candidates.push(path.join('/data', p.substring('data/'.length)));\n    } else if (path.isAbsolute(p)) {\n      candidates.push(p);\n    } else {\n      candidates.push(path.join(process.cwd(), 'data', p));\n      candidates.push(path.join('/data', p));\n    }\n    absPath = candidates.find((c) => fs.existsSync(c)) || candidates[0];\n\n    if (!fs.existsSync(absPath)) {\n      return res.status(404).json({ error: 'Image file not found' });\n    }\n    res.sendFile(absPath);\n  } catch (error) {\n    next(error);\n  }\n});\n\napp.get('/api/media/images/:id/raw', async (req, res, next) => {\n  try {\n    const imageId = parseInt(req.params.id);\n    if (isNaN(imageId)) {\n      return res.status(400).json({ error: 'Invalid image ID' });\n    }\n    const image = mediaService.getImageById(imageId);\n    if (!image) {\n      return res.status(404).json({ error: 'Image not found' });\n    }\n    const p = ((image as any).path || (image as any).file_path || '').toString();\n    if (!p) {\n      return res.status(404).json({ error: 'Image path missing' });\n    }\n\n    // Since all real data is in /data, we'll resolve paths relative to that\n    let absPath = p;\n    const candidates: string[] = [];\n    if (p.startsWith('/data/')) {\n      candidates.push(path.join(process.cwd(), p.substring(1)));\n      candidates.push(path.join('/data', p.substring('/data/'.length)));\n    } else if (p.startsWith('data/')) {\n      candidates.push(path.join(process.cwd(), p));\n      candidates.push(path.join('/data', p.substring('data/'.length)));\n    } else if (path.isAbsolute(p)) {\n      candidates.push(p);\n    } else {\n      candidates.push(path.join(process.cwd(), 'data', p));\n      candidates.push(path.join('/data', p));\n    }\n    absPath = candidates.find((c) => fs.existsSync(c)) || candidates[0];\n\n    if (!fs.existsSync(absPath)) {\n      return res.status(404).json({ error: 'Image file not found' });\n    }\n    res.sendFile(absPath);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Get thumbnail for an image (smaller, faster loading)\napp.get('/api/media/images/:id/thumbnail', async (req, res, next) => {\n  try {\n    const imageId = parseInt(req.params.id);\n    if (isNaN(imageId)) {\n      return res.status(400).json({ error: 'Invalid image ID' });\n    }\n    const image = mediaService.getImageById(imageId);\n    if (!image) {\n      return res.status(404).json({ error: 'Image not found' });\n    }\n\n    // Check for thumbnail path first\n    const thumbnailPath = ((image as any).thumbnail_path || '').toString();\n    let absPath = '';\n\n    if (thumbnailPath && thumbnailPath.includes('thumbnails')) {\n      // Use the thumbnail\n      const candidates: string[] = [];\n      if (thumbnailPath.startsWith('/data/')) {\n        candidates.push(path.join(process.cwd(), thumbnailPath.substring(1)));\n        candidates.push(path.join('/data', thumbnailPath.substring('/data/'.length)));\n      } else if (thumbnailPath.startsWith('data/')) {\n        candidates.push(path.join(process.cwd(), thumbnailPath));\n        candidates.push(path.join('/data', thumbnailPath.substring('data/'.length)));\n      } else if (thumbnailPath.startsWith('/thumbnails/')) {\n        candidates.push(path.join(process.cwd(), 'data', thumbnailPath.substring(1)));\n        candidates.push(path.join('/data', thumbnailPath.substring(1)));\n      } else if (path.isAbsolute(thumbnailPath)) {\n        candidates.push(thumbnailPath);\n      } else {\n        candidates.push(path.join(process.cwd(), 'data', thumbnailPath));\n        candidates.push(path.join('/data', thumbnailPath));\n      }\n      absPath = candidates.find((c) => fs.existsSync(c)) || candidates[0];\n    }\n\n    // Fall back to original image if thumbnail doesn't exist\n    if (!absPath || !fs.existsSync(absPath)) {\n      const p = ((image as any).path || (image as any).file_path || '').toString();\n      const candidates: string[] = [];\n      if (p.startsWith('/data/')) {\n        candidates.push(path.join(process.cwd(), p.substring(1)));\n        candidates.push(path.join('/data', p.substring('/data/'.length)));\n      } else if (p.startsWith('data/')) {\n        candidates.push(path.join(process.cwd(), p));\n        candidates.push(path.join('/data', p.substring('data/'.length)));\n      } else if (path.isAbsolute(p)) {\n        candidates.push(p);\n      } else {\n        candidates.push(path.join(process.cwd(), 'data', p));\n        candidates.push(path.join('/data', p));\n      }\n      absPath = candidates.find((c) => fs.existsSync(c)) || candidates[0];\n    }\n\n    if (!absPath || !fs.existsSync(absPath)) {\n      return res.status(404).json({ error: 'Thumbnail not found' });\n    }\n\n    // Set aggressive cache headers for thumbnails (immutable - never change)\n    const stat = fs.statSync(absPath);\n    const etag = `\"${imageId}-${stat.mtime.getTime()}\"`;\n\n    res.set({\n      'Cache-Control': 'public, max-age=31536000, immutable',\n      'Content-Type': 'image/jpeg',\n      ETag: etag,\n      'Last-Modified': stat.mtime.toUTCString(),\n    });\n\n    // Handle conditional GET requests (304 Not Modified)\n    if (req.headers['if-none-match'] === etag) {\n      return res.status(304).end();\n    }\n\n    res.sendFile(absPath);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Search images\n\n// ============================================================================\n// BATCH OPERATIONS (Must be defined BEFORE single image routes with :id)\n// ============================================================================\n\n// Batch rotate images (Admin only)\napp.put(\n  '/api/media/images/batch/rotate',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const { imageIds, direction } = req.body;\n\n      if (!Array.isArray(imageIds) || imageIds.length === 0) {\n        return res.status(400).json({ error: 'Invalid image IDs' });\n      }\n\n      if (!['left', 'right'].includes(direction)) {\n        return res.status(400).json({ error: 'Invalid rotation direction' });\n      }\n\n      const rotationAngle = direction === 'left' ? -90 : 90;\n      const results = [];\n\n      // Rotate each image\n      for (const imageId of imageIds) {\n        try {\n          const id = parseInt(imageId.toString());\n          if (isNaN(id)) continue;\n\n          const image = mediaService.getImageById(id);\n          if (!image) continue;\n\n          // Rotate the image\n          await mediaService.rotateImage(id, rotationAngle);\n\n          // Regenerate thumbnail\n          const thumbnailDir = path.dirname(\n            (image as any).thumbnail_path ||\n              image.thumbnailPath ||\n              path.join(path.dirname(image.path), 'thumbnails'),\n          );\n          await mediaService.generateThumbnail(image.path, thumbnailDir, {\n            force: true,\n            orientation: 1,\n          });\n\n          // Get updated image\n          const updatedImage = mediaService.getImageById(id);\n          results.push({ id, success: true, image: updatedImage });\n        } catch (err) {\n          console.error(`Error rotating image ${imageId}:`, err);\n          results.push({ id: imageId, success: false, error: (err as Error).message });\n        }\n      }\n\n      res.json({ results });\n    } catch (error) {\n      console.error('Error batch rotating images:', error);\n      next(error);\n    }\n  },\n);\n\n// Batch rate images\napp.put(\n  '/api/media/images/batch/rate',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const { imageIds, rating } = req.body;\n\n      if (!Array.isArray(imageIds) || imageIds.length === 0) {\n        return res.status(400).json({ error: 'Invalid image IDs' });\n      }\n\n      if (typeof rating !== 'number' || rating < 1 || rating > 5) {\n        return res.status(400).json({ error: 'Invalid rating value' });\n      }\n\n      const results = [];\n\n      // Rate each image\n      for (const imageId of imageIds) {\n        try {\n          const id = parseInt(imageId.toString());\n          if (isNaN(id)) continue;\n\n          // Update rating in database\n          const db = getDb();\n          const result = db.prepare('UPDATE images SET rating = ? WHERE id = ?').run(rating, id);\n\n          if (result.changes === 0) {\n            results.push({ id, success: false, error: 'Image not found' });\n          } else {\n            results.push({ id, success: true });\n          }\n        } catch (err) {\n          console.error(`Error rating image ${imageId}:`, err);\n          results.push({ id: imageId, success: false, error: (err as Error).message });\n        }\n      }\n\n      res.json({ results });\n    } catch (error) {\n      console.error('Error batch rating images:', error);\n      next(error);\n    }\n  },\n);\n\n// Batch tag images\napp.put(\n  '/api/media/images/batch/tags',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const { imageIds, tagIds, action } = req.body; // action: 'add' or 'remove'\n\n      if (!Array.isArray(imageIds) || imageIds.length === 0) {\n        return res.status(400).json({ error: 'Invalid image IDs' });\n      }\n\n      if (!Array.isArray(tagIds) || tagIds.length === 0) {\n        return res.status(400).json({ error: 'Invalid tag IDs' });\n      }\n\n      if (!['add', 'remove'].includes(action)) {\n        return res.status(400).json({ error: 'Invalid action' });\n      }\n\n      const results = [];\n      const db = getDb();\n\n      // Process each image\n      for (const imageId of imageIds) {\n        try {\n          const id = parseInt(imageId.toString());\n          if (isNaN(id)) continue;\n\n          // Process each tag\n          for (const tagId of tagIds) {\n            const tid = parseInt(tagId.toString());\n            if (isNaN(tid)) continue;\n\n            if (action === 'add') {\n              // Add tag to image\n              db.prepare('INSERT OR IGNORE INTO image_tags (image_id, tag_id) VALUES (?, ?)').run(\n                id,\n                tid,\n              );\n            } else {\n              // Remove tag from image\n              db.prepare('DELETE FROM image_tags WHERE image_id = ? AND tag_id = ?').run(id, tid);\n            }\n          }\n\n          results.push({ id, success: true });\n        } catch (err) {\n          console.error(`Error tagging image ${imageId}:`, err);\n          results.push({ id: imageId, success: false, error: (err as Error).message });\n        }\n      }\n\n      res.json({ results });\n    } catch (error) {\n      console.error('Error batch tagging images:', error);\n      next(error);\n    }\n  },\n);\n\n// Batch tagging for Audio/Video (Media Items)\napp.put(\n  '/api/media/items/batch/tags',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const { itemIds, tagIds, action } = req.body;\n\n      if (!Array.isArray(itemIds) || itemIds.length === 0)\n        return res.status(400).json({ error: 'Invalid item IDs' });\n      if (!Array.isArray(tagIds) || tagIds.length === 0)\n        return res.status(400).json({ error: 'Invalid tag IDs' });\n      if (!['add', 'remove'].includes(action))\n        return res.status(400).json({ error: 'Invalid action' });\n\n      const results = [];\n\n      for (const itemId of itemIds) {\n        try {\n          const id = parseInt(itemId);\n          if (isNaN(id)) continue;\n\n          for (const tagId of tagIds) {\n            const tid = parseInt(tagId);\n            if (isNaN(tid)) continue;\n\n            if (action === 'add') {\n              mediaService.addTagToItem(id, tid);\n            } else {\n              mediaService.removeTagFromItem(id, tid);\n            }\n          }\n          results.push({ id, success: true });\n        } catch (err) {\n          results.push({ id: itemId, success: false, error: (err as Error).message });\n        }\n      }\n      res.json({ results });\n    } catch (error) {\n      console.error('Error batch tagging items:', error);\n      next(error);\n    }\n  },\n);\n\napp.put(\n  '/api/media/items/batch/people',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const { itemIds, personIds, action } = req.body;\n\n      if (!Array.isArray(itemIds) || itemIds.length === 0)\n        return res.status(400).json({ error: 'Invalid item IDs' });\n      if (!Array.isArray(personIds) || personIds.length === 0)\n        return res.status(400).json({ error: 'Invalid person IDs' });\n      if (!['add', 'remove'].includes(action))\n        return res.status(400).json({ error: 'Invalid action' });\n\n      const results = [];\n\n      for (const itemId of itemIds) {\n        try {\n          const id = parseInt(itemId);\n          if (isNaN(id)) continue;\n\n          for (const personId of personIds) {\n            const pid = parseInt(personId);\n            if (isNaN(pid)) continue;\n\n            if (action === 'add') {\n              mediaService.addPersonToItem(id, pid);\n            } else {\n              mediaService.removePersonFromItem(id, pid);\n            }\n          }\n          results.push({ id, success: true });\n        } catch (err) {\n          results.push({ id: itemId, success: false, error: (err as Error).message });\n        }\n      }\n      res.json({ results });\n    } catch (error) {\n      console.error('Error batch adding people to items:', error);\n      next(error);\n    }\n  },\n);\n\n// Batch update metadata\napp.put(\n  '/api/media/images/batch/metadata',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const { imageIds, updates } = req.body; // updates: { title?, description? }\n\n      if (!Array.isArray(imageIds) || imageIds.length === 0) {\n        return res.status(400).json({ error: 'Invalid image IDs' });\n      }\n\n      if (!updates || typeof updates !== 'object') {\n        return res.status(400).json({ error: 'Invalid updates' });\n      }\n\n      const results = [];\n      const db = getDb();\n\n      // Build update query dynamically based on provided fields\n      const fields = [];\n      const values = [];\n\n      if (updates.title !== undefined) {\n        fields.push('title = ?');\n        values.push(updates.title);\n      }\n\n      if (updates.description !== undefined) {\n        fields.push('description = ?');\n        values.push(updates.description);\n      }\n\n      if (fields.length === 0) {\n        return res.status(400).json({ error: 'No valid fields to update' });\n      }\n\n      // Process each image\n      for (const imageId of imageIds) {\n        try {\n          const id = parseInt(imageId.toString());\n          if (isNaN(id)) continue;\n\n          // Update image metadata\n          const stmt = db.prepare(`UPDATE images SET ${fields.join(', ')} WHERE id = ?`);\n          const result = stmt.run(...values, id);\n\n          if (result.changes === 0) {\n            results.push({ id, success: false, error: 'Image not found' });\n          } else {\n            results.push({ id, success: true });\n          }\n        } catch (err) {\n          console.error(`Error updating metadata for image ${imageId}:`, err);\n          results.push({ id: imageId, success: false, error: (err as Error).message });\n        }\n      }\n\n      res.json({ results });\n    } catch (error) {\n      console.error('Error batch updating metadata:', error);\n      next(error);\n    }\n  },\n);\n\n// Batch tag people in images (Admin only)\napp.put(\n  '/api/media/images/batch/people',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const { imageIds, entityIds, action } = req.body; // action: 'add' or 'remove'\n\n      if (!Array.isArray(imageIds) || imageIds.length === 0) {\n        return res.status(400).json({ error: 'Invalid image IDs' });\n      }\n\n      if (!Array.isArray(entityIds) || entityIds.length === 0) {\n        return res.status(400).json({ error: 'Invalid entity IDs' });\n      }\n\n      if (!['add', 'remove'].includes(action)) {\n        return res.status(400).json({ error: 'Invalid action' });\n      }\n\n      const results = [];\n      const db = getDb();\n\n      // Process each image\n      for (const imageId of imageIds) {\n        try {\n          const id = parseInt(imageId.toString());\n          if (isNaN(id)) continue;\n\n          // Process each entity\n          for (const entityId of entityIds) {\n            const eid = parseInt(entityId.toString());\n            if (isNaN(eid)) continue;\n\n            if (action === 'add') {\n              // Add person to image\n              db.prepare(\n                'INSERT OR IGNORE INTO media_people (media_id, entity_id) VALUES (?, ?)',\n              ).run(id, eid);\n            } else {\n              // Remove person from image\n              db.prepare('DELETE FROM media_people WHERE media_id = ? AND entity_id = ?').run(\n                id,\n                eid,\n              );\n            }\n          }\n\n          results.push({ id, success: true });\n        } catch (err) {\n          console.error(`Error tagging people in image ${imageId}:`, err);\n          results.push({ id: imageId, success: false, error: (err as Error).message });\n        }\n      }\n\n      res.json({ results });\n    } catch (error) {\n      console.error('Error batch tagging people in images:', error);\n      next(error);\n    }\n  },\n);\n\napp.put(\n  '/api/media/images/:id',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const imageId = parseInt(req.params.id);\n      if (isNaN(imageId)) {\n        return res.status(400).json({ error: 'Invalid image ID' });\n      }\n\n      // Only allow specific fields to be updated\n      const updates: any = {};\n      if (req.body.title !== undefined) updates.title = req.body.title;\n      if (req.body.description !== undefined) updates.description = req.body.description;\n\n      mediaService.updateImage(imageId, updates);\n      res.json({ success: true });\n    } catch (error) {\n      console.error('Error updating image:', error);\n      next(error);\n    }\n  },\n);\n\n// Rotate image (Admin only)\napp.put(\n  '/api/media/images/:id/rotate',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const imageId = parseInt(req.params.id);\n      const direction = req.body.direction === 'left' ? -90 : 90; // Default to right/clockwise\n\n      if (isNaN(imageId)) {\n        return res.status(400).json({ error: 'Invalid image ID' });\n      }\n\n      const image = mediaService.getImageById(imageId);\n      if (!image) {\n        return res.status(404).json({ error: 'Image not found' });\n      }\n\n      // Use MediaService to physically rotate the image file\n      // This solves the \"Double Rotation\" display issues by normalizing\n      // the image pixels and resetting EXIF orientation to 1.\n      await mediaService.rotateImage(imageId, direction);\n\n      // Regenerate thumbnail with new orientation\n      const thumbnailDir = path.dirname(\n        (image as any).thumbnail_path ||\n          image.thumbnailPath ||\n          path.join(path.dirname(image.path), 'thumbnails'),\n      );\n      // Ensure we have a valid thumbnail directory. If image.thumbnail_path exists, use its dir.\n      // If not, assume 'thumbnails' subdir of image path (standard structure)\n\n      try {\n        await mediaService.generateThumbnail(image.path, thumbnailDir, {\n          force: true,\n          orientation: 1,\n        });\n      } catch (err) {\n        console.error('Failed to regenerate thumbnail during rotation:', err);\n        // Continue, as the DB update was successful\n      }\n\n      // Return the updated image so frontend can reflect changes immediately\n      const updatedImage = mediaService.getImageById(imageId);\n      res.json(updatedImage);\n    } catch (error) {\n      console.error('Error rotating image:', error);\n      next(error);\n    }\n  },\n);\n\n// Delete image (Admin only)\napp.delete(\n  '/api/media/images/:id',\n  authenticateRequest,\n  requireRole('admin'),\n  async (req, res, next) => {\n    try {\n      const imageId = parseInt(req.params.id);\n      if (isNaN(imageId)) {\n        return res.status(400).json({ error: 'Invalid image ID' });\n      }\n\n      mediaService.deleteImage(imageId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error('Error deleting image:', error);\n      next(error);\n    }\n  },\n);\n\n// Search images\napp.get('/api/media/search', async (req, res, next) => {\n  try {\n    const query = req.query.q as string;\n    if (!query) {\n      return res.status(400).json({ error: 'Search query is required' });\n    }\n\n    const images = mediaService.searchImages(query);\n    res.json(images);\n  } catch (error) {\n    console.error('Error searching images:', error);\n    next(error);\n  }\n});\n\n// Get all media tags\napp.get('/api/media/tags', async (_req, res, next) => {\n  try {\n    const tags = mediaService.getAllTags();\n    res.json(tags);\n  } catch (error) {\n    console.error('Error fetching tags:', error);\n    next(error);\n  }\n});\n\n// Get media statistics\napp.get('/api/media/stats', async (_req, res, next) => {\n  try {\n    const stats = mediaService.getMediaStats();\n    res.json(stats);\n  } catch (error) {\n    console.error('Error fetching media stats:', error);\n    next(error);\n  }\n});\n\n// ============================================\n// TAGS API - Global tagging system\n// ============================================\n\n// Get all tags\napp.get('/api/tags', async (_req, res, next) => {\n  try {\n    const db = getDb();\n    const tags = db.prepare('SELECT * FROM tags ORDER BY name ASC').all();\n    res.json(tags);\n  } catch (error) {\n    console.error('Error fetching tags:', error);\n    next(error);\n  }\n});\n\n// Create a new tag\napp.post('/api/tags', authenticateRequest, async (req, res, next) => {\n  try {\n    const { name, color } = req.body;\n    if (!name || !name.trim()) {\n      return res.status(400).json({ error: 'Tag name is required' });\n    }\n\n    const db = getDb();\n    const result = db\n      .prepare('INSERT INTO tags (name, color) VALUES (?, ?)')\n      .run(name.trim(), color || '#6366f1');\n\n    res\n      .status(201)\n      .json({ id: result.lastInsertRowid, name: name.trim(), color: color || '#6366f1' });\n  } catch (error: any) {\n    if (error.code === 'SQLITE_CONSTRAINT_UNIQUE') {\n      return res.status(409).json({ error: 'Tag already exists' });\n    }\n    console.error('Error creating tag:', error);\n    next(error);\n  }\n});\n\n// Delete a tag\napp.delete('/api/tags/:id', authenticateRequest, requireRole('admin'), async (req, res, next) => {\n  try {\n    const tagId = parseInt(req.params.id);\n    if (isNaN(tagId)) return res.status(400).json({ error: 'Invalid tag ID' });\n\n    const db = getDb();\n    const result = db.prepare('DELETE FROM tags WHERE id = ?').run(tagId);\n\n    if (result.changes === 0) return res.status(404).json({ error: 'Tag not found' });\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error deleting tag:', error);\n    next(error);\n  }\n});\n\n// ============================================\n// MEDIA TAGS API\n// ============================================\n\n// Get tags for an image\napp.get('/api/media/images/:id/tags', async (req, res, next) => {\n  try {\n    const imageId = parseInt(req.params.id);\n    if (isNaN(imageId)) return res.status(400).json({ error: 'Invalid image ID' });\n\n    const db = getDb();\n    const tags = db\n      .prepare(\n        `\n      SELECT t.* FROM tags t\n      JOIN image_tags it ON t.id = it.tag_id\n      WHERE it.image_id = ?\n      ORDER BY t.name ASC\n    `,\n      )\n      .all(imageId);\n\n    res.json(tags);\n  } catch (error) {\n    console.error('Error fetching image tags:', error);\n    next(error);\n  }\n});\n\n// Add tag to image\napp.post('/api/media/images/:id/tags', authenticateRequest, async (req, res, next) => {\n  try {\n    const imageId = parseInt(req.params.id);\n    const { tagId } = req.body;\n\n    if (isNaN(imageId) || !tagId) return res.status(400).json({ error: 'Invalid image or tag ID' });\n\n    const db = getDb();\n    db.prepare('INSERT OR IGNORE INTO image_tags (image_id, tag_id) VALUES (?, ?)').run(\n      imageId,\n      tagId,\n    );\n\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error adding tag to image:', error);\n    next(error);\n  }\n});\n\n// Remove tag from image\napp.delete('/api/media/images/:id/tags/:tagId', authenticateRequest, async (req, res, next) => {\n  try {\n    const imageId = parseInt(req.params.id);\n    const tagId = parseInt(req.params.tagId);\n\n    if (isNaN(imageId) || isNaN(tagId)) return res.status(400).json({ error: 'Invalid IDs' });\n\n    const db = getDb();\n    db.prepare('DELETE FROM image_tags WHERE image_id = ? AND tag_id = ?').run(imageId, tagId);\n\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error removing tag from image:', error);\n    next(error);\n  }\n});\n\n// ============================================\n// MEDIA PEOPLE API - Link entities to images\n// ============================================\n\n// Get people in an image\napp.get('/api/media/images/:id/people', async (req, res, next) => {\n  try {\n    const imageId = parseInt(req.params.id);\n    if (isNaN(imageId)) return res.status(400).json({ error: 'Invalid image ID' });\n\n    const db = getDb();\n    const people = db\n      .prepare(\n        `\n      SELECT e.id, e.full_name as name, e.primary_role as role, e.red_flag_rating as redFlagRating\n      FROM entities e\n      JOIN media_people mp ON e.id = mp.entity_id\n      WHERE mp.media_id = ?\n      ORDER BY e.full_name ASC\n    `,\n      )\n      .all(imageId);\n\n    res.json(people);\n  } catch (error) {\n    console.error('Error fetching image people:', error);\n    next(error);\n  }\n});\n\n// Add person to image\napp.post('/api/media/images/:id/people', authenticateRequest, async (req, res, next) => {\n  try {\n    const imageId = parseInt(req.params.id);\n    const { entityId } = req.body;\n\n    if (isNaN(imageId) || !entityId)\n      return res.status(400).json({ error: 'Invalid image or entity ID' });\n\n    const db = getDb();\n    db.prepare('INSERT OR IGNORE INTO media_people (media_id, entity_id) VALUES (?, ?)').run(\n      imageId,\n      entityId,\n    );\n\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error adding person to image:', error);\n    next(error);\n  }\n});\n\n// Remove person from image\napp.delete(\n  '/api/media/images/:id/people/:entityId',\n  authenticateRequest,\n  async (req, res, next) => {\n    try {\n      const imageId = parseInt(req.params.id);\n      const entityId = parseInt(req.params.entityId);\n\n      if (isNaN(imageId) || isNaN(entityId)) return res.status(400).json({ error: 'Invalid IDs' });\n\n      const db = getDb();\n      db.prepare('DELETE FROM media_people WHERE media_id = ? AND entity_id = ?').run(\n        imageId,\n        entityId,\n      );\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error('Error removing person from image:', error);\n      next(error);\n    }\n  },\n);\n\n// ============ FLIGHT TRACKER API ============\nimport { flightsRepository } from './server/db/flightsRepository.js';\n\n// Get flights with filtering and pagination\napp.get('/api/flights', async (req, res, next) => {\n  try {\n    const filters = {\n      page: parseInt(req.query.page as string) || 1,\n      limit: Math.min(100, parseInt(req.query.limit as string) || 50),\n      startDate: req.query.startDate as string,\n      endDate: req.query.endDate as string,\n      passenger: req.query.passenger as string,\n      airport: req.query.airport as string,\n    };\n\n    const result = flightsRepository.getFlights(filters);\n    res.json(result);\n  } catch (error) {\n    console.error('Error fetching flights:', error);\n    next(error);\n  }\n});\n\n// Get flight statistics\napp.get('/api/flights/stats', async (req, res, next) => {\n  try {\n    const stats = flightsRepository.getFlightStats();\n    res.json(stats);\n  } catch (error) {\n    console.error('Error fetching flight stats:', error);\n    next(error);\n  }\n});\n\n// Get airport coordinates for map\napp.get('/api/flights/airports', async (req, res, next) => {\n  try {\n    const coords = flightsRepository.getAirportCoords();\n    res.json(coords);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Get unique passengers list\napp.get('/api/flights/passengers', async (req, res, next) => {\n  try {\n    const passengers = flightsRepository.getUniquePassengers();\n    res.json(passengers);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Get single flight by ID\napp.get('/api/flights/:id', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    if (isNaN(id)) return res.status(400).json({ error: 'Invalid flight ID' });\n\n    const flight = flightsRepository.getFlightById(id);\n    if (!flight) return res.status(404).json({ error: 'Flight not found' });\n\n    res.json(flight);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Get flights for specific passenger\napp.get('/api/flights/passenger/:name', async (req, res, next) => {\n  try {\n    const name = decodeURIComponent(req.params.name);\n    const flights = flightsRepository.getPassengerFlights(name);\n    res.json(flights);\n  } catch (error) {\n    next(error);\n  }\n});\n\n// Advanced Analytics API routes\napp.use('/api/advanced-analytics', advancedAnalyticsRoutes);\n\n// Investigative Tasks API routes\napp.use('/api/investigative-tasks', investigativeTasksRoutes);\n\n// Memory API routes\napp.get('/api/memory', async (req, res, next) => {\n  try {\n    const page = Math.max(1, parseInt(req.query.page as string) || 1);\n    const limit = Math.min(100, Math.max(1, parseInt(req.query.limit as string) || 20));\n    const memoryType = req.query.memoryType as string;\n    const status = req.query.status as string;\n    const searchQuery = req.query.q as string;\n\n    const filters: any = {};\n    if (memoryType) filters.memoryType = memoryType;\n    if (status) filters.status = status;\n    if (searchQuery) filters.searchQuery = searchQuery;\n\n    const result = memoryRepository.searchMemoryEntries(getDb(), filters, page, limit);\n\n    res.json({\n      data: result.data,\n      total: result.total,\n      page,\n      pageSize: limit,\n      totalPages: Math.ceil(result.total / limit),\n    });\n  } catch (error) {\n    console.error('Error fetching memory entries:', error);\n    next(error);\n  }\n});\n\napp.get('/api/memory/:id', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    if (isNaN(id)) {\n      return res.status(400).json({ error: 'Invalid memory ID' });\n    }\n\n    const memoryEntry = memoryRepository.getMemoryEntryById(getDb(), id);\n    if (!memoryEntry) {\n      return res.status(404).json({ error: 'Memory entry not found' });\n    }\n\n    res.json(memoryEntry);\n  } catch (error) {\n    console.error('Error fetching memory entry:', error);\n    next(error);\n  }\n});\n\napp.post('/api/memory', async (req, res, next) => {\n  try {\n    const {\n      memoryType,\n      content,\n      metadata,\n      contextTags,\n      importanceScore,\n      sourceId,\n      sourceType,\n      provenance,\n    } = req.body;\n\n    if (!memoryType || !content) {\n      return res.status(400).json({ error: 'memoryType and content are required' });\n    }\n\n    const input = {\n      memoryType,\n      content,\n      metadata,\n      contextTags,\n      importanceScore,\n      sourceId,\n      sourceType,\n      provenance,\n    };\n\n    const newMemoryEntry = memoryRepository.createMemoryEntry(getDb(), input);\n\n    res.status(201).json(newMemoryEntry);\n  } catch (error) {\n    console.error('Error creating memory entry:', error);\n    next(error);\n  }\n});\n\napp.put('/api/memory/:id', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    if (isNaN(id)) {\n      return res.status(400).json({ error: 'Invalid memory ID' });\n    }\n\n    const updates = req.body;\n    const updatedMemoryEntry = memoryRepository.updateMemoryEntry(getDb(), id, updates);\n\n    if (!updatedMemoryEntry) {\n      return res.status(404).json({ error: 'Memory entry not found' });\n    }\n\n    res.json(updatedMemoryEntry);\n  } catch (error) {\n    console.error('Error updating memory entry:', error);\n    next(error);\n  }\n});\n\napp.delete('/api/memory/:id', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    if (isNaN(id)) {\n      return res.status(400).json({ error: 'Invalid memory ID' });\n    }\n\n    const result = memoryRepository.updateMemoryEntry(getDb(), id, { status: 'deprecated' });\n\n    if (!result) {\n      return res.status(404).json({ error: 'Memory entry not found' });\n    }\n\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error deleting memory entry:', error);\n    next(error);\n  }\n});\n\napp.get('/api/memory/:id/relationships', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    if (isNaN(id)) {\n      return res.status(400).json({ error: 'Invalid memory ID' });\n    }\n\n    const relationships = memoryRepository.getMemoryRelationships(getDb(), id);\n\n    res.json(relationships);\n  } catch (error) {\n    console.error('Error fetching memory relationships:', error);\n    next(error);\n  }\n});\n\napp.get('/api/memory/:id/audit', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    if (isNaN(id)) {\n      return res.status(400).json({ error: 'Invalid memory ID' });\n    }\n\n    const auditLogs = memoryRepository.getMemoryAuditLogs(getDb(), id);\n\n    res.json(auditLogs);\n  } catch (error) {\n    console.error('Error fetching memory audit logs:', error);\n    next(error);\n  }\n});\n\napp.get('/api/memory/:id/quality', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    if (isNaN(id)) {\n      return res.status(400).json({ error: 'Invalid memory ID' });\n    }\n\n    const qualityMetrics = memoryRepository.getQualityMetrics(getDb(), id);\n\n    res.json(qualityMetrics);\n  } catch (error) {\n    console.error('Error fetching memory quality metrics:', error);\n    next(error);\n  }\n});\n\napp.post('/api/memory/:id/quality', async (req, res, next) => {\n  try {\n    const id = parseInt(req.params.id);\n    if (isNaN(id)) {\n      return res.status(400).json({ error: 'Invalid memory ID' });\n    }\n\n    const { sourceReliability, evidenceStrength, temporalRelevance, entityConfidence } = req.body;\n\n    const dimensions = {\n      sourceReliability: sourceReliability || 0.5,\n      evidenceStrength: evidenceStrength || 0.5,\n      temporalRelevance: temporalRelevance || 0.5,\n      entityConfidence: entityConfidence || 0.5,\n    };\n\n    memoryRepository.updateQualityMetrics(getDb(), id, dimensions);\n\n    res.json({ success: true });\n  } catch (error) {\n    console.error('Error updating memory quality metrics:', error);\n    next(error);\n  }\n});\n\n// Error handling middleware (must be last)\napp.use(globalErrorHandler);\n\n// SPA fallback to index.html for non-API routes\napp.get('*', async (req, res, next) => {\n  if (req.path.startsWith('/api/')) return next();\n\n  const indexFile = path.join(distPath, 'index.html');\n  if (fs.existsSync(indexFile)) {\n    // Check if we need to inject Open Graph tags for deep links\n    const photoId = req.query.photoId;\n\n    if (photoId) {\n      try {\n        const id = parseInt(photoId as string);\n        if (!isNaN(id)) {\n          const image = mediaService.getImageById(id);\n          if (image) {\n            let html = fs.readFileSync(indexFile, 'utf8');\n            const baseUrl = `${req.protocol}://${req.get('host')}`;\n            const imageUrl = `${baseUrl}/api/media/images/${id}/raw?v=${new Date(image.dateModified || image.dateAdded || 0).getTime()}`;\n            const title = image.title || image.filename;\n            const description =\n              image.description || `Photo from Epstein Archive - ${image.filename}`;\n\n            // Generate OG Tags\n            const ogTags = `\n              <!-- Dynamic Open Graph Tags -->\n              <meta property=\"og:title\" content=\"${title.replace(/\"/g, '&quot;')}\" />\n              <meta property=\"og:description\" content=\"${description.replace(/\"/g, '&quot;')}\" />\n              <meta property=\"og:image\" content=\"${imageUrl}\" />\n              <meta property=\"og:type\" content=\"website\" />\n              <meta property=\"og:url\" content=\"${baseUrl}${req.originalUrl}\" />\n              <meta name=\"twitter:card\" content=\"summary_large_image\" />\n              <meta name=\"twitter:title\" content=\"${title.replace(/\"/g, '&quot;')}\" />\n              <meta name=\"twitter:description\" content=\"${description.replace(/\"/g, '&quot;')}\" />\n              <meta name=\"twitter:image\" content=\"${imageUrl}\" />\n            `;\n\n            // Replace default tags\n            // We look for the block starting with our comment and ending with the last twitter tag\n            const defaultTagsRegex =\n              /<!-- Default Open Graph Tags -->[\\s\\S]*?<meta name=\"twitter:image\" content=\".*?\" \\/>/;\n            if (defaultTagsRegex.test(html)) {\n              html = html.replace(defaultTagsRegex, ogTags);\n            } else {\n              // Fallback: append to head if regex fails (shouldn't happen if index.html is synced)\n              html = html.replace('</head>', `${ogTags}</head>`);\n            }\n\n            return res.send(html);\n          }\n        }\n      } catch (err) {\n        console.error('Error injecting OG tags:', err);\n        // Fallback to sending file normally\n      }\n    }\n\n    res.sendFile(indexFile);\n  } else {\n    next();\n  }\n});\n\n// Graceful shutdown handling\nprocess.on('SIGTERM', () => {\n  console.log('SIGTERM received, shutting down gracefully');\n  process.exit(0);\n});\n\nprocess.on('SIGINT', () => {\n  console.log('SIGINT received, shutting down gracefully');\n  process.exit(0);\n});\n\n// Start server\n// Ensure migrations are run before starting\ntry {\n  validateStartup();\n  runMigrations();\n} catch (err) {\n  console.error('Failed to run migrations:', err);\n  // Continue anyway? Or exit? For now, log and continue as per plan to be robust.\n}\n\nconst server = app.listen(config.apiPort, () => {\n  console.log(`🚀 Production API server running on port ${config.apiPort}`);\n  console.log(`📊 Environment: ${config.nodeEnv}`);\n\n  // CRITICAL STARTUP ASSERTIONS\n  if (config.nodeEnv === 'production' && config.apiPort !== 8080 && config.apiPort !== 3012) {\n    console.warn(`⚠️  [DEPLOYMENT WARNING] Production expects PORT 8080 or 3012!`);\n    console.warn(`⚠️  Current PORT is ${config.apiPort} - API calls may return 404!`);\n  }\n\n  // Log startup diagnostics for debugging\n  console.log('--- Startup Warnings ---');\n  const isProduction = process.env.NODE_ENV === 'production';\n  if (isProduction) {\n    console.log(\n      '[INFO] Production mode: Authentication is FORCED regardless of ENABLE_AUTH setting.',\n    );\n  }\n  console.log('[INFO] Authentication is now forced to be enabled in all environments');\n  console.log('------------------------');\n});\n\n// === GRACEFUL SHUTDOWN ===\n// Close database connection properly to prevent \"database is locked\" errors\nconst gracefulShutdown = (signal: string) => {\n  console.log(`\\n${signal} received. Shutting down gracefully...`);\n\n  server.close(() => {\n    console.log('HTTP server closed.');\n\n    try {\n      // Close database connection\n      const db = getDb();\n      if (db) {\n        db.close();\n        console.log('Database connection closed.');\n      }\n    } catch (e) {\n      console.error('Error closing database:', e);\n    }\n\n    console.log('Graceful shutdown complete.');\n    process.exit(0);\n  });\n\n  // Force exit after 10 seconds if graceful shutdown fails\n  setTimeout(() => {\n    console.error('Forced shutdown after timeout.');\n    process.exit(1);\n  }, 10000);\n};\n\nprocess.on('SIGTERM', () => gracefulShutdown('SIGTERM'));\nprocess.on('SIGINT', () => gracefulShutdown('SIGINT'));\n\nexport default server;\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/audit/logger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/auth/middleware.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used. Allowed unused caught errors must match /^_/u.","line":38,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":38,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Request, Response, NextFunction } from 'express';\nimport { getDb } from '../db/connection.js';\n\n// Extend Request locally to avoid global type conflicts for now\n// Extend Request locally to avoid global type conflicts for now\nexport interface AuthRequest extends Request {\n  user?: {\n    id: string;\n    username: string;\n    role: string;\n    email?: string | null;\n  };\n}\n\nimport jwt from 'jsonwebtoken';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'dev-secret-do-not-use-in-prod-if-possible';\n\n// Shared verification helper\nconst verifyToken = (req: Request): any | null => {\n  let token: string | undefined;\n\n  if (req.cookies && req.cookies.token) {\n    token = req.cookies.token;\n  } else if (req.headers.authorization && req.headers.authorization.startsWith('Bearer ')) {\n    token = req.headers.authorization.split(' ')[1];\n  }\n\n  if (!token) return null;\n\n  try {\n    const decoded = jwt.verify(token, JWT_SECRET) as any;\n    const db = getDb();\n    const user = db\n      .prepare('SELECT id, username, role, email FROM users WHERE id = ?')\n      .get(decoded.id) as any;\n    return user || null;\n  } catch (error) {\n    return null;\n  }\n};\n\nexport const authenticateRequest = (req: Request, res: Response, next: NextFunction) => {\n  const authReq = req as AuthRequest;\n\n  // Check if Auth is enabled\n  const isAuthEnabled = true;\n\n  if (!isAuthEnabled) {\n    authReq.user = {\n      id: 'dev-user',\n      username: 'Developer',\n      role: 'admin',\n      email: 'dev@local.test',\n    };\n    return next();\n  }\n\n  const user = verifyToken(req);\n  if (!user) {\n    return res\n      .status(401)\n      .json({ error: 'Unauthorized', message: 'Missing or invalid authentication credentials' });\n  }\n\n  authReq.user = user;\n  next();\n};\n\nexport const optionalAuthenticate = (req: Request, res: Response, next: NextFunction) => {\n  const authReq = req as AuthRequest;\n  // Always try to verify, but don't error if it fails\n  const user = verifyToken(req);\n  if (user) {\n    authReq.user = user;\n  }\n  next();\n};\n\nexport const requireRole = (requiredRole: string) => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const authReq = req as AuthRequest;\n\n    if (!authReq.user) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n\n    // Admin has access to everything\n    if (authReq.user.role === 'admin') {\n      return next();\n    }\n\n    if (authReq.user.role !== requiredRole) {\n      return res.status(403).json({ error: 'Forbidden', message: `Requires ${requiredRole} role` });\n    }\n\n    next();\n  };\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/auth/routes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/articleRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/blackBookRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/bulkOperationsRepository.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'documentId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":83,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":83,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDb } from './connection.js';\n\nexport const bulkOperationsRepository = {\n  // Bulk insert entities with prepared statements for performance\n  bulkInsertEntities: async (entities: any[]) => {\n    const db = getDb();\n    const insertEntity = db.prepare(`\n      INSERT INTO entities (full_name, primary_role, secondary_roles, likelihood_level, mentions, \n                           current_status, connections_summary, red_flag_rating, red_flag_score)\n      VALUES (@full_name, @primary_role, @secondary_roles, @likelihood_level, @mentions,\n              @current_status, @connections_summary, @red_flag_rating, @red_flag_score)\n    `);\n\n    const insertDocument = db.prepare(`\n      INSERT INTO documents (file_name, file_path, file_type, file_size, date_created, content, metadata_json, word_count, red_flag_rating, content_hash)\n      VALUES (@file_name, @file_path, @file_type, @file_size, @date_created, @content, @metadata_json, @word_count, @red_flag_rating, @content_hash)\n    `);\n\n    const getEvidenceTypeId = db.prepare('SELECT id FROM evidence_types WHERE type_name = ?');\n\n    const insertEntityEvidence = db.prepare(`\n      INSERT OR IGNORE INTO entity_evidence_types (entity_id, evidence_type_id)\n      VALUES (@entity_id, @evidence_type_id)\n    `);\n\n    const transaction = db.transaction((entitiesData: any[]) => {\n      for (const entityData of entitiesData) {\n        const entityResult = insertEntity.run({\n          full_name: entityData.fullName,\n          primary_role: entityData.primaryRole,\n          secondary_roles: entityData.secondaryRoles ? entityData.secondaryRoles.join(', ') : null,\n          likelihood_level: entityData.likelihoodLevel,\n          mentions: entityData.mentions || 0,\n          current_status: entityData.currentStatus,\n          connections_summary: entityData.connectionsSummary,\n          red_flag_rating: entityData.redFlagRating,\n          red_flag_score: entityData.redFlagScore || 0,\n        });\n\n        const entityId = entityResult.lastInsertRowid;\n\n        // Insert evidence types\n        if (entityData.evidenceTypes && Array.isArray(entityData.evidenceTypes)) {\n          for (const typeName of entityData.evidenceTypes) {\n            const typeRow = getEvidenceTypeId.get(typeName) as { id: number } | undefined;\n            if (typeRow) {\n              insertEntityEvidence.run({\n                entity_id: entityId,\n                evidence_type_id: typeRow.id,\n              });\n            }\n          }\n        }\n\n        // Insert documents and mentions\n        if (entityData.fileReferences && entityData.fileReferences.length > 0) {\n          for (const fileRef of entityData.fileReferences) {\n            // Check if document already exists to avoid duplicates\n            // We use a simple check here. For high performance with millions of rows,\n            // we might want to cache recent document IDs or use INSERT OR IGNORE with a returning clause if supported.\n            // Since we added a UNIQUE index on file_path, we can use that.\n            let documentId: number | bigint;\n\n            const existingDoc = db\n              .prepare('SELECT id FROM documents WHERE file_path = ?')\n              .get(fileRef.filePath) as { id: number } | undefined;\n\n            if (existingDoc) {\n              documentId = existingDoc.id;\n            } else {\n              const docResult = insertDocument.run({\n                file_name: fileRef.fileName,\n                file_path: fileRef.filePath || fileRef.path,\n                file_type: fileRef.fileType,\n                file_size: fileRef.fileSize || 0,\n                date_created: fileRef.dateCreated || new Date().toISOString(),\n                content: fileRef.content || '',\n                metadata_json: fileRef.metadataJson || '{}',\n                word_count: fileRef.wordCount || 0,\n                red_flag_rating: fileRef.redFlagRating || 0,\n                content_hash: fileRef.md5Hash || '',\n              });\n              documentId = docResult.lastInsertRowid as number;\n            }\n\n            // Insert mention\n          }\n        }\n      }\n    });\n\n    transaction(entities);\n  },\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/cache.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/communicationsRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/connection.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/dataQualityRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/documentPagesRepository.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":52,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { join } from 'path';\nimport { statSync } from 'fs';\nimport { documentsRepository } from './documentsRepository.js';\n\nexport const documentPagesRepository = {\n  getDocumentPages: async (id: string) => {\n    const doc = documentsRepository.getDocumentById(id);\n    if (!doc || !doc.filePath) return { pages: [] };\n\n    // Extract filename without extension\n    const filename = doc.fileName.replace(/\\.[^/.]+$/, '');\n\n    // Try to find the page number in the filename\n    // Format is usually NAME_OF_DOC_PageNumber\n    // e.g. HOUSE_OVERSIGHT_010477\n    const match = filename.match(/_(\\d+)$/);\n    if (!match) return { pages: [] };\n\n    const startPage = parseInt(match[1], 10);\n\n    if (!doc.filePath.includes('Epstein Estate Documents - Seventh Production')) {\n      return { pages: [] };\n    }\n\n    const baseDirParts = doc.filePath.split('Epstein Estate Documents - Seventh Production/');\n    if (baseDirParts.length < 2) return { pages: [] };\n\n    const relativePath = baseDirParts[1].replace('TEXT/', 'IMAGES/');\n    const baseDir = relativePath.split('/').slice(0, -1).join('/');\n\n    const corpusBasePath = process.env.RAW_CORPUS_BASE_PATH || '';\n    if (!corpusBasePath) return { pages: [] }; // Can't find pages without corpus path\n    const absoluteBaseDir = join(corpusBasePath, baseDir);\n\n    const pages: string[] = [];\n    let currentPage = startPage;\n    let pageFound = true;\n\n    // Limit to 100 pages to prevent infinite loops if logic fails\n    while (pageFound && pages.length < 100) {\n      // Reconstruct filename with current page number\n      const prefix = filename.substring(0, filename.lastIndexOf('_'));\n      const pageStr = currentPage.toString().padStart(match[1].length, '0');\n      const currentFilename = `${prefix}_${pageStr}.jpg`;\n      const absolutePath = join(absoluteBaseDir, currentFilename);\n\n      try {\n        statSync(absolutePath);\n        // File exists\n        pages.push(`/files/${baseDir}/${currentFilename}`);\n        currentPage++;\n      } catch (e) {\n        pageFound = false;\n      }\n    }\n\n    return { pages };\n  },\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/documentsRepository.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":30,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":117,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":117,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDb } from './connection.js';\n\nexport const documentsRepository = {\n  getDocuments: (\n    page: number = 1,\n    limit: number = 50,\n    filters: {\n      search?: string;\n      fileType?: string;\n      evidenceType?: string;\n      minRedFlag?: number;\n      maxRedFlag?: number;\n      sortBy?: string;\n    } = {},\n  ) => {\n    const db = getDb();\n    const whereConditions: string[] = [];\n    const params: any[] = [];\n\n    if (filters.search && filters.search.trim()) {\n      try {\n        // Simple check if table exists (cached or checked once)\n        // For now, just try-catch the query construction later?\n        // Better to assume FTS if we are in \"production\" mode or fallback.\n        // Let's stick to LIKE for simple browse, but if search term is complex, FTS is better.\n        // For now, I'll keep LIKE for robustness as per previous patterns unless I can guarantee FTS table.\n        whereConditions.push('(file_name LIKE ? OR content LIKE ?)');\n        const searchPattern = `%${filters.search.trim()}%`;\n        params.push(searchPattern, searchPattern);\n      } catch (e) {\n        // Fallback\n      }\n    }\n\n    if (filters.fileType && filters.fileType !== 'all') {\n      const types = filters.fileType.split(',');\n      whereConditions.push(`file_type IN (${types.map(() => '?').join(',')})`);\n      params.push(...types);\n    }\n\n    if (filters.evidenceType && filters.evidenceType !== 'all') {\n      whereConditions.push('evidence_type = ?');\n      params.push(filters.evidenceType);\n    }\n\n    if (filters.minRedFlag || filters.maxRedFlag) {\n      const min = filters.minRedFlag || 0;\n      const max = filters.maxRedFlag || 5;\n      whereConditions.push(\n        '(red_flag_rating IS NULL OR (red_flag_rating >= ? AND red_flag_rating <= ?))',\n      );\n      params.push(min, max);\n    }\n\n    // Default to hiding child pages unless specifically requested or searching deeply\n    if (!filters.search) {\n      // whereConditions.push('(is_hidden = 0 OR is_hidden IS NULL)');\n      // Temporarily disable hiding pages to debug email count regression (Issue #4769)\n      // Many emails might be marked as hidden pages incorrectly?\n    }\n\n    const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';\n\n    let orderByClause = 'ORDER BY ';\n    switch (filters.sortBy) {\n      case 'date':\n        orderByClause += 'date_created DESC';\n        break;\n      case 'title':\n        orderByClause += 'file_name ASC';\n        break;\n      case 'red_flag':\n      default:\n        orderByClause += 'red_flag_rating DESC, date_created DESC';\n        break;\n    }\n\n    const offset = (page - 1) * limit;\n\n    const countQuery = `SELECT COUNT(*) as total FROM documents ${whereClause}`;\n    const totalResult = db.prepare(countQuery).get(...params) as { total: number };\n\n    const sql = `\n      SELECT \n        id,\n        file_name as fileName,\n        file_path as filePath,\n        file_type as fileType,\n        file_size as fileSize,\n        date_created as dateCreated,\n        substr(content, 1, 300) as contentPreview,\n        evidence_type as evidenceType,\n        0 as mentionsCount,\n        content,\n        metadata_json as metadata,\n        word_count as wordCount,\n        red_flag_rating as redFlagRating,\n        content_hash as contentHash,\n        file_name as title\n      FROM documents\n      ${whereClause}\n      ${orderByClause}\n      LIMIT ? OFFSET ?\n    `;\n\n    const documents = db.prepare(sql).all(...params, limit, offset);\n\n    return {\n      documents: documents.map((doc: any) => {\n        let metadata = {};\n        try {\n          if (typeof doc.metadata === 'string') {\n            metadata = JSON.parse(doc.metadata);\n          } else if (typeof doc.metadata === 'object') {\n            metadata = doc.metadata;\n          }\n        } catch (e) {\n          /* ignore */\n        }\n        return { ...doc, metadata };\n      }),\n      total: totalResult.total,\n      page,\n      pageSize: limit,\n      totalPages: Math.ceil(totalResult.total / limit),\n    };\n  },\n\n  // Get document by ID with full content\n  getDocumentById: (id: string): any | null => {\n    const db = getDb();\n\n    const query = `\n      SELECT \n        d.id,\n        d.file_name as fileName,\n        d.file_path as filePath,\n        d.file_type as fileType,\n        d.file_size as fileSize,\n        d.date_created as dateCreated,\n        d.content_hash as contentHash,\n        d.word_count as wordCount,\n        d.red_flag_rating as redFlagRating,\n        d.metadata_json as metadataJson,\n        d.content,\n        d.evidence_type as evidenceType,\n        d.original_file_id as originalFileId,\n        d.unredaction_attempted as unredactionAttempted,\n        d.unredaction_succeeded as unredactionSucceeded,\n        d.redaction_coverage_before as redactionCoverageBefore,\n        d.redaction_coverage_after as redactionCoverageAfter,\n        d.unredacted_text_gain as unredactedTextGain,\n        d.unredaction_baseline_vocab as unredactionBaselineVocab,\n        COALESCE(orig.file_path, d.original_file_path) as original_file_path\n      FROM documents d\n      LEFT JOIN documents orig ON d.original_file_id = orig.id\n      WHERE d.id = ?\n    `;\n\n    const document = db.prepare(query).get(id) as any;\n\n    if (!document) return null;\n\n    // Parse metadata if it's a JSON string\n    if (document.metadataJson && typeof document.metadataJson === 'string') {\n      try {\n        document.metadata = JSON.parse(document.metadataJson);\n      } catch (e) {\n        console.error('Error parsing document metadata:', e);\n        document.metadata = {};\n      }\n    }\n\n    // Transform original_file_path to URL\n    if (document && document.original_file_path) {\n      // Assume /data/ is mapped to /files/data/ or similar.\n      // The server maps RAW_CORPUS_BASE_PATH to /files.\n      // If standard path is /data/originals/..., we want /files/originals/... if RAW_CORPUS_BASE_PATH is /data\n      // OR if full path is /app/data/originals, and CORPUS is /app/data.\n      // Safest bet for now: If it starts with /data/, map to /files/data/ (or just /files/ if it's relative).\n      // Actually, looking at Timeline.tsx: event.original_file_path.replace('/data/originals/', '')\n      // and href={`/files/${...}`}\n\n      // Let's standardise on returning a usable URL path if possible, OR just passed the raw path and let frontend handle it?\n      // The plan said \"transform... into a web-accessible URL\".\n\n      const rawPath = document.original_file_path;\n      // Quick fix for standard /data/originals structure\n      if (rawPath.includes('/data/originals/')) {\n        document.source_original_url = `/files/${rawPath.split('/data/originals/')[1]}`;\n      } else {\n        // Fallback or leave as is\n        document.source_original_url = `/files/${rawPath}`;\n      }\n      // Also keep the raw path\n    }\n\n    return {\n      ...document,\n      source_collection: 'Epstein Files',\n      // Ensure top-level access to the URL\n      original_file_path: document.source_original_url || document.original_file_path,\n      unredaction_metrics: {\n        attempted: Boolean(document.unredactionAttempted),\n        succeeded: Boolean(document.unredactionSucceeded),\n        redactionCoverageBefore: document.redactionCoverageBefore,\n        redactionCoverageAfter: document.redactionCoverageAfter,\n        unredactedTextGain: document.unredactedTextGain,\n        baselineVocab: document.unredactionBaselineVocab || null,\n      },\n    };\n  },\n\n  search: (query: string, limit: number = 50) => {\n    // FTS or LIKE search\n    // documentsRepository.getDocuments implies filters, but FTS logic often separate.\n    // documentsRepository.getDocuments implies filters, but FTS logic often separate.\n    const db = getDb();\n    // If documents_fts exists, use it? Currently it's broken or not reliable without title triggers.\n    // Fallback to LIKE\n    const sql = `\n        SELECT id, file_name, substr(content, 1, 300) as contentPreview \n        FROM documents \n        WHERE content LIKE ? OR file_name LIKE ? \n        LIMIT ?\n     `;\n    const pattern = `%${query}%`;\n    return db.prepare(sql).all(pattern, pattern, limit);\n  },\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/entitiesRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/entityEvidenceRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/evidenceRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/flightsRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/forensicRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/investigationsRepository.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":381,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":381,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used. Allowed unused caught errors must match /^_/u.","line":386,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":386,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDb } from './connection.js';\n\nexport interface Investigation {\n  id: number;\n  uuid: string;\n  title: string;\n  description?: string;\n  owner_id: string;\n  collaborator_ids: string[];\n  status: 'open' | 'in_review' | 'closed' | 'archived';\n  scope?: string;\n  created_at: string;\n  updated_at: string;\n}\n\nexport const investigationsRepository = {\n  getInvestigations: async (\n    filters: {\n      status?: string;\n      ownerId?: string;\n      page?: number;\n      limit?: number;\n    } = {},\n  ) => {\n    const db = getDb();\n    const { status, ownerId, page = 1, limit = 20 } = filters;\n    const offset = (page - 1) * limit;\n\n    const where: string[] = [];\n    const params: any = {};\n\n    if (status) {\n      where.push('status = @status');\n      params.status = status;\n    }\n    if (ownerId) {\n      where.push('owner_id = @ownerId');\n      params.ownerId = ownerId;\n    }\n\n    const whereClause = where.length > 0 ? `WHERE ${where.join(' AND ')}` : '';\n\n    const query = `\n      SELECT id, uuid, title, description, owner_id, collaborator_ids, \n             status, scope, created_at, updated_at\n      FROM investigations\n      ${whereClause}\n      ORDER BY updated_at DESC\n      LIMIT @limit OFFSET @offset\n    `;\n\n    const countQuery = `SELECT COUNT(*) as total FROM investigations ${whereClause}`;\n\n    const investigations = db.prepare(query).all({ ...params, limit, offset }) as any[];\n    const { total } = db.prepare(countQuery).get(params) as { total: number };\n\n    return {\n      data: investigations.map((inv) => mapInvestigation(inv)),\n      total,\n      page,\n      pageSize: limit,\n      totalPages: Math.ceil(total / limit),\n    };\n  },\n\n  createInvestigation: async (data: {\n    title: string;\n    description?: string;\n    ownerId: string;\n    scope?: string;\n    collaboratorIds?: string[];\n  }) => {\n    const db = getDb();\n    const stmt = db.prepare(`\n      INSERT INTO investigations (title, description, owner_id, scope, collaborator_ids)\n      VALUES (@title, @description, @ownerId, @scope, @collaboratorIds)\n    `);\n\n    const result = stmt.run({\n      title: data.title,\n      description: data.description || null,\n      ownerId: data.ownerId,\n      scope: data.scope || null,\n      collaboratorIds: JSON.stringify(data.collaboratorIds || []),\n    });\n\n    return investigationsRepository.getInvestigationById(result.lastInsertRowid as number);\n  },\n\n  getInvestigationById: async (id: number | string) => {\n    const db = getDb();\n    // Support uuid or id? Logic used ID mostly.\n    const inv = db\n      .prepare(\n        `\n      SELECT id, uuid, title, description, owner_id, collaborator_ids, \n             status, scope, created_at, updated_at\n      FROM investigations WHERE id = ?\n    `,\n      )\n      .get(id) as any;\n\n    if (!inv) return null;\n    return mapInvestigation(inv);\n  },\n\n  getInvestigationByUuid: async (uuid: string) => {\n    const db = getDb();\n    const inv = db\n      .prepare(\n        `\n      SELECT id, uuid, title, description, owner_id, collaborator_ids, \n             status, scope, created_at, updated_at\n      FROM investigations WHERE uuid = ?\n    `,\n      )\n      .get(uuid) as any;\n\n    if (!inv) return null;\n    return mapInvestigation(inv);\n  },\n\n  deleteInvestigation: async (id: number) => {\n    const db = getDb();\n    const result = db.prepare('DELETE FROM investigations WHERE id = ?').run(id);\n    return result.changes > 0;\n  },\n\n  // --- Sub-resources ---\n\n  getEvidence: async (investigationId: number) => {\n    const db = getDb();\n    // JOINing investigation_evidence with evidence table to get the full view\n    // aligned with the frontend expectations.\n    return db\n      .prepare(\n        `\n      SELECT \n        e.id, \n        e.evidence_type as type, \n        e.title, \n        e.description, \n        e.source_path, \n        ie.relevance, \n        ie.added_at as extracted_at, \n        ie.added_by as extracted_by\n      FROM investigation_evidence ie\n      JOIN evidence e ON ie.evidence_id = e.id\n      WHERE ie.investigation_id = ? \n      ORDER BY ie.added_at DESC\n    `,\n      )\n      .all(investigationId);\n  },\n\n  addEvidence: async (investigationId: number, data: any) => {\n    const db = getDb();\n\n    // Handle frontend format where evidence is nested\n    const evidenceData = data.evidence || data;\n    const relevance = data.relevance || evidenceData.relevance || 'high';\n\n    // 1. Create or Find Evidence Record in `evidence` table\n    const title = evidenceData.title || evidenceData.file_name || 'Untitled Evidence';\n    const description = evidenceData.description || '';\n    const sourcePath =\n      evidenceData.source_path ||\n      evidenceData.source ||\n      evidenceData.path ||\n      `manual:${Date.now()}`;\n    const type = evidenceData.type || 'document'; // Default type\n\n    // Check if evidence already exists by source_path\n    let evidenceId;\n    const existingEvidence = db\n      .prepare('SELECT id FROM evidence WHERE source_path = ?')\n      .get(sourcePath);\n\n    if (existingEvidence) {\n      evidenceId = (existingEvidence as any).id;\n    } else {\n      const insertEvidence = db.prepare(`\n            INSERT INTO evidence (\n                title, \n                description, \n                evidence_type, \n                source_path, \n                original_filename,\n                created_at,\n                red_flag_rating\n            ) VALUES (?, ?, ?, ?, ?, datetime('now'), ?)\n        `);\n\n      const result = insertEvidence.run(\n        title,\n        description,\n        type,\n        sourcePath,\n        title, // original_filename fallback\n        evidenceData.red_flag_rating || 0,\n      );\n      evidenceId = result.lastInsertRowid;\n    }\n\n    // 2. Link to Investigation in `investigation_evidence`\n    const stmt = db.prepare(`\n      INSERT OR IGNORE INTO investigation_evidence (\n        investigation_id, evidence_id, notes, relevance, added_at, added_by\n      ) VALUES (\n        @investigation_id, @evidence_id, @notes, @relevance, datetime('now'), @added_by\n      )\n    `);\n\n    const result = stmt.run({\n      investigation_id: investigationId,\n      evidence_id: evidenceId,\n      notes: evidenceData.notes || '',\n      relevance: relevance,\n      added_by: 'user',\n    });\n\n    return result.lastInsertRowid;\n  },\n\n  getTimelineEvents: async (investigationId: number) => {\n    const db = getDb();\n    return db\n      .prepare(\n        'SELECT * FROM investigation_timeline_events WHERE investigation_id = ? ORDER BY start_date ASC',\n      )\n      .all(investigationId);\n  },\n\n  addTimelineEvent: async (investigationId: number, data: any) => {\n    const db = getDb();\n    const stmt = db.prepare(`\n      INSERT INTO investigation_timeline_events (\n        investigation_id, title, description, type, start_date, end_date\n      ) VALUES (\n        @investigation_id, @title, @description, @type, @start_date, @end_date\n      )\n    `);\n    const result = stmt.run({\n      investigation_id: investigationId,\n      title: data.title || '',\n      description: data.description || '',\n      type: data.type || 'document',\n      start_date: data.startDate || '',\n      end_date: data.endDate || null,\n    });\n    return result.lastInsertRowid;\n  },\n\n  updateTimelineEvent: async (eventId: number, data: any) => {\n    const db = getDb();\n    const stmt = db.prepare(`\n      UPDATE investigation_timeline_events \n      SET title = COALESCE(@title, title), \n          description = COALESCE(@description, description), \n          type = COALESCE(@type, type), \n          start_date = COALESCE(@startDate, start_date), \n          end_date = COALESCE(@endDate, end_date),\n          confidence = COALESCE(@confidence, confidence),\n          entities_json = COALESCE(@entities, entities_json),\n          documents_json = COALESCE(@documents, documents_json)\n      WHERE id = @id\n    `);\n\n    const result = stmt.run({\n      id: eventId,\n      title: data.title,\n      description: data.description,\n      type: data.type,\n      startDate: data.startDate,\n      endDate: data.endDate,\n      confidence: data.confidence,\n      entities: data.entities ? JSON.stringify(data.entities) : null,\n      documents: data.documents ? JSON.stringify(data.documents) : null,\n    });\n    return result.changes > 0;\n  },\n\n  deleteTimelineEvent: async (eventId: number) => {\n    const db = getDb();\n    const result = db\n      .prepare('DELETE FROM investigation_timeline_events WHERE id = ?')\n      .run(eventId);\n    return result.changes > 0;\n  },\n\n  getChainOfCustody: async (evidenceId: number) => {\n    const db = getDb();\n    return db\n      .prepare(\n        'SELECT id, evidence_id, date, actor, action, notes, signature FROM chain_of_custody WHERE evidence_id = ? ORDER BY date ASC',\n      )\n      .all(evidenceId);\n  },\n\n  addChainOfCustody: async (data: any) => {\n    const db = getDb();\n    const stmt = db.prepare(\n      'INSERT INTO chain_of_custody (evidence_id, date, actor, action, notes, signature) VALUES (?,?,?,?,?,?)',\n    );\n    const result = stmt.run(\n      data.evidenceId,\n      new Date().toISOString(),\n      data.actor || 'system',\n      data.action || 'analyzed',\n      data.notes || '',\n      data.signature || null,\n    );\n    return result.lastInsertRowid;\n  },\n\n  updateInvestigation: async (\n    id: number,\n    updates: {\n      title?: string;\n      description?: string;\n      scope?: string;\n      status?: 'open' | 'in_review' | 'closed' | 'archived';\n      collaboratorIds?: string[];\n    },\n  ) => {\n    const db = getDb();\n    const fields: string[] = [];\n    const params: any = { id };\n    if (updates.title !== undefined) {\n      fields.push('title = @title');\n      params.title = updates.title;\n    }\n    if (updates.description !== undefined) {\n      fields.push('description = @description');\n      params.description = updates.description;\n    }\n    if (updates.scope !== undefined) {\n      fields.push('scope = @scope');\n      params.scope = updates.scope;\n    }\n    if (updates.status !== undefined) {\n      fields.push('status = @status');\n      params.status = updates.status;\n    }\n    if (updates.collaboratorIds !== undefined) {\n      fields.push('collaborator_ids = @collaboratorIds');\n      params.collaboratorIds = JSON.stringify(updates.collaboratorIds);\n    }\n\n    if (fields.length === 0) return investigationsRepository.getInvestigationById(id);\n\n    db.prepare(\n      `\n      UPDATE investigations \n      SET ${fields.join(', ')}\n      WHERE id = @id\n    `,\n    ).run(params);\n\n    return investigationsRepository.getInvestigationById(id);\n  },\n\n  getNotebook: async (investigationId: number) => {\n    const db = getDb();\n    const row = db\n      .prepare(\n        `\n      SELECT investigation_id as investigationId, order_json as orderJson, annotations_json as annotationsJson, updated_at as updatedAt\n      FROM investigation_notebook\n      WHERE investigation_id = ?\n    `,\n      )\n      .get(investigationId) as any;\n    if (!row) {\n      return { investigationId, order: [], annotations: [], updatedAt: null };\n    }\n    let order = [];\n    let annotations = [];\n    try {\n      order = row.orderJson ? JSON.parse(row.orderJson) : [];\n    } catch (e) {\n      order = [];\n    }\n    try {\n      annotations = row.annotationsJson ? JSON.parse(row.annotationsJson) : [];\n    } catch (e) {\n      annotations = [];\n    }\n    return { investigationId, order, annotations, updatedAt: row.updatedAt };\n  },\n\n  saveNotebook: async (\n    investigationId: number,\n    payload: { order?: number[]; annotations?: any[] },\n  ) => {\n    const db = getDb();\n    const existing = db\n      .prepare(`SELECT investigation_id FROM investigation_notebook WHERE investigation_id = ?`)\n      .get(investigationId);\n    const orderJson = JSON.stringify(payload.order || []);\n    const annotationsJson = JSON.stringify(payload.annotations || []);\n    if (existing) {\n      db.prepare(\n        `\n        UPDATE investigation_notebook\n        SET order_json = ?, annotations_json = ?, updated_at = datetime('now')\n        WHERE investigation_id = ?\n      `,\n      ).run(orderJson, annotationsJson, investigationId);\n    } else {\n      db.prepare(\n        `\n        INSERT INTO investigation_notebook (investigation_id, order_json, annotations_json, updated_at)\n        VALUES (?, ?, ?, datetime('now'))\n      `,\n      ).run(investigationId, orderJson, annotationsJson);\n    }\n    return true;\n  },\n};\n\nfunction mapInvestigation(row: any): Investigation {\n  return {\n    id: row.id,\n    uuid: row.uuid,\n    title: row.title,\n    description: row.description,\n    owner_id: row.owner_id,\n    collaborator_ids: JSON.parse(row.collaborator_ids || '[]'),\n    status: row.status,\n    scope: row.scope,\n    created_at: row.created_at,\n    updated_at: row.updated_at,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/jobsRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/mediaRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/memoryRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/migrator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/relationshipsRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/searchRepository.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ftsError' is defined but never used. Allowed unused caught errors must match /^_/u.","line":112,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":112,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getDb } from './connection.js';\n\nexport const searchRepository = {\n  search: (\n    query: string,\n    limit: number = 50,\n    filters: { evidenceType?: string; redFlagBand?: string } = {},\n  ) => {\n    const db = getDb();\n    const searchTerm = query.trim();\n\n    if (!searchTerm) {\n      return { entities: [], documents: [] };\n    }\n\n    try {\n      // Split search into words for fuzzy matching\n      const searchWords = searchTerm.split(/\\s+/).filter((w) => w.length > 0);\n\n      // Build FTS query: each word with prefix matching, AND'd together\n      // e.g., \"William Riley\" -> \"William* AND Riley*\"\n      const ftsQuery = searchWords.map((w) => `${w.replace(/\"/g, '\"\"')}*`).join(' AND ');\n\n      let entities: any[] = [];\n      try {\n        const ftsEntityQuery = `\n          SELECT \n            e.id,\n            e.full_name as fullName,\n            e.primary_role as primaryRole,\n            'Person' as entityType,\n            e.red_flag_rating as redFlagRating,\n            e.red_flag_score as redFlagScore,\n            entities_fts.rank\n          FROM entities_fts\n          JOIN entities e ON e.id = entities_fts.rowid\n          WHERE entities_fts MATCH @ftsQuery\n          ORDER BY entities_fts.rank\n          LIMIT @limit\n        `;\n        entities = db.prepare(ftsEntityQuery).all({ ftsQuery, limit }) as any[];\n      } catch (ftsError) {\n        // Fallback to LIKE if FTS table missing or error\n        console.warn('FTS search failed, falling back to LIKE:', ftsError);\n      }\n\n      // Fallback to LIKE if FTS returned no results (safety net for broken indices)\n      if (entities.length === 0) {\n        // Build WHERE clause matching all words\n        const wordConditions = searchWords.map((word, i) => {\n          return `(e.full_name LIKE @word${i} OR e.primary_role LIKE @word${i} OR e.connections_summary LIKE @word${i} OR e.aliases LIKE @word${i})`;\n        });\n        const params: any = { limit };\n        searchWords.forEach((word, i) => {\n          params[`word${i}`] = `%${word}%`;\n        });\n\n        const entityQuery = `\n            SELECT \n            e.id,\n            e.full_name as fullName,\n            e.primary_role as primaryRole,\n            'Person' as entityType,\n            e.red_flag_rating as redFlagRating,\n            e.red_flag_score as redFlagScore\n            FROM entities e\n            WHERE ${wordConditions.join(' AND ')}\n            ORDER BY e.mentions DESC\n            LIMIT @limit\n        `;\n        entities = db.prepare(entityQuery).all(params) as any[];\n      }\n\n      // Build document query with filters\n      let documents: any[] = [];\n      try {\n        // FTS for documents\n        let documentQuery = `\n            SELECT \n              d.id,\n              d.file_name as fileName,\n              d.file_path as filePath,\n              d.file_type as fileType,\n              d.evidence_type as evidenceType,\n              d.file_size as fileSize,\n              d.date_created as dateCreated,\n              d.word_count as wordCount,\n              d.red_flag_rating as redFlagRating,\n              documents_fts.rank\n            FROM documents_fts\n            JOIN documents d ON d.id = documents_fts.rowid\n            WHERE documents_fts MATCH @ftsQuery\n         `;\n\n        const params: any = { ftsQuery, limit };\n\n        if (filters.evidenceType && filters.evidenceType !== 'ALL') {\n          documentQuery += ` AND d.evidence_type = @evidenceType`;\n          params.evidenceType = filters.evidenceType.toLowerCase();\n        }\n\n        if (filters.redFlagBand) {\n          // ... (same logic as before) ...\n          if (filters.redFlagBand === 'high') documentQuery += ` AND d.red_flag_rating >= 4`;\n          else if (filters.redFlagBand === 'medium')\n            documentQuery += ` AND d.red_flag_rating >= 2 AND d.red_flag_rating < 4`;\n          else if (filters.redFlagBand === 'low') documentQuery += ` AND d.red_flag_rating < 2`;\n        }\n\n        documentQuery += ` ORDER BY documents_fts.rank LIMIT @limit`;\n        documents = db.prepare(documentQuery).all(params) as any[];\n      } catch (ftsError) {\n        // Fallback\n        const searchPattern = `%${searchTerm}%`;\n        let documentQuery = `\n            SELECT \n            d.id,\n            d.file_name as fileName,\n            d.file_path as filePath,\n            d.file_type as fileType,\n            d.evidence_type as evidenceType,\n            d.file_size as fileSize,\n            d.date_created as dateCreated,\n            d.word_count as wordCount,\n            d.red_flag_rating as redFlagRating\n            FROM documents d\n            WHERE (d.file_name LIKE @searchPattern OR d.content LIKE @searchPattern)\n        `;\n        const params: any = { searchPattern, limit };\n        if (filters.evidenceType && filters.evidenceType !== 'ALL') {\n          documentQuery += ` AND d.evidence_type = @evidenceType`;\n          params.evidenceType = filters.evidenceType.toLowerCase();\n        }\n        if (filters.redFlagBand) {\n          if (filters.redFlagBand === 'high') documentQuery += ` AND d.red_flag_rating >= 4`;\n          else if (filters.redFlagBand === 'medium')\n            documentQuery += ` AND d.red_flag_rating >= 2 AND d.red_flag_rating < 4`;\n          else if (filters.redFlagBand === 'low') documentQuery += ` AND d.red_flag_rating < 2`;\n        }\n        documentQuery += ` ORDER BY d.red_flag_rating DESC LIMIT @limit`;\n        documents = db.prepare(documentQuery).all(params) as any[];\n      }\n\n      return {\n        entities: entities.map((row) => ({\n          id: row.id.toString(),\n          fullName: row.fullName,\n          name: row.fullName, // Helper\n          primaryRole: row.primaryRole,\n          title: row.primaryRole, // Fallback\n          entityType: row.entityType,\n          secondaryRoles: [],\n          likelihoodLevel: 0,\n          mentions: 0,\n          currentStatus: null,\n          connectionsSummary: null,\n          redFlagRating: row.redFlagRating,\n          redFlagScore: row.redFlagScore,\n          redFlagIndicators: [],\n          redFlagDescription: row.redFlagDescription,\n          titleVariants: [],\n          evidenceTypes: [], // Prevent fallback to 'Unknown' or invalid types\n        })),\n        documents: documents.map((row) => ({\n          id: row.id.toString(),\n          fileName: row.fileName,\n          title: row.fileName, // Helper\n          filePath: row.filePath,\n          fileType: row.fileType,\n          evidenceType: row.evidenceType,\n          fileSize: row.fileSize,\n          dateCreated: row.dateCreated,\n          wordCount: row.wordCount,\n          redFlagRating: row.redFlagRating,\n          createdAt: row.dateCreated,\n        })),\n      };\n    } catch (error) {\n      console.error('Search error:', error);\n      return { entities: [], documents: [] };\n    }\n  },\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/statsRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/db/timelineRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/middleware/validation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/routes/advancedAnalytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/routes/downloads.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/routes/emailRoutes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/routes/investigations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/routes/investigativeTasks.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/services/entityLinkingService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/utils/auditLogger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/utils/envValidator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/utils/errorHandler.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/utils/pathResolver.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/server/utils/startupValidation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/types/documents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/types/exif-parser.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/types/global.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/types/investigation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/types/media.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/types/memory.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/vite-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/veland/Downloads/Epstein Files/epstein-archive/src/workers/networkGraph.worker.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
